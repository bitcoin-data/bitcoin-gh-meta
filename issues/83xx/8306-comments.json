[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I observed a testnet node persistently stuck (even across restarts) in a case where its best header chain was invalid and the public network has a best valid chain with much more work than the invalid best header chain that I have, but it took more than one headers message to connect it.\n\nSuhas identified this PR as the probable cause, and on revert the node immediately became unstuck. Considering how near we are to release, I think simply reverting this is the right action currently. The issue it was fixing should have been rare and largely inconsequential on the Bitcoin network.\n",
      "created_at" : "2016-07-05T20:50:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8306#issuecomment-230599035",
      "id" : 230599035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8306",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDIzMDU5OTAzNQ==",
      "updated_at" : "2016-07-05T20:50:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/230599035",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK.  We should tag this for 0.13.0.\n",
      "created_at" : "2016-07-05T22:07:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8306#issuecomment-230617290",
      "id" : 230617290,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8306",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDIzMDYxNzI5MA==",
      "updated_at" : "2016-07-05T22:07:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/230617290",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I ran into this problem, this fixed it.\n",
      "created_at" : "2016-07-05T23:28:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8306#issuecomment-230632503",
      "id" : 230632503,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8306",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDIzMDYzMjUwMw==",
      "updated_at" : "2016-07-05T23:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/230632503",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've run into at least two people on IRC with this issue (in addition to Patrick).\n",
      "created_at" : "2016-07-06T03:30:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8306#issuecomment-230662871",
      "id" : 230662871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8306",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDIzMDY2Mjg3MQ==",
      "updated_at" : "2016-07-06T03:30:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/230662871",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Even if the issue my original patch fixed is rare in practice, I would like to see it fixed.  I understand that it is best to roll the change back after finding the issue now before the upcoming release, though.  Can I open an issue to track a \"fixed fix\" for 0.14?  Also, I do not yet fully understand how a node could become stuck with the patch even if it is on an invalid chain.  Does anyone have a good explanation for what the issue is exactly?\n",
      "created_at" : "2016-07-09T11:55:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8306#issuecomment-231530775",
      "id" : 231530775,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8306",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDIzMTUzMDc3NQ==",
      "updated_at" : "2016-07-09T11:55:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/231530775",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4943644?v=4",
         "events_url" : "https://api.github.com/users/domob1812/events{/privacy}",
         "followers_url" : "https://api.github.com/users/domob1812/followers",
         "following_url" : "https://api.github.com/users/domob1812/following{/other_user}",
         "gists_url" : "https://api.github.com/users/domob1812/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/domob1812",
         "id" : 4943644,
         "login" : "domob1812",
         "node_id" : "MDQ6VXNlcjQ5NDM2NDQ=",
         "organizations_url" : "https://api.github.com/users/domob1812/orgs",
         "received_events_url" : "https://api.github.com/users/domob1812/received_events",
         "repos_url" : "https://api.github.com/users/domob1812/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/domob1812/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/domob1812/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/domob1812"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@domob1812  One example: before reverting this patch, if there are two competing forks with tips A and B, and a node is at tip A and the fork point C between A and B is more than 2000 blocks in the past, and a node already has the first 2000 headers from C to B but no later ones, then it's possible that the hasHeaders check added by #8054 would prevent the node from ever learning about tip B, causing chain sync to fail.\n",
      "created_at" : "2016-07-10T11:38:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8306#issuecomment-231584578",
      "id" : 231584578,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8306",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDIzMTU4NDU3OA==",
      "updated_at" : "2016-07-13T16:17:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/231584578",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @sdaftuar, makes sense.  I'll think about it.\n",
      "created_at" : "2016-07-13T16:15:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8306#issuecomment-232406467",
      "id" : 232406467,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8306",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDIzMjQwNjQ2Nw==",
      "updated_at" : "2016-07-13T16:15:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/232406467",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4943644?v=4",
         "events_url" : "https://api.github.com/users/domob1812/events{/privacy}",
         "followers_url" : "https://api.github.com/users/domob1812/followers",
         "following_url" : "https://api.github.com/users/domob1812/following{/other_user}",
         "gists_url" : "https://api.github.com/users/domob1812/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/domob1812",
         "id" : 4943644,
         "login" : "domob1812",
         "node_id" : "MDQ6VXNlcjQ5NDM2NDQ=",
         "organizations_url" : "https://api.github.com/users/domob1812/orgs",
         "received_events_url" : "https://api.github.com/users/domob1812/received_events",
         "repos_url" : "https://api.github.com/users/domob1812/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/domob1812/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/domob1812/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/domob1812"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@sdaftuar i know it's been a long time since initial patch, but how do you think, if we limit initial @domob1812 fix only to IBD, like:\r\n```\r\nbool hasNewHeaders = true;\r\nif (IsInitialBlockDownload()) {\r\n    hasNewHeaders = (mapBlockIndex.count(headers.back().GetHash()) == 0);\r\n}\r\n...\r\nif (nCount == MAX_HEADERS_RESULTS && pindexLast && hasNewHeaders) {\r\n...\r\n    pfrom->PushMessage(\"getheaders\", chainActive.GetLocator(pindexLast), uint256());\r\n}\r\n```\r\nWill it cause sync stuck case described here https://github.com/bitcoin/bitcoin/pull/8306#issuecomment-231584578 ? \r\n\r\nI'm trying to solve duplicate getheaders requests issue in ZCash and Komodo, bcz in these chains duplicate getheaders requests causes really huge overhead (additional traffic download), bcz of bigger blockheader size (1488 size). Just an example:\r\n```\r\n2020-04-16 02:03:29 more getheaders (1641598) to end to peer=1 (startheight:1836680)\r\n2020-04-16 02:03:29 sending: getheaders (1061 bytes) peer=1\r\n2020-04-16 02:03:29 received: headers (238081 bytes) peer=2\r\n2020-04-16 02:03:29 more getheaders (1641598) to end to peer=2 (startheight:1836680)\r\n2020-04-16 02:03:29 sending: getheaders (1061 bytes) peer=2\r\n2020-04-16 02:03:29 sending: getheaders (1061 bytes) peer=3\r\n2020-04-16 02:03:29 getheaders (1641598) 08685ebc864678e16e9094fafce2119a9c63aae7872dc6fcc974f29cfc201e1e to peer=3\r\n...\r\n2020-04-16 02:03:29 more getheaders (1641598) to end to peer=5 (startheight:1836680)\r\n2020-04-16 02:03:29 sending: getheaders (1061 bytes) peer=5\r\n2020-04-16 02:03:29 received: headers (238081 bytes) peer=5\r\n```\r\nAs we are see here same `getheaders` request sent to peer 1, 2 and 5. And we got 3 replies (`MAX_HEADERS_RESULTS x size(CBlockHeader) = 160 x 1488 = 238081 bytes each`). With ~1.8M blocks in chain it can cause even **~500 Gb** of download traffic during IBD and initial headers sync stage, while the size of entire blockchain is only ~25-30 Gb. I did small test-lab experiment with syncing from scratch from 2 peers in local 1 Gbps network - it downloads 1 Gb of duplicate headers just in few minutes. \r\n\r\nSo, any advice is appreciated.\r\n\r\n**p.s.** Limiting initial fix with `IsInitialBlockDownload()` seems working, trafic download during initial headers sync reducing significantly, but I just want to make sure that there are no any pitfalls.\r\n",
      "created_at" : "2020-04-16T21:53:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8306#issuecomment-614916454",
      "id" : 614916454,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8306",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDkxNjQ1NA==",
      "updated_at" : "2020-04-16T21:53:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614916454",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/22120003?v=4",
         "events_url" : "https://api.github.com/users/DeckerSU/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DeckerSU/followers",
         "following_url" : "https://api.github.com/users/DeckerSU/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DeckerSU/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DeckerSU",
         "id" : 22120003,
         "login" : "DeckerSU",
         "node_id" : "MDQ6VXNlcjIyMTIwMDAz",
         "organizations_url" : "https://api.github.com/users/DeckerSU/orgs",
         "received_events_url" : "https://api.github.com/users/DeckerSU/received_events",
         "repos_url" : "https://api.github.com/users/DeckerSU/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DeckerSU/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DeckerSU/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DeckerSU"
      }
   }
]
