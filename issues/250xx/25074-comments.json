[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-05-06T12:54:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#issuecomment-1119586198",
      "id" : 1119586198,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25074",
      "node_id" : "IC_kwDOABII585Cu4eW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1119586198/reactions"
      },
      "updated_at" : "2022-05-06T12:54:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1119586198",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I wonder if it would make sense to always re-index the initial best block too, just to avoid accidentally running with such corruption undetected.",
      "created_at" : "2022-05-09T21:33:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#issuecomment-1121604985",
      "id" : 1121604985,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25074",
      "node_id" : "IC_kwDOABII585C2lV5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1121604985/reactions"
      },
      "updated_at" : "2022-05-09T21:33:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1121604985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r868492947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/868492947"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`current_time` is stale here. Maybe instead of moving this, it'd be better to just `SetBestBlockIndex(pindex->pprev);`?",
      "commit_id" : "75f53f1e1fc6917eac40e51ce7b6bec2717bd526",
      "created_at" : "2022-05-09T21:39:13Z",
      "diff_hunk" : "@@ -185,6 +178,13 @@ void BaseIndex::ThreadSync()\n                            __func__, pindex->GetBlockHash().ToString());\n                 return;\n             }\n+\n+            if (last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r868492947",
      "id" : 868492947,
      "line" : 182,
      "node_id" : "PRRC_kwDOABII584zxCaT",
      "original_commit_id" : "75f53f1e1fc6917eac40e51ce7b6bec2717bd526",
      "original_line" : 182,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 19,
      "pull_request_review_id" : 966860653,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/868492947/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-09T21:39:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/868492947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r869806954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869806954"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/25074#discussion_r868492947\r\n\r\n> `current_time` is stale here. Maybe instead of moving this, it'd be better to just `SetBestBlockIndex(pindex->pprev);`?\r\n\r\nYeah probably the reason this bug was introduced is that original author was trying to avoid `current_time` being stale. But `pindex->pprev` would be the wrong best block index to use in the `Rewind()` case above. It would be pointing to parent of the rewind block instead of the block that was actually rewound to. I guess this would be better than current behavior, but still technically incorrect, and seems like it would be fragile even if current index subclasses are ok with it.\r\n\r\nI think using stale rewind time is ok and probably better than the alternatives, even if it seems a little wonky. This is all replaced anyway in 1819bdb7cb0634dad2e07daccfe7e8a122a943d6 from #24230, as Martin noted in https://github.com/bitcoin/bitcoin/pull/24230#discussion_r866785619\r\n\r\n",
      "commit_id" : "75f53f1e1fc6917eac40e51ce7b6bec2717bd526",
      "created_at" : "2022-05-11T02:02:26Z",
      "diff_hunk" : "@@ -185,6 +178,13 @@ void BaseIndex::ThreadSync()\n                            __func__, pindex->GetBlockHash().ToString());\n                 return;\n             }\n+\n+            if (last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r869806954",
      "id" : 869806954,
      "in_reply_to_id" : 868492947,
      "line" : 182,
      "node_id" : "PRRC_kwDOABII584z2DNq",
      "original_commit_id" : "75f53f1e1fc6917eac40e51ce7b6bec2717bd526",
      "original_line" : 182,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 19,
      "pull_request_review_id" : 968587279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869806954/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-11T02:06:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869806954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r869815696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869815696"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">But pindex->pprev would be the wrong best block index to use in the Rewind() case above. It would be pointing to parent of the rewind block instead of the block that was actually rewound to. I guess this would be better than current behavior, but still technically incorrect,\r\n\r\nI don't see how it would even be incorrect... After the rewind, `pindex` is changed to the block one beyond that which the index should be current to...?",
      "commit_id" : "75f53f1e1fc6917eac40e51ce7b6bec2717bd526",
      "created_at" : "2022-05-11T02:26:35Z",
      "diff_hunk" : "@@ -185,6 +178,13 @@ void BaseIndex::ThreadSync()\n                            __func__, pindex->GetBlockHash().ToString());\n                 return;\n             }\n+\n+            if (last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r869815696",
      "id" : 869815696,
      "in_reply_to_id" : 868492947,
      "line" : 182,
      "node_id" : "PRRC_kwDOABII584z2FWQ",
      "original_commit_id" : "75f53f1e1fc6917eac40e51ce7b6bec2717bd526",
      "original_line" : 182,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 19,
      "pull_request_review_id" : 968598687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869815696/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-11T02:26:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869815696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r869821236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869821236"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I don't see how it would even be incorrect... After the rewind, `pindex` is changed to the block one beyond that which the index should be current to...?\r\n\r\nOops, you're right. I didn't notice NextSyncBlock was returning the next block after the fork. So I think your `pindex->pprev` suggestion is good and makes sense, and probably a little better than the current fix, though I think both fixes are fine.",
      "commit_id" : "75f53f1e1fc6917eac40e51ce7b6bec2717bd526",
      "created_at" : "2022-05-11T02:41:40Z",
      "diff_hunk" : "@@ -185,6 +178,13 @@ void BaseIndex::ThreadSync()\n                            __func__, pindex->GetBlockHash().ToString());\n                 return;\n             }\n+\n+            if (last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r869821236",
      "id" : 869821236,
      "in_reply_to_id" : 868492947,
      "line" : 182,
      "node_id" : "PRRC_kwDOABII584z2Gs0",
      "original_commit_id" : "75f53f1e1fc6917eac40e51ce7b6bec2717bd526",
      "original_line" : 182,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 19,
      "pull_request_review_id" : 968605709,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869821236/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-11T02:41:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/869821236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2022-05-12T07:48:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#issuecomment-1124646828",
      "id" : 1124646828,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25074",
      "node_id" : "IC_kwDOABII585DCL-s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124646828/reactions"
      },
      "updated_at" : "2022-05-12T07:48:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124646828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-05-12T09:17:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#issuecomment-1124733511",
      "id" : 1124733511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25074",
      "node_id" : "IC_kwDOABII585DChJH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124733511/reactions"
      },
      "updated_at" : "2022-05-18T08:13:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124733511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r871905238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/871905238"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I changed it to Luke's suggestion and adjusted the commit message, thanks.\r\nWhile this is simpler, `current_time` being a bit stale shouldn't ever be a serious problem in my opinion -  I think of updating the best block / committing it every 30s as a non-essential but nice-to-have feature that may save users some time in case of shutdowns, if we removed this block completely, it shouldn't break anything.",
      "commit_id" : "9d4509b64ee333ef4587c77fb0d52e8e720a28c4",
      "created_at" : "2022-05-13T00:12:41Z",
      "diff_hunk" : "@@ -185,6 +178,13 @@ void BaseIndex::ThreadSync()\n                            __func__, pindex->GetBlockHash().ToString());\n                 return;\n             }\n+\n+            if (last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r871905238",
      "id" : 871905238,
      "in_reply_to_id" : 868492947,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584z-DfW",
      "original_commit_id" : "75f53f1e1fc6917eac40e51ce7b6bec2717bd526",
      "original_line" : 182,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 971582230,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/871905238/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-13T10:05:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/871905238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I pushed an update, implementing Luke's [suggestion](https://github.com/bitcoin/bitcoin/pull/25074#discussion_r868492947).\r\n\r\n> I wonder if it would make sense to always re-index the initial best block too, just to avoid accidentally running with such corruption undetected.\r\n\r\nIt does get detected for the coinstatsindex, leading to an init error - that's how I encountered this, playing around with uprobes that send kill signals to bitcoind ([branch](https://github.com/mzumsande/bitcoin/commit/706967b5880bdc04605ffac334da19f02ebad7d3)). But other indexes may not. \r\nSince this should not be possible unless there is a logic bug in the index code, checking on startup that there is an indexed entry for the best block / aborting otherwise may be another way instead of attempting to recover ?",
      "created_at" : "2022-05-13T00:31:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#issuecomment-1125544043",
      "id" : 1125544043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25074",
      "node_id" : "IC_kwDOABII585DFnBr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125544043/reactions"
      },
      "updated_at" : "2022-05-13T00:31:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125544043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r876478322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876478322"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"index: Don't commit a best block before indexing it during sync\" (9d4509b64ee333ef4587c77fb0d52e8e720a28c4)\r\n\r\nI think commit description saying previous code leaves the \"index database temporarily in an inconsistent state\" is a little misleading, because the bug could permanently corrupt the index if node is killed before the block is committed. I'd drop the word \"temporarily\" and maybe mention that this could lead to corruption if the sync is interrupted at a bad time.\r\n\r\nAlso could add: \r\n\r\n```\r\nCo-authored-by: Luke Dashjr <luke-jr+git@utopios.org>\r\n```\r\n\r\nsince he spotted the simpler fix",
      "commit_id" : "9d4509b64ee333ef4587c77fb0d52e8e720a28c4",
      "created_at" : "2022-05-19T00:21:01Z",
      "diff_hunk" : "@@ -168,7 +168,7 @@ void BaseIndex::ThreadSync()\n             }\n \n             if (last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time) {\n-                SetBestBlockIndex(pindex);\n+                SetBestBlockIndex(pindex->pprev);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r876478322",
      "id" : 876478322,
      "line" : 171,
      "node_id" : "PRRC_kwDOABII5840Pf9y",
      "original_commit_id" : "9d4509b64ee333ef4587c77fb0d52e8e720a28c4",
      "original_line" : 171,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 5,
      "pull_request_review_id" : 977783077,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876478322/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-19T00:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876478322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r876935589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876935589"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done both. I meant \"temporarily\" as in \"until the committed best block is indexed\" and made that more clear in the commit message and the OP.",
      "commit_id" : "7171ebc7cbd911fa7ccad732ea7f73bce30928ee",
      "created_at" : "2022-05-19T11:22:45Z",
      "diff_hunk" : "@@ -168,7 +168,7 @@ void BaseIndex::ThreadSync()\n             }\n \n             if (last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time) {\n-                SetBestBlockIndex(pindex);\n+                SetBestBlockIndex(pindex->pprev);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#discussion_r876935589",
      "id" : 876935589,
      "in_reply_to_id" : 876478322,
      "line" : 171,
      "node_id" : "PRRC_kwDOABII5840RPml",
      "original_commit_id" : "9d4509b64ee333ef4587c77fb0d52e8e720a28c4",
      "original_line" : 171,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 5,
      "pull_request_review_id" : 978402064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25074",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876935589/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-19T11:25:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876935589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "[9d4509b](https://github.com/bitcoin/bitcoin/commit/9d4509b64ee333ef4587c77fb0d52e8e720a28c4) -> [7171ebc](https://github.com/bitcoin/bitcoin/commit/7171ebc7cbd911fa7ccad732ea7f73bce30928ee): Updated the commit message and the PR description.\r\n\r\n> I was thinking probably it would be possible write a unit test for this with a mock BaseIndex subclass that overrides the `CommitInternal()` and `WriteBlock()` methods and checks that commit is called with the last block written, not the next block about to be written during sync. I don't think this is necessary however, since the bug is pretty theoretical and seems unlikely to happen in practice.\r\n\r\nI think that having a test-only mock index is a really interesting idea, and that it could help with increasing the test coverage. I'd be interested to look into this as a follow-up, with the goal of improving the test coverage of the base index logic more broadly (not only with respect to this issue, I think if the mock index class tested only this it might be a bit overkill). \r\n\r\n",
      "created_at" : "2022-05-19T11:39:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25074#issuecomment-1131581453",
      "id" : 1131581453,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25074",
      "node_id" : "IC_kwDOABII585DcpAN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131581453/reactions"
      },
      "updated_at" : "2022-05-19T11:44:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131581453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
