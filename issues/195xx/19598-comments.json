[
   {
      "author_association" : "NONE",
      "body" : "for those who doesn't have linqpad I adapted the script to be run on dotnetfiddle here\r\n\r\nhttps://dotnetfiddle.net/wT87D2",
      "created_at" : "2020-07-27T13:45:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19598#issuecomment-664405965",
      "id" : 664405965,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19598",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NDQwNTk2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-27T13:45:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/664405965",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5107375?v=4",
         "events_url" : "https://api.github.com/users/MithrilMan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MithrilMan/followers",
         "following_url" : "https://api.github.com/users/MithrilMan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MithrilMan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MithrilMan",
         "id" : 5107375,
         "login" : "MithrilMan",
         "node_id" : "MDQ6VXNlcjUxMDczNzU=",
         "organizations_url" : "https://api.github.com/users/MithrilMan/orgs",
         "received_events_url" : "https://api.github.com/users/MithrilMan/received_events",
         "repos_url" : "https://api.github.com/users/MithrilMan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MithrilMan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MithrilMan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MithrilMan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "* I think you're right that an O(log n) solution is possible.\r\n\r\n* I don't understand what you mean by \"without having to use a solution like that `mutated` boolean parameter\". That's just an interface question - a different algorithm would still need a way to report malleation back to the caller. It could do that in the same way, or a different way, but that shouldn't depend on the algorithm.\r\n\r\n* The performance of the malleability check in the existing code is absolutely negligible. It's one extra 32-byte comparison (~nanoseconds) added per inner hash (~100s of nanoseconds at the very least). Even if a better solution is available, I don't think we should touch this critical piece of code unless benchmarks show a significant improvement (which I doubt).\r\n\r\n* I can't follow your code, but I think this observation captures is: if the malleability trick is exploited, it must mean that at some level in the tree there is an even number of nodes where the real tree had an odd number - and the last entry was duplicated. This means that at every level we should only check the last two nodes for equality, rather than all pairs of two nodes.\r\n\r\nThis *should* do it (untested):\r\n\r\n```c++\r\nuint256 ComputeMerkleRoot(std::vector<uint256> hashes, bool* mutated) {\r\n    bool mutation = false;\r\n    while (hashes.size() > 1) {\r\n        if (mutated && !mutation && hashes.size() % 2 == 0) {\r\n            if (hashes[hashes.size() - 1] == hashes[hashes.size() - 2]) mutation = true;\r\n        }\r\n        if (hashes.size() & 1) {\r\n            hashes.push_back(hashes.back());\r\n        }\r\n        SHA256D64(hashes[0].begin(), hashes[0].begin(), hashes.size() / 2);\r\n        hashes.resize(hashes.size() / 2);\r\n    }\r\n    if (mutated) *mutated = mutation;\r\n    if (hashes.size() == 0) return uint256();\r\n    return hashes[0];\r\n}\r\n```\r\n",
      "created_at" : "2020-09-16T06:55:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19598#issuecomment-693212439",
      "id" : 693212439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19598",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzIxMjQzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T06:55:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693212439",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, wrt sipa's fourth bullet point.",
      "created_at" : "2020-09-16T07:21:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19598#issuecomment-693224011",
      "id" : 693224011,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19598",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzIyNDAxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T07:21:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693224011",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "FWIW, my point is that we *shouldn't* change anything; I'm just showing something that I think could work in the 4th point.",
      "created_at" : "2020-09-16T16:19:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19598#issuecomment-693513884",
      "id" : 693513884,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19598",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzUxMzg4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T16:19:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693513884",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> * The performance of the malleability check in the existing code is absolutely negligible. It's one extra 32-byte comparison (~nanoseconds) added per inner hash (~100s of nanoseconds at the very least). Even if a better solution is available, I don't think we should touch this critical piece of code unless benchmarks show a significant improvement (which I doubt).\r\n> * I can't follow your code, but I think this observation captures is: if the malleability trick is exploited, it must mean that at some level in the tree there is an even number of nodes where the real tree had an odd number - and the last entry was duplicated. This means that at every level we should only check the last two nodes for equality, rather than all pairs of two nodes.\r\n\r\nNo, implication is bigger.\r\nIn my implementation I check only the lower level of the tree saving lot of checks and the checks isn't about having even/odd node numbers\r\nthis is the copy&pasted code from my gist\r\n\r\n```\r\n// not a bitcoin double hash, not important for POC code\r\npublic string ComputeMerkleRoot(IList<string> hashes)\r\n{\r\n\tif (hashes.Count == 0) return String.Empty;\r\n\r\n\tbool oddHashes = (hashes.Count & 1) == 1;\r\n\t//ensure to allocate one more item if hashes are odd.\r\n\tList<string> hashesList = new List<string>(oddHashes ? hashes.Count + 1 : hashes.Count);\r\n\r\n\tfor (int i = 0; i < hashes.Count; i++)\r\n\t{\r\n\t\thashesList.Add(hashes[i]);\r\n\t}\r\n\r\n\t// if odd, duplicate last element\r\n\tif (oddHashes)\r\n\t{\r\n\t\thashesList.Add(hashes[hashes.Count - 1]);\r\n\t}\r\n\r\n\tvar hashAlgo = HashAlgorithm.Create(\"SHA256\");\r\n\tint elementsCount = hashesList.Count;\r\n\twhile (elementsCount > 1)\r\n\t{\r\n\t\tint newHashPosition = 0;\r\n\t\tfor (int pos = 0; pos + 1 < elementsCount; pos += 2)\r\n\t\t{\r\n\t\t\tstring pairOfHashes = hashesList[pos] + hashesList[pos + 1];\r\n\r\n\t\t\thashesList[newHashPosition++] = ASCIIEncoding.Unicode.GetString(hashAlgo.ComputeHash(ASCIIEncoding.Unicode.GetBytes(pairOfHashes)));\r\n\t\t}\r\n\r\n\t\tif (newHashPosition > 1 && (newHashPosition & 1) == 1)\r\n\t\t{\r\n\t\t\thashesList[newHashPosition] = hashesList[newHashPosition - 1];\r\n\t\t\tnewHashPosition++;\r\n\t\t}\r\n\r\n\t\thashesList.RemoveRange(newHashPosition, elementsCount - newHashPosition);\r\n\t\telementsCount = newHashPosition;\r\n\t}\r\n\r\n\treturn BitConverter.ToString(ASCIIEncoding.Unicode.GetBytes(hashesList[0])).Replace(\"-\", \"\");\r\n}\r\n```\r\n\r\nI can comment/explain the code if it's not easy to follow.\r\nThis code that computes merklee tree is implemented without the boolean flag that return if it's malleated or not (separation of concerns)",
      "created_at" : "2020-09-18T12:57:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19598#issuecomment-694851356",
      "id" : 694851356,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19598",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NDg1MTM1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-18T13:07:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/694851356",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5107375?v=4",
         "events_url" : "https://api.github.com/users/MithrilMan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MithrilMan/followers",
         "following_url" : "https://api.github.com/users/MithrilMan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MithrilMan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MithrilMan",
         "id" : 5107375,
         "login" : "MithrilMan",
         "node_id" : "MDQ6VXNlcjUxMDczNzU=",
         "organizations_url" : "https://api.github.com/users/MithrilMan/orgs",
         "received_events_url" : "https://api.github.com/users/MithrilMan/received_events",
         "repos_url" : "https://api.github.com/users/MithrilMan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MithrilMan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MithrilMan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MithrilMan"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "and this is the code that can check if there is a malleability in place (thus no need to have ComputeMerkleRoot polluted with that boolean flag like I said in point 2\r\n\r\n```\r\nList<string> transactions = GetTransactions(transactionSet).Select(c => c.ToString()).ToList();\r\nuint transactionsCount = ((uint)transactions.Count);\r\nbool transactionCountIsOdd = (transactionsCount & 1) == 1;\r\nuint higherBitPosition = (uint)(sizeof(uint) * 8 - (BitOperations.LeadingZeroCount(transactionsCount - 1) + 1));\r\nuint safePoint = ((uint)Math.Pow(2, higherBitPosition));\r\nuint itemsToConsider = transactionsCount - safePoint;\r\n\r\nstring transactionToFind = transactions.Last();\r\nint transactionIndexToCompare = transactions.Count - 2;\r\nint expStep = transactionCountIsOdd ? 2 : 1;\r\n\r\nint numberOfChecks = 0;\r\nwhile (expStep < itemsToConsider)\r\n{\r\n\tnumberOfChecks++;\r\n\t$\"comparing {transactionToFind} with {transactions[transactionIndexToCompare]}\".Dump();\r\n\tif (transactions[transactionIndexToCompare] == transactionToFind)\r\n\t{\r\n\t\t\"\".PadRight(120, '-').Dump($\"FOUND MALLEABLE BLOCK: {transactionToFind} found both on last position and at position {transactionIndexToCompare}. Checks performed: {numberOfChecks})\");\r\n\t\treturn;\r\n\t}\r\n\r\n\ttransactionIndexToCompare -= expStep;\r\n\texpStep <<= 1;\r\n}\r\n```",
      "created_at" : "2020-09-18T13:05:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19598#issuecomment-694855746",
      "id" : 694855746,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19598",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NDg1NTc0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-18T13:10:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/694855746",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5107375?v=4",
         "events_url" : "https://api.github.com/users/MithrilMan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MithrilMan/followers",
         "following_url" : "https://api.github.com/users/MithrilMan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MithrilMan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MithrilMan",
         "id" : 5107375,
         "login" : "MithrilMan",
         "node_id" : "MDQ6VXNlcjUxMDczNzU=",
         "organizations_url" : "https://api.github.com/users/MithrilMan/orgs",
         "received_events_url" : "https://api.github.com/users/MithrilMan/received_events",
         "repos_url" : "https://api.github.com/users/MithrilMan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MithrilMan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MithrilMan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MithrilMan"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "let me try to summarize some concept behind this (sorry if I fail to use correct terminology here and there):\r\n\r\n- it's impossible to malleate a block duplicating less than the max pow of 2 transaction count (this is why I visualized the vertical line that I named \"safe point\".\r\ne.g. if you have a block that have 10 transactions, you know that it can be malleable just by duplicating the last 2 (because the first 8 belongs to a different node up in the hierarchy\r\n\r\n- In order to not have to check every level of the tree, I do a simple (smart?) thing: I choose a specific element of comparison that may indicate that a duplication took place and it's the last transaction hash.\r\n`string transactionToFind = transactions.Last();`\r\n\r\nOnce I have it, I start then a loop where, at each iteration, I check if that element is the same as the one at a different index int `transactionIndexToCompare` where transactionIndexToCompare starts from the second last transaction and move exponentially backward at each iteration (there is a caveat if the number of transaction is odd or even, handled by `int expStep = transactionCountIsOdd ? 2 : 1;` before start the loop\r\n\r\nof course if I find these 2 elements that are equal it means a malleability took place\r\n\r\nalso note that I stop the loop when the index pass the so called \"safe point\", saving even more comparisons.\r\n\r\nTLTR: my implementation is O(Log n) over a list of transaction hashes, doesn't need to be part of the merkle tree computation method and save lot of checks other than applying the separation of concerns",
      "created_at" : "2020-09-18T13:22:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19598#issuecomment-694864631",
      "id" : 694864631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19598",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NDg2NDYzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-18T13:26:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/694864631",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5107375?v=4",
         "events_url" : "https://api.github.com/users/MithrilMan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MithrilMan/followers",
         "following_url" : "https://api.github.com/users/MithrilMan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MithrilMan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MithrilMan",
         "id" : 5107375,
         "login" : "MithrilMan",
         "node_id" : "MDQ6VXNlcjUxMDczNzU=",
         "organizations_url" : "https://api.github.com/users/MithrilMan/orgs",
         "received_events_url" : "https://api.github.com/users/MithrilMan/received_events",
         "repos_url" : "https://api.github.com/users/MithrilMan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MithrilMan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MithrilMan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MithrilMan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The performance of the malleability check in the existing code is absolutely negligible. It's one extra 32-byte comparison (~nanoseconds) added per inner hash (~100s of nanoseconds at the very least). Even if a better solution is available, I don't think we should touch this critical piece of code unless benchmarks show a significant improvement (which I doubt).\r\n\r\n\r\nTend to agree with this. Will close this for now until there is a proven (wall-clock) time performance improvement on IBD or some other real-world load.",
      "created_at" : "2020-09-20T13:19:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19598#issuecomment-695786455",
      "id" : 695786455,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19598",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTc4NjQ1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-20T13:19:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695786455",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
