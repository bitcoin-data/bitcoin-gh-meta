[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21726 (Add prune blockers to BlockManager by fjahr)\n* #21584 (Fix assumeutxo crash due to invalid base_blockhash by MarcoFalke)\n* #20295 (rpc: getblockfrompeer by Sjors)\n* #17167 (Allow whitelisting outgoing connections by luke-jr)\n* #13462 (Make SER_GETHASH implicit for CHashWriter and SerializeHash by Empact)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-07-15T05:44:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-658558618",
      "id" : 658558618,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODU1ODYxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-23T14:20:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658558618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r463328440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463328440"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-07-30T23:37:22Z",
      "diff_hunk" : "@@ -1003,10 +1012,12 @@ bool AppInitParameterInteraction()\n         return InitError(_(\"Cannot set -peerblockfilters without -blockfilterindex.\"));\n     }\n \n-    // if using block pruning, then disallow txindex\n+    // if using block pruning, then disallow txindex, coinstatsindex and blockfilterindex\n     if (gArgs.GetArg(\"-prune\", 0)) {\n         if (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX))\n             return InitError(_(\"Prune mode is incompatible with -txindex.\"));\n+        if (gArgs.GetBoolArg(\"-coinstatsindex\", DEFAULT_COINSTATSINDEX))\n+            return InitError(_(\"Prune mode is incompatible with -coinstatsindex.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r463328440",
      "id" : 463328440,
      "line" : 964,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMyODQ0MA==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 964,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 56,
      "pull_request_review_id" : 458831985,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463328440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r463993512"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463993512"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It syncs over the whole blockchain, processing every block and saving state on each. That allows users to query the stats for every block height (a nice-to-have feature). It's the standard way `BaseIndex` currently works, although changing that would probably only require minimal effort. Potential users who I have talked to didn't really care much about this. But I will look into it if this again since progress is slow anyway currently.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-01T19:41:46Z",
      "diff_hunk" : "@@ -1003,10 +1012,12 @@ bool AppInitParameterInteraction()\n         return InitError(_(\"Cannot set -peerblockfilters without -blockfilterindex.\"));\n     }\n \n-    // if using block pruning, then disallow txindex\n+    // if using block pruning, then disallow txindex, coinstatsindex and blockfilterindex\n     if (gArgs.GetArg(\"-prune\", 0)) {\n         if (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX))\n             return InitError(_(\"Prune mode is incompatible with -txindex.\"));\n+        if (gArgs.GetBoolArg(\"-coinstatsindex\", DEFAULT_COINSTATSINDEX))\n+            return InitError(_(\"Prune mode is incompatible with -coinstatsindex.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r463993512",
      "id" : 463993512,
      "in_reply_to_id" : 463328440,
      "line" : 964,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk5MzUxMg==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 964,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 56,
      "pull_request_review_id" : 459599507,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463993512",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471199276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471199276"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A comment explaining \"bogo\" would be helpful, I looked at the function that calculates it and it didn't make intuitive sense to me.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-17T02:17:33Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471199276",
      "id" : 471199276,
      "line" : 24,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE5OTI3Ng==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 24,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 24,
      "pull_request_review_id" : 468129702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471199276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471199582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471199582"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can we add `unspendable_amount` to the index data and include the genesis block in it?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-17T02:19:13Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471199582",
      "id" : 471199582,
      "line" : 112,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE5OTU4Mg==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 112,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 112,
      "pull_request_review_id" : 468129702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471199582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471199972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471199972"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm assuming these would be added to `unspendable_amount` too",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-17T02:20:42Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471199972",
      "id" : 471199972,
      "line" : 139,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE5OTk3Mg==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 139,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 139,
      "pull_request_review_id" : 468129702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471199972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471200138"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471200138"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this would be 3/3 of `unspendable_amount` items.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-17T02:21:33Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471200138",
      "id" : 471200138,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIwMDEzOA==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 145,
      "original_position" : 145,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 468129702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471200138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471203531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471203531"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If I understand the logic, `total_amount` is the net increase of coins due to this block?\r\n\r\nI don't want to bloat your stats index, but I'd be interested in adding `total_prevout_spent_amount`, `total_new_outputs_ex_coinbase_amount`, and `coinbase_amount` to unpack `total_amount`.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-17T02:38:42Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471203531",
      "id" : 471203531,
      "line" : 25,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIwMzUzMQ==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 25,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 25,
      "pull_request_review_id" : 468129702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471203531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-17T11:55:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-674837048",
      "id" : 674837048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NDgzNzA0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-17T11:55:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674837048",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471805502"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471805502"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think bogo just stands for bogus, indicating that this metric is not meaningful in any way other than comparing it to itself, i.e. has the UTXO set grown or shrunk over the last x blocks. I added a comment on the calculation and improved the RPC help with the same text.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-17T22:18:09Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471805502",
      "id" : 471805502,
      "in_reply_to_id" : 471199276,
      "line" : 24,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgwNTUwMg==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 24,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 24,
      "pull_request_review_id" : 468869319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471805502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471805619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471805619"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Actually 3/4 :) The unclaimed block rewards need to be included as well. (See code and/or my [blog post](https://fjahr.com/posts/where-are-the-coins/))",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-17T22:18:28Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471805619",
      "id" : 471805619,
      "in_reply_to_id" : 471200138,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgwNTYxOQ==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 145,
      "original_position" : 145,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 468869425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471805619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471805744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471805744"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It is the total amount of coins in the UTXO set at that block height. So it's accumulative rather than for this specific block. I added the other values in a draft commit, needs some cleanup but ready to test.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-17T22:18:51Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r471805744",
      "id" : 471805744,
      "in_reply_to_id" : 471203531,
      "line" : 25,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgwNTc0NA==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 25,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 25,
      "pull_request_review_id" : 468869591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471805744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@PierreRochard Thanks a lot for the comments! I am happy to include these values you requested and drafted that up in a new commit (will need another day for clean-up, docs, tests etc. but it should work already). I actually had done some [similar work](https://github.com/fjahr/bitcoin/commit/4d08663e5d2a4eeda06a408c3fef6361475d3ce6) already for my [blog post](https://fjahr.com/posts/where-are-the-coins/) and was thinking about adding some more numbers myself, just opted to keep the changeset small at the end.\r\n\r\nThe RPC now has the values for every block by passing a verbose flag `true` after the block indicator (example is testnet):\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo 'none' 1800003 true\r\n{\r\n  \"height\": 1800003,\r\n  \"bestblock\": \"00000000000005359e00fe3d069b2999baaaf4d69a34492e543f9f82047ddd01\",\r\n  \"txouts\": 23990594,\r\n  \"bogosize\": 1799579780,\r\n  \"disk_size\": 1341237413,\r\n  \"total_amount\": 20940531.15125810,\r\n  \"block_info\": {\r\n    \"unspendable_amount\": 0.00000000,\r\n    \"total_prevout_spent_amount\": 0.21428778,\r\n    \"total_new_outputs_ex_coinbase_amount\": 0.21428778,\r\n    \"coinbase_amount\": 0.19531250\r\n  }\r\n}\r\n```\r\n\r\nI just noticed when I was almost done, that I wasn't sure if you would like these requested values to be cumulative or per-block. They are per-block now but it is trivial to change that. Actually, I could even do both. And another questions: should the unspendable output values be included or excluded from the other output values. Example: `src/bitcoin-cli gettxoutsetinfo 'none' 0 true` shows `coinbase: 50.0` although that is unspendable. Same for the `total_new_outputs_ex_coinbase_amount` if there is an `OP_RETURN` for example. Just a question of the definition.\r\n\r\nAnd I saw your request for the data dump on twitter. Will look into that as a follow-up :)",
      "created_at" : "2020-08-17T22:18:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-675143288",
      "id" : 675143288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTE0MzI4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-17T22:18:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675143288",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nWould be nice to be able to see the `total_unspendable_amount` up to that current block.",
      "created_at" : "2020-08-17T23:02:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-675156917",
      "id" : 675156917,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTE1NjkxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-17T23:02:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675156917",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/15256660?v=4",
         "events_url" : "https://api.github.com/users/benthecarman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benthecarman/followers",
         "following_url" : "https://api.github.com/users/benthecarman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benthecarman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benthecarman",
         "id" : 15256660,
         "login" : "benthecarman",
         "node_id" : "MDQ6VXNlcjE1MjU2NjYw",
         "organizations_url" : "https://api.github.com/users/benthecarman/orgs",
         "received_events_url" : "https://api.github.com/users/benthecarman/received_events",
         "repos_url" : "https://api.github.com/users/benthecarman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benthecarman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benthecarman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benthecarman"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-08-18T07:52:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-675319765",
      "id" : 675319765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTMxOTc2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-18T07:52:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675319765",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r474290951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474290951"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this is causing BIP30 blocks to be double counted as unspendable\r\n\r\n`bitcoin-cli gettxoutsetinfo 'none' 91722 true`\r\n\r\n`\"unspendable_amount\": 100.00000000`",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-20T21:46:57Z",
      "diff_hunk" : "@@ -0,0 +1,364 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    CAmount unspendable_amount;\n+    CAmount total_prevout_spent_amount;\n+    CAmount total_new_outputs_ex_coinbase_amount;\n+    CAmount coinbase_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+        READWRITE(obj.unspendable_amount);\n+        READWRITE(obj.total_prevout_spent_amount);\n+        READWRITE(obj.total_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.coinbase_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+\n+        m_unspendable_amount = 0;\n+        m_total_prevout_spent_amount = 0;\n+        m_total_new_outputs_ex_coinbase_amount = 0;\n+        m_coinbase_amount = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    CAmount block_subsidy = GetBlockSubsidy(pindex->nHeight, Params().GetConsensus());\n+    CAmount total_in = 0;\n+    CAmount total_out = 0;\n+    m_unspendable_amount = 0;\n+\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_unspendable_amount += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                total_out += coin.out.nValue;\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_unspendable_amount += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+\n+                    total_in += coin.out.nValue;\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    } else {\n+        // Genesis block\n+        m_unspendable_amount += block_subsidy;\n+    }\n+\n+    m_coinbase_amount = block_subsidy;\n+    m_total_prevout_spent_amount = total_in;\n+\n+    if (pindex->nHeight > 0) {\n+        m_total_new_outputs_ex_coinbase_amount = total_out - block_subsidy;\n+\n+        // Unclaimed block rewards\n+        if ((total_in + block_subsidy) > total_out) {\n+            m_unspendable_amount += (total_in + block_subsidy - total_out);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r474290951",
      "id" : 474290951,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5MDk1MQ==",
      "original_commit_id" : "7139c1798819074123fd2b841e54eeafe849bc5a",
      "original_line" : 203,
      "original_position" : 203,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 472008569,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474290951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`values to be cumulative or per-block`\r\n\r\nI find it easier to do the cumulative sum in pandas than to back in to the per-block, but the answer also depends on the performance of the underlying index for aggregate queries. If this behaves like a SQL database and we want it to be normalized, it should be per-block, but I'm not religious about it.",
      "created_at" : "2020-08-20T23:39:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-677958519",
      "id" : 677958519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3Nzk1ODUxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-20T23:39:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/677958519",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@PierreRochard Thanks for testing and further feedback. As I have written the tests today and did further cleanup I have found that I hadn't been really doing what you were looking for in the coinbase_amount. I was simply returning the block subsidy there. \r\n\r\nI am pushing my fixes and test as a separate commit for now since you were already testing with the first version:\r\n- Adds `total_unspendable_amount`, the cumulative number as requested\r\n- Tests for different unspendables (except BIP30 because that is pretty hard to test)\r\n- Cleans up internal naming and removes some indirections that caused bugs in some scenarios (removes `total_in` and `total_out` for example)\r\n\r\nI think the formula in `block_sanity_check` in the test is what should hold for each block and that is how you intended it, correct?\r\n```\r\n    assert_equal(\r\n        block_info['total_prevout_spent_amount'] + block_subsidy,\r\n        block_info['total_new_outputs_ex_coinbase_amount'] + block_info['coinbase_amount'] + block_info['unspendable_amount']\r\n    )\r\n```\r\n\r\nI think the new code also fixes the BIP30 issue you discovered but I am still syncing the new version of the index with not-super-fast hardware so I will be able to check tomorrow.",
      "created_at" : "2020-08-21T00:33:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-677973339",
      "id" : 677973339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3Nzk3MzMzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-21T00:33:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/677973339",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, perfect, that equation is exactly right. I'll just delete the coinstats index file for now but does this indexing system have versioning/migrations? ",
      "created_at" : "2020-08-21T02:09:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-677997938",
      "id" : 677997938,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3Nzk5NzkzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-21T02:09:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/677997938",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "From testnet:\r\n\r\n```\r\ngettxoutsetinfo  none 1807942 true\r\n{\r\n  \"height\": 1807942,\r\n  \"bestblock\": \"00000000374715d95667998b720a60bf8241182b279c913573f5e9e3fa54ba00\",\r\n  \"txouts\": 24100924,\r\n  \"bogosize\": 1807675952,\r\n  \"disk_size\": 1318392833,\r\n  \"total_amount\": 20942081.72908999,\r\n  \"total_unspendable_amount\": 875.88809751,\r\n  \"block_info\": {\r\n    \"unspendable_amount\": 0.00000000,\r\n    \"total_prevout_spent_amount\": 16798.39641164,\r\n    \"total_new_outputs_ex_coinbase_amount\": 16798.36929066,\r\n    \"coinbase_amount\": 0.22243348\r\n  }\r\n}\r\n\r\n```\r\n\r\nLooking good!",
      "created_at" : "2020-08-21T05:19:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-678043934",
      "id" : 678043934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3ODA0MzkzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-21T05:19:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/678043934",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/15256660?v=4",
         "events_url" : "https://api.github.com/users/benthecarman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benthecarman/followers",
         "following_url" : "https://api.github.com/users/benthecarman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benthecarman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benthecarman",
         "id" : 15256660,
         "login" : "benthecarman",
         "node_id" : "MDQ6VXNlcjE1MjU2NjYw",
         "organizations_url" : "https://api.github.com/users/benthecarman/orgs",
         "received_events_url" : "https://api.github.com/users/benthecarman/received_events",
         "repos_url" : "https://api.github.com/users/benthecarman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benthecarman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benthecarman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benthecarman"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Yes, perfect, that equation is exactly right. I'll just delete the coinstats index file for now but does this indexing system have versioning/migrations?\r\n\r\nGreat! There is only a different kind of migration for txindex because it was around before the whole `BaseIndex` class was introduced. It is something that I have been thinking about already because I will add the UTXO set hash at some point. I am still figuring out what would work best for Coinstats but also other indexes in general, so for now the index needs to be deleted and resynced, unfortunately.",
      "created_at" : "2020-08-21T12:26:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-678263874",
      "id" : 678263874,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3ODI2Mzg3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-21T12:26:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/678263874",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Cleaned up the latest changes and tests in more coherent commits. This is ready for review now.",
      "created_at" : "2020-08-22T19:51:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-678685225",
      "id" : 678685225,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3ODY4NTIyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-22T19:51:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/678685225",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r475161291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475161291"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This only counts the first output of the coinbase tx as being the coinbase amount, which doesn't necessarily hold true ( one example https://blockstream.info/block/0000000000000af7c56d09abdbce2a36ba9aebbd8559b3d0460defaeaf3c0f31 )",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-23T02:38:37Z",
      "diff_hunk" : "@@ -0,0 +1,368 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+    CAmount total_unspendable_amount;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+        READWRITE(obj.total_unspendable_amount);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+        m_total_unspendable_amount = 0;\n+        m_block_unspendable_amount = 0;\n+        m_block_prevout_spent_amount = 0;\n+        m_block_new_outputs_ex_coinbase_amount = 0;\n+        m_block_coinbase_amount = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    CAmount block_subsidy = GetBlockSubsidy(pindex->nHeight, Params().GetConsensus());\n+\n+    // Reset per-block values\n+    m_block_unspendable_amount = 0;\n+    m_block_coinbase_amount = 0;\n+    m_block_prevout_spent_amount = 0;\n+    m_block_new_outputs_ex_coinbase_amount = 0;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_block_unspendable_amount += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                if (tx->IsCoinBase() && j == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r475161291",
      "id" : 475161291,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MTI5MQ==",
      "original_commit_id" : "79535960d1324cd24db78e383e21d2f3b810f66a",
      "original_line" : 173,
      "original_position" : 173,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 472974571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475161291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r475205283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475205283"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You are right. I just pushed a fix for this and also improved the tests to account for this case.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-23T11:03:22Z",
      "diff_hunk" : "@@ -0,0 +1,368 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+    CAmount total_unspendable_amount;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+        READWRITE(obj.total_unspendable_amount);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+        m_total_unspendable_amount = 0;\n+        m_block_unspendable_amount = 0;\n+        m_block_prevout_spent_amount = 0;\n+        m_block_new_outputs_ex_coinbase_amount = 0;\n+        m_block_coinbase_amount = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    CAmount block_subsidy = GetBlockSubsidy(pindex->nHeight, Params().GetConsensus());\n+\n+    // Reset per-block values\n+    m_block_unspendable_amount = 0;\n+    m_block_coinbase_amount = 0;\n+    m_block_prevout_spent_amount = 0;\n+    m_block_new_outputs_ex_coinbase_amount = 0;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_block_unspendable_amount += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                if (tx->IsCoinBase() && j == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r475205283",
      "id" : 475205283,
      "in_reply_to_id" : 475161291,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIwNTI4Mw==",
      "original_commit_id" : "79535960d1324cd24db78e383e21d2f3b810f66a",
      "original_line" : 173,
      "original_position" : 173,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 473001690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475205283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@fjahr \r\n\r\nI'm late to the party, but:\r\n\r\n> I just noticed when I was almost done, that I wasn't sure if you would like these requested values to be cumulative or per-block.\r\n\r\nIt is trivial to convert cumulative to per-block by simply taking `value(block) - value(prevblock)`, but the other way requires iterating over all the blocks, so I think cumulative would be more useful.",
      "created_at" : "2020-08-26T01:39:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-680409442",
      "id" : 680409442,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MDQwOTQ0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-26T01:39:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/680409442",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-26T09:02:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-680754758",
      "id" : 680754758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MDc1NDc1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-26T09:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/680754758",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Would it be too verbose to split out unspendables by the 4 categories? I realize it is granular, but it would remove any ambiguity in the reconciliation.",
      "created_at" : "2020-08-27T02:14:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-681301264",
      "id" : 681301264,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MTMwMTI2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-27T02:14:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/681301264",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/6299681?v=4",
         "events_url" : "https://api.github.com/users/PierreRochard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PierreRochard/followers",
         "following_url" : "https://api.github.com/users/PierreRochard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PierreRochard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PierreRochard",
         "id" : 6299681,
         "login" : "PierreRochard",
         "node_id" : "MDQ6VXNlcjYyOTk2ODE=",
         "organizations_url" : "https://api.github.com/users/PierreRochard/orgs",
         "received_events_url" : "https://api.github.com/users/PierreRochard/received_events",
         "repos_url" : "https://api.github.com/users/PierreRochard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PierreRochard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PierreRochard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PierreRochard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Would it be too verbose to split out unspendables by the 4 categories? I realize it is granular, but it would remove any ambiguity in the reconciliation.\r\n\r\nI think more verbose is not a problem itself unless it creates other problems, the only serious argument against it IMO would be if it ends up taking up too much disk space but the index is still pretty small and unless I change it to be accumulative numbers it should mostly be zeros anyway which should let the index only grow very little. I am just still thinking about if would really make sense to record all four categories because it is technically not possible that there will ever be another Genesis block or another BIP30 block, so recording these two values (even if it's just 0s) for every block forever seems kind of pointless in a way. But then if I leave them out it's annoying that it can't be a clean sum of all the categories to get the total unspendable. So, happy to do it but still struggling a bit with finding the right approach.",
      "created_at" : "2020-08-28T16:53:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-682886060",
      "id" : 682886060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4Mjg4NjA2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-28T16:53:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/682886060",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @fjahr\r\n> \r\n> I'm late to the party, but:\r\n> \r\n> > I just noticed when I was almost done, that I wasn't sure if you would like these requested values to be cumulative or per-block.\r\n> \r\n> It is trivial to convert cumulative to per-block by simply taking `value(block) - value(prevblock)`, but the other way requires iterating over all the blocks, so I think cumulative would be more useful.\r\n\r\nTwo concept ACKs, I think you are still early :) And that is a good point. I think I will do the following then: I will record cumulative numbers on the index but also return the per-block numbers in the rpc by default using the prevblock numbers. Since I have written that comment I have thought a bit more about the casual (non-auditor) user who might just want to check on a specific block height and for them the per-block numbers are much more intuitive and I would like to avoid another situation where the users see the very large cumulative numbers and ask questions about what it means, if it's a bug etc.",
      "created_at" : "2020-08-28T17:14:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-682948466",
      "id" : 682948466,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4Mjk0ODQ2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-28T17:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/682948466",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Only rebased for now, will work on the suggested changes shortly.",
      "created_at" : "2020-08-28T17:16:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-682952026",
      "id" : 682952026,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4Mjk1MjAyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-28T17:16:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/682952026",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r479786750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479786750"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9981a8f nit: sort",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-30T16:03:39Z",
      "diff_hunk" : "@@ -23,6 +23,7 @@\n #include <httpserver.h>\n #include <index/blockfilterindex.h>\n #include <index/txindex.h>\n+#include <index/coinstatsindex.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r479786750",
      "id" : 479786750,
      "line" : 24,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4Njc1MA==",
      "original_commit_id" : "fe86a280c3f49da89acd3cb93eb9189f6f6c2a9d",
      "original_line" : 24,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 4,
      "pull_request_review_id" : 478215123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479786750",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r479787149"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479787149"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9981a8f\r\n\r\n- s/rpc/RPC/ (can also fix the one in `txindex`)\r\n\r\n- omit \"call\" (the C in RPC stands for \"call\")\r\n\r\n- drop the comma at s/index, /index /\r\n\r\n- nit: sort for both `-coinstatsindex` and `-blockfilterindex` (they should be at line 411)",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-08-30T16:07:37Z",
      "diff_hunk" : "@@ -432,6 +440,7 @@ void SetupServerArgs(NodeContext& node)\n                  strprintf(\"Maintain an index of compact filters by block (default: %s, values: %s).\", DEFAULT_BLOCKFILTERINDEX, ListBlockFilterTypes()) +\n                  \" If <type> is not supplied or if <type> = 1, indexes for all known types are enabled.\",\n                  ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-coinstatsindex\", strprintf(\"Maintain coin statistics index, used by the gettxoutset rpc call (default: %u)\", DEFAULT_COINSTATSINDEX), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r479787149",
      "id" : 479787149,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4NzE0OQ==",
      "original_commit_id" : "fe86a280c3f49da89acd3cb93eb9189f6f6c2a9d",
      "original_line" : 443,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 478215123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479787149",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> OTOH on a mainnet node, which has been running `txindex=1 peerbloomfilters=1 blockfilterindex=1` without issues, this PR crashed repeatedly:\r\n> \r\n> ```\r\n> 2020-08-30T16:32:25Z coinstatsindex thread start\r\n> 2020-08-30T16:32:25Z Syncing coinstatsindex with block chain from height 632589\r\n> 2020-08-30T16:32:26Z *** ThreadSync: Failed to write block 000000000000000000017ff124286aa9a7c80a353c11bd7bd81e8a4b467c2e34 to index database\r\n> 2020-08-30T16:32:26Z Error: A fatal internal error occurred, see debug.log for details\r\n> Error: A fatal internal error occurred, see debug.log for details\r\n> 2020-08-30T16:32:26Z coinstatsindex thread exit\r\n> ...\r\n> 2020-08-30T16:32:26Z Shutdown: In progress...\r\n> ...\r\n> 2020-08-30T16:32:26Z Shutdown: done\r\n> ```\r\n\r\nThanks for taking another look @jonatack . Maybe you had an older version of `coinstatsindex` running on that node before? You need to delete the folder and fully resync in that case. I have not taken care of a migration mechanism yet. That could explain such crashes.",
      "created_at" : "2020-08-30T19:59:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-683463535",
      "id" : 683463535,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzQ2MzUzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-30T19:59:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683463535",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Thanks for taking another look @jonatack . Maybe you had an older version of `coinstatsindex` running on that node before? You need to delete the folder and fully resync in that case. I have not taken care of a migration mechanism yet. That could explain such crashes.\r\n\r\nThanks @fjahr, that could explain it; I tested building the index with #18000 and only on mainnet.",
      "created_at" : "2020-08-30T20:09:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-683464648",
      "id" : 683464648,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzQ2NDY0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-30T20:09:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683464648",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yup, all good now.\r\n```\r\nrm -rf ~/.bitcoin/indexes/coinstats\r\n```\r\n```\r\n2020-08-30T20:17:32Z coinstatsindex thread start\r\n2020-08-30T20:17:32Z Syncing coinstatsindex with block chain from height 0\r\n...\r\n2020-08-30T20:21:09Z Syncing coinstatsindex with block chain from height 150291\r\n2020-08-30T20:21:40Z Syncing coinstatsindex with block chain from height 172129\r\n2020-08-30T20:22:11Z Syncing coinstatsindex with block chain from height 183549\r\n2020-08-30T20:22:42Z Syncing coinstatsindex with block chain from height 190364\r\n```\r\n```\r\n$ ./src/bitcoin-cli getindexinfo\r\n{\r\n  \"txindex\": {\r\n    \"synced\": true,\r\n    \"best_block_height\": 646031\r\n  },\r\n  \"coinstatsindex\": {\r\n    \"synced\": false,\r\n    \"best_block_height\": 203567\r\n  },\r\n  \"basic block filter index\": {\r\n    \"synced\": true,\r\n    \"best_block_height\": 646031\r\n  }\r\n}\r\n```",
      "created_at" : "2020-08-30T20:23:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-683466314",
      "id" : 683466314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzQ2NjMxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-30T20:24:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683466314",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485635996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485635996"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `look up stats`",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-09T14:01:33Z",
      "diff_hunk" : "@@ -0,0 +1,50 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_COINSTATSINDEX_H\n+#define BITCOIN_INDEX_COINSTATSINDEX_H\n+\n+#include <chain.h>\n+#include <flatfile.h>\n+#include <index/base.h>\n+#include <node/coinstats.h>\n+\n+/**\n+ * CoinStatsIndex maintains statistics on the UTXO set.\n+ */\n+class CoinStatsIndex final : public BaseIndex\n+{\n+private:\n+    std::string m_name;\n+    std::unique_ptr<BaseIndex::DB> m_db;\n+\n+    uint64_t m_transaction_output_count;\n+    uint64_t m_bogo_size;\n+    CAmount m_total_amount;\n+    uint64_t m_disk_size;\n+\n+    bool ReverseBlock(const CBlock& block, const CBlockIndex* pindex);\n+protected:\n+    bool Init() override;\n+\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex) override;\n+\n+    bool Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip) override;\n+\n+    BaseIndex::DB& GetDB() const override { return *m_db; }\n+\n+    const char* GetName() const override { return \"coinstatsindex\"; }\n+\n+public:\n+    // Constructs the index, which becomes available to be queried.\n+    explicit CoinStatsIndex(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Look up hash digest for a specific block using CBlockIndex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485635996",
      "id" : 485635996,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYzNTk5Ng==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.h",
      "position" : null,
      "pull_request_review_id" : 485041059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485635996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485646852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485646852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This would prematurely return if the active chain is shorter? It currently doesn't matter, because `gettxoutsetinfo` only takes a height argument.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-09T14:15:32Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    }\n+\n+    CCoinsView* coins_view = WITH_LOCK(cs_main, return &ChainstateActive().CoinsDB());\n+    m_disk_size = coins_view->EstimateSize();\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.disk_size = m_disk_size;\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+\n+    if (!m_db->Write(DBHeightKey(pindex->nHeight), value)) {\n+        return false;\n+    }\n+\n+    return true;\n+}\n+\n+static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n+                                       const std::string& index_name,\n+                                       int start_height, int stop_height)\n+{\n+    DBHeightKey key(start_height);\n+    db_it.Seek(key);\n+\n+    for (int height = start_height; height <= stop_height; ++height) {\n+        if (!db_it.GetKey(key) || key.height != height) {\n+            return error(\"%s: unexpected key in %s: expected (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        std::pair<uint256, DBVal> value;\n+        if (!db_it.GetValue(value)) {\n+            return error(\"%s: unable to read value in %s at key (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        batch.Write(DBHashKey(value.first), std::move(value.second));\n+\n+        db_it.Next();\n+    }\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip)\n+{\n+    assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n+\n+    CDBBatch batch(*m_db);\n+    std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n+\n+    {\n+        LOCK(cs_main);\n+        CBlockIndex* iter_tip = LookupBlockIndex(current_tip->GetBlockHash());\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        do {\n+            CBlock block;\n+\n+            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                               __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+\n+            ReverseBlock(block, iter_tip);\n+\n+            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n+        } while (new_tip != iter_tip);\n+    }\n+\n+    // During a reorg, we need to copy all hash digests for blocks that are getting disconnected from the\n+    // height index to the hash index so we can still find them when the height index entries are\n+    // overwritten.\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip->nHeight, current_tip->nHeight)) {\n+        return false;\n+    }\n+\n+    if (!m_db->WriteBatch(batch)) return false;\n+\n+    return BaseIndex::Rewind(current_tip, new_tip);\n+}\n+\n+static bool LookupOne(const CDBWrapper& db, const CBlockIndex* block_index, DBVal& result)\n+{\n+    // First check if the result is stored under the height index and the value there matches the\n+    // block hash. This should be the case if the block is on the active chain.\n+    std::pair<uint256, DBVal> read_out;\n+    if (!db.Read(DBHeightKey(block_index->nHeight), read_out)) {\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485646852",
      "id" : 485646852,
      "line" : 296,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0Njg1Mg==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 296,
      "original_position" : 254,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 296,
      "pull_request_review_id" : 485041059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485646852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485661976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485661976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why are these values only initialised is no result is found? (and `result` is not used, so this just a sanity check?). Should this be initialised with the most recent block?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-09T14:34:55Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485661976",
      "id" : 485661976,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY2MTk3Ng==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 98,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 485041059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485661976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485665973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485665973"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why doesn't this fail for `pindex->nHeight == 1` given that we don't index block 0?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-09T14:40:04Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485665973",
      "id" : 485665973,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY2NTk3Mw==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 119,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 119,
      "pull_request_review_id" : 485041059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485665973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485669614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485669614"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(Why) are we using the tip disk size here? The index now contains the disk size at the time the index was made.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-09T14:44:49Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    }\n+\n+    CCoinsView* coins_view = WITH_LOCK(cs_main, return &ChainstateActive().CoinsDB());\n+    m_disk_size = coins_view->EstimateSize();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r485669614",
      "id" : 485669614,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY2OTYxNA==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 168,
      "original_position" : 168,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 485041059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485669614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488283833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488283833"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-14T22:58:34Z",
      "diff_hunk" : "@@ -23,6 +23,7 @@\n #include <httpserver.h>\n #include <index/blockfilterindex.h>\n #include <index/txindex.h>\n+#include <index/coinstatsindex.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488283833",
      "id" : 488283833,
      "in_reply_to_id" : 479786750,
      "line" : 24,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4MzgzMw==",
      "original_commit_id" : "fe86a280c3f49da89acd3cb93eb9189f6f6c2a9d",
      "original_line" : 24,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 4,
      "pull_request_review_id" : 488211432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488283833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488283873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488283873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-14T22:58:41Z",
      "diff_hunk" : "@@ -432,6 +440,7 @@ void SetupServerArgs(NodeContext& node)\n                  strprintf(\"Maintain an index of compact filters by block (default: %s, values: %s).\", DEFAULT_BLOCKFILTERINDEX, ListBlockFilterTypes()) +\n                  \" If <type> is not supplied or if <type> = 1, indexes for all known types are enabled.\",\n                  ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-coinstatsindex\", strprintf(\"Maintain coin statistics index, used by the gettxoutset rpc call (default: %u)\", DEFAULT_COINSTATSINDEX), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488283873",
      "id" : 488283873,
      "in_reply_to_id" : 479787149,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4Mzg3Mw==",
      "original_commit_id" : "fe86a280c3f49da89acd3cb93eb9189f6f6c2a9d",
      "original_line" : 443,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 488211486,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488283873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284233"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284233"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-14T22:59:43Z",
      "diff_hunk" : "@@ -0,0 +1,50 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_COINSTATSINDEX_H\n+#define BITCOIN_INDEX_COINSTATSINDEX_H\n+\n+#include <chain.h>\n+#include <flatfile.h>\n+#include <index/base.h>\n+#include <node/coinstats.h>\n+\n+/**\n+ * CoinStatsIndex maintains statistics on the UTXO set.\n+ */\n+class CoinStatsIndex final : public BaseIndex\n+{\n+private:\n+    std::string m_name;\n+    std::unique_ptr<BaseIndex::DB> m_db;\n+\n+    uint64_t m_transaction_output_count;\n+    uint64_t m_bogo_size;\n+    CAmount m_total_amount;\n+    uint64_t m_disk_size;\n+\n+    bool ReverseBlock(const CBlock& block, const CBlockIndex* pindex);\n+protected:\n+    bool Init() override;\n+\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex) override;\n+\n+    bool Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip) override;\n+\n+    BaseIndex::DB& GetDB() const override { return *m_db; }\n+\n+    const char* GetName() const override { return \"coinstatsindex\"; }\n+\n+public:\n+    // Constructs the index, which becomes available to be queried.\n+    explicit CoinStatsIndex(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Look up hash digest for a specific block using CBlockIndex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284233",
      "id" : 488284233,
      "in_reply_to_id" : 485635996,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NDIzMw==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.h",
      "position" : null,
      "pull_request_review_id" : 488211895,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284358"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure what you mean here. Like, in case of a reorg?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-14T23:00:00Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    }\n+\n+    CCoinsView* coins_view = WITH_LOCK(cs_main, return &ChainstateActive().CoinsDB());\n+    m_disk_size = coins_view->EstimateSize();\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.disk_size = m_disk_size;\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+\n+    if (!m_db->Write(DBHeightKey(pindex->nHeight), value)) {\n+        return false;\n+    }\n+\n+    return true;\n+}\n+\n+static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n+                                       const std::string& index_name,\n+                                       int start_height, int stop_height)\n+{\n+    DBHeightKey key(start_height);\n+    db_it.Seek(key);\n+\n+    for (int height = start_height; height <= stop_height; ++height) {\n+        if (!db_it.GetKey(key) || key.height != height) {\n+            return error(\"%s: unexpected key in %s: expected (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        std::pair<uint256, DBVal> value;\n+        if (!db_it.GetValue(value)) {\n+            return error(\"%s: unable to read value in %s at key (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        batch.Write(DBHashKey(value.first), std::move(value.second));\n+\n+        db_it.Next();\n+    }\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip)\n+{\n+    assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n+\n+    CDBBatch batch(*m_db);\n+    std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n+\n+    {\n+        LOCK(cs_main);\n+        CBlockIndex* iter_tip = LookupBlockIndex(current_tip->GetBlockHash());\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        do {\n+            CBlock block;\n+\n+            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                               __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+\n+            ReverseBlock(block, iter_tip);\n+\n+            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n+        } while (new_tip != iter_tip);\n+    }\n+\n+    // During a reorg, we need to copy all hash digests for blocks that are getting disconnected from the\n+    // height index to the hash index so we can still find them when the height index entries are\n+    // overwritten.\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip->nHeight, current_tip->nHeight)) {\n+        return false;\n+    }\n+\n+    if (!m_db->WriteBatch(batch)) return false;\n+\n+    return BaseIndex::Rewind(current_tip, new_tip);\n+}\n+\n+static bool LookupOne(const CDBWrapper& db, const CBlockIndex* block_index, DBVal& result)\n+{\n+    // First check if the result is stored under the height index and the value there matches the\n+    // block hash. This should be the case if the block is on the active chain.\n+    std::pair<uint256, DBVal> read_out;\n+    if (!db.Read(DBHeightKey(block_index->nHeight), read_out)) {\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284358",
      "id" : 488284358,
      "in_reply_to_id" : 485646852,
      "line" : 296,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NDM1OA==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 296,
      "original_position" : 254,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 296,
      "pull_request_review_id" : 488211987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284393"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, this was just to initialize the values when the index is initialized itself. But initializing the values in the object is sufficient so I removed this.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-14T23:00:06Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284393",
      "id" : 488284393,
      "in_reply_to_id" : 485661976,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NDM5Mw==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 98,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 488212027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284437"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, we do index block 0, we just don't process the block data in the usual way but there is still an entry for it.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-14T23:00:13Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284437",
      "id" : 488284437,
      "in_reply_to_id" : 485665973,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NDQzNw==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 119,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 119,
      "pull_request_review_id" : 488212078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284467"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You are right, that doesn't make sense. I guess there is no reasonable way to get that number for every height so I removed it from the index.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-14T23:00:18Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    }\n+\n+    CCoinsView* coins_view = WITH_LOCK(cs_main, return &ChainstateActive().CoinsDB());\n+    m_disk_size = coins_view->EstimateSize();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r488284467",
      "id" : 488284467,
      "in_reply_to_id" : 485669614,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NDQ2Nw==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 168,
      "original_position" : 168,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 488212119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488284467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for all the feedback, reviewers! I pushed a big update which should address all of the feedback from the past couple of weeks. If I missed something, please let me know:\r\n- Now saving cumulative values in the index. The PRC still returns the per-block values by subtracting the values from the prev block.\r\n- Unspendables are tracked in the four separate categories.\r\n- Addressed feedback by @jonatack \r\n- Addressed feedback by @Sjors . Most importantly removed `disk_size` from the index and only returning it if the index is not used. This also led me to revert the change removing `transactions` because I could deal with it the exact same way and that meant keeping it in place now felt like the more sensible move.",
      "created_at" : "2020-09-14T23:03:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-692363789",
      "id" : 692363789,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MjM2Mzc4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-14T23:05:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/692363789",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r492091745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492091745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A rather large reorg (with difficulty adjustments),  where the new chain is shorter, but has more proof of work.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-09-21T14:27:11Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    }\n+\n+    CCoinsView* coins_view = WITH_LOCK(cs_main, return &ChainstateActive().CoinsDB());\n+    m_disk_size = coins_view->EstimateSize();\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.disk_size = m_disk_size;\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+\n+    if (!m_db->Write(DBHeightKey(pindex->nHeight), value)) {\n+        return false;\n+    }\n+\n+    return true;\n+}\n+\n+static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n+                                       const std::string& index_name,\n+                                       int start_height, int stop_height)\n+{\n+    DBHeightKey key(start_height);\n+    db_it.Seek(key);\n+\n+    for (int height = start_height; height <= stop_height; ++height) {\n+        if (!db_it.GetKey(key) || key.height != height) {\n+            return error(\"%s: unexpected key in %s: expected (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        std::pair<uint256, DBVal> value;\n+        if (!db_it.GetValue(value)) {\n+            return error(\"%s: unable to read value in %s at key (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        batch.Write(DBHashKey(value.first), std::move(value.second));\n+\n+        db_it.Next();\n+    }\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip)\n+{\n+    assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n+\n+    CDBBatch batch(*m_db);\n+    std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n+\n+    {\n+        LOCK(cs_main);\n+        CBlockIndex* iter_tip = LookupBlockIndex(current_tip->GetBlockHash());\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        do {\n+            CBlock block;\n+\n+            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                               __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+\n+            ReverseBlock(block, iter_tip);\n+\n+            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n+        } while (new_tip != iter_tip);\n+    }\n+\n+    // During a reorg, we need to copy all hash digests for blocks that are getting disconnected from the\n+    // height index to the hash index so we can still find them when the height index entries are\n+    // overwritten.\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip->nHeight, current_tip->nHeight)) {\n+        return false;\n+    }\n+\n+    if (!m_db->WriteBatch(batch)) return false;\n+\n+    return BaseIndex::Rewind(current_tip, new_tip);\n+}\n+\n+static bool LookupOne(const CDBWrapper& db, const CBlockIndex* block_index, DBVal& result)\n+{\n+    // First check if the result is stored under the height index and the value there matches the\n+    // block hash. This should be the case if the block is on the active chain.\n+    std::pair<uint256, DBVal> read_out;\n+    if (!db.Read(DBHeightKey(block_index->nHeight), read_out)) {\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r492091745",
      "id" : 492091745,
      "in_reply_to_id" : 485646852,
      "line" : 296,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA5MTc0NQ==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 296,
      "original_position" : 254,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 296,
      "pull_request_review_id" : 492660697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492091745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r500651118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500651118"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could move `CCoinsStats` and related to src/coinstats.h to avoid this.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-10-06T23:26:51Z",
      "diff_hunk" : "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/coinstatsindex -> node/coinstats -> index/coinstatsindex\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r500651118",
      "id" : 500651118,
      "line" : 17,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY1MTExOA==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 17,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 503427107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500651118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502323841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502323841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe add: `The genesis coinbase transaction is excluded from the UTXO set`, so users understand the result of `gettxoutsetinfo none 0` (`total_amount`: 0, `total_unspendable_amount`: 50, `unspendable_amount`: 50)",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-10-09T10:04:08Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n-                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502323841",
      "id" : 502323841,
      "line" : 1116,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyMzg0MQ==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1116,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 67,
      "pull_request_review_id" : 505535088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502323841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502325077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502325077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Suggest dropping `total_` here and below, so it's clear this is per block.\r\n\r\nAlternatively, rename `total_unspendable_amount` to `cumulative_unspendable_amount`\r\n\r\nI also don't think the word \"amount\" is needed in the variable name. We already indicate count by using plural form, e.g. `txouts`. Finally I suggest putting `total` at the end, so variables with similar stuff are easier to spot, so:\r\n\r\n```\r\ntotal\r\ntotal_unspendable\r\nblock_info\r\n   prevout_spent\r\n   coinbase\r\n   new_outputs_ex_coinbase\r\n   unspendable\r\n   unspendables\r\n      genesis_block\r\n      ...\r\n```",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-10-09T10:06:33Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n-                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_unspendable_amount\", \"The total amount of coins excluded from the UTXO set (only available if coinstatsindex is used)\"},\n+                        {RPCResult::Type::OBJ, \"block_info\", \"Info on amounts in the block at this block height (only available if coinstatsindex is used)\",\n+                        {\n+                            {RPCResult::Type::STR_AMOUNT, \"unspendable_amount\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"total_prevout_spent_amount\", \"\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502325077",
      "id" : 502325077,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyNTA3Nw==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1027,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 505535088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502325077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502335126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502335126"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For other reviewers, see #15448 and #19949 for solutions to avoid having to pass a hash with `'\"1abc...'\"` ",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-10-09T10:26:57Z",
      "diff_hunk" : "@@ -123,6 +123,7 @@ static const CRPCConvertParam vRPCConvertParams[] =\n     { \"gettxout\", 1, \"n\" },\n     { \"gettxout\", 2, \"include_mempool\" },\n     { \"gettxoutproof\", 0, \"txids\" },\n+    { \"gettxoutsetinfo\", 1, \"hash_or_height\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502335126",
      "id" : 502335126,
      "line" : 130,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzNTEyNg==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 130,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/client.cpp",
      "position" : 4,
      "pull_request_review_id" : 505535088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502335126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502340746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502340746"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"permanently excluded\" makes it more clear this number does not include coinbase transactions.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-10-09T10:39:19Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n-                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_unspendable_amount\", \"The total amount of coins excluded from the UTXO set (only available if coinstatsindex is used)\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502340746",
      "id" : 502340746,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM0MDc0Ng==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1023,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 505535088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502340746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502342030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502342030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "* `The current block height` -> `The (current) block height`\r\n* `bestblock` -> should probably be dropped if a `hash` argument is used, otherwise it's confusing",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-10-09T10:41:50Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502342030",
      "id" : 502342030,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM0MjAzMA==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1083,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 505535088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502342030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502343829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502343829"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's not _due_ to BIP30 that these coins are lost. BIP30 prevents it from ever happening again, so doc could e.g. say: \"Transactions overridden by duplicates (no longer possible with BIP30)\"",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-10-09T10:45:30Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n-                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_unspendable_amount\", \"The total amount of coins excluded from the UTXO set (only available if coinstatsindex is used)\"},\n+                        {RPCResult::Type::OBJ, \"block_info\", \"Info on amounts in the block at this block height (only available if coinstatsindex is used)\",\n+                        {\n+                            {RPCResult::Type::STR_AMOUNT, \"unspendable_amount\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"total_prevout_spent_amount\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"total_new_outputs_ex_coinbase_amount\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"coinbase_amount\", \"\"},\n+                            {RPCResult::Type::OBJ, \"unspendables\", \"Detailed view of the unspendable categories\",\n+                            {\n+                                {RPCResult::Type::STR_AMOUNT, \"genesis_block\", \"\"},\n+                                {RPCResult::Type::STR_AMOUNT, \"bip30\", \"\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r502343829",
      "id" : 502343829,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM0MzgyOQ==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1033,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 505535088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502343829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-15T11:09:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-709204210",
      "id" : 709204210,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwOTIwNDIxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-15T11:09:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/709204210",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700006"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-11-25T23:59:43Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n-                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700006",
      "id" : 530700006,
      "in_reply_to_id" : 502323841,
      "line" : 1116,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwMDAwNg==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1116,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 67,
      "pull_request_review_id" : 538911968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700074"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I dropped the totals and amounts in block_info, I think that made sense. I think we should keep `total_amount` as is to keep compatibility and I left `total_unspendable_amount` as is so it's close to its pair on that level if that makes sense. I am not sure I understand the comment about putting total at the end. That was only in case I really want to keep the total somehow?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-11-25T23:59:55Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n-                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_unspendable_amount\", \"The total amount of coins excluded from the UTXO set (only available if coinstatsindex is used)\"},\n+                        {RPCResult::Type::OBJ, \"block_info\", \"Info on amounts in the block at this block height (only available if coinstatsindex is used)\",\n+                        {\n+                            {RPCResult::Type::STR_AMOUNT, \"unspendable_amount\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"total_prevout_spent_amount\", \"\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700074",
      "id" : 530700074,
      "in_reply_to_id" : 502325077,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwMDA3NA==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1027,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 538912013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700175"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700175"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-11-26T00:00:13Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n-                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_unspendable_amount\", \"The total amount of coins excluded from the UTXO set (only available if coinstatsindex is used)\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700175",
      "id" : 530700175,
      "in_reply_to_id" : 502340746,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwMDE3NQ==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1023,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 538912105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700778"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the `bestblock` help text was confusing as it was outdated so I changed it. Otherwise, I think it's ok to repeat the hash that was passed to keep consistency. Made the other change.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-11-26T00:02:39Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700778",
      "id" : 530700778,
      "in_reply_to_id" : 502342030,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwMDc3OA==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1083,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 538912773,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700822"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-11-26T00:02:53Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n-                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_unspendable_amount\", \"The total amount of coins excluded from the UTXO set (only available if coinstatsindex is used)\"},\n+                        {RPCResult::Type::OBJ, \"block_info\", \"Info on amounts in the block at this block height (only available if coinstatsindex is used)\",\n+                        {\n+                            {RPCResult::Type::STR_AMOUNT, \"unspendable_amount\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"total_prevout_spent_amount\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"total_new_outputs_ex_coinbase_amount\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"coinbase_amount\", \"\"},\n+                            {RPCResult::Type::OBJ, \"unspendables\", \"Detailed view of the unspendable categories\",\n+                            {\n+                                {RPCResult::Type::STR_AMOUNT, \"genesis_block\", \"\"},\n+                                {RPCResult::Type::STR_AMOUNT, \"bip30\", \"\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r530700822",
      "id" : 530700822,
      "in_reply_to_id" : 502343829,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwMDgyMg==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1033,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 538912842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/530700822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@Sjors Thanks for the review and sorry for the long wait. I improved the error message as well, as you suggested. But I am a bit hesitant about flipping the arguments because the `hash_type` is relevant to both users running the index and those that don't run the index and `hash_or_height` is only for those that run the index. But maybe there is an elegant solution to that that I am not seeing :)",
      "created_at" : "2020-11-26T00:13:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-734002395",
      "id" : 734002395,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNDAwMjM5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-26T00:13:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734002395",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r537047921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537047921"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry for the late reply, I am not sure if I can follow this: you mean src/node/coinstats.h (file was moved not too long ago I think), right? But the struct `CCoinsStats` is already in there.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-12-06T14:17:32Z",
      "diff_hunk" : "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/coinstatsindex -> node/coinstats -> index/coinstatsindex\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r537047921",
      "id" : 537047921,
      "in_reply_to_id" : 500651118,
      "line" : 17,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA0NzkyMQ==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 17,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 545710064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537047921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539306604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539306604"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure what I meant either :-) It's fine now.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-12-09T13:30:13Z",
      "diff_hunk" : "@@ -974,48 +1004,109 @@ static UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n             RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The current block height (index)\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at the tip of the chain\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n-                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_unspendable_amount\", \"The total amount of coins excluded from the UTXO set (only available if coinstatsindex is used)\"},\n+                        {RPCResult::Type::OBJ, \"block_info\", \"Info on amounts in the block at this block height (only available if coinstatsindex is used)\",\n+                        {\n+                            {RPCResult::Type::STR_AMOUNT, \"unspendable_amount\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"total_prevout_spent_amount\", \"\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539306604",
      "id" : 539306604,
      "in_reply_to_id" : 502325077,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwNjYwNA==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 1027,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 548182382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539306604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539325672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539325672"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2f6f9a7ad11209744fb0fbf797a1a87d9127dd5e: I'm puzzled why we never hit this, maybe because I've only testsed on a node that saw very few reorgs.\r\n\r\nIf you have two blocks at height N, and you're processing a block at N+1, you might not always get the right block at height N if you use `DBHeightKey`. IIUC this could be solved with an else branch that tries `DBHashKey`.\r\n\r\nMight be good to have to test for that.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-12-09T13:56:13Z",
      "diff_hunk" : "@@ -0,0 +1,296 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539325672",
      "id" : 539325672,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyNTY3Mg==",
      "original_commit_id" : "2f6f9a7ad11209744fb0fbf797a1a87d9127dd5e",
      "original_line" : 124,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 548205526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539325672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539348593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539348593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As a potential user, it would be nice if I can at least turn on pruning _after_ the index is generated, but I think that's for a separate PR.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-12-09T14:25:04Z",
      "diff_hunk" : "@@ -1003,10 +1012,12 @@ bool AppInitParameterInteraction()\n         return InitError(_(\"Cannot set -peerblockfilters without -blockfilterindex.\"));\n     }\n \n-    // if using block pruning, then disallow txindex\n+    // if using block pruning, then disallow txindex, coinstatsindex and blockfilterindex\n     if (gArgs.GetArg(\"-prune\", 0)) {\n         if (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX))\n             return InitError(_(\"Prune mode is incompatible with -txindex.\"));\n+        if (gArgs.GetBoolArg(\"-coinstatsindex\", DEFAULT_COINSTATSINDEX))\n+            return InitError(_(\"Prune mode is incompatible with -coinstatsindex.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539348593",
      "id" : 539348593,
      "in_reply_to_id" : 463328440,
      "line" : 964,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0ODU5Mw==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 964,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 56,
      "pull_request_review_id" : 548205526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539348593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539350809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539350809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "5479000c79b254120b7535bf322869439ee33215  nit: `coin_stats_cache_size`",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-12-09T14:27:46Z",
      "diff_hunk" : "@@ -1552,6 +1563,7 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n         filter_index_cache = max_cache / n_indexes;\n         nTotalCache -= filter_index_cache * n_indexes;\n     }\n+    int64_t coin_stats_cache = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539350809",
      "id" : 539350809,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM1MDgwOQ==",
      "original_commit_id" : "5479000c79b254120b7535bf322869439ee33215",
      "original_line" : 1566,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 548205526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539350809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539353330"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539353330"
         }
      },
      "author_association" : "MEMBER",
      "body" : "5479000c79b254120b7535bf322869439ee33215: consider splitting the usage of the index away from enabling the index",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-12-09T14:30:52Z",
      "diff_hunk" : "@@ -60,11 +73,23 @@ static bool GetUTXOStats(CCoinsView* view, CCoinsStats& stats, T hash_obj, const\n     stats = CCoinsStats();\n     std::unique_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n     assert(pcursor);\n-\n     stats.hashBlock = pcursor->GetBestBlock();\n+\n+    const CBlockIndex* block_index;\n     {\n         LOCK(cs_main);\n-        stats.nHeight = LookupBlockIndex(stats.hashBlock)->nHeight;\n+        block_index = LookupBlockIndex(pcursor->GetBestBlock());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539353330",
      "id" : 539353330,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM1MzMzMA==",
      "original_commit_id" : "5479000c79b254120b7535bf322869439ee33215",
      "original_line" : 81,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/node/coinstats.cpp",
      "position" : null,
      "pull_request_review_id" : 548205526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539353330",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539358106"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539358106"
         }
      },
      "author_association" : "MEMBER",
      "body" : "5479000: this seems overly abstract, maybe just check the hash type in `GetUTXOStats`? Unless it makes more sense once MuHash is added.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-12-09T14:36:36Z",
      "diff_hunk" : "@@ -25,6 +26,18 @@ uint64_t GetBogoSize(const CScript& scriptPubKey)\n            scriptPubKey.size() /* scriptPubKey */;\n }\n \n+static bool CanUseIndex(CHashWriter& ss)\n+{\n+    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539358106",
      "id" : 539358106,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM1ODEwNg==",
      "original_commit_id" : "5479000c79b254120b7535bf322869439ee33215",
      "original_line" : 31,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/node/coinstats.cpp",
      "position" : null,
      "pull_request_review_id" : 548205526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539358106",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539363670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539363670"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fc621a8fbdb5ecad1866e754ad38c24bfedfe5c1  This can in theory also happen for other (future) reasons than `OP_RETURN`:\r\n```cpp\r\n    /**\r\n     * Returns whether the script is guaranteed to fail at execution,\r\n     * regardless of the initial stack. This allows outputs to be pruned\r\n     * instantly when entering the UTXO set.\r\n     */\r\n    bool IsUnspendable() const\r\n    {\r\n        return (size() > 0 && *begin() == OP_RETURN) || (size() > MAX_SCRIPT_SIZE);\r\n    }\r\n```",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2020-12-09T14:43:23Z",
      "diff_hunk" : "@@ -135,7 +157,17 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n                 Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n \n                 // Skip unspendable coins\n-                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+                if (coin.out.scriptPubKey.IsUnspendable()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r539363670",
      "id" : 539363670,
      "line" : 152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM2MzY3MA==",
      "original_commit_id" : "fc621a8fbdb5ecad1866e754ad38c24bfedfe5c1",
      "original_line" : 152,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 152,
      "pull_request_review_id" : 548205526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539363670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Would love to see some progress here...",
      "created_at" : "2021-01-23T14:14:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-766085820",
      "id" : 766085820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NjA4NTgyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-23T14:14:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/766085820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Would love to see some progress here...\r\n\r\nYes, thanks for the nudge. However, since #19055 is merged now and reviewing power seems to be particularly scarce at the moment, I think it makes more sense to focus on getting #19145 in (which is comparatively small and easy-ish to review) and then reopen this here as a follow-up with the UTXO set hash included again also taking in your feedback @Sjors . I think this will be more intuitive for reviewers than keeping this and then adding the hash as a follow-up, the current approach made sense because it was unclear how long #19055 would take. I am working on getting that ready and will put this PR here in draft mode until it's ready, to avoid confusion.",
      "created_at" : "2021-01-25T22:20:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-767151349",
      "id" : 767151349,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzE1MTM0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-25T22:20:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767151349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r566324962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566324962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can remove this diff, and then rebase",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-01-28T18:42:29Z",
      "diff_hunk" : "@@ -2482,7 +2553,7 @@ static const CRPCCommand commands[] =\n     { \"blockchain\",         \"getmempoolinfo\",         &getmempoolinfo,         {} },\n     { \"blockchain\",         \"getrawmempool\",          &getrawmempool,          {\"verbose\", \"mempool_sequence\"} },\n     { \"blockchain\",         \"gettxout\",               &gettxout,               {\"txid\",\"n\",\"include_mempool\"} },\n-    { \"blockchain\",         \"gettxoutsetinfo\",        &gettxoutsetinfo,        {\"hash_type\"} },\n+    { \"blockchain\",         \"gettxoutsetinfo\",        &gettxoutsetinfo,        {\"hash_type\", \"hash_or_height\"} },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r566324962",
      "id" : 566324962,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjMyNDk2Mg==",
      "original_commit_id" : "355b91d454195e10289e34bdde755442d43bc30e",
      "original_line" : 2556,
      "original_position" : 208,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 578634653,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566324962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "#19055 is merged, rebase time? ",
      "created_at" : "2021-02-19T13:03:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-782060948",
      "id" : 782060948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MjA2MDk0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-19T13:03:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/782060948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> #19055 is merged, rebase time?\r\n\r\nDone, and I have made several changes based on feedback. But there are still a few comments I haven't addressed yet or still need to test.",
      "created_at" : "2021-02-22T00:53:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-782971620",
      "id" : 782971620,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4Mjk3MTYyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T00:53:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/782971620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r579896859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579896859"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-02-22T00:54:39Z",
      "diff_hunk" : "@@ -25,6 +26,18 @@ uint64_t GetBogoSize(const CScript& scriptPubKey)\n            scriptPubKey.size() /* scriptPubKey */;\n }\n \n+static bool CanUseIndex(CHashWriter& ss)\n+{\n+    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r579896859",
      "id" : 579896859,
      "in_reply_to_id" : 539358106,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTg5Njg1OQ==",
      "original_commit_id" : "5479000c79b254120b7535bf322869439ee33215",
      "original_line" : 31,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/node/coinstats.cpp",
      "position" : null,
      "pull_request_review_id" : 594906161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579896859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r579896895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579896895"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-02-22T00:54:57Z",
      "diff_hunk" : "@@ -1552,6 +1563,7 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n         filter_index_cache = max_cache / n_indexes;\n         nTotalCache -= filter_index_cache * n_indexes;\n     }\n+    int64_t coin_stats_cache = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r579896895",
      "id" : 579896895,
      "in_reply_to_id" : 539350809,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTg5Njg5NQ==",
      "original_commit_id" : "5479000c79b254120b7535bf322869439ee33215",
      "original_line" : 1566,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 594906201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579896895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r579897540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579897540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yepp, to be honest I just didn't come up with a better name in the moment and didn't revisit it afterwards. Will give this some more thought of what a good name is. Maybe `unspendable_script`.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-02-22T00:58:18Z",
      "diff_hunk" : "@@ -135,7 +157,17 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n                 Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n \n                 // Skip unspendable coins\n-                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+                if (coin.out.scriptPubKey.IsUnspendable()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r579897540",
      "id" : 579897540,
      "in_reply_to_id" : 539363670,
      "line" : 152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTg5NzU0MA==",
      "original_commit_id" : "fc621a8fbdb5ecad1866e754ad38c24bfedfe5c1",
      "original_line" : 152,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 152,
      "pull_request_review_id" : 594906734,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579897540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r581029128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/581029128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "clang is unhappy: `unused member function 'DBHeightKey' [-Wunused-member-function]`",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-02-23T13:22:04Z",
      "diff_hunk" : "@@ -0,0 +1,421 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_op_return;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_op_return);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r581029128",
      "id" : 581029128,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTAyOTEyOA==",
      "original_commit_id" : "847e8ba7e6e17fc85bdb1e0a23fdd7daa4b481f5",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 596324632,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/581029128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584320216"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584320216"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fixed",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-02-28T16:14:57Z",
      "diff_hunk" : "@@ -0,0 +1,421 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_op_return;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_op_return);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584320216",
      "id" : 584320216,
      "in_reply_to_id" : 581029128,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDMyMDIxNg==",
      "original_commit_id" : "847e8ba7e6e17fc85bdb1e0a23fdd7daa4b481f5",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 600275639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584320216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584385307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584385307"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I added an option (`no_index`) for it in a new commit.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T00:04:00Z",
      "diff_hunk" : "@@ -60,11 +73,23 @@ static bool GetUTXOStats(CCoinsView* view, CCoinsStats& stats, T hash_obj, const\n     stats = CCoinsStats();\n     std::unique_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n     assert(pcursor);\n-\n     stats.hashBlock = pcursor->GetBestBlock();\n+\n+    const CBlockIndex* block_index;\n     {\n         LOCK(cs_main);\n-        stats.nHeight = LookupBlockIndex(stats.hashBlock)->nHeight;\n+        block_index = LookupBlockIndex(pcursor->GetBestBlock());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584385307",
      "id" : 584385307,
      "in_reply_to_id" : 539353330,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDM4NTMwNw==",
      "original_commit_id" : "5479000c79b254120b7535bf322869439ee33215",
      "original_line" : 81,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/node/coinstats.cpp",
      "position" : null,
      "pull_request_review_id" : 600324372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584385307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584385315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584385315"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Renamed",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T00:04:06Z",
      "diff_hunk" : "@@ -135,7 +157,17 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n                 Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n \n                 // Skip unspendable coins\n-                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+                if (coin.out.scriptPubKey.IsUnspendable()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584385315",
      "id" : 584385315,
      "in_reply_to_id" : 539363670,
      "line" : 152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDM4NTMxNQ==",
      "original_commit_id" : "fc621a8fbdb5ecad1866e754ad38c24bfedfe5c1",
      "original_line" : 152,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 152,
      "pull_request_review_id" : 600324385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584385315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for your comments @Sjors ! I think I have addressed all except for the reorg test but I am working on that one.",
      "created_at" : "2021-03-01T00:08:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-787552191",
      "id" : 787552191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NzU1MjE5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-01T00:08:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/787552191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584591432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584591432"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because the snapshot uses `CoinStatsHashType::HASH_SERIALIZED` it might be better to initialise `stats` with that option explicitly, in case we ever change the default.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T10:16:01Z",
      "diff_hunk" : "@@ -5437,7 +5437,7 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     // about the snapshot_chainstate.\n     CCoinsViewDB* snapshot_coinsdb = WITH_LOCK(::cs_main, return &snapshot_chainstate.CoinsDB());\n \n-    if (!GetUTXOStats(snapshot_coinsdb, stats, CoinStatsHashType::HASH_SERIALIZED, breakpoint_fnc)) {\n+    if (!GetUTXOStats(snapshot_coinsdb, stats, breakpoint_fnc)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584591432",
      "id" : 584591432,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDU5MTQzMg==",
      "original_commit_id" : "917e29a7767d08f5ba04c7f91a4d0d265017e75b",
      "original_line" : 5440,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 600575630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584591432",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584607991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584607991"
         }
      },
      "author_association" : "MEMBER",
      "body" : "TODO what?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T10:41:33Z",
      "diff_hunk" : "@@ -0,0 +1,379 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        // TODO",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584607991",
      "id" : 584607991,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYwNzk5MQ==",
      "original_commit_id" : "1fc3470c1b03857245b94eebde5cd0f18805a884",
      "original_line" : 108,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 600575630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584607991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584617745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584617745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Are you sure bogo_size shouldn't be counted for `OP_RETURN`? I guess not, because you're testing that the result is consistent with a non-indexed node: https://github.com/bitcoin/bitcoin/pull/19521/commits/9c07684e444a5c8e1f81d19221c6217dada3da72#diff-a6434325d09a6df4b371513c837907dfc1a97cf540709def4bded9b2a17e3f49R61 ",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T10:56:49Z",
      "diff_hunk" : "@@ -0,0 +1,379 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        // TODO\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+                COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584617745",
      "id" : 584617745,
      "line" : 168,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYxNzc0NQ==",
      "original_commit_id" : "1fc3470c1b03857245b94eebde5cd0f18805a884",
      "original_line" : 168,
      "original_position" : 133,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 168,
      "pull_request_review_id" : 600575630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584617745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584621490"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584621490"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1fc3470c1b03857245b94eebde5cd0f18805a884: I think these ended up in the wrong commit",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T11:02:29Z",
      "diff_hunk" : "@@ -0,0 +1,379 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        // TODO\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+                COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+                    COutPoint outpoint = COutPoint(tx->vin[j].prevout.hash, tx->vin[j].prevout.n);\n+\n+                    m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    }\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+\n+    uint256 out;\n+    m_muhash.Finalize(out);\n+    value.second.muhash = out;\n+\n+    if (!m_db->Write(DBHeightKey(pindex->nHeight), value)) {\n+        return false;\n+    }\n+\n+    if (!m_db->Write(DB_MUHASH, m_muhash)) {\n+        return false;\n+    }\n+\n+    return true;\n+}\n+\n+static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n+                                       const std::string& index_name,\n+                                       int start_height, int stop_height)\n+{\n+    DBHeightKey key(start_height);\n+    db_it.Seek(key);\n+\n+    for (int height = start_height; height <= stop_height; ++height) {\n+        if (!db_it.GetKey(key) || key.height != height) {\n+            return error(\"%s: unexpected key in %s: expected (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        std::pair<uint256, DBVal> value;\n+        if (!db_it.GetValue(value)) {\n+            return error(\"%s: unable to read value in %s at key (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        batch.Write(DBHashKey(value.first), std::move(value.second));\n+\n+        db_it.Next();\n+    }\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip)\n+{\n+    assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n+\n+    CDBBatch batch(*m_db);\n+    std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n+\n+    {\n+        LOCK(cs_main);\n+        CBlockIndex* iter_tip = g_chainman.m_blockman.LookupBlockIndex(current_tip->GetBlockHash());\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        do {\n+            CBlock block;\n+\n+            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                               __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+\n+            ReverseBlock(block, iter_tip);\n+\n+            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n+        } while (new_tip != iter_tip);\n+    }\n+\n+    // During a reorg, we need to copy all hash digests for blocks that are getting disconnected from the\n+    // height index to the hash index so we can still find them when the height index entries are\n+    // overwritten.\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip->nHeight, current_tip->nHeight)) {\n+        return false;\n+    }\n+\n+    if (!m_db->WriteBatch(batch)) return false;\n+\n+    return BaseIndex::Rewind(current_tip, new_tip);\n+}\n+\n+static bool LookupOne(const CDBWrapper& db, const CBlockIndex* block_index, DBVal& result)\n+{\n+    // First check if the result is stored under the height index and the value there matches the\n+    // block hash. This should be the case if the block is on the active chain.\n+    std::pair<uint256, DBVal> read_out;\n+    if (!db.Read(DBHeightKey(block_index->nHeight), read_out)) {\n+        return false;\n+    }\n+    if (read_out.first == block_index->GetBlockHash()) {\n+        result = std::move(read_out.second);\n+        return true;\n+    }\n+\n+    // If value at the height index corresponds to an different block, the result will be stored in\n+    // the hash index.\n+    return db.Read(DBHashKey(block_index->GetBlockHash()), result);\n+}\n+\n+bool CoinStatsIndex::LookupStats(const CBlockIndex* block_index, CCoinsStats& coins_stats) const\n+{\n+    DBVal entry;\n+    if (!LookupOne(*m_db, block_index, entry)) {\n+        return false;\n+    }\n+\n+    coins_stats.hashSerialized = entry.muhash;\n+    coins_stats.nTransactionOutputs = entry.transaction_output_count;\n+    coins_stats.nBogoSize = entry.bogo_size;\n+    coins_stats.nTotalAmount = entry.total_amount;\n+\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    if (!m_db->Read(DB_MUHASH, m_muhash)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_MUHASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+    }\n+\n+    if (BaseIndex::Init()) {\n+        const CBlockIndex* pindex = CurrentIndex();\n+\n+        if (pindex) {\n+            DBVal entry;\n+            if (!LookupOne(*m_db, pindex, entry)) {\n+                return false;\n+            }\n+\n+            m_transaction_output_count = entry.transaction_output_count;\n+            m_bogo_size = entry.bogo_size;\n+            m_total_amount = entry.total_amount;\n+            m_total_subsidy = entry.total_subsidy;\n+            m_block_unspendable_amount = entry.block_unspendable_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584621490",
      "id" : 584621490,
      "line" : 357,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYyMTQ5MA==",
      "original_commit_id" : "1fc3470c1b03857245b94eebde5cd0f18805a884",
      "original_line" : 357,
      "original_position" : 297,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 357,
      "pull_request_review_id" : 600575630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584621490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584624182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584624182"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1fc3470c1b03857245b94eebde5cd0f18805a884 if you're checking MuHash for consistency, why not also check the other variables?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T11:06:41Z",
      "diff_hunk" : "@@ -0,0 +1,379 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        // TODO\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+                COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+                    COutPoint outpoint = COutPoint(tx->vin[j].prevout.hash, tx->vin[j].prevout.n);\n+\n+                    m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    }\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+\n+    uint256 out;\n+    m_muhash.Finalize(out);\n+    value.second.muhash = out;\n+\n+    if (!m_db->Write(DBHeightKey(pindex->nHeight), value)) {\n+        return false;\n+    }\n+\n+    if (!m_db->Write(DB_MUHASH, m_muhash)) {\n+        return false;\n+    }\n+\n+    return true;\n+}\n+\n+static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n+                                       const std::string& index_name,\n+                                       int start_height, int stop_height)\n+{\n+    DBHeightKey key(start_height);\n+    db_it.Seek(key);\n+\n+    for (int height = start_height; height <= stop_height; ++height) {\n+        if (!db_it.GetKey(key) || key.height != height) {\n+            return error(\"%s: unexpected key in %s: expected (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        std::pair<uint256, DBVal> value;\n+        if (!db_it.GetValue(value)) {\n+            return error(\"%s: unable to read value in %s at key (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        batch.Write(DBHashKey(value.first), std::move(value.second));\n+\n+        db_it.Next();\n+    }\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip)\n+{\n+    assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n+\n+    CDBBatch batch(*m_db);\n+    std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n+\n+    {\n+        LOCK(cs_main);\n+        CBlockIndex* iter_tip = g_chainman.m_blockman.LookupBlockIndex(current_tip->GetBlockHash());\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        do {\n+            CBlock block;\n+\n+            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                               __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+\n+            ReverseBlock(block, iter_tip);\n+\n+            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n+        } while (new_tip != iter_tip);\n+    }\n+\n+    // During a reorg, we need to copy all hash digests for blocks that are getting disconnected from the\n+    // height index to the hash index so we can still find them when the height index entries are\n+    // overwritten.\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip->nHeight, current_tip->nHeight)) {\n+        return false;\n+    }\n+\n+    if (!m_db->WriteBatch(batch)) return false;\n+\n+    return BaseIndex::Rewind(current_tip, new_tip);\n+}\n+\n+static bool LookupOne(const CDBWrapper& db, const CBlockIndex* block_index, DBVal& result)\n+{\n+    // First check if the result is stored under the height index and the value there matches the\n+    // block hash. This should be the case if the block is on the active chain.\n+    std::pair<uint256, DBVal> read_out;\n+    if (!db.Read(DBHeightKey(block_index->nHeight), read_out)) {\n+        return false;\n+    }\n+    if (read_out.first == block_index->GetBlockHash()) {\n+        result = std::move(read_out.second);\n+        return true;\n+    }\n+\n+    // If value at the height index corresponds to an different block, the result will be stored in\n+    // the hash index.\n+    return db.Read(DBHashKey(block_index->GetBlockHash()), result);\n+}\n+\n+bool CoinStatsIndex::LookupStats(const CBlockIndex* block_index, CCoinsStats& coins_stats) const\n+{\n+    DBVal entry;\n+    if (!LookupOne(*m_db, block_index, entry)) {\n+        return false;\n+    }\n+\n+    coins_stats.hashSerialized = entry.muhash;\n+    coins_stats.nTransactionOutputs = entry.transaction_output_count;\n+    coins_stats.nBogoSize = entry.bogo_size;\n+    coins_stats.nTotalAmount = entry.total_amount;\n+\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    if (!m_db->Read(DB_MUHASH, m_muhash)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_MUHASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+    }\n+\n+    if (BaseIndex::Init()) {\n+        const CBlockIndex* pindex = CurrentIndex();\n+\n+        if (pindex) {\n+            DBVal entry;\n+            if (!LookupOne(*m_db, pindex, entry)) {\n+                return false;\n+            }\n+\n+            m_transaction_output_count = entry.transaction_output_count;\n+            m_bogo_size = entry.bogo_size;\n+            m_total_amount = entry.total_amount;\n+            m_total_subsidy = entry.total_subsidy;\n+            m_block_unspendable_amount = entry.block_unspendable_amount;\n+            m_block_prevout_spent_amount = entry.block_prevout_spent_amount;\n+            m_block_new_outputs_ex_coinbase_amount = entry.block_new_outputs_ex_coinbase_amount;\n+            m_block_coinbase_amount = entry.block_coinbase_amount;\n+            m_unspendables_genesis_block = entry.unspendables_genesis_block;\n+            m_unspendables_bip30 = entry.unspendables_bip30;\n+            m_unspendables_op_return = entry.unspendables_op_return;\n+            m_unspendables_unclaimed_rewards = entry.unspendables_unclaimed_rewards;\n+        }\n+\n+        return true;\n+    }\n+\n+    return false;\n+}\n+\n+\n+\n+// Reverse Block in case of reorg\n+bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    std::pair<uint256, DBVal> read_out;\n+\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+    }\n+\n+    // Remove the new utxos that were created from the block\n+    for (size_t i = 0; i < block.vtx.size(); ++i) {\n+        const auto& tx = block.vtx.at(i);\n+\n+        for (size_t j = 0; j < tx->vout.size(); ++j) {\n+            const CTxOut& out = tx->vout[j];\n+            COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+            Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+            // Skip unspendable coins\n+            if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+            m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584624182",
      "id" : 584624182,
      "line" : 417,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYyNDE4Mg==",
      "original_commit_id" : "1fc3470c1b03857245b94eebde5cd0f18805a884",
      "original_line" : 417,
      "original_position" : 349,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 417,
      "pull_request_review_id" : 600575630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584624182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584626513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584626513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How _do_ we process the genesis block?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T11:10:18Z",
      "diff_hunk" : "@@ -0,0 +1,309 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    uint64_t disk_size;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.disk_size);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    DBHeightKey() : height(0) {}\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    DBVal result;\n+    if (!m_db->Read(DB_BLOCK_HASH, result)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_BLOCK_HASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+\n+        m_transaction_output_count = 0;\n+        m_bogo_size = 0;\n+        m_total_amount = 0;\n+        m_disk_size = 0;\n+    }\n+\n+    return BaseIndex::Init();\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584626513",
      "id" : 584626513,
      "in_reply_to_id" : 485665973,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYyNjUxMw==",
      "original_commit_id" : "d28fed9b50c21b5f170b10f10532467989f043e5",
      "original_line" : 119,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 119,
      "pull_request_review_id" : 600575630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584626513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584630707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584630707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be nice to add a test here that adds a block and then rolls it back, to see if the result is untouched.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T11:17:11Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test CoinStatsIndex across nodes.\n+\n+Test that the values returned by gettxoutsetinfo are consistent\n+between a node running the coinstatsindex and a node without\n+the index.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+    try_rpc,\n+)\n+\n+class CoinStatsIndexTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.supports_cli = False\n+        self.extra_args = [\n+            [],\n+            [\"-coinstatsindex\"]\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self._test_coin_stats_index()\n+\n+    def _test_coin_stats_index(self):\n+        node = self.nodes[0]\n+        index_node = self.nodes[1]\n+        # Both none and muhash options allow the usage of the index\n+        index_hash_options = ['none', 'muhash']\n+\n+        # Generate a normal transaction and mine it\n+        node.generate(101)\n+        address = self.nodes[0].get_deterministic_priv_key().address\n+        node.sendtoaddress(address=address, amount=10, subtractfeefromamount=True)\n+        node.generate(1)\n+\n+        self.sync_blocks(timeout=120)\n+\n+        self.log.info(\"Test that gettxoutsetinfo() output is consistent with or without coinstatsindex option\")\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", node.gettxoutsetinfo))\n+        res0 = node.gettxoutsetinfo('none')\n+\n+        # The fields 'disk_size' and 'transactions' do not exist on the index\n+        del res0['disk_size'], res0['transactions']\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        for hash_option in index_hash_options:\n+            res1 = index_node.gettxoutsetinfo(hash_option)\n+            res1.pop('muhash', None)\n+\n+            # Everything left should be the same\n+            assert_equal(res1, res0)\n+\n+        self.log.info(\"Test that gettxoutsetinfo() can get fetch data on specific heights with index\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584630707",
      "id" : 584630707,
      "line" : 95,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYzMDcwNw==",
      "original_commit_id" : "9c07684e444a5c8e1f81d19221c6217dada3da72",
      "original_line" : 95,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "test/functional/feature_coinstatsindex.py",
      "position" : 95,
      "pull_request_review_id" : 600575630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584630707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584829802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584829802"
         }
      },
      "author_association" : "MEMBER",
      "body" : "rpc_help.py looking for `{ \"gettxoutsetinfo\", 2, \"no_index\"}` here:\r\n\r\n```\r\nFile \"/bitcoin/test/functional/rpc_help.py\", line 51, in run_test\r\n    self.test_client_conversion_table()\r\nFile \"/bitcoin/test/functional/rpc_help.py\", line 69, in test_client_conversion_table\r\n    raise AssertionError(\"RPC client conversion table ({}) and RPC server named arguments mismatch!\\n{}\".format(\r\nAssertionError: RPC client conversion table (/bitcoin/src/rpc/client.cpp) and RPC server named arguments mismatch!\r\n{('gettxoutsetinfo', 2, 'no_index')}\r\n```",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-01T15:49:47Z",
      "diff_hunk" : "@@ -127,6 +127,7 @@ static const CRPCConvertParam vRPCConvertParams[] =\n     { \"gettxout\", 1, \"n\" },\n     { \"gettxout\", 2, \"include_mempool\" },\n     { \"gettxoutproof\", 0, \"txids\" },\n+    { \"gettxoutsetinfo\", 1, \"hash_or_height\" },\n     { \"lockunspent\", 0, \"unlock\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r584829802",
      "id" : 584829802,
      "line" : 132,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDgyOTgwMg==",
      "original_commit_id" : "c3488a426f7ef71e45143e4bd797d06332bd5287",
      "original_line" : 132,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/client.cpp",
      "position" : 6,
      "pull_request_review_id" : 600883358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584829802",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/755825?v=4",
         "events_url" : "https://api.github.com/users/adamjonas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/adamjonas/followers",
         "following_url" : "https://api.github.com/users/adamjonas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/adamjonas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/adamjonas",
         "id" : 755825,
         "login" : "adamjonas",
         "node_id" : "MDQ6VXNlcjc1NTgyNQ==",
         "organizations_url" : "https://api.github.com/users/adamjonas/orgs",
         "received_events_url" : "https://api.github.com/users/adamjonas/received_events",
         "repos_url" : "https://api.github.com/users/adamjonas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/adamjonas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/adamjonas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/adamjonas"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585149164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585149164"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry, I confused myself quite a bit because I thought deduplicating bip30 block stuff was part of a Coinstats PR discussion and I had made a commit in a local branch but after searching for it for a while I realized now that it wasn't there, it was actually in #19888. So, this was actually a \"I think I had something that I might want to use here\" reminder for this: https://github.com/bitcoin/bitcoin/pull/19888/commits/b8797b064099aafadc0bbc9f152a962f76dd31e3. But I am not sure if it's worth it to throw another consensus critical code refactoring commit in here.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-02T00:17:31Z",
      "diff_hunk" : "@@ -0,0 +1,379 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        // TODO",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585149164",
      "id" : 585149164,
      "in_reply_to_id" : 584607991,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTE0OTE2NA==",
      "original_commit_id" : "1fc3470c1b03857245b94eebde5cd0f18805a884",
      "original_line" : 108,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 601291223,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585149164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585155146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585155146"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, strange I don't see this fail when running `rpc_help.py` locally. Should be fixed now.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-02T00:28:03Z",
      "diff_hunk" : "@@ -127,6 +127,7 @@ static const CRPCConvertParam vRPCConvertParams[] =\n     { \"gettxout\", 1, \"n\" },\n     { \"gettxout\", 2, \"include_mempool\" },\n     { \"gettxoutproof\", 0, \"txids\" },\n+    { \"gettxoutsetinfo\", 1, \"hash_or_height\" },\n     { \"lockunspent\", 0, \"unlock\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585155146",
      "id" : 585155146,
      "in_reply_to_id" : 584829802,
      "line" : 132,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTE1NTE0Ng==",
      "original_commit_id" : "c3488a426f7ef71e45143e4bd797d06332bd5287",
      "original_line" : 132,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/client.cpp",
      "position" : 6,
      "pull_request_review_id" : 601298874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585155146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585331716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585331716"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Definitely not. You could just make a separate PR for it later, and maybe write a comment to point out the duplication. ",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-02T07:51:28Z",
      "diff_hunk" : "@@ -0,0 +1,379 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        // TODO",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585331716",
      "id" : 585331716,
      "in_reply_to_id" : 584607991,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTMzMTcxNg==",
      "original_commit_id" : "1fc3470c1b03857245b94eebde5cd0f18805a884",
      "original_line" : 108,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 601513117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585331716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585414659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585414659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Instead of double-negation this could be named `use_index (default: true)`?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-02T09:45:58Z",
      "diff_hunk" : "@@ -1043,42 +1073,80 @@ static RPCHelpMan gettxoutsetinfo()\n {\n     return RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n+                    {\"no_index\", RPCArg::Type::BOOL, /* default */ \"false\", \"Don't use Coinstatsindex even when it is available.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585414659",
      "id" : 585414659,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTQxNDY1OQ==",
      "original_commit_id" : "5491fd38861253923387e92a386c1892035dece6",
      "original_line" : 1080,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 601621830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585414659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585415984"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585415984"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be nice to use a fixed address, instead of relying on the hardcoded one to not change. Also, could this be split up into a separate test-only pull?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-02T09:47:43Z",
      "diff_hunk" : "@@ -15,38 +14,41 @@\n from test_framework.muhash import MuHash3072\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n \n class UTXOSetHashTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def test_deterministic_hash_results(self):\n         self.log.info(\"Test deterministic UTXO set hash results\")\n \n-        # These depend on the setup_clean_chain option, the chain loaded from the cache\n-        assert_equal(self.nodes[0].gettxoutsetinfo()['hash_serialized_2'], \"b32ec1dda5a53cd025b95387aad344a801825fe46a60ff952ce26528f01d3be8\")\n-        assert_equal(self.nodes[0].gettxoutsetinfo(\"muhash\")['muhash'], \"dd5ad2a105c2d29495f577245c357409002329b9f4d6182c0af3dc2f462555c8\")\n+        node = self.nodes[0]\n+        mocktime = node.getblockheader(node.getblockhash(0))['time'] + 1\n+        node.setmocktime(mocktime)\n+        blocks = node.generate(10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r585415984",
      "id" : 585415984,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTQxNTk4NA==",
      "original_commit_id" : "5491fd38861253923387e92a386c1892035dece6",
      "original_line" : 30,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/feature_utxo_set_hash.py",
      "position" : null,
      "pull_request_review_id" : 601621830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585415984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586842261"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586842261"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, to be consistent we should only count stuff that actually ends up in the UTXO set.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-03T22:32:17Z",
      "diff_hunk" : "@@ -0,0 +1,379 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        // TODO\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+                COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586842261",
      "id" : 586842261,
      "in_reply_to_id" : 584617745,
      "line" : 168,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Njg0MjI2MQ==",
      "original_commit_id" : "1fc3470c1b03857245b94eebde5cd0f18805a884",
      "original_line" : 168,
      "original_position" : 133,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 168,
      "pull_request_review_id" : 603412830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586842261",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for your persistance on this @fjahr. Will review soon.",
      "created_at" : "2021-03-03T22:38:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-790122850",
      "id" : 790122850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDEyMjg1MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-03T22:38:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790122850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586921614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586921614"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-04T00:39:18Z",
      "diff_hunk" : "@@ -1043,42 +1073,80 @@ static RPCHelpMan gettxoutsetinfo()\n {\n     return RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n+                    {\"no_index\", RPCArg::Type::BOOL, /* default */ \"false\", \"Don't use Coinstatsindex even when it is available.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586921614",
      "id" : 586921614,
      "in_reply_to_id" : 585414659,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjkyMTYxNA==",
      "original_commit_id" : "5491fd38861253923387e92a386c1892035dece6",
      "original_line" : 1080,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 603548602,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586921614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586922720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586922720"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, I also still want to switch the test to use MiniWallet, that improvement is coming up. I could make a test only pull but personally, I find it hard to review a PR without some tests alongside it. But overall this has still grown quite a bit and there are probably still plenty of tests to be written, so I will think about where to make a good cut.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-04T00:42:24Z",
      "diff_hunk" : "@@ -15,38 +14,41 @@\n from test_framework.muhash import MuHash3072\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n \n class UTXOSetHashTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def test_deterministic_hash_results(self):\n         self.log.info(\"Test deterministic UTXO set hash results\")\n \n-        # These depend on the setup_clean_chain option, the chain loaded from the cache\n-        assert_equal(self.nodes[0].gettxoutsetinfo()['hash_serialized_2'], \"b32ec1dda5a53cd025b95387aad344a801825fe46a60ff952ce26528f01d3be8\")\n-        assert_equal(self.nodes[0].gettxoutsetinfo(\"muhash\")['muhash'], \"dd5ad2a105c2d29495f577245c357409002329b9f4d6182c0af3dc2f462555c8\")\n+        node = self.nodes[0]\n+        mocktime = node.getblockheader(node.getblockhash(0))['time'] + 1\n+        node.setmocktime(mocktime)\n+        blocks = node.generate(10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586922720",
      "id" : 586922720,
      "in_reply_to_id" : 585415984,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjkyMjcyMA==",
      "original_commit_id" : "5491fd38861253923387e92a386c1892035dece6",
      "original_line" : 30,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/feature_utxo_set_hash.py",
      "position" : null,
      "pull_request_review_id" : 603553861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586922720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586923367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586923367"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I added the test, please let me know if you can think of other scenarios that I might have missed.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-04T00:44:19Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test CoinStatsIndex across nodes.\n+\n+Test that the values returned by gettxoutsetinfo are consistent\n+between a node running the coinstatsindex and a node without\n+the index.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+    try_rpc,\n+)\n+\n+class CoinStatsIndexTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.supports_cli = False\n+        self.extra_args = [\n+            [],\n+            [\"-coinstatsindex\"]\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self._test_coin_stats_index()\n+\n+    def _test_coin_stats_index(self):\n+        node = self.nodes[0]\n+        index_node = self.nodes[1]\n+        # Both none and muhash options allow the usage of the index\n+        index_hash_options = ['none', 'muhash']\n+\n+        # Generate a normal transaction and mine it\n+        node.generate(101)\n+        address = self.nodes[0].get_deterministic_priv_key().address\n+        node.sendtoaddress(address=address, amount=10, subtractfeefromamount=True)\n+        node.generate(1)\n+\n+        self.sync_blocks(timeout=120)\n+\n+        self.log.info(\"Test that gettxoutsetinfo() output is consistent with or without coinstatsindex option\")\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", node.gettxoutsetinfo))\n+        res0 = node.gettxoutsetinfo('none')\n+\n+        # The fields 'disk_size' and 'transactions' do not exist on the index\n+        del res0['disk_size'], res0['transactions']\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        for hash_option in index_hash_options:\n+            res1 = index_node.gettxoutsetinfo(hash_option)\n+            res1.pop('muhash', None)\n+\n+            # Everything left should be the same\n+            assert_equal(res1, res0)\n+\n+        self.log.info(\"Test that gettxoutsetinfo() can get fetch data on specific heights with index\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586923367",
      "id" : 586923367,
      "in_reply_to_id" : 584630707,
      "line" : 95,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjkyMzM2Nw==",
      "original_commit_id" : "9c07684e444a5c8e1f81d19221c6217dada3da72",
      "original_line" : 95,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "test/functional/feature_coinstatsindex.py",
      "position" : 95,
      "pull_request_review_id" : 603557538,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586923367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586923385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586923385"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-04T00:44:23Z",
      "diff_hunk" : "@@ -0,0 +1,379 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        // TODO\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+                COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+                    COutPoint outpoint = COutPoint(tx->vin[j].prevout.hash, tx->vin[j].prevout.n);\n+\n+                    m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    }\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+\n+    uint256 out;\n+    m_muhash.Finalize(out);\n+    value.second.muhash = out;\n+\n+    if (!m_db->Write(DBHeightKey(pindex->nHeight), value)) {\n+        return false;\n+    }\n+\n+    if (!m_db->Write(DB_MUHASH, m_muhash)) {\n+        return false;\n+    }\n+\n+    return true;\n+}\n+\n+static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n+                                       const std::string& index_name,\n+                                       int start_height, int stop_height)\n+{\n+    DBHeightKey key(start_height);\n+    db_it.Seek(key);\n+\n+    for (int height = start_height; height <= stop_height; ++height) {\n+        if (!db_it.GetKey(key) || key.height != height) {\n+            return error(\"%s: unexpected key in %s: expected (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        std::pair<uint256, DBVal> value;\n+        if (!db_it.GetValue(value)) {\n+            return error(\"%s: unable to read value in %s at key (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        batch.Write(DBHashKey(value.first), std::move(value.second));\n+\n+        db_it.Next();\n+    }\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip)\n+{\n+    assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n+\n+    CDBBatch batch(*m_db);\n+    std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n+\n+    {\n+        LOCK(cs_main);\n+        CBlockIndex* iter_tip = g_chainman.m_blockman.LookupBlockIndex(current_tip->GetBlockHash());\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        do {\n+            CBlock block;\n+\n+            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                               __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+\n+            ReverseBlock(block, iter_tip);\n+\n+            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n+        } while (new_tip != iter_tip);\n+    }\n+\n+    // During a reorg, we need to copy all hash digests for blocks that are getting disconnected from the\n+    // height index to the hash index so we can still find them when the height index entries are\n+    // overwritten.\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip->nHeight, current_tip->nHeight)) {\n+        return false;\n+    }\n+\n+    if (!m_db->WriteBatch(batch)) return false;\n+\n+    return BaseIndex::Rewind(current_tip, new_tip);\n+}\n+\n+static bool LookupOne(const CDBWrapper& db, const CBlockIndex* block_index, DBVal& result)\n+{\n+    // First check if the result is stored under the height index and the value there matches the\n+    // block hash. This should be the case if the block is on the active chain.\n+    std::pair<uint256, DBVal> read_out;\n+    if (!db.Read(DBHeightKey(block_index->nHeight), read_out)) {\n+        return false;\n+    }\n+    if (read_out.first == block_index->GetBlockHash()) {\n+        result = std::move(read_out.second);\n+        return true;\n+    }\n+\n+    // If value at the height index corresponds to an different block, the result will be stored in\n+    // the hash index.\n+    return db.Read(DBHashKey(block_index->GetBlockHash()), result);\n+}\n+\n+bool CoinStatsIndex::LookupStats(const CBlockIndex* block_index, CCoinsStats& coins_stats) const\n+{\n+    DBVal entry;\n+    if (!LookupOne(*m_db, block_index, entry)) {\n+        return false;\n+    }\n+\n+    coins_stats.hashSerialized = entry.muhash;\n+    coins_stats.nTransactionOutputs = entry.transaction_output_count;\n+    coins_stats.nBogoSize = entry.bogo_size;\n+    coins_stats.nTotalAmount = entry.total_amount;\n+\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    if (!m_db->Read(DB_MUHASH, m_muhash)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_MUHASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+    }\n+\n+    if (BaseIndex::Init()) {\n+        const CBlockIndex* pindex = CurrentIndex();\n+\n+        if (pindex) {\n+            DBVal entry;\n+            if (!LookupOne(*m_db, pindex, entry)) {\n+                return false;\n+            }\n+\n+            m_transaction_output_count = entry.transaction_output_count;\n+            m_bogo_size = entry.bogo_size;\n+            m_total_amount = entry.total_amount;\n+            m_total_subsidy = entry.total_subsidy;\n+            m_block_unspendable_amount = entry.block_unspendable_amount;\n+            m_block_prevout_spent_amount = entry.block_prevout_spent_amount;\n+            m_block_new_outputs_ex_coinbase_amount = entry.block_new_outputs_ex_coinbase_amount;\n+            m_block_coinbase_amount = entry.block_coinbase_amount;\n+            m_unspendables_genesis_block = entry.unspendables_genesis_block;\n+            m_unspendables_bip30 = entry.unspendables_bip30;\n+            m_unspendables_op_return = entry.unspendables_op_return;\n+            m_unspendables_unclaimed_rewards = entry.unspendables_unclaimed_rewards;\n+        }\n+\n+        return true;\n+    }\n+\n+    return false;\n+}\n+\n+\n+\n+// Reverse Block in case of reorg\n+bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    std::pair<uint256, DBVal> read_out;\n+\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+    }\n+\n+    // Remove the new utxos that were created from the block\n+    for (size_t i = 0; i < block.vtx.size(); ++i) {\n+        const auto& tx = block.vtx.at(i);\n+\n+        for (size_t j = 0; j < tx->vout.size(); ++j) {\n+            const CTxOut& out = tx->vout[j];\n+            COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+            Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+\n+            // Skip unspendable coins\n+            if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+            m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586923385",
      "id" : 586923385,
      "in_reply_to_id" : 584624182,
      "line" : 417,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjkyMzM4NQ==",
      "original_commit_id" : "1fc3470c1b03857245b94eebde5cd0f18805a884",
      "original_line" : 417,
      "original_position" : 349,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 417,
      "pull_request_review_id" : 603557646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586923385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586923437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586923437"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yepp, fixed.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-04T00:44:30Z",
      "diff_hunk" : "@@ -0,0 +1,379 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                         __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+        }\n+\n+        // TODO\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+                COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {\n+                const auto& tx_undo = block_undo.vtxundo.at(i-1);\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin = tx_undo.vprevout[j];\n+                    COutPoint outpoint = COutPoint(tx->vin[j].prevout.hash, tx->vin[j].prevout.n);\n+\n+                    m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                    m_transaction_output_count--;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    }\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+\n+    uint256 out;\n+    m_muhash.Finalize(out);\n+    value.second.muhash = out;\n+\n+    if (!m_db->Write(DBHeightKey(pindex->nHeight), value)) {\n+        return false;\n+    }\n+\n+    if (!m_db->Write(DB_MUHASH, m_muhash)) {\n+        return false;\n+    }\n+\n+    return true;\n+}\n+\n+static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n+                                       const std::string& index_name,\n+                                       int start_height, int stop_height)\n+{\n+    DBHeightKey key(start_height);\n+    db_it.Seek(key);\n+\n+    for (int height = start_height; height <= stop_height; ++height) {\n+        if (!db_it.GetKey(key) || key.height != height) {\n+            return error(\"%s: unexpected key in %s: expected (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        std::pair<uint256, DBVal> value;\n+        if (!db_it.GetValue(value)) {\n+            return error(\"%s: unable to read value in %s at key (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        batch.Write(DBHashKey(value.first), std::move(value.second));\n+\n+        db_it.Next();\n+    }\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip)\n+{\n+    assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n+\n+    CDBBatch batch(*m_db);\n+    std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n+\n+    {\n+        LOCK(cs_main);\n+        CBlockIndex* iter_tip = g_chainman.m_blockman.LookupBlockIndex(current_tip->GetBlockHash());\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        do {\n+            CBlock block;\n+\n+            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                               __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+\n+            ReverseBlock(block, iter_tip);\n+\n+            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n+        } while (new_tip != iter_tip);\n+    }\n+\n+    // During a reorg, we need to copy all hash digests for blocks that are getting disconnected from the\n+    // height index to the hash index so we can still find them when the height index entries are\n+    // overwritten.\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip->nHeight, current_tip->nHeight)) {\n+        return false;\n+    }\n+\n+    if (!m_db->WriteBatch(batch)) return false;\n+\n+    return BaseIndex::Rewind(current_tip, new_tip);\n+}\n+\n+static bool LookupOne(const CDBWrapper& db, const CBlockIndex* block_index, DBVal& result)\n+{\n+    // First check if the result is stored under the height index and the value there matches the\n+    // block hash. This should be the case if the block is on the active chain.\n+    std::pair<uint256, DBVal> read_out;\n+    if (!db.Read(DBHeightKey(block_index->nHeight), read_out)) {\n+        return false;\n+    }\n+    if (read_out.first == block_index->GetBlockHash()) {\n+        result = std::move(read_out.second);\n+        return true;\n+    }\n+\n+    // If value at the height index corresponds to an different block, the result will be stored in\n+    // the hash index.\n+    return db.Read(DBHashKey(block_index->GetBlockHash()), result);\n+}\n+\n+bool CoinStatsIndex::LookupStats(const CBlockIndex* block_index, CCoinsStats& coins_stats) const\n+{\n+    DBVal entry;\n+    if (!LookupOne(*m_db, block_index, entry)) {\n+        return false;\n+    }\n+\n+    coins_stats.hashSerialized = entry.muhash;\n+    coins_stats.nTransactionOutputs = entry.transaction_output_count;\n+    coins_stats.nBogoSize = entry.bogo_size;\n+    coins_stats.nTotalAmount = entry.total_amount;\n+\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    if (!m_db->Read(DB_MUHASH, m_muhash)) {\n+        // Check that the cause of the read failure is that the key does not exist. Any other errors\n+        // indicate database corruption or a disk failure, and starting the index would cause\n+        // further corruption.\n+        if (m_db->Exists(DB_MUHASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+    }\n+\n+    if (BaseIndex::Init()) {\n+        const CBlockIndex* pindex = CurrentIndex();\n+\n+        if (pindex) {\n+            DBVal entry;\n+            if (!LookupOne(*m_db, pindex, entry)) {\n+                return false;\n+            }\n+\n+            m_transaction_output_count = entry.transaction_output_count;\n+            m_bogo_size = entry.bogo_size;\n+            m_total_amount = entry.total_amount;\n+            m_total_subsidy = entry.total_subsidy;\n+            m_block_unspendable_amount = entry.block_unspendable_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586923437",
      "id" : 586923437,
      "in_reply_to_id" : 584621490,
      "line" : 357,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjkyMzQzNw==",
      "original_commit_id" : "1fc3470c1b03857245b94eebde5cd0f18805a884",
      "original_line" : 357,
      "original_position" : 297,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 357,
      "pull_request_review_id" : 603557868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586923437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586923513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586923513"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yepp, makes sense. Done.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-04T00:44:41Z",
      "diff_hunk" : "@@ -5437,7 +5437,7 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     // about the snapshot_chainstate.\n     CCoinsViewDB* snapshot_coinsdb = WITH_LOCK(::cs_main, return &snapshot_chainstate.CoinsDB());\n \n-    if (!GetUTXOStats(snapshot_coinsdb, stats, CoinStatsHashType::HASH_SERIALIZED, breakpoint_fnc)) {\n+    if (!GetUTXOStats(snapshot_coinsdb, stats, breakpoint_fnc)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r586923513",
      "id" : 586923513,
      "in_reply_to_id" : 584591432,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjkyMzUxMw==",
      "original_commit_id" : "917e29a7767d08f5ba04c7f91a4d0d265017e75b",
      "original_line" : 5440,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 603558203,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586923513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed several comments by @Sjors and @MarcoFalke . Thanks for reviewing ð \r\n\r\n> How do we process the genesis block?\r\n\r\n(for some reason GH doesn't let me comment on this) The Genesis block is explicitly skipped in `WriteBlock`.\r\n\r\n> [c3488a4](https://github.com/bitcoin/bitcoin/commit/c3488a426f7ef71e45143e4bd797d06332bd5287) is getting very close\r\n> \r\n> `rpc_help.py` complains:\r\n> \r\n> ```\r\n> RPC server named arguments mismatch!\r\n> {('gettxoutsetinfo', 2, 'no_index')}\r\n> ```\r\n> \r\n> Probably because you need to add ` { \"gettxoutsetinfo\", 2, \"no_index\" }` to `client.cpp`.\r\n\r\nYepp, fixed.\r\n\r\n> \r\n> The [error I found last week](https://github.com/bitcoin/bitcoin/pull/19521#pullrequestreview-596324632) is gone now.\r\n> \r\n> > a bug when you restart the node during the indexing process. E.g. `txouts` and `bogosize` seem to get reset and can even turn negative.\r\n> \r\n> This has also been fixed now.\r\n> \r\n> The \"To be discussed\" section in the PR description can be dropped now.\r\n> \r\n> MuHash at height 670,000: `b1567b5e632bd67e72e056711fd644945ed9abcae5c28bf4750e4a10c567112a`\r\n> hash_serialized_2 at height 672702: `0aafad4ae3a9e8b9c9f97a6b9e16e19e0c24bfc5543470436f365e0b1edec222`, but with `no_index` and on master it's `b5177c4bd0df0195c8e8877c33f973b740bf148301c8662eca94cf0b3385f210`.\r\n> bogo_size at height 672702: `5466711713` (matches no_index and master)\r\n\r\nI had inserted the MuHash insert line above the line that skips unspendable outputs, so they were added to the hash, that's why they must have been inconsistent. I haven't yet synced with the new code, will test tomorrow.\r\n\r\nI think the hash_serialized call with a specific height shouldn't work since it's incompatible with the index, so I added that.\r\n\r\n> \r\n> When I did `src/bitcoin-cli gettxoutsetinfo muhash 670000 true`, when my tip was further, it returned a muhash that appears to be nonsense. It should error instead.\r\n> \r\n> Other reviewers, see also my [list of interesting blocks](https://github.com/bitcoin/bitcoin/pull/19521#pullrequestreview-505535088) above. When testing the tip, it helps to call `setnetworkactive false` so it doesn't move between calls.\r\n> \r\n> I'd still like to know what happens when a `valid-fork` chaintip has two or more blocks. Unfortunately I don't have any on my node: `bitcoin-cli getchaintips | jq '.[] | select(.status == \"valid-fork\")'`. My node did see a 2 block fork at height 656,478, but it only has the headers. I could use #20295 to fetch the block if it's still out there. In order for the indexer to pick it up, I guess it has to be validated? So that would require a long rollback. So anyway, a test would be easier.\r\n> \r\n> Regarding the error I saw with `645179` when asking for the hash of a stale block, this makes sense now: you only create a block hash based entry _during_ a reorg, but it's not done for all the stale blocks the node already has. This is probably a general issue with the indexes system, and not worth addressing here imo.\r\n> \r\n> Bonus tip for other reviewers, if you want to drink tea while the index builds, try @dongcarl's [yo](https://apps.apple.com/ua/app/yo-terminal-notifications/id1542496070):\r\n> `while (src/bitcoin-cli getindexinfo | jq '.coinstatsindex.synced' | grep \"false\"); do sleep 60; done; yo`\r\n",
      "created_at" : "2021-03-04T00:56:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-790197840",
      "id" : 790197840,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDE5Nzg0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T00:56:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790197840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">> How do we process the genesis block?\r\n\r\n> The Genesis block is explicitly skipped in WriteBlock.\r\n\r\nBut then why isn't the result of `src/bitcoin-cli gettxoutsetinfo muhash 0` all zeros? Yet it contains a value for muhash and `unspendables->genesis_block` is 50. Where does that get set?",
      "created_at" : "2021-03-04T12:18:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-790577414",
      "id" : 790577414,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDU3NzQxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T12:18:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790577414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > > How do we process the genesis block?\r\n> \r\n> > The Genesis block is explicitly skipped in WriteBlock.\r\n> \r\n> But then why isn't the result of `src/bitcoin-cli gettxoutsetinfo muhash 0` all zeros? Yet it contains a value for muhash and `unspendables->genesis_block` is 50. Where does that get set?\r\n\r\nWe skip almost all the processing of the genesis block in `WriteBlock()` from this line: https://github.com/bitcoin/bitcoin/pull/19521/files#diff-f1b8261031c7f062025f97106824d80601e5247ba0b68ffe608285eeaecceed2R112\r\n```\r\nif (pindex->nHeight > 0) {\r\n```\r\n\r\nBut there is also an else block belonging to that if ~80 lines later, that's where these values are set: https://github.com/bitcoin/bitcoin/pull/19521/files#diff-f1b8261031c7f062025f97106824d80601e5247ba0b68ffe608285eeaecceed2R188\r\n```\r\n    } else {\r\n        m_block_unspendable_amount += block_subsidy;\r\n        m_unspendables_genesis_block += block_subsidy;\r\n    }\r\n```",
      "created_at" : "2021-03-04T19:37:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-790876793",
      "id" : 790876793,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDg3Njc5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T19:37:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790876793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> But then why isn't the result of `src/bitcoin-cli gettxoutsetinfo muhash 0` all zeros?\r\n\r\nI realized I didn't answer that one yet. The internal state of the `MuHash3072` object is all zeros but that state gets finalized by hashing it with SHA256 so the uint256 output in the `gettxoutsetinfo` call is not all zeros anymore. ",
      "created_at" : "2021-03-06T23:34:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-792117478",
      "id" : 792117478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MjExNzQ3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-06T23:34:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/792117478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589029056"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589029056"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Splitting up the tests makes it easier to check for accidental regressions (https://github.com/bitcoin/bitcoin/pull/19145#discussion_r575334728, https://github.com/bitcoin/bitcoin/pull/19145#pullrequestreview-579351730, ...). If the tests are changed along with changes that should be refactor-only or new tests added for a different feature than the one being introduced, it may be easier to miss bugs.\r\n\r\nObviously a good first step is to touch the tests in separate commits, whenever possible, so the only burden to reviewers is to run the tests on each commit.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-07T13:16:12Z",
      "diff_hunk" : "@@ -15,38 +14,41 @@\n from test_framework.muhash import MuHash3072\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n \n class UTXOSetHashTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def test_deterministic_hash_results(self):\n         self.log.info(\"Test deterministic UTXO set hash results\")\n \n-        # These depend on the setup_clean_chain option, the chain loaded from the cache\n-        assert_equal(self.nodes[0].gettxoutsetinfo()['hash_serialized_2'], \"b32ec1dda5a53cd025b95387aad344a801825fe46a60ff952ce26528f01d3be8\")\n-        assert_equal(self.nodes[0].gettxoutsetinfo(\"muhash\")['muhash'], \"dd5ad2a105c2d29495f577245c357409002329b9f4d6182c0af3dc2f462555c8\")\n+        node = self.nodes[0]\n+        mocktime = node.getblockheader(node.getblockhash(0))['time'] + 1\n+        node.setmocktime(mocktime)\n+        blocks = node.generate(10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589029056",
      "id" : 589029056,
      "in_reply_to_id" : 585415984,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTAyOTA1Ng==",
      "original_commit_id" : "5491fd38861253923387e92a386c1892035dece6",
      "original_line" : 30,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/feature_utxo_set_hash.py",
      "position" : null,
      "pull_request_review_id" : 605845036,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589029056",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589070367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589070367"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d608c400411f1451d6298efc1bf6f200a56aa136: no need to brag that you use `vim`",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-07T18:40:35Z",
      "diff_hunk" : "@@ -0,0 +1,372 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODOi: Deduplicate BIP30 related code",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589070367",
      "id" : 589070367,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTA3MDM2Nw==",
      "original_commit_id" : "d608c400411f1451d6298efc1bf6f200a56aa136",
      "original_line" : 110,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 605873130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589070367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589072478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589072478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`stats.hashBlock = pindex->GetBlockHash();` so this check doesn't really do much. I believe what you want to (also) check here is that `muhash` for height 111 matches `muhash` for `blocks[0]`.\r\n\r\nFor context, the bit I'm worried about is that `CoinStatsIndex::WriteBlock` first attempts to fetch by height, only then falls back to fetching by hash.\r\n\r\nSo in the case of a reorg, I think it will ignore the hash and give you the result form the active tip branch. But the reorg I had in mind would come from a temporarily disconnected node (with some unique transaction so it's different). \r\n\r\nIn other words, try querying a reorged block by hash and see if it returns the right muhash, rather than the main chain one. \r\n\r\n```cpp\r\n        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\r\n            return false;\r\n        }\r\n\r\n        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\r\n        if (read_out.first != expected_block_hash) {\r\n            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\r\n```\r\n\r\nAnother thing you can test is what happens when you activate the index _after_ a reorg (but I think fixing issues there can wait).",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-07T18:59:45Z",
      "diff_hunk" : "@@ -247,6 +248,32 @@ def _test_use_index_option(self):\n         del res['disk_size'], option_res['disk_size']\n         assert_equal(res, option_res)\n \n+    def _test_reorg_index(self):\n+        self.log.info(\"Test that index can handle reorgs\")\n+\n+        # Generate a block, let the index catch up, then invalidate the block\n+        index_node = self.nodes[1]\n+        reorg_block = index_node.generatetoaddress(1, index_node.getnewaddress())[0]\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        index_node.invalidateblock(reorg_block)\n+        assert_equal(index_node.gettxoutsetinfo('muhash')['height'], 110)\n+\n+        # Add two new blocks\n+        blocks = index_node.generate(2)\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+\n+        # Test that the result of the reorged block is not returned for its old block height\n+        res = index_node.gettxoutsetinfo('muhash', 111)\n+        assert_equal(res[\"bestblock\"], blocks[0])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589072478",
      "id" : 589072478,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTA3MjQ3OA==",
      "original_commit_id" : "29ac833e8f94189bc33f735028428370b3d6de76",
      "original_line" : 267,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/feature_coinstatsindex.py",
      "position" : null,
      "pull_request_review_id" : 605873130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589072478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589729470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589729470"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You caught me ;) Fixed.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-08T20:34:50Z",
      "diff_hunk" : "@@ -0,0 +1,372 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODOi: Deduplicate BIP30 related code",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589729470",
      "id" : 589729470,
      "in_reply_to_id" : 589070367,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTcyOTQ3MA==",
      "original_commit_id" : "d608c400411f1451d6298efc1bf6f200a56aa136",
      "original_line" : 110,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 606684195,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589729470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589733818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589733818"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think I got you now. Initially, I misunderstood that I should move all the tests in this PR into separate PRs but I think you were only referring to the #19145 follow-ups, correct? I have moved these into #21390 and use one of the deterministic privkeys there now.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-08T20:42:08Z",
      "diff_hunk" : "@@ -15,38 +14,41 @@\n from test_framework.muhash import MuHash3072\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n \n class UTXOSetHashTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def test_deterministic_hash_results(self):\n         self.log.info(\"Test deterministic UTXO set hash results\")\n \n-        # These depend on the setup_clean_chain option, the chain loaded from the cache\n-        assert_equal(self.nodes[0].gettxoutsetinfo()['hash_serialized_2'], \"b32ec1dda5a53cd025b95387aad344a801825fe46a60ff952ce26528f01d3be8\")\n-        assert_equal(self.nodes[0].gettxoutsetinfo(\"muhash\")['muhash'], \"dd5ad2a105c2d29495f577245c357409002329b9f4d6182c0af3dc2f462555c8\")\n+        node = self.nodes[0]\n+        mocktime = node.getblockheader(node.getblockhash(0))['time'] + 1\n+        node.setmocktime(mocktime)\n+        blocks = node.generate(10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589733818",
      "id" : 589733818,
      "in_reply_to_id" : 585415984,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTczMzgxOA==",
      "original_commit_id" : "5491fd38861253923387e92a386c1892035dece6",
      "original_line" : 30,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/feature_utxo_set_hash.py",
      "position" : null,
      "pull_request_review_id" : 606689524,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589733818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589785367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589785367"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Interesting. Thanks for the clearer description @Sjors. The reorg case that you describe here (querying a reorged out block by hash) would return an error until now because `ParseHashOrHeight()` is checking that the queried block is part of the active chain. But I think it could be interesting to have that functionality so I removed this check and added the test. It works fine. However, I am still a bit unsure if I should integrate this here or pull it out into a separate PR because `ParseHashOrHeight()` is also used by `getblockstats` so it leads to a behavior change there too. Tests are passing though and I tend to think it's ok. But I have left it as a separate WIP commit for now for easier inspection.\r\n\r\n> Another thing you can test is what happens when you activate the index after a reorg (but I think fixing issues there can wait).\r\n\r\nNot sure I fully understand this one. Do you mean just activating the index for the first time on a node that is aware of some stale blocks?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-08T22:11:30Z",
      "diff_hunk" : "@@ -247,6 +248,32 @@ def _test_use_index_option(self):\n         del res['disk_size'], option_res['disk_size']\n         assert_equal(res, option_res)\n \n+    def _test_reorg_index(self):\n+        self.log.info(\"Test that index can handle reorgs\")\n+\n+        # Generate a block, let the index catch up, then invalidate the block\n+        index_node = self.nodes[1]\n+        reorg_block = index_node.generatetoaddress(1, index_node.getnewaddress())[0]\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        index_node.invalidateblock(reorg_block)\n+        assert_equal(index_node.gettxoutsetinfo('muhash')['height'], 110)\n+\n+        # Add two new blocks\n+        blocks = index_node.generate(2)\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+\n+        # Test that the result of the reorged block is not returned for its old block height\n+        res = index_node.gettxoutsetinfo('muhash', 111)\n+        assert_equal(res[\"bestblock\"], blocks[0])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589785367",
      "id" : 589785367,
      "in_reply_to_id" : 589072478,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTc4NTM2Nw==",
      "original_commit_id" : "29ac833e8f94189bc33f735028428370b3d6de76",
      "original_line" : 267,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/feature_coinstatsindex.py",
      "position" : null,
      "pull_request_review_id" : 606754869,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589785367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r590101001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/590101001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> But I think it could be interesting to have that functionality so I removed this check and added the test. It works fine.\r\n\r\nNice!\r\n\r\n> Do you mean just activating the index for the first time on a node that is aware of some stale blocks?\r\n\r\nCorrect. Do those stale blocks get indexed?\r\n\r\n",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-09T09:06:03Z",
      "diff_hunk" : "@@ -247,6 +248,32 @@ def _test_use_index_option(self):\n         del res['disk_size'], option_res['disk_size']\n         assert_equal(res, option_res)\n \n+    def _test_reorg_index(self):\n+        self.log.info(\"Test that index can handle reorgs\")\n+\n+        # Generate a block, let the index catch up, then invalidate the block\n+        index_node = self.nodes[1]\n+        reorg_block = index_node.generatetoaddress(1, index_node.getnewaddress())[0]\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        index_node.invalidateblock(reorg_block)\n+        assert_equal(index_node.gettxoutsetinfo('muhash')['height'], 110)\n+\n+        # Add two new blocks\n+        blocks = index_node.generate(2)\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+\n+        # Test that the result of the reorged block is not returned for its old block height\n+        res = index_node.gettxoutsetinfo('muhash', 111)\n+        assert_equal(res[\"bestblock\"], blocks[0])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r590101001",
      "id" : 590101001,
      "in_reply_to_id" : 589072478,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDEwMTAwMQ==",
      "original_commit_id" : "29ac833e8f94189bc33f735028428370b3d6de76",
      "original_line" : 267,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/feature_coinstatsindex.py",
      "position" : null,
      "pull_request_review_id" : 607167332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/590101001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r590143682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/590143682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I expanded the test to do a deeper reorg: https://github.com/Sjors/bitcoin/commit/24c37b2dc446e944176093f1cd47f32686cdd1aa",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-09T09:45:47Z",
      "diff_hunk" : "@@ -247,6 +248,32 @@ def _test_use_index_option(self):\n         del res['disk_size'], option_res['disk_size']\n         assert_equal(res, option_res)\n \n+    def _test_reorg_index(self):\n+        self.log.info(\"Test that index can handle reorgs\")\n+\n+        # Generate a block, let the index catch up, then invalidate the block\n+        index_node = self.nodes[1]\n+        reorg_block = index_node.generatetoaddress(1, index_node.getnewaddress())[0]\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        index_node.invalidateblock(reorg_block)\n+        assert_equal(index_node.gettxoutsetinfo('muhash')['height'], 110)\n+\n+        # Add two new blocks\n+        blocks = index_node.generate(2)\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+\n+        # Test that the result of the reorged block is not returned for its old block height\n+        res = index_node.gettxoutsetinfo('muhash', 111)\n+        assert_equal(res[\"bestblock\"], blocks[0])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r590143682",
      "id" : 590143682,
      "in_reply_to_id" : 589072478,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDE0MzY4Mg==",
      "original_commit_id" : "29ac833e8f94189bc33f735028428370b3d6de76",
      "original_line" : 267,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/feature_coinstatsindex.py",
      "position" : null,
      "pull_request_review_id" : 607205351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/590143682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think you lost 6b21ff9bf7 in the rebase? I think ffeb0af71f and 98ec2e5170 were moved to #21390.",
      "created_at" : "2021-03-09T09:52:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-793641922",
      "id" : 793641922,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MzY0MTkyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-09T09:53:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/793641922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think you lost [6b21ff9](https://github.com/bitcoin/bitcoin/commit/6b21ff9bf7afca0cc25942fb49175b6bd7113e87) in the rebase? I think [ffeb0af](https://github.com/bitcoin/bitcoin/commit/ffeb0af71fc0e8e2eff5af54c4550dd5b96c9e23) and [98ec2e5](https://github.com/bitcoin/bitcoin/commit/98ec2e5170f41bd50cd6d6d89d386bbd44f79bcc) were moved to #21390.\r\n\r\nSorry, yes, I moved all three of them to #21390 but only commented on it here https://github.com/bitcoin/bitcoin/pull/19521#discussion_r589733818 . The test changes were follow-ups to #19145 and the  doc improvements could also stand alone after I made some light edits so I followed @MarcoFalke 's recommendation there. ",
      "created_at" : "2021-03-10T23:02:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-796267017",
      "id" : 796267017,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjI2NzAxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-10T23:02:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796267017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r591963642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591963642"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Cool, I pulled in your changes and made you co-author. The stale blocks don't get indexed because the base index only follows the active chain when syncing. I have added some additional coverage for that in the reorg test part, mainly to document that behavior. I have pulled the change that allows querying stale blocks in its own commit so it's more clear that this also touches `getblockstats` and that that gets the attention such a side effect deserves.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-10T23:50:26Z",
      "diff_hunk" : "@@ -247,6 +248,32 @@ def _test_use_index_option(self):\n         del res['disk_size'], option_res['disk_size']\n         assert_equal(res, option_res)\n \n+    def _test_reorg_index(self):\n+        self.log.info(\"Test that index can handle reorgs\")\n+\n+        # Generate a block, let the index catch up, then invalidate the block\n+        index_node = self.nodes[1]\n+        reorg_block = index_node.generatetoaddress(1, index_node.getnewaddress())[0]\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        index_node.invalidateblock(reorg_block)\n+        assert_equal(index_node.gettxoutsetinfo('muhash')['height'], 110)\n+\n+        # Add two new blocks\n+        blocks = index_node.generate(2)\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+\n+        # Test that the result of the reorged block is not returned for its old block height\n+        res = index_node.gettxoutsetinfo('muhash', 111)\n+        assert_equal(res[\"bestblock\"], blocks[0])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r591963642",
      "id" : 591963642,
      "in_reply_to_id" : 589072478,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTk2MzY0Mg==",
      "original_commit_id" : "29ac833e8f94189bc33f735028428370b3d6de76",
      "original_line" : 267,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/feature_coinstatsindex.py",
      "position" : null,
      "pull_request_review_id" : 609278537,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591963642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-utACK fc3f9c0a0debe040971098c3edb1078c8679c54c",
      "created_at" : "2021-03-11T10:12:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-796625212",
      "id" : 796625212,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjYyNTIxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T10:12:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796625212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-11T12:47:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-796711107",
      "id" : 796711107,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjcxMTEwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T12:47:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796711107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "rebased",
      "created_at" : "2021-03-11T23:22:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-797116798",
      "id" : 797116798,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NzExNjc5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T23:22:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/797116798",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r592832081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592832081"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please [use `std::make_unique` in new code](https://github.com/bitcoin/bitcoin/blob/master/src/util/memory.h#L13).",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-12T00:45:24Z",
      "diff_hunk" : "@@ -1809,6 +1821,11 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n         GetBlockFilterIndex(filter_type)->Start();\n     }\n \n+    if (args.GetBoolArg(\"-coinstatsindex\", DEFAULT_COINSTATSINDEX)) {\n+        g_coin_stats_index = MakeUnique<CoinStatsIndex>(coin_stats_cache_size, false, fReindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r592832081",
      "id" : 592832081,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjgzMjA4MQ==",
      "original_commit_id" : "28d2bc80d610d6f783934bab3efba0019dca6276",
      "original_line" : 1825,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 610362273,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592832081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r593512325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593512325"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-12T23:53:28Z",
      "diff_hunk" : "@@ -1809,6 +1821,11 @@ bool AppInitMain(const util::Ref& context, NodeContext& node, interfaces::BlockA\n         GetBlockFilterIndex(filter_type)->Start();\n     }\n \n+    if (args.GetBoolArg(\"-coinstatsindex\", DEFAULT_COINSTATSINDEX)) {\n+        g_coin_stats_index = MakeUnique<CoinStatsIndex>(coin_stats_cache_size, false, fReindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r593512325",
      "id" : 593512325,
      "in_reply_to_id" : 592832081,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MzUxMjMyNQ==",
      "original_commit_id" : "28d2bc80d610d6f783934bab3efba0019dca6276",
      "original_line" : 1825,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 611229945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593512325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed @fanquake s comment and used `std::make_unique`.",
      "created_at" : "2021-03-12T23:54:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-797819214",
      "id" : 797819214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NzgxOTIxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-12T23:54:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/797819214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r594262300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594262300"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm seeing build errors here (debian gcc 10.2.1)\r\n```\r\nindex/coinstatsindex.cpp: In constructor âCoinStatsIndex::CoinStatsIndex(size_t, bool, bool)â:\r\nindex/coinstatsindex.cpp:102:12: error: âMakeUniqueâ was not declared in this scope\r\n  102 |     m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\r\n      |            ^~~~~~~~~~\r\n```\r\nand with clang 11\r\n```\r\nindex/coinstatsindex.cpp:102:12: error: use of undeclared identifier 'MakeUnique'\r\n    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\r\n           ^\r\n1 error generated.\r\n```\r\nmaybe need to use `std::make_unique`",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-15T11:38:47Z",
      "diff_hunk" : "@@ -0,0 +1,480 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r594262300",
      "id" : 594262300,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDI2MjMwMA==",
      "original_commit_id" : "7e1382942fdd51cdfbc2f83e84a14bd6489220b7",
      "original_line" : 102,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 612093575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594262300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r594291070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594291070"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Update: build, unit tests and `test/functional/feature_coinstatsindex.py` are green for me locally after replacing with `std::make_unique`.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-15T12:26:57Z",
      "diff_hunk" : "@@ -0,0 +1,480 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r594291070",
      "id" : 594291070,
      "in_reply_to_id" : 594262300,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDI5MTA3MA==",
      "original_commit_id" : "7e1382942fdd51cdfbc2f83e84a14bd6489220b7",
      "original_line" : 102,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 612131751,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594291070",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r594698655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594698655"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ugh, indeed, sloppily overlooked during the last update. Thanks @jonatack ! Fixed.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-15T21:33:28Z",
      "diff_hunk" : "@@ -0,0 +1,480 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = MakeUnique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r594698655",
      "id" : 594698655,
      "in_reply_to_id" : 594262300,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY5ODY1NQ==",
      "original_commit_id" : "7e1382942fdd51cdfbc2f83e84a14bd6489220b7",
      "original_line" : 102,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 612661710,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594698655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 9e746e8\r\nMuHash at height 674,863: `eca35832ffdac43638e849e818ae10db7d2ea53746c406e386e8139e0583a990` (matches `use_index=false`)",
      "created_at" : "2021-03-16T09:56:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-800117128",
      "id" : 800117128,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMDExNzEyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-16T09:56:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/800117128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for re-pushing @fjahr. Reviewing.",
      "created_at" : "2021-03-16T17:30:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-800463219",
      "id" : 800463219,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMDQ2MzIxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-16T17:30:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/800463219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "When building bf347106cd \"index: Coinstats index can be activated with command line flag\"\r\n\r\n```\r\nrpc/blockchain.cpp: In lambda function:\r\nrpc/blockchain.cpp:1092:13: error: âg_coin_stats_indexâ was not declared in this scope\r\n 1092 |         if (g_coin_stats_index && (g_coin_stats_index->GetSummary().synced == false)) {\r\n      |             ^~~~~~~~~~~~~~~~~~\r\n```",
      "created_at" : "2021-03-16T18:15:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-800496273",
      "id" : 800496273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMDQ5NjI3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-16T18:15:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/800496273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> When building [bf34710](https://github.com/bitcoin/bitcoin/commit/bf347106cd463ecc0d8ab3795b8d6e0805ebea65) \"index: Coinstats index can be activated with command line flag\"\r\n> \r\n> ```\r\n> rpc/blockchain.cpp: In lambda function:\r\n> rpc/blockchain.cpp:1092:13: error: âg_coin_stats_indexâ was not declared in this scope\r\n>  1092 |         if (g_coin_stats_index && (g_coin_stats_index->GetSummary().synced == false)) {\r\n>       |             ^~~~~~~~~~~~~~~~~~\r\n> ```\r\n\r\nAh, that include was a bit late to the party, fixed.",
      "created_at" : "2021-03-16T23:23:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-800677568",
      "id" : 800677568,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMDY3NzU2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-16T23:23:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/800677568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @fjahr! resolved in the latest push; moving forward, `test/functional/feature_coinstatsindex.py` fails at commit 540428a2c7\r\n\r\n<details><summary>test output x 3</summary><p>\r\n\r\n```\r\n((HEAD detached at 540428a2c7))$ src/test/test_bitcoin -t coinstatsindex_tests ; test/functional/feature_coinstatsindex.py\r\nRunning 1 test case...\r\n\r\n*** No errors detected\r\n\r\n2021-03-17T01:07:46.879000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_inxlkokp\r\n2021-03-17T01:07:56.135000Z TestFramework (INFO): Test that gettxoutsetinfo() output is consistent with or without coinstatsindex option\r\n2021-03-17T01:07:56.744000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/test_framework.py\", line 128, in main\r\n    self.run_test()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/feature_coinstatsindex.py\", line 33, in run_test\r\n    self._test_coin_stats_index()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/feature_coinstatsindex.py\", line 62, in _test_coin_stats_index\r\n    assert_equal(res1, res0)\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/util.py\", line 50, in assert_equal\r\n    raise AssertionError(\"not(%s)\" % \" == \".join(str(arg) for arg in (thing1, thing2) + args))\r\nAssertionError: not({'height': 102, 'bestblock': '7471357854133661aaa6d50eba11ec46c3322e299c5b6907885351551005f771', 'txouts': 103, 'bogosize': 7722, 'total_amount': Decimal('5100.00000000'), 'total_unspendable_amount': Decimal('50.00000000'), 'block_info': {'prevout_spent': Decimal('50.00000000'), 'coinbase': Decimal('50.00004440'), 'new_outputs_ex_coinbase': Decimal('49.99995560'), 'unspendable': Decimal('0E-8'), 'unspendables': {'genesis_block': Decimal('0E-8'), 'bip30': Decimal('0E-8'), 'scripts': Decimal('0E-8'), 'unclaimed_rewards': Decimal('0E-8')}}} == {'height': 102, 'bestblock': '7471357854133661aaa6d50eba11ec46c3322e299c5b6907885351551005f771', 'txouts': 103, 'bogosize': 7722, 'total_amount': Decimal('5100.00000000')})\r\n2021-03-17T01:07:56.797000Z TestFramework (INFO): Stopping nodes\r\n2021-03-17T01:07:57.000000Z TestFramework (WARNING): Not cleaning up dir /tmp/bitcoin_func_test_inxlkokp\r\n2021-03-17T01:07:57.000000Z TestFramework (ERROR): Test failed. Test logging available at /tmp/bitcoin_func_test_inxlkokp/test_framework.log\r\n2021-03-17T01:07:57.001000Z TestFramework (ERROR): \r\n2021-03-17T01:07:57.001000Z TestFramework (ERROR): Hint: Call /home/jon/projects/bitcoin/bitcoin/test/functional/combine_logs.py '/tmp/bitcoin_func_test_inxlkokp' to consolidate all logs\r\n2021-03-17T01:07:57.001000Z TestFramework (ERROR): \r\n2021-03-17T01:07:57.001000Z TestFramework (ERROR): If this failure happened unexpectedly or intermittently, please file a bug and provide a link or upload of the combined log.\r\n2021-03-17T01:07:57.001000Z TestFramework (ERROR): https://github.com/bitcoin/bitcoin/issues\r\n2021-03-17T01:07:57.001000Z TestFramework (ERROR): \r\n\r\n\r\n((HEAD detached at 540428a2c7)) $ test/functional/feature_coinstatsindex.py\r\n2021-03-17T01:08:09.775000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_rxs4xbm6\r\n2021-03-17T01:08:20.052000Z TestFramework (INFO): Test that gettxoutsetinfo() output is consistent with or without coinstatsindex option\r\n2021-03-17T01:08:20.215000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/test_framework.py\", line 128, in main\r\n    self.run_test()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/feature_coinstatsindex.py\", line 33, in run_test\r\n    self._test_coin_stats_index()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/feature_coinstatsindex.py\", line 62, in _test_coin_stats_index\r\n    assert_equal(res1, res0)\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/util.py\", line 50, in assert_equal\r\n    raise AssertionError(\"not(%s)\" % \" == \".join(str(arg) for arg in (thing1, thing2) + args))\r\nAssertionError: not({'height': 102, 'bestblock': '591e401cdaae94127f81f00ac25ec95edcdeac17c2031b772c71f92104091293', 'txouts': 103, 'bogosize': 7722, 'total_amount': Decimal('5100.00000000'), 'total_unspendable_amount': Decimal('50.00000000'), 'block_info': {'prevout_spent': Decimal('50.00000000'), 'coinbase': Decimal('50.00004440'), 'new_outputs_ex_coinbase': Decimal('49.99995560'), 'unspendable': Decimal('0E-8'), 'unspendables': {'genesis_block': Decimal('0E-8'), 'bip30': Decimal('0E-8'), 'scripts': Decimal('0E-8'), 'unclaimed_rewards': Decimal('0E-8')}}} == {'height': 102, 'bestblock': '591e401cdaae94127f81f00ac25ec95edcdeac17c2031b772c71f92104091293', 'txouts': 103, 'bogosize': 7722, 'total_amount': Decimal('5100.00000000')})\r\n2021-03-17T01:08:20.267000Z TestFramework (INFO): Stopping nodes\r\n2021-03-17T01:08:20.473000Z TestFramework (WARNING): Not cleaning up dir /tmp/bitcoin_func_test_rxs4xbm6\r\n2021-03-17T01:08:20.473000Z TestFramework (ERROR): Test failed. Test logging available at /tmp/bitcoin_func_test_rxs4xbm6/test_framework.log\r\n2021-03-17T01:08:20.473000Z TestFramework (ERROR): \r\n2021-03-17T01:08:20.474000Z TestFramework (ERROR): Hint: Call /home/jon/projects/bitcoin/bitcoin/test/functional/combine_logs.py '/tmp/bitcoin_func_test_rxs4xbm6' to consolidate all logs\r\n2021-03-17T01:08:20.474000Z TestFramework (ERROR): \r\n2021-03-17T01:08:20.474000Z TestFramework (ERROR): If this failure happened unexpectedly or intermittently, please file a bug and provide a link or upload of the combined log.\r\n2021-03-17T01:08:20.474000Z TestFramework (ERROR): https://github.com/bitcoin/bitcoin/issues\r\n2021-03-17T01:08:20.474000Z TestFramework (ERROR): \r\n\r\n\r\n((HEAD detached at 540428a2c7)) $ test/functional/feature_coinstatsindex.py\r\n2021-03-17T01:08:25.879000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_i2yd6ri_\r\n2021-03-17T01:08:35.297000Z TestFramework (INFO): Test that gettxoutsetinfo() output is consistent with or without coinstatsindex option\r\n2021-03-17T01:08:35.848000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/test_framework.py\", line 128, in main\r\n    self.run_test()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/feature_coinstatsindex.py\", line 33, in run_test\r\n    self._test_coin_stats_index()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/feature_coinstatsindex.py\", line 62, in _test_coin_stats_index\r\n    assert_equal(res1, res0)\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/util.py\", line 50, in assert_equal\r\n    raise AssertionError(\"not(%s)\" % \" == \".join(str(arg) for arg in (thing1, thing2) + args))\r\nAssertionError: not({'height': 102, 'bestblock': '3a98eacc26af554ce719e5f09257a9e8e535ee82fb363c79f4144b0100d26938', 'txouts': 103, 'bogosize': 7722, 'total_amount': Decimal('5100.00000000'), 'total_unspendable_amount': Decimal('50.00000000'), 'block_info': {'prevout_spent': Decimal('50.00000000'), 'coinbase': Decimal('50.00004440'), 'new_outputs_ex_coinbase': Decimal('49.99995560'), 'unspendable': Decimal('0E-8'), 'unspendables': {'genesis_block': Decimal('0E-8'), 'bip30': Decimal('0E-8'), 'scripts': Decimal('0E-8'), 'unclaimed_rewards': Decimal('0E-8')}}} == {'height': 102, 'bestblock': '3a98eacc26af554ce719e5f09257a9e8e535ee82fb363c79f4144b0100d26938', 'txouts': 103, 'bogosize': 7722, 'total_amount': Decimal('5100.00000000')})\r\n2021-03-17T01:08:35.902000Z TestFramework (INFO): Stopping nodes\r\n2021-03-17T01:08:36.111000Z TestFramework (WARNING): Not cleaning up dir /tmp/bitcoin_func_test_i2yd6ri_\r\n2021-03-17T01:08:36.112000Z TestFramework (ERROR): Test failed. Test logging available at /tmp/bitcoin_func_test_i2yd6ri_/test_framework.log\r\n2021-03-17T01:08:36.112000Z TestFramework (ERROR): \r\n2021-03-17T01:08:36.113000Z TestFramework (ERROR): Hint: Call /home/jon/projects/bitcoin/bitcoin/test/functional/combine_logs.py '/tmp/bitcoin_func_test_i2yd6ri_' to consolidate all logs\r\n2021-03-17T01:08:36.113000Z TestFramework (ERROR): \r\n2021-03-17T01:08:36.113000Z TestFramework (ERROR): If this failure happened unexpectedly or intermittently, please file a bug and provide a link or upload of the combined log.\r\n2021-03-17T01:08:36.114000Z TestFramework (ERROR): https://github.com/bitcoin/bitcoin/issues\r\n2021-03-17T01:08:36.114000Z TestFramework (ERROR): \r\n```\r\n</p></details>\r\n",
      "created_at" : "2021-03-17T01:15:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-800719573",
      "id" : 800719573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMDcxOTU3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T01:15:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/800719573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Thanks @fjahr! resolved in the latest push; moving forward, `test/functional/feature_coinstatsindex.py` fails at commit [540428a](https://github.com/bitcoin/bitcoin/commit/540428a2c7d8791b20d81967c3b811cfa7bc613a)\r\n> \r\n> test output x 3\r\n\r\nFixed and quick-checked the following commits. I think that should be the last of those. ð¤ ",
      "created_at" : "2021-03-17T21:38:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-801460423",
      "id" : 801460423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMTQ2MDQyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T21:38:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/801460423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Fixed and quick-checked the following commits. I think that should be the last of those. crossed_fingers\r\n\r\nYup, they check out for me too. Deleted my coinstats index files from last August and re-syncing under adversarial conditions (restarts, very frequent internet cuts) while trying the commands in mainnet, signet and testnet. The reviews by @Sjors are very helpful with ideas of issues to check / things to test.",
      "created_at" : "2021-03-23T11:58:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-804843662",
      "id" : 804843662,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNDg0MzY2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-23T11:58:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/804843662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r599507629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599507629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps provide the best block height so the user doesn't have to call `getindexinfo` to find out. Maybe a bit long, but something like:\r\n\r\nUnable to read the UTXO set beyond the current best block height of 3190, as the coinstatsindex is still syncing.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-23T12:05:42Z",
      "diff_hunk" : "@@ -1087,9 +1156,38 @@ static RPCHelpMan gettxoutsetinfo()\n         if (hash_type == CoinStatsHashType::MUHASH) {\n               ret.pushKV(\"muhash\", stats.hashSerialized.GetHex());\n         }\n-        ret.pushKV(\"disk_size\", stats.nDiskSize);\n         ret.pushKV(\"total_amount\", ValueFromAmount(stats.nTotalAmount));\n+        if (!stats.from_index) {\n+            ret.pushKV(\"transactions\", (int64_t)stats.nTransactions);\n+            ret.pushKV(\"disk_size\", stats.nDiskSize);\n+        } else {\n+            ret.pushKV(\"total_unspendable_amount\", ValueFromAmount(stats.block_unspendable_amount));\n+\n+            CCoinsStats prev_stats{hash_type};\n+\n+            if (pindex->nHeight > 0) {\n+                GetUTXOStats(coins_view, WITH_LOCK(::cs_main, return std::ref(g_chainman.m_blockman)), prev_stats, node.rpc_interruption_point, pindex->pprev);\n+            }\n+\n+            UniValue block_info(UniValue::VOBJ);\n+            block_info.pushKV(\"prevout_spent\", ValueFromAmount(stats.block_prevout_spent_amount - prev_stats.block_prevout_spent_amount));\n+            block_info.pushKV(\"coinbase\", ValueFromAmount(stats.block_coinbase_amount - prev_stats.block_coinbase_amount));\n+            block_info.pushKV(\"new_outputs_ex_coinbase\", ValueFromAmount(stats.block_new_outputs_ex_coinbase_amount - prev_stats.block_new_outputs_ex_coinbase_amount));\n+            block_info.pushKV(\"unspendable\", ValueFromAmount(stats.block_unspendable_amount - prev_stats.block_unspendable_amount));\n+\n+            UniValue unspendables(UniValue::VOBJ);\n+            unspendables.pushKV(\"genesis_block\", ValueFromAmount(stats.unspendables_genesis_block - prev_stats.unspendables_genesis_block));\n+            unspendables.pushKV(\"bip30\", ValueFromAmount(stats.unspendables_bip30 - prev_stats.unspendables_bip30));\n+            unspendables.pushKV(\"scripts\", ValueFromAmount(stats.unspendables_scripts - prev_stats.unspendables_scripts));\n+            unspendables.pushKV(\"unclaimed_rewards\", ValueFromAmount(stats.unspendables_unclaimed_rewards - prev_stats.unspendables_unclaimed_rewards));\n+            block_info.pushKV(\"unspendables\", unspendables);\n+\n+            ret.pushKV(\"block_info\", block_info);\n+        }\n     } else {\n+        if (g_coin_stats_index && (g_coin_stats_index->GetSummary().synced == false)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set. Coinstatsindex is still syncing.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r599507629",
      "id" : 599507629,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTUwNzYyOQ==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 1189,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 618507858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599507629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r599606214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599606214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9d4c991 if you retouch, it would be nice to provide some context in the commit message, point to a discussion or benchmark, etc.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-23T14:13:41Z",
      "diff_hunk" : "@@ -341,6 +341,6 @@ MuHash3072& MuHash3072::Insert(Span<const unsigned char> in) noexcept {\n }\n \n MuHash3072& MuHash3072::Remove(Span<const unsigned char> in) noexcept {\n-    m_numerator.Divide(ToNum3072(in));\n+    m_denominator.Multiply(ToNum3072(in));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r599606214",
      "id" : 599606214,
      "line" : 344,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTYwNjIxNA==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 344,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/crypto/muhash.cpp",
      "position" : 5,
      "pull_request_review_id" : 618507858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599606214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r599652604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599652604"
         }
      },
      "author_association" : "MEMBER",
      "body" : "31d0b7f7 could make the same change here as in `validation.cpp:L5421` in the same commit (or vice-versa)\r\n\r\nTwo possible simplifications:\r\n\r\na) pass the argument in the tests, drop unneeded ctor that is currently only used for tests\r\n```diff\r\nsrc/node/coinstats.h\r\n@@ -56,7 +56,6 @@ struct CCoinsStats \r\n     CCoinsStats(CoinStatsHashType hash_type) : m_hash_type(hash_type) {}\r\n-    CCoinsStats() : m_hash_type(CoinStatsHashType::HASH_SERIALIZED) {}\r\n \r\nsrc/test/coinstatsindex_tests.cpp\r\n@@ -14,7 +14,7 @@ BOOST_FIXTURE_TEST_CASE(coinstatsindex_initial_sync, TestChain100Setup)\r\n { \r\n-    CCoinsStats coin_stats;\r\n+    CCoinsStats coin_stats{CoinStatsHashType::HASH_SERIALIZED};\r\n     const CBlockIndex* block_index;\r\n@@ -57,7 +57,7 @@ BOOST_FIXTURE_TEST_CASE(coinstatsindex_initial_sync, TestChain100Setup)\r\n \r\n-    CCoinsStats new_coin_stats;\r\n+    CCoinsStats new_coin_stats{CoinStatsHashType::HASH_SERIALIZED};\r\n     const CBlockIndex* new_block_index;\r\n\r\nsrc/test/fuzz/coins_view.cpp\r\n@@ -261,7 +261,7 @@ FUZZ_TARGET_INIT(coins_view, initialize_coins_view)\r\n-                CCoinsStats stats;\r\n+                CCoinsStats stats{CoinStatsHashType::HASH_SERIALIZED};\r\n                 bool expected_code_path = false;\r\n```\r\nb) use the default member initializer as the general default, overridden by the specific one in ctor member initializer list\r\n```diff\r\nsrc/node/coinstats.h\r\n@@ -26,7 +26,7 @@ enum class CoinStatsHashType { \r\n struct CCoinsStats\r\n {\r\n-    CoinStatsHashType m_hash_type;\r\n+    CoinStatsHashType m_hash_type{CoinStatsHashType::HASH_SERIALIZED};\r\n@@ -56,7 +56,7 @@ struct CCoinsStats \r\n-    CCoinsStats() : m_hash_type(CoinStatsHashType::HASH_SERIALIZED) {}\r\n+    CCoinsStats() {}\r\n };\r\n\r\nsrc/validation.cpp\r\n@@ -5418,7 +5418,7 @@ bool ChainstateManager::PopulateAndValidateSnapshot( \r\n-    CCoinsStats stats{CoinStatsHashType::HASH_SERIALIZED};\r\n+    CCoinsStats stats;\r\n```\r\n",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-23T15:01:30Z",
      "diff_hunk" : "@@ -264,7 +264,7 @@ FUZZ_TARGET_INIT(coins_view, initialize_coins_view)\n                 CCoinsStats stats;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r599652604",
      "id" : 599652604,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTY1MjYwNA==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 261,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : null,
      "pull_request_review_id" : 618507858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599652604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-24T07:36:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-805575349",
      "id" : 805575349,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNTU3NTM0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-24T07:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/805575349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r602524356"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602524356"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It would be nice indeed to avoid adding a circular dependency.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-26T18:56:52Z",
      "diff_hunk" : "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/coinstatsindex -> node/coinstats -> index/coinstatsindex\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r602524356",
      "id" : 602524356,
      "in_reply_to_id" : 500651118,
      "line" : 17,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjUyNDM1Ng==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 17,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 618507858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602524356",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "WIP review update: re-reviewed e880a5e and 435ed5b, added more suggestions in separate annotated commits in the branch at https://github.com/jonatack/bitcoin/commits/pr19521-review. I'll update this comment with progress.\r\n\r\n- https://github.com/jonatack/bitcoin/commit/e9262d2b38ebfe134b42e44ff3b88cfb89f744cc : *PR19521 suggestions, commit e880a5e \"Add Coinstats index\"*\r\n- https://github.com/jonatack/bitcoin/commit/d4fb34de51a3d21ae68e8331822020e6fc2f06e6 : *PR19521 suggestions, commit 435ed5b \"Coinstats index can be activated with command line flag\"*\r\n",
      "created_at" : "2021-03-27T12:45:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-808727448",
      "id" : 808727448,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODcyNzQ0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-27T12:48:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808727448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Review update: reviewed up to 590b887 and added suggestions in separate annotated commits in the branch at https://github.com/jonatack/bitcoin/commits/pr19521-review\r\n\r\n- https://github.com/jonatack/bitcoin/commit/e9262d2b38ebfe134b42e44ff3b88cfb89f744cc : \"PR19521 suggestions, commit e880a5e *Add Coinstats index\"*\r\n- https://github.com/jonatack/bitcoin/commit/d4fb34de51a3d21ae68e8331822020e6fc2f06e6 : \"PR19521 suggestions, commit 435ed5b *Coinstats index can be activated with command line flag\"*\r\n- https://github.com/jonatack/bitcoin/commit/452a4fb5c03c024d4e98a38ef3806f921888d641 : \"PR19521 suggestions, commit 6aedd7b *gettxoutsetinfo can be requested for specific blockheights*\"\r\n- https://github.com/jonatack/bitcoin/commit/f6ebc75c78442cf0fde8c4330ebdda32a426c1a3 : \"PR19521 suggestions, commit dc26799 *Add unit test for Coinstats index*\" (among other things updated the tests to use std::chrono)\r\n- https://github.com/jonatack/bitcoin/commit/ae3d058394ad0268f491b240372e76b0a0457719 : \"PR19521 suggestions, commit 590b887 *Add verbose amounts tracking to Coinstats index*\"",
      "created_at" : "2021-03-27T18:57:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-808786709",
      "id" : 808786709,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODc4NjcwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-27T21:17:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808786709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Here is a test commit you can pull in, if you like, to add coverage for c3cfc509 *Add Coinstats index to getindexinfo*\r\n\r\nhttps://github.com/jonatack/bitcoin/commits/pr19521-coinstatsindex-getindexinfo-test-coverage",
      "created_at" : "2021-03-27T18:58:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-808786833",
      "id" : 808786833,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODc4NjgzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-27T18:58:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808786833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r602784581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602784581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "590b887de0b5f6cb ISTM this line should be added in 6aedd7bb05  where the `hash_or_height` param is added",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-27T19:47:05Z",
      "diff_hunk" : "@@ -123,6 +123,7 @@ static const CRPCConvertParam vRPCConvertParams[] =\n     { \"gettxout\", 1, \"n\" },\n     { \"gettxout\", 2, \"include_mempool\" },\n     { \"gettxoutproof\", 0, \"txids\" },\n+    { \"gettxoutsetinfo\", 1, \"hash_or_height\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r602784581",
      "id" : 602784581,
      "in_reply_to_id" : 502335126,
      "line" : 130,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjc4NDU4MQ==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 130,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/client.cpp",
      "position" : 4,
      "pull_request_review_id" : 622697217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602784581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r602785206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602785206"
         }
      },
      "author_association" : "MEMBER",
      "body" : "590b887de0b5f6cb didn't look deeply but does there need to be an equivalent inverse of this BIP30 duplicate transactions code in `CoinStatsIndex::ReverseBlock()`?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-27T19:52:49Z",
      "diff_hunk" : "@@ -0,0 +1,480 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r602785206",
      "id" : 602785206,
      "line" : 143,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjc4NTIwNg==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 143,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 143,
      "pull_request_review_id" : 622697634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602785206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r602930964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602930964"
         }
      },
      "author_association" : "NONE",
      "body" : "Just a follow-up suggestion.\r\nIt adds the current Coinstatsindex height in the error message, so the the user can see the progress of the synchronization.\r\n\r\n```\r\nUnable to read UTXO set. Coinstatsindex is still syncing. Current height: 77329\r\nUnable to read UTXO set. Coinstatsindex is still syncing. Current height: 86827\r\n```\r\n\r\n```suggestion\r\n            throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set. Coinstatsindex is still syncing. Current height: \" + \r\n                std::to_string(g_coin_stats_index->GetSummary().best_block_height));\r\n```",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-28T20:52:36Z",
      "diff_hunk" : "@@ -1087,9 +1156,38 @@ static RPCHelpMan gettxoutsetinfo()\n         if (hash_type == CoinStatsHashType::MUHASH) {\n               ret.pushKV(\"muhash\", stats.hashSerialized.GetHex());\n         }\n-        ret.pushKV(\"disk_size\", stats.nDiskSize);\n         ret.pushKV(\"total_amount\", ValueFromAmount(stats.nTotalAmount));\n+        if (!stats.from_index) {\n+            ret.pushKV(\"transactions\", (int64_t)stats.nTransactions);\n+            ret.pushKV(\"disk_size\", stats.nDiskSize);\n+        } else {\n+            ret.pushKV(\"total_unspendable_amount\", ValueFromAmount(stats.block_unspendable_amount));\n+\n+            CCoinsStats prev_stats{hash_type};\n+\n+            if (pindex->nHeight > 0) {\n+                GetUTXOStats(coins_view, WITH_LOCK(::cs_main, return std::ref(g_chainman.m_blockman)), prev_stats, node.rpc_interruption_point, pindex->pprev);\n+            }\n+\n+            UniValue block_info(UniValue::VOBJ);\n+            block_info.pushKV(\"prevout_spent\", ValueFromAmount(stats.block_prevout_spent_amount - prev_stats.block_prevout_spent_amount));\n+            block_info.pushKV(\"coinbase\", ValueFromAmount(stats.block_coinbase_amount - prev_stats.block_coinbase_amount));\n+            block_info.pushKV(\"new_outputs_ex_coinbase\", ValueFromAmount(stats.block_new_outputs_ex_coinbase_amount - prev_stats.block_new_outputs_ex_coinbase_amount));\n+            block_info.pushKV(\"unspendable\", ValueFromAmount(stats.block_unspendable_amount - prev_stats.block_unspendable_amount));\n+\n+            UniValue unspendables(UniValue::VOBJ);\n+            unspendables.pushKV(\"genesis_block\", ValueFromAmount(stats.unspendables_genesis_block - prev_stats.unspendables_genesis_block));\n+            unspendables.pushKV(\"bip30\", ValueFromAmount(stats.unspendables_bip30 - prev_stats.unspendables_bip30));\n+            unspendables.pushKV(\"scripts\", ValueFromAmount(stats.unspendables_scripts - prev_stats.unspendables_scripts));\n+            unspendables.pushKV(\"unclaimed_rewards\", ValueFromAmount(stats.unspendables_unclaimed_rewards - prev_stats.unspendables_unclaimed_rewards));\n+            block_info.pushKV(\"unspendables\", unspendables);\n+\n+            ret.pushKV(\"block_info\", block_info);\n+        }\n     } else {\n+        if (g_coin_stats_index && (g_coin_stats_index->GetSummary().synced == false)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set. Coinstatsindex is still syncing.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r602930964",
      "id" : 602930964,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjkzMDk2NA==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 1189,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 622782022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602930964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2694753?v=4",
         "events_url" : "https://api.github.com/users/leonardojobim/events{/privacy}",
         "followers_url" : "https://api.github.com/users/leonardojobim/followers",
         "following_url" : "https://api.github.com/users/leonardojobim/following{/other_user}",
         "gists_url" : "https://api.github.com/users/leonardojobim/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/leonardojobim",
         "id" : 2694753,
         "login" : "leonardojobim",
         "node_id" : "MDQ6VXNlcjI2OTQ3NTM=",
         "organizations_url" : "https://api.github.com/users/leonardojobim/orgs",
         "received_events_url" : "https://api.github.com/users/leonardojobim/received_events",
         "repos_url" : "https://api.github.com/users/leonardojobim/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/leonardojobim/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/leonardojobim/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/leonardojobim"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Approach ACK. I finished this pass of reviewing and have pushed annotated comments/fixes/suggestions, per-commit, in https://github.com/jonatack/bitcoin/commits/pr19521-review (with a few initial comments in the first commit and in my comments here above).",
      "created_at" : "2021-03-29T16:17:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-809516409",
      "id" : 809516409,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTUxNjQwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-29T16:17:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809516409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603605338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603605338"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 435ed5ba6589bf8391c3374ebf74bafed5f13237 \"index: Coinstats index can be activated with command line flag\"\r\n\r\nThis is an unrelated move. It isn't necessary to have all of the arguments in alphabetical order, the formatter for output will do that automatically.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-29T20:52:12Z",
      "diff_hunk" : "@@ -393,6 +401,11 @@ void SetupServerArgs(NodeContext& node)\n #endif\n     argsman.AddArg(\"-blockreconstructionextratxn=<n>\", strprintf(\"Extra transactions to keep in memory for compact block reconstructions (default: %u)\", DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-blocksonly\", strprintf(\"Whether to reject transactions from network peers. Automatic broadcast and rebroadcast of any transactions from inbound peers is disabled, unless the peer has the 'forcerelay' permission. RPC transactions are not affected. (default: %u)\", DEFAULT_BLOCKSONLY), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-blockfilterindex=<type>\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603605338",
      "id" : 603605338,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzYwNTMzOA==",
      "original_commit_id" : "435ed5ba6589bf8391c3374ebf74bafed5f13237",
      "original_line" : 404,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 623631847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603605338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603606325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603606325"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 435ed5ba6589bf8391c3374ebf74bafed5f13237 \"index: Coinstats index can be activated with command line flag\"\r\n\r\nThis comment is incorrect. The block filter index is not disallowed when pruning is enabled.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-29T20:53:56Z",
      "diff_hunk" : "@@ -1034,10 +1043,12 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         nLocalServices = ServiceFlags(nLocalServices | NODE_COMPACT_FILTERS);\n     }\n \n-    // if using block pruning, then disallow txindex\n+    // if using block pruning, then disallow txindex, coinstatsindex and blockfilterindex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603606325",
      "id" : 603606325,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzYwNjMyNQ==",
      "original_commit_id" : "435ed5ba6589bf8391c3374ebf74bafed5f13237",
      "original_line" : 1046,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 623631847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603606325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603607663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603607663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it is necessary to disallow the coin stats index when pruning is enabled. The only reason that txindex disallows it is because txindex gets the transaction data by reading it off disk from the block files, so that is incompatible with pruning.\r\n\r\nThe coin stats index doesn't have the same problem. The only issue would be if there were a large reorg and it needed the undo data that has already been deleted. However this is an issue overall of pruned nodes so it shouldn't be a concern for the coin stats index.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-29T20:56:08Z",
      "diff_hunk" : "@@ -1003,10 +1012,12 @@ bool AppInitParameterInteraction()\n         return InitError(_(\"Cannot set -peerblockfilters without -blockfilterindex.\"));\n     }\n \n-    // if using block pruning, then disallow txindex\n+    // if using block pruning, then disallow txindex, coinstatsindex and blockfilterindex\n     if (gArgs.GetArg(\"-prune\", 0)) {\n         if (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX))\n             return InitError(_(\"Prune mode is incompatible with -txindex.\"));\n+        if (gArgs.GetBoolArg(\"-coinstatsindex\", DEFAULT_COINSTATSINDEX))\n+            return InitError(_(\"Prune mode is incompatible with -coinstatsindex.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603607663",
      "id" : 603607663,
      "in_reply_to_id" : 463328440,
      "line" : 964,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzYwNzY2Mw==",
      "original_commit_id" : "0269ff80aa936a226f5c41b7e06b49caa88e82e4",
      "original_line" : 964,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 56,
      "pull_request_review_id" : 623631847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603607663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603608582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603608582"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 435ed5ba6589bf8391c3374ebf74bafed5f13237 \"index: Coinstats index can be activated with command line flag\"\r\n\r\n`hash_type muhash` is also allowed.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-29T20:57:35Z",
      "diff_hunk" : "@@ -91,12 +92,20 @@ static bool GetUTXOStats(CCoinsView* view, BlockManager& blockman, CCoinsStats&\n {\n     std::unique_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n     assert(pcursor);\n-\n     stats.hashBlock = pcursor->GetBestBlock();\n+\n+    const CBlockIndex* pindex;\n     {\n         LOCK(cs_main);\n         assert(std::addressof(g_chainman.m_blockman) == std::addressof(blockman));\n-        stats.nHeight = blockman.LookupBlockIndex(stats.hashBlock)->nHeight;\n+        pindex = blockman.LookupBlockIndex(stats.hashBlock);\n+    }\n+\n+    stats.nHeight = pindex->nHeight;\n+\n+    // Use CoinStatsIndex if it is available and hash_type none was requested",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603608582",
      "id" : 603608582,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzYwODU4Mg==",
      "original_commit_id" : "435ed5ba6589bf8391c3374ebf74bafed5f13237",
      "original_line" : 106,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/coinstats.cpp",
      "position" : null,
      "pull_request_review_id" : 623631847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603608582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603616976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603616976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In e880a5e95b999369bc277ed4d0ecbf0eaa758e88 \"index: Add Coinstats index\"\r\n\r\nThis would be easier to read as `if (!tx->IsCoinbase())`",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-29T21:12:28Z",
      "diff_hunk" : "@@ -0,0 +1,372 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+                COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603616976",
      "id" : 603616976,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzYxNjk3Ng==",
      "original_commit_id" : "e880a5e95b999369bc277ed4d0ecbf0eaa758e88",
      "original_line" : 139,
      "original_position" : 139,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 623631847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603616976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603624171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603624171"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agree, made a similar comment here: https://github.com/jonatack/bitcoin/commit/d4fb34de51a3d21ae68e8331822020e6fc2f06e6#r48780818",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-29T21:25:35Z",
      "diff_hunk" : "@@ -91,12 +92,20 @@ static bool GetUTXOStats(CCoinsView* view, BlockManager& blockman, CCoinsStats&\n {\n     std::unique_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n     assert(pcursor);\n-\n     stats.hashBlock = pcursor->GetBestBlock();\n+\n+    const CBlockIndex* pindex;\n     {\n         LOCK(cs_main);\n         assert(std::addressof(g_chainman.m_blockman) == std::addressof(blockman));\n-        stats.nHeight = blockman.LookupBlockIndex(stats.hashBlock)->nHeight;\n+        pindex = blockman.LookupBlockIndex(stats.hashBlock);\n+    }\n+\n+    stats.nHeight = pindex->nHeight;\n+\n+    // Use CoinStatsIndex if it is available and hash_type none was requested",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603624171",
      "id" : 603624171,
      "in_reply_to_id" : 603608582,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzYyNDE3MQ==",
      "original_commit_id" : "435ed5ba6589bf8391c3374ebf74bafed5f13237",
      "original_line" : 106,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/coinstats.cpp",
      "position" : null,
      "pull_request_review_id" : 623663651,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603624171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603624618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603624618"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree: https://github.com/jonatack/bitcoin/commit/d4fb34de51a3d21ae68e8331822020e6fc2f06e6#r48780784",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-03-29T21:26:30Z",
      "diff_hunk" : "@@ -1034,10 +1043,12 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         nLocalServices = ServiceFlags(nLocalServices | NODE_COMPACT_FILTERS);\n     }\n \n-    // if using block pruning, then disallow txindex\n+    // if using block pruning, then disallow txindex, coinstatsindex and blockfilterindex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r603624618",
      "id" : 603624618,
      "in_reply_to_id" : 603606325,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzYyNDYxOA==",
      "original_commit_id" : "435ed5ba6589bf8391c3374ebf74bafed5f13237",
      "original_line" : 1046,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 623664266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603624618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374124"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-05T22:38:15Z",
      "diff_hunk" : "@@ -0,0 +1,372 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out = tx->vout[j];\n+                Coin coin = Coin(out, pindex->nHeight, tx->IsCoinBase());\n+                COutPoint outpoint = COutPoint(tx->GetHash(), j);\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) continue;\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                m_transaction_output_count++;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (i > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374124",
      "id" : 607374124,
      "in_reply_to_id" : 603616976,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzM3NDEyNA==",
      "original_commit_id" : "e880a5e95b999369bc277ed4d0ecbf0eaa758e88",
      "original_line" : 139,
      "original_position" : 139,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : null,
      "pull_request_review_id" : 628212428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374153"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-05T22:38:20Z",
      "diff_hunk" : "@@ -91,12 +92,20 @@ static bool GetUTXOStats(CCoinsView* view, BlockManager& blockman, CCoinsStats&\n {\n     std::unique_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n     assert(pcursor);\n-\n     stats.hashBlock = pcursor->GetBestBlock();\n+\n+    const CBlockIndex* pindex;\n     {\n         LOCK(cs_main);\n         assert(std::addressof(g_chainman.m_blockman) == std::addressof(blockman));\n-        stats.nHeight = blockman.LookupBlockIndex(stats.hashBlock)->nHeight;\n+        pindex = blockman.LookupBlockIndex(stats.hashBlock);\n+    }\n+\n+    stats.nHeight = pindex->nHeight;\n+\n+    // Use CoinStatsIndex if it is available and hash_type none was requested",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374153",
      "id" : 607374153,
      "in_reply_to_id" : 603608582,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzM3NDE1Mw==",
      "original_commit_id" : "435ed5ba6589bf8391c3374ebf74bafed5f13237",
      "original_line" : 106,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/coinstats.cpp",
      "position" : null,
      "pull_request_review_id" : 628212455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374219"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It was when I first wrote that commit ;) fixed",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-05T22:38:31Z",
      "diff_hunk" : "@@ -1034,10 +1043,12 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         nLocalServices = ServiceFlags(nLocalServices | NODE_COMPACT_FILTERS);\n     }\n \n-    // if using block pruning, then disallow txindex\n+    // if using block pruning, then disallow txindex, coinstatsindex and blockfilterindex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374219",
      "id" : 607374219,
      "in_reply_to_id" : 603606325,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzM3NDIxOQ==",
      "original_commit_id" : "435ed5ba6589bf8391c3374ebf74bafed5f13237",
      "original_line" : 1046,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 628212542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374254"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Undone",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-05T22:38:38Z",
      "diff_hunk" : "@@ -393,6 +401,11 @@ void SetupServerArgs(NodeContext& node)\n #endif\n     argsman.AddArg(\"-blockreconstructionextratxn=<n>\", strprintf(\"Extra transactions to keep in memory for compact block reconstructions (default: %u)\", DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-blocksonly\", strprintf(\"Whether to reject transactions from network peers. Automatic broadcast and rebroadcast of any transactions from inbound peers is disabled, unless the peer has the 'forcerelay' permission. RPC transactions are not affected. (default: %u)\", DEFAULT_BLOCKSONLY), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-blockfilterindex=<type>\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374254",
      "id" : 607374254,
      "in_reply_to_id" : 603605338,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzM3NDI1NA==",
      "original_commit_id" : "435ed5ba6589bf8391c3374ebf74bafed5f13237",
      "original_line" : 404,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 628212583,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374299"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, I added this with some tweaks.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-05T22:38:45Z",
      "diff_hunk" : "@@ -1087,9 +1156,38 @@ static RPCHelpMan gettxoutsetinfo()\n         if (hash_type == CoinStatsHashType::MUHASH) {\n               ret.pushKV(\"muhash\", stats.hashSerialized.GetHex());\n         }\n-        ret.pushKV(\"disk_size\", stats.nDiskSize);\n         ret.pushKV(\"total_amount\", ValueFromAmount(stats.nTotalAmount));\n+        if (!stats.from_index) {\n+            ret.pushKV(\"transactions\", (int64_t)stats.nTransactions);\n+            ret.pushKV(\"disk_size\", stats.nDiskSize);\n+        } else {\n+            ret.pushKV(\"total_unspendable_amount\", ValueFromAmount(stats.block_unspendable_amount));\n+\n+            CCoinsStats prev_stats{hash_type};\n+\n+            if (pindex->nHeight > 0) {\n+                GetUTXOStats(coins_view, WITH_LOCK(::cs_main, return std::ref(g_chainman.m_blockman)), prev_stats, node.rpc_interruption_point, pindex->pprev);\n+            }\n+\n+            UniValue block_info(UniValue::VOBJ);\n+            block_info.pushKV(\"prevout_spent\", ValueFromAmount(stats.block_prevout_spent_amount - prev_stats.block_prevout_spent_amount));\n+            block_info.pushKV(\"coinbase\", ValueFromAmount(stats.block_coinbase_amount - prev_stats.block_coinbase_amount));\n+            block_info.pushKV(\"new_outputs_ex_coinbase\", ValueFromAmount(stats.block_new_outputs_ex_coinbase_amount - prev_stats.block_new_outputs_ex_coinbase_amount));\n+            block_info.pushKV(\"unspendable\", ValueFromAmount(stats.block_unspendable_amount - prev_stats.block_unspendable_amount));\n+\n+            UniValue unspendables(UniValue::VOBJ);\n+            unspendables.pushKV(\"genesis_block\", ValueFromAmount(stats.unspendables_genesis_block - prev_stats.unspendables_genesis_block));\n+            unspendables.pushKV(\"bip30\", ValueFromAmount(stats.unspendables_bip30 - prev_stats.unspendables_bip30));\n+            unspendables.pushKV(\"scripts\", ValueFromAmount(stats.unspendables_scripts - prev_stats.unspendables_scripts));\n+            unspendables.pushKV(\"unclaimed_rewards\", ValueFromAmount(stats.unspendables_unclaimed_rewards - prev_stats.unspendables_unclaimed_rewards));\n+            block_info.pushKV(\"unspendables\", unspendables);\n+\n+            ret.pushKV(\"block_info\", block_info);\n+        }\n     } else {\n+        if (g_coin_stats_index && (g_coin_stats_index->GetSummary().synced == false)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set. Coinstatsindex is still syncing.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374299",
      "id" : 607374299,
      "in_reply_to_id" : 602930964,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzM3NDI5OQ==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 1189,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 628212650,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374334"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, only if we would expect to reorg this deep :)",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-05T22:38:53Z",
      "diff_hunk" : "@@ -0,0 +1,480 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374334",
      "id" : 607374334,
      "in_reply_to_id" : 602785206,
      "line" : 143,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzM3NDMzNA==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 143,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 143,
      "pull_request_review_id" : 628212696,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374536"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-05T22:39:21Z",
      "diff_hunk" : "@@ -1087,9 +1156,38 @@ static RPCHelpMan gettxoutsetinfo()\n         if (hash_type == CoinStatsHashType::MUHASH) {\n               ret.pushKV(\"muhash\", stats.hashSerialized.GetHex());\n         }\n-        ret.pushKV(\"disk_size\", stats.nDiskSize);\n         ret.pushKV(\"total_amount\", ValueFromAmount(stats.nTotalAmount));\n+        if (!stats.from_index) {\n+            ret.pushKV(\"transactions\", (int64_t)stats.nTransactions);\n+            ret.pushKV(\"disk_size\", stats.nDiskSize);\n+        } else {\n+            ret.pushKV(\"total_unspendable_amount\", ValueFromAmount(stats.block_unspendable_amount));\n+\n+            CCoinsStats prev_stats{hash_type};\n+\n+            if (pindex->nHeight > 0) {\n+                GetUTXOStats(coins_view, WITH_LOCK(::cs_main, return std::ref(g_chainman.m_blockman)), prev_stats, node.rpc_interruption_point, pindex->pprev);\n+            }\n+\n+            UniValue block_info(UniValue::VOBJ);\n+            block_info.pushKV(\"prevout_spent\", ValueFromAmount(stats.block_prevout_spent_amount - prev_stats.block_prevout_spent_amount));\n+            block_info.pushKV(\"coinbase\", ValueFromAmount(stats.block_coinbase_amount - prev_stats.block_coinbase_amount));\n+            block_info.pushKV(\"new_outputs_ex_coinbase\", ValueFromAmount(stats.block_new_outputs_ex_coinbase_amount - prev_stats.block_new_outputs_ex_coinbase_amount));\n+            block_info.pushKV(\"unspendable\", ValueFromAmount(stats.block_unspendable_amount - prev_stats.block_unspendable_amount));\n+\n+            UniValue unspendables(UniValue::VOBJ);\n+            unspendables.pushKV(\"genesis_block\", ValueFromAmount(stats.unspendables_genesis_block - prev_stats.unspendables_genesis_block));\n+            unspendables.pushKV(\"bip30\", ValueFromAmount(stats.unspendables_bip30 - prev_stats.unspendables_bip30));\n+            unspendables.pushKV(\"scripts\", ValueFromAmount(stats.unspendables_scripts - prev_stats.unspendables_scripts));\n+            unspendables.pushKV(\"unclaimed_rewards\", ValueFromAmount(stats.unspendables_unclaimed_rewards - prev_stats.unspendables_unclaimed_rewards));\n+            block_info.pushKV(\"unspendables\", unspendables);\n+\n+            ret.pushKV(\"block_info\", block_info);\n+        }\n     } else {\n+        if (g_coin_stats_index && (g_coin_stats_index->GetSummary().synced == false)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set. Coinstatsindex is still syncing.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607374536",
      "id" : 607374536,
      "in_reply_to_id" : 599507629,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzM3NDUzNg==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 1189,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 628212884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607374536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607685333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607685333"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Which (also) can't happen because of the checkpoint at height 295,000.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T09:20:13Z",
      "diff_hunk" : "@@ -0,0 +1,480 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+constexpr char DB_BLOCK_HASH = 's';\n+constexpr char DB_BLOCK_HEIGHT = 't';\n+constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template<typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix = ser_readdata8(s);\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix = DB_BLOCK_HASH;\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coin stats index DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path = GetDataDir() / \"indexes\" / \"coinstats\";\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash = pindex->pprev->GetBlockHash();\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block = (pindex->nHeight==91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                              (pindex->nHeight==91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"));\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx = block.vtx.at(i);\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607685333",
      "id" : 607685333,
      "in_reply_to_id" : 602785206,
      "line" : 143,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzY4NTMzMw==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 143,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 143,
      "pull_request_review_id" : 628753736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607685333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-tACK 5860532c4041bc3f90fc1f8919f56b6f3955ae9f\r\n\r\nMuhash at height 677990: c49dc3e5ab445812a3eeb8460aa169b4b8900fe8e8c70b328bb7fa0edb0d4690",
      "created_at" : "2021-04-06T09:20:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-813969320",
      "id" : 813969320,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMzk2OTMyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-06T09:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/813969320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607823680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607823680"
         }
      },
      "author_association" : "MEMBER",
      "body" : "5b683ab suggest adding a comment here, as this is quite far away from the parent `if`\r\n```diff\r\n     } else {\r\n+        // genesis block\r\n         m_block_unspendable_amount += block_subsidy;\r\n         m_unspendables_genesis_block += block_subsidy;\r\n```",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T12:56:13Z",
      "diff_hunk" : "@@ -0,0 +1,470 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block{(pindex->nHeight == 91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                            (pindex->nHeight == 91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"))};\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx.at(i)};\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out{tx->vout[j]};\n+                Coin coin{out, pindex->nHeight, tx->IsCoinBase()};\n+                COutPoint outpoint{tx->GetHash(), static_cast<uint32_t>(j)};\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_block_unspendable_amount += coin.out.nValue;\n+                    m_unspendables_scripts += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                if (tx->IsCoinBase()) {\n+                    m_block_coinbase_amount += coin.out.nValue;\n+                } else {\n+                    m_block_new_outputs_ex_coinbase_amount += coin.out.nValue;\n+                }\n+\n+                ++m_transaction_output_count;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (!tx->IsCoinBase()) {\n+                const auto& tx_undo{block_undo.vtxundo.at(i - 1)};\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin{tx_undo.vprevout[j]};\n+                    COutPoint outpoint{tx->vin[j].prevout.hash, tx->vin[j].prevout.n};\n+\n+                    m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                    m_block_prevout_spent_amount += coin.out.nValue;\n+\n+                    --m_transaction_output_count;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    } else {\n+        m_block_unspendable_amount += block_subsidy;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607823680",
      "id" : 607823680,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzgyMzY4MA==",
      "original_commit_id" : "5860532c4041bc3f90fc1f8919f56b6f3955ae9f",
      "original_line" : 191,
      "original_position" : 189,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 191,
      "pull_request_review_id" : 628935807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607823680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607846449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607846449"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7287e76f28\r\n\r\n- what does this mean: \"Use Coinstatsindex even when it is available.\" ... I am `#notsurehere` but maybe it is supposed to say:\r\n```suggestion\r\n                    {\"use_index\", RPCArg::Type::BOOL, /* default */ \"true\", \"Use coinstatsindex, if available\"},\r\n```\r\n\r\n- s/Coinstatsindex/coinstatsindex/ for consistency\r\n\r\n- drop full stops for consistency\r\n",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T13:25:54Z",
      "diff_hunk" : "@@ -1043,42 +1070,84 @@ static RPCHelpMan gettxoutsetinfo()\n {\n     return RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n-                    {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\n+                    {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n+                    {\"use_index\", RPCArg::Type::BOOL, /* default */ \"true\", \"Use Coinstatsindex even when it is available.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607846449",
      "id" : 607846449,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzg0NjQ0OQ==",
      "original_commit_id" : "5860532c4041bc3f90fc1f8919f56b6f3955ae9f",
      "original_line" : 1077,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 628935807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607846449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607877856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607877856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "13d2fc63ac\r\n\r\nVerified this new error message (thanks for improving this):\r\n```\r\n$ bitcoin-cli -signet gettxoutsetinfo muhash 32353\r\nerror code: -32603\r\nerror message:\r\nUnable to read UTXO set. coinstatsindex is still syncing. Current height: 31025\r\n```\r\n\r\nsuggestion, as \"coinstatsindex\" after a full stop looks a little odd:\r\n```suggestion\r\n                throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to read UTXO set because coinstatsindex is still syncing. Current height: %d\", summary.best_block_height));\r\n```",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T14:02:19Z",
      "diff_hunk" : "@@ -1087,9 +1156,42 @@ static RPCHelpMan gettxoutsetinfo()\n         if (hash_type == CoinStatsHashType::MUHASH) {\n               ret.pushKV(\"muhash\", stats.hashSerialized.GetHex());\n         }\n-        ret.pushKV(\"disk_size\", stats.nDiskSize);\n         ret.pushKV(\"total_amount\", ValueFromAmount(stats.nTotalAmount));\n+        if (!stats.index_used) {\n+            ret.pushKV(\"transactions\", static_cast<int64_t>(stats.nTransactions));\n+            ret.pushKV(\"disk_size\", stats.nDiskSize);\n+        } else {\n+            ret.pushKV(\"total_unspendable_amount\", ValueFromAmount(stats.block_unspendable_amount));\n+\n+            CCoinsStats prev_stats{hash_type};\n+\n+            if (pindex->nHeight > 0) {\n+                GetUTXOStats(coins_view, WITH_LOCK(::cs_main, return std::ref(g_chainman.m_blockman)), prev_stats, node.rpc_interruption_point, pindex->pprev);\n+            }\n+\n+            UniValue block_info(UniValue::VOBJ);\n+            block_info.pushKV(\"prevout_spent\", ValueFromAmount(stats.block_prevout_spent_amount - prev_stats.block_prevout_spent_amount));\n+            block_info.pushKV(\"coinbase\", ValueFromAmount(stats.block_coinbase_amount - prev_stats.block_coinbase_amount));\n+            block_info.pushKV(\"new_outputs_ex_coinbase\", ValueFromAmount(stats.block_new_outputs_ex_coinbase_amount - prev_stats.block_new_outputs_ex_coinbase_amount));\n+            block_info.pushKV(\"unspendable\", ValueFromAmount(stats.block_unspendable_amount - prev_stats.block_unspendable_amount));\n+\n+            UniValue unspendables(UniValue::VOBJ);\n+            unspendables.pushKV(\"genesis_block\", ValueFromAmount(stats.unspendables_genesis_block - prev_stats.unspendables_genesis_block));\n+            unspendables.pushKV(\"bip30\", ValueFromAmount(stats.unspendables_bip30 - prev_stats.unspendables_bip30));\n+            unspendables.pushKV(\"scripts\", ValueFromAmount(stats.unspendables_scripts - prev_stats.unspendables_scripts));\n+            unspendables.pushKV(\"unclaimed_rewards\", ValueFromAmount(stats.unspendables_unclaimed_rewards - prev_stats.unspendables_unclaimed_rewards));\n+            block_info.pushKV(\"unspendables\", unspendables);\n+\n+            ret.pushKV(\"block_info\", block_info);\n+        }\n     } else {\n+        if (g_coin_stats_index) {\n+            IndexSummary summary = g_coin_stats_index->GetSummary();\n+\n+            if (!summary.synced) {\n+                throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to read UTXO set. coinstatsindex is still syncing. Current height: %d\", summary.best_block_height));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607877856",
      "id" : 607877856,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzg3Nzg1Ng==",
      "original_commit_id" : "5860532c4041bc3f90fc1f8919f56b6f3955ae9f",
      "original_line" : 1192,
      "original_position" : 175,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 628935807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607877856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607881278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607881278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "13d2fc63ac\r\n\r\n```suggestion\r\n            const IndexSummary summary{g_coin_stats_index->GetSummary()};\r\n```",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T14:06:21Z",
      "diff_hunk" : "@@ -1087,9 +1156,42 @@ static RPCHelpMan gettxoutsetinfo()\n         if (hash_type == CoinStatsHashType::MUHASH) {\n               ret.pushKV(\"muhash\", stats.hashSerialized.GetHex());\n         }\n-        ret.pushKV(\"disk_size\", stats.nDiskSize);\n         ret.pushKV(\"total_amount\", ValueFromAmount(stats.nTotalAmount));\n+        if (!stats.index_used) {\n+            ret.pushKV(\"transactions\", static_cast<int64_t>(stats.nTransactions));\n+            ret.pushKV(\"disk_size\", stats.nDiskSize);\n+        } else {\n+            ret.pushKV(\"total_unspendable_amount\", ValueFromAmount(stats.block_unspendable_amount));\n+\n+            CCoinsStats prev_stats{hash_type};\n+\n+            if (pindex->nHeight > 0) {\n+                GetUTXOStats(coins_view, WITH_LOCK(::cs_main, return std::ref(g_chainman.m_blockman)), prev_stats, node.rpc_interruption_point, pindex->pprev);\n+            }\n+\n+            UniValue block_info(UniValue::VOBJ);\n+            block_info.pushKV(\"prevout_spent\", ValueFromAmount(stats.block_prevout_spent_amount - prev_stats.block_prevout_spent_amount));\n+            block_info.pushKV(\"coinbase\", ValueFromAmount(stats.block_coinbase_amount - prev_stats.block_coinbase_amount));\n+            block_info.pushKV(\"new_outputs_ex_coinbase\", ValueFromAmount(stats.block_new_outputs_ex_coinbase_amount - prev_stats.block_new_outputs_ex_coinbase_amount));\n+            block_info.pushKV(\"unspendable\", ValueFromAmount(stats.block_unspendable_amount - prev_stats.block_unspendable_amount));\n+\n+            UniValue unspendables(UniValue::VOBJ);\n+            unspendables.pushKV(\"genesis_block\", ValueFromAmount(stats.unspendables_genesis_block - prev_stats.unspendables_genesis_block));\n+            unspendables.pushKV(\"bip30\", ValueFromAmount(stats.unspendables_bip30 - prev_stats.unspendables_bip30));\n+            unspendables.pushKV(\"scripts\", ValueFromAmount(stats.unspendables_scripts - prev_stats.unspendables_scripts));\n+            unspendables.pushKV(\"unclaimed_rewards\", ValueFromAmount(stats.unspendables_unclaimed_rewards - prev_stats.unspendables_unclaimed_rewards));\n+            block_info.pushKV(\"unspendables\", unspendables);\n+\n+            ret.pushKV(\"block_info\", block_info);\n+        }\n     } else {\n+        if (g_coin_stats_index) {\n+            IndexSummary summary = g_coin_stats_index->GetSummary();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607881278",
      "id" : 607881278,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzg4MTI3OA==",
      "original_commit_id" : "5860532c4041bc3f90fc1f8919f56b6f3955ae9f",
      "original_line" : 1189,
      "original_position" : 172,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 628935807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607881278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607884218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607884218"
         }
      },
      "author_association" : "MEMBER",
      "body" : "13d2fc6 looks like this can be const (I'm not sure there is a reason to declare this variable instead of doing `std::make_unique<CoinStatsIndex>(/* coin_stats_cache_size */ 0, false, fReindex);` at line 1829 below)",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T14:09:42Z",
      "diff_hunk" : "@@ -1562,6 +1573,7 @@ bool AppInitMain(const std::any& context, NodeContext& node, interfaces::BlockAn\n         filter_index_cache = max_cache / n_indexes;\n         nTotalCache -= filter_index_cache * n_indexes;\n     }\n+    int64_t coin_stats_cache_size = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r607884218",
      "id" : 607884218,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzg4NDIxOA==",
      "original_commit_id" : "5860532c4041bc3f90fc1f8919f56b6f3955ae9f",
      "original_line" : 1576,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 628935807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607884218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608214880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608214880"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree but I don't see how to achieve this with some refactor if it's done right. It's is on the top of my TODO list to resolve some circular dependencies but I think it's out of the scope of this PR.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T22:15:39Z",
      "diff_hunk" : "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/coinstatsindex -> node/coinstats -> index/coinstatsindex\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608214880",
      "id" : 608214880,
      "in_reply_to_id" : 500651118,
      "line" : 17,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODIxNDg4MA==",
      "original_commit_id" : "106231807935bf24334827d1edf1d25acb1933d2",
      "original_line" : 17,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 629451877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608214880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232424"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I have dropped the ctor. We need to keep the explicit passing of the hash type in validation in case any default changes but we still need hash_serialized for assume_utxo.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T23:01:07Z",
      "diff_hunk" : "@@ -264,7 +264,7 @@ FUZZ_TARGET_INIT(coins_view, initialize_coins_view)\n                 CCoinsStats stats;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232424",
      "id" : 608232424,
      "in_reply_to_id" : 599652604,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODIzMjQyNA==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 261,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : null,
      "pull_request_review_id" : 629472465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232610"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T23:01:35Z",
      "diff_hunk" : "@@ -0,0 +1,470 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block{(pindex->nHeight == 91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                            (pindex->nHeight == 91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"))};\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx.at(i)};\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out{tx->vout[j]};\n+                Coin coin{out, pindex->nHeight, tx->IsCoinBase()};\n+                COutPoint outpoint{tx->GetHash(), static_cast<uint32_t>(j)};\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_block_unspendable_amount += coin.out.nValue;\n+                    m_unspendables_scripts += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                if (tx->IsCoinBase()) {\n+                    m_block_coinbase_amount += coin.out.nValue;\n+                } else {\n+                    m_block_new_outputs_ex_coinbase_amount += coin.out.nValue;\n+                }\n+\n+                ++m_transaction_output_count;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (!tx->IsCoinBase()) {\n+                const auto& tx_undo{block_undo.vtxundo.at(i - 1)};\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin{tx_undo.vprevout[j]};\n+                    COutPoint outpoint{tx->vin[j].prevout.hash, tx->vin[j].prevout.n};\n+\n+                    m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                    m_block_prevout_spent_amount += coin.out.nValue;\n+\n+                    --m_transaction_output_count;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    } else {\n+        m_block_unspendable_amount += block_subsidy;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232610",
      "id" : 608232610,
      "in_reply_to_id" : 607823680,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODIzMjYxMA==",
      "original_commit_id" : "5860532c4041bc3f90fc1f8919f56b6f3955ae9f",
      "original_line" : 191,
      "original_position" : 189,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 191,
      "pull_request_review_id" : 629472710,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232610",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232675"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, I already fixed this but must have undone it somehow in all the rebasing :-/ I hope it works now.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T23:01:45Z",
      "diff_hunk" : "@@ -1043,42 +1070,84 @@ static RPCHelpMan gettxoutsetinfo()\n {\n     return RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n-                    {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\n+                    {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n+                    {\"use_index\", RPCArg::Type::BOOL, /* default */ \"true\", \"Use Coinstatsindex even when it is available.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232675",
      "id" : 608232675,
      "in_reply_to_id" : 607846449,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODIzMjY3NQ==",
      "original_commit_id" : "5860532c4041bc3f90fc1f8919f56b6f3955ae9f",
      "original_line" : 1077,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 629472795,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232769"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T23:01:56Z",
      "diff_hunk" : "@@ -1087,9 +1156,42 @@ static RPCHelpMan gettxoutsetinfo()\n         if (hash_type == CoinStatsHashType::MUHASH) {\n               ret.pushKV(\"muhash\", stats.hashSerialized.GetHex());\n         }\n-        ret.pushKV(\"disk_size\", stats.nDiskSize);\n         ret.pushKV(\"total_amount\", ValueFromAmount(stats.nTotalAmount));\n+        if (!stats.index_used) {\n+            ret.pushKV(\"transactions\", static_cast<int64_t>(stats.nTransactions));\n+            ret.pushKV(\"disk_size\", stats.nDiskSize);\n+        } else {\n+            ret.pushKV(\"total_unspendable_amount\", ValueFromAmount(stats.block_unspendable_amount));\n+\n+            CCoinsStats prev_stats{hash_type};\n+\n+            if (pindex->nHeight > 0) {\n+                GetUTXOStats(coins_view, WITH_LOCK(::cs_main, return std::ref(g_chainman.m_blockman)), prev_stats, node.rpc_interruption_point, pindex->pprev);\n+            }\n+\n+            UniValue block_info(UniValue::VOBJ);\n+            block_info.pushKV(\"prevout_spent\", ValueFromAmount(stats.block_prevout_spent_amount - prev_stats.block_prevout_spent_amount));\n+            block_info.pushKV(\"coinbase\", ValueFromAmount(stats.block_coinbase_amount - prev_stats.block_coinbase_amount));\n+            block_info.pushKV(\"new_outputs_ex_coinbase\", ValueFromAmount(stats.block_new_outputs_ex_coinbase_amount - prev_stats.block_new_outputs_ex_coinbase_amount));\n+            block_info.pushKV(\"unspendable\", ValueFromAmount(stats.block_unspendable_amount - prev_stats.block_unspendable_amount));\n+\n+            UniValue unspendables(UniValue::VOBJ);\n+            unspendables.pushKV(\"genesis_block\", ValueFromAmount(stats.unspendables_genesis_block - prev_stats.unspendables_genesis_block));\n+            unspendables.pushKV(\"bip30\", ValueFromAmount(stats.unspendables_bip30 - prev_stats.unspendables_bip30));\n+            unspendables.pushKV(\"scripts\", ValueFromAmount(stats.unspendables_scripts - prev_stats.unspendables_scripts));\n+            unspendables.pushKV(\"unclaimed_rewards\", ValueFromAmount(stats.unspendables_unclaimed_rewards - prev_stats.unspendables_unclaimed_rewards));\n+            block_info.pushKV(\"unspendables\", unspendables);\n+\n+            ret.pushKV(\"block_info\", block_info);\n+        }\n     } else {\n+        if (g_coin_stats_index) {\n+            IndexSummary summary = g_coin_stats_index->GetSummary();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232769",
      "id" : 608232769,
      "in_reply_to_id" : 607881278,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODIzMjc2OQ==",
      "original_commit_id" : "5860532c4041bc3f90fc1f8919f56b6f3955ae9f",
      "original_line" : 1189,
      "original_position" : 172,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 629472890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232810"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232810"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done (inlined)",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-06T23:02:01Z",
      "diff_hunk" : "@@ -1562,6 +1573,7 @@ bool AppInitMain(const std::any& context, NodeContext& node, interfaces::BlockAn\n         filter_index_cache = max_cache / n_indexes;\n         nTotalCache -= filter_index_cache * n_indexes;\n     }\n+    int64_t coin_stats_cache_size = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r608232810",
      "id" : 608232810,
      "in_reply_to_id" : 607884218,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODIzMjgxMA==",
      "original_commit_id" : "5860532c4041bc3f90fc1f8919f56b6f3955ae9f",
      "original_line" : 1576,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 629472946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608232810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry, I didn't get around to write an update after I pushed yesterday. I further addressed comments from @jonatack and I think I should have addressed everything now :)\r\n\r\n>I don't think it is necessary to disallow the coin stats index when pruning is enabled. The only reason that txindex disallows it is because txindex gets the transaction data by reading it off disk from the block files, so that is incompatible with pruning.\r\n>\r\n>The coin stats index doesn't have the same problem. The only issue would be if there were a large reorg and it needed the undo data that has already been deleted. However this is an issue overall of pruned nodes so it shouldn't be a concern for the coin stats index.\r\n\r\nYes, but I would like to keep this for a follow-up because if I do it the same way as it is done for the blockfilterindexes it makes coinstatsindex a new dependency for validation and that would also be a new circular dependency. But I am working on a better solution, it just requires some refactoring that is beyond the scope of this PR IMO.",
      "created_at" : "2021-04-06T23:08:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-814490653",
      "id" : 814490653,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNDQ5MDY1Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-06T23:09:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/814490653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-07T06:34:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-814643578",
      "id" : 814643578,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNDY0MzU3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-07T06:34:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/814643578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased",
      "created_at" : "2021-04-10T22:29:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-817210690",
      "id" : 817210690,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzIxMDY5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-10T22:29:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817210690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r611155443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611155443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks; done in latest update a4eaae4",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-11T08:58:57Z",
      "diff_hunk" : "@@ -341,6 +341,6 @@ MuHash3072& MuHash3072::Insert(Span<const unsigned char> in) noexcept {\n }\n \n MuHash3072& MuHash3072::Remove(Span<const unsigned char> in) noexcept {\n-    m_numerator.Divide(ToNum3072(in));\n+    m_denominator.Multiply(ToNum3072(in));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r611155443",
      "id" : 611155443,
      "in_reply_to_id" : 599606214,
      "line" : 344,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTE1NTQ0Mw==",
      "original_commit_id" : "b12f331cbf2544291693368f3600937965f05490",
      "original_line" : 344,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/crypto/muhash.cpp",
      "position" : 5,
      "pull_request_review_id" : 632989041,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611155443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK a4eaae4697d027f511ca2fa216b2ec0480b0be5d per `git diff 5860532 074cc23` (before rebase) and `git range-diff 1e3db68 5860532 a4eaae4` (after rebase), debug build is clean, lightly re-tested on signet\r\n\r\n<details><summary>manual testing</summary><p>\r\n\r\n```\r\n$ bitcoin-cli -signet gettxoutsetinfo \"none\" 90111\r\nerror code: -8\r\nerror message:\r\nTarget block height 90111 after current tip 33053\r\n\r\n$ bitcoin-cli -signet gettxoutsetinfo \"muhash\" 33053\r\nerror code: -32603\r\nerror message:\r\nUnable to read UTXO set because coinstatsindex is still syncing. Current height: 32533\r\n\r\n...a few seconds later...\r\n\r\n$ bitcoin-cli gettxoutsetinfo muhash 33053\r\n{\r\n  \"height\": 33053,\r\n  \"bestblock\": \"000000ef50b4fd3572a61e461ea156a936906fcf9828c9f2cb305391bbb5078c\",\r\n  \"txouts\": 48452,\r\n  \"bogosize\": 3545492,\r\n  \"muhash\": \"8620187d4cb621cee5c409fc3809d43d9029557b6b07f646d8293156e69e6a8f\",\r\n  \"total_amount\": 1652650.00000000,\r\n  \"total_unspendable_amount\": 50.00000000,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 6.65019527,\r\n    \"coinbase\": 50.00000433,\r\n    \"new_outputs_ex_coinbase\": 6.65019094,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n\r\n$  bitcoin-cli -signet help gettxoutsetinfo\r\ngettxoutsetinfo ( \"hash_type\" hash_or_height use_index )\r\n\r\nReturns statistics about the unspent transaction output set.\r\nNote this call may take some time if you are not using coinstatsindex.\r\n\r\nArguments:\r\n1. hash_type         (string, optional, default=hash_serialized_2) Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'\r\n2. hash_or_height    (string or numeric) The block hash or height of the target height (only available with coinstatsindex)\r\n3. use_index         (boolean, optional, default=true) Use coinstatsindex, if available.\r\n\r\nResult:\r\n{                                     (json object)\r\n  \"height\" : n,                       (numeric) The block height (index) of the returned statistics\r\n  \"bestblock\" : \"hex\",                (string) The hash of the block at which these statistics are calculated\r\n  \"txouts\" : n,                       (numeric) The number of unspent transaction outputs\r\n  \"bogosize\" : n,                     (numeric) Database-independent, meaningless metric indicating the UTXO set size\r\n  \"hash_serialized_2\" : \"hex\",        (string, optional) The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\r\n  \"muhash\" : \"hex\",                   (string, optional) The serialized hash (only present if 'muhash' hash_type is chosen)\r\n  \"transactions\" : n,                 (numeric) The number of transactions with unspent outputs (not available when coinstatsindex is used)\r\n  \"disk_size\" : n,                    (numeric) The estimated size of the chainstate on disk (not available when coinstatsindex is used)\r\n  \"total_amount\" : n,                 (numeric) The total amount of coins in the UTXO set\r\n  \"total_unspendable_amount\" : n,     (numeric) The total amount of coins permanently excluded from the UTXO set (only available if coinstatsindex is used)\r\n  \"block_info\" : {                    (json object) Info on amounts in the block at this block height (only available if coinstatsindex is used)\r\n    \"prevout_spent\" : n,              (numeric)\r\n    \"coinbase\" : n,                   (numeric)\r\n    \"new_outputs_ex_coinbase\" : n,    (numeric)\r\n    \"unspendable\" : n,                (numeric)\r\n    \"unspendables\" : {                (json object) Detailed view of the unspendable categories\r\n      \"genesis_block\" : n,            (numeric)\r\n      \"bip30\" : n,                    (numeric) Transactions overridden by duplicates (no longer possible with BIP30)\r\n      \"scripts\" : n,                  (numeric) Amounts sent to scripts that are unspendable (for example OP_RETURN outputs)\r\n      \"unclaimed_rewards\" : n         (numeric) Fee rewards that miners did not claim in their coinbase transaction\r\n    }\r\n  }\r\n}\r\n\r\nExamples:\r\n> bitcoin-cli gettxoutsetinfo \r\n> bitcoin-cli gettxoutsetinfo \"none\"\r\n> bitcoin-cli gettxoutsetinfo \"none\" 1000\r\n> bitcoin-cli gettxoutsetinfo \"none\" '\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\"'\r\n> curl --user myusername --data-binary '{\"jsonrpc\": \"1.0\", \"id\": \"curltest\", \"method\": \"gettxoutsetinfo\", \"params\": []}' -H 'content-type: text/plain;' http://127.0.0.1:8332/\r\n> curl --user myusername --data-binary '{\"jsonrpc\": \"1.0\", \"id\": \"curltest\", \"method\": \"gettxoutsetinfo\", \"params\": [\"none\"]}' -H 'content-type: text/plain;' http://127.0.0.1:8332/\r\n> curl --user myusername --data-binary '{\"jsonrpc\": \"1.0\", \"id\": \"curltest\", \"method\": \"gettxoutsetinfo\", \"params\": [\"none\", 1000]}' -H 'content-type: text/plain;' http://127.0.0.1:8332/\r\n> curl --user myusername --data-binary '{\"jsonrpc\": \"1.0\", \"id\": \"curltest\", \"method\": \"gettxoutsetinfo\", \"params\": [\"none\", \"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\"]}' -H 'content-type: text/plain;' http://127.0.0.1:8332/\r\n```\r\n</p></details>\r\n\r\n",
      "created_at" : "2021-04-11T09:12:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-817275460",
      "id" : 817275460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzI3NTQ2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-11T09:12:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817275460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Tested ACK. [a4eaae4](https://github.com/bitcoin/bitcoin/commit/a4eaae4697d027f511ca2fa216b2ec0480b0be5d)\r\n\r\nManual Testing: \r\n\r\n```\r\n./src/bitcoin-cli gettxoutsetinfo muhash 677990\r\n{\r\n  \"height\": 677990,\r\n  \"bestblock\": \"00000000000000000005e25f3d3e12bf69664dcfe78e2b90a58d5a9e596eef6b\",\r\n  \"txouts\": 74586452,\r\n  \"bogosize\": 5588597888,\r\n  \"muhash\": \"0f829dbd43ecd72de16a8b906f287600a0426ea0bb6deb1bc15772af2e534628\",\r\n  \"total_amount\": 18674738.62932678,\r\n  \"total_unspendable_amount\": 205.12067322,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 15754.91848125,\r\n    \"coinbase\": 7.03601537,\r\n    \"new_outputs_ex_coinbase\": 15754.13246588,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n\r\n```\r\n./src/bitcoin-cli  gettxoutsetinfo \"none\" 1000\r\n{\r\n  \"height\": 1000,\r\n  \"bestblock\": \"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\",\r\n  \"txouts\": 998,\r\n  \"bogosize\": 116724,\r\n  \"total_amount\": 50000.00000000,\r\n  \"total_unspendable_amount\": 50.00000000,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 0.00000000,\r\n    \"coinbase\": 50.00000000,\r\n    \"new_outputs_ex_coinbase\": 0.00000000,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n\r\n```\r\n./src/bitcoin-cli gettxoutsetinfo \"none\" '\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\"'\r\n{\r\n  \"height\": 1000,\r\n  \"bestblock\": \"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\",\r\n  \"txouts\": 998,\r\n  \"bogosize\": 116724,\r\n  \"total_amount\": 50000.00000000,\r\n  \"total_unspendable_amount\": 50.00000000,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 0.00000000,\r\n    \"coinbase\": 50.00000000,\r\n    \"new_outputs_ex_coinbase\": 0.00000000,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\nI saw this on the logs: \r\n\r\n```\r\n2021-04-11T18:53:56Z Syncing coinstatsindex with block chain from height 617225\r\n2021-04-11T18:54:33Z Syncing coinstatsindex with block chain from height 617231\r\n2021-04-11T18:55:04Z Syncing coinstatsindex with block chain from height 617280\r\n\r\n```\r\n\r\nWithout coinstatsindex enabled: \r\n\r\n```\r\n./src/bitcoin-cli gettxoutsetinfo muhash 677990\r\n\r\nerror code: -8\r\nerror message:\r\nQuerying specific block heights requires coinstatsindex\r\n```",
      "created_at" : "2021-04-12T22:38:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-818288887",
      "id" : 818288887,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODI4ODg4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-12T22:38:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818288887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16559?v=4",
         "events_url" : "https://api.github.com/users/ivanacostarubio/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ivanacostarubio/followers",
         "following_url" : "https://api.github.com/users/ivanacostarubio/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ivanacostarubio/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ivanacostarubio",
         "id" : 16559,
         "login" : "ivanacostarubio",
         "node_id" : "MDQ6VXNlcjE2NTU5",
         "organizations_url" : "https://api.github.com/users/ivanacostarubio/orgs",
         "received_events_url" : "https://api.github.com/users/ivanacostarubio/received_events",
         "repos_url" : "https://api.github.com/users/ivanacostarubio/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ivanacostarubio/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ivanacostarubio/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ivanacostarubio"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-tACK a4eaae4\r\n\r\nMuhash at height 679,048: f5058d7485db847f189ad33c80ecdbb8ad0ceba3fe3e9e32a3ada9553dc52406 \r\n\r\nOf course it needs a rebase 2 hours after my re-ACK :-(",
      "created_at" : "2021-04-13T12:21:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-818692017",
      "id" : 818692017,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODY5MjAxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-13T19:16:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818692017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-13T14:25:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-818778770",
      "id" : 818778770,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODc3ODc3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-13T14:25:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818778770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Tested ACK. a4eaae4\r\n\r\nManual Testing:\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo none '\"00000000d1145790a8694403d4063f323d499e655c83426834d4ce2f8dd4a2ee\"'\r\n{\r\n  \"height\": 170,\r\n  \"bestblock\": \"00000000d1145790a8694403d4063f323d499e655c83426834d4ce2f8dd4a2ee\",\r\n  \"txouts\": 171,\r\n  \"bogosize\": 20007,\r\n  \"total_amount\": 8500.00000000,\r\n  \"total_unspendable_amount\": 50.00000000,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 50.00000000,\r\n    \"coinbase\": 50.00000000,\r\n    \"new_outputs_ex_coinbase\": 50.00000000,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo none 400000\r\nerror code: -32603\r\nerror message:\r\nUnable to read UTXO set because coinstatsindex is still syncing. Current height: 291230\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo none 200000\r\n{\r\n  \"height\": 200000,\r\n  \"bestblock\": \"000000000000034a7dedef4a161fa058a2d67a173a90155f3a2fe6fc132e0ebf\",\r\n  \"txouts\": 2318056,\r\n  \"bogosize\": 175620421,\r\n  \"total_amount\": 9999889.98361183,\r\n  \"total_unspendable_amount\": 160.01638817,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 211681.67936751,\r\n    \"coinbase\": 50.63517500,\r\n    \"new_outputs_ex_coinbase\": 211681.04419251,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo muhash 100000\r\n{\r\n  \"height\": 100000,\r\n  \"bestblock\": \"000000000003ba27aa200b1cecaad478d2b00432346c3f1f3986da1afd33e506\",\r\n  \"txouts\": 71888,\r\n  \"bogosize\": 7606209,\r\n  \"muhash\": \"86aa993b32b9df2afa1a2c4855d34911146ad77328a82887e058d23f01831e3e\",\r\n  \"total_amount\": 4999900.00000000,\r\n  \"total_unspendable_amount\": 150.00000000,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 53.01000000,\r\n    \"coinbase\": 50.00000000,\r\n    \"new_outputs_ex_coinbase\": 53.01000000,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo none\r\nerror code: -32603\r\nerror message:\r\nUnable to read UTXO set because coinstatsindex is still syncing. Current height: 299131\r\n```",
      "created_at" : "2021-04-14T15:54:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-819626933",
      "id" : 819626933,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTYyNjkzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T15:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819626933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/228364?v=4",
         "events_url" : "https://api.github.com/users/grunch/events{/privacy}",
         "followers_url" : "https://api.github.com/users/grunch/followers",
         "following_url" : "https://api.github.com/users/grunch/following{/other_user}",
         "gists_url" : "https://api.github.com/users/grunch/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/grunch",
         "id" : 228364,
         "login" : "grunch",
         "node_id" : "MDQ6VXNlcjIyODM2NA==",
         "organizations_url" : "https://api.github.com/users/grunch/orgs",
         "received_events_url" : "https://api.github.com/users/grunch/received_events",
         "repos_url" : "https://api.github.com/users/grunch/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/grunch/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/grunch/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/grunch"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ain't no party like a rebase party, 'cause a rebase party don't stop...",
      "created_at" : "2021-04-14T19:52:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-819789914",
      "id" : 819789914,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTc4OTkxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T19:52:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819789914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review re-ACK 1be67944193241ff5aee60188f2730367a638500 per `git range-diff 773f8c1 a4eaae4 1be6794`, only changes since my last review are rebase due to added neighboring headers and circular dependencies from merged #21575",
      "created_at" : "2021-04-14T21:13:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-819836733",
      "id" : 819836733,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTgzNjczMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T21:13:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819836733",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(also verified that the unrelated-looking cirrus CI test failure in `feature_notifications.py#L172` does not occur for me locally and opened issue #21683)",
      "created_at" : "2021-04-14T21:16:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-819838244",
      "id" : 819838244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTgzODI0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T21:16:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819838244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-utACK 1be67944193241ff5aee60188f2730367a638500: what jonatack said",
      "created_at" : "2021-04-15T07:20:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-820182102",
      "id" : 820182102,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMDE4MjEwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-15T07:20:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820182102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "re-tACK [1be6794](https://github.com/bitcoin/bitcoin/commit/1be67944193241ff5aee60188f2730367a638500)\r\n\r\n<details>\r\n  <summary>Manual Testing</summary>\r\n\r\n\r\n**After recompiling:**\r\n\r\nRight after starting bitcoind: \r\n\r\n```\r\n ./src/bitcoin-cli gettxoutsetinfo 'muhash' 677990\r\nerror code: -28\r\nerror message:\r\nVerifying blocks...\r\n```\r\n\r\nAfter verified the blocks: \r\n\r\n```\r\nsrc/bitcoin-cli gettxoutsetinfo 'muhash' 677990\r\n{\r\n  \"height\": 677990,\r\n  \"bestblock\": \"00000000000000000005e25f3d3e12bf69664dcfe78e2b90a58d5a9e596eef6b\",\r\n  \"txouts\": 74586452,\r\n  \"bogosize\": 5588597888,\r\n  \"muhash\": \"0f829dbd43ecd72de16a8b906f287600a0426ea0bb6deb1bc15772af2e534628\",\r\n  \"total_amount\": 18674738.62932678,\r\n  \"total_unspendable_amount\": 205.12067322,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 15754.91848125,\r\n    \"coinbase\": 7.03601537,\r\n    \"new_outputs_ex_coinbase\": 15754.13246588,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n ```\r\n./src/bitcoin-cli  gettxoutsetinfo \"none\" 1000\r\n{\r\n  \"height\": 1000,\r\n  \"bestblock\": \"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\",\r\n  \"txouts\": 998,\r\n  \"bogosize\": 116724,\r\n  \"total_amount\": 50000.00000000,\r\n  \"total_unspendable_amount\": 50.00000000,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 0.00000000,\r\n    \"coinbase\": 50.00000000,\r\n    \"new_outputs_ex_coinbase\": 0.00000000,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n</details>\r\n\r\n",
      "created_at" : "2021-04-15T20:07:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-820699496",
      "id" : 820699496,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMDY5OTQ5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-15T20:07:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820699496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16559?v=4",
         "events_url" : "https://api.github.com/users/ivanacostarubio/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ivanacostarubio/followers",
         "following_url" : "https://api.github.com/users/ivanacostarubio/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ivanacostarubio/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ivanacostarubio",
         "id" : 16559,
         "login" : "ivanacostarubio",
         "node_id" : "MDQ6VXNlcjE2NTU5",
         "organizations_url" : "https://api.github.com/users/ivanacostarubio/orgs",
         "received_events_url" : "https://api.github.com/users/ivanacostarubio/received_events",
         "repos_url" : "https://api.github.com/users/ivanacostarubio/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ivanacostarubio/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ivanacostarubio/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ivanacostarubio"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-17T16:27:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-821849414",
      "id" : 821849414,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMTg0OTQxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-17T16:27:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821849414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Ain't no party like a rebase party, 'cause a rebase party don't stop...\r\n\r\nðº ",
      "created_at" : "2021-04-17T22:13:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-821894930",
      "id" : 821894930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMTg5NDkzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-17T22:13:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821894930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r615311365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615311365"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 0123b7e4e2 \"rpc: gettxoutsetinfo can be requested for specific blockheights\" the range-diff seems to be:\r\n```diff\r\n-        if (!::ChainActive().Contains(pindex)) {\r\n+        if (active_chain.Contains(pindex)) {\r\n```\r\nShould it be `if (!active_chain.Contains(pindex)) {` ? (it's late so I may be misreading)",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-17T22:26:17Z",
      "diff_hunk" : "@@ -140,6 +140,35 @@ static int ComputeNextBlockAndDepth(const CBlockIndex* tip, const CBlockIndex* b\n     return blockindex == tip ? 1 : -1;\n }\n \n+CBlockIndex* ParseHashOrHeight(const UniValue& param, ChainstateManager& chainman) {\n+    LOCK(::cs_main);\n+    CChain& active_chain = chainman.ActiveChain();\n+\n+    if (param.isNum()) {\n+        const int height{param.get_int()};\n+        if (height < 0) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(\"Target block height %d is negative\", height));\n+        }\n+        const int current_tip{active_chain.Height()};\n+        if (height > current_tip) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(\"Target block height %d after current tip %d\", height, current_tip));\n+        }\n+\n+        return active_chain[height];\n+    } else {\n+        const uint256 hash{ParseHashV(param, \"hash_or_height\")};\n+        CBlockIndex* pindex = chainman.m_blockman.LookupBlockIndex(hash);\n+\n+        if (!pindex) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n+        }\n+        if (active_chain.Contains(pindex)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r615311365",
      "id" : 615311365,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTMxMTM2NQ==",
      "original_commit_id" : "0123b7e4e2dc259cb7205d037ba4e2c232980ee0",
      "original_line" : 165,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 638278909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615311365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r615311910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615311910"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looks like that commit and then f87cf789 are affected. Ugh, my sympathies for the rebase.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-17T22:32:28Z",
      "diff_hunk" : "@@ -140,6 +140,35 @@ static int ComputeNextBlockAndDepth(const CBlockIndex* tip, const CBlockIndex* b\n     return blockindex == tip ? 1 : -1;\n }\n \n+CBlockIndex* ParseHashOrHeight(const UniValue& param, ChainstateManager& chainman) {\n+    LOCK(::cs_main);\n+    CChain& active_chain = chainman.ActiveChain();\n+\n+    if (param.isNum()) {\n+        const int height{param.get_int()};\n+        if (height < 0) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(\"Target block height %d is negative\", height));\n+        }\n+        const int current_tip{active_chain.Height()};\n+        if (height > current_tip) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(\"Target block height %d after current tip %d\", height, current_tip));\n+        }\n+\n+        return active_chain[height];\n+    } else {\n+        const uint256 hash{ParseHashV(param, \"hash_or_height\")};\n+        CBlockIndex* pindex = chainman.m_blockman.LookupBlockIndex(hash);\n+\n+        if (!pindex) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n+        }\n+        if (active_chain.Contains(pindex)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r615311910",
      "id" : 615311910,
      "in_reply_to_id" : 615311365,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTMxMTkxMA==",
      "original_commit_id" : "0123b7e4e2dc259cb7205d037ba4e2c232980ee0",
      "original_line" : 165,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 638279171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615311910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r615313624"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615313624"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yepp, thanks. Fixed!",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-17T22:53:36Z",
      "diff_hunk" : "@@ -140,6 +140,35 @@ static int ComputeNextBlockAndDepth(const CBlockIndex* tip, const CBlockIndex* b\n     return blockindex == tip ? 1 : -1;\n }\n \n+CBlockIndex* ParseHashOrHeight(const UniValue& param, ChainstateManager& chainman) {\n+    LOCK(::cs_main);\n+    CChain& active_chain = chainman.ActiveChain();\n+\n+    if (param.isNum()) {\n+        const int height{param.get_int()};\n+        if (height < 0) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(\"Target block height %d is negative\", height));\n+        }\n+        const int current_tip{active_chain.Height()};\n+        if (height > current_tip) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(\"Target block height %d after current tip %d\", height, current_tip));\n+        }\n+\n+        return active_chain[height];\n+    } else {\n+        const uint256 hash{ParseHashV(param, \"hash_or_height\")};\n+        CBlockIndex* pindex = chainman.m_blockman.LookupBlockIndex(hash);\n+\n+        if (!pindex) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n+        }\n+        if (active_chain.Contains(pindex)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r615313624",
      "id" : 615313624,
      "in_reply_to_id" : 615311365,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTMxMzYyNA==",
      "original_commit_id" : "0123b7e4e2dc259cb7205d037ba4e2c232980ee0",
      "original_line" : 165,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 638279960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T19:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615313624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review re-ACK 07201d39d1c10ddbf8a576915203bf3aa4be135c changes appear to be rebase-only per `git range-diff 0dd7b23 1be6794 07201d3`.\r\n\r\nDebug build is clean; I didn't build and test each commit like in my previous reviews above.\r\n\r\nIt may be good if someone familiar with the chainman changes in #21391 et al that caused the rebase had a look. ",
      "created_at" : "2021-04-18T14:19:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-821998941",
      "id" : 821998941,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMTk5ODk0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-18T14:19:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821998941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Tested ACK. [07201d3](https://github.com/bitcoin/bitcoin/commit/07201d39d1c10ddbf8a576915203bf3aa4be135c)\r\n\r\nManual Testing on testnet: \r\n\r\n```\r\n$ src/bitcoind -coinstatsindex\r\n2021-04-18T20:07:19Z Syncing coinstatsindex with block chain from height 15716\r\n2021-04-18T20:07:50Z Syncing coinstatsindex with block chain from height 19420\r\n2021-04-18T20:07:57Z FlushStateToDisk: write coins cache to disk (1580417 coins, 218854kB) started\r\n2021-04-18T20:08:02Z FlushStateToDisk: write coins cache to disk (1580417 coins, 218854kB) completed (4.79s)\r\n\r\n2021-04-18T22:43:40Z Syncing coinstatsindex with block chain from height 1958230\r\n2021-04-18T22:44:11Z Syncing coinstatsindex with block chain from height 1961375\r\n2021-04-18T22:44:42Z Syncing coinstatsindex with block chain from height 1964519\r\n2021-04-18T22:45:13Z Syncing coinstatsindex with block chain from height 1967320\r\n2021-04-18T22:45:44Z Syncing coinstatsindex with block chain from height 1969832\r\n2021-04-18T22:46:15Z Syncing coinstatsindex with block chain from height 1971923\r\n2021-04-18T22:46:15Z coinstatsindex is enabled at height 1971953\r\n2021-04-18T22:46:15Z coinstatsindex thread exit\r\n\r\n```\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo 'none' 0 true\r\n{\r\n\r\n  \"height\": 0,\r\n  \"bestblock\": \"000000000933ea01ad0ee984209779baaec3ced90fa3f408719526f8d77f4943\",\r\n  \"txouts\": 0,\r\n  \"bogosize\": 0,\r\n  \"total_amount\": 0.00000000,\r\n  \"total_unspendable_amount\": 50.00000000,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 0.00000000,\r\n    \"coinbase\": 0.00000000,\r\n    \"new_outputs_ex_coinbase\": 0.00000000,\r\n    \"unspendable\": 50.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 50.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo muhash 0\r\n{\r\n  \"height\": 0,\r\n  \"bestblock\": \"000000000933ea01ad0ee984209779baaec3ced90fa3f408719526f8d77f4943\",\r\n  \"txouts\": 0,\r\n  \"bogosize\": 0,\r\n  \"muhash\": \"dd5ad2a105c2d29495f577245c357409002329b9f4d6182c0af3dc2f462555c8\",\r\n  \"total_amount\": 0.00000000,\r\n  \"total_unspendable_amount\": 50.00000000,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 0.00000000,\r\n    \"coinbase\": 0.00000000,\r\n    \"new_outputs_ex_coinbase\": 0.00000000,\r\n    \"unspendable\": 50.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 50.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo 'none' 1800003 true\r\nerror code: -32603\r\nerror message:\r\nUnable to read UTXO set because coinstatsindex is still syncing. Current height: 403170\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo muhash 677990\r\nerror code: -32603\r\nerror message:\r\nUnable to read UTXO set because coinstatsindex is still syncing. Current height: 403357\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo 'none' 500000 true\r\n{\r\n  \"height\": 500000,\r\n  \"bestblock\": \"000000000001a7c0aaa2630fbb2c0e476aafffc60f82177375b2aaa22209f606\",\r\n  \"txouts\": 5447499,\r\n  \"bogosize\": 413044654,\r\n  \"total_amount\": 16749305.03353846,\r\n  \"total_unspendable_amount\": 707.46646154,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 0.00000000,\r\n    \"coinbase\": 12.50000000,\r\n    \"new_outputs_ex_coinbase\": 0.00000000,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo 'none' '\"00000000009e2958c15ff9290d571bf9459e93b19765c6801ddeccadbb160a1e\"' true\r\n{\r\n  \"height\": 100000,\r\n  \"bestblock\": \"00000000009e2958c15ff9290d571bf9459e93b19765c6801ddeccadbb160a1e\",\r\n  \"txouts\": 274250,\r\n  \"bogosize\": 21344460,\r\n  \"total_amount\": 4999849.36870600,\r\n  \"total_unspendable_amount\": 200.63129400,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 0.00000000,\r\n    \"coinbase\": 50.00000000,\r\n    \"new_outputs_ex_coinbase\": 0.00000000,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n$ src/bitcoin-cli gettxoutsetinfo muhash '\"00000000009e2958c15ff9290d571bf9459e93b19765c6801ddeccadbb160a1e\"'\r\n{\r\n  \"height\": 100000,\r\n  \"bestblock\": \"00000000009e2958c15ff9290d571bf9459e93b19765c6801ddeccadbb160a1e\",\r\n  \"txouts\": 274250,\r\n  \"bogosize\": 21344460,\r\n  \"muhash\": \"a014cef901c62e92a84004a0f77999062a44210329e3bc21e1b96d9d8a392fb1\",\r\n  \"total_amount\": 4999849.36870600,\r\n  \"total_unspendable_amount\": 200.63129400,\r\n  \"block_info\": {\r\n    \"prevout_spent\": 0.00000000,\r\n    \"coinbase\": 50.00000000,\r\n    \"new_outputs_ex_coinbase\": 0.00000000,\r\n    \"unspendable\": 0.00000000,\r\n    \"unspendables\": {\r\n      \"genesis_block\": 0.00000000,\r\n      \"bip30\": 0.00000000,\r\n      \"scripts\": 0.00000000,\r\n      \"unclaimed_rewards\": 0.00000000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n$ test/functional/feature_coinstatsindex.py\r\n2021-04-18T17:06:20.254000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_4klxhrpj\r\n2021-04-18T17:06:21.796000Z TestFramework (INFO): Test that gettxoutsetinfo() output is consistent with or without coinstatsindex option\r\n2021-04-18T17:06:21.862000Z TestFramework (INFO): Test that gettxoutsetinfo() can get fetch data on specific heights with index\r\n2021-04-18T17:06:22.013000Z TestFramework (INFO): Test gettxoutsetinfo() with index and verbose flag\r\n2021-04-18T17:06:22.178000Z TestFramework (INFO): Test that the index is robust across restarts\r\n2021-04-18T17:06:22.880000Z TestFramework (INFO): Test use_index option for nodes running the index\r\n2021-04-18T17:06:23.002000Z TestFramework (INFO): Test that index can handle reorgs\r\n2021-04-18T17:06:23.516000Z TestFramework (INFO): Test that a node aware of stale blocks syncs them as well\r\n2021-04-18T17:06:24.774000Z TestFramework (INFO): Test that the rpc raises if the legacy hash is passed with the index\r\n2021-04-18T17:06:24.864000Z TestFramework (INFO): Stopping nodes\r\n2021-04-18T17:06:25.017000Z TestFramework (INFO): Cleaning up /tmp/bitcoin_func_test_4klxhrpj on exit\r\n2021-04-18T17:06:25.018000Z TestFramework (INFO): Tests successful\r\n```\r\n\r\n```\r\n$ ~/.bitcoin/testnet3/indexes/coinstats$ du -h\r\n336M\t./db\r\n336M\t.\r\n```",
      "created_at" : "2021-04-18T17:38:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-822029740",
      "id" : 822029740,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMjAyOTc0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-18T22:52:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822029740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1209012?v=4",
         "events_url" : "https://api.github.com/users/aitorjs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aitorjs/followers",
         "following_url" : "https://api.github.com/users/aitorjs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aitorjs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aitorjs",
         "id" : 1209012,
         "login" : "aitorjs",
         "node_id" : "MDQ6VXNlcjEyMDkwMTI=",
         "organizations_url" : "https://api.github.com/users/aitorjs/orgs",
         "received_events_url" : "https://api.github.com/users/aitorjs/received_events",
         "repos_url" : "https://api.github.com/users/aitorjs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aitorjs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aitorjs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aitorjs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\r\n:partying_face: This pull request conflicts with the target branch and [needs rebase party](https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-821894930).\r\n\r\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-19T07:16:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-822232815",
      "id" : 822232815,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMjIzMjgxNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-19T07:16:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822232815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased, review while it's hot! ð¥ \r\n\r\n<details>\r\n  <summary>At least it's a relatively simple one.</summary>\r\n<p>\r\n  \r\n```\r\n$ git range-diff master 07201d3 5f96d7d22\r\n 1:  f8b5dd30f =  1:  2e2648a90 crypto: Make MuHash Remove method efficient\r\n 2:  da85ed5a6 =  2:  9c8a265fd refactor: Pass hash_type to CoinsStats in stats object\r\n 3:  85405cc2a =  3:  a8a46c4b3 refactor: Simplify ApplyStats and ApplyHash\r\n 4:  873cd68fc =  4:  dd58a4de2 index: Add Coinstats index\r\n 5:  e2d5eddfa =  5:  3c914d58f index: Coinstats index can be activated with command line flag\r\n 6:  aeffcbdf5 !  6:  3f166ecc1 rpc: gettxoutsetinfo can be requested for specific blockheights\r\n    @@ src/rpc/blockchain.cpp: static RPCHelpMan gettxoutsetinfo()\r\n     -                \"Note this call may take some time.\\n\",\r\n     +                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\r\n                      {\r\n    --                    {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\r\n    -+                    {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'\"},\r\n    +                     {\"hash_type\", RPCArg::Type::STR, RPCArg::Default{\"hash_serialized_2\"}, \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\r\n     +                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\r\n                      },\r\n                      RPCResult{\r\n 7:  fa7a1f8ae =  7:  6a4c0c09a test: Add functional test for Coinstats index\r\n 8:  1edf2c26b =  8:  57a026c30 test: Add unit test for Coinstats index\r\n 9:  5194bf51d =  9:  ca01bb8d6 rpc: Add Coinstats index to getindexinfo\r\n10:  2214cca58 = 10:  655d92983 test: add coinstatsindex getindexinfo coverage, improve current tests\r\n11:  3b89ad85f = 11:  2501576ec rpc, index: Add verbose amounts tracking to Coinstats index\r\n12:  08952fb10 = 12:  e0938c290 test: Add tests for block_info in gettxoutsetinfo\r\n13:  71e136d5a = 13:  bb7788b12 test: Test coinstatsindex robustness across restarts\r\n14:  6c99446b4 ! 14:  b9362392a index, rpc: Add use_index option for gettxoutsetinfo\r\n    @@ src/node/coinstats.h: struct CCoinsStats\r\n      ## src/rpc/blockchain.cpp ##\r\n     @@ src/rpc/blockchain.cpp: static RPCHelpMan gettxoutsetinfo()\r\n                      {\r\n    -                     {\"hash_type\", RPCArg::Type::STR, /* default */ \"hash_serialized_2\", \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'\"},\r\n    +                     {\"hash_type\", RPCArg::Type::STR, RPCArg::Default{\"hash_serialized_2\"}, \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\r\n                          {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\r\n    -+                    {\"use_index\", RPCArg::Type::BOOL, /* default */ \"true\", \"Use coinstatsindex, if available.\"},\r\n    ++                    {\"use_index\", RPCArg::Type::BOOL, RPCArg::Default{true}, \"Use coinstatsindex, if available.\"},\r\n                      },\r\n                      RPCResult{\r\n                          RPCResult::Type::OBJ, \"\", \"\",\r\n15:  1c0ddc4ef = 15:  90c966b0f rpc: Allow gettxoutsetinfo and getblockstats for stale blocks\r\n16:  8e61ced8e = 16:  23fe50436 test: Add test for coinstatsindex behavior in reorgs\r\n17:  07201d39d = 17:  5f96d7d22 rpc: gettxoutsetinfo rejects hash_serialized_2 for specific height\r\n```\r\n\r\n</p>\r\n</details>",
      "created_at" : "2021-04-19T19:28:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-822727320",
      "id" : 822727320,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMjcyNzMyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-19T19:29:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822727320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-tACK 5f96d7d22d8e05876c6fc014e70488699950fe38\r\n\r\nMuhash at height for block 000000000000000000000f0d7742e6cd22da819b59af361224f452baee8d31c4 (which or may or may not win [the race](https://forkmonitor.info/stale/btc/679823)) is 1d324ac1c67e5317ab40d5c9e23b5aae6a0049fa5649795d32553cae008076fb.",
      "created_at" : "2021-04-19T20:11:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-822753248",
      "id" : 822753248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMjc1MzI0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-19T20:11:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822753248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Narrator: it lost, which is a good opportunity to test a reorg in real life. For height 679824 I now get 157ec719407b64f9204f464fcc203b04d288ff837a3ce5ca63edeb20a2614903. ",
      "created_at" : "2021-04-19T20:21:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-822758954",
      "id" : 822758954,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMjc1ODk1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-19T20:21:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822758954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r616228938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616228938"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit if you have to rebase, this is the only help argument of the three that doesn't end with a period.\r\n\r\n```suggestion\r\n                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex).\", \"\", {\"\", \"string or numeric\"}},\r\n```",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-19T22:53:25Z",
      "diff_hunk" : "@@ -1068,50 +1096,88 @@ static RPCHelpMan gettxoutsetinfo()\n {\n     return RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, RPCArg::Default{\"hash_serialized_2\"}, \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r616228938",
      "id" : 616228938,
      "line" : 1102,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjIyODkzOA==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 1102,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 50,
      "pull_request_review_id" : 639371891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T22:55:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616228938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r617340759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617340759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9c8a265fd21a87228c18a1661df99fedc1866baf\r\n\r\n`const CoinStatsHashType m_hash_type` and drop constructor.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-21T09:08:26Z",
      "diff_hunk" : "@@ -23,6 +23,7 @@ enum class CoinStatsHashType {\n \n struct CCoinsStats\n {\n+    CoinStatsHashType m_hash_type;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r617340759",
      "id" : 617340759,
      "line" : 29,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzM0MDc1OQ==",
      "original_commit_id" : "9c8a265fd21a87228c18a1661df99fedc1866baf",
      "original_line" : 26,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/coinstats.h",
      "position" : 14,
      "pull_request_review_id" : 640805550,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T09:49:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617340759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r617359458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617359458"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3f166ecc125fce6ccd995687fa16572090a5d099\r\n\r\nRemove unnecessary block.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-21T09:33:26Z",
      "diff_hunk" : "@@ -89,22 +89,24 @@ static void ApplyStats(CCoinsStats& stats, const uint256& hash, const std::map<u\n \n //! Calculate statistics about the unspent transaction output set\n template <typename T>\n-static bool GetUTXOStats(CCoinsView* view, BlockManager& blockman, CCoinsStats& stats, T hash_obj, const std::function<void()>& interruption_point)\n+static bool GetUTXOStats(CCoinsView* view, BlockManager& blockman, CCoinsStats& stats, T hash_obj, const std::function<void()>& interruption_point, const CBlockIndex* pindex)\n {\n     std::unique_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n     assert(pcursor);\n-    stats.hashBlock = pcursor->GetBestBlock();\n-\n-    const CBlockIndex* pindex;\n-    {\n-        LOCK(cs_main);\n-        assert(std::addressof(g_chainman.m_blockman) == std::addressof(blockman));\n-        pindex = blockman.LookupBlockIndex(stats.hashBlock);\n-        stats.nHeight = Assert(pindex)->nHeight;\n+\n+    if (!pindex) {\n+        {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r617359458",
      "id" : 617359458,
      "line" : 98,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzM1OTQ1OA==",
      "original_commit_id" : "3f166ecc125fce6ccd995687fa16572090a5d099",
      "original_line" : 98,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/node/coinstats.cpp",
      "position" : 120,
      "pull_request_review_id" : 640805550,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T09:49:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617359458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r617361123"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617361123"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3f166ecc125fce6ccd995687fa16572090a5d099\r\n\r\nnit, can be `static` and move `{` to new line.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-21T09:35:40Z",
      "diff_hunk" : "@@ -140,6 +140,35 @@ static int ComputeNextBlockAndDepth(const CBlockIndex* tip, const CBlockIndex* b\n     return blockindex == tip ? 1 : -1;\n }\n \n+CBlockIndex* ParseHashOrHeight(const UniValue& param, ChainstateManager& chainman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r617361123",
      "id" : 617361123,
      "line" : 143,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzM2MTEyMw==",
      "original_commit_id" : "3f166ecc125fce6ccd995687fa16572090a5d099",
      "original_line" : 143,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 12,
      "pull_request_review_id" : 640805550,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-21T09:49:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617361123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think it should error when `hash_or_height` is set but index is not available or `use_index=false` otherwise the result is misleading.\r\n\r\nThere is already a check for that and it should error in the case you describe: https://github.com/bitcoin/bitcoin/pull/19521/files#diff-decae4be02fb8a47ab4557fe74a9cb853bdfa3ec0fa1b515c0a1e5de91f4ad0bR1168\r\n\r\nIf you found a scenario where it doesn't work, please let me know. There is at least a basic test for it here but maybe I have overlooked something: https://github.com/bitcoin/bitcoin/pull/19521/files#diff-a6434325d09a6df4b371513c837907dfc1a97cf540709def4bded9b2a17e3f49R115\r\n",
      "created_at" : "2021-04-24T21:38:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-826156834",
      "id" : 826156834,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNjE1NjgzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-24T21:38:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/826156834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-04-30T15:35:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-830179892",
      "id" : 830179892,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMDE3OTg5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-30T15:35:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/830179892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r624500568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/624500568"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done in #21818 ",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-01T12:03:51Z",
      "diff_hunk" : "@@ -1068,50 +1096,88 @@ static RPCHelpMan gettxoutsetinfo()\n {\n     return RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, RPCArg::Default{\"hash_serialized_2\"}, \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r624500568",
      "id" : 624500568,
      "in_reply_to_id" : 616228938,
      "line" : 1102,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNDUwMDU2OA==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 1102,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 50,
      "pull_request_review_id" : 649782409,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-01T12:03:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/624500568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634079897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634079897"
         }
      },
      "author_association" : "MEMBER",
      "body" : "could just make `j` of type `uint32_t` to avoid the cast?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-18T06:26:18Z",
      "diff_hunk" : "@@ -0,0 +1,472 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <node/blockstorage.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block{(pindex->nHeight == 91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                            (pindex->nHeight == 91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"))};\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx.at(i)};\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out{tx->vout[j]};\n+                Coin coin{out, pindex->nHeight, tx->IsCoinBase()};\n+                COutPoint outpoint{tx->GetHash(), static_cast<uint32_t>(j)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634079897",
      "id" : 634079897,
      "line" : 149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDA3OTg5Nw==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 149,
      "original_position" : 149,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 149,
      "pull_request_review_id" : 649806721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634079897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634085868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634085868"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why is this called `m_block...`? The value is not per block, but the *total*, like all other CAmount members!? It might be good to call all of them `m_block`, or `m_total`, or just skip the prefix for all of them.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-18T06:37:59Z",
      "diff_hunk" : "@@ -0,0 +1,472 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <node/blockstorage.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block{(pindex->nHeight == 91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                            (pindex->nHeight == 91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"))};\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx.at(i)};\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out{tx->vout[j]};\n+                Coin coin{out, pindex->nHeight, tx->IsCoinBase()};\n+                COutPoint outpoint{tx->GetHash(), static_cast<uint32_t>(j)};\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_block_unspendable_amount += coin.out.nValue;\n+                    m_unspendables_scripts += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                if (tx->IsCoinBase()) {\n+                    m_block_coinbase_amount += coin.out.nValue;\n+                } else {\n+                    m_block_new_outputs_ex_coinbase_amount += coin.out.nValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634085868",
      "id" : 634085868,
      "line" : 163,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDA4NTg2OA==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 163,
      "original_position" : 163,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 163,
      "pull_request_review_id" : 649806721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634085868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634089179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634089179"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't this be a batch to ensure an atomic operation? Otherwise you may end up with a corrupt muhash?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-18T06:44:05Z",
      "diff_hunk" : "@@ -0,0 +1,472 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <node/blockstorage.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block{(pindex->nHeight == 91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                            (pindex->nHeight == 91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"))};\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx.at(i)};\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out{tx->vout[j]};\n+                Coin coin{out, pindex->nHeight, tx->IsCoinBase()};\n+                COutPoint outpoint{tx->GetHash(), static_cast<uint32_t>(j)};\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_block_unspendable_amount += coin.out.nValue;\n+                    m_unspendables_scripts += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                if (tx->IsCoinBase()) {\n+                    m_block_coinbase_amount += coin.out.nValue;\n+                } else {\n+                    m_block_new_outputs_ex_coinbase_amount += coin.out.nValue;\n+                }\n+\n+                ++m_transaction_output_count;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (!tx->IsCoinBase()) {\n+                const auto& tx_undo{block_undo.vtxundo.at(i - 1)};\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin{tx_undo.vprevout[j]};\n+                    COutPoint outpoint{tx->vin[j].prevout.hash, tx->vin[j].prevout.n};\n+\n+                    m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                    m_block_prevout_spent_amount += coin.out.nValue;\n+\n+                    --m_transaction_output_count;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    } else {\n+        // genesis block\n+        m_block_unspendable_amount += block_subsidy;\n+        m_unspendables_genesis_block += block_subsidy;\n+    }\n+\n+    // If spent prevouts + block subsidy are still a higher amount than\n+    // new outputs + coinbase + current unspendable amount this means\n+    // the miner did not claim the full block reward. Unclaimed block\n+    // rewards are also unspendable.\n+    const CAmount unclaimed_rewards{(m_block_prevout_spent_amount + m_total_subsidy) - (m_block_new_outputs_ex_coinbase_amount + m_block_coinbase_amount + m_block_unspendable_amount)};\n+    m_block_unspendable_amount += unclaimed_rewards;\n+    m_unspendables_unclaimed_rewards += unclaimed_rewards;\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+    value.second.total_subsidy = m_total_subsidy;\n+    value.second.block_unspendable_amount = m_block_unspendable_amount;\n+    value.second.block_prevout_spent_amount = m_block_prevout_spent_amount;\n+    value.second.block_new_outputs_ex_coinbase_amount = m_block_new_outputs_ex_coinbase_amount;\n+    value.second.block_coinbase_amount = m_block_coinbase_amount;\n+    value.second.unspendables_genesis_block = m_unspendables_genesis_block;\n+    value.second.unspendables_bip30 = m_unspendables_bip30;\n+    value.second.unspendables_scripts = m_unspendables_scripts;\n+    value.second.unspendables_unclaimed_rewards = m_unspendables_unclaimed_rewards;\n+\n+    uint256 out;\n+    m_muhash.Finalize(out);\n+    value.second.muhash = out;\n+\n+    return m_db->Write(DBHeightKey(pindex->nHeight), value) && m_db->Write(DB_MUHASH, m_muhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634089179",
      "id" : 634089179,
      "line" : 222,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDA4OTE3OQ==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 222,
      "original_position" : 222,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 222,
      "pull_request_review_id" : 649806721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634089179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634095336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634095336"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use early return `if (!...) return false;` to avoid large multi-line nesting ",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-18T06:54:59Z",
      "diff_hunk" : "@@ -0,0 +1,472 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <node/blockstorage.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block{(pindex->nHeight == 91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                            (pindex->nHeight == 91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"))};\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx.at(i)};\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out{tx->vout[j]};\n+                Coin coin{out, pindex->nHeight, tx->IsCoinBase()};\n+                COutPoint outpoint{tx->GetHash(), static_cast<uint32_t>(j)};\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_block_unspendable_amount += coin.out.nValue;\n+                    m_unspendables_scripts += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                if (tx->IsCoinBase()) {\n+                    m_block_coinbase_amount += coin.out.nValue;\n+                } else {\n+                    m_block_new_outputs_ex_coinbase_amount += coin.out.nValue;\n+                }\n+\n+                ++m_transaction_output_count;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (!tx->IsCoinBase()) {\n+                const auto& tx_undo{block_undo.vtxundo.at(i - 1)};\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin{tx_undo.vprevout[j]};\n+                    COutPoint outpoint{tx->vin[j].prevout.hash, tx->vin[j].prevout.n};\n+\n+                    m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                    m_block_prevout_spent_amount += coin.out.nValue;\n+\n+                    --m_transaction_output_count;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    } else {\n+        // genesis block\n+        m_block_unspendable_amount += block_subsidy;\n+        m_unspendables_genesis_block += block_subsidy;\n+    }\n+\n+    // If spent prevouts + block subsidy are still a higher amount than\n+    // new outputs + coinbase + current unspendable amount this means\n+    // the miner did not claim the full block reward. Unclaimed block\n+    // rewards are also unspendable.\n+    const CAmount unclaimed_rewards{(m_block_prevout_spent_amount + m_total_subsidy) - (m_block_new_outputs_ex_coinbase_amount + m_block_coinbase_amount + m_block_unspendable_amount)};\n+    m_block_unspendable_amount += unclaimed_rewards;\n+    m_unspendables_unclaimed_rewards += unclaimed_rewards;\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+    value.second.total_subsidy = m_total_subsidy;\n+    value.second.block_unspendable_amount = m_block_unspendable_amount;\n+    value.second.block_prevout_spent_amount = m_block_prevout_spent_amount;\n+    value.second.block_new_outputs_ex_coinbase_amount = m_block_new_outputs_ex_coinbase_amount;\n+    value.second.block_coinbase_amount = m_block_coinbase_amount;\n+    value.second.unspendables_genesis_block = m_unspendables_genesis_block;\n+    value.second.unspendables_bip30 = m_unspendables_bip30;\n+    value.second.unspendables_scripts = m_unspendables_scripts;\n+    value.second.unspendables_unclaimed_rewards = m_unspendables_unclaimed_rewards;\n+\n+    uint256 out;\n+    m_muhash.Finalize(out);\n+    value.second.muhash = out;\n+\n+    return m_db->Write(DBHeightKey(pindex->nHeight), value) && m_db->Write(DB_MUHASH, m_muhash);\n+}\n+\n+static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n+                                       const std::string& index_name,\n+                                       int start_height, int stop_height)\n+{\n+    DBHeightKey key{start_height};\n+    db_it.Seek(key);\n+\n+    for (int height = start_height; height <= stop_height; ++height) {\n+        if (!db_it.GetKey(key) || key.height != height) {\n+            return error(\"%s: unexpected key in %s: expected (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        std::pair<uint256, DBVal> value;\n+        if (!db_it.GetValue(value)) {\n+            return error(\"%s: unable to read value in %s at key (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        batch.Write(DBHashKey(value.first), std::move(value.second));\n+\n+        db_it.Next();\n+    }\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip)\n+{\n+    assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n+\n+    CDBBatch batch(*m_db);\n+    std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n+\n+    // During a reorg, we need to copy all hash digests for blocks that are\n+    // getting disconnected from the height index to the hash index so we can\n+    // still find them when the height index entries are overwritten.\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip->nHeight, current_tip->nHeight)) {\n+        return false;\n+    }\n+\n+    if (!m_db->WriteBatch(batch)) return false;\n+\n+    {\n+        LOCK(cs_main);\n+        CBlockIndex* iter_tip{g_chainman.m_blockman.LookupBlockIndex(current_tip->GetBlockHash())};\n+        const auto& consensus_params{Params().GetConsensus()};\n+\n+        do {\n+            CBlock block;\n+\n+            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                             __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+\n+            ReverseBlock(block, iter_tip);\n+\n+            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n+        } while (new_tip != iter_tip);\n+    }\n+\n+    return BaseIndex::Rewind(current_tip, new_tip);\n+}\n+\n+static bool LookUpOne(const CDBWrapper& db, const CBlockIndex* block_index, DBVal& result)\n+{\n+    // First check if the result is stored under the height index and the value\n+    // there matches the block hash. This should be the case if the block is on\n+    // the active chain.\n+    std::pair<uint256, DBVal> read_out;\n+    if (!db.Read(DBHeightKey(block_index->nHeight), read_out)) {\n+        return false;\n+    }\n+    if (read_out.first == block_index->GetBlockHash()) {\n+        result = std::move(read_out.second);\n+        return true;\n+    }\n+\n+    // If value at the height index corresponds to an different block, the\n+    // result will be stored in the hash index.\n+    return db.Read(DBHashKey(block_index->GetBlockHash()), result);\n+}\n+\n+bool CoinStatsIndex::LookUpStats(const CBlockIndex* block_index, CCoinsStats& coins_stats) const\n+{\n+    DBVal entry;\n+    if (!LookUpOne(*m_db, block_index, entry)) {\n+        return false;\n+    }\n+\n+    coins_stats.hashSerialized = entry.muhash;\n+    coins_stats.nTransactionOutputs = entry.transaction_output_count;\n+    coins_stats.nBogoSize = entry.bogo_size;\n+    coins_stats.nTotalAmount = entry.total_amount;\n+    coins_stats.total_subsidy = entry.total_subsidy;\n+    coins_stats.block_unspendable_amount = entry.block_unspendable_amount;\n+    coins_stats.block_prevout_spent_amount = entry.block_prevout_spent_amount;\n+    coins_stats.block_new_outputs_ex_coinbase_amount = entry.block_new_outputs_ex_coinbase_amount;\n+    coins_stats.block_coinbase_amount = entry.block_coinbase_amount;\n+    coins_stats.unspendables_genesis_block = entry.unspendables_genesis_block;\n+    coins_stats.unspendables_bip30 = entry.unspendables_bip30;\n+    coins_stats.unspendables_scripts = entry.unspendables_scripts;\n+    coins_stats.unspendables_unclaimed_rewards = entry.unspendables_unclaimed_rewards;\n+\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    if (!m_db->Read(DB_MUHASH, m_muhash)) {\n+        // Check that the cause of the read failure is that the key does not\n+        // exist. Any other errors indicate database corruption or a disk\n+        // failure, and starting the index would cause further corruption.\n+        if (m_db->Exists(DB_MUHASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+    }\n+\n+    if (BaseIndex::Init()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634095336",
      "id" : 634095336,
      "line" : 344,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDA5NTMzNg==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 344,
      "original_position" : 344,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 344,
      "pull_request_review_id" : 649806721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634095336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634104483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634104483"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Under what circumstance would this recovery condition be hit? Also, shouldn't the error message mention that this condition failed as well?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-18T07:10:09Z",
      "diff_hunk" : "@@ -0,0 +1,472 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <node/blockstorage.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634104483",
      "id" : 634104483,
      "line" : 125,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDEwNDQ4Mw==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 125,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 125,
      "pull_request_review_id" : 649806721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634104483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634104604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634104604"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Under what circumstance would this recovery condition be hit? Also, shouldn't the error message mention that this condition failed as well?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-18T07:10:21Z",
      "diff_hunk" : "@@ -0,0 +1,472 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <node/blockstorage.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block{(pindex->nHeight == 91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                            (pindex->nHeight == 91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"))};\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx.at(i)};\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out{tx->vout[j]};\n+                Coin coin{out, pindex->nHeight, tx->IsCoinBase()};\n+                COutPoint outpoint{tx->GetHash(), static_cast<uint32_t>(j)};\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_block_unspendable_amount += coin.out.nValue;\n+                    m_unspendables_scripts += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                if (tx->IsCoinBase()) {\n+                    m_block_coinbase_amount += coin.out.nValue;\n+                } else {\n+                    m_block_new_outputs_ex_coinbase_amount += coin.out.nValue;\n+                }\n+\n+                ++m_transaction_output_count;\n+                m_total_amount += coin.out.nValue;\n+                m_bogo_size += GetBogoSize(coin.out.scriptPubKey);\n+            }\n+\n+            // The coinbase tx has no undo data since no former output is spent\n+            if (!tx->IsCoinBase()) {\n+                const auto& tx_undo{block_undo.vtxundo.at(i - 1)};\n+\n+                for (size_t j = 0; j < tx_undo.vprevout.size(); ++j) {\n+                    Coin coin{tx_undo.vprevout[j]};\n+                    COutPoint outpoint{tx->vin[j].prevout.hash, tx->vin[j].prevout.n};\n+\n+                    m_muhash.Remove(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                    m_block_prevout_spent_amount += coin.out.nValue;\n+\n+                    --m_transaction_output_count;\n+                    m_total_amount -= coin.out.nValue;\n+                    m_bogo_size -= GetBogoSize(coin.out.scriptPubKey);\n+                }\n+            }\n+        }\n+    } else {\n+        // genesis block\n+        m_block_unspendable_amount += block_subsidy;\n+        m_unspendables_genesis_block += block_subsidy;\n+    }\n+\n+    // If spent prevouts + block subsidy are still a higher amount than\n+    // new outputs + coinbase + current unspendable amount this means\n+    // the miner did not claim the full block reward. Unclaimed block\n+    // rewards are also unspendable.\n+    const CAmount unclaimed_rewards{(m_block_prevout_spent_amount + m_total_subsidy) - (m_block_new_outputs_ex_coinbase_amount + m_block_coinbase_amount + m_block_unspendable_amount)};\n+    m_block_unspendable_amount += unclaimed_rewards;\n+    m_unspendables_unclaimed_rewards += unclaimed_rewards;\n+\n+    std::pair<uint256, DBVal> value;\n+    value.first = pindex->GetBlockHash();\n+    value.second.transaction_output_count = m_transaction_output_count;\n+    value.second.bogo_size = m_bogo_size;\n+    value.second.total_amount = m_total_amount;\n+    value.second.total_subsidy = m_total_subsidy;\n+    value.second.block_unspendable_amount = m_block_unspendable_amount;\n+    value.second.block_prevout_spent_amount = m_block_prevout_spent_amount;\n+    value.second.block_new_outputs_ex_coinbase_amount = m_block_new_outputs_ex_coinbase_amount;\n+    value.second.block_coinbase_amount = m_block_coinbase_amount;\n+    value.second.unspendables_genesis_block = m_unspendables_genesis_block;\n+    value.second.unspendables_bip30 = m_unspendables_bip30;\n+    value.second.unspendables_scripts = m_unspendables_scripts;\n+    value.second.unspendables_unclaimed_rewards = m_unspendables_unclaimed_rewards;\n+\n+    uint256 out;\n+    m_muhash.Finalize(out);\n+    value.second.muhash = out;\n+\n+    return m_db->Write(DBHeightKey(pindex->nHeight), value) && m_db->Write(DB_MUHASH, m_muhash);\n+}\n+\n+static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n+                                       const std::string& index_name,\n+                                       int start_height, int stop_height)\n+{\n+    DBHeightKey key{start_height};\n+    db_it.Seek(key);\n+\n+    for (int height = start_height; height <= stop_height; ++height) {\n+        if (!db_it.GetKey(key) || key.height != height) {\n+            return error(\"%s: unexpected key in %s: expected (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        std::pair<uint256, DBVal> value;\n+        if (!db_it.GetValue(value)) {\n+            return error(\"%s: unable to read value in %s at key (%c, %d)\",\n+                         __func__, index_name, DB_BLOCK_HEIGHT, height);\n+        }\n+\n+        batch.Write(DBHashKey(value.first), std::move(value.second));\n+\n+        db_it.Next();\n+    }\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_tip)\n+{\n+    assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n+\n+    CDBBatch batch(*m_db);\n+    std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n+\n+    // During a reorg, we need to copy all hash digests for blocks that are\n+    // getting disconnected from the height index to the hash index so we can\n+    // still find them when the height index entries are overwritten.\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip->nHeight, current_tip->nHeight)) {\n+        return false;\n+    }\n+\n+    if (!m_db->WriteBatch(batch)) return false;\n+\n+    {\n+        LOCK(cs_main);\n+        CBlockIndex* iter_tip{g_chainman.m_blockman.LookupBlockIndex(current_tip->GetBlockHash())};\n+        const auto& consensus_params{Params().GetConsensus()};\n+\n+        do {\n+            CBlock block;\n+\n+            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n+                return error(\"%s: Failed to read block %s from disk\",\n+                             __func__, iter_tip->GetBlockHash().ToString());\n+            }\n+\n+            ReverseBlock(block, iter_tip);\n+\n+            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n+        } while (new_tip != iter_tip);\n+    }\n+\n+    return BaseIndex::Rewind(current_tip, new_tip);\n+}\n+\n+static bool LookUpOne(const CDBWrapper& db, const CBlockIndex* block_index, DBVal& result)\n+{\n+    // First check if the result is stored under the height index and the value\n+    // there matches the block hash. This should be the case if the block is on\n+    // the active chain.\n+    std::pair<uint256, DBVal> read_out;\n+    if (!db.Read(DBHeightKey(block_index->nHeight), read_out)) {\n+        return false;\n+    }\n+    if (read_out.first == block_index->GetBlockHash()) {\n+        result = std::move(read_out.second);\n+        return true;\n+    }\n+\n+    // If value at the height index corresponds to an different block, the\n+    // result will be stored in the hash index.\n+    return db.Read(DBHashKey(block_index->GetBlockHash()), result);\n+}\n+\n+bool CoinStatsIndex::LookUpStats(const CBlockIndex* block_index, CCoinsStats& coins_stats) const\n+{\n+    DBVal entry;\n+    if (!LookUpOne(*m_db, block_index, entry)) {\n+        return false;\n+    }\n+\n+    coins_stats.hashSerialized = entry.muhash;\n+    coins_stats.nTransactionOutputs = entry.transaction_output_count;\n+    coins_stats.nBogoSize = entry.bogo_size;\n+    coins_stats.nTotalAmount = entry.total_amount;\n+    coins_stats.total_subsidy = entry.total_subsidy;\n+    coins_stats.block_unspendable_amount = entry.block_unspendable_amount;\n+    coins_stats.block_prevout_spent_amount = entry.block_prevout_spent_amount;\n+    coins_stats.block_new_outputs_ex_coinbase_amount = entry.block_new_outputs_ex_coinbase_amount;\n+    coins_stats.block_coinbase_amount = entry.block_coinbase_amount;\n+    coins_stats.unspendables_genesis_block = entry.unspendables_genesis_block;\n+    coins_stats.unspendables_bip30 = entry.unspendables_bip30;\n+    coins_stats.unspendables_scripts = entry.unspendables_scripts;\n+    coins_stats.unspendables_unclaimed_rewards = entry.unspendables_unclaimed_rewards;\n+\n+    return true;\n+}\n+\n+bool CoinStatsIndex::Init()\n+{\n+    if (!m_db->Read(DB_MUHASH, m_muhash)) {\n+        // Check that the cause of the read failure is that the key does not\n+        // exist. Any other errors indicate database corruption or a disk\n+        // failure, and starting the index would cause further corruption.\n+        if (m_db->Exists(DB_MUHASH)) {\n+            return error(\"%s: Cannot read current %s state; index may be corrupted\",\n+                         __func__, GetName());\n+        }\n+    }\n+\n+    if (BaseIndex::Init()) {\n+        const CBlockIndex* pindex{CurrentIndex()};\n+\n+        if (pindex) {\n+            DBVal entry;\n+            if (!LookUpOne(*m_db, pindex, entry)) {\n+                return false;\n+            }\n+\n+            m_transaction_output_count = entry.transaction_output_count;\n+            m_bogo_size = entry.bogo_size;\n+            m_total_amount = entry.total_amount;\n+            m_total_subsidy = entry.total_subsidy;\n+            m_block_unspendable_amount = entry.block_unspendable_amount;\n+            m_block_prevout_spent_amount = entry.block_prevout_spent_amount;\n+            m_block_new_outputs_ex_coinbase_amount = entry.block_new_outputs_ex_coinbase_amount;\n+            m_block_coinbase_amount = entry.block_coinbase_amount;\n+            m_unspendables_genesis_block = entry.unspendables_genesis_block;\n+            m_unspendables_bip30 = entry.unspendables_bip30;\n+            m_unspendables_scripts = entry.unspendables_scripts;\n+            m_unspendables_unclaimed_rewards = entry.unspendables_unclaimed_rewards;\n+        }\n+\n+        return true;\n+    }\n+\n+    return false;\n+}\n+\n+// Reverse a single block as part of a reorg\n+bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    std::pair<uint256, DBVal> read_out;\n+\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy -= block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634104604",
      "id" : 634104604,
      "line" : 394,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDEwNDYwNA==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 394,
      "original_position" : 394,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 394,
      "pull_request_review_id" : 649806721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634104604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634106089"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634106089"
         }
      },
      "author_association" : "MEMBER",
      "body" : "missing `{}` :sweat_smile: ",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-18T07:12:47Z",
      "diff_hunk" : "@@ -947,10 +956,12 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         nLocalServices = ServiceFlags(nLocalServices | NODE_COMPACT_FILTERS);\n     }\n \n-    // if using block pruning, then disallow txindex\n+    // if using block pruning, then disallow txindex and coinstatsindex\n     if (args.GetArg(\"-prune\", 0)) {\n         if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX))\n             return InitError(_(\"Prune mode is incompatible with -txindex.\"));\n+        if (args.GetBoolArg(\"-coinstatsindex\", DEFAULT_COINSTATSINDEX))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634106089",
      "id" : 634106089,
      "line" : 963,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDEwNjA4OQ==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 963,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 55,
      "pull_request_review_id" : 649806721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634106089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634165852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634165852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why is this needed? (sync_all should call syncwithvalidationinterface). Also, if it didn't, shouldn't the index RPC call syncwithvalidationinterface internally by itself, similar to how the wallet does it?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-18T08:35:24Z",
      "diff_hunk" : "@@ -0,0 +1,313 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test coinstatsindex across nodes.\n+\n+Test that the values returned by gettxoutsetinfo are consistent\n+between a node running the coinstatsindex and a node without\n+the index.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n+from test_framework.messages import (\n+    COIN,\n+    COutPoint,\n+    CTransaction,\n+    CTxIn,\n+    CTxOut,\n+    ToHex,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_FALSE,\n+    OP_RETURN,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+    try_rpc,\n+)\n+\n+class CoinStatsIndexTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.supports_cli = False\n+        self.extra_args = [\n+            [],\n+            [\"-coinstatsindex\"]\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self._test_coin_stats_index()\n+        self._test_use_index_option()\n+        self._test_reorg_index()\n+        self._test_index_rejects_hash_serialized()\n+\n+    def block_sanity_check(self, block_info):\n+        block_subsidy = 50\n+        assert_equal(\n+            block_info['prevout_spent'] + block_subsidy,\n+            block_info['new_outputs_ex_coinbase'] + block_info['coinbase'] + block_info['unspendable']\n+        )\n+\n+    def _test_coin_stats_index(self):\n+        node = self.nodes[0]\n+        index_node = self.nodes[1]\n+        # Both none and muhash options allow the usage of the index\n+        index_hash_options = ['none', 'muhash']\n+\n+        # Generate a normal transaction and mine it\n+        node.generate(101)\n+        address = self.nodes[0].get_deterministic_priv_key().address\n+        node.sendtoaddress(address=address, amount=10, subtractfeefromamount=True)\n+        node.generate(1)\n+\n+        self.sync_blocks(timeout=120)\n+\n+        self.log.info(\"Test that gettxoutsetinfo() output is consistent with or without coinstatsindex option\")\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", node.gettxoutsetinfo))\n+        res0 = node.gettxoutsetinfo('none')\n+\n+        # The fields 'disk_size' and 'transactions' do not exist on the index\n+        del res0['disk_size'], res0['transactions']\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        for hash_option in index_hash_options:\n+            res1 = index_node.gettxoutsetinfo(hash_option)\n+            # The fields 'block_info' and 'total_unspendable_amount' only exist on the index\n+            del res1['block_info'], res1['total_unspendable_amount']\n+            res1.pop('muhash', None)\n+\n+            # Everything left should be the same\n+            assert_equal(res1, res0)\n+\n+        self.log.info(\"Test that gettxoutsetinfo() can get fetch data on specific heights with index\")\n+\n+        # Generate a new tip\n+        node.generate(5)\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        for hash_option in index_hash_options:\n+            # Fetch old stats by height\n+            res2 = index_node.gettxoutsetinfo(hash_option, 102)\n+            del res2['block_info'], res2['total_unspendable_amount']\n+            res2.pop('muhash', None)\n+            assert_equal(res0, res2)\n+\n+            # Fetch old stats by hash\n+            res3 = index_node.gettxoutsetinfo(hash_option, res0['bestblock'])\n+            del res3['block_info'], res3['total_unspendable_amount']\n+            res3.pop('muhash', None)\n+            assert_equal(res0, res3)\n+\n+            # It does not work without coinstatsindex\n+            assert_raises_rpc_error(-8, \"Querying specific block heights requires coinstatsindex\", node.gettxoutsetinfo, hash_option, 102)\n+\n+        self.log.info(\"Test gettxoutsetinfo() with index and verbose flag\")\n+\n+        for hash_option in index_hash_options:\n+            # Genesis block is unspendable\n+            res4 = index_node.gettxoutsetinfo(hash_option, 0)\n+            assert_equal(res4['total_unspendable_amount'], 50)\n+            assert_equal(res4['block_info'], {\n+                'unspendable': 50,\n+                'prevout_spent': 0,\n+                'new_outputs_ex_coinbase': 0,\n+                'coinbase': 0,\n+                'unspendables': {\n+                    'genesis_block': 50,\n+                    'bip30': 0,\n+                    'scripts': 0,\n+                    'unclaimed_rewards': 0\n+                }\n+            })\n+            self.block_sanity_check(res4['block_info'])\n+\n+            # Test an older block height that included a normal tx\n+            res5 = index_node.gettxoutsetinfo(hash_option, 102)\n+            assert_equal(res5['total_unspendable_amount'], 50)\n+            assert_equal(res5['block_info'], {\n+                'unspendable': 0,\n+                'prevout_spent': 50,\n+                'new_outputs_ex_coinbase': Decimal('49.99995560'),\n+                'coinbase': Decimal('50.00004440'),\n+                'unspendables': {\n+                    'genesis_block': 0,\n+                    'bip30': 0,\n+                    'scripts': 0,\n+                    'unclaimed_rewards': 0\n+                }\n+            })\n+            self.block_sanity_check(res5['block_info'])\n+\n+        # Generate and send a normal tx with two outputs\n+        tx1_inputs = []\n+        tx1_outputs = {self.nodes[0].getnewaddress(): 21, self.nodes[0].getnewaddress(): 42}\n+        raw_tx1 = self.nodes[0].createrawtransaction(tx1_inputs, tx1_outputs)\n+        funded_tx1 = self.nodes[0].fundrawtransaction(raw_tx1)\n+        signed_tx1 = self.nodes[0].signrawtransactionwithwallet(funded_tx1['hex'])\n+        tx1_txid = self.nodes[0].sendrawtransaction(signed_tx1['hex'])\n+\n+        # Find the right position of the 21 BTC output\n+        tx1_final = self.nodes[0].gettransaction(tx1_txid)\n+        for output in tx1_final['details']:\n+            if output['amount'] == Decimal('21.00000000') and output['category'] == 'receive':\n+                n = output['vout']\n+\n+        # Generate and send another tx with an OP_RETURN output (which is unspendable)\n+        tx2 = CTransaction()\n+        tx2.vin.append(CTxIn(COutPoint(int(tx1_txid, 16), n), b''))\n+        tx2.vout.append(CTxOut(int(20.99 * COIN), CScript([OP_RETURN] + [OP_FALSE]*30)))\n+        tx2_hex = self.nodes[0].signrawtransactionwithwallet(ToHex(tx2))['hex']\n+        self.nodes[0].sendrawtransaction(tx2_hex)\n+\n+        # Include both txs in a block\n+        self.nodes[0].generate(1)\n+        self.sync_all()\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        for hash_option in index_hash_options:\n+            # Check all amounts were registered correctly\n+            res6 = index_node.gettxoutsetinfo(hash_option, 108)\n+            assert_equal(res6['total_unspendable_amount'], Decimal('70.98999999'))\n+            assert_equal(res6['block_info'], {\n+                'unspendable': Decimal('20.98999999'),\n+                'prevout_spent': 111,\n+                'new_outputs_ex_coinbase': Decimal('89.99993620'),\n+                'coinbase': Decimal('50.01006381'),\n+                'unspendables': {\n+                    'genesis_block': 0,\n+                    'bip30': 0,\n+                    'scripts': Decimal('20.98999999'),\n+                    'unclaimed_rewards': 0\n+                }\n+            })\n+            self.block_sanity_check(res6['block_info'])\n+\n+        # Create a coinbase that does not claim full subsidy and also\n+        # has two outputs\n+        cb = create_coinbase(109, nValue=35)\n+        cb.vout.append(CTxOut(5 * COIN, CScript([OP_FALSE])))\n+        cb.rehash()\n+\n+        # Generate a block that includes previous coinbase\n+        tip = self.nodes[0].getbestblockhash()\n+        block_time = self.nodes[0].getblock(tip)['time'] + 1\n+        block = create_block(int(tip, 16), cb, block_time)\n+        block.solve()\n+        self.nodes[0].submitblock(ToHex(block))\n+        self.sync_all()\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634165852",
      "id" : 634165852,
      "line" : 212,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDE2NTg1Mg==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 212,
      "original_position" : 212,
      "original_start_line" : null,
      "path" : "test/functional/feature_coinstatsindex.py",
      "position" : 212,
      "pull_request_review_id" : 649806721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634165852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634169745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634169745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Empty string as documentation? Would be nice to explain this a bit better. Does it include unspendable outputs ...?",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-18T08:40:13Z",
      "diff_hunk" : "@@ -1068,50 +1096,88 @@ static RPCHelpMan gettxoutsetinfo()\n {\n     return RPCHelpMan{\"gettxoutsetinfo\",\n                 \"\\nReturns statistics about the unspent transaction output set.\\n\"\n-                \"Note this call may take some time.\\n\",\n+                \"Note this call may take some time if you are not using coinstatsindex.\\n\",\n                 {\n                     {\"hash_type\", RPCArg::Type::STR, RPCArg::Default{\"hash_serialized_2\"}, \"Which UTXO set hash should be calculated. Options: 'hash_serialized_2' (the legacy algorithm), 'muhash', 'none'.\"},\n+                    {\"hash_or_height\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"The block hash or height of the target height (only available with coinstatsindex)\", \"\", {\"\", \"string or numeric\"}},\n+                    {\"use_index\", RPCArg::Type::BOOL, RPCArg::Default{true}, \"Use coinstatsindex, if available.\"},\n                 },\n                 RPCResult{\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"height\", \"The block height (index) of the returned statistics\"},\n                         {RPCResult::Type::STR_HEX, \"bestblock\", \"The hash of the block at which these statistics are calculated\"},\n-                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs\"},\n                         {RPCResult::Type::NUM, \"txouts\", \"The number of unspent transaction outputs\"},\n-                        {RPCResult::Type::NUM, \"bogosize\", \"A meaningless metric for UTXO set size\"},\n+                        {RPCResult::Type::NUM, \"bogosize\", \"Database-independent, meaningless metric indicating the UTXO set size\"},\n                         {RPCResult::Type::STR_HEX, \"hash_serialized_2\", /* optional */ true, \"The serialized hash (only present if 'hash_serialized_2' hash_type is chosen)\"},\n                         {RPCResult::Type::STR_HEX, \"muhash\", /* optional */ true, \"The serialized hash (only present if 'muhash' hash_type is chosen)\"},\n-                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk\"},\n+                        {RPCResult::Type::NUM, \"transactions\", \"The number of transactions with unspent outputs (not available when coinstatsindex is used)\"},\n+                        {RPCResult::Type::NUM, \"disk_size\", \"The estimated size of the chainstate on disk (not available when coinstatsindex is used)\"},\n                         {RPCResult::Type::STR_AMOUNT, \"total_amount\", \"The total amount of coins in the UTXO set\"},\n+                        {RPCResult::Type::STR_AMOUNT, \"total_unspendable_amount\", \"The total amount of coins permanently excluded from the UTXO set (only available if coinstatsindex is used)\"},\n+                        {RPCResult::Type::OBJ, \"block_info\", \"Info on amounts in the block at this block height (only available if coinstatsindex is used)\",\n+                        {\n+                            {RPCResult::Type::STR_AMOUNT, \"prevout_spent\", \"\"},\n+                            {RPCResult::Type::STR_AMOUNT, \"coinbase\", \"\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r634169745",
      "id" : 634169745,
      "line" : 1121,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDE2OTc0NQ==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 1121,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 72,
      "pull_request_review_id" : 649806721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634169745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r638163118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638163118"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hopefully removed soon anyway with #21726 :)",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-24T18:08:27Z",
      "diff_hunk" : "@@ -947,10 +956,12 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         nLocalServices = ServiceFlags(nLocalServices | NODE_COMPACT_FILTERS);\n     }\n \n-    // if using block pruning, then disallow txindex\n+    // if using block pruning, then disallow txindex and coinstatsindex\n     if (args.GetArg(\"-prune\", 0)) {\n         if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX))\n             return InitError(_(\"Prune mode is incompatible with -txindex.\"));\n+        if (args.GetBoolArg(\"-coinstatsindex\", DEFAULT_COINSTATSINDEX))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r638163118",
      "id" : 638163118,
      "in_reply_to_id" : 634106089,
      "line" : 963,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODE2MzExOA==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 963,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 55,
      "pull_request_review_id" : 667026483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T18:08:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638163118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r638164201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638164201"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yepp, it used to be per block, but the names were not changed when the values were changed to track totals.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-24T18:10:35Z",
      "diff_hunk" : "@@ -0,0 +1,472 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <node/blockstorage.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {\n+                return error(\"%s: previous block header belongs to unexpected block %s; expected %s\",\n+                             __func__, read_out.first.ToString(), expected_block_hash.ToString());\n+            }\n+        }\n+\n+        // TODO: Deduplicate BIP30 related code\n+        bool is_bip30_block{(pindex->nHeight == 91722 && pindex->GetBlockHash() == uint256S(\"0x00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e\")) ||\n+                            (pindex->nHeight == 91812 && pindex->GetBlockHash() == uint256S(\"0x00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f\"))};\n+\n+        // Add the new utxos created from the block\n+        for (size_t i = 0; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx.at(i)};\n+\n+            // Skip duplicate txid coinbase transactions (BIP30).\n+            if (is_bip30_block && tx->IsCoinBase()) {\n+                m_block_unspendable_amount += block_subsidy;\n+                m_unspendables_bip30 += block_subsidy;\n+                continue;\n+            }\n+\n+            for (size_t j = 0; j < tx->vout.size(); ++j) {\n+                const CTxOut& out{tx->vout[j]};\n+                Coin coin{out, pindex->nHeight, tx->IsCoinBase()};\n+                COutPoint outpoint{tx->GetHash(), static_cast<uint32_t>(j)};\n+\n+                // Skip unspendable coins\n+                if (coin.out.scriptPubKey.IsUnspendable()) {\n+                    m_block_unspendable_amount += coin.out.nValue;\n+                    m_unspendables_scripts += coin.out.nValue;\n+                    continue;\n+                }\n+\n+                m_muhash.Insert(MakeUCharSpan(TxOutSer(outpoint, coin)));\n+\n+                if (tx->IsCoinBase()) {\n+                    m_block_coinbase_amount += coin.out.nValue;\n+                } else {\n+                    m_block_new_outputs_ex_coinbase_amount += coin.out.nValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r638164201",
      "id" : 638164201,
      "in_reply_to_id" : 634085868,
      "line" : 163,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODE2NDIwMQ==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 163,
      "original_position" : 163,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 163,
      "pull_request_review_id" : 667027934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T18:10:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638164201",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r638164626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638164626"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "True, I missed the option to use the `BlockUntilSynced...` function from BaseIndex. ",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-24T18:11:25Z",
      "diff_hunk" : "@@ -0,0 +1,313 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test coinstatsindex across nodes.\n+\n+Test that the values returned by gettxoutsetinfo are consistent\n+between a node running the coinstatsindex and a node without\n+the index.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n+from test_framework.messages import (\n+    COIN,\n+    COutPoint,\n+    CTransaction,\n+    CTxIn,\n+    CTxOut,\n+    ToHex,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_FALSE,\n+    OP_RETURN,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+    try_rpc,\n+)\n+\n+class CoinStatsIndexTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.supports_cli = False\n+        self.extra_args = [\n+            [],\n+            [\"-coinstatsindex\"]\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self._test_coin_stats_index()\n+        self._test_use_index_option()\n+        self._test_reorg_index()\n+        self._test_index_rejects_hash_serialized()\n+\n+    def block_sanity_check(self, block_info):\n+        block_subsidy = 50\n+        assert_equal(\n+            block_info['prevout_spent'] + block_subsidy,\n+            block_info['new_outputs_ex_coinbase'] + block_info['coinbase'] + block_info['unspendable']\n+        )\n+\n+    def _test_coin_stats_index(self):\n+        node = self.nodes[0]\n+        index_node = self.nodes[1]\n+        # Both none and muhash options allow the usage of the index\n+        index_hash_options = ['none', 'muhash']\n+\n+        # Generate a normal transaction and mine it\n+        node.generate(101)\n+        address = self.nodes[0].get_deterministic_priv_key().address\n+        node.sendtoaddress(address=address, amount=10, subtractfeefromamount=True)\n+        node.generate(1)\n+\n+        self.sync_blocks(timeout=120)\n+\n+        self.log.info(\"Test that gettxoutsetinfo() output is consistent with or without coinstatsindex option\")\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", node.gettxoutsetinfo))\n+        res0 = node.gettxoutsetinfo('none')\n+\n+        # The fields 'disk_size' and 'transactions' do not exist on the index\n+        del res0['disk_size'], res0['transactions']\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        for hash_option in index_hash_options:\n+            res1 = index_node.gettxoutsetinfo(hash_option)\n+            # The fields 'block_info' and 'total_unspendable_amount' only exist on the index\n+            del res1['block_info'], res1['total_unspendable_amount']\n+            res1.pop('muhash', None)\n+\n+            # Everything left should be the same\n+            assert_equal(res1, res0)\n+\n+        self.log.info(\"Test that gettxoutsetinfo() can get fetch data on specific heights with index\")\n+\n+        # Generate a new tip\n+        node.generate(5)\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        for hash_option in index_hash_options:\n+            # Fetch old stats by height\n+            res2 = index_node.gettxoutsetinfo(hash_option, 102)\n+            del res2['block_info'], res2['total_unspendable_amount']\n+            res2.pop('muhash', None)\n+            assert_equal(res0, res2)\n+\n+            # Fetch old stats by hash\n+            res3 = index_node.gettxoutsetinfo(hash_option, res0['bestblock'])\n+            del res3['block_info'], res3['total_unspendable_amount']\n+            res3.pop('muhash', None)\n+            assert_equal(res0, res3)\n+\n+            # It does not work without coinstatsindex\n+            assert_raises_rpc_error(-8, \"Querying specific block heights requires coinstatsindex\", node.gettxoutsetinfo, hash_option, 102)\n+\n+        self.log.info(\"Test gettxoutsetinfo() with index and verbose flag\")\n+\n+        for hash_option in index_hash_options:\n+            # Genesis block is unspendable\n+            res4 = index_node.gettxoutsetinfo(hash_option, 0)\n+            assert_equal(res4['total_unspendable_amount'], 50)\n+            assert_equal(res4['block_info'], {\n+                'unspendable': 50,\n+                'prevout_spent': 0,\n+                'new_outputs_ex_coinbase': 0,\n+                'coinbase': 0,\n+                'unspendables': {\n+                    'genesis_block': 50,\n+                    'bip30': 0,\n+                    'scripts': 0,\n+                    'unclaimed_rewards': 0\n+                }\n+            })\n+            self.block_sanity_check(res4['block_info'])\n+\n+            # Test an older block height that included a normal tx\n+            res5 = index_node.gettxoutsetinfo(hash_option, 102)\n+            assert_equal(res5['total_unspendable_amount'], 50)\n+            assert_equal(res5['block_info'], {\n+                'unspendable': 0,\n+                'prevout_spent': 50,\n+                'new_outputs_ex_coinbase': Decimal('49.99995560'),\n+                'coinbase': Decimal('50.00004440'),\n+                'unspendables': {\n+                    'genesis_block': 0,\n+                    'bip30': 0,\n+                    'scripts': 0,\n+                    'unclaimed_rewards': 0\n+                }\n+            })\n+            self.block_sanity_check(res5['block_info'])\n+\n+        # Generate and send a normal tx with two outputs\n+        tx1_inputs = []\n+        tx1_outputs = {self.nodes[0].getnewaddress(): 21, self.nodes[0].getnewaddress(): 42}\n+        raw_tx1 = self.nodes[0].createrawtransaction(tx1_inputs, tx1_outputs)\n+        funded_tx1 = self.nodes[0].fundrawtransaction(raw_tx1)\n+        signed_tx1 = self.nodes[0].signrawtransactionwithwallet(funded_tx1['hex'])\n+        tx1_txid = self.nodes[0].sendrawtransaction(signed_tx1['hex'])\n+\n+        # Find the right position of the 21 BTC output\n+        tx1_final = self.nodes[0].gettransaction(tx1_txid)\n+        for output in tx1_final['details']:\n+            if output['amount'] == Decimal('21.00000000') and output['category'] == 'receive':\n+                n = output['vout']\n+\n+        # Generate and send another tx with an OP_RETURN output (which is unspendable)\n+        tx2 = CTransaction()\n+        tx2.vin.append(CTxIn(COutPoint(int(tx1_txid, 16), n), b''))\n+        tx2.vout.append(CTxOut(int(20.99 * COIN), CScript([OP_RETURN] + [OP_FALSE]*30)))\n+        tx2_hex = self.nodes[0].signrawtransactionwithwallet(ToHex(tx2))['hex']\n+        self.nodes[0].sendrawtransaction(tx2_hex)\n+\n+        # Include both txs in a block\n+        self.nodes[0].generate(1)\n+        self.sync_all()\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))\n+        for hash_option in index_hash_options:\n+            # Check all amounts were registered correctly\n+            res6 = index_node.gettxoutsetinfo(hash_option, 108)\n+            assert_equal(res6['total_unspendable_amount'], Decimal('70.98999999'))\n+            assert_equal(res6['block_info'], {\n+                'unspendable': Decimal('20.98999999'),\n+                'prevout_spent': 111,\n+                'new_outputs_ex_coinbase': Decimal('89.99993620'),\n+                'coinbase': Decimal('50.01006381'),\n+                'unspendables': {\n+                    'genesis_block': 0,\n+                    'bip30': 0,\n+                    'scripts': Decimal('20.98999999'),\n+                    'unclaimed_rewards': 0\n+                }\n+            })\n+            self.block_sanity_check(res6['block_info'])\n+\n+        # Create a coinbase that does not claim full subsidy and also\n+        # has two outputs\n+        cb = create_coinbase(109, nValue=35)\n+        cb.vout.append(CTxOut(5 * COIN, CScript([OP_FALSE])))\n+        cb.rehash()\n+\n+        # Generate a block that includes previous coinbase\n+        tip = self.nodes[0].getbestblockhash()\n+        block_time = self.nodes[0].getblock(tip)['time'] + 1\n+        block = create_block(int(tip, 16), cb, block_time)\n+        block.solve()\n+        self.nodes[0].submitblock(ToHex(block))\n+        self.sync_all()\n+\n+        self.wait_until(lambda: not try_rpc(-32603, \"Unable to read UTXO set\", index_node.gettxoutsetinfo, 'muhash'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r638164626",
      "id" : 638164626,
      "in_reply_to_id" : 634165852,
      "line" : 212,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODE2NDYyNg==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 212,
      "original_position" : 212,
      "original_start_line" : null,
      "path" : "test/functional/feature_coinstatsindex.py",
      "position" : 212,
      "pull_request_review_id" : 667028492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T18:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638164626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r638165428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638165428"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This could happen if there is a reorg that the index has not picked up on yet, so the hash returned from the height index is not on the active chain anymore. I added a warning logging and changed the `error()` message to be more accurate.",
      "commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "created_at" : "2021-05-24T18:13:02Z",
      "diff_hunk" : "@@ -0,0 +1,472 @@\n+// Copyright (c) 2020-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <crypto/muhash.h>\n+#include <index/coinstatsindex.h>\n+#include <node/blockstorage.h>\n+#include <serialize.h>\n+#include <txdb.h>\n+#include <undo.h>\n+#include <validation.h>\n+\n+static constexpr char DB_BLOCK_HASH = 's';\n+static constexpr char DB_BLOCK_HEIGHT = 't';\n+static constexpr char DB_MUHASH = 'M';\n+\n+namespace {\n+\n+struct DBVal {\n+    uint256 muhash;\n+    uint64_t transaction_output_count;\n+    uint64_t bogo_size;\n+    CAmount total_amount;\n+    CAmount total_subsidy;\n+    CAmount block_unspendable_amount;\n+    CAmount block_prevout_spent_amount;\n+    CAmount block_new_outputs_ex_coinbase_amount;\n+    CAmount block_coinbase_amount;\n+    CAmount unspendables_genesis_block;\n+    CAmount unspendables_bip30;\n+    CAmount unspendables_scripts;\n+    CAmount unspendables_unclaimed_rewards;\n+\n+    SERIALIZE_METHODS(DBVal, obj)\n+    {\n+        READWRITE(obj.muhash);\n+        READWRITE(obj.transaction_output_count);\n+        READWRITE(obj.bogo_size);\n+        READWRITE(obj.total_amount);\n+        READWRITE(obj.total_subsidy);\n+        READWRITE(obj.block_unspendable_amount);\n+        READWRITE(obj.block_prevout_spent_amount);\n+        READWRITE(obj.block_new_outputs_ex_coinbase_amount);\n+        READWRITE(obj.block_coinbase_amount);\n+        READWRITE(obj.unspendables_genesis_block);\n+        READWRITE(obj.unspendables_bip30);\n+        READWRITE(obj.unspendables_scripts);\n+        READWRITE(obj.unspendables_unclaimed_rewards);\n+    }\n+};\n+\n+struct DBHeightKey {\n+    int height;\n+\n+    explicit DBHeightKey(int height_in) : height(height_in) {}\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s) const\n+    {\n+        ser_writedata8(s, DB_BLOCK_HEIGHT);\n+        ser_writedata32be(s, height);\n+    }\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s)\n+    {\n+        char prefix{static_cast<char>(ser_readdata8(s))};\n+        if (prefix != DB_BLOCK_HEIGHT) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB height key\");\n+        }\n+        height = ser_readdata32be(s);\n+    }\n+};\n+\n+struct DBHashKey {\n+    uint256 block_hash;\n+\n+    explicit DBHashKey(const uint256& hash_in) : block_hash(hash_in) {}\n+\n+    SERIALIZE_METHODS(DBHashKey, obj)\n+    {\n+        char prefix{DB_BLOCK_HASH};\n+        READWRITE(prefix);\n+        if (prefix != DB_BLOCK_HASH) {\n+            throw std::ios_base::failure(\"Invalid format for coinstatsindex DB hash key\");\n+        }\n+\n+        READWRITE(obj.block_hash);\n+    }\n+};\n+\n+}; // namespace\n+\n+std::unique_ptr<CoinStatsIndex> g_coin_stats_index;\n+\n+CoinStatsIndex::CoinStatsIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+{\n+    fs::path path{GetDataDir() / \"indexes\" / \"coinstats\"};\n+    fs::create_directories(path);\n+\n+    m_db = std::make_unique<CoinStatsIndex::DB>(path / \"db\", n_cache_size, f_memory, f_wipe);\n+}\n+\n+bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    const CAmount block_subsidy{GetBlockSubsidy(pindex->nHeight, Params().GetConsensus())};\n+    m_total_subsidy += block_subsidy;\n+\n+    // Ignore genesis block\n+    if (pindex->nHeight > 0) {\n+        if (!UndoReadFromDisk(block_undo, pindex)) {\n+            return false;\n+        }\n+\n+        std::pair<uint256, DBVal> read_out;\n+        if (!m_db->Read(DBHeightKey(pindex->nHeight - 1), read_out)) {\n+            return false;\n+        }\n+\n+        uint256 expected_block_hash{pindex->pprev->GetBlockHash()};\n+        if (read_out.first != expected_block_hash) {\n+            if (!m_db->Read(DBHashKey(expected_block_hash), read_out)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#discussion_r638165428",
      "id" : 638165428,
      "in_reply_to_id" : 634104483,
      "line" : 125,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODE2NTQyOA==",
      "original_commit_id" : "5f96d7d22d8e05876c6fc014e70488699950fe38",
      "original_line" : 125,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 125,
      "pull_request_review_id" : 667029630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19521",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T18:13:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638165428",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @MarcoFalke , all comments should be addressed in #22047 aside from the init arg brackets which should be made redundant with #21726.",
      "created_at" : "2021-05-24T18:17:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19521#issuecomment-847238235",
      "id" : 847238235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19521",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NzIzODIzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-24T18:17:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847238235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
