{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "TLDR: We are generally explicit about the hardening related flags we use, \r\nrather than letting the distro / toolchain decide via their defaults. This PR\r\nadds `-z,separate-code` which has been enabled by default for Linux targets\r\n since binutils 2.31. Ubuntu Bionic (currently used for gitian) ships with\r\nbinutils 2.30, so this will enable the option for those builds.\r\n\r\nThis flag was added to binutils/ld in the 2.30 release, \r\nsee commit c11c786f0b45617bb8807ab6a57220d5ff50e414:\r\n\r\n> The new \"-z separate-code\" option will generate separate code LOAD\r\nsegment which must be in wholly disjoint pages from any other data.\r\n\r\nIt was made the default for Linux/x86 targets in the 2.31 release, see commit\r\nf6aec96dce1ddbd8961a3aa8a2925db2021719bb:\r\n\r\n> This patch adds --enable-separate-code to ld configure to turn on\r\n-z separate-code by default and enables it by default for Linux/x86.\r\nThis avoids mixing code pages with data to improve cache performance\r\nas well as security.\r\n\r\n> To reduce x86-64 executable and shared object sizes, the maximum page\r\nsize is reduced from 2MB to 4KB when -z separate-code is turned on by\r\ndefault.  Note: -z max-page-size= can be used to set the maximum page\r\nsize.\r\n\r\n> We compared SPEC CPU 2017 performance before and after this change on\r\nSkylake server.  There are no any significant performance changes.\r\nEverything is mostly below +/-1%.\r\n\r\nSupport was also added to LLVMs lld: https://reviews.llvm.org/D64903, however\r\nthere it remains off by default.\r\n\r\nThere were concerns about an increase in binary size, however in our case, the\r\ndifference would seem negligible, given we are shipping a\r\nmulti-megabyte binary, which then downloads 100's of GBs of data.\r\n\r\nAlso note that most recent versions of distros are shipping a new enough version\r\nof binutils that this is available and/or already on by default (assuming the distro \r\nhas not turned it off, I haven't checked everywhere):\r\n\r\nCentOS 8: 2.30\r\nDebian Buster 2.31.1\r\nFedora 29: 2.31.1\r\nFreeBSD: 2.33\r\nGNU Guix: 2.33 / 2.34\r\nUbuntu 18.04: 2.30\r\n\r\nRelated threads / discussion:\r\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1623218\r\n\r\nThe ELF header when building on Debian Buster (where it's already enabled by default in binutils):\r\n```bash\r\nProgram Header:\r\n    PHDR off    0x0000000000000040 vaddr 0x0000000000000040 paddr 0x0000000000000040 align 2**3\r\n         filesz 0x00000000000002a0 memsz 0x00000000000002a0 flags r--\r\n  INTERP off    0x00000000000002e0 vaddr 0x00000000000002e0 paddr 0x00000000000002e0 align 2**0\r\n         filesz 0x000000000000001c memsz 0x000000000000001c flags r--\r\n    LOAD off    0x0000000000000000 vaddr 0x0000000000000000 paddr 0x0000000000000000 align 2**12\r\n         filesz 0x0000000000038f10 memsz 0x0000000000038f10 flags r--\r\n    LOAD off    0x0000000000039000 vaddr 0x0000000000039000 paddr 0x0000000000039000 align 2**12\r\n         filesz 0x00000000006b9389 memsz 0x00000000006b9389 flags r-x\r\n    LOAD off    0x00000000006f3000 vaddr 0x00000000006f3000 paddr 0x00000000006f3000 align 2**12\r\n         filesz 0x0000000000204847 memsz 0x0000000000204847 flags r--\r\n    LOAD off    0x00000000008f7920 vaddr 0x00000000008f8920 paddr 0x00000000008f8920 align 2**12\r\n         filesz 0x00000000000183e0 memsz 0x0000000000022fd0 flags rw-\r\n DYNAMIC off    0x000000000090adb0 vaddr 0x000000000090bdb0 paddr 0x000000000090bdb0 align 2**3\r\n         filesz 0x0000000000000240 memsz 0x0000000000000240 flags rw-\r\n```\r\n vs when opting out using `-Wl,-z,noseparate-code`:\r\n```bash\r\nProgram Header:\r\n    PHDR off    0x0000000000000040 vaddr 0x0000000000000040 paddr 0x0000000000000040 align 2**3\r\n         filesz 0x0000000000000230 memsz 0x0000000000000230 flags r--\r\n  INTERP off    0x0000000000000270 vaddr 0x0000000000000270 paddr 0x0000000000000270 align 2**0\r\n         filesz 0x000000000000001c memsz 0x000000000000001c flags r--\r\n    LOAD off    0x0000000000000000 vaddr 0x0000000000000000 paddr 0x0000000000000000 align 2**12\r\n         filesz 0x00000000008f6a87 memsz 0x00000000008f6a87 flags r-x\r\n    LOAD off    0x00000000008f7920 vaddr 0x00000000008f8920 paddr 0x00000000008f8920 align 2**12\r\n         filesz 0x00000000000183e0 memsz 0x0000000000022fd0 flags rw-\r\n DYNAMIC off    0x000000000090adb0 vaddr 0x000000000090bdb0 paddr 0x000000000090bdb0 align 2**3\r\n         filesz 0x0000000000000240 memsz 0x0000000000000240 flags rw-\r\n```",
   "closed_at" : "2020-07-29T14:53:24Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 17,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19525/comments",
   "created_at" : "2020-07-15T06:41:21Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19525/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/19525",
   "id" : 657103198,
   "labels" : [
      {
         "color" : "5319e7",
         "default" : false,
         "description" : null,
         "id" : 61889416,
         "name" : "Build system",
         "node_id" : "MDU6TGFiZWw2MTg4OTQxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Build%20system"
      },
      {
         "color" : "8c9e07",
         "default" : false,
         "description" : "",
         "id" : 997854106,
         "name" : "Needs gitian build",
         "node_id" : "MDU6TGFiZWw5OTc4NTQxMDY=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20gitian%20build"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19525/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NDQ5Mjc5MTQ3",
   "number" : 19525,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/19525.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19525",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/19525.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19525"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "build: add -Wl,-z,separate-code to hardening flags",
   "updated_at" : "2020-07-29T14:53:24Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19525",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   }
}
