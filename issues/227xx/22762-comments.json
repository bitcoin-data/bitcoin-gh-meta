[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22937](https://github.com/bitcoin/bitcoin/pull/22937) (refactor: Add fs::PathToString, fs::PathFromString, u8string, u8path functions by ryanofsky)\n* [#22831](https://github.com/bitcoin/bitcoin/pull/22831) (test, bugfix: addrman tried table corruption on restart with asmap by jonatack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-08-21T21:56:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-903181009",
      "id" : 903181009,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII58411XLR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903181009/reactions"
      },
      "updated_at" : "2021-09-10T13:46:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903181009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r694778282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694778282"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I would expect `LoadAddrman()` to return, eh... addrman, no? Like `Foo x = LoadFoo();`. Consider this (or ignore it):\r\n\r\n```cpp\r\nstd::unique_ptr<CAddrMan> LoadAddrman(const ArgsManager& args, bilingual_str& error);\r\n\r\nbilingual_str error;\r\nnode.addrman = LoadAddrman(args, error);\r\nif (!node.addrman) {\r\n    return InitError(error);\r\n}\r\n```",
      "commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "created_at" : "2021-08-24T11:53:16Z",
      "diff_hunk" : "@@ -227,24 +226,39 @@ bool CBanDB::Read(banmap_t& banSet)\n     return true;\n }\n \n-CAddrDB::CAddrDB()\n-{\n-    pathAddr = gArgs.GetDataDirNet() / \"peers.dat\";\n-}\n-\n-bool CAddrDB::Write(const CAddrMan& addr)\n+bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n {\n+    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r694778282",
      "id" : 694778282,
      "line" : 240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDc3ODI4Mg==",
      "original_commit_id" : "fa50c25b1a761c6f98ae299bbf10cf79faf362e3",
      "original_line" : 240,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 114,
      "pull_request_review_id" : 737131806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T15:05:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694778282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r694783657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694783657"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: there is no _re_-creating if the file is missing:\r\n\r\n```suggestion\r\n        LogPrintf(\"Creating peers.dat because it was not found\\n\");\r\n```\r\n\r\nor just \"Creating peers.dat\" or \"peers.dat not found, creating an empty one\"",
      "commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "created_at" : "2021-08-24T12:01:10Z",
      "diff_hunk" : "@@ -227,24 +226,39 @@ bool CBanDB::Read(banmap_t& banSet)\n     return true;\n }\n \n-CAddrDB::CAddrDB()\n-{\n-    pathAddr = gArgs.GetDataDirNet() / \"peers.dat\";\n-}\n-\n-bool CAddrDB::Write(const CAddrMan& addr)\n+bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n {\n+    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(/* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    // Load addresses from peers.dat\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it\n+        addrman = std::make_unique<CAddrMan>(/* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+        LogPrintf(\"Recreating peers.dat because it was not found\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r694783657",
      "id" : 694783657,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDc4MzY1Nw==",
      "original_commit_id" : "fa50c25b1a761c6f98ae299bbf10cf79faf362e3",
      "original_line" : 254,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : null,
      "pull_request_review_id" : 737131806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T15:05:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694783657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r694787503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694787503"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The string argument is excessive. Maybe inherit `DbNotFoundError` from `std::exception` and use `throw DbNotFoundError;`? Or, I guess, the proper C++ way to do that is:\r\n\r\n```cpp\r\ntry {\r\n    throw std::system_error(std::make_error_code(std::errc::no_such_file_or_directory));\r\n} catch (const std::exception& e) {\r\n    auto se = dynamic_cast<const std::system_error*>(&e);\r\n    if (se != nullptr && se->code() == std::errc::no_such_file_or_directory) {\r\n        std::cout << \"no peers.dat\" << std::endl;\r\n    } else {\r\n        std::cout << e.what() << std::endl;\r\n    }\r\n}\r\n```\r\n",
      "commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "created_at" : "2021-08-24T12:07:13Z",
      "diff_hunk" : "@@ -134,47 +140,40 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n }\n \n template <typename Stream, typename Data>\n-bool DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n+void DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n {\n-    try {\n-        CHashVerifier<Stream> verifier(&stream);\n-        // de-serialize file header (network specific magic number) and ..\n-        unsigned char pchMsgTmp[4];\n-        verifier >> pchMsgTmp;\n-        // ... verify the network matches ours\n-        if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp)))\n-            return error(\"%s: Invalid network magic number\", __func__);\n-\n-        // de-serialize data\n-        verifier >> data;\n-\n-        // verify checksum\n-        if (fCheckSum) {\n-            uint256 hashTmp;\n-            stream >> hashTmp;\n-            if (hashTmp != verifier.GetHash()) {\n-                return error(\"%s: Checksum mismatch, data corrupted\", __func__);\n-            }\n-        }\n-    }\n-    catch (const std::exception& e) {\n-        return error(\"%s: Deserialize or I/O error - %s\", __func__, e.what());\n+    CHashVerifier<Stream> verifier(&stream);\n+    // de-serialize file header (network specific magic number) and ..\n+    unsigned char pchMsgTmp[4];\n+    verifier >> pchMsgTmp;\n+    // ... verify the network matches ours\n+    if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp))) {\n+        throw std::runtime_error{\"Invalid network magic number\"};\n     }\n \n-    return true;\n+    // de-serialize data\n+    verifier >> data;\n+\n+    // verify checksum\n+    if (fCheckSum) {\n+        uint256 hashTmp;\n+        stream >> hashTmp;\n+        if (hashTmp != verifier.GetHash()) {\n+            throw std::runtime_error{\"Checksum mismatch, data corrupted\"};\n+        }\n+    }\n }\n \n template <typename Data>\n-bool DeserializeFileDB(const fs::path& path, Data& data, int version)\n+void DeserializeFileDB(const fs::path& path, Data& data, int version)\n {\n     // open input file, and associate with CAutoFile\n     FILE* file = fsbridge::fopen(path, \"rb\");\n     CAutoFile filein(file, SER_DISK, version);\n     if (filein.IsNull()) {\n-        LogPrintf(\"Missing or invalid file %s\\n\", path.string());\n-        return false;\n+        throw DbNotFoundError{\"\"};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r694787503",
      "id" : 694787503,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDc4NzUwMw==",
      "original_commit_id" : "fa50c25b1a761c6f98ae299bbf10cf79faf362e3",
      "original_line" : 174,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : null,
      "pull_request_review_id" : 737131806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T15:05:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694787503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-08-24T17:18:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-904829923",
      "id" : 904829923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII58417pvj",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-24T17:18:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/904829923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r696430107"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696430107"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This would make the code more verbose. In general I rather standardize error handling how it is done in rust, which the current code is closer to than yours, I think.",
      "commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "created_at" : "2021-08-26T08:53:28Z",
      "diff_hunk" : "@@ -227,24 +226,39 @@ bool CBanDB::Read(banmap_t& banSet)\n     return true;\n }\n \n-CAddrDB::CAddrDB()\n-{\n-    pathAddr = gArgs.GetDataDirNet() / \"peers.dat\";\n-}\n-\n-bool CAddrDB::Write(const CAddrMan& addr)\n+bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n {\n+    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r696430107",
      "id" : 696430107,
      "in_reply_to_id" : 694778282,
      "line" : 240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjQzMDEwNw==",
      "original_commit_id" : "fa50c25b1a761c6f98ae299bbf10cf79faf362e3",
      "original_line" : 240,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 114,
      "pull_request_review_id" : 739211774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-26T09:04:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696430107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r696438029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696438029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed",
      "commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "created_at" : "2021-08-26T09:03:08Z",
      "diff_hunk" : "@@ -227,24 +226,39 @@ bool CBanDB::Read(banmap_t& banSet)\n     return true;\n }\n \n-CAddrDB::CAddrDB()\n-{\n-    pathAddr = gArgs.GetDataDirNet() / \"peers.dat\";\n-}\n-\n-bool CAddrDB::Write(const CAddrMan& addr)\n+bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n {\n+    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(/* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    // Load addresses from peers.dat\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it\n+        addrman = std::make_unique<CAddrMan>(/* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+        LogPrintf(\"Recreating peers.dat because it was not found\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r696438029",
      "id" : 696438029,
      "in_reply_to_id" : 694783657,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjQzODAyOQ==",
      "original_commit_id" : "fa50c25b1a761c6f98ae299bbf10cf79faf362e3",
      "original_line" : 254,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : null,
      "pull_request_review_id" : 739211774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-26T09:04:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696438029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r696438462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696438462"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, removed `\"\"`.",
      "commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "created_at" : "2021-08-26T09:03:43Z",
      "diff_hunk" : "@@ -134,47 +140,40 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n }\n \n template <typename Stream, typename Data>\n-bool DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n+void DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n {\n-    try {\n-        CHashVerifier<Stream> verifier(&stream);\n-        // de-serialize file header (network specific magic number) and ..\n-        unsigned char pchMsgTmp[4];\n-        verifier >> pchMsgTmp;\n-        // ... verify the network matches ours\n-        if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp)))\n-            return error(\"%s: Invalid network magic number\", __func__);\n-\n-        // de-serialize data\n-        verifier >> data;\n-\n-        // verify checksum\n-        if (fCheckSum) {\n-            uint256 hashTmp;\n-            stream >> hashTmp;\n-            if (hashTmp != verifier.GetHash()) {\n-                return error(\"%s: Checksum mismatch, data corrupted\", __func__);\n-            }\n-        }\n-    }\n-    catch (const std::exception& e) {\n-        return error(\"%s: Deserialize or I/O error - %s\", __func__, e.what());\n+    CHashVerifier<Stream> verifier(&stream);\n+    // de-serialize file header (network specific magic number) and ..\n+    unsigned char pchMsgTmp[4];\n+    verifier >> pchMsgTmp;\n+    // ... verify the network matches ours\n+    if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp))) {\n+        throw std::runtime_error{\"Invalid network magic number\"};\n     }\n \n-    return true;\n+    // de-serialize data\n+    verifier >> data;\n+\n+    // verify checksum\n+    if (fCheckSum) {\n+        uint256 hashTmp;\n+        stream >> hashTmp;\n+        if (hashTmp != verifier.GetHash()) {\n+            throw std::runtime_error{\"Checksum mismatch, data corrupted\"};\n+        }\n+    }\n }\n \n template <typename Data>\n-bool DeserializeFileDB(const fs::path& path, Data& data, int version)\n+void DeserializeFileDB(const fs::path& path, Data& data, int version)\n {\n     // open input file, and associate with CAutoFile\n     FILE* file = fsbridge::fopen(path, \"rb\");\n     CAutoFile filein(file, SER_DISK, version);\n     if (filein.IsNull()) {\n-        LogPrintf(\"Missing or invalid file %s\\n\", path.string());\n-        return false;\n+        throw DbNotFoundError{\"\"};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r696438462",
      "id" : 696438462,
      "in_reply_to_id" : 694787503,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjQzODQ2Mg==",
      "original_commit_id" : "fa50c25b1a761c6f98ae299bbf10cf79faf362e3",
      "original_line" : 174,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : null,
      "pull_request_review_id" : 739211774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-26T09:04:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696438462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r697292858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697292858"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `{}` is not necessary",
      "commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "created_at" : "2021-08-27T09:27:17Z",
      "diff_hunk" : "@@ -134,47 +140,40 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n }\n \n template <typename Stream, typename Data>\n-bool DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n+void DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n {\n-    try {\n-        CHashVerifier<Stream> verifier(&stream);\n-        // de-serialize file header (network specific magic number) and ..\n-        unsigned char pchMsgTmp[4];\n-        verifier >> pchMsgTmp;\n-        // ... verify the network matches ours\n-        if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp)))\n-            return error(\"%s: Invalid network magic number\", __func__);\n-\n-        // de-serialize data\n-        verifier >> data;\n-\n-        // verify checksum\n-        if (fCheckSum) {\n-            uint256 hashTmp;\n-            stream >> hashTmp;\n-            if (hashTmp != verifier.GetHash()) {\n-                return error(\"%s: Checksum mismatch, data corrupted\", __func__);\n-            }\n-        }\n-    }\n-    catch (const std::exception& e) {\n-        return error(\"%s: Deserialize or I/O error - %s\", __func__, e.what());\n+    CHashVerifier<Stream> verifier(&stream);\n+    // de-serialize file header (network specific magic number) and ..\n+    unsigned char pchMsgTmp[4];\n+    verifier >> pchMsgTmp;\n+    // ... verify the network matches ours\n+    if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp))) {\n+        throw std::runtime_error{\"Invalid network magic number\"};\n     }\n \n-    return true;\n+    // de-serialize data\n+    verifier >> data;\n+\n+    // verify checksum\n+    if (fCheckSum) {\n+        uint256 hashTmp;\n+        stream >> hashTmp;\n+        if (hashTmp != verifier.GetHash()) {\n+            throw std::runtime_error{\"Checksum mismatch, data corrupted\"};\n+        }\n+    }\n }\n \n template <typename Data>\n-bool DeserializeFileDB(const fs::path& path, Data& data, int version)\n+void DeserializeFileDB(const fs::path& path, Data& data, int version)\n {\n     // open input file, and associate with CAutoFile\n     FILE* file = fsbridge::fopen(path, \"rb\");\n     CAutoFile filein(file, SER_DISK, version);\n     if (filein.IsNull()) {\n-        LogPrintf(\"Missing or invalid file %s\\n\", path.string());\n-        return false;\n+        throw DbNotFoundError{};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r697292858",
      "id" : 697292858,
      "line" : 174,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzI5Mjg1OA==",
      "original_commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "original_line" : 174,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 83,
      "pull_request_review_id" : 740322255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-27T09:27:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697292858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-01T09:25:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-910104001",
      "id" : 910104001,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842PxXB",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T09:25:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910104001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r700352453"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700352453"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not for me:\r\n\r\n```\r\naddrdb.cpp:174:15: error: 'DbNotFoundError' does not refer to a value\r\n        throw DbNotFoundError;\r\n              ^\r\n",
      "commit_id" : "faff4fd4e00621a02554233effa8f144990f3dd8",
      "created_at" : "2021-09-01T15:58:03Z",
      "diff_hunk" : "@@ -134,47 +140,40 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n }\n \n template <typename Stream, typename Data>\n-bool DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n+void DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n {\n-    try {\n-        CHashVerifier<Stream> verifier(&stream);\n-        // de-serialize file header (network specific magic number) and ..\n-        unsigned char pchMsgTmp[4];\n-        verifier >> pchMsgTmp;\n-        // ... verify the network matches ours\n-        if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp)))\n-            return error(\"%s: Invalid network magic number\", __func__);\n-\n-        // de-serialize data\n-        verifier >> data;\n-\n-        // verify checksum\n-        if (fCheckSum) {\n-            uint256 hashTmp;\n-            stream >> hashTmp;\n-            if (hashTmp != verifier.GetHash()) {\n-                return error(\"%s: Checksum mismatch, data corrupted\", __func__);\n-            }\n-        }\n-    }\n-    catch (const std::exception& e) {\n-        return error(\"%s: Deserialize or I/O error - %s\", __func__, e.what());\n+    CHashVerifier<Stream> verifier(&stream);\n+    // de-serialize file header (network specific magic number) and ..\n+    unsigned char pchMsgTmp[4];\n+    verifier >> pchMsgTmp;\n+    // ... verify the network matches ours\n+    if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp))) {\n+        throw std::runtime_error{\"Invalid network magic number\"};\n     }\n \n-    return true;\n+    // de-serialize data\n+    verifier >> data;\n+\n+    // verify checksum\n+    if (fCheckSum) {\n+        uint256 hashTmp;\n+        stream >> hashTmp;\n+        if (hashTmp != verifier.GetHash()) {\n+            throw std::runtime_error{\"Checksum mismatch, data corrupted\"};\n+        }\n+    }\n }\n \n template <typename Data>\n-bool DeserializeFileDB(const fs::path& path, Data& data, int version)\n+void DeserializeFileDB(const fs::path& path, Data& data, int version)\n {\n     // open input file, and associate with CAutoFile\n     FILE* file = fsbridge::fopen(path, \"rb\");\n     CAutoFile filein(file, SER_DISK, version);\n     if (filein.IsNull()) {\n-        LogPrintf(\"Missing or invalid file %s\\n\", path.string());\n-        return false;\n+        throw DbNotFoundError{};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r700352453",
      "id" : 700352453,
      "in_reply_to_id" : 697292858,
      "line" : 174,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDM1MjQ1Mw==",
      "original_commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "original_line" : 174,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 83,
      "pull_request_review_id" : 744117175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-01T15:58:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700352453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased (trivial)",
      "created_at" : "2021-09-01T16:01:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-910426753",
      "id" : 910426753,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842RAKB",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T16:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910426753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r700768194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700768194"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ah, oh, yes of course, sorry for the noise",
      "commit_id" : "faff4fd4e00621a02554233effa8f144990f3dd8",
      "created_at" : "2021-09-02T05:58:10Z",
      "diff_hunk" : "@@ -134,47 +140,40 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n }\n \n template <typename Stream, typename Data>\n-bool DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n+void DeserializeDB(Stream& stream, Data& data, bool fCheckSum = true)\n {\n-    try {\n-        CHashVerifier<Stream> verifier(&stream);\n-        // de-serialize file header (network specific magic number) and ..\n-        unsigned char pchMsgTmp[4];\n-        verifier >> pchMsgTmp;\n-        // ... verify the network matches ours\n-        if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp)))\n-            return error(\"%s: Invalid network magic number\", __func__);\n-\n-        // de-serialize data\n-        verifier >> data;\n-\n-        // verify checksum\n-        if (fCheckSum) {\n-            uint256 hashTmp;\n-            stream >> hashTmp;\n-            if (hashTmp != verifier.GetHash()) {\n-                return error(\"%s: Checksum mismatch, data corrupted\", __func__);\n-            }\n-        }\n-    }\n-    catch (const std::exception& e) {\n-        return error(\"%s: Deserialize or I/O error - %s\", __func__, e.what());\n+    CHashVerifier<Stream> verifier(&stream);\n+    // de-serialize file header (network specific magic number) and ..\n+    unsigned char pchMsgTmp[4];\n+    verifier >> pchMsgTmp;\n+    // ... verify the network matches ours\n+    if (memcmp(pchMsgTmp, Params().MessageStart(), sizeof(pchMsgTmp))) {\n+        throw std::runtime_error{\"Invalid network magic number\"};\n     }\n \n-    return true;\n+    // de-serialize data\n+    verifier >> data;\n+\n+    // verify checksum\n+    if (fCheckSum) {\n+        uint256 hashTmp;\n+        stream >> hashTmp;\n+        if (hashTmp != verifier.GetHash()) {\n+            throw std::runtime_error{\"Checksum mismatch, data corrupted\"};\n+        }\n+    }\n }\n \n template <typename Data>\n-bool DeserializeFileDB(const fs::path& path, Data& data, int version)\n+void DeserializeFileDB(const fs::path& path, Data& data, int version)\n {\n     // open input file, and associate with CAutoFile\n     FILE* file = fsbridge::fopen(path, \"rb\");\n     CAutoFile filein(file, SER_DISK, version);\n     if (filein.IsNull()) {\n-        LogPrintf(\"Missing or invalid file %s\\n\", path.string());\n-        return false;\n+        throw DbNotFoundError{};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r700768194",
      "id" : 700768194,
      "in_reply_to_id" : 697292858,
      "line" : 174,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDc2ODE5NA==",
      "original_commit_id" : "fa1704a2f49eaedf5788d82294485f3a8e17a6c8",
      "original_line" : 174,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 83,
      "pull_request_review_id" : 744631829,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T05:58:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700768194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nLike other open pulls to change or fix addrman behavior, it might be good to have functional/regression test coverage in place first.",
      "created_at" : "2021-09-03T10:40:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-912441771",
      "id" : 912441771,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842YsGr",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-03T10:40:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/912441771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-06T10:10:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-913525136",
      "id" : 913525136,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842c0mQ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-06T10:10:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913525136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-06T10:58:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-913554752",
      "id" : 913554752,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842c71A",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-06T10:58:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913554752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2021-09-06T11:42:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-913581823",
      "id" : 913581823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842dCb_",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-06T11:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913581823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703008705"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703008705"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa9aed72 while fixing the addrman includes may as well do these too: https://github.com/bitcoin/bitcoin/pull/22740#issuecomment-911461646",
      "commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "created_at" : "2021-09-06T16:45:28Z",
      "diff_hunk" : "@@ -10,14 +10,14 @@\n #include <config/bitcoin-config.h>\n #include <fs.h>\n #include <hash.h>\n+#include <logging.h>\n #include <netaddress.h>\n #include <protocol.h>\n #include <random.h>\n #include <streams.h>\n #include <sync.h>\n #include <timedata.h>\n #include <tinyformat.h>\n-#include <util/system.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703008705",
      "id" : 703008705,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzAwODcwNQ==",
      "original_commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "original_line" : 20,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 12,
      "pull_request_review_id" : 747357866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T17:38:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703008705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703012605"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703012605"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa63ebb21 `CAddrDB` removed in this commit; update these references \r\n```diff\r\n--- a/src/test/addrman_tests.cpp\r\n+++ b/src/test/addrman_tests.cpp\r\n@@ -1002,7 +1002,7 @@ BOOST_AUTO_TEST_CASE(addrman_evictionworks)\r\n     BOOST_CHECK(addrman.SelectTriedCollision().ToString() == \"[::]:0\");\r\n }\r\n \r\n-BOOST_AUTO_TEST_CASE(caddrdb_read)\r\n+BOOST_AUTO_TEST_CASE(load_addrman)\r\n {\r\n     CAddrManUncorrupted addrmanUncorrupted;\r\n \r\n@@ -1047,7 +1047,7 @@ BOOST_AUTO_TEST_CASE(caddrdb_read)\r\n }\r\n \r\n \r\n-BOOST_AUTO_TEST_CASE(caddrdb_read_corrupted)\r\n+BOOST_AUTO_TEST_CASE(load_corrupted_addrman)\r\n {\r\n     CAddrManCorrupted addrmanCorrupted;\r\n```\r\n",
      "commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "created_at" : "2021-09-06T16:57:19Z",
      "diff_hunk" : "@@ -1037,12 +1037,12 @@ BOOST_AUTO_TEST_CASE(caddrdb_read)\n     BOOST_CHECK(addrman1.size() == 3);\n     BOOST_CHECK(exceptionThrown == false);\n \n-    // Test that CAddrDB::Read creates an addrman with the correct number of addrs.\n+    // Test that ReadFromStream creates an addrman with the correct number of addrs.\n     CDataStream ssPeers2 = AddrmanToStream(addrmanUncorrupted);\n \n     CAddrMan addrman2(/* asmap */ std::vector<bool>(), /* deterministic */ false, /* consistency_check_ratio */ 100);\n     BOOST_CHECK(addrman2.size() == 0);\n-    BOOST_CHECK(CAddrDB::Read(addrman2, ssPeers2));\n+    ReadFromStream(addrman2, ssPeers2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703012605",
      "id" : 703012605,
      "line" : 1045,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzAxMjYwNQ==",
      "original_commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "original_line" : 1045,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/test/addrman_tests.cpp",
      "position" : 11,
      "pull_request_review_id" : 747357866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T17:38:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703012605",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703021771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703021771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "faa75278d076874194073a6cb397 suggestions\r\n```suggestion\r\n        return strprintf(_(\"Invalid or corrupt peers.dat (%s). If you believe this is a bug, please report it to %s. As a workaround, you can move the file (%s) out of the way (rename, move, or delete) and bitcoind will create a new one on the next start.\"),\r\n```",
      "commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "created_at" : "2021-09-06T17:29:57Z",
      "diff_hunk" : "@@ -170,24 +170,39 @@ bool CBanDB::Read(banmap_t& banSet)\n     return true;\n }\n \n-CAddrDB::CAddrDB()\n-{\n-    pathAddr = gArgs.GetDataDirNet() / \"peers.dat\";\n-}\n-\n-bool CAddrDB::Write(const CAddrMan& addr)\n+bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n {\n+    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    // Load addresses from peers.dat\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it\n+        addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+        LogPrintf(\"Creating peers.dat because it was not found\\n\");\n+        DumpPeerAddresses(args, *addrman);\n+    } catch (const std::exception& e) {\n+        addrman = nullptr;\n+        return strprintf(_(\"Addrman invalid or corrupt (%s). If you believe this is a bug, please report it to %s. As a workaround you can move the database (%s) out of the way (rename, move, or delete) to use a fresh one on the next start.\"),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703021771",
      "id" : 703021771,
      "line" : 202,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzAyMTc3MQ==",
      "original_commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "original_line" : 202,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 129,
      "pull_request_review_id" : 747357866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T17:44:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703021771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703023866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703023866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "faa75278d076874194073a6cb3974f45de051ffc Perhaps also log to the user the location where the file was expected to be (as is currently the case).",
      "commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "created_at" : "2021-09-06T17:37:30Z",
      "diff_hunk" : "@@ -170,24 +170,39 @@ bool CBanDB::Read(banmap_t& banSet)\n     return true;\n }\n \n-CAddrDB::CAddrDB()\n-{\n-    pathAddr = gArgs.GetDataDirNet() / \"peers.dat\";\n-}\n-\n-bool CAddrDB::Write(const CAddrMan& addr)\n+bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n {\n+    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    // Load addresses from peers.dat\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it\n+        addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+        LogPrintf(\"Creating peers.dat because it was not found\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703023866",
      "id" : 703023866,
      "line" : 198,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzAyMzg2Ng==",
      "original_commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "original_line" : 198,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 125,
      "pull_request_review_id" : 747357866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T17:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703023866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703326048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703326048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, done",
      "commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "created_at" : "2021-09-07T09:06:55Z",
      "diff_hunk" : "@@ -10,14 +10,14 @@\n #include <config/bitcoin-config.h>\n #include <fs.h>\n #include <hash.h>\n+#include <logging.h>\n #include <netaddress.h>\n #include <protocol.h>\n #include <random.h>\n #include <streams.h>\n #include <sync.h>\n #include <timedata.h>\n #include <tinyformat.h>\n-#include <util/system.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703326048",
      "id" : 703326048,
      "in_reply_to_id" : 703008705,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzMyNjA0OA==",
      "original_commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "original_line" : 20,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 16,
      "pull_request_review_id" : 747732330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-07T09:06:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703326048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703326206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703326206"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, done",
      "commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "created_at" : "2021-09-07T09:07:05Z",
      "diff_hunk" : "@@ -1037,12 +1037,12 @@ BOOST_AUTO_TEST_CASE(caddrdb_read)\n     BOOST_CHECK(addrman1.size() == 3);\n     BOOST_CHECK(exceptionThrown == false);\n \n-    // Test that CAddrDB::Read creates an addrman with the correct number of addrs.\n+    // Test that ReadFromStream creates an addrman with the correct number of addrs.\n     CDataStream ssPeers2 = AddrmanToStream(addrmanUncorrupted);\n \n     CAddrMan addrman2(/* asmap */ std::vector<bool>(), /* deterministic */ false, /* consistency_check_ratio */ 100);\n     BOOST_CHECK(addrman2.size() == 0);\n-    BOOST_CHECK(CAddrDB::Read(addrman2, ssPeers2));\n+    ReadFromStream(addrman2, ssPeers2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703326206",
      "id" : 703326206,
      "in_reply_to_id" : 703012605,
      "line" : 1046,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzMyNjIwNg==",
      "original_commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "original_line" : 1046,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/test/addrman_tests.cpp",
      "position" : 38,
      "pull_request_review_id" : 747732503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-07T09:07:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703326206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703326325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703326325"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, done",
      "commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "created_at" : "2021-09-07T09:07:15Z",
      "diff_hunk" : "@@ -170,24 +170,39 @@ bool CBanDB::Read(banmap_t& banSet)\n     return true;\n }\n \n-CAddrDB::CAddrDB()\n-{\n-    pathAddr = gArgs.GetDataDirNet() / \"peers.dat\";\n-}\n-\n-bool CAddrDB::Write(const CAddrMan& addr)\n+bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n {\n+    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    // Load addresses from peers.dat\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it\n+        addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+        LogPrintf(\"Creating peers.dat because it was not found\\n\");\n+        DumpPeerAddresses(args, *addrman);\n+    } catch (const std::exception& e) {\n+        addrman = nullptr;\n+        return strprintf(_(\"Addrman invalid or corrupt (%s). If you believe this is a bug, please report it to %s. As a workaround you can move the database (%s) out of the way (rename, move, or delete) to use a fresh one on the next start.\"),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703326325",
      "id" : 703326325,
      "in_reply_to_id" : 703021771,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzMyNjMyNQ==",
      "original_commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "original_line" : 202,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : null,
      "pull_request_review_id" : 747732660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-07T09:07:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703326325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703326500"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703326500"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, done",
      "commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "created_at" : "2021-09-07T09:07:28Z",
      "diff_hunk" : "@@ -170,24 +170,39 @@ bool CBanDB::Read(banmap_t& banSet)\n     return true;\n }\n \n-CAddrDB::CAddrDB()\n-{\n-    pathAddr = gArgs.GetDataDirNet() / \"peers.dat\";\n-}\n-\n-bool CAddrDB::Write(const CAddrMan& addr)\n+bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n {\n+    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool CAddrDB::Read(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    // Load addresses from peers.dat\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it\n+        addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+        LogPrintf(\"Creating peers.dat because it was not found\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703326500",
      "id" : 703326500,
      "in_reply_to_id" : 703023866,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzMyNjUwMA==",
      "original_commit_id" : "faa75278d076874194073a6cb3974f45de051ffc",
      "original_line" : 198,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : null,
      "pull_request_review_id" : 747732899,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-07T09:07:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703326500",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "appveyor failure can be ignored",
      "created_at" : "2021-09-07T12:33:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-914265164",
      "id" : 914265164,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842fpRM",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-07T12:33:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914265164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703561784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703561784"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa035c1 suggestion if you retouch\r\n```suggestion\r\n/** Load addresses from peers.dat into addrman. Returns an error string on failure */\r\n```",
      "commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "created_at" : "2021-09-07T14:26:35Z",
      "diff_hunk" : "@@ -52,6 +47,9 @@ class CBanDB\n     bool Read(banmap_t& banSet);\n };\n \n+/** Returns an error string on failure */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703561784",
      "id" : 703561784,
      "line" : 50,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzU2MTc4NA==",
      "original_commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "original_line" : 50,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/addrdb.h",
      "position" : 35,
      "pull_request_review_id" : 748046806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-07T15:54:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703561784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703562958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703562958"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa035c1 perhaps keep this comment",
      "commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "created_at" : "2021-09-07T14:27:53Z",
      "diff_hunk" : "@@ -1200,20 +1200,9 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n             LogPrintf(\"Using /16 prefix for IP bucketing\\n\");\n         }\n \n-        auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n-        node.addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n-\n-        // Load addresses from peers.dat",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703562958",
      "id" : 703562958,
      "line" : 1206,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzU2Mjk1OA==",
      "original_commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "original_line" : 1206,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 7,
      "pull_request_review_id" : 748046806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-07T15:54:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703562958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703641121"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703641121"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it is important to document the file name in init.cpp, so I removed it",
      "commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "created_at" : "2021-09-07T16:00:15Z",
      "diff_hunk" : "@@ -1200,20 +1200,9 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n             LogPrintf(\"Using /16 prefix for IP bucketing\\n\");\n         }\n \n-        auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n-        node.addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n-\n-        // Load addresses from peers.dat",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703641121",
      "id" : 703641121,
      "in_reply_to_id" : 703562958,
      "line" : 1206,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzY0MTEyMQ==",
      "original_commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "original_line" : 1206,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 7,
      "pull_request_review_id" : 748153651,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-07T16:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703641121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703642840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703642840"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think other modules care much about the exact file name, so I didn't mention it, as it is self-documented in the addrdb implementation file (cpp) already. And the \"Load addresses\" part should already be clear from the function name.",
      "commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "created_at" : "2021-09-07T16:02:24Z",
      "diff_hunk" : "@@ -52,6 +47,9 @@ class CBanDB\n     bool Read(banmap_t& banSet);\n };\n \n+/** Returns an error string on failure */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r703642840",
      "id" : 703642840,
      "in_reply_to_id" : 703561784,
      "line" : 50,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzY0Mjg0MA==",
      "original_commit_id" : "fa7003f949f21a0ba81388caff1ff986d8b43eed",
      "original_line" : 50,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/addrdb.h",
      "position" : 35,
      "pull_request_review_id" : 748155883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-07T16:02:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703642840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested on Pop!_OS and everything works as expected and mentioned in PR description.\r\n\r\n### Master Branch:\r\n\r\n_peers.dat_ is replaced with a new file if it is corrupt or other issues.\r\n\r\n\r\n<details>\r\n  <summary>Details</summary>\r\n\r\n![image](https://user-images.githubusercontent.com/13405205/132393914-755fd969-1874-4abb-8654-bc267e722b76.png)\r\n\r\n![image](https://user-images.githubusercontent.com/13405205/132393959-2847368a-ac9e-41b9-93b2-ea67333d6c6e.png)\r\n  \r\n</details>\r\n\r\n### PR Branch:\r\n\r\nA. Corrupt _peers.dat_ file\r\n\r\n1. Open _peers.dat_ add random characters in beginning and save.\r\n2. Run `bitcoind`\r\n\r\n```\r\n2021-09-07T18:05:46Z init message: Loading P2P addressesâ¦\r\n2021-09-07T18:05:46Z Error: Invalid or corrupt peers.dat (Invalid network magic number). If you believe this is a bug, please report it to https://github.com/bitcoin/bitcoin/issues. As a workaround, you can move the file (\"/home/prayank/.bitcoin/regtest/peers.dat\") out of the way (rename, move, or delete) to have a new one created on the next start.\r\nError: Invalid or corrupt peers.dat (Invalid network magic number). If you believe this is a bug, please report it to https://github.com/bitcoin/bitcoin/issues. As a workaround, you can move the file (\"/home/prayank/.bitcoin/regtest/peers.dat\") out of the way (rename, move, or delete) to have a new one created on the next start.\r\n2021-09-07T18:05:46Z Shutdown: In progress...\r\n```\r\n:warning: Not sure why same **error printed twice** in terminal running `bitcoind`. I see only one error message in debug.log:\r\n\r\n```\r\n2021-09-07T18:05:46Z init message: Loading P2P addressesâ¦\r\n2021-09-07T18:05:46Z Error: Invalid or corrupt peers.dat (Invalid network magic number). If you believe this is a bug, please report it to https://github.com/bitcoin/bitcoin/issues. As a workaround, you can move the file (\"/home/prayank/.bitcoin/regtest/peers.dat\") out of the way (rename, move, or delete) to have a new one created on the next start.\r\n2021-09-07T18:05:46Z Shutdown: In progress...\r\n```\r\n\r\nB. _peers.dat_ from testnet used in regtest\r\n\r\n1. Delete _regtest/peers.dat_ and copy _testnet3/peers.dat_ in _regtest/_\r\n2. Run `bitcoind`\r\n\r\n```\r\n2021-09-07T18:14:33Z init message: Loading P2P addressesâ¦\r\n2021-09-07T18:14:33Z Error: Invalid or corrupt peers.dat (Invalid network magic number). If you believe this is a bug, please report it to https://github.com/bitcoin/bitcoin/issues. As a workaround, you can move the file (\"/home/prayank/.bitcoin/regtest/peers.dat\") out of the way (rename, move, or delete) to have a new one created on the next start.\r\nError: Invalid or corrupt peers.dat (Invalid network magic number). If you believe this is a bug, please report it to https://github.com/bitcoin/bitcoin/issues. As a workaround, you can move the file (\"/home/prayank/.bitcoin/regtest/peers.dat\") out of the way (rename, move, or delete) to have a new one created on the next start.\r\n2021-09-07T18:14:33Z Shutdown: In progress...\r\n```\r\nFix the issue by following the things mentioned in error: Delete _peers.dat_ and restart `bitcoind`. No issues. :white_check_mark:\r\n\r\n\r\n",
      "created_at" : "2021-09-07T19:05:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-914552140",
      "id" : 914552140,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842gvVM",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-07T19:06:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914552140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Please review #22915 first, as this pull requires rebase again",
      "created_at" : "2021-09-08T08:21:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-915025401",
      "id" : 915025401,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842ii35",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-08T08:21:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/915025401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased (only change is in tests)",
      "created_at" : "2021-09-09T07:25:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-915833083",
      "id" : 915833083,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842loD7",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-09T07:25:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/915833083",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review re-ACK fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae per `git range-diff eb1f570 fa59c6d fa55c3` and verified the new tests fail on master, except \"Check mocked addrman is valid\", as expected",
      "created_at" : "2021-09-09T08:44:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-915886858",
      "id" : 915886858,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842l1MK",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-09T08:44:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/915886858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r705182050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705182050"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is somewhat confusing or designates a corrupted file, not one from the future. How could the file be format=1 and only be compatible with formats larger than 111? If the above is changed as:\r\n\r\n```diff\r\n-write_addrman(peers_dat, lowest_compatible=111)\r\n+write_addrman(peers_dat, format=115, lowest_compatible=111)\r\n```\r\n\r\nit will be a bit more realistic.\r\n\r\nFeel free to ignore as out of the scope of this PR, given that a similar message is already in `master`.",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-09T10:02:57Z",
      "diff_hunk" : "@@ -54,30 +61,29 @@ def run_test(self):\n         self.log.info(\"Check that addrman from future cannot be read\")\n         self.stop_node(0)\n         write_addrman(peers_dat, lowest_compatible=111)\n-        with self.nodes[0].assert_debug_log([\n-                f'ERROR: DeserializeDB: Deserialize or I/O error - Unsupported format of addrman database: 1. It is compatible with formats >=111, but the maximum supported by this version of {self.config[\"environment\"][\"PACKAGE_NAME\"]} is 3.',\n-                \"Recreating peers.dat\",\n-        ]):\n-            self.start_node(0)\n-        assert_equal(self.nodes[0].getnodeaddresses(), [])\n+        self.nodes[0].assert_start_raises_init_error(\n+            expected_msg=init_error(\n+                \"Unsupported format of addrman database: 1. It is compatible with \"\n+                \"formats >=111, but the maximum supported by this version of \"\n+                f\"{self.config['environment']['PACKAGE_NAME']} is 3.: (.+)\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r705182050",
      "id" : 705182050,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTE4MjA1MA==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 68,
      "original_position" : 35,
      "original_start_line" : 66,
      "path" : "test/functional/feature_addrman.py",
      "position" : 35,
      "pull_request_review_id" : 750137483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : 66,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-09T10:05:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705182050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r705219600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705219600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Instead of \"fixing\" the test, I think rejecting formats that are less than lowest_compatible seems like a good sanity check. Though, this would be an unrelated fix in a separate pull:\r\n\r\n```diff\r\ndiff --git a/src/addrman.cpp b/src/addrman.cpp\r\nindex 174b3a654c..bcffe64de3 100644\r\n--- a/src/addrman.cpp\r\n+++ b/src/addrman.cpp\r\n@@ -243,7 +243,7 @@ void CAddrMan::Unserialize(Stream& s_)\r\n     uint8_t compat;\r\n     s >> compat;\r\n     const uint8_t lowest_compatible = compat - INCOMPATIBILITY_BASE;\r\n-    if (lowest_compatible > FILE_FORMAT) {\r\n+    if (format < lowest_compatible || lowest_compatible > FILE_FORMAT) {\r\n         throw std::ios_base::failure(strprintf(\r\n             \"Unsupported format of addrman database: %u. It is compatible with formats >=%u, \"\r\n             \"but the maximum supported by this version of %s is %u.\",\r\n",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-09T10:58:59Z",
      "diff_hunk" : "@@ -54,30 +61,29 @@ def run_test(self):\n         self.log.info(\"Check that addrman from future cannot be read\")\n         self.stop_node(0)\n         write_addrman(peers_dat, lowest_compatible=111)\n-        with self.nodes[0].assert_debug_log([\n-                f'ERROR: DeserializeDB: Deserialize or I/O error - Unsupported format of addrman database: 1. It is compatible with formats >=111, but the maximum supported by this version of {self.config[\"environment\"][\"PACKAGE_NAME\"]} is 3.',\n-                \"Recreating peers.dat\",\n-        ]):\n-            self.start_node(0)\n-        assert_equal(self.nodes[0].getnodeaddresses(), [])\n+        self.nodes[0].assert_start_raises_init_error(\n+            expected_msg=init_error(\n+                \"Unsupported format of addrman database: 1. It is compatible with \"\n+                \"formats >=111, but the maximum supported by this version of \"\n+                f\"{self.config['environment']['PACKAGE_NAME']} is 3.: (.+)\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r705219600",
      "id" : 705219600,
      "in_reply_to_id" : 705182050,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTIxOTYwMA==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 68,
      "original_position" : 35,
      "original_start_line" : 66,
      "path" : "test/functional/feature_addrman.py",
      "position" : 35,
      "pull_request_review_id" : 750187897,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : 66,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-09T10:59:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705219600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r705236701"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705236701"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "+1, maybe each condition deserves its own error message.",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-09T11:25:25Z",
      "diff_hunk" : "@@ -54,30 +61,29 @@ def run_test(self):\n         self.log.info(\"Check that addrman from future cannot be read\")\n         self.stop_node(0)\n         write_addrman(peers_dat, lowest_compatible=111)\n-        with self.nodes[0].assert_debug_log([\n-                f'ERROR: DeserializeDB: Deserialize or I/O error - Unsupported format of addrman database: 1. It is compatible with formats >=111, but the maximum supported by this version of {self.config[\"environment\"][\"PACKAGE_NAME\"]} is 3.',\n-                \"Recreating peers.dat\",\n-        ]):\n-            self.start_node(0)\n-        assert_equal(self.nodes[0].getnodeaddresses(), [])\n+        self.nodes[0].assert_start_raises_init_error(\n+            expected_msg=init_error(\n+                \"Unsupported format of addrman database: 1. It is compatible with \"\n+                \"formats >=111, but the maximum supported by this version of \"\n+                f\"{self.config['environment']['PACKAGE_NAME']} is 3.: (.+)\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r705236701",
      "id" : 705236701,
      "in_reply_to_id" : 705182050,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTIzNjcwMQ==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 68,
      "original_position" : 35,
      "original_start_line" : 66,
      "path" : "test/functional/feature_addrman.py",
      "position" : 35,
      "pull_request_review_id" : 750210838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : 66,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-09T11:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705236701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tACK https://github.com/bitcoin/bitcoin/commit/fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae\r\n\r\nnit: Will be better if error message was printed only once https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-914552140",
      "created_at" : "2021-09-09T12:44:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-916057388",
      "id" : 916057388,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842me0s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916057388/reactions"
      },
      "updated_at" : "2021-09-09T12:44:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916057388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> nit: Will be better if error message was printed only once #22762 (comment)\r\n\r\nInitErrors are printed to the debug log and stderr. I think it makes sense to print them to both instead of only one.",
      "created_at" : "2021-09-09T12:50:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-916061849",
      "id" : 916061849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5842mf6Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916061849/reactions"
      },
      "updated_at" : "2021-09-09T12:50:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916061849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706094821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706094821"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just to clarify that, strictly, this isn't needed. `DbNotFoundError` means that the file wasn't found, so addrman shouldn't be touched at all.\r\n\r\nDoes anyone have opinions on whether to remove it or not?",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-10T11:06:50Z",
      "diff_hunk" : "@@ -176,15 +176,32 @@ bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool ReadPeerAddresses(const ArgsManager& args, CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706094821",
      "id" : 706094821,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjA5NDgyMQ==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 195,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 111,
      "pull_request_review_id" : 751297873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T11:06:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706094821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706108958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706108958"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "But we need to distinguish somehow this from the other error case, so that we don't signal an error to the caller in this case?",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-10T11:34:09Z",
      "diff_hunk" : "@@ -176,15 +176,32 @@ bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool ReadPeerAddresses(const ArgsManager& args, CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706108958",
      "id" : 706108958,
      "in_reply_to_id" : 706094821,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjEwODk1OA==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 195,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 111,
      "pull_request_review_id" : 751316153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T11:34:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706108958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706111057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706111057"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I meant recreating the addrman can be skipped, because it wasn't touched. Saves two lines of code:\r\n\r\n```diff\r\ndiff --git a/src/addrdb.cpp b/src/addrdb.cpp\r\nindex 1e73750ce3..a86f4c3789 100644\r\n--- a/src/addrdb.cpp\r\n+++ b/src/addrdb.cpp\r\n@@ -192,8 +192,6 @@ std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const A\r\n         DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\r\n         LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\r\n     } catch (const DbNotFoundError&) {\r\n-        // Addrman can be in an inconsistent state after failure, reset it\r\n-        addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\r\n         LogPrintf(\"Creating peers.dat because the file was not found (%s)\\n\", path_addr);\r\n         DumpPeerAddresses(args, *addrman);\r\n     } catch (const std::exception& e) {\r\n",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-10T11:37:57Z",
      "diff_hunk" : "@@ -176,15 +176,32 @@ bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool ReadPeerAddresses(const ArgsManager& args, CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706111057",
      "id" : 706111057,
      "in_reply_to_id" : 706094821,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjExMTA1Nw==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 195,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 111,
      "pull_request_review_id" : 751318758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T11:37:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706111057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706124074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706124074"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This would leave the unique_ptr empty and not signal error to the caller. So the caller will continue, possibly dereferencing the empty unique_ptr, leading to undefined behavior?",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-10T12:01:21Z",
      "diff_hunk" : "@@ -176,15 +176,32 @@ bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool ReadPeerAddresses(const ArgsManager& args, CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706124074",
      "id" : 706124074,
      "in_reply_to_id" : 706094821,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjEyNDA3NA==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 195,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 111,
      "pull_request_review_id" : 751335100,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T12:01:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706124074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706135880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706135880"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The pointer is initialized in the beginning of the function. Otherwise `DumpPeerAddresses(args, *addrman);` wouldn't work either.",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-10T12:21:59Z",
      "diff_hunk" : "@@ -176,15 +176,32 @@ bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool ReadPeerAddresses(const ArgsManager& args, CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706135880",
      "id" : 706135880,
      "in_reply_to_id" : 706094821,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjEzNTg4MA==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 195,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 111,
      "pull_request_review_id" : 751350494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T12:21:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706135880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706162067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706162067"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removal LGTM. Built with the suggested diff and tested.",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-10T13:01:42Z",
      "diff_hunk" : "@@ -176,15 +176,32 @@ bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool ReadPeerAddresses(const ArgsManager& args, CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706162067",
      "id" : 706162067,
      "in_reply_to_id" : 706094821,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjE2MjA2Nw==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 195,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 111,
      "pull_request_review_id" : 751385186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T13:01:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706162067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706167815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706167815"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> The pointer is initialized in the beginning of the function\r\n\r\nah, well, then it is ok. ACK.",
      "commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "created_at" : "2021-09-10T13:09:47Z",
      "diff_hunk" : "@@ -176,15 +176,32 @@ bool DumpPeerAddresses(const ArgsManager& args, const CAddrMan& addr)\n     return SerializeFileDB(\"peers\", pathAddr, addr, CLIENT_VERSION);\n }\n \n-bool ReadPeerAddresses(const ArgsManager& args, CAddrMan& addr)\n+void ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n {\n-    const auto pathAddr = args.GetDataDirNet() / \"peers.dat\";\n-    return DeserializeFileDB(pathAddr, addr, CLIENT_VERSION);\n+    DeserializeDB(ssPeers, addr, false);\n }\n \n-bool ReadFromStream(CAddrMan& addr, CDataStream& ssPeers)\n+std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const ArgsManager& args, std::unique_ptr<CAddrMan>& addrman)\n {\n-    return DeserializeDB(ssPeers, addr, false);\n+    auto check_addrman = std::clamp<int32_t>(args.GetArg(\"-checkaddrman\", DEFAULT_ADDRMAN_CONSISTENCY_CHECKS), 0, 1000000);\n+    addrman = std::make_unique<CAddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+\n+    int64_t nStart = GetTimeMillis();\n+    const auto path_addr{args.GetDataDirNet() / \"peers.dat\"};\n+    try {\n+        DeserializeFileDB(path_addr, *addrman, CLIENT_VERSION);\n+        LogPrintf(\"Loaded %i addresses from peers.dat  %dms\\n\", addrman->size(), GetTimeMillis() - nStart);\n+    } catch (const DbNotFoundError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#discussion_r706167815",
      "id" : 706167815,
      "in_reply_to_id" : 706094821,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjE2NzgxNQ==",
      "original_commit_id" : "fa55c3dc1b4bbdc6a53bd11fa6c0b2ec6bbb64ae",
      "original_line" : 195,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 111,
      "pull_request_review_id" : 751392930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22762",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T13:09:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706167815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm not sure it's entirely desirable to require user intervention when downgrading. When there is actual corruption, this may make sense as it's a sign of a deeper problem, but wiping peers.dat when downgrading to an incompatible version seems entirely expected to me.",
      "created_at" : "2021-10-25T15:50:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22762#issuecomment-951063826",
      "id" : 951063826,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22762",
      "node_id" : "IC_kwDOABII5844sBUS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951063826/reactions"
      },
      "updated_at" : "2021-10-25T15:50:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951063826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
