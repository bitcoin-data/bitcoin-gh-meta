[
   {
      "author_association" : "MEMBER",
      "body" : "I don't think this is the right approach, and doesn't fix the underlying bug in #22450. It's addressing the symptom, rather than the fact that addrman's internal datastructures can get into an inconsistent state.",
      "created_at" : "2021-07-15T12:10:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-880642849",
      "id" : 880642849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDY0Mjg0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T12:10:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880642849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cr ACK 816f29eab296ebec2da8f8606ad618609e3ba228\r\n\r\ncan't hurt to check for corrupt data during deserialize \r\n",
      "created_at" : "2021-07-15T12:22:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-880650016",
      "id" : 880650016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDY1MDAxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T12:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880650016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jnewbery, considering https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-880643711, do you think that this PR fixes the underlying bug in #22450?",
      "created_at" : "2021-07-16T07:04:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-881226078",
      "id" : 881226078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "IC_kwDOABII5840hnFe",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-16T07:04:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881226078",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It looks like an improvement, but it doesn't fix the other issue(s) in #22450: https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-880629375",
      "created_at" : "2021-07-16T07:27:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-881237785",
      "id" : 881237785,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "IC_kwDOABII5840hp8Z",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-16T07:27:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881237785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> do you think that this PR fixes the underlying bug\r\n\r\nNo. I agree with Marco that this may be an improvement, but it's not fixing the bugs in #22450.",
      "created_at" : "2021-07-16T07:47:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-881247651",
      "id" : 881247651,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "IC_kwDOABII5840hsWj",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-16T07:47:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881247651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I am talking about the bug that is reported in the #22450 OP/description. Others would need separate PRs. I need to be sure that the #22450 OP/description is fixed properly, which I believe this PR does, but if you disagree, then maybe I am wrong and this PR needs an update.",
      "created_at" : "2021-07-16T07:52:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-881250582",
      "id" : 881250582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "IC_kwDOABII5840htEW",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-16T07:52:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881250582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Maybe remove the \"Fixes #22450\" from OP to avoid closing the issue. We can then use it as meta issue for addrman deserialize bugs.",
      "created_at" : "2021-07-16T08:03:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-881257587",
      "id" : 881257587,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "IC_kwDOABII5840huxz",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-16T08:03:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881257587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm quite anxious about the fact that we're now modifying addrman in a way that apparently introduces inconsistencies.\n\nWould it be possible to just revert that part, and rely on the higher level code to not insert invalid I2P address/ports? That means existing nodes running master won't be able to connect to the I2P addresses existing in their addrman, but I don't think that's much of an issue as I2P support isn't in any release yet?",
      "created_at" : "2021-07-16T15:17:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-881525272",
      "id" : 881525272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "IC_kwDOABII5840iwIY",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-16T15:17:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881525272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Maybe remove the \"Fixes #22450\" from OP to avoid closing the issue. We can then use it as meta issue for addrman deserialize bugs.\r\n\r\nI think it is better to report different problems as separate bug entries, so that none gets forgotten and the conversations do not mix in one bug report. So, now we have:\r\n\r\n1. #22450 (the text \"Introduced in commit e0a2b39\" in the OP is misleading), fixed in #22455. Not relevant to I2P.\r\n\r\n2. #22467, fixed in #22468. A bug in `CAddrMan::ResetI2PPorts()`, found by fuzzing.\r\n\r\n3. #22470, fixed in #22471. A bug in `CAddrMan::ResetI2PPorts()`, found by @jnewbery looking at the code.",
      "created_at" : "2021-07-16T16:39:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-881577240",
      "id" : 881577240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "IC_kwDOABII5840i80Y",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-16T16:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881577240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Upgrading my review ACK to tested ACK using commit fa740252d2dcc272204b745906785fe26e9a0b77 from #22493 and the following diff:\r\n\r\n```diff\r\ndiff --git a/src/addrman.cpp b/src/addrman.cpp\r\nindex 8192b4eba6..4e21062444 100644\r\n--- a/src/addrman.cpp\r\n+++ b/src/addrman.cpp\r\n@@ -468,6 +468,5 @@ int CAddrMan::Check_()\r\n     std::unordered_map<int, int> mapNew;\r\n \r\n-    if (vRandom.size() != (size_t)(nTried + nNew))\r\n-        return -7;\r\n+    assert(vRandom.size() == (size_t)(nTried + nNew));\r\n \r\n     for (const auto& entry : mapInfo) {\r\n```\r\n\r\n[crash-ce5f3356346c37f5a1eb17cf252105a87f6264ea.log](https://github.com/bitcoin/bitcoin/files/6840703/crash-ce5f3356346c37f5a1eb17cf252105a87f6264ea.log)\r\n\r\n\r\nBefore (commit fa740252d2dcc272204b745906785fe26e9a0b77 + patch):\r\n\r\n```\r\n$ FUZZ=addrman ./src/test/fuzz/fuzz ./crash-ce5f3356346c37f5a1eb17cf252105a87f6264ea.log \r\nINFO: Running with entropic power schedule (0xFF, 100).\r\nINFO: Seed: 1743330088\r\nINFO: Loaded 1 modules   (229079 inline 8-bit counters): 229079 [0x556cd64990f8, 0x556cd64d0fcf), \r\nINFO: Loaded 1 PC tables (229079 PCs): 229079 [0x556cd64d0fd0,0x556cd684fd40), \r\n./src/test/fuzz/fuzz: Running 1 inputs 1 time(s) each.\r\nRunning: ./crash-ce5f3356346c37f5a1eb17cf252105a87f6264ea.log\r\nfuzz: addrman.cpp:470: int CAddrMan::Check_(): Assertion `vRandom.size() == (size_t)(nTried + nNew)' failed.\r\n```\r\n\r\nAfter (commit fa740252d2dcc272204b745906785fe26e9a0b77 + patch + 816f29eab296ebec2da8f8606ad618609e3ba228 cherry-picked):\r\n\r\n```\r\n$ FUZZ=addrman ./src/test/fuzz/fuzz ./crash-ce5f3356346c37f5a1eb17cf252105a87f6264ea.log \r\nINFO: Running with entropic power schedule (0xFF, 100).\r\nINFO: Seed: 3797513599\r\nINFO: Loaded 1 modules   (229109 inline 8-bit counters): 229109 [0x5619431f80f8, 0x56194322ffed), \r\nINFO: Loaded 1 PC tables (229109 PCs): 229109 [0x56194322fff0,0x5619435aef40), \r\n./src/test/fuzz/fuzz: Running 1 inputs 1 time(s) each.\r\nRunning: ./crash-ce5f3356346c37f5a1eb17cf252105a87f6264ea.log\r\nExecuted ./crash-ce5f3356346c37f5a1eb17cf252105a87f6264ea.log in 3 ms\r\n***\r\n*** NOTE: fuzzing was not performed, you have only\r\n***       executed the target code on a fixed set of inputs.\r\n***\r\n",
      "created_at" : "2021-07-19T12:24:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22455#issuecomment-882505495",
      "id" : 882505495,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22455",
      "node_id" : "IC_kwDOABII5840mfcX",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-19T12:24:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/882505495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
