[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665699562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665699562"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why the change from `true` -> `false`?",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:54:39Z",
      "diff_hunk" : "@@ -2565,12 +2570,12 @@ bool CChainState::ActivateBestChainStep(BlockValidationState& state, CBlockIndex\n         }\n     }\n \n-    if (fBlocksDisconnected) {\n+    if (fBlocksDisconnected && m_mempool) {\n         // If any blocks were disconnected, disconnectpool may be non empty.  Add\n         // any disconnected transactions back to the mempool.\n-        UpdateMempoolForReorg(*this, m_mempool, disconnectpool, true);\n+        mempoolHandleReorg(disconnectpool, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665699562",
      "id" : 665699562,
      "line" : 2576,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY5OTU2Mg==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2576,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 122,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665699562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700194"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice try, but leaving out the `{}` won't prevent the lock from being closed in the same line.",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:55:46Z",
      "diff_hunk" : "@@ -2642,7 +2647,8 @@ bool CChainState::ActivateBestChain(BlockValidationState& state, std::shared_ptr\n \n         {\n             LOCK(cs_main);\n-            LOCK(m_mempool.cs); // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            if (m_mempool) LOCK(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700194",
      "id" : 665700194,
      "line" : 2651,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMDE5NA==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2651,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 135,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700380"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700380"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:56:03Z",
      "diff_hunk" : "@@ -2792,7 +2803,9 @@ bool CChainState::InvalidateBlock(BlockValidationState& state, CBlockIndex* pind\n         LimitValidationInterfaceQueue();\n \n         LOCK(cs_main);\n-        LOCK(m_mempool.cs); // Lock for as long as disconnectpool is in scope to make sure UpdateMempoolForReorg is called after DisconnectTip without unlocking in between\n+        // Lock for as long as disconnectpool is in scope to make sure UpdateMempoolForReorg is\n+        // called after DisconnectTip without unlocking in between\n+        if (m_mempool) LOCK(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700380",
      "id" : 665700380,
      "line" : 2808,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMDM4MA==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2808,
      "original_position" : 160,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 160,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700380",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700718"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nvoid CChainState::mempoolHandleReorg(DisconnectedBlockTransactions& disconnectpool, bool add_to_mempool)\r\n{\r\n```\r\n\r\nproperly format new code?",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:56:41Z",
      "diff_hunk" : "@@ -4492,6 +4506,41 @@ bool CChainState::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n     return ret;\n }\n \n+void CChainState::mempoolHandleReorg(DisconnectedBlockTransactions& disconnectpool, bool add_to_mempool) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700718",
      "id" : 665700718,
      "line" : 4509,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMDcxOA==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 4509,
      "original_position" : 191,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 191,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665701402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665701402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would it be possible to combine the args so that *either* a mempool, or a hash can be passed, but not both? I think std::variant can do this",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:57:56Z",
      "diff_hunk" : "@@ -600,7 +601,7 @@ class CChainState\n     //! CChainState instances.\n     BlockManager& m_blockman;\n \n-    explicit CChainState(CTxMemPool& mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n+    explicit CChainState(CTxMemPool* mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665701402",
      "id" : 665701402,
      "line" : 604,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMTQwMg==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 604,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 17,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665701402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. I think you can drop the second commit and add a `LOCK_RETURNED` helper method to be able to keep using lock annotations when m_mempool is null:\r\n\r\n```c++\r\nRecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs) { return m_mempool ? &m_mempool->cs : nullptr; }\r\n```\r\n\r\nSeems to work for me in commit 8db5953e2d666fb9c25ae8f0df5b4c5c5897cd58\r\n",
      "created_at" : "2021-07-07T23:24:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-875999127",
      "id" : 875999127,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTk5OTEyNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T23:24:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875999127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #22371 by MarcoFalke\n* #21526 by jamesob\n* #21464 by JeremyRubin\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-07-08T00:48:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876031066",
      "id" : 876031066,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjAzMTA2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-10T11:03:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876031066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665807596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665807596"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hey somebody's gotta keep review fun!",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-08T01:31:20Z",
      "diff_hunk" : "@@ -2565,12 +2570,12 @@ bool CChainState::ActivateBestChainStep(BlockValidationState& state, CBlockIndex\n         }\n     }\n \n-    if (fBlocksDisconnected) {\n+    if (fBlocksDisconnected && m_mempool) {\n         // If any blocks were disconnected, disconnectpool may be non empty.  Add\n         // any disconnected transactions back to the mempool.\n-        UpdateMempoolForReorg(*this, m_mempool, disconnectpool, true);\n+        mempoolHandleReorg(disconnectpool, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665807596",
      "id" : 665807596,
      "in_reply_to_id" : 665699562,
      "line" : 2576,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTgwNzU5Ng==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2576,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 122,
      "pull_request_review_id" : 701567478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T01:31:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665807596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665807889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665807889"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh yeah d'oh. Sure could've used those missing annotations there.",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-08T01:32:21Z",
      "diff_hunk" : "@@ -2642,7 +2647,8 @@ bool CChainState::ActivateBestChain(BlockValidationState& state, std::shared_ptr\n \n         {\n             LOCK(cs_main);\n-            LOCK(m_mempool.cs); // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            if (m_mempool) LOCK(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665807889",
      "id" : 665807889,
      "in_reply_to_id" : 665700194,
      "line" : 2651,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTgwNzg4OQ==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2651,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 135,
      "pull_request_review_id" : 701567847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T01:32:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665807889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased to remove the second commit per Russ' suggestion, which also addresses most of Marco's feedback.\r\n\r\n> Seems to work for me in commit 8db5953\r\n\r\nWow, that was wizardly. Thanks @ryanofsky!\r\n\r\n> I think std::variant can do this\r\n\r\nI'll look into this tomorrow.",
      "created_at" : "2021-07-08T02:05:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876061371",
      "id" : 876061371,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjA2MTM3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T02:05:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876061371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666040037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666040037"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Similarly to [this comment](https://github.com/bitcoin/bitcoin/pull/22415/commits/b17bb4c37d58ca49e877983a632bfcaa493be993#r665701402), can we somehow reflect that if mempool is nullptr, the second argument doesn't make sense?",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T09:45:48Z",
      "diff_hunk" : "@@ -907,7 +913,7 @@ class ChainstateManager\n     //                                  constructor\n     //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n     //!                                 is based on a snapshot.\n-    CChainState& InitializeChainstate(CTxMemPool& mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)\n+    CChainState& InitializeChainstate(CTxMemPool* mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666040037",
      "id" : 666040037,
      "line" : 916,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjA0MDAzNw==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 916,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 58,
      "pull_request_review_id" : 701858949,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T09:45:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666040037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Light code review ACK b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T09:46:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876296570",
      "id" : 876296570,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjI5NjU3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T09:46:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876296570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666144964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666144964"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    RecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs)\r\n    {\r\n```\r\n\r\nclang-format?",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T12:27:09Z",
      "diff_hunk" : "@@ -798,6 +799,11 @@ class CChainState\n \n     bool LoadBlockIndexDB() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Indirection necessary to make lock annotations work with an optional mempool.\n+    RecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666144964",
      "id" : 666144964,
      "line" : 803,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjE0NDk2NA==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 803,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 46,
      "pull_request_review_id" : 701997551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T12:27:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666144964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666249472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666249472"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: make CChainState::m_mempool optional\" (b17bb4c37d58ca49e877983a632bfcaa493be993)\r\n\r\nMight be a little more obviously safe to write `Assert(node.mempool.get())` instead of `Assert(node.mempool).get()` since that version looks like the Assert function might be returning a temporary `unique_ptr` that would delete the mempool.",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T14:31:26Z",
      "diff_hunk" : "@@ -1349,7 +1349,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n             const int64_t load_block_index_start_time = GetTimeMillis();\n             try {\n                 LOCK(cs_main);\n-                chainman.InitializeChainstate(*Assert(node.mempool));\n+                chainman.InitializeChainstate(Assert(node.mempool).get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666249472",
      "id" : 666249472,
      "line" : 1352,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjI0OTQ3Mg==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 1352,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 5,
      "pull_request_review_id" : 702140548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T15:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666249472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, will review on next push.",
      "created_at" : "2021-07-08T14:52:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876506636",
      "id" : 876506636,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjUwNjYzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T14:52:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876506636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666272104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666272104"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: make CChainState::m_mempool optional\" (b17bb4c37d58ca49e877983a632bfcaa493be993)\r\n\r\nNote: It could be nice to be able to write `AssertLockHeld(MempoolMutex()` for consistency with `LOCK(MempoolMutex())` and to avoid the if statement. But it'd be beyond scope of this PR since it'd require changing `AssertLockHeld` and there are other issues with that function anyway.",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T14:56:05Z",
      "diff_hunk" : "@@ -2254,7 +2257,7 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTransactions* disconnectpool)\n {\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(m_mempool.cs);\n+    if (m_mempool) AssertLockHeld(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666272104",
      "id" : 666272104,
      "line" : 2260,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjI3MjEwNA==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 2260,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 49,
      "pull_request_review_id" : 702140548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T15:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666272104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666275700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666275700"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: make CChainState::m_mempool optional\" (b17bb4c37d58ca49e877983a632bfcaa493be993)\r\n\r\nNote: Naively I'd expect the mempool pointer for the activated snapshot to be non-null, but I guess it could be set later when the snapshot is fully initialized.",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T14:59:59Z",
      "diff_hunk" : "@@ -4763,7 +4772,7 @@ bool ChainstateManager::ActivateSnapshot(\n     }\n \n     auto snapshot_chainstate = WITH_LOCK(::cs_main, return std::make_unique<CChainState>(\n-            this->ActiveChainstate().m_mempool, m_blockman, base_blockhash));\n+            nullptr, m_blockman, base_blockhash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666275700",
      "id" : 666275700,
      "line" : 4775,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjI3NTcwMA==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 4775,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 183,
      "pull_request_review_id" : 702140548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T15:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666275700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.\r\n\r\n> Note: Naively I'd expect the mempool pointer for the activated snapshot to be non-null, but I guess it could be set later when the snapshot is fully initialized.\r\n\r\nThis is a good point. I'd come up with a commit that implements the `std::variant` feedback (and am glad to have for learning about that), but @ryanofsky's point here makes that change inappropriate: with assumeutxo, we may actually want the snapshot chain to have a non-null mempool if we're in, say, init.cpp and loading a snapshot chainstate that is active but not yet at tip.\r\n\r\nI've covered all of the other feedback aside from the lock assertion for the reasons Russ mentioned; maybe we can get around to it later.",
      "created_at" : "2021-07-08T16:13:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876568120",
      "id" : 876568120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjU2ODEyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T16:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876568120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666340082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666340082"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not going this route for reasons mentioned in a recent comment: passing both is a valid approach if we are initializing a not-yet-to-tip snapshot chainstate in init.cpp.",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-08T16:18:28Z",
      "diff_hunk" : "@@ -600,7 +601,7 @@ class CChainState\n     //! CChainState instances.\n     BlockManager& m_blockman;\n \n-    explicit CChainState(CTxMemPool& mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n+    explicit CChainState(CTxMemPool* mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666340082",
      "id" : 666340082,
      "in_reply_to_id" : 665701402,
      "line" : 604,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjM0MDA4Mg==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 604,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 17,
      "pull_request_review_id" : 702263693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T16:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666340082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666340418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666340418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-08T16:18:59Z",
      "diff_hunk" : "@@ -1349,7 +1349,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n             const int64_t load_block_index_start_time = GetTimeMillis();\n             try {\n                 LOCK(cs_main);\n-                chainman.InitializeChainstate(*Assert(node.mempool));\n+                chainman.InitializeChainstate(Assert(node.mempool).get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666340418",
      "id" : 666340418,
      "in_reply_to_id" : 666249472,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjM0MDQxOA==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 1352,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 702264178,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T16:18:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666340418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666368135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666368135"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(if you retouch)\r\n```suggestion\r\n            /* mempool */ nullptr, m_blockman, base_blockhash));\r\n```",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-08T16:57:50Z",
      "diff_hunk" : "@@ -4763,7 +4772,7 @@ bool ChainstateManager::ActivateSnapshot(\n     }\n \n     auto snapshot_chainstate = WITH_LOCK(::cs_main, return std::make_unique<CChainState>(\n-            this->ActiveChainstate().m_mempool, m_blockman, base_blockhash));\n+            nullptr, m_blockman, base_blockhash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666368135",
      "id" : 666368135,
      "line" : 4775,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjM2ODEzNQ==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 4775,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 183,
      "pull_request_review_id" : 702300732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T17:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666368135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666708997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666708997"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\n\r\nWhat do you think about making this std::optional<CTxMemPool, std::optional>?\r\n\r\nIn this case, snapshot_blockhash can't be possibly specified without mempool, and that's what I originally suggested.\r\n",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-09T06:41:51Z",
      "diff_hunk" : "@@ -907,7 +914,7 @@ class ChainstateManager\n     //                                  constructor\n     //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n     //!                                 is based on a snapshot.\n-    CChainState& InitializeChainstate(CTxMemPool& mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)\n+    CChainState& InitializeChainstate(CTxMemPool* mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666708997",
      "id" : 666708997,
      "line" : 917,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjcwODk5Nw==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 917,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 59,
      "pull_request_review_id" : 702727979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T06:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666708997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666864433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666864433"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since you're updating both call sites for `CChainState::GetCoinsCacheSizeState(const CTxMemPool* tx_pool)`, maybe it makes sense to just remove the argument. There's no need to pass a data member of `CChainState` to a member function of `CChainState` - it can just use its own `m_mempool`.",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-09T10:59:54Z",
      "diff_hunk" : "@@ -2053,7 +2054,7 @@ bool CChainState::FlushStateToDisk(\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n \n-        CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n+        CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(m_mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666864433",
      "id" : 666864433,
      "line" : 2057,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Njg2NDQzMw==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2057,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 702933845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T11:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666864433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666871618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666871618"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This `if (m_mempool)` condition can be at the level of the `if (disconnectpool)` above:\r\n\r\n```diff\r\n         return false;\r\n     }\r\n \r\n-    if (disconnectpool) {\r\n+    if (m_mempool && disconnectpool) {\r\n         // Save transactions to re-add to mempool at end of reorg\r\n         for (auto it = block.vtx.rbegin(); it != block.vtx.rend(); ++it) {\r\n             disconnectpool->addTransaction(*it);\r\n@@ -2291,7 +2291,7 @@ bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTr\r\n         while (disconnectpool->DynamicMemoryUsage() > MAX_DISCONNECTED_TX_POOL_SIZE * 1000) {\r\n             // Drop the earliest entry, and remove its children from the mempool.\r\n             auto it = disconnectpool->queuedTx.get<insertion_order>().begin();\r\n-            if (m_mempool) m_mempool->removeRecursive(**it, MemPoolRemovalReason::REORG);\r\n+            m_mempool->removeRecursive(**it, MemPoolRemovalReason::REORG);\r\n             disconnectpool->removeEntry(it);\r\n         }\r\n     }\r\n```\r\n\r\nThat would potentially save some work updating the `disconnectpool` data structure, which will never get used.\r\n\r\nEven better (but not necessarily part of this PR) would be to only create a `DisconnectedBlockTransactions` if `m_mempool` is non-null, and then update ` UpdateMempoolForReorg()` and ` DisconnectedBlockTransactions()` to take optional `DisconnectedBlockTransactions*`. There's no need to create and maintain a `DisconnectedBlockTransactions` if we're never going to use it.",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-09T11:13:42Z",
      "diff_hunk" : "@@ -2288,7 +2291,7 @@ bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTr\n         while (disconnectpool->DynamicMemoryUsage() > MAX_DISCONNECTED_TX_POOL_SIZE * 1000) {\n             // Drop the earliest entry, and remove its children from the mempool.\n             auto it = disconnectpool->queuedTx.get<insertion_order>().begin();\n-            m_mempool.removeRecursive(**it, MemPoolRemovalReason::REORG);\n+            if (m_mempool) m_mempool->removeRecursive(**it, MemPoolRemovalReason::REORG);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666871618",
      "id" : 666871618,
      "line" : 2294,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Njg3MTYxOA==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2294,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 58,
      "pull_request_review_id" : 702933845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T11:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666871618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666874055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666874055"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This could be a member of `CChainState` to avoid passing `mempool`, `chainParams` and `active_chainstate`.",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-09T11:16:59Z",
      "diff_hunk" : "@@ -2205,11 +2206,13 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n }\n \n /** Check warning conditions and do some notifications on new chain tip set. */\n-static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& active_chainstate)\n+static void UpdateTip(CTxMemPool* mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& active_chainstate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666874055",
      "id" : 666874055,
      "line" : 2209,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Njg3NDA1NQ==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2209,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 33,
      "pull_request_review_id" : 702933845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T11:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666874055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666875394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666875394"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to update `disconnectpool` if the mempool doesn't exist:\r\n\r\n```suggestion\r\n    if (m_mempool) {\r\n        m_mempool->removeForBlock(blockConnecting.vtx, pindexNew->nHeight);\r\n        disconnectpool.removeForBlock(blockConnecting.vtx);\r\n    }\r\n```",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-09T11:19:39Z",
      "diff_hunk" : "@@ -2401,7 +2404,7 @@ bool CChainState::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew\n     int64_t nTime5 = GetTimeMicros(); nTimeChainState += nTime5 - nTime4;\n     LogPrint(BCLog::BENCH, \"  - Writing chainstate: %.2fms [%.2fs (%.2fms/blk)]\\n\", (nTime5 - nTime4) * MILLI, nTimeChainState * MICRO, nTimeChainState * MILLI / nBlocksTotal);\n     // Remove conflicting transactions from the mempool.;\n-    m_mempool.removeForBlock(blockConnecting.vtx, pindexNew->nHeight);\n+    if (m_mempool) m_mempool->removeForBlock(blockConnecting.vtx, pindexNew->nHeight);\n     disconnectpool.removeForBlock(blockConnecting.vtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666875394",
      "id" : 666875394,
      "line" : 2408,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Njg3NTM5NA==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2408,
      "original_position" : 77,
      "original_start_line" : 2407,
      "path" : "src/validation.cpp",
      "position" : 77,
      "pull_request_review_id" : 702933845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : 2407,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-09T11:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666875394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666881091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666881091"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think about updating `UpdateMempoolForReorg` to either be a member of `CChainState` or take `CTxMemPool` as an optional pointer, and then return immediately if mempool is null. That would avoid scattering so many `if (m_mempool)` checks across multiple validation functions.",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-09T11:30:49Z",
      "diff_hunk" : "@@ -2507,7 +2510,7 @@ bool CChainState::ActivateBestChainStep(BlockValidationState& state, CBlockIndex\n         if (!DisconnectTip(state, &disconnectpool)) {\n             // This is likely a fatal error, but keep the mempool consistent,\n             // just in case. Only remove from the mempool in this case.\n-            UpdateMempoolForReorg(*this, m_mempool, disconnectpool, false);\n+            if (m_mempool) UpdateMempoolForReorg(*this, *m_mempool, disconnectpool, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666881091",
      "id" : 666881091,
      "line" : 2513,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Njg4MTA5MQ==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2513,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 702933845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T11:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666881091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667100285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667100285"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good call! Done. ",
      "commit_id" : "29acd850fb0539b8358a451089ef7b1c583dd1a1",
      "created_at" : "2021-07-09T17:16:52Z",
      "diff_hunk" : "@@ -2053,7 +2054,7 @@ bool CChainState::FlushStateToDisk(\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n \n-        CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n+        CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(m_mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667100285",
      "id" : 667100285,
      "in_reply_to_id" : 666864433,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzEwMDI4NQ==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2057,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 703250886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T17:16:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667100285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667101066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667101066"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yup, also a good call. Fixed. Initially wasn't sure if there was some other purpose we might be using the disconnectpool for (since it's sometimes passed in as a mutable parameter) but after looking around it's clearly just used for mempool maintenance.",
      "commit_id" : "29acd850fb0539b8358a451089ef7b1c583dd1a1",
      "created_at" : "2021-07-09T17:18:21Z",
      "diff_hunk" : "@@ -2288,7 +2291,7 @@ bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTr\n         while (disconnectpool->DynamicMemoryUsage() > MAX_DISCONNECTED_TX_POOL_SIZE * 1000) {\n             // Drop the earliest entry, and remove its children from the mempool.\n             auto it = disconnectpool->queuedTx.get<insertion_order>().begin();\n-            m_mempool.removeRecursive(**it, MemPoolRemovalReason::REORG);\n+            if (m_mempool) m_mempool->removeRecursive(**it, MemPoolRemovalReason::REORG);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667101066",
      "id" : 667101066,
      "in_reply_to_id" : 666871618,
      "line" : 2294,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzEwMTA2Ng==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2294,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 159,
      "pull_request_review_id" : 703251951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T17:18:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667101066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667101218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667101218"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed, done.",
      "commit_id" : "29acd850fb0539b8358a451089ef7b1c583dd1a1",
      "created_at" : "2021-07-09T17:18:37Z",
      "diff_hunk" : "@@ -2205,11 +2206,13 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n }\n \n /** Check warning conditions and do some notifications on new chain tip set. */\n-static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& active_chainstate)\n+static void UpdateTip(CTxMemPool* mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& active_chainstate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667101218",
      "id" : 667101218,
      "in_reply_to_id" : 666874055,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzEwMTIxOA==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2209,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 703252145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T17:18:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667101218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667101302"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667101302"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":+1: ",
      "commit_id" : "29acd850fb0539b8358a451089ef7b1c583dd1a1",
      "created_at" : "2021-07-09T17:18:48Z",
      "diff_hunk" : "@@ -2401,7 +2404,7 @@ bool CChainState::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew\n     int64_t nTime5 = GetTimeMicros(); nTimeChainState += nTime5 - nTime4;\n     LogPrint(BCLog::BENCH, \"  - Writing chainstate: %.2fms [%.2fs (%.2fms/blk)]\\n\", (nTime5 - nTime4) * MILLI, nTimeChainState * MICRO, nTimeChainState * MILLI / nBlocksTotal);\n     // Remove conflicting transactions from the mempool.;\n-    m_mempool.removeForBlock(blockConnecting.vtx, pindexNew->nHeight);\n+    if (m_mempool) m_mempool->removeForBlock(blockConnecting.vtx, pindexNew->nHeight);\n     disconnectpool.removeForBlock(blockConnecting.vtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667101302",
      "id" : 667101302,
      "in_reply_to_id" : 666875394,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzEwMTMwMg==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2408,
      "original_position" : 77,
      "original_start_line" : 2407,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 703252254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-09T17:18:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667101302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667101565"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667101565"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I went ahead and threw it onto `CChainState` since I think that makes sense; can strip off the commit if there are any objections.",
      "commit_id" : "29acd850fb0539b8358a451089ef7b1c583dd1a1",
      "created_at" : "2021-07-09T17:19:19Z",
      "diff_hunk" : "@@ -2507,7 +2510,7 @@ bool CChainState::ActivateBestChainStep(BlockValidationState& state, CBlockIndex\n         if (!DisconnectTip(state, &disconnectpool)) {\n             // This is likely a fatal error, but keep the mempool consistent,\n             // just in case. Only remove from the mempool in this case.\n-            UpdateMempoolForReorg(*this, m_mempool, disconnectpool, false);\n+            if (m_mempool) UpdateMempoolForReorg(*this, *m_mempool, disconnectpool, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667101565",
      "id" : 667101565,
      "in_reply_to_id" : 666881091,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzEwMTU2NQ==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 2513,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 703252618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T17:19:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667101565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667102878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667102878"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There are cases when we want to call this with a snapshot blockhash but not a mempool - during snapshot load time when we need a chainstate instance to populate/validate but don't want to yet make it the active chainstate in case loading the UTXO snapshot fails.",
      "commit_id" : "29acd850fb0539b8358a451089ef7b1c583dd1a1",
      "created_at" : "2021-07-09T17:21:43Z",
      "diff_hunk" : "@@ -907,7 +914,7 @@ class ChainstateManager\n     //                                  constructor\n     //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n     //!                                 is based on a snapshot.\n-    CChainState& InitializeChainstate(CTxMemPool& mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)\n+    CChainState& InitializeChainstate(CTxMemPool* mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667102878",
      "id" : 667102878,
      "in_reply_to_id" : 666708997,
      "line" : 924,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzEwMjg3OA==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 924,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 80,
      "pull_request_review_id" : 703254307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T17:21:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667102878",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the prompt attention, good people. I've pushed a rebase that includes pretty much all of @jnewbery's feedback. This widens the scope of the PR to encompass a bit of refactoring, but I think it's all reasonable stuff to include here.",
      "created_at" : "2021-07-09T17:24:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-877340546",
      "id" : 877340546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NzM0MDU0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-09T17:24:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/877340546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667134941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667134941"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor: move UpdateMempoolForReorg into CChainState\" (7cdcd08d665570167b06a93e003369f7fa833cec)\r\n\r\n`active_chainstate` is always `*this` right? Can the parameter be dropped?",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-09T18:21:43Z",
      "diff_hunk" : "@@ -342,11 +342,15 @@ static bool IsCurrentForFeeEstimation(CChainState& active_chainstate) EXCLUSIVE_\n  * Passing fAddToMempool=false will skip trying to add the transactions back,\n  * and instead just erase from the mempool as needed.\n  */\n-\n-static void UpdateMempoolForReorg(CChainState& active_chainstate, CTxMemPool& mempool, DisconnectedBlockTransactions& disconnectpool, bool fAddToMempool) EXCLUSIVE_LOCKS_REQUIRED(cs_main, mempool.cs)\n+void CChainState::UpdateMempoolForReorg(\n+    CChainState& active_chainstate,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667134941",
      "id" : 667134941,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzEzNDk0MQ==",
      "original_commit_id" : "7cdcd08d665570167b06a93e003369f7fa833cec",
      "original_line" : 346,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 703295494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T18:28:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667134941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667148994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667148994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, thanks. Always weary to assume active_chainstate == *this, but in this case (as you probably realized) only the active ever has a mempool, so it's a fine substitution.",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-09T18:49:27Z",
      "diff_hunk" : "@@ -342,11 +342,15 @@ static bool IsCurrentForFeeEstimation(CChainState& active_chainstate) EXCLUSIVE_\n  * Passing fAddToMempool=false will skip trying to add the transactions back,\n  * and instead just erase from the mempool as needed.\n  */\n-\n-static void UpdateMempoolForReorg(CChainState& active_chainstate, CTxMemPool& mempool, DisconnectedBlockTransactions& disconnectpool, bool fAddToMempool) EXCLUSIVE_LOCKS_REQUIRED(cs_main, mempool.cs)\n+void CChainState::UpdateMempoolForReorg(\n+    CChainState& active_chainstate,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667148994",
      "id" : 667148994,
      "in_reply_to_id" : 667134941,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzE0ODk5NA==",
      "original_commit_id" : "7cdcd08d665570167b06a93e003369f7fa833cec",
      "original_line" : 346,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 703313303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T18:49:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667148994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebase to incorporate minor changes from @ryanofsky's feedback (https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667134941).",
      "created_at" : "2021-07-09T18:50:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-877389354",
      "id" : 877389354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NzM4OTM1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-09T18:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/877389354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667711900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667711900"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This new `if` here is not needed, it's augmented by the check you added above (`if (disconnectpool && m_mempool) {`)? ",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-12T08:02:52Z",
      "diff_hunk" : "@@ -2280,15 +2283,15 @@ bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTr\n         return false;\n     }\n \n-    if (disconnectpool) {\n+    if (disconnectpool && m_mempool) {\n         // Save transactions to re-add to mempool at end of reorg\n         for (auto it = block.vtx.rbegin(); it != block.vtx.rend(); ++it) {\n             disconnectpool->addTransaction(*it);\n         }\n         while (disconnectpool->DynamicMemoryUsage() > MAX_DISCONNECTED_TX_POOL_SIZE * 1000) {\n             // Drop the earliest entry, and remove its children from the mempool.\n             auto it = disconnectpool->queuedTx.get<insertion_order>().begin();\n-            m_mempool.removeRecursive(**it, MemPoolRemovalReason::REORG);\n+            if (m_mempool) m_mempool->removeRecursive(**it, MemPoolRemovalReason::REORG);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667711900",
      "id" : 667711900,
      "line" : 2299,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzcxMTkwMA==",
      "original_commit_id" : "ad911753a1af3a10f9e74a78a066ed4f1e40ce4d",
      "original_line" : 2294,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 164,
      "pull_request_review_id" : 703825628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T08:04:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667711900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667716247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667716247"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Mixed feelings about this change. I like params reduction, but I think a reader might get confused: \"`UpdateMempoolForReorg`? But I don't have mempool.\"\r\n\r\nI would slightly prefer changing the name to `UpdateMempoolForReorgIfExists` or `TryUpdateMempoolForReorg`, but feel free to ignore.",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-12T08:09:50Z",
      "diff_hunk" : "@@ -342,11 +342,14 @@ static bool IsCurrentForFeeEstimation(CChainState& active_chainstate) EXCLUSIVE_\n  * Passing fAddToMempool=false will skip trying to add the transactions back,\n  * and instead just erase from the mempool as needed.\n  */\n-\n-static void UpdateMempoolForReorg(CChainState& active_chainstate, CTxMemPool& mempool, DisconnectedBlockTransactions& disconnectpool, bool fAddToMempool) EXCLUSIVE_LOCKS_REQUIRED(cs_main, mempool.cs)\n+void CChainState::UpdateMempoolForReorg(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667716247",
      "id" : 667716247,
      "line" : 345,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzcxNjI0Nw==",
      "original_commit_id" : "1e0262e04093f62b13f83da7c3b2be0b51ddbe1b",
      "original_line" : 345,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 703831648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T08:10:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667716247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667833810"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667833810"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This could be a const pointer:\r\n\r\n```suggestion\r\n    CTxMemPool* const m_mempool;\r\n```\r\n\r\nsince it's set in the initializer list and never modified.",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-12T11:03:22Z",
      "diff_hunk" : "@@ -587,8 +587,9 @@ class CChainState\n      */\n     mutable std::atomic<bool> m_cached_finished_ibd{false};\n \n-    //! mempool that is kept in sync with the chain\n-    CTxMemPool& m_mempool;\n+    //! Optional mempool that is kept in sync with the chain.\n+    //! Only the active chainstate has a mempool.\n+    CTxMemPool* m_mempool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667833810",
      "id" : 667833810,
      "line" : 592,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzgzMzgxMA==",
      "original_commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "original_line" : 592,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 8,
      "pull_request_review_id" : 703984078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T11:09:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667833810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667837165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667837165"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was also surprised by this. Is the snapshot chainstate the one that eventually becomes our tip? In that case, don't we want it to have a mempool?",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-12T11:09:24Z",
      "diff_hunk" : "@@ -4763,7 +4772,7 @@ bool ChainstateManager::ActivateSnapshot(\n     }\n \n     auto snapshot_chainstate = WITH_LOCK(::cs_main, return std::make_unique<CChainState>(\n-            this->ActiveChainstate().m_mempool, m_blockman, base_blockhash));\n+            nullptr, m_blockman, base_blockhash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667837165",
      "id" : 667837165,
      "in_reply_to_id" : 666275700,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzgzNzE2NQ==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 4775,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 703984078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T11:09:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667837165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667838641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667838641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: doxygen function comments should go with the function declaration. Do you mind moving this to the header file now that the declaration is there?",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-12T11:11:51Z",
      "diff_hunk" : "@@ -329,7 +329,8 @@ static bool IsCurrentForFeeEstimation(CChainState& active_chainstate) EXCLUSIVE_\n     return true;\n }\n \n-/* Make mempool consistent after a reorg, by re-adding or recursively erasing\n+/**",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667838641",
      "id" : 667838641,
      "line" : 332,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzgzODY0MQ==",
      "original_commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "original_line" : 332,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 703990431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T11:18:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667838641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667842272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667842272"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for the `CChainState& active_chainstate` argument - this is a private method in `CChainState` where the `active_chainstate` arg is always `*this`. You can remove the argument and use the implicit `this` inside the function.",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-12T11:18:06Z",
      "diff_hunk" : "@@ -798,6 +797,20 @@ class CChainState\n \n     bool LoadBlockIndexDB() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Indirection necessary to make lock annotations work with an optional mempool.\n+    RecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs)\n+    {\n+        return m_mempool ? &m_mempool->cs : nullptr;\n+    }\n+\n+    void UpdateMempoolForReorg(\n+        DisconnectedBlockTransactions& disconnectpool,\n+        bool fAddToMempool) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_mempool->cs);\n+\n+    /** Check warning conditions and do some notifications on new chain tip set. */\n+    void UpdateTip(const CBlockIndex* pindexNew, CChainState& active_chainstate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r667842272",
      "id" : 667842272,
      "line" : 811,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Nzg0MjI3Mg==",
      "original_commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "original_line" : 811,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 68,
      "pull_request_review_id" : 703990431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T11:18:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667842272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668111707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668111707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, this is a little confusing absent context, but basically the idea per @ryanofsky's feedback is that mempool presence should be used to indicate chainstate activeness, so we don't want to give the snapshot chainstate a mempool until we consider it active.",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-12T17:13:15Z",
      "diff_hunk" : "@@ -4763,7 +4772,7 @@ bool ChainstateManager::ActivateSnapshot(\n     }\n \n     auto snapshot_chainstate = WITH_LOCK(::cs_main, return std::make_unique<CChainState>(\n-            this->ActiveChainstate().m_mempool, m_blockman, base_blockhash));\n+            nullptr, m_blockman, base_blockhash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668111707",
      "id" : 668111707,
      "in_reply_to_id" : 666275700,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODExMTcwNw==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 4775,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 704355399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T17:13:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668111707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668113712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668113712"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The pointer may actually be nulled out e.g. when we transition the initial IBD chainstate to the background (and give its mempool to the snapshot chainstate, which becomes our active).",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-12T17:16:17Z",
      "diff_hunk" : "@@ -587,8 +587,9 @@ class CChainState\n      */\n     mutable std::atomic<bool> m_cached_finished_ibd{false};\n \n-    //! mempool that is kept in sync with the chain\n-    CTxMemPool& m_mempool;\n+    //! Optional mempool that is kept in sync with the chain.\n+    //! Only the active chainstate has a mempool.\n+    CTxMemPool* m_mempool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668113712",
      "id" : 668113712,
      "in_reply_to_id" : 667833810,
      "line" : 592,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODExMzcxMg==",
      "original_commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "original_line" : 592,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 8,
      "pull_request_review_id" : 704358127,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T17:16:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668113712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668125115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668125115"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah, ok! I'm not totally up to date on how the different chainstate objects work in assumeutxo.",
      "commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "created_at" : "2021-07-12T17:33:21Z",
      "diff_hunk" : "@@ -587,8 +587,9 @@ class CChainState\n      */\n     mutable std::atomic<bool> m_cached_finished_ibd{false};\n \n-    //! mempool that is kept in sync with the chain\n-    CTxMemPool& m_mempool;\n+    //! Optional mempool that is kept in sync with the chain.\n+    //! Only the active chainstate has a mempool.\n+    CTxMemPool* m_mempool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668125115",
      "id" : 668125115,
      "in_reply_to_id" : 667833810,
      "line" : 592,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODEyNTExNQ==",
      "original_commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "original_line" : 592,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 8,
      "pull_request_review_id" : 704373007,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T17:33:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668125115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668143212"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668143212"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good call - weird, thought I had made that change... maybe lost in rebase shuffle.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-12T18:00:16Z",
      "diff_hunk" : "@@ -798,6 +797,20 @@ class CChainState\n \n     bool LoadBlockIndexDB() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Indirection necessary to make lock annotations work with an optional mempool.\n+    RecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs)\n+    {\n+        return m_mempool ? &m_mempool->cs : nullptr;\n+    }\n+\n+    void UpdateMempoolForReorg(\n+        DisconnectedBlockTransactions& disconnectpool,\n+        bool fAddToMempool) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_mempool->cs);\n+\n+    /** Check warning conditions and do some notifications on new chain tip set. */\n+    void UpdateTip(const CBlockIndex* pindexNew, CChainState& active_chainstate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668143212",
      "id" : 668143212,
      "in_reply_to_id" : 667842272,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODE0MzIxMg==",
      "original_commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "original_line" : 811,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 704396284,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T18:00:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668143212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668169676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668169676"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks!",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-12T18:42:57Z",
      "diff_hunk" : "@@ -329,7 +329,8 @@ static bool IsCurrentForFeeEstimation(CChainState& active_chainstate) EXCLUSIVE_\n     return true;\n }\n \n-/* Make mempool consistent after a reorg, by re-adding or recursively erasing\n+/**",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668169676",
      "id" : 668169676,
      "in_reply_to_id" : 667838641,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODE2OTY3Ng==",
      "original_commit_id" : "e34a992baedcac7514b82fa27c2c05a720c1df3d",
      "original_line" : 332,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 704431511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T18:42:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668169676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668169812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668169812"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sounds good, fixed.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-12T18:43:09Z",
      "diff_hunk" : "@@ -342,11 +342,14 @@ static bool IsCurrentForFeeEstimation(CChainState& active_chainstate) EXCLUSIVE_\n  * Passing fAddToMempool=false will skip trying to add the transactions back,\n  * and instead just erase from the mempool as needed.\n  */\n-\n-static void UpdateMempoolForReorg(CChainState& active_chainstate, CTxMemPool& mempool, DisconnectedBlockTransactions& disconnectpool, bool fAddToMempool) EXCLUSIVE_LOCKS_REQUIRED(cs_main, mempool.cs)\n+void CChainState::UpdateMempoolForReorg(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668169812",
      "id" : 668169812,
      "in_reply_to_id" : 667716247,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODE2OTgxMg==",
      "original_commit_id" : "1e0262e04093f62b13f83da7c3b2be0b51ddbe1b",
      "original_line" : 345,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 704431670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T18:43:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668169812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668169895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668169895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, thanks.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-12T18:43:17Z",
      "diff_hunk" : "@@ -2280,15 +2283,15 @@ bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTr\n         return false;\n     }\n \n-    if (disconnectpool) {\n+    if (disconnectpool && m_mempool) {\n         // Save transactions to re-add to mempool at end of reorg\n         for (auto it = block.vtx.rbegin(); it != block.vtx.rend(); ++it) {\n             disconnectpool->addTransaction(*it);\n         }\n         while (disconnectpool->DynamicMemoryUsage() > MAX_DISCONNECTED_TX_POOL_SIZE * 1000) {\n             // Drop the earliest entry, and remove its children from the mempool.\n             auto it = disconnectpool->queuedTx.get<insertion_order>().begin();\n-            m_mempool.removeRecursive(**it, MemPoolRemovalReason::REORG);\n+            if (m_mempool) m_mempool->removeRecursive(**it, MemPoolRemovalReason::REORG);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668169895",
      "id" : 668169895,
      "in_reply_to_id" : 667711900,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODE2OTg5NQ==",
      "original_commit_id" : "ad911753a1af3a10f9e74a78a066ed4f1e40ce4d",
      "original_line" : 2294,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 704431781,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-12T18:43:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668169895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668698941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668698941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This new name seems worse to me than the original (`UpdateMempoolForReorg()`). The `Try` suggests that this operation may fail or that it's best-effort. In fact, if a mempool exists then it really will be updated to be internally consistent.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T12:06:10Z",
      "diff_hunk" : "@@ -798,6 +800,33 @@ class CChainState\n \n     bool LoadBlockIndexDB() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Indirection necessary to make lock annotations work with an optional mempool.\n+    RecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs)\n+    {\n+        return m_mempool ? &m_mempool->cs : nullptr;\n+    }\n+\n+    /**\n+     * Make mempool consistent after a reorg, by re-adding or recursively erasing\n+     * disconnected block transactions from the mempool, and also removing any\n+     * other transactions from the mempool that are no longer valid given the new\n+     * tip/height.\n+     *\n+     * Note: we assume that disconnectpool only contains transactions that are NOT\n+     * confirmed in the current chain nor already in the mempool (otherwise,\n+     * in-mempool descendants of such transactions would be removed).\n+     *\n+     * Passing fAddToMempool=false will skip trying to add the transactions back,\n+     * and instead just erase from the mempool as needed.\n+     */\n+    void TryUpdateMempoolForReorg(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668698941",
      "id" : 668698941,
      "line" : 822,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODY5ODk0MQ==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 822,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 79,
      "pull_request_review_id" : 705099557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T12:55:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668698941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668701404"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668701404"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There's no need to use `this->` to call member functions. `this->` is implicitly added before the names: https://en.cppreference.com/w/cpp/language/this.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T12:09:46Z",
      "diff_hunk" : "@@ -2218,11 +2213,11 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    if (!active_chainstate.IsInitialBlockDownload()) {\n+    if (!this->IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668701404",
      "id" : 668701404,
      "line" : 2216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODcwMTQwNA==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 2216,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 130,
      "pull_request_review_id" : 705099557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T12:55:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668701404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668701559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668701559"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As above, no need for `this->` here.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T12:09:58Z",
      "diff_hunk" : "@@ -2237,14 +2232,14 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n       pindexNew->GetBlockHash().ToString(), pindexNew->nHeight, pindexNew->nVersion,\n       log(pindexNew->nChainWork.getdouble())/log(2.0), (unsigned long)pindexNew->nChainTx,\n       FormatISO8601DateTime(pindexNew->GetBlockTime()),\n-      GuessVerificationProgress(chainParams.TxData(), pindexNew), active_chainstate.CoinsTip().DynamicMemoryUsage() * (1.0 / (1<<20)), active_chainstate.CoinsTip().GetCacheSize(),\n+      GuessVerificationProgress(m_params.TxData(), pindexNew), this->CoinsTip().DynamicMemoryUsage() * (1.0 / (1<<20)), this->CoinsTip().GetCacheSize(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668701559",
      "id" : 668701559,
      "line" : 2235,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODcwMTU1OQ==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 2235,
      "original_position" : 144,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 144,
      "pull_request_review_id" : 705099557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T12:55:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668701559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668719890"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668719890"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These new `const` keywords on the `CChainstate::CChainstate` and `InitializeChainstate` arguments are harmless but unnecessary. When you're passing by value (which is what happens when you pass a pointer), making that argument const doesn't change the interface, since the argument is copied to a locally scoped parameter inside the function. It's only when passing by reference that marking arguments const matters.\r\n\r\nYou can tell that it doesn't make a difference because the function declaration here has the first arg as `CTxMemPool* const`, and the function definition in the .cpp file has `CTxMemPool*` (non const pointer). The compiler doesn't complain because the const-ness of a pass by value arg isn't part of the signature.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T12:35:32Z",
      "diff_hunk" : "@@ -600,7 +601,10 @@ class CChainState\n     //! CChainState instances.\n     BlockManager& m_blockman;\n \n-    explicit CChainState(CTxMemPool& mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n+    explicit CChainState(\n+        CTxMemPool* const mempool,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668719890",
      "id" : 668719890,
      "line" : 605,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODcxOTg5MA==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 605,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 18,
      "pull_request_review_id" : 705099557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T12:55:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668719890",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668723653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668723653"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for `this->`",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T12:40:49Z",
      "diff_hunk" : "@@ -372,12 +365,16 @@ static void UpdateMempoolForReorg(CChainState& active_chainstate, CTxMemPool& me\n     // previously-confirmed transactions back to the mempool.\n     // UpdateTransactionsFromBlock finds descendants of any transactions in\n     // the disconnectpool that were added back and cleans up the mempool state.\n-    mempool.UpdateTransactionsFromBlock(vHashUpdate);\n+    m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n     // We also need to remove any now-immature transactions\n-    mempool.removeForReorg(active_chainstate, STANDARD_LOCKTIME_VERIFY_FLAGS);\n+    m_mempool->removeForReorg(*this, STANDARD_LOCKTIME_VERIFY_FLAGS);\n     // Re-limit mempool size, in case we added any transactions\n-    LimitMempoolSize(mempool, active_chainstate.CoinsTip(), gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000, std::chrono::hours{gArgs.GetArg(\"-mempoolexpiry\", DEFAULT_MEMPOOL_EXPIRY)});\n+    LimitMempoolSize(\n+        *m_mempool,\n+        this->CoinsTip(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668723653",
      "id" : 668723653,
      "line" : 375,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODcyMzY1Mw==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 375,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 61,
      "pull_request_review_id" : 705099557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T12:55:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668723653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668725963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668725963"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any idea why there's a different `tx_pool` from `mempool` in this test? It's not used anywhere so presumably can be removed?",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T12:43:44Z",
      "diff_hunk" : "@@ -20,7 +20,7 @@ BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n {\n     CTxMemPool mempool;\n     BlockManager blockman{};\n-    CChainState chainstate{mempool, blockman};\n+    CChainState chainstate{&mempool, blockman};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668725963",
      "id" : 668725963,
      "line" : 23,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODcyNTk2Mw==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 23,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 5,
      "pull_request_review_id" : 705099557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T12:55:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668725963",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668761642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668761642"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I prefer the `this->` prefix to be explicit about a member function call; last time I talked about this with others it was uncontroversial.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T13:26:16Z",
      "diff_hunk" : "@@ -2218,11 +2213,11 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    if (!active_chainstate.IsInitialBlockDownload()) {\n+    if (!this->IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668761642",
      "id" : 668761642,
      "in_reply_to_id" : 668701404,
      "line" : 2216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODc2MTY0Mg==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 2216,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 130,
      "pull_request_review_id" : 705184542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T13:26:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668761642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Anyone have any idea what the deal is with libsecp tests failing on ARM here? \r\n![image](https://user-images.githubusercontent.com/73197/125460328-0c24f2b4-fa8b-4544-ad19-a0c1c1b082ee.png)\r\n\r\nThis doesn't look like a spurious failure.",
      "created_at" : "2021-07-13T13:29:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-879089245",
      "id" : 879089245,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3OTA4OTI0NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-13T13:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/879089245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668765914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668765914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right but at least this makes it clear that we aren't going to do any pointer arithmetic on `mempool` in the body of the function, right?",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T13:30:59Z",
      "diff_hunk" : "@@ -600,7 +601,10 @@ class CChainState\n     //! CChainState instances.\n     BlockManager& m_blockman;\n \n-    explicit CChainState(CTxMemPool& mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n+    explicit CChainState(\n+        CTxMemPool* const mempool,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668765914",
      "id" : 668765914,
      "in_reply_to_id" : 668719890,
      "line" : 605,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODc2NTkxNA==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 605,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 18,
      "pull_request_review_id" : 705190391,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T13:30:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668765914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668775580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668775580"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you felt this way it would have been helpful for you to chime in on @naumenkogs's original comment; doing commits back and forth on relatively cosmetic things like method names is not a good use of energy.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T13:42:07Z",
      "diff_hunk" : "@@ -798,6 +800,33 @@ class CChainState\n \n     bool LoadBlockIndexDB() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Indirection necessary to make lock annotations work with an optional mempool.\n+    RecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs)\n+    {\n+        return m_mempool ? &m_mempool->cs : nullptr;\n+    }\n+\n+    /**\n+     * Make mempool consistent after a reorg, by re-adding or recursively erasing\n+     * disconnected block transactions from the mempool, and also removing any\n+     * other transactions from the mempool that are no longer valid given the new\n+     * tip/height.\n+     *\n+     * Note: we assume that disconnectpool only contains transactions that are NOT\n+     * confirmed in the current chain nor already in the mempool (otherwise,\n+     * in-mempool descendants of such transactions would be removed).\n+     *\n+     * Passing fAddToMempool=false will skip trying to add the transactions back,\n+     * and instead just erase from the mempool as needed.\n+     */\n+    void TryUpdateMempoolForReorg(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668775580",
      "id" : 668775580,
      "in_reply_to_id" : 668698941,
      "line" : 822,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODc3NTU4MA==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 822,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 79,
      "pull_request_review_id" : 705204038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T13:42:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668775580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668787380"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668787380"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, looks like it. I think when I wrote these I wanted to cover the fact that you could pass in a mempool reference that wasn't owned by the chainstate, but I don't think there's any point in doing that now.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T13:55:03Z",
      "diff_hunk" : "@@ -20,7 +20,7 @@ BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n {\n     CTxMemPool mempool;\n     BlockManager blockman{};\n-    CChainState chainstate{mempool, blockman};\n+    CChainState chainstate{&mempool, blockman};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668787380",
      "id" : 668787380,
      "in_reply_to_id" : 668725963,
      "line" : 23,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODc4NzM4MA==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 23,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 5,
      "pull_request_review_id" : 705220221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T13:55:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668787380",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668789480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668789480"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Curious. I've never come across this style before.",
      "commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "created_at" : "2021-07-13T13:57:19Z",
      "diff_hunk" : "@@ -2218,11 +2213,11 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    if (!active_chainstate.IsInitialBlockDownload()) {\n+    if (!this->IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668789480",
      "id" : 668789480,
      "in_reply_to_id" : 668701404,
      "line" : 2216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODc4OTQ4MA==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 2216,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 130,
      "pull_request_review_id" : 705223101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T13:57:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668789480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668792472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668792472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> this makes it clear that we aren't going to do any pointer arithmetic on mempool\r\n\r\n`mempool` inside the function is a copy of the pointer, and so whether or not it's mutated is not part of the contract with the caller, and so doesn't need to be in the function declaration. Like I said it's harmless, but you'll see that there are almost no examples in the code of pass by value parameters being marked const.",
      "commit_id" : "ceb7b35a39145717e2d9d356fd382bd1f95d2a5a",
      "created_at" : "2021-07-13T14:00:33Z",
      "diff_hunk" : "@@ -600,7 +601,10 @@ class CChainState\n     //! CChainState instances.\n     BlockManager& m_blockman;\n \n-    explicit CChainState(CTxMemPool& mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n+    explicit CChainState(\n+        CTxMemPool* const mempool,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668792472",
      "id" : 668792472,
      "in_reply_to_id" : 668719890,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODc5MjQ3Mg==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 605,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 705227300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T14:00:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668792472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668812004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668812004"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry - I didn't see the original comment. Ultimately it's up to you what you put in your PR. I don't think that renaming this function is necessary, and is actually worse for the reasons I gave here, but if other people prefer the new name, that's also fine!",
      "commit_id" : "ceb7b35a39145717e2d9d356fd382bd1f95d2a5a",
      "created_at" : "2021-07-13T14:20:59Z",
      "diff_hunk" : "@@ -798,6 +800,33 @@ class CChainState\n \n     bool LoadBlockIndexDB() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Indirection necessary to make lock annotations work with an optional mempool.\n+    RecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs)\n+    {\n+        return m_mempool ? &m_mempool->cs : nullptr;\n+    }\n+\n+    /**\n+     * Make mempool consistent after a reorg, by re-adding or recursively erasing\n+     * disconnected block transactions from the mempool, and also removing any\n+     * other transactions from the mempool that are no longer valid given the new\n+     * tip/height.\n+     *\n+     * Note: we assume that disconnectpool only contains transactions that are NOT\n+     * confirmed in the current chain nor already in the mempool (otherwise,\n+     * in-mempool descendants of such transactions would be removed).\n+     *\n+     * Passing fAddToMempool=false will skip trying to add the transactions back,\n+     * and instead just erase from the mempool as needed.\n+     */\n+    void TryUpdateMempoolForReorg(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r668812004",
      "id" : 668812004,
      "in_reply_to_id" : 668698941,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODgxMjAwNA==",
      "original_commit_id" : "c13e832af4a044a5c4beb4694022df53fa2eaf6d",
      "original_line" : 822,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 705254441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-13T14:20:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/668812004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke would probably be most knowledgeable about the qemu-arm coredump https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-879089245 https://cirrus-ci.com/task/6754077301276672?logs=ci#L3494, I was curious about that too. It seems like it is happening in a libsecp256k1 test so not related? But maybe there are ways to debug.\r\n\r\n(I don't want to bikeshed the style issues, since they don't actually matter at all. But just for fun I'll say I do agree with John in not liking mostly spurious `const`. Also would drop `Try` prefix or replace it with `Maybe` since `Try` suggests some kind of failure would be expected. I do think having `this->` prefixes is more readable in current code to distinguish method calls from function calls, but in non-legacy code it'd be cleaner to use `lowerCaseMethod()` and `UpperCaseFunction()` names to avoid the ambiguity.)",
      "created_at" : "2021-07-13T14:22:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-879133508",
      "id" : 879133508,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3OTEzMzUwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-13T14:23:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/879133508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The `(~x[m][shift]) << (64 - (1 << usebits))) == 0` failure is expected: https://github.com/bitcoin-core/secp256k1/issues/610#issuecomment-482803876",
      "created_at" : "2021-07-13T14:40:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-879147719",
      "id" : 879147719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3OTE0NzcxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-13T14:40:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/879147719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Could edit OP to remove the section that no longer applies to make sure it doesn't end up in the final merge commit?",
      "created_at" : "2021-07-13T14:41:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-879148608",
      "id" : 879148608,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3OTE0ODYwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-13T14:41:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/879148608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pushed a rebase:\r\n- `TryUpdateMempool...` -> `MaybeUpdateMempool...`\r\n- Removed unnecessary `const`s\r\n- Removed outdated content from OP",
      "created_at" : "2021-07-13T15:14:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-879176417",
      "id" : 879176417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3OTE3NjQxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-13T15:14:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/879176417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "- unnecessary `tx_pool` removed",
      "created_at" : "2021-07-13T15:28:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-879187156",
      "id" : 879187156,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3OTE4NzE1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-13T15:28:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/879187156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK ceb7b35a39145717e2d9d356fd382bd1f95d2a5a",
      "created_at" : "2021-07-13T15:32:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-879190309",
      "id" : 879190309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3OTE5MDMwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-13T15:32:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/879190309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK ceb7b35a39145717e2d9d356fd382bd1f95d2a5a",
      "created_at" : "2021-07-15T08:51:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-880518895",
      "id" : 880518895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDUxODg5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T08:51:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880518895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
