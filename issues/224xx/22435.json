{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "The [BIP340 SchrorrSig standard](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) states that during the signature there is a verification step, aborting the signature if verification fails. It is not mandatory, \"_it is recommended, but can be omitted if the computation cost is prohibitive_\".\r\n\r\nThe underlying secp256k1 library is written in C and ASM is very very efficient on multiple platforms. I can't see so much case where this cost is prohibitive. The only cases I can see is on small connected devices, embedded systems, or security chips, which are running below 50 Mhz, without full crypto-accelerator. Also this library is the central security implementation in Bitcoin and many other blockchains, and it should should enforce best security practices. Plus the embedded small platforms would be the most vulnerable about the provoked computation errors to leak the private keys. But it is not an issue if the small devices has only a small amount in its private key.\r\n\r\nThe [reference implementation in Python](https://github.com/bitcoin/bips/blob/master/bip-0340/reference.py#L120) is performing this verification step, in accordance with the standard.\r\n\r\nThe [libsecp256k1 library code documentation used here](https://github.com/bitcoin/bitcoin/blob/7fcf53f7b4524572d1d0c9a5fdc388e87eb02416/src/secp256k1/include/secp256k1_schnorrsig.h#L63) explains that the _secp256k1_schnorrsig_sign_ method \"_does not strictly follow BIP-340 because it does not verify the resulting signature. Instead, you can manually use secp256k1_schnorrsig_verify and abort if it fails._\" So this is up to the secp256k1 library users, here the Bitcoin developers, to add the verification of the signature.\r\n\r\nI propose the following change :\r\n\r\nAdding the verification step [in src/key.cpp CKey::SignSchnorr method](https://github.com/bitcoin/bitcoin/blob/master/src/key.cpp#L277).\r\nAnd make this optional with compilation flags, by default activated, and users of this consensus software can choose to disengage this security intentionally if they feel that can hurt the computation time over security when signing. For example a leaf key making hundred thousands small transactions a day, with small amount in the address balance, in a small slow embedding device.\r\n\r\nAt the very least, one should add a comment note in the SignSchnorr code (or header), explaining and justifying how the computation cost is prohibitive, so the verification step is omitted. For now the comment says SignSchnorr \"_create a BIP-340 Schnorr signature_\" and that builds an incorrect feeling of security like as it would follow the given standard.\r\n\r\nAn other way, can be to amend the standard, to relax the recommendation, and it could state the verification step is only a possibility to zealous user for stronger security.\r\n\r\nFrom the security point of view, the verification step has to be added. We just need to discuss users experiences and usage of this software, if the removal of this security protection is a benefit for most users. And especially, from the standard statement, justify that the computation cost is prohibitive, so this security step can be omitted like it is now. The standard makes the choice to strengthen the security against some kind of attacks, and states this can be disabled if this security measure uses prohibitive resources in practice. The standard doesn't say this is an extra feature up to the implementation choice. Actually, this is _recommended_, but there are specific conditions covering the reasons when it can be omitted.\r\n\r\nThe optimizations to reduce the computation resources is focused on signatures checks, and should not be a matter over security for the signing process.\r\n",
   "closed_at" : "2022-06-08T18:30:53Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   },
   "comments" : 8,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22435/comments",
   "created_at" : "2021-07-12T20:24:16Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22435/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/22435",
   "id" : 942417771,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22435/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU5NDI0MTc3NzE=",
   "number" : 22435,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 2,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 2,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22435/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : "completed",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22435/timeline",
   "title" : "Schnorr sig implementation diverges from the BIP340 standard",
   "updated_at" : "2022-06-08T18:30:54Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22435",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/7551901?v=4",
      "events_url" : "https://api.github.com/users/antonio-fr/events{/privacy}",
      "followers_url" : "https://api.github.com/users/antonio-fr/followers",
      "following_url" : "https://api.github.com/users/antonio-fr/following{/other_user}",
      "gists_url" : "https://api.github.com/users/antonio-fr/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/antonio-fr",
      "id" : 7551901,
      "login" : "antonio-fr",
      "node_id" : "MDQ6VXNlcjc1NTE5MDE=",
      "organizations_url" : "https://api.github.com/users/antonio-fr/orgs",
      "received_events_url" : "https://api.github.com/users/antonio-fr/received_events",
      "repos_url" : "https://api.github.com/users/antonio-fr/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/antonio-fr/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/antonio-fr/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/antonio-fr"
   }
}
