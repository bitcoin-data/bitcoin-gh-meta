{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "Upon reviewing the documentation for `CTxMemPool::CalculateMemPoolAncestors`, I noticed `setAncestors` was meant to be an `out` parameter but actually is an `in,out` parameter, as can be observed by adding `assert(setAncestors.empty());` as the first line in the function and running `make check`. This PR fixes this unexpected behaviour and introduces refactoring improvements to make intents and effects of the code more clear.\r\n\r\n## Unexpected behaviour\r\nThis behaviour occurs only in the package acceptance path, currently only triggered by `testmempoolaccept` and `submitpackage` RPCs. \r\n\r\nIn `MemPoolAccept::AcceptMultipleTransactions()`, we first call `PreChecks()` and then `SubmitPackage()` with the same `Workspace ws` reference. `PreChecks` leaves `ws.m_ancestors` in a potentially non-empty state, before it is passed on to `MemPoolAccept::SubmitPackage`. `SubmitPackage` is the only place where `setAncestors` isn't guaranteed to be empty before calling `CalculateMemPoolAncestors`. The most straightforward fix is to just forcefully clear `setAncestors` at the beginning of CalculateMemPoolAncestors, which is done in the first bugfix commit.\r\n\r\n## Improvements\r\n### Return value instead of out-parameters\r\nThis PR updates the function signatures for `CTxMemPool::CalculateMemPoolAncestors` and `CTxMemPool::CalculateAncestorsAndCheckLimits` to use a `util::Result` return type and eliminate both the `setAncestors` `in,out`-parameter as well as the error string. It simplifies the code and makes the intent and effects more explicit.\r\n\r\n### Observability\r\nThere are 7 instances where we currently call `CalculateMemPoolAncestors` without actually checking if the function succeeded because we assume that it can't fail, such as in [miner.cpp](https://github.com/bitcoin/bitcoin/blob/69b10212ea5370606c7a5aa500a70c36b4cbb58f/src/node/miner.cpp#L399). This PR adds a new wrapper `AssumeCalculateMemPoolAncestors` function that logs such unexpected failures, or in case of debug builds even halts the program. It's not crucial to the objective, more of an observability improvement that seems sensible to add on here.",
   "closed_at" : "2023-01-03T21:31:16Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
      "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
      "followers_url" : "https://api.github.com/users/achow101/followers",
      "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/achow101",
      "id" : 3782274,
      "login" : "achow101",
      "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
      "organizations_url" : "https://api.github.com/users/achow101/orgs",
      "received_events_url" : "https://api.github.com/users/achow101/received_events",
      "repos_url" : "https://api.github.com/users/achow101/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/achow101"
   },
   "comments" : 20,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26289/comments",
   "created_at" : "2022-10-10T20:55:08Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26289/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/26289",
   "id" : 1403702935,
   "labels" : [
      {
         "color" : "fef2c0",
         "default" : false,
         "description" : null,
         "id" : 164208572,
         "name" : "Mempool",
         "node_id" : "MDU6TGFiZWwxNjQyMDg1NzI=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Mempool"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26289/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII585Aham6",
   "number" : 26289,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/26289.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26289",
      "merged_at" : "2023-01-03T21:31:16Z",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/26289.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26289"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26289/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26289/timeline",
   "title" : "Use util::Result in for calculating mempool ancestors",
   "updated_at" : "2023-01-03T21:31:17Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26289",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
      "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
      "followers_url" : "https://api.github.com/users/stickies-v/followers",
      "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
      "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/stickies-v",
      "id" : 69010457,
      "login" : "stickies-v",
      "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
      "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
      "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
      "repos_url" : "https://api.github.com/users/stickies-v/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/stickies-v"
   }
}
