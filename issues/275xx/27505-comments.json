[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27530](https://github.com/bitcoin/bitcoin/pull/27530) (Remove now-unnecessary poll, fcntl includes from net(base).cpp by Empact)\n* [#27405](https://github.com/bitcoin/bitcoin/pull/27405) (util: Use steady clock instead of system clock to measure durations by MarcoFalke)\n* [#27375](https://github.com/bitcoin/bitcoin/pull/27375) (net: support unix domain sockets for -proxy and -onion by pinheadmz)\n* [#27071](https://github.com/bitcoin/bitcoin/pull/27071) (Handle CJDNS from LookupSubNet() by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-04-20T21:07:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1516950023",
      "id" : 1516950023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585aatIH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1516950023/reactions"
      },
      "updated_at" : "2023-04-26T20:44:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1516950023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Afaik we currently do not expose libevent on any public facing interface (e.g. p2p) and only use it for things that aren't supposed to be exposed (e.g. rpc or rest). By using it for DNS queries we would be changing that (e.g. a malicious DNS seeder) and I'm not sure if that is the best idea given that libevent is pretty archaic (I think the MSan, ASan, TSan and LSan failures in the CI are kind of proving my point).",
      "created_at" : "2023-04-21T09:06:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1517517368",
      "id" : 1517517368,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585ac3o4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517517368/reactions"
      },
      "updated_at" : "2023-04-21T09:06:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517517368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dergoegge I think at least some of the CI failures are memory leaks from my code, I'm going to fix that. But I hear your point about the arcane library. Any suggestions?\r\n",
      "created_at" : "2023-04-21T11:27:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1517682872",
      "id" : 1517682872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585adgC4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517682872/reactions"
      },
      "updated_at" : "2023-04-21T11:37:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517682872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Any suggestions?\r\n\r\nThe issue seems somewhat stale so maybe no need to fix? Judging by your last comment, you were also not able to reproduce? (https://github.com/bitcoin/bitcoin/issues/16778#issuecomment-1458423187)\r\n\r\n",
      "created_at" : "2023-04-21T12:49:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1517787932",
      "id" : 1517787932,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585ad5sc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517787932/reactions"
      },
      "updated_at" : "2023-04-21T12:49:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517787932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I was able to somewhat reproduce -- by sending all DNS requests on my machine to a blackhole resolver, I observed a 30 second pause during shutdown. But I think that 30 seconds may be platform-specific, or whatever the local `getaddrinfo()` implementation is.",
      "created_at" : "2023-04-21T12:53:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1517793681",
      "id" : 1517793681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585ad7GR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517793681/reactions"
      },
      "updated_at" : "2023-04-21T12:53:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1517793681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173774847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173774847"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wouldn't this also wait indefinitely for `getaddrinfo` to finish before the thread can join?",
      "commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "created_at" : "2023-04-21T13:34:10Z",
      "diff_hunk" : "@@ -40,49 +42,71 @@ bool fNameLookup = DEFAULT_NAME_LOOKUP;\n int g_socks5_recv_timeout = 20 * 1000;\n static std::atomic<bool> interruptSocks5Recv(false);\n \n-std::vector<CNetAddr> WrappedGetAddrInfo(const std::string& name, bool allow_lookup)\n+void GAICallback(int errcode, struct evutil_addrinfo *addr, void *user_data)\n {\n-    addrinfo ai_hint{};\n+    struct DNSResolveResponse* res = (struct DNSResolveResponse*)user_data;\n+\n+    while (addr != nullptr) {\n+        if (addr->ai_family == AF_INET) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in));\n+            res->vAddr->emplace_back(reinterpret_cast<sockaddr_in*>(addr->ai_addr)->sin_addr);\n+        }\n+        if (addr->ai_family == AF_INET6) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in6));\n+            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(addr->ai_addr)};\n+            res->vAddr->emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n+        }\n+        addr = addr->ai_next;\n+    }\n+    res->complete = true;\n+}\n+\n+std::vector<CNetAddr> DNSResolveAsync(const std::string& name, bool allow_lookup)\n+{\n+    raii_event_base base = obtain_event_base();\n+    raii_evdns_base dnsbase = obtain_evdns_base(base.get());\n+\n+    struct evutil_addrinfo hints{};\n     // We want a TCP port, which is a streaming socket type\n-    ai_hint.ai_socktype = SOCK_STREAM;\n-    ai_hint.ai_protocol = IPPROTO_TCP;\n+    hints.ai_socktype = SOCK_STREAM;\n+    hints.ai_protocol = IPPROTO_TCP;\n     // We don't care which address family (IPv4 or IPv6) is returned\n-    ai_hint.ai_family = AF_UNSPEC;\n-    // If we allow lookups of hostnames, use the AI_ADDRCONFIG flag to only\n+    hints.ai_family = AF_UNSPEC;\n+    // If we allow lookups of hostnames, use the EVUTIL_AI_ADDRCONFIG flag to only\n     // return addresses whose family we have an address configured for.\n     //\n-    // If we don't allow lookups, then use the AI_NUMERICHOST flag for\n+    // If we don't allow lookups, then use the EVUTIL_AI_NUMERICHOST flag for\n     // getaddrinfo to only decode numerical network addresses and suppress\n     // hostname lookups.\n-    ai_hint.ai_flags = allow_lookup ? AI_ADDRCONFIG : AI_NUMERICHOST;\n+    hints.ai_flags = allow_lookup ? EVUTIL_AI_ADDRCONFIG : EVUTIL_AI_NUMERICHOST;\n \n-    addrinfo* ai_res{nullptr};\n-    const int n_err{getaddrinfo(name.c_str(), nullptr, &ai_hint, &ai_res)};\n-    if (n_err != 0) {\n-        return {};\n+    std::vector<CNetAddr> resolved_addresses;\n+    struct DNSResolveResponse res = {.complete = false, .vAddr = &resolved_addresses};\n+\n+    auto req = evdns_getaddrinfo(dnsbase.get(), name.c_str(), nullptr, &hints, GAICallback, &res);\n+\n+    if (!req) {\n+        // evdns_getaddrinfo() returned immediately.\n+        // There might have been an error, or no name lookup was necessary\n+        return resolved_addresses;\n     }\n \n-    // Traverse the linked list starting with ai_trav.\n-    addrinfo* ai_trav{ai_res};\n-    std::vector<CNetAddr> resolved_addresses;\n-    while (ai_trav != nullptr) {\n-        if (ai_trav->ai_family == AF_INET) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in));\n-            resolved_addresses.emplace_back(reinterpret_cast<sockaddr_in*>(ai_trav->ai_addr)->sin_addr);\n-        }\n-        if (ai_trav->ai_family == AF_INET6) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in6));\n-            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(ai_trav->ai_addr)};\n-            resolved_addresses.emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n-        }\n-        ai_trav = ai_trav->ai_next;\n+    // We need to wait for the name resolution callback on a new temporary event loop\n+    std::thread thread(event_base_loop, base.get(), 1);\n+\n+    int checks = 0;\n+    while (!res.complete)\n+    {\n+        // Check every 100ms for 2 seconds\n+        if (++checks > 20) break;\n+        std::this_thread::sleep_for(std::chrono::milliseconds(100));\n     }\n-    freeaddrinfo(ai_res);\n \n+    thread.join();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173774847",
      "id" : 1173774847,
      "line" : 105,
      "node_id" : "PRRC_kwDOABII585F9mH_",
      "original_commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "original_line" : 105,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/netbase.cpp",
      "position" : 100,
      "pull_request_review_id" : 1395781965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173774847/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-21T13:34:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173774847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173797262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173797262"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2 sec timeout waiting for the callback and then the loop will close. With my black hole dns resolver, the patch saves 30 seconds against master on the unit test in the second commit. \r\n\r\nIt took me some work to figure out that using ..._once() to start the event loop would allow me to quit the loop manually which allows join() to succeed ",
      "commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "created_at" : "2023-04-21T13:53:07Z",
      "diff_hunk" : "@@ -40,49 +42,71 @@ bool fNameLookup = DEFAULT_NAME_LOOKUP;\n int g_socks5_recv_timeout = 20 * 1000;\n static std::atomic<bool> interruptSocks5Recv(false);\n \n-std::vector<CNetAddr> WrappedGetAddrInfo(const std::string& name, bool allow_lookup)\n+void GAICallback(int errcode, struct evutil_addrinfo *addr, void *user_data)\n {\n-    addrinfo ai_hint{};\n+    struct DNSResolveResponse* res = (struct DNSResolveResponse*)user_data;\n+\n+    while (addr != nullptr) {\n+        if (addr->ai_family == AF_INET) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in));\n+            res->vAddr->emplace_back(reinterpret_cast<sockaddr_in*>(addr->ai_addr)->sin_addr);\n+        }\n+        if (addr->ai_family == AF_INET6) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in6));\n+            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(addr->ai_addr)};\n+            res->vAddr->emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n+        }\n+        addr = addr->ai_next;\n+    }\n+    res->complete = true;\n+}\n+\n+std::vector<CNetAddr> DNSResolveAsync(const std::string& name, bool allow_lookup)\n+{\n+    raii_event_base base = obtain_event_base();\n+    raii_evdns_base dnsbase = obtain_evdns_base(base.get());\n+\n+    struct evutil_addrinfo hints{};\n     // We want a TCP port, which is a streaming socket type\n-    ai_hint.ai_socktype = SOCK_STREAM;\n-    ai_hint.ai_protocol = IPPROTO_TCP;\n+    hints.ai_socktype = SOCK_STREAM;\n+    hints.ai_protocol = IPPROTO_TCP;\n     // We don't care which address family (IPv4 or IPv6) is returned\n-    ai_hint.ai_family = AF_UNSPEC;\n-    // If we allow lookups of hostnames, use the AI_ADDRCONFIG flag to only\n+    hints.ai_family = AF_UNSPEC;\n+    // If we allow lookups of hostnames, use the EVUTIL_AI_ADDRCONFIG flag to only\n     // return addresses whose family we have an address configured for.\n     //\n-    // If we don't allow lookups, then use the AI_NUMERICHOST flag for\n+    // If we don't allow lookups, then use the EVUTIL_AI_NUMERICHOST flag for\n     // getaddrinfo to only decode numerical network addresses and suppress\n     // hostname lookups.\n-    ai_hint.ai_flags = allow_lookup ? AI_ADDRCONFIG : AI_NUMERICHOST;\n+    hints.ai_flags = allow_lookup ? EVUTIL_AI_ADDRCONFIG : EVUTIL_AI_NUMERICHOST;\n \n-    addrinfo* ai_res{nullptr};\n-    const int n_err{getaddrinfo(name.c_str(), nullptr, &ai_hint, &ai_res)};\n-    if (n_err != 0) {\n-        return {};\n+    std::vector<CNetAddr> resolved_addresses;\n+    struct DNSResolveResponse res = {.complete = false, .vAddr = &resolved_addresses};\n+\n+    auto req = evdns_getaddrinfo(dnsbase.get(), name.c_str(), nullptr, &hints, GAICallback, &res);\n+\n+    if (!req) {\n+        // evdns_getaddrinfo() returned immediately.\n+        // There might have been an error, or no name lookup was necessary\n+        return resolved_addresses;\n     }\n \n-    // Traverse the linked list starting with ai_trav.\n-    addrinfo* ai_trav{ai_res};\n-    std::vector<CNetAddr> resolved_addresses;\n-    while (ai_trav != nullptr) {\n-        if (ai_trav->ai_family == AF_INET) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in));\n-            resolved_addresses.emplace_back(reinterpret_cast<sockaddr_in*>(ai_trav->ai_addr)->sin_addr);\n-        }\n-        if (ai_trav->ai_family == AF_INET6) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in6));\n-            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(ai_trav->ai_addr)};\n-            resolved_addresses.emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n-        }\n-        ai_trav = ai_trav->ai_next;\n+    // We need to wait for the name resolution callback on a new temporary event loop\n+    std::thread thread(event_base_loop, base.get(), 1);\n+\n+    int checks = 0;\n+    while (!res.complete)\n+    {\n+        // Check every 100ms for 2 seconds\n+        if (++checks > 20) break;\n+        std::this_thread::sleep_for(std::chrono::milliseconds(100));\n     }\n-    freeaddrinfo(ai_res);\n \n+    thread.join();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173797262",
      "id" : 1173797262,
      "in_reply_to_id" : 1173774847,
      "line" : 105,
      "node_id" : "PRRC_kwDOABII585F9rmO",
      "original_commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "original_line" : 105,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/netbase.cpp",
      "position" : 100,
      "pull_request_review_id" : 1395814798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173797262/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-21T13:53:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173797262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173800861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173800861"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(libevent does not call the platform getaddrinfo for dns requests, it has its own async methods)",
      "commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "created_at" : "2023-04-21T13:56:29Z",
      "diff_hunk" : "@@ -40,49 +42,71 @@ bool fNameLookup = DEFAULT_NAME_LOOKUP;\n int g_socks5_recv_timeout = 20 * 1000;\n static std::atomic<bool> interruptSocks5Recv(false);\n \n-std::vector<CNetAddr> WrappedGetAddrInfo(const std::string& name, bool allow_lookup)\n+void GAICallback(int errcode, struct evutil_addrinfo *addr, void *user_data)\n {\n-    addrinfo ai_hint{};\n+    struct DNSResolveResponse* res = (struct DNSResolveResponse*)user_data;\n+\n+    while (addr != nullptr) {\n+        if (addr->ai_family == AF_INET) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in));\n+            res->vAddr->emplace_back(reinterpret_cast<sockaddr_in*>(addr->ai_addr)->sin_addr);\n+        }\n+        if (addr->ai_family == AF_INET6) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in6));\n+            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(addr->ai_addr)};\n+            res->vAddr->emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n+        }\n+        addr = addr->ai_next;\n+    }\n+    res->complete = true;\n+}\n+\n+std::vector<CNetAddr> DNSResolveAsync(const std::string& name, bool allow_lookup)\n+{\n+    raii_event_base base = obtain_event_base();\n+    raii_evdns_base dnsbase = obtain_evdns_base(base.get());\n+\n+    struct evutil_addrinfo hints{};\n     // We want a TCP port, which is a streaming socket type\n-    ai_hint.ai_socktype = SOCK_STREAM;\n-    ai_hint.ai_protocol = IPPROTO_TCP;\n+    hints.ai_socktype = SOCK_STREAM;\n+    hints.ai_protocol = IPPROTO_TCP;\n     // We don't care which address family (IPv4 or IPv6) is returned\n-    ai_hint.ai_family = AF_UNSPEC;\n-    // If we allow lookups of hostnames, use the AI_ADDRCONFIG flag to only\n+    hints.ai_family = AF_UNSPEC;\n+    // If we allow lookups of hostnames, use the EVUTIL_AI_ADDRCONFIG flag to only\n     // return addresses whose family we have an address configured for.\n     //\n-    // If we don't allow lookups, then use the AI_NUMERICHOST flag for\n+    // If we don't allow lookups, then use the EVUTIL_AI_NUMERICHOST flag for\n     // getaddrinfo to only decode numerical network addresses and suppress\n     // hostname lookups.\n-    ai_hint.ai_flags = allow_lookup ? AI_ADDRCONFIG : AI_NUMERICHOST;\n+    hints.ai_flags = allow_lookup ? EVUTIL_AI_ADDRCONFIG : EVUTIL_AI_NUMERICHOST;\n \n-    addrinfo* ai_res{nullptr};\n-    const int n_err{getaddrinfo(name.c_str(), nullptr, &ai_hint, &ai_res)};\n-    if (n_err != 0) {\n-        return {};\n+    std::vector<CNetAddr> resolved_addresses;\n+    struct DNSResolveResponse res = {.complete = false, .vAddr = &resolved_addresses};\n+\n+    auto req = evdns_getaddrinfo(dnsbase.get(), name.c_str(), nullptr, &hints, GAICallback, &res);\n+\n+    if (!req) {\n+        // evdns_getaddrinfo() returned immediately.\n+        // There might have been an error, or no name lookup was necessary\n+        return resolved_addresses;\n     }\n \n-    // Traverse the linked list starting with ai_trav.\n-    addrinfo* ai_trav{ai_res};\n-    std::vector<CNetAddr> resolved_addresses;\n-    while (ai_trav != nullptr) {\n-        if (ai_trav->ai_family == AF_INET) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in));\n-            resolved_addresses.emplace_back(reinterpret_cast<sockaddr_in*>(ai_trav->ai_addr)->sin_addr);\n-        }\n-        if (ai_trav->ai_family == AF_INET6) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in6));\n-            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(ai_trav->ai_addr)};\n-            resolved_addresses.emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n-        }\n-        ai_trav = ai_trav->ai_next;\n+    // We need to wait for the name resolution callback on a new temporary event loop\n+    std::thread thread(event_base_loop, base.get(), 1);\n+\n+    int checks = 0;\n+    while (!res.complete)\n+    {\n+        // Check every 100ms for 2 seconds\n+        if (++checks > 20) break;\n+        std::this_thread::sleep_for(std::chrono::milliseconds(100));\n     }\n-    freeaddrinfo(ai_res);\n \n+    thread.join();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173800861",
      "id" : 1173800861,
      "in_reply_to_id" : 1173774847,
      "line" : 105,
      "node_id" : "PRRC_kwDOABII585F9sed",
      "original_commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "original_line" : 105,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/netbase.cpp",
      "position" : 100,
      "pull_request_review_id" : 1395820488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173800861/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-21T13:56:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173800861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173837388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173837388"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> libevent does not call the platform getaddrinfo for dns requests, it has its own async methods\r\n\r\nThat explains why it doesn't hang, thanks!\r\n\r\nBut it does seem like it uses `getaddrinfo` in some cases: https://github.com/libevent/libevent/blob/75208132d5b7a8fff59ca3bf47253179ec314951/evutil.c#L1686",
      "commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "created_at" : "2023-04-21T14:26:51Z",
      "diff_hunk" : "@@ -40,49 +42,71 @@ bool fNameLookup = DEFAULT_NAME_LOOKUP;\n int g_socks5_recv_timeout = 20 * 1000;\n static std::atomic<bool> interruptSocks5Recv(false);\n \n-std::vector<CNetAddr> WrappedGetAddrInfo(const std::string& name, bool allow_lookup)\n+void GAICallback(int errcode, struct evutil_addrinfo *addr, void *user_data)\n {\n-    addrinfo ai_hint{};\n+    struct DNSResolveResponse* res = (struct DNSResolveResponse*)user_data;\n+\n+    while (addr != nullptr) {\n+        if (addr->ai_family == AF_INET) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in));\n+            res->vAddr->emplace_back(reinterpret_cast<sockaddr_in*>(addr->ai_addr)->sin_addr);\n+        }\n+        if (addr->ai_family == AF_INET6) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in6));\n+            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(addr->ai_addr)};\n+            res->vAddr->emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n+        }\n+        addr = addr->ai_next;\n+    }\n+    res->complete = true;\n+}\n+\n+std::vector<CNetAddr> DNSResolveAsync(const std::string& name, bool allow_lookup)\n+{\n+    raii_event_base base = obtain_event_base();\n+    raii_evdns_base dnsbase = obtain_evdns_base(base.get());\n+\n+    struct evutil_addrinfo hints{};\n     // We want a TCP port, which is a streaming socket type\n-    ai_hint.ai_socktype = SOCK_STREAM;\n-    ai_hint.ai_protocol = IPPROTO_TCP;\n+    hints.ai_socktype = SOCK_STREAM;\n+    hints.ai_protocol = IPPROTO_TCP;\n     // We don't care which address family (IPv4 or IPv6) is returned\n-    ai_hint.ai_family = AF_UNSPEC;\n-    // If we allow lookups of hostnames, use the AI_ADDRCONFIG flag to only\n+    hints.ai_family = AF_UNSPEC;\n+    // If we allow lookups of hostnames, use the EVUTIL_AI_ADDRCONFIG flag to only\n     // return addresses whose family we have an address configured for.\n     //\n-    // If we don't allow lookups, then use the AI_NUMERICHOST flag for\n+    // If we don't allow lookups, then use the EVUTIL_AI_NUMERICHOST flag for\n     // getaddrinfo to only decode numerical network addresses and suppress\n     // hostname lookups.\n-    ai_hint.ai_flags = allow_lookup ? AI_ADDRCONFIG : AI_NUMERICHOST;\n+    hints.ai_flags = allow_lookup ? EVUTIL_AI_ADDRCONFIG : EVUTIL_AI_NUMERICHOST;\n \n-    addrinfo* ai_res{nullptr};\n-    const int n_err{getaddrinfo(name.c_str(), nullptr, &ai_hint, &ai_res)};\n-    if (n_err != 0) {\n-        return {};\n+    std::vector<CNetAddr> resolved_addresses;\n+    struct DNSResolveResponse res = {.complete = false, .vAddr = &resolved_addresses};\n+\n+    auto req = evdns_getaddrinfo(dnsbase.get(), name.c_str(), nullptr, &hints, GAICallback, &res);\n+\n+    if (!req) {\n+        // evdns_getaddrinfo() returned immediately.\n+        // There might have been an error, or no name lookup was necessary\n+        return resolved_addresses;\n     }\n \n-    // Traverse the linked list starting with ai_trav.\n-    addrinfo* ai_trav{ai_res};\n-    std::vector<CNetAddr> resolved_addresses;\n-    while (ai_trav != nullptr) {\n-        if (ai_trav->ai_family == AF_INET) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in));\n-            resolved_addresses.emplace_back(reinterpret_cast<sockaddr_in*>(ai_trav->ai_addr)->sin_addr);\n-        }\n-        if (ai_trav->ai_family == AF_INET6) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in6));\n-            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(ai_trav->ai_addr)};\n-            resolved_addresses.emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n-        }\n-        ai_trav = ai_trav->ai_next;\n+    // We need to wait for the name resolution callback on a new temporary event loop\n+    std::thread thread(event_base_loop, base.get(), 1);\n+\n+    int checks = 0;\n+    while (!res.complete)\n+    {\n+        // Check every 100ms for 2 seconds\n+        if (++checks > 20) break;\n+        std::this_thread::sleep_for(std::chrono::milliseconds(100));\n     }\n-    freeaddrinfo(ai_res);\n \n+    thread.join();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173837388",
      "id" : 1173837388,
      "in_reply_to_id" : 1173774847,
      "line" : 105,
      "node_id" : "PRRC_kwDOABII585F91ZM",
      "original_commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "original_line" : 105,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/netbase.cpp",
      "position" : 100,
      "pull_request_review_id" : 1395885670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173837388/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-21T14:26:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173837388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173902633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173902633"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah I think thats just to decode numeric addresses like \"100.200.30.40\" etc. It looked to me like if an actual DNS request is necessary it has its own methods to make reqests directly to the nameservers provided by the platform? When things get \"serious\":\r\n\r\nhttps://github.com/libevent/libevent/blob/master/evdns.c#L5623",
      "commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "created_at" : "2023-04-21T15:22:08Z",
      "diff_hunk" : "@@ -40,49 +42,71 @@ bool fNameLookup = DEFAULT_NAME_LOOKUP;\n int g_socks5_recv_timeout = 20 * 1000;\n static std::atomic<bool> interruptSocks5Recv(false);\n \n-std::vector<CNetAddr> WrappedGetAddrInfo(const std::string& name, bool allow_lookup)\n+void GAICallback(int errcode, struct evutil_addrinfo *addr, void *user_data)\n {\n-    addrinfo ai_hint{};\n+    struct DNSResolveResponse* res = (struct DNSResolveResponse*)user_data;\n+\n+    while (addr != nullptr) {\n+        if (addr->ai_family == AF_INET) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in));\n+            res->vAddr->emplace_back(reinterpret_cast<sockaddr_in*>(addr->ai_addr)->sin_addr);\n+        }\n+        if (addr->ai_family == AF_INET6) {\n+            assert(addr->ai_addrlen >= sizeof(sockaddr_in6));\n+            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(addr->ai_addr)};\n+            res->vAddr->emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n+        }\n+        addr = addr->ai_next;\n+    }\n+    res->complete = true;\n+}\n+\n+std::vector<CNetAddr> DNSResolveAsync(const std::string& name, bool allow_lookup)\n+{\n+    raii_event_base base = obtain_event_base();\n+    raii_evdns_base dnsbase = obtain_evdns_base(base.get());\n+\n+    struct evutil_addrinfo hints{};\n     // We want a TCP port, which is a streaming socket type\n-    ai_hint.ai_socktype = SOCK_STREAM;\n-    ai_hint.ai_protocol = IPPROTO_TCP;\n+    hints.ai_socktype = SOCK_STREAM;\n+    hints.ai_protocol = IPPROTO_TCP;\n     // We don't care which address family (IPv4 or IPv6) is returned\n-    ai_hint.ai_family = AF_UNSPEC;\n-    // If we allow lookups of hostnames, use the AI_ADDRCONFIG flag to only\n+    hints.ai_family = AF_UNSPEC;\n+    // If we allow lookups of hostnames, use the EVUTIL_AI_ADDRCONFIG flag to only\n     // return addresses whose family we have an address configured for.\n     //\n-    // If we don't allow lookups, then use the AI_NUMERICHOST flag for\n+    // If we don't allow lookups, then use the EVUTIL_AI_NUMERICHOST flag for\n     // getaddrinfo to only decode numerical network addresses and suppress\n     // hostname lookups.\n-    ai_hint.ai_flags = allow_lookup ? AI_ADDRCONFIG : AI_NUMERICHOST;\n+    hints.ai_flags = allow_lookup ? EVUTIL_AI_ADDRCONFIG : EVUTIL_AI_NUMERICHOST;\n \n-    addrinfo* ai_res{nullptr};\n-    const int n_err{getaddrinfo(name.c_str(), nullptr, &ai_hint, &ai_res)};\n-    if (n_err != 0) {\n-        return {};\n+    std::vector<CNetAddr> resolved_addresses;\n+    struct DNSResolveResponse res = {.complete = false, .vAddr = &resolved_addresses};\n+\n+    auto req = evdns_getaddrinfo(dnsbase.get(), name.c_str(), nullptr, &hints, GAICallback, &res);\n+\n+    if (!req) {\n+        // evdns_getaddrinfo() returned immediately.\n+        // There might have been an error, or no name lookup was necessary\n+        return resolved_addresses;\n     }\n \n-    // Traverse the linked list starting with ai_trav.\n-    addrinfo* ai_trav{ai_res};\n-    std::vector<CNetAddr> resolved_addresses;\n-    while (ai_trav != nullptr) {\n-        if (ai_trav->ai_family == AF_INET) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in));\n-            resolved_addresses.emplace_back(reinterpret_cast<sockaddr_in*>(ai_trav->ai_addr)->sin_addr);\n-        }\n-        if (ai_trav->ai_family == AF_INET6) {\n-            assert(ai_trav->ai_addrlen >= sizeof(sockaddr_in6));\n-            const sockaddr_in6* s6{reinterpret_cast<sockaddr_in6*>(ai_trav->ai_addr)};\n-            resolved_addresses.emplace_back(s6->sin6_addr, s6->sin6_scope_id);\n-        }\n-        ai_trav = ai_trav->ai_next;\n+    // We need to wait for the name resolution callback on a new temporary event loop\n+    std::thread thread(event_base_loop, base.get(), 1);\n+\n+    int checks = 0;\n+    while (!res.complete)\n+    {\n+        // Check every 100ms for 2 seconds\n+        if (++checks > 20) break;\n+        std::this_thread::sleep_for(std::chrono::milliseconds(100));\n     }\n-    freeaddrinfo(ai_res);\n \n+    thread.join();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#discussion_r1173902633",
      "id" : 1173902633,
      "in_reply_to_id" : 1173774847,
      "line" : 105,
      "node_id" : "PRRC_kwDOABII585F-FUp",
      "original_commit_id" : "fd6679b8f387e25cb197204fd6c8126834949e3f",
      "original_line" : 105,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/netbase.cpp",
      "position" : 100,
      "pull_request_review_id" : 1395974031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27505",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173902633/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-21T15:22:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1173902633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "In general, I'm ~0 on leaning into further libevent usage, especially for something like this. The upstream code is currently not necessarily very well maintained or tested. There is also at least one open issue which reports `evdns_getaddrinfo` just \"crashing occasionally\": https://github.com/libevent/libevent/issues/1130. Although it's not entirely clear if this is user error.",
      "created_at" : "2023-05-02T13:30:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1531483899",
      "id" : 1531483899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585bSJb7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531483899/reactions"
      },
      "updated_at" : "2023-05-02T13:30:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531483899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "As an alternative to this PR, could we give the DNS thread time to join cleanly (e.g. 5s) and if it doesn't we just detach it and let the OS handle the clean up? That risks memory leaks but that shouldn't really matter when the program is about to exit anyway.\r\n\r\nI would also be fine with not addressing this at all, because it seems like this only happens when a system generally fails to make DNS requests? In the absence of nice solutions, it seems like that isn't our problem and the user should fix their system instead.",
      "created_at" : "2023-05-02T14:17:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1531564374",
      "id" : 1531564374,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585bSdFW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531564374/reactions"
      },
      "updated_at" : "2023-05-02T14:17:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531564374",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@fanquake @dergoegge good feedback, thanks. I'll look into a different approach moving the lib call `getaddrinfo` to a detachable thread before abandoning, and then we may just have to close https://github.com/bitcoin/bitcoin/issues/16778 as \"won't fix\"\r\n\r\nThere is another thought I had about name resolution moving forward: If bitcoin can make more interesting DNS queries (either using a library or just implementing some bare necessities) we could ask the DNS seeders for I2P and onion addresses as TXT records\r\n\r\n",
      "created_at" : "2023-05-02T14:50:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1531618658",
      "id" : 1531618658,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585bSqVi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531618658/reactions"
      },
      "updated_at" : "2023-05-02T14:50:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531618658",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> either using a library \r\n\r\nIt's very unlikely we are going to add a new external dependency to make \"interesting\" DNS queries.",
      "created_at" : "2023-05-02T14:52:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1531621948",
      "id" : 1531621948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585bSrI8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531621948/reactions"
      },
      "updated_at" : "2023-05-02T14:52:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531621948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closing this now for alternative in https://github.com/bitcoin/bitcoin/pull/27557 which just calls `getaddrinfo()` from a detachable thread. No libevent at all and, yeeeeeesh it is way simpler.",
      "created_at" : "2023-05-02T18:29:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27505#issuecomment-1531951962",
      "id" : 1531951962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27505",
      "node_id" : "IC_kwDOABII585bT7ta",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531951962/reactions"
      },
      "updated_at" : "2023-05-02T18:29:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1531951962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   }
]
