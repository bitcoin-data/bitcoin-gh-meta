[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for this report @vostrnad.\r\n\r\nI have reproduced this issue sucessfully and am looking into the root cause.\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```log\r\n2023-05-03T12:40:07Z InvalidChainFound: invalid block=0000002217824449bf6b7d8f9bc3cdb3407927712114a462376a991fea9f74af  height=141000  log2_work=40.653563  date=2023-05-01T05:44:57Z\r\n2023-05-03T12:40:07Z InvalidChainFound:  current best=0000010052eca20e8afb2fd62cb0b07ef3cbbaffe43068c825f2e09f80b2ab35  height=140999  log2_work=40.653552  date=2023-05-01T05:37:27Z\r\n2023-05-03T12:40:08Z tor: Thread interrupt\r\n2023-05-03T12:40:08Z Shutdown: In progress...\r\n2023-05-03T12:40:08Z opencon thread exit\r\n2023-05-03T12:40:08Z torcontrol thread exit\r\n2023-05-03T12:40:08Z addcon thread exit\r\n2023-05-03T12:40:08Z net thread exit\r\n2023-05-03T12:40:08Z msghand thread exit\r\n2023-05-03T12:40:08Z DumpAnchors: Flush 2 outbound block-relay-only peer addresses to anchors.dat started\r\n2023-05-03T12:40:08Z DumpAnchors: Flush 2 outbound block-relay-only peer addresses to anchors.dat completed (0.01s)\r\n2023-05-03T12:40:08Z scheduler thread exit\r\n2023-05-03T12:40:08Z Writing 0 unbroadcast transactions to disk.\r\n2023-05-03T12:40:08Z Dumped mempool: 9.263e-06s to copy, 0.00437868s to dump\r\n2023-05-03T12:40:08Z Shutdown: done\r\n\r\n\r\n\r\n\r\n\r\n2023-05-03T12:40:23Z Bitcoin Core version v24.0.1 (release build)\r\n2023-05-03T12:40:23Z Signet derived magic (message start): 0a03cf40\r\n2023-05-03T12:40:23Z Using the 'x86_shani(1way,2way)' SHA256 implementation\r\n2023-05-03T12:40:23Z Using RdSeed as an additional entropy source\r\n2023-05-03T12:40:23Z Using RdRand as an additional entropy source\r\n2023-05-03T12:40:23Z Default data directory /home/will/.bitcoin\r\n2023-05-03T12:40:23Z Using data directory /home/will/.bitcoin/signet\r\n2023-05-03T12:40:23Z Config file: /home/will/.bitcoin/bitcoin.conf\r\n2023-05-03T12:40:23Z Config file arg: [signet] blocksdir=\"/media/will/crucial1/bitcoin\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] coinstatsindex=\"1\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] daemon=\"1\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] fallbackfee=\"0.00001000\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] listen=\"1\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] port=\"38333\"\r\n2023-05-03T12:40:23Z Config file arg: [signet] rpcpassword=****\r\n2023-05-03T12:40:23Z Config file arg: [signet] rpcuser=****\r\n2023-05-03T12:40:23Z Config file arg: [signet] server=\"1\"\r\n2023-05-03T12:40:23Z Command-line arg: signet=\"\"\r\n2023-05-03T12:40:23Z Using at most 125 automatic connections (1024 file descriptors available)\r\n2023-05-03T12:40:23Z Using 16 MiB out of 16 MiB requested for signature cache, able to store 524288 elements\r\n2023-05-03T12:40:23Z Using 16 MiB out of 16 MiB requested for script execution cache, able to store 524288 elements\r\n2023-05-03T12:40:23Z Script verification uses 15 additional threads\r\n2023-05-03T12:40:23Z scheduler thread start\r\n2023-05-03T12:40:23Z [http] creating work queue of depth 16\r\n2023-05-03T12:40:23Z Config options rpcuser and rpcpassword will soon be deprecated. Locally-run instances may remove rpcuser to use cookie-based auth, or may be replaced with rpcauth. Please see share/rpcauth for rpcauth auth generation.\r\n2023-05-03T12:40:23Z [http] starting 4 worker threads\r\n2023-05-03T12:40:23Z Using wallet directory /home/will/.bitcoin/signet/wallets\r\n2023-05-03T12:40:23Z init message: Verifying wallet(s)â¦\r\n2023-05-03T12:40:23Z Using /16 prefix for IP bucketing\r\n2023-05-03T12:40:23Z init message: Loading P2P addressesâ¦\r\n2023-05-03T12:40:23Z Loaded 2022 addresses from peers.dat  20ms\r\n2023-05-03T12:40:23Z init message: Loading banlistâ¦\r\n2023-05-03T12:40:23Z SetNetworkActive: true\r\n2023-05-03T12:40:23Z Cache configuration:\r\n2023-05-03T12:40:23Z * Using 2.0 MiB for block index database\r\n2023-05-03T12:40:23Z * Using 8.0 MiB for chain state database\r\n2023-05-03T12:40:23Z * Using 440.0 MiB for in-memory UTXO set (plus up to 286.1 MiB of unused mempool space)\r\n2023-05-03T12:40:23Z init message: Loading block indexâ¦\r\n2023-05-03T12:40:23Z Assuming ancestors of block 000000d1a0e224fa4679d2fb2187ba55431c284fa1b74cbc8cfda866fd4d2c09 have valid signatures.\r\n2023-05-03T12:40:23Z Setting nMinimumChainWork=000000000000000000000000000000000000000000000000000001291fc22898\r\n2023-05-03T12:40:23Z Switching active chainstate to Chainstate [ibd] @ height -1 (null)\r\n2023-05-03T12:40:23Z Opening LevelDB in /home/will/.bitcoin/signet/blocks/index\r\n2023-05-03T12:40:23Z Opened LevelDB successfully\r\n2023-05-03T12:40:23Z Using obfuscation key for /home/will/.bitcoin/signet/blocks/index: 0000000000000000\r\n2023-05-03T12:40:24Z LoadBlockIndexDB: last block file = 4\r\n2023-05-03T12:40:24Z LoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=32218, size=117995451, heights=109096...141321, time=2022-09-22...2023-05-03)\r\n2023-05-03T12:40:24Z Checking all blk files are present...\r\n2023-05-03T12:40:25Z Opening LevelDB in /home/will/.bitcoin/signet/chainstate\r\n2023-05-03T12:40:25Z Opened LevelDB successfully\r\n2023-05-03T12:40:25Z Using obfuscation key for /home/will/.bitcoin/signet/chainstate: 279a4349025ab109\r\n2023-05-03T12:40:25Z Loaded best chain: hashBestChain=0000010052eca20e8afb2fd62cb0b07ef3cbbaffe43068c825f2e09f80b2ab35 height=140999 date=2023-05-01T05:37:27Z progress=0.997935\r\n2023-05-03T12:40:25Z init message: Verifying blocksâ¦\r\n2023-05-03T12:40:25Z Verifying last 6 blocks at level 3\r\n2023-05-03T12:40:25Z [0%]...[16%]...[33%]...[50%]...[66%]...[83%]...[99%]...[DONE].\r\n2023-05-03T12:40:25Z No coin database inconsistencies in last 6 blocks (9 transactions)\r\n2023-05-03T12:40:25Z  block index            2022ms\r\n2023-05-03T12:40:25Z Opening LevelDB in /home/will/.bitcoin/signet/indexes/coinstats/db\r\n2023-05-03T12:40:25Z Opened LevelDB successfully\r\n2023-05-03T12:40:25Z Using obfuscation key for /home/will/.bitcoin/signet/indexes/coinstats/db: 0000000000000000\r\n2023-05-03T12:40:25Z ERROR: CustomInit: Cannot read current coinstatsindex state; index may be corrupted\r\n2023-05-03T12:40:25Z Shutdown: In progress...\r\n2023-05-03T12:40:25Z scheduler thread exit\r\n2023-05-03T12:40:25Z Shutdown: done\r\n```\r\n\r\n</details>\r\n\r\nedit: I think this even occurred on my node after the `invalidateblock` command had finished",
      "created_at" : "2023-05-03T12:43:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1532965770",
      "id" : 1532965770,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27558",
      "node_id" : "IC_kwDOABII585bXzOK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1532965770/reactions"
      },
      "updated_at" : "2023-05-03T12:45:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1532965770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @mzumsande ",
      "created_at" : "2023-05-03T12:45:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1532968619",
      "id" : 1532968619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27558",
      "node_id" : "IC_kwDOABII585bXz6r",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1532968619/reactions"
      },
      "updated_at" : "2023-05-03T12:45:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1532968619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I haven't looked into the root cause yet, but some quick tests seem to suggest that this could be fixed by #25193 - at least I could reproduce it with master, but not with that branch.",
      "created_at" : "2023-05-03T18:36:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1533520155",
      "id" : 1533520155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27558",
      "node_id" : "IC_kwDOABII585bZ6kb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1533520155/reactions"
      },
      "updated_at" : "2023-05-03T18:36:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1533520155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "A more detailed explanation: The indexes have a `Rewind()` function to reverse the effects of blocks (which calls `CustomRewind` for the coinstats index). However, once the index is synced, `Rewind` will only be invoked through `BlockConnected()` validationinterface signals, not when blocks are disconnected. So when `invalidateblock` is called, the state of the coinstatsindex will still point to the old block (unless a new block is connected before the node is stopped).\r\n\r\nAfter restarting the node, the current logic in master sets the best block to the fork in the chain based on a locator - however, it doesn't rewind the state of the coinstatsindex as would be necessary to prevent corruption. With commit 5fafeec47185cd3fd0c079fcdc77f037971e8188 of #25193, we'd keep on loading the previous best block, and `ThreadSync` would then do the rewinding to the invalidated block - that way, corruption shouldn't be possible.\r\n\r\nAn additional change that would make sense to me is to let the indexes react to `BlockDisconnected` signals (by rewinding right when they happen). That would rewind the index immediately, and not only after the next startup, and seems useful in general. Of course it wouldn't help when the node is stopped midway through invalidateblock.",
      "created_at" : "2023-05-03T21:00:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1533742759",
      "id" : 1533742759,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27558",
      "node_id" : "IC_kwDOABII585baw6n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1533742759/reactions"
      },
      "updated_at" : "2023-05-03T21:28:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1533742759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @mzumsande, I can confirm that that patch does fix the described issue for me too.",
      "created_at" : "2023-05-04T08:38:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27558#issuecomment-1534309409",
      "id" : 1534309409,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27558",
      "node_id" : "IC_kwDOABII585bc7Qh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1534309409/reactions"
      },
      "updated_at" : "2023-05-04T08:38:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1534309409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
