[
   {
      "author_association" : "MEMBER",
      "body" : "I've observed such behavior but did not notice the reasons.\r\n\r\nThanks @luke-jr!",
      "created_at" : "2021-10-09T07:54:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23234#issuecomment-939250975",
      "id" : 939250975,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23234",
      "node_id" : "IC_kwDOABII5843-9Uf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/939250975/reactions"
      },
      "updated_at" : "2021-10-09T07:54:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/939250975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I had what I think was a similar issue (scriptcheck thread hanging, waiting on `SyncWithValidationInterfaceQueue` to complete). I found the changing `SyncWithValidationInterfaceQueue` to be:\r\n\r\n```c++\r\nvoid SyncWithValidationInterfaceQueue()\r\n{\r\n    AssertLockNotHeld(cs_main);\r\n    // Block until the validation queue drains\r\n    auto promise = std::make_shared<std::promise<void>>();\r\n    CallFunctionInValidationInterfaceQueue([promise] {\r\n        promise->set_value();\r\n    });\r\n    std::future_status status;\r\n    do {\r\n        status = promise->get_future().wait_for(10s);\r\n    } while (status != std::future_status::ready); // && !ShutdownRequested());\r\n}\r\n```\r\n\r\nfixed my problem. In particular, `Shutdown()` calls `scheduler->stop()` before `StopScriptCheckWorkerThreads()` which gives a deadlock: scheduler is stopped, but worker threads can't complete because they're waiting for the scheduler to finish off the promise. Just having the scriptcheck threads exit early isn't enough, because after the scriptcheck threads have finished `FlushBackgroundCallbacks()` is called which does the `promise->set_value()` above, so `promise` still needs to exist, hence making it a `shared_ptr`.",
      "created_at" : "2022-11-03T05:20:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23234#issuecomment-1301650721",
      "id" : 1301650721,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23234",
      "node_id" : "IC_kwDOABII585NlZ0h",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1301650721/reactions"
      },
      "updated_at" : "2022-11-03T05:20:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1301650721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
