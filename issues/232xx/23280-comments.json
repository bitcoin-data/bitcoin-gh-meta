[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r729149055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729149055"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: FYI @fanquake is discouraging \"for\" comments: https://github.com/bitcoin/bitcoin/pull/15294#pullrequestreview-779241491",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-10-14T16:25:36Z",
      "diff_hunk" : "@@ -24,6 +24,8 @@\n #include <index/blockfilterindex.h>\n #include <index/coinstatsindex.h>\n #include <index/txindex.h>\n+#include <init/caches.h> // for CalculateCacheSizes\n+#include <init/chainstate.h> // for LoadChainstateSequence",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r729149055",
      "id" : 729149055,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII584rde5_",
      "original_commit_id" : "29c5c2b4700aa3f537e7291971dbd763469fce1c",
      "original_line" : 28,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 5,
      "pull_request_review_id" : 779992528,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729149055/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-14T16:25:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729149055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK! I've already done a preliminary review of this code but will formally test and review very soon.",
      "created_at" : "2021-10-14T16:30:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-943522697",
      "id" : 943522697,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5844PQOJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943522697/reactions"
      },
      "updated_at" : "2021-10-14T16:30:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943522697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-10-14T16:52:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-943539690",
      "id" : 943539690,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5844PUXq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943539690/reactions"
      },
      "updated_at" : "2021-10-14T16:52:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943539690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed 29c5c2b4700aa3f537e7291971dbd763469fce1c -> 3d5aa4b8503ed834e4e14651cd64f8a5d3d47f46\r\n- Rebased over master\r\n- Changed some commit messages",
      "created_at" : "2021-10-14T17:04:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-943549459",
      "id" : 943549459,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5844PWwT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943549459/reactions"
      },
      "updated_at" : "2021-10-14T17:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943549459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#21763](https://github.com/bitcoin/bitcoin/pull/21763) (test: Run AppInitSanityChecks before all tests by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-10-14T20:00:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-943683489",
      "id" : 943683489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5844P3eh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943683489/reactions"
      },
      "updated_at" : "2021-12-08T13:23:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943683489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Will review.",
      "created_at" : "2021-10-14T21:57:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-943766855",
      "id" : 943766855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5844QL1H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943766855/reactions"
      },
      "updated_at" : "2021-10-14T21:57:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943766855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-10-15T09:38:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-944150951",
      "id" : 944150951,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5844Rpmn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/944150951/reactions"
      },
      "updated_at" : "2021-10-15T09:38:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/944150951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed 3d5aa4b850...7dd898c0df:\r\n- Rebased over master\r\n- Tweaked last commit to minimize use of `gArgs` in setup_common",
      "created_at" : "2021-10-15T15:50:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-944408573",
      "id" : 944408573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5844Sof9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/944408573/reactions"
      },
      "updated_at" : "2021-10-15T15:50:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/944408573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r739412808"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/739412808"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cd29d334a3 \r\n\r\n`XXX` to be removed/addressed?",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-10-29T17:22:02Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r739412808",
      "id" : 739412808,
      "line" : 1415,
      "node_id" : "PRRC_kwDOABII584sEotI",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1415,
      "original_position" : 209,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 209,
      "pull_request_review_id" : 793288260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/739412808/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-29T18:16:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/739412808",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r739424818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/739424818"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b229024932 \r\n\r\nNote for other reviewers: NotifyBlockTip -> RPCNotifyBlockChange(tip) is performed here: https://github.com/jamesob/bitcoin/blob/master/src/init.cpp#L343-L347\r\n\r\nAlso note that `uiInterface.NotifyBlockTip()` is already called from within other `CChainState` methods (e.g. `ActivateBestChain()`), so there's no concern about introducing exposure to a global in CChainState code.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-10-29T17:41:51Z",
      "diff_hunk" : "@@ -3764,6 +3764,7 @@ bool CChainState::LoadChainTip()\n     PruneBlockIndexCandidates();\n \n     tip = m_chain.Tip();\n+    uiInterface.NotifyBlockTip(GetSynchronizationState(IsInitialBlockDownload()), tip);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r739424818",
      "id" : 739424818,
      "line" : 3767,
      "node_id" : "PRRC_kwDOABII584sEroy",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 3767,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 793288260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/739424818/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-29T18:16:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/739424818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r739436153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/739436153"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1f966b8d9f\r\n\r\nOne naive question here might be: why are we using a mutable arg for `cache_sizes` vs. just returning a constructed `CacheSizes` instance to make the function pure? Answer seems to be that this is used within a unittest context to modify an existing `m_cache_sizes` instance.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-10-29T18:00:43Z",
      "diff_hunk" : "@@ -0,0 +1,36 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <init/caches.h>\n+\n+#include <txdb.h>\n+#include <util/system.h>\n+#include <validation.h>\n+\n+void CalculateCacheSizes(const ArgsManager& args, CacheSizes& cache_sizes, size_t n_indexes)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r739436153",
      "id" : 739436153,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII584sEuZ5",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 11,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/init/caches.cpp",
      "position" : 11,
      "pull_request_review_id" : 793288260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/739436153/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-29T18:16:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/739436153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "My sincerest thanks for the thorough review @jamesob, that functional test in #23289 is certainly beyond the call of duty, and the `master` bug it revealed is leading to some excellent investigation in #23365. ð \r\n\r\nI'm glad to hear that this sort of cleanup came up for the AssumeUTXO work as well, my hope is that the change will make future work easier involving the init sequence easier to reason about.\r\n\r\n> reusing more (all?) of our chain initialization logic from within the unittests\r\n\r\nOne thing to note is that although we _load_ the chainstate, we do not _activate_ it, which is done in `ThreadImport` with `ActivateBestChain`, this can be included in followup PRs.",
      "created_at" : "2021-10-29T20:28:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-955029268",
      "id" : 955029268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII58447JcU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/955029268/reactions"
      },
      "updated_at" : "2021-10-29T20:28:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/955029268",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743133511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743133511"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init: Extract chainstate loading sequence\" (83ed7db27b4c4798666b77d83fc8e7c3eab8c621)\r\n\r\n>```\r\n>The sequence can have 4 types of outcomes:\r\n>\r\n>1. Success\r\n>2. Shutdown requested\r\n>  - nothing failed but a shutdown was triggered in the middle of the\r\n>    sequence\r\n>3. Soft failure\r\n>  - a failure that might be recovered from with a reindex\r\n>4. Hard failure\r\n>  - a failure that definitively cannot be recovered from with a reindex\r\n>\r\n>Currently, LoadChainstateSequence returns a bool which:\r\n>    - if false\r\n>        - Definitely a \"Hard failure\"\r\n>    - if true\r\n>        - if fLoaded -> \"Success\"\r\n>        - if ShutdownRequested() -> \"Shutdown requested\"\r\n>        - else -> \"Soft failure\"\r\n>```\r\n\r\nI'd remove this explanation from the commit message and move it to here above this function declaration, or to the .cpp file as a code comment. This is helpful information to know and a shame for it to be lost in a temporary commit message. Also it will make upcoming changes easier to understand if this documentation is updated in sync with the changes.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-04T19:15:28Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H\n+#define BITCOIN_INIT_CHAINSTATE_H\n+\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+struct bilingual_str;\n+class CChainParams;\n+class CClientUIInterface;\n+class ChainstateManager;\n+struct NodeContext;\n+\n+bool LoadChainstateSequence(bool& fLoaded,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743133511",
      "id" : 743133511,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sS1FH",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/init/chainstate.h",
      "position" : null,
      "pull_request_review_id" : 798165689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743133511/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T19:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743133511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743624127"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743624127"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init/chainstate: Decouple from stringy errors\" (cd29d334a38fdaf0bbbe810a9cbdeeffad394daa)\r\n\r\nWith this commit introducing and returning a nice status type, I think it is a shame to add a new out-of-band global `ShutdownRequested` call to check the interrupted status separately from the return value. Would suggest adding a `ChainstateLoadingError::INTERRUPTED_SHUTDOWN_REQUESTED` or similar return code. And in the future hopefully we can get rid of  other global `ShutdownRequested` calls as well.\r\n\r\nIn case motivation for this request is unclear, reason I think a return code is better than a global status check is that requiring a global check makes function usage easier to screw up. It is easier to accidentally forget an external check than to forget to handle a return value. Also if there is a race where a shutdown is requested after the function returns, it doesn't seem right to skip logging the call's success. The right interruption point is after the function call and the log, not between.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T12:35:32Z",
      "diff_hunk" : "@@ -1415,8 +1412,46 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                          nCoinCacheUsage,\n                                          args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n                                          args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL));\n-        if (!rv) return false;\n-        if (fLoaded) {\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:\n+                strLoadError = _(\"Error loading block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK:\n+                return false;  // bail immediately!\n+            case ChainstateLoadingError::ERROR_PRUNED_NEEDS_REINDEX:\n+                strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOAD_GENESIS_BLOCK_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CHAINSTATE_UPGRADE_FAILED:\n+                strLoadError = _(\"Error upgrading chainstate database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_REPLAYBLOCKS_FAILED:\n+                strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOADCHAINTIP_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED:\n+                strLoadError = _(\"Error opening block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCKS_WITNESS_INSUFFICIENTLY_VALIDATED:\n+                strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n+                                         chainparams.GetConsensus().SegwitHeight);\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCK_FROM_FUTURE:\n+                strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n+                                 \"This may be due to your computer's date and time being set incorrectly. \"\n+                                 \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CORRUPTED_BLOCK_DB:\n+                strLoadError = _(\"Corrupted block database detected\");\n+                break;\n+            }\n+        } else if (!ShutdownRequested()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743624127",
      "id" : 743624127,
      "line" : 1456,
      "node_id" : "PRRC_kwDOABII584sUs2_",
      "original_commit_id" : "cd29d334a38fdaf0bbbe810a9cbdeeffad394daa",
      "original_line" : 1453,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 305,
      "pull_request_review_id" : 798165689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743624127/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T19:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743624127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743628897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743628897"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init/chainstate: Decouple from stringy errors\" (cd29d334a38fdaf0bbbe810a9cbdeeffad394daa)\r\n\r\nThis seems to be losing the \"Incorrect or no genesis block found. Wrong datadir for network?\" error string. Would be good to fix or say in the commit message if this is intentional.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T12:43:06Z",
      "diff_hunk" : "@@ -1415,8 +1412,46 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                          nCoinCacheUsage,\n                                          args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n                                          args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL));\n-        if (!rv) return false;\n-        if (fLoaded) {\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:\n+                strLoadError = _(\"Error loading block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK:\n+                return false;  // bail immediately!",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743628897",
      "id" : 743628897,
      "line" : 1424,
      "node_id" : "PRRC_kwDOABII584sUuBh",
      "original_commit_id" : "cd29d334a38fdaf0bbbe810a9cbdeeffad394daa",
      "original_line" : 1421,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 266,
      "pull_request_review_id" : 798165689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743628897/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T19:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743628897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743636334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743636334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                                                             std::optional<std::function<void()>> verifying_blocks_cb)\r\n{\r\n```",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T12:54:08Z",
      "diff_hunk" : "@@ -0,0 +1,157 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <init/chainstate.h>\n+\n+#include <consensus/params.h> // for Consensus::Params\n+#include <node/blockstorage.h> // for CleanupBlockRevFiles, fHavePruned, fReindex\n+#include <validation.h> // for a lot of things\n+\n+std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n+                                                             ChainstateManager& chainman,\n+                                                             CTxMemPool* mempool,\n+                                                             bool fPruneMode,\n+                                                             const Consensus::Params& consensus_params,\n+                                                             bool fReindexChainState,\n+                                                             int64_t nBlockTreeDBCache,\n+                                                             int64_t nCoinDBCache,\n+                                                             int64_t nCoinCacheUsage,\n+                                                             unsigned int check_blocks,\n+                                                             unsigned int check_level,\n+                                                             bool block_tree_db_in_memory,\n+                                                             bool coins_db_in_memory,\n+                                                             std::function<int64_t()> get_unix_time_seconds,\n+                                                             std::optional<std::function<bool()>> shutdown_requested,\n+                                                             std::optional<std::function<void()>> coins_error_cb,\n+                                                             std::optional<std::function<void()>> verifying_blocks_cb) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743636334",
      "id" : 743636334,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII584sUv1u",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 27,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : 27,
      "pull_request_review_id" : 798853955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743636334/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T13:06:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743636334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743637480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743637480"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init/chainstate: Decouple from stringy errors\" (cd29d334a38fdaf0bbbe810a9cbdeeffad394daa)\r\n\r\n>```\r\n>1. Success\r\n>2. Shutdown requested\r\n>  - nothing failed but a shutdown was triggered in the middle of the\r\n>    sequence\r\n>3. Soft failure\r\n>  - a failure that might be recovered from with a reindex\r\n>4. Hard failure\r\n>  - a failure that definitively cannot be recovered from with a reindex\r\n>\r\n>Previously, LoadChainstateSequence returns a bool which:\r\n>    - if false\r\n>        - Definitely a \"Hard failure\"\r\n>    - if true\r\n>        - if fLoaded -> \"Success\"\r\n>        - if ShutdownRequested() -> \"Shutdown requested\"\r\n>        - else -> \"Soft failure\"\r\n>\r\n>After this change, LoadChainstateSequence returns a\r\n>std::optional<ChainstateLoadingError> which:\r\n>    - if has_value()\r\n>        - Either \"Soft failure\" or \"Hard failure\", caller decides what\r\n>          to do based on the specific ChainstateLoadingError enum\r\n>          member\r\n>    - else\r\n>        - Either \"Success\" or \"Shutdown requested\", caller checks\r\n>          ShutdownRequested() to determine which.\r\n>```\r\n\r\nAgain I think this information should be removed from the commit message and moved here to the function declaration or the chainstate.cpp file as documentation for the LoadChainstateSequence function. That way instead of having manually compare these two piece of documentation, the differences can be seen with standard diff tools. This will leave the code better documented, let documentation change in sync with the code, and let the commit message succinctly describe the changes in behavior without having to describe the full behavior.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T12:55:51Z",
      "diff_hunk" : "@@ -6,27 +6,24 @@\n \n #include <chainparams.h> // for CChainParams\n #include <rpc/blockchain.h> // for RPCNotifyBlockChange\n-#include <util/translation.h> // for bilingual_str\n #include <node/blockstorage.h> // for CleanupBlockRevFiles, fHavePruned, fReindex\n #include <node/ui_interface.h> // for InitError, CClientUIInterface member access\n #include <shutdown.h> // for ShutdownRequested\n #include <timedata.h> // for GetAdjustedTime\n #include <validation.h> // for a lot of things\n \n-bool LoadChainstateSequence(bool& fLoaded,\n-                            bilingual_str& strLoadError,\n-                            bool fReset,\n-                            CClientUIInterface& uiInterface,\n-                            ChainstateManager& chainman,\n-                            CTxMemPool* mempool,\n-                            bool fPruneMode,\n-                            const CChainParams& chainparams,\n-                            bool fReindexChainState,\n-                            int64_t nBlockTreeDBCache,\n-                            int64_t nCoinDBCache,\n-                            int64_t nCoinCacheUsage,\n-                            unsigned int check_blocks,\n-                            unsigned int check_level) {\n+std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743637480",
      "id" : 743637480,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII584sUwHo",
      "original_commit_id" : "cd29d334a38fdaf0bbbe810a9cbdeeffad394daa",
      "original_line" : 15,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : 11,
      "pull_request_review_id" : 798165689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743637480/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T19:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743637480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743645041"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743645041"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree. These comments are unmaintainable.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T13:06:57Z",
      "diff_hunk" : "@@ -24,6 +24,8 @@\n #include <index/blockfilterindex.h>\n #include <index/coinstatsindex.h>\n #include <index/txindex.h>\n+#include <init/caches.h> // for CalculateCacheSizes\n+#include <init/chainstate.h> // for LoadChainstateSequence",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743645041",
      "id" : 743645041,
      "in_reply_to_id" : 729149055,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII584sUx9x",
      "original_commit_id" : "29c5c2b4700aa3f537e7291971dbd763469fce1c",
      "original_line" : 28,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 5,
      "pull_request_review_id" : 798853955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743645041/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T13:06:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743645041",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743657031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743657031"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would have guessed that this would be part of libbitcoin_server, since loading a chainstate is something that only bitcoind or bitcoin-qt would do.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T13:23:47Z",
      "diff_hunk" : "@@ -547,6 +549,8 @@ libbitcoin_common_a_SOURCES = \\\n   core_write.cpp \\\n   deploymentinfo.cpp \\\n   external_signer.cpp \\\n+  init/caches.cpp \\\n+  init/chainstate.cpp \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743657031",
      "id" : 743657031,
      "line" : 553,
      "node_id" : "PRRC_kwDOABII584sU05H",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 553,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/Makefile.am",
      "position" : 14,
      "pull_request_review_id" : 798882733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743657031/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T15:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743657031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743661160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743661160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It'd be great if there was a final commit that added a doxygen comment for all of these parameters.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T13:29:12Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H\n+#define BITCOIN_INIT_CHAINSTATE_H\n+\n+#include <cstdint> // for int64_t\n+#include <functional> // for std::function\n+#include <optional> // for std::optional\n+\n+class ChainstateManager;\n+namespace Consensus {\n+    struct Params;\n+}\n+class CTxMemPool;\n+\n+enum class ChainstateLoadingError {\n+    ERROR_LOADING_BLOCK_DB,\n+    ERROR_BAD_GENESIS_BLOCK,\n+    ERROR_PRUNED_NEEDS_REINDEX,\n+    ERROR_LOAD_GENESIS_BLOCK_FAILED,\n+    ERROR_CHAINSTATE_UPGRADE_FAILED,\n+    ERROR_REPLAYBLOCKS_FAILED,\n+    ERROR_LOADCHAINTIP_FAILED,\n+    ERROR_GENERIC_BLOCKDB_OPEN_FAILED,\n+    ERROR_BLOCKS_WITNESS_INSUFFICIENTLY_VALIDATED,\n+    ERROR_BLOCK_FROM_FUTURE,\n+    ERROR_CORRUPTED_BLOCK_DB,\n+};\n+\n+std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743661160",
      "id" : 743661160,
      "line" : 32,
      "node_id" : "PRRC_kwDOABII584sU15o",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 32,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/init/chainstate.h",
      "position" : 32,
      "pull_request_review_id" : 798882733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743661160/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T15:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743661160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743698625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743698625"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't really like the use of \"bail\" here or in the commit log. It feels a bit colloquial and imprecise.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T14:15:37Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX\n+            rv = ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED;\n+        }\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:\n+                strLoadError = _(\"Error loading block database\");\n                 break;\n-            }\n-\n-            if (!fReset) {\n-                LOCK(cs_main);\n-                auto chainstates{chainman.GetAll()};\n-                if (std::any_of(chainstates.begin(), chainstates.end(),\n-                                [](const CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(); })) {\n-                    strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n-                                             chainparams.GetConsensus().SegwitHeight);\n-                    break;\n-                }\n-            }\n-\n-            bool failed_verification = false;\n-\n-            try {\n-                LOCK(cs_main);\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n-                        if (fHavePruned && args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS) > MIN_BLOCKS_TO_KEEP) {\n-                            LogPrintf(\"Prune: pruned datadir may not have more than %d blocks; only checking available blocks\\n\",\n-                                MIN_BLOCKS_TO_KEEP);\n-                        }\n-\n-                        const CBlockIndex* tip = chainstate->m_chain.Tip();\n-                        RPCNotifyBlockChange(tip);\n-                        if (tip && tip->nTime > GetAdjustedTime() + 2 * 60 * 60) {\n-                            strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n-                                    \"This may be due to your computer's date and time being set incorrectly. \"\n-                                    \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n-                            failed_verification = true;\n-                            break;\n-                        }\n-\n-                        if (!CVerifyDB().VerifyDB(\n-                                *chainstate, chainparams, chainstate->CoinsDB(),\n-                                args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n-                                args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS))) {\n-                            strLoadError = _(\"Corrupted block database detected\");\n-                            failed_verification = true;\n-                            break;\n-                        }\n-                    }\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n+            case ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK:\n+                return false;  // bail immediately!",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743698625",
      "id" : 743698625,
      "line" : 1424,
      "node_id" : "PRRC_kwDOABII584sU_DB",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1424,
      "original_position" : 266,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 266,
      "pull_request_review_id" : 798882733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743698625/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T15:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743698625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743703915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743703915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think about adding `ChainstateLoadingError::SHUTDOWN_REQUESTED` as an error reason, and then bringing the shutdown requested logic up into the switch statement above? I think that'd make the logic flow a bit easier to understand.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T14:21:57Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX\n+            rv = ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED;\n+        }\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:\n+                strLoadError = _(\"Error loading block database\");\n                 break;\n-            }\n-\n-            if (!fReset) {\n-                LOCK(cs_main);\n-                auto chainstates{chainman.GetAll()};\n-                if (std::any_of(chainstates.begin(), chainstates.end(),\n-                                [](const CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(); })) {\n-                    strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n-                                             chainparams.GetConsensus().SegwitHeight);\n-                    break;\n-                }\n-            }\n-\n-            bool failed_verification = false;\n-\n-            try {\n-                LOCK(cs_main);\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n-                        if (fHavePruned && args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS) > MIN_BLOCKS_TO_KEEP) {\n-                            LogPrintf(\"Prune: pruned datadir may not have more than %d blocks; only checking available blocks\\n\",\n-                                MIN_BLOCKS_TO_KEEP);\n-                        }\n-\n-                        const CBlockIndex* tip = chainstate->m_chain.Tip();\n-                        RPCNotifyBlockChange(tip);\n-                        if (tip && tip->nTime > GetAdjustedTime() + 2 * 60 * 60) {\n-                            strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n-                                    \"This may be due to your computer's date and time being set incorrectly. \"\n-                                    \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n-                            failed_verification = true;\n-                            break;\n-                        }\n-\n-                        if (!CVerifyDB().VerifyDB(\n-                                *chainstate, chainparams, chainstate->CoinsDB(),\n-                                args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n-                                args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS))) {\n-                            strLoadError = _(\"Corrupted block database detected\");\n-                            failed_verification = true;\n-                            break;\n-                        }\n-                    }\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n+            case ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK:\n+                return false;  // bail immediately!\n+            case ChainstateLoadingError::ERROR_PRUNED_NEEDS_REINDEX:\n+                strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOAD_GENESIS_BLOCK_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CHAINSTATE_UPGRADE_FAILED:\n+                strLoadError = _(\"Error upgrading chainstate database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_REPLAYBLOCKS_FAILED:\n+                strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOADCHAINTIP_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED:\n                 strLoadError = _(\"Error opening block database\");\n-                failed_verification = true;\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCKS_WITNESS_INSUFFICIENTLY_VALIDATED:\n+                strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n+                                         chainparams.GetConsensus().SegwitHeight);\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCK_FROM_FUTURE:\n+                strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n+                                 \"This may be due to your computer's date and time being set incorrectly. \"\n+                                 \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CORRUPTED_BLOCK_DB:\n+                strLoadError = _(\"Corrupted block database detected\");\n                 break;\n             }\n-\n-            if (!failed_verification) {\n-                fLoaded = true;\n-                LogPrintf(\" block index %15dms\\n\", GetTimeMillis() - load_block_index_start_time);\n-            }\n-        } while(false);\n+        } else if (!ShutdownRequested()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743703915",
      "id" : 743703915,
      "line" : 1456,
      "node_id" : "PRRC_kwDOABII584sVAVr",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1456,
      "original_position" : 305,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 305,
      "pull_request_review_id" : 798882733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743703915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T15:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743703915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743709991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743709991"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't like how the error strings have been separated from the error logic that they're describing. What do you think about returning an optional `std::pair` or struct from `LoadChainstateSequence()` that contains both the enum and error string? That'd simplify this switch statement (all the \"soft failure\" cases could share the same statement, and there'd be one separate statement for the \"hard failure\")",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T14:29:09Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX\n+            rv = ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED;\n+        }\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743709991",
      "id" : 743709991,
      "line" : 1420,
      "node_id" : "PRRC_kwDOABII584sVB0n",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1420,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 214,
      "pull_request_review_id" : 798882733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743709991/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T15:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743709991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743713370"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743713370"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It looks like this init error string has been lost. I think that previously this would have been displayed to the user.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T14:33:08Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743713370",
      "id" : 743713370,
      "line" : 1444,
      "node_id" : "PRRC_kwDOABII584sVCpa",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1444,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 110,
      "pull_request_review_id" : 798882733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743713370/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T15:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743713370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743767227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743767227"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Again, it'd be nice to have a doxygen comment here. It's not immediately obvious what `n_indexes` represents.\r\n\r\nIs there any reason that you made `cache_sizes` an out-param rather than the return value for this function?\r\n\r\nSince this is a new function and you're adding all the call sites, can we make `n_indexes` a required argument?",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T15:35:13Z",
      "diff_hunk" : "@@ -0,0 +1,22 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CACHES_H\n+#define BITCOIN_INIT_CACHES_H\n+\n+#include <cstddef> // for size_t\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+\n+struct CacheSizes {\n+    int64_t block_tree_db_cache_size;\n+    int64_t coin_db_cache_size;\n+    int64_t coin_cache_usage_size;\n+    int64_t tx_index_cache_size;\n+    int64_t filter_index_cache_size;\n+};\n+void CalculateCacheSizes(const ArgsManager& args, CacheSizes& cache_sizes, size_t n_indexes = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743767227",
      "id" : 743767227,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII584sVPy7",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/init/caches.h",
      "position" : 20,
      "pull_request_review_id" : 798882733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743767227/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T15:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743767227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743768587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743768587"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `_cache_size` parts to all these member names seems redundant with the fact they're members of a struct called `CacheSizes`",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T15:36:50Z",
      "diff_hunk" : "@@ -0,0 +1,22 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CACHES_H\n+#define BITCOIN_INIT_CACHES_H\n+\n+#include <cstddef> // for size_t\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+\n+struct CacheSizes {\n+    int64_t block_tree_db_cache_size;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743768587",
      "id" : 743768587,
      "line" : 14,
      "node_id" : "PRRC_kwDOABII584sVQIL",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 14,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/init/caches.h",
      "position" : 14,
      "pull_request_review_id" : 798882733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743768587/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T15:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743768587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743771983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743771983"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you add inline comments for these arguments (that can be checked by a clang-tidy):\r\n\r\n```suggestion\r\n                                        /*block_tree_db_in_memory=*/false,\r\n                                        /*coins_db_in_memory=*/false,\r\n```",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T15:40:57Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743771983",
      "id" : 743771983,
      "line" : 1403,
      "node_id" : "PRRC_kwDOABII584sVQ9P",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1403,
      "original_position" : 197,
      "original_start_line" : 1402,
      "path" : "src/init.cpp",
      "position" : 197,
      "pull_request_review_id" : 798882733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743771983/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1402,
      "start_side" : "RIGHT",
      "updated_at" : "2021-11-05T15:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743771983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743809355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743809355"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This function now consists of three code blocks that each lock `cs_main`. What do you think about just taking `cs_main` at the top of the function and holding it throughout?",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T16:28:38Z",
      "diff_hunk" : "@@ -0,0 +1,157 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <init/chainstate.h>\n+\n+#include <consensus/params.h> // for Consensus::Params\n+#include <node/blockstorage.h> // for CleanupBlockRevFiles, fHavePruned, fReindex\n+#include <validation.h> // for a lot of things\n+\n+std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n+                                                             ChainstateManager& chainman,\n+                                                             CTxMemPool* mempool,\n+                                                             bool fPruneMode,\n+                                                             const Consensus::Params& consensus_params,\n+                                                             bool fReindexChainState,\n+                                                             int64_t nBlockTreeDBCache,\n+                                                             int64_t nCoinDBCache,\n+                                                             int64_t nCoinCacheUsage,\n+                                                             unsigned int check_blocks,\n+                                                             unsigned int check_level,\n+                                                             bool block_tree_db_in_memory,\n+                                                             bool coins_db_in_memory,\n+                                                             std::function<int64_t()> get_unix_time_seconds,\n+                                                             std::optional<std::function<bool()>> shutdown_requested,\n+                                                             std::optional<std::function<void()>> coins_error_cb,\n+                                                             std::optional<std::function<void()>> verifying_blocks_cb) {\n+    auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n+    };\n+\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743809355",
      "id" : 743809355,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII584sVaFL",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 33,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : 33,
      "pull_request_review_id" : 799097823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743809355/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T16:28:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743809355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743851104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743851104"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init: Extract chainstate loading sequence\" (83ed7db27b4c4798666b77d83fc8e7c3eab8c621)\r\n\r\nOther code in the `src/init/` directory is using the `init:: namespace, and I think it'd be good to follow that pattern:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/77a2f5d30c5ecb764b8a7c098492e1f5cdec90f0/src/init/common.cpp#L25\r\nhttps://github.com/bitcoin/bitcoin/blob/77a2f5d30c5ecb764b8a7c098492e1f5cdec90f0/src/init/bitcoind.cpp#L15\r\n\r\nIn general, I'd like to expand use of pattern putting `src/init` code in `init::`, `src/util` code in `util::`, `src/interfaces` code in `interfaces::`, `src/node` code in `node::`, etc,",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T17:25:28Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H\n+#define BITCOIN_INIT_CHAINSTATE_H\n+\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+struct bilingual_str;\n+class CChainParams;\n+class CClientUIInterface;\n+class ChainstateManager;\n+struct NodeContext;\n+\n+bool LoadChainstateSequence(bool& fLoaded,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743851104",
      "id" : 743851104,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sVkRg",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/init/chainstate.h",
      "position" : null,
      "pull_request_review_id" : 798165689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743851104/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T19:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743851104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743858865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743858865"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init: Extract chainstate loading sequence\" (83ed7db27b4c4798666b77d83fc8e7c3eab8c621)\r\n\r\nI think the new files here `chainstate.h`, `chainstate.cpp`, `caches.h`, `caches.cpp` all belong in `src/node/` not `src/init/`.\r\n\r\nI maybe I should have given the [`src/init/`](https://github.com/bitcoin/bitcoin/tree/master/src/init) directory a more descriptive name like `src/process_init/`, but I was intending it to hold common code that various bitcoin executables: `bitcoind`, `bitcoin-qt`, `bitcoin-node`, `bitcoin-wallet`, and `bitcoin-gui` all generically need to start up, and to be place for them to customize their individual behavior by overriding `interfaces::Init` methods.\r\n\r\nThe new code being added in this PR is all node specific, and would be at home in `src/node/`. The new code is also not really related to any existing `src/init/` code except for being called during startup, and it would be unusual in this case to organize source code based on when it is called, instead of what it does.\r\n\r\nI think it should be possible to rename these files pretty painlessly in a rebase and git should be smart enough detect it and not create conflicts. Otherwise a handy command for a git rename over a series of commits is:\r\n\r\n```shell\r\ngit filter-branch --index-filter 'git mv <old name> <new name>' <base>..<head>\r\n```",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T17:36:54Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743858865",
      "id" : 743858865,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII584sVmKx",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init/chainstate.h",
      "position" : 5,
      "pull_request_review_id" : 798165689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743858865/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T19:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743858865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743895731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743895731"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: Call NotifyBlockTip in CCS::LoadChainTip\" (b229024932ebd4775070149ff0f27d0fd329bf0a)\r\n\r\nThis seems like a good change, but two questions come to mind here that might be good to address in commit message:\r\n\r\n1-Previously this code would work regardless of whether `OnRPCStarted` was called before `NotifyBlockTip`. Now it *must* be called before or the notification will be lost. I'm assuming the correct thing does happen, but it would be good to say if it does, or if something guarantees it.\r\n\r\n2-It looks like there are some other callers of `NotifyBlockTip_connect` in the node code and `handleNotifyBlockTip` in GUI code that may now receive new notifications. Is this the case, and are all these callers ok receiving it it? Are they are also OK being called with `cs_main` held?\r\n\r\n---\r\n\r\nEDIT: The newer version of b229024932ebd4775070149ff0f27d0fd329bf0a in ca13555758e6d868d3cfa5b55e679fca74381b03 in just moves the `OnRPCStarted` call instead of replacing it, to avoid potential problems above.",
      "commit_id" : "8301c696d0a0be921ce01b6e9f74f7ff6e8c0f2f",
      "created_at" : "2021-11-05T18:34:30Z",
      "diff_hunk" : "@@ -3764,6 +3764,7 @@ bool CChainState::LoadChainTip()\n     PruneBlockIndexCandidates();\n \n     tip = m_chain.Tip();\n+    uiInterface.NotifyBlockTip(GetSynchronizationState(IsInitialBlockDownload()), tip);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743895731",
      "id" : 743895731,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sVvKz",
      "original_commit_id" : "b229024932ebd4775070149ff0f27d0fd329bf0a",
      "original_line" : 3767,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 798165689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743895731/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T19:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743895731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743901275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743901275"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init: Extract chainstate loading sequence\" (83ed7db27b4c4798666b77d83fc8e7c3eab8c621)\r\n\r\n\"Sequence\" here seems like a strange thing to include in a the function name. Most functions are sequences. IMO an ideal name for this function would be something like `node::LoadChainStates` (assuming this is moved to `src/node/` directory and put in `node::` namespace).",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T18:43:57Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H\n+#define BITCOIN_INIT_CHAINSTATE_H\n+\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+struct bilingual_str;\n+class CChainParams;\n+class CClientUIInterface;\n+class ChainstateManager;\n+struct NodeContext;\n+\n+bool LoadChainstateSequence(bool& fLoaded,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743901275",
      "id" : 743901275,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sVwhb",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/init/chainstate.h",
      "position" : null,
      "pull_request_review_id" : 798165689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743901275/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T19:43:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743901275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743904232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743904232"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init/chainstate: Add options for in-memory DBs\" (f45b885db6636e135d617d915e0ef4ec9e1be8e6)\r\n\r\nI think the `LoadChainstateSequence` function already has so many arguments that if we're going to add optional ones they should really be consolidated in an options struct like:\r\n\r\n```c++\r\nstruct LoadChainStatesOptions {\r\n    std::optional<std::function<bool()>> shutdown_requested_cb;\r\n    std::optional<std::function<void()>> coins_error_cb;\r\n    std::optional<std::function<void()>> verifying_blocks_cb;\r\n};\r\n```\r\n\r\nIf it's possible to eliminate other function arguments that have sensible default values and move them to the options struct as well, that would be great:\r\n\r\n```c++\r\n    bool block_tree_db_in_memory = false;\r\n    bool coins_db_in_memory = false;\r\n```",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T18:49:05Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H\n+#define BITCOIN_INIT_CHAINSTATE_H\n+\n+#include <cstdint> // for int64_t\n+#include <functional> // for std::function\n+#include <optional> // for std::optional\n+\n+class ChainstateManager;\n+namespace Consensus {\n+    struct Params;\n+}\n+class CTxMemPool;\n+\n+enum class ChainstateLoadingError {\n+    ERROR_LOADING_BLOCK_DB,\n+    ERROR_BAD_GENESIS_BLOCK,\n+    ERROR_PRUNED_NEEDS_REINDEX,\n+    ERROR_LOAD_GENESIS_BLOCK_FAILED,\n+    ERROR_CHAINSTATE_UPGRADE_FAILED,\n+    ERROR_REPLAYBLOCKS_FAILED,\n+    ERROR_LOADCHAINTIP_FAILED,\n+    ERROR_GENERIC_BLOCKDB_OPEN_FAILED,\n+    ERROR_BLOCKS_WITNESS_INSUFFICIENTLY_VALIDATED,\n+    ERROR_BLOCK_FROM_FUTURE,\n+    ERROR_CORRUPTED_BLOCK_DB,\n+};\n+\n+std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n+                                                             ChainstateManager& chainman,\n+                                                             CTxMemPool* mempool,\n+                                                             bool fPruneMode,\n+                                                             const Consensus::Params& consensus_params,\n+                                                             bool fReindexChainState,\n+                                                             int64_t nBlockTreeDBCache,\n+                                                             int64_t nCoinDBCache,\n+                                                             int64_t nCoinCacheUsage,\n+                                                             unsigned int check_blocks,\n+                                                             unsigned int check_level,\n+                                                             bool block_tree_db_in_memory,\n+                                                             bool coins_db_in_memory,\n+                                                             std::function<int64_t()> get_unix_time_seconds,\n+                                                             std::optional<std::function<bool()>> shutdown_requested = std::nullopt,\n+                                                             std::optional<std::function<void()>> coins_error_cb = std::nullopt,\n+                                                             std::optional<std::function<void()>> verifying_blocks_cb = std::nullopt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743904232",
      "id" : 743904232,
      "line" : 48,
      "node_id" : "PRRC_kwDOABII584sVxPo",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 48,
      "original_position" : 48,
      "original_start_line" : 46,
      "path" : "src/init/chainstate.h",
      "position" : 48,
      "pull_request_review_id" : 798165689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743904232/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 46,
      "start_side" : "RIGHT",
      "updated_at" : "2021-11-05T19:43:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743904232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743923908"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743923908"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"init: Extract chainstate loading sequence\"\r\n\r\nCould you please use a new variable here rather than shadowing the global? I was very confused about what changed that required `AddReadErrCallback([](...))` -> `AddReadErrCallback([&](...))`",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T19:24:22Z",
      "diff_hunk" : "@@ -0,0 +1,206 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <init/chainstate.h>\n+\n+#include <chainparams.h> // for CChainParams\n+#include <rpc/blockchain.h> // for RPCNotifyBlockChange\n+#include <util/time.h> // for GetTimeMillis\n+#include <util/translation.h> // for bilingual_str\n+#include <node/blockstorage.h> // for CleanupBlockRevFiles, fHavePruned, fReindex\n+#include <node/context.h> // for NodeContext\n+#include <node/ui_interface.h> // for InitError, CClientUIInterface member access\n+#include <shutdown.h> // for ShutdownRequested\n+#include <timedata.h> // for GetAdjustedTime\n+#include <validation.h> // for a lot of things\n+\n+bool LoadChainstateSequence(bool& fLoaded,\n+                            bilingual_str& strLoadError,\n+                            bool fReset,\n+                            CClientUIInterface& uiInterface,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743923908",
      "id" : 743923908,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sV2DE",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 21,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743923908/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743923908",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743933885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743933885"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"init/chainstate: Decouple from concept of NodeContext\"\r\n\r\nI think it makes sense to split this into two commits, one for the decoupling and one for the nullable mempool. I think that's a significant thing to signal for review.\r\n\r\nSome justification for why this is safe (and maybe why it wasn't this way before) would be helpful context for review as well.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T19:43:28Z",
      "diff_hunk" : "@@ -37,11 +36,11 @@ bool LoadChainstateSequence(bool& fLoaded,\n         const int64_t load_block_index_start_time = GetTimeMillis();\n         try {\n             LOCK(cs_main);\n-            chainman.InitializeChainstate(Assert(node.mempool.get()));\n+            chainman.InitializeChainstate(mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743933885",
      "id" : 743933885,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sV4e9",
      "original_commit_id" : "3ecaf812d4934d63124b640d2aeb008d4b742d89",
      "original_line" : 39,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743933885/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743933885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743935696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743935696"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"init/chainstate: Decouple from GetTimeMillis\"\r\n\r\nThe commit message mentions passing in a callback for the current time, but that's not what's happening here. Fingers crossed that's not what happens in the next commit, because it sounds ugly :p",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T19:47:00Z",
      "diff_hunk" : "@@ -1400,6 +1400,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n \n+        const int64_t load_block_index_start_time = GetTimeMillis();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743935696",
      "id" : 743935696,
      "line" : 1388,
      "node_id" : "PRRC_kwDOABII584sV47Q",
      "original_commit_id" : "e53e85f8b4ff7642c876950942cadcc819aa50e1",
      "original_line" : 1403,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 182,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743935696/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743935696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743937762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743937762"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm, I rather like the separation of logic. How about a lookup function rather than marrying them? Something like https://github.com/bitcoin/bitcoin/blob/master/src/script/script_error.cpp#L10 ",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T19:50:45Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX\n+            rv = ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED;\n+        }\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743937762",
      "id" : 743937762,
      "in_reply_to_id" : 743709991,
      "line" : 1420,
      "node_id" : "PRRC_kwDOABII584sV5bi",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1420,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 214,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743937762/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743937762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743953515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743953515"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I third this idea. It's what I would've expected, and the alternative here seems weird. Additionally, we might want to specify in the future _why_ shutdown was requested (rpc, console, etc). ",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T20:17:47Z",
      "diff_hunk" : "@@ -1415,8 +1412,46 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                          nCoinCacheUsage,\n                                          args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n                                          args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL));\n-        if (!rv) return false;\n-        if (fLoaded) {\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:\n+                strLoadError = _(\"Error loading block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK:\n+                return false;  // bail immediately!\n+            case ChainstateLoadingError::ERROR_PRUNED_NEEDS_REINDEX:\n+                strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOAD_GENESIS_BLOCK_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CHAINSTATE_UPGRADE_FAILED:\n+                strLoadError = _(\"Error upgrading chainstate database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_REPLAYBLOCKS_FAILED:\n+                strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOADCHAINTIP_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED:\n+                strLoadError = _(\"Error opening block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCKS_WITNESS_INSUFFICIENTLY_VALIDATED:\n+                strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n+                                         chainparams.GetConsensus().SegwitHeight);\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCK_FROM_FUTURE:\n+                strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n+                                 \"This may be due to your computer's date and time being set incorrectly. \"\n+                                 \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CORRUPTED_BLOCK_DB:\n+                strLoadError = _(\"Corrupted block database detected\");\n+                break;\n+            }\n+        } else if (!ShutdownRequested()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743953515",
      "id" : 743953515,
      "in_reply_to_id" : 743624127,
      "line" : 1456,
      "node_id" : "PRRC_kwDOABII584sV9Rr",
      "original_commit_id" : "cd29d334a38fdaf0bbbe810a9cbdeeffad394daa",
      "original_line" : 1453,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 305,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743953515/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743953515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743954607"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743954607"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why why why",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T20:20:00Z",
      "diff_hunk" : "@@ -127,36 +115,25 @@ bool LoadChainstateSequence(bool& fLoaded,\n                 if (!is_coinsview_empty(chainstate)) {\n                     // LoadChainTip initializes the chain based on CoinsTip()'s best block\n                     if (!chainstate->LoadChainTip()) {\n-                        strLoadError = _(\"Error initializing block database\");\n-                        failed_chainstate_init = true;\n-                        break; // out of the per-chainstate loop\n+                        return ChainstateLoadingError::ERROR_LOADCHAINTIP_FAILED;\n                     }\n                     assert(chainstate->m_chain.Tip() != nullptr);\n                 }\n             }\n-\n-            if (failed_chainstate_init) {\n-                break; // out of the chainstate activation do-while\n-            }\n         } catch (const std::exception& e) {\n-            LogPrintf(\"%s\\n\", e.what());\n-            strLoadError = _(\"Error opening block database\");\n-            break;\n+            LogPrintf(\"%s\\n\", e.what()); // XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743954607",
      "id" : 743954607,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sV9iv",
      "original_commit_id" : "cd29d334a38fdaf0bbbe810a9cbdeeffad394daa",
      "original_line" : 124,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743954607/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743954607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743961236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743961236"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"init/chainstate: Decouple from concept of uiInterface\"\r\n\r\nHmm, this seems strange. Before, it printed \"Error reading from database, shutting down\". Was that innacurate?\r\n\r\nWhy not instead return an error type and let the caller print the message and shutdown?",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T20:32:56Z",
      "diff_hunk" : "@@ -90,11 +90,9 @@ std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n                 /* in_memory */ false,\n                 /* should_wipe */ fReset || fReindexChainState);\n \n-            chainstate->CoinsErrorCatcher().AddReadErrCallback([&]() {\n-                uiInterface.ThreadSafeMessageBox(\n-                    _(\"Error reading from database, shutting down.\"),\n-                    \"\", CClientUIInterface::MSG_ERROR);\n-            });\n+            if (coins_error_cb.has_value()) {\n+                chainstate->CoinsErrorCatcher().AddReadErrCallback(coins_error_cb.value());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743961236",
      "id" : 743961236,
      "line" : 95,
      "node_id" : "PRRC_kwDOABII584sV_KU",
      "original_commit_id" : "0e61af06834c9a9331e620343e60e9104e08331e",
      "original_line" : 94,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : 95,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743961236/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743961236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743965561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743965561"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Might it make sense to split this function in two rather than requiring a callback in the middle? `LoadChainstateSequence` / `VerifyChainState` or so?\r\n\r\nNeeding to tell that we've moved on from one thing to another is a hint to me that maybe those things should be separate functions :)",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T20:41:57Z",
      "diff_hunk" : "@@ -138,7 +136,9 @@ std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n \n         for (CChainState* chainstate : chainman.GetAll()) {\n             if (!is_coinsview_empty(chainstate)) {\n-                uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                if (verifying_blocks_cb.has_value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743965561",
      "id" : 743965561,
      "line" : 137,
      "node_id" : "PRRC_kwDOABII584sWAN5",
      "original_commit_id" : "0e61af06834c9a9331e620343e60e9104e08331e",
      "original_line" : 139,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : 137,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743965561/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743965561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743969616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743969616"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"init/chainstate: Reduce coupling of LogPrintf\"\r\n\r\nGrouping the two try/catch looks safe to me, but I think it'd be easier to split this into two commits: one to combine, and one to move it out to init. That way the second is pretty much move-only.\r\n\r\nOr if you end up going the `LoadChainstateSequence`/`VerifyChainState` route, this logic doesn't need to change.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T20:50:25Z",
      "diff_hunk" : "@@ -1400,25 +1400,31 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n         const int64_t load_block_index_start_time = GetTimeMillis();\n-        auto rv = LoadChainstateSequence(fReset,\n-                                         chainman,\n-                                         Assert(node.mempool.get()),\n-                                         fPruneMode,\n-                                         chainparams,\n-                                         fReindexChainState,\n-                                         nBlockTreeDBCache,\n-                                         nCoinDBCache,\n-                                         nCoinCacheUsage,\n-                                         args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n-                                         args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n-                                         []() {\n-                                             uiInterface.ThreadSafeMessageBox(\n-                                                 _(\"Error reading from database, shutting down.\"),\n-                                                 \"\", CClientUIInterface::MSG_ERROR);\n-                                         },\n-                                         []() {\n-                                             uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n-                                         });\n+        std::optional<ChainstateLoadingError> rv;\n+        try {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743969616",
      "id" : 743969616,
      "line" : 1390,
      "node_id" : "PRRC_kwDOABII584sWBNQ",
      "original_commit_id" : "38d88e2950afc99caca31388fd75f03c4d06bcc9",
      "original_line" : 1404,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 184,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743969616/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743969616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743971845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743971845"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I belive this change also wouldn't be necessary with this function split in half.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T20:55:16Z",
      "diff_hunk" : "@@ -136,10 +136,6 @@ std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n                 if (verifying_blocks_cb.has_value()) {\n                     verifying_blocks_cb.value()();\n                 }\n-                if (fHavePruned && check_blocks > MIN_BLOCKS_TO_KEEP) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743971845",
      "id" : 743971845,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sWBwF",
      "original_commit_id" : "10564583429762ddfb6601d1f64ac663406bf8e2",
      "original_line" : 139,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743971845/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743971845",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743976213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743976213"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"init/chainstate: Decouple from GetAdjustedTime\"\r\n\r\nI suppose we can't just pass a timeout time in here because the current logic includes the runtime of the loading/checking itself?\r\n\r\nThis seems like yet something else that would be unnecessary if this function were split. That keeps coming up as a potential alternative, but I'm unsure if there's something that would prevent it, so I'll stop suggesting it.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T21:04:52Z",
      "diff_hunk" : "@@ -137,7 +137,7 @@ std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n                 }\n \n                 const CBlockIndex* tip = chainstate->m_chain.Tip();\n-                if (tip && tip->nTime > GetAdjustedTime() + 2 * 60 * 60) {\n+                if (tip && tip->nTime > get_unix_time_seconds() + 2 * 60 * 60) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743976213",
      "id" : 743976213,
      "line" : 142,
      "node_id" : "PRRC_kwDOABII584sWC0V",
      "original_commit_id" : "8eae069b0015524d877a6fc9f92ab85d2ad6b26b",
      "original_line" : 140,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : 142,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743976213/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743976213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743977609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743977609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"init/chainstate: Decouple from ShutdownRequested\"\r\n\r\nWithout actually trying it.. I think it would be more straightforward here to use a `CThreadInterrupt` which gets triggered for this.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-05T21:08:05Z",
      "diff_hunk" : "@@ -21,6 +20,7 @@ std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n                                                              unsigned int check_blocks,\n                                                              unsigned int check_level,\n                                                              std::function<int64_t()> get_unix_time_seconds,\n+                                                             std::optional<std::function<bool()>> shutdown_requested,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743977609",
      "id" : 743977609,
      "line" : 25,
      "node_id" : "PRRC_kwDOABII584sWDKJ",
      "original_commit_id" : "855a86102095003779d63b514728d1f0ed4d3a91",
      "original_line" : 23,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : 25,
      "pull_request_review_id" : 799254153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743977609/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-05T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743977609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r745731433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745731433"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with @theuni but in any case this feels like bikeshedding to me. What's written as-is is a clear improvement and refining this further should be optional or follow-up IMO.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-09T15:30:07Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX\n+            rv = ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED;\n+        }\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r745731433",
      "id" : 745731433,
      "in_reply_to_id" : 743709991,
      "line" : 1420,
      "node_id" : "PRRC_kwDOABII584scvVp",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1420,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 214,
      "pull_request_review_id" : 801435209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745731433/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-09T15:30:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745731433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r745734466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745734466"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Is there any reason that you made cache_sizes an out-param rather than the return value for this function?\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/23280#discussion_r739436153",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-09T15:33:06Z",
      "diff_hunk" : "@@ -0,0 +1,22 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CACHES_H\n+#define BITCOIN_INIT_CACHES_H\n+\n+#include <cstddef> // for size_t\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+\n+struct CacheSizes {\n+    int64_t block_tree_db_cache_size;\n+    int64_t coin_db_cache_size;\n+    int64_t coin_cache_usage_size;\n+    int64_t tx_index_cache_size;\n+    int64_t filter_index_cache_size;\n+};\n+void CalculateCacheSizes(const ArgsManager& args, CacheSizes& cache_sizes, size_t n_indexes = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r745734466",
      "id" : 745734466,
      "in_reply_to_id" : 743767227,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII584scwFC",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/init/caches.h",
      "position" : 20,
      "pull_request_review_id" : 801439296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745734466/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-09T15:33:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745734466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r745738495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745738495"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">  How about a lookup function rather than marrying them? Something like master/src/script/script_error.cpp#L10\r\n\r\nI agree that this would be an improvement, separating the error code:string lookup from the recovery logic.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-09T15:37:08Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX\n+            rv = ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED;\n+        }\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r745738495",
      "id" : 745738495,
      "in_reply_to_id" : 743709991,
      "line" : 1420,
      "node_id" : "PRRC_kwDOABII584scxD_",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1420,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 214,
      "pull_request_review_id" : 801444655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745738495/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-09T15:37:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745738495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r747746404"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747746404"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah I see! What do you think about putting the files under `src/node/init`? And I supposed everything would be under the `node::init` namespace?",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-11T19:00:54Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r747746404",
      "id" : 747746404,
      "in_reply_to_id" : 743858865,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII584skbRk",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init/chainstate.h",
      "position" : 5,
      "pull_request_review_id" : 804124570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747746404/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-11T19:00:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747746404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r747818124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747818124"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Ah I see! What do you think about putting the files under `src/node/init`? And I supposed everything would be under the `node::init` namespace?\r\n\r\nProbably best to use your own judgement, and other people may have opinions, but IMO just moving things into top level, `node`, `wallet`, `util` directories is ideal for seeing where things come from and making it obvious when you may be doing something bad like calling wallet code from node code. Extra nesting may be good, but I think only if there is some specific justification for it. In this case, I think having an \"init\" module is not good, because it will encourage people to add startup code from disparate parts of code there instead of closer to the actual database/index/connection structures that are being initialized. \r\n\r\nI also think it's nice when there's a 1:1 correspondence between directories and namespaces and personally would not suggest extra nesting for namespaces either.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-11T21:08:25Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r747818124",
      "id" : 747818124,
      "in_reply_to_id" : 743858865,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII584sksyM",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init/chainstate.h",
      "position" : 5,
      "pull_request_review_id" : 804218181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747818124/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-11T21:08:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747818124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r748454947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748454947"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743923908\r\n\r\n> In commit \"init: Extract chainstate loading sequence\"\r\n> \r\n> Could you please use a new variable here rather than shadowing the global? I was very confused about what changed that required `AddReadErrCallback([](...))` -> `AddReadErrCallback([&](...))`\r\n\r\nIMO ideal thing to do here so this commit remains moveonly and easy to review and doesn't require thinking about renames or new variables or adding `[&]`, is just to keep `uiInterface` a global instead of a parameter here, since it is already going away later anyway in 83ed7db27b4c4798666b77d83fc8e7c3eab8c621.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-12T17:14:20Z",
      "diff_hunk" : "@@ -0,0 +1,206 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <init/chainstate.h>\n+\n+#include <chainparams.h> // for CChainParams\n+#include <rpc/blockchain.h> // for RPCNotifyBlockChange\n+#include <util/time.h> // for GetTimeMillis\n+#include <util/translation.h> // for bilingual_str\n+#include <node/blockstorage.h> // for CleanupBlockRevFiles, fHavePruned, fReindex\n+#include <node/context.h> // for NodeContext\n+#include <node/ui_interface.h> // for InitError, CClientUIInterface member access\n+#include <shutdown.h> // for ShutdownRequested\n+#include <timedata.h> // for GetAdjustedTime\n+#include <validation.h> // for a lot of things\n+\n+bool LoadChainstateSequence(bool& fLoaded,\n+                            bilingual_str& strLoadError,\n+                            bool fReset,\n+                            CClientUIInterface& uiInterface,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r748454947",
      "id" : 748454947,
      "in_reply_to_id" : 743923908,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584snIQj",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 21,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 805043197,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748454947/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-12T17:46:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748454947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r748465779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748465779"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init/chainstate: Decouple from stringy errors\" (cd29d334a38fdaf0bbbe810a9cbdeeffad394daa)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743709991\r\n\r\nI agree with John's original comment, and do not think fine grained error codes are good or that some kind of external error code -> string indirection would be good. I think the ideal thing would be for this to return a straightforward SUCCESS / FAILURE / INTERRUPTED status, with a detailed error string or list of error strings in the case of failure. The problem with fine grained return codes is:\r\n\r\n- They are maintenance burden making code more verbose than it needs to be and hard to spot inconsistencies easier to introduce.\r\n- They are unergnomic for callers (important if this is supposed evolve into a libbitcoin kernel API) because it's more work for callers to figure out how to handle a long list error codes correctly than a small set of cases.\r\n- They are worse for user experience because it's not possible to include specific information about errors that may be helpful like filenames, timestamps, hashes.",
      "commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "created_at" : "2021-11-12T17:31:11Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX\n+            rv = ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED;\n+        }\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r748465779",
      "id" : 748465779,
      "in_reply_to_id" : 743709991,
      "line" : 1420,
      "node_id" : "PRRC_kwDOABII584snK5z",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1420,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 214,
      "pull_request_review_id" : 805043197,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748465779/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-12T17:46:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748465779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r748472926"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748472926"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743133511\r\n\r\nFWIW, followed up with more `node::` namespace in #23497",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-12T17:42:06Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r748472926",
      "id" : 748472926,
      "in_reply_to_id" : 743858865,
      "line" : 5,
      "node_id" : "PRRC_kwDOABII584snMpe",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init/chainstate.h",
      "position" : 5,
      "pull_request_review_id" : 805043197,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748472926/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-12T19:38:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748472926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749570801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749570801"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:13:23Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749570801",
      "id" : 749570801,
      "in_reply_to_id" : 739412808,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srYrx",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1415,
      "original_position" : 209,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 806400875,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749570801/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:13:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749570801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571227"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:14:06Z",
      "diff_hunk" : "@@ -0,0 +1,157 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <init/chainstate.h>\n+\n+#include <consensus/params.h> // for Consensus::Params\n+#include <node/blockstorage.h> // for CleanupBlockRevFiles, fHavePruned, fReindex\n+#include <validation.h> // for a lot of things\n+\n+std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n+                                                             ChainstateManager& chainman,\n+                                                             CTxMemPool* mempool,\n+                                                             bool fPruneMode,\n+                                                             const Consensus::Params& consensus_params,\n+                                                             bool fReindexChainState,\n+                                                             int64_t nBlockTreeDBCache,\n+                                                             int64_t nCoinDBCache,\n+                                                             int64_t nCoinCacheUsage,\n+                                                             unsigned int check_blocks,\n+                                                             unsigned int check_level,\n+                                                             bool block_tree_db_in_memory,\n+                                                             bool coins_db_in_memory,\n+                                                             std::function<int64_t()> get_unix_time_seconds,\n+                                                             std::optional<std::function<bool()>> shutdown_requested,\n+                                                             std::optional<std::function<void()>> coins_error_cb,\n+                                                             std::optional<std::function<void()>> verifying_blocks_cb) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571227",
      "id" : 749571227,
      "in_reply_to_id" : 743636334,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srYyb",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 27,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 806401457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571227/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:14:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:14:12Z",
      "diff_hunk" : "@@ -547,6 +549,8 @@ libbitcoin_common_a_SOURCES = \\\n   core_write.cpp \\\n   deploymentinfo.cpp \\\n   external_signer.cpp \\\n+  init/caches.cpp \\\n+  init/chainstate.cpp \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571294",
      "id" : 749571294,
      "in_reply_to_id" : 743657031,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srYze",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 553,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/Makefile.am",
      "position" : null,
      "pull_request_review_id" : 806401540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:14:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571632"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6, just copied over the existing comment which mostly describes error handling anyway",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:14:47Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX\n+            rv = ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED;\n+        }\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:\n+                strLoadError = _(\"Error loading block database\");\n                 break;\n-            }\n-\n-            if (!fReset) {\n-                LOCK(cs_main);\n-                auto chainstates{chainman.GetAll()};\n-                if (std::any_of(chainstates.begin(), chainstates.end(),\n-                                [](const CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(); })) {\n-                    strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n-                                             chainparams.GetConsensus().SegwitHeight);\n-                    break;\n-                }\n-            }\n-\n-            bool failed_verification = false;\n-\n-            try {\n-                LOCK(cs_main);\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n-                        if (fHavePruned && args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS) > MIN_BLOCKS_TO_KEEP) {\n-                            LogPrintf(\"Prune: pruned datadir may not have more than %d blocks; only checking available blocks\\n\",\n-                                MIN_BLOCKS_TO_KEEP);\n-                        }\n-\n-                        const CBlockIndex* tip = chainstate->m_chain.Tip();\n-                        RPCNotifyBlockChange(tip);\n-                        if (tip && tip->nTime > GetAdjustedTime() + 2 * 60 * 60) {\n-                            strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n-                                    \"This may be due to your computer's date and time being set incorrectly. \"\n-                                    \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n-                            failed_verification = true;\n-                            break;\n-                        }\n-\n-                        if (!CVerifyDB().VerifyDB(\n-                                *chainstate, chainparams, chainstate->CoinsDB(),\n-                                args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n-                                args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS))) {\n-                            strLoadError = _(\"Corrupted block database detected\");\n-                            failed_verification = true;\n-                            break;\n-                        }\n-                    }\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n+            case ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK:\n+                return false;  // bail immediately!",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571632",
      "id" : 749571632,
      "in_reply_to_id" : 743698625,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srY4w",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1424,
      "original_position" : 266,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 806402019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571632/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571722"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:14:54Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));\n-                }\n-\n-                // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-                // in the past, but is now trying to run unpruned.\n-                if (fHavePruned && !fPruneMode) {\n-                    strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n-                    break;\n-                }\n-\n-                // At this point blocktree args are consistent with what's on disk.\n-                // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n-                // (otherwise we use the one already on disk).\n-                // This is called again in ThreadImport after the reindex completes.\n-                if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n-                    strLoadError = _(\"Error initializing block database\");\n-                    break;\n-                }\n-\n-                // At this point we're either in reindex or we've loaded a useful\n-                // block tree into BlockIndex()!\n-\n-                bool failed_chainstate_init = false;\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    chainstate->InitCoinsDB(\n-                        /* cache_size_bytes */ nCoinDBCache,\n-                        /* in_memory */ false,\n-                        /* should_wipe */ fReset || fReindexChainState);\n-\n-                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n-                        uiInterface.ThreadSafeMessageBox(\n-                            _(\"Error reading from database, shutting down.\"),\n-                            \"\", CClientUIInterface::MSG_ERROR);\n-                    });\n-\n-                    // If necessary, upgrade from older database format.\n-                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->CoinsDB().Upgrade()) {\n-                        strLoadError = _(\"Error upgrading chainstate database\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                    if (!chainstate->ReplayBlocks()) {\n-                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n-                        failed_chainstate_init = true;\n-                        break;\n-                    }\n-\n-                    // The on-disk coinsdb is now in a good state, create the cache\n-                    chainstate->InitCoinsCache(nCoinCacheUsage);\n-                    assert(chainstate->CanFlushToDisk());\n-\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                        if (!chainstate->LoadChainTip()) {\n-                            strLoadError = _(\"Error initializing block database\");\n-                            failed_chainstate_init = true;\n-                            break; // out of the per-chainstate loop\n-                        }\n-                        assert(chainstate->m_chain.Tip() != nullptr);\n-                    }\n-                }\n-\n-                if (failed_chainstate_init) {\n-                    break; // out of the chainstate activation do-while\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n-                strLoadError = _(\"Error opening block database\");\n+        const int64_t load_block_index_start_time = GetTimeMillis();\n+        std::optional<ChainstateLoadingError> rv;\n+        try {\n+            rv = LoadChainstateSequence(fReset,\n+                                        chainman,\n+                                        Assert(node.mempool.get()),\n+                                        fPruneMode,\n+                                        chainparams.GetConsensus(),\n+                                        fReindexChainState,\n+                                        cache_sizes.block_tree_db_cache_size,\n+                                        cache_sizes.coin_db_cache_size,\n+                                        cache_sizes.coin_cache_usage_size,\n+                                        args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n+                                        args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n+                                        false,\n+                                        false,\n+                                        GetAdjustedTime,\n+                                        ShutdownRequested,\n+                                        []() {\n+                                            uiInterface.ThreadSafeMessageBox(\n+                                                _(\"Error reading from database, shutting down.\"),\n+                                                \"\", CClientUIInterface::MSG_ERROR);\n+                                        },\n+                                        []() {\n+                                            uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                                        });\n+        } catch (const std::exception& e) {\n+            LogPrintf(\"%s\\n\", e.what()); // XXX\n+            rv = ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED;\n+        }\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:\n+                strLoadError = _(\"Error loading block database\");\n                 break;\n-            }\n-\n-            if (!fReset) {\n-                LOCK(cs_main);\n-                auto chainstates{chainman.GetAll()};\n-                if (std::any_of(chainstates.begin(), chainstates.end(),\n-                                [](const CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(); })) {\n-                    strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n-                                             chainparams.GetConsensus().SegwitHeight);\n-                    break;\n-                }\n-            }\n-\n-            bool failed_verification = false;\n-\n-            try {\n-                LOCK(cs_main);\n-\n-                for (CChainState* chainstate : chainman.GetAll()) {\n-                    if (!is_coinsview_empty(chainstate)) {\n-                        uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n-                        if (fHavePruned && args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS) > MIN_BLOCKS_TO_KEEP) {\n-                            LogPrintf(\"Prune: pruned datadir may not have more than %d blocks; only checking available blocks\\n\",\n-                                MIN_BLOCKS_TO_KEEP);\n-                        }\n-\n-                        const CBlockIndex* tip = chainstate->m_chain.Tip();\n-                        RPCNotifyBlockChange(tip);\n-                        if (tip && tip->nTime > GetAdjustedTime() + 2 * 60 * 60) {\n-                            strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n-                                    \"This may be due to your computer's date and time being set incorrectly. \"\n-                                    \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n-                            failed_verification = true;\n-                            break;\n-                        }\n-\n-                        if (!CVerifyDB().VerifyDB(\n-                                *chainstate, chainparams, chainstate->CoinsDB(),\n-                                args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n-                                args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS))) {\n-                            strLoadError = _(\"Corrupted block database detected\");\n-                            failed_verification = true;\n-                            break;\n-                        }\n-                    }\n-                }\n-            } catch (const std::exception& e) {\n-                LogPrintf(\"%s\\n\", e.what());\n+            case ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK:\n+                return false;  // bail immediately!\n+            case ChainstateLoadingError::ERROR_PRUNED_NEEDS_REINDEX:\n+                strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOAD_GENESIS_BLOCK_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CHAINSTATE_UPGRADE_FAILED:\n+                strLoadError = _(\"Error upgrading chainstate database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_REPLAYBLOCKS_FAILED:\n+                strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOADCHAINTIP_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED:\n                 strLoadError = _(\"Error opening block database\");\n-                failed_verification = true;\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCKS_WITNESS_INSUFFICIENTLY_VALIDATED:\n+                strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n+                                         chainparams.GetConsensus().SegwitHeight);\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCK_FROM_FUTURE:\n+                strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n+                                 \"This may be due to your computer's date and time being set incorrectly. \"\n+                                 \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CORRUPTED_BLOCK_DB:\n+                strLoadError = _(\"Corrupted block database detected\");\n                 break;\n             }\n-\n-            if (!failed_verification) {\n-                fLoaded = true;\n-                LogPrintf(\" block index %15dms\\n\", GetTimeMillis() - load_block_index_start_time);\n-            }\n-        } while(false);\n+        } else if (!ShutdownRequested()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571722",
      "id" : 749571722,
      "in_reply_to_id" : 743703915,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srY6K",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1456,
      "original_position" : 305,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 806402136,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571722/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:14:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571802"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:15:02Z",
      "diff_hunk" : "@@ -1361,217 +1363,100 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     bool fReindexChainState = args.GetBoolArg(\"-reindex-chainstate\", false);\n \n     // cache size calculations\n-    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n-    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n-    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n-    nTotalCache -= nBlockTreeDBCache;\n-    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n-    nTotalCache -= nTxIndexCache;\n-    int64_t filter_index_cache = 0;\n-    if (!g_enabled_filter_types.empty()) {\n-        size_t n_indexes = g_enabled_filter_types.size();\n-        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n-        filter_index_cache = max_cache / n_indexes;\n-        nTotalCache -= filter_index_cache * n_indexes;\n-    }\n-    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n-    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n-    nTotalCache -= nCoinDBCache;\n-    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+    CacheSizes cache_sizes;\n+    CalculateCacheSizes(args, cache_sizes, g_enabled_filter_types.size());\n+\n     int64_t nMempoolSizeMax = args.GetIntArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     LogPrintf(\"Cache configuration:\\n\");\n-    LogPrintf(\"* Using %.1f MiB for block index database\\n\", nBlockTreeDBCache * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for block index database\\n\", cache_sizes.block_tree_db_cache_size * (1.0 / 1024 / 1024));\n     if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n-        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", nTxIndexCache * (1.0 / 1024 / 1024));\n+        LogPrintf(\"* Using %.1f MiB for transaction index database\\n\", cache_sizes.tx_index_cache_size * (1.0 / 1024 / 1024));\n     }\n     for (BlockFilterType filter_type : g_enabled_filter_types) {\n         LogPrintf(\"* Using %.1f MiB for %s block filter index database\\n\",\n-                  filter_index_cache * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n+                  cache_sizes.filter_index_cache_size * (1.0 / 1024 / 1024), BlockFilterTypeName(filter_type));\n     }\n-    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n-    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for chain state database\\n\", cache_sizes.coin_db_cache_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", cache_sizes.coin_cache_usage_size * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;\n-        auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n-            return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n-        };\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n-        do {\n-            const int64_t load_block_index_start_time = GetTimeMillis();\n-            try {\n-                LOCK(cs_main);\n-                chainman.InitializeChainstate(Assert(node.mempool.get()));\n-                chainman.m_total_coinstip_cache = nCoinCacheUsage;\n-                chainman.m_total_coinsdb_cache = nCoinDBCache;\n-\n-                UnloadBlockIndex(node.mempool.get(), chainman);\n-\n-                auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n-                // new CBlockTreeDB tries to delete the existing file, which\n-                // fails if it's still open from the previous loop. Close it first:\n-                pblocktree.reset();\n-                pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, false, fReset));\n-\n-                if (fReset) {\n-                    pblocktree->WriteReindexing(true);\n-                    //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n-                    if (fPruneMode)\n-                        CleanupBlockRevFiles();\n-                }\n-\n-                if (ShutdownRequested()) break;\n-\n-                // LoadBlockIndex will load fHavePruned if we've ever removed a\n-                // block file from disk.\n-                // Note that it also sets fReindex based on the disk flag!\n-                // From here on out fReindex and fReset mean something different!\n-                if (!chainman.LoadBlockIndex()) {\n-                    if (ShutdownRequested()) break;\n-                    strLoadError = _(\"Error loading block database\");\n-                    break;\n-                }\n-\n-                // If the loaded chain has a wrong genesis, bail out immediately\n-                // (we're likely using a testnet datadir, or the other way around).\n-                if (!chainman.BlockIndex().empty() &&\n-                        !chainman.m_blockman.LookupBlockIndex(chainparams.GetConsensus().hashGenesisBlock)) {\n-                    return InitError(_(\"Incorrect or no genesis block found. Wrong datadir for network?\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749571802",
      "id" : 749571802,
      "in_reply_to_id" : 743713370,
      "line" : 1444,
      "node_id" : "PRRC_kwDOABII584srY7a",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 1444,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 149,
      "pull_request_review_id" : 806402253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571802/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:15:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749571802",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749572057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572057"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:15:24Z",
      "diff_hunk" : "@@ -0,0 +1,22 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CACHES_H\n+#define BITCOIN_INIT_CACHES_H\n+\n+#include <cstddef> // for size_t\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+\n+struct CacheSizes {\n+    int64_t block_tree_db_cache_size;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749572057",
      "id" : 749572057,
      "in_reply_to_id" : 743768587,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srY_Z",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 14,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/init/caches.h",
      "position" : null,
      "pull_request_review_id" : 806402618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572057/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:15:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749572297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572297"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:15:46Z",
      "diff_hunk" : "@@ -0,0 +1,157 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <init/chainstate.h>\n+\n+#include <consensus/params.h> // for Consensus::Params\n+#include <node/blockstorage.h> // for CleanupBlockRevFiles, fHavePruned, fReindex\n+#include <validation.h> // for a lot of things\n+\n+std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n+                                                             ChainstateManager& chainman,\n+                                                             CTxMemPool* mempool,\n+                                                             bool fPruneMode,\n+                                                             const Consensus::Params& consensus_params,\n+                                                             bool fReindexChainState,\n+                                                             int64_t nBlockTreeDBCache,\n+                                                             int64_t nCoinDBCache,\n+                                                             int64_t nCoinCacheUsage,\n+                                                             unsigned int check_blocks,\n+                                                             unsigned int check_level,\n+                                                             bool block_tree_db_in_memory,\n+                                                             bool coins_db_in_memory,\n+                                                             std::function<int64_t()> get_unix_time_seconds,\n+                                                             std::optional<std::function<bool()>> shutdown_requested,\n+                                                             std::optional<std::function<void()>> coins_error_cb,\n+                                                             std::optional<std::function<void()>> verifying_blocks_cb) {\n+    auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n+    };\n+\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749572297",
      "id" : 749572297,
      "in_reply_to_id" : 743809355,
      "line" : 30,
      "node_id" : "PRRC_kwDOABII584srZDJ",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 30,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : 30,
      "pull_request_review_id" : 806402897,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572297/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:15:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749572455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572455"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:16:00Z",
      "diff_hunk" : "@@ -1415,8 +1412,46 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                          nCoinCacheUsage,\n                                          args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n                                          args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL));\n-        if (!rv) return false;\n-        if (fLoaded) {\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:\n+                strLoadError = _(\"Error loading block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK:\n+                return false;  // bail immediately!\n+            case ChainstateLoadingError::ERROR_PRUNED_NEEDS_REINDEX:\n+                strLoadError = _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOAD_GENESIS_BLOCK_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CHAINSTATE_UPGRADE_FAILED:\n+                strLoadError = _(\"Error upgrading chainstate database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_REPLAYBLOCKS_FAILED:\n+                strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\");\n+                break;\n+            case ChainstateLoadingError::ERROR_LOADCHAINTIP_FAILED:\n+                strLoadError = _(\"Error initializing block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_GENERIC_BLOCKDB_OPEN_FAILED:\n+                strLoadError = _(\"Error opening block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCKS_WITNESS_INSUFFICIENTLY_VALIDATED:\n+                strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n+                                         chainparams.GetConsensus().SegwitHeight);\n+                break;\n+            case ChainstateLoadingError::ERROR_BLOCK_FROM_FUTURE:\n+                strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n+                                 \"This may be due to your computer's date and time being set incorrectly. \"\n+                                 \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n+                break;\n+            case ChainstateLoadingError::ERROR_CORRUPTED_BLOCK_DB:\n+                strLoadError = _(\"Corrupted block database detected\");\n+                break;\n+            }\n+        } else if (!ShutdownRequested()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749572455",
      "id" : 749572455,
      "in_reply_to_id" : 743624127,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srZFn",
      "original_commit_id" : "cd29d334a38fdaf0bbbe810a9cbdeeffad394daa",
      "original_line" : 1453,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 806403096,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572455/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749572922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572922"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:16:44Z",
      "diff_hunk" : "@@ -1415,8 +1412,46 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                          nCoinCacheUsage,\n                                          args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n                                          args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL));\n-        if (!rv) return false;\n-        if (fLoaded) {\n+        if (rv.has_value()) {\n+            switch (rv.value()) {\n+            case ChainstateLoadingError::ERROR_LOADING_BLOCK_DB:\n+                strLoadError = _(\"Error loading block database\");\n+                break;\n+            case ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK:\n+                return false;  // bail immediately!",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749572922",
      "id" : 749572922,
      "in_reply_to_id" : 743628897,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srZM6",
      "original_commit_id" : "cd29d334a38fdaf0bbbe810a9cbdeeffad394daa",
      "original_line" : 1421,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 806403747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572922/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:16:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749572922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573114"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:17:04Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CHAINSTATE_H\n+#define BITCOIN_INIT_CHAINSTATE_H\n+\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+struct bilingual_str;\n+class CChainParams;\n+class CClientUIInterface;\n+class ChainstateManager;\n+struct NodeContext;\n+\n+bool LoadChainstateSequence(bool& fLoaded,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573114",
      "id" : 749573114,
      "in_reply_to_id" : 743901275,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srZP6",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/init/chainstate.h",
      "position" : null,
      "pull_request_review_id" : 806404031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573114/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:17:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573230"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:17:16Z",
      "diff_hunk" : "@@ -37,11 +36,11 @@ bool LoadChainstateSequence(bool& fLoaded,\n         const int64_t load_block_index_start_time = GetTimeMillis();\n         try {\n             LOCK(cs_main);\n-            chainman.InitializeChainstate(Assert(node.mempool.get()));\n+            chainman.InitializeChainstate(mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573230",
      "id" : 749573230,
      "in_reply_to_id" : 743933885,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srZRu",
      "original_commit_id" : "3ecaf812d4934d63124b640d2aeb008d4b742d89",
      "original_line" : 39,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 806404199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573230/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573320"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6, thanks Russ for the neat idea!",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:17:24Z",
      "diff_hunk" : "@@ -0,0 +1,206 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <init/chainstate.h>\n+\n+#include <chainparams.h> // for CChainParams\n+#include <rpc/blockchain.h> // for RPCNotifyBlockChange\n+#include <util/time.h> // for GetTimeMillis\n+#include <util/translation.h> // for bilingual_str\n+#include <node/blockstorage.h> // for CleanupBlockRevFiles, fHavePruned, fReindex\n+#include <node/context.h> // for NodeContext\n+#include <node/ui_interface.h> // for InitError, CClientUIInterface member access\n+#include <shutdown.h> // for ShutdownRequested\n+#include <timedata.h> // for GetAdjustedTime\n+#include <validation.h> // for a lot of things\n+\n+bool LoadChainstateSequence(bool& fLoaded,\n+                            bilingual_str& strLoadError,\n+                            bool fReset,\n+                            CClientUIInterface& uiInterface,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573320",
      "id" : 749573320,
      "in_reply_to_id" : 743923908,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srZTI",
      "original_commit_id" : "83ed7db27b4c4798666b77d83fc8e7c3eab8c621",
      "original_line" : 21,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 806404325,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573320/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:17:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573623"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:17:55Z",
      "diff_hunk" : "@@ -127,36 +115,25 @@ bool LoadChainstateSequence(bool& fLoaded,\n                 if (!is_coinsview_empty(chainstate)) {\n                     // LoadChainTip initializes the chain based on CoinsTip()'s best block\n                     if (!chainstate->LoadChainTip()) {\n-                        strLoadError = _(\"Error initializing block database\");\n-                        failed_chainstate_init = true;\n-                        break; // out of the per-chainstate loop\n+                        return ChainstateLoadingError::ERROR_LOADCHAINTIP_FAILED;\n                     }\n                     assert(chainstate->m_chain.Tip() != nullptr);\n                 }\n             }\n-\n-            if (failed_chainstate_init) {\n-                break; // out of the chainstate activation do-while\n-            }\n         } catch (const std::exception& e) {\n-            LogPrintf(\"%s\\n\", e.what());\n-            strLoadError = _(\"Error opening block database\");\n-            break;\n+            LogPrintf(\"%s\\n\", e.what()); // XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573623",
      "id" : 749573623,
      "in_reply_to_id" : 743954607,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srZX3",
      "original_commit_id" : "cd29d334a38fdaf0bbbe810a9cbdeeffad394daa",
      "original_line" : 124,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 806404759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573623/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:17:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573676"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not inaccurate, but I think we're adding a callback here and can't return immediately?",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:18:01Z",
      "diff_hunk" : "@@ -90,11 +90,9 @@ std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n                 /* in_memory */ false,\n                 /* should_wipe */ fReset || fReindexChainState);\n \n-            chainstate->CoinsErrorCatcher().AddReadErrCallback([&]() {\n-                uiInterface.ThreadSafeMessageBox(\n-                    _(\"Error reading from database, shutting down.\"),\n-                    \"\", CClientUIInterface::MSG_ERROR);\n-            });\n+            if (coins_error_cb.has_value()) {\n+                chainstate->CoinsErrorCatcher().AddReadErrCallback(coins_error_cb.value());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749573676",
      "id" : 749573676,
      "in_reply_to_id" : 743961236,
      "line" : 90,
      "node_id" : "PRRC_kwDOABII584srZYs",
      "original_commit_id" : "0e61af06834c9a9331e620343e60e9104e08331e",
      "original_line" : 90,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : 90,
      "pull_request_review_id" : 806404851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573676/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:19:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749574706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749574706"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:19:38Z",
      "diff_hunk" : "@@ -138,7 +136,9 @@ std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n \n         for (CChainState* chainstate : chainman.GetAll()) {\n             if (!is_coinsview_empty(chainstate)) {\n-                uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n+                if (verifying_blocks_cb.has_value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749574706",
      "id" : 749574706,
      "in_reply_to_id" : 743965561,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srZoy",
      "original_commit_id" : "0e61af06834c9a9331e620343e60e9104e08331e",
      "original_line" : 139,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 806406349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749574706/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:19:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749574706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749574770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749574770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:19:43Z",
      "diff_hunk" : "@@ -1400,25 +1400,31 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n         const int64_t load_block_index_start_time = GetTimeMillis();\n-        auto rv = LoadChainstateSequence(fReset,\n-                                         chainman,\n-                                         Assert(node.mempool.get()),\n-                                         fPruneMode,\n-                                         chainparams,\n-                                         fReindexChainState,\n-                                         nBlockTreeDBCache,\n-                                         nCoinDBCache,\n-                                         nCoinCacheUsage,\n-                                         args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n-                                         args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n-                                         []() {\n-                                             uiInterface.ThreadSafeMessageBox(\n-                                                 _(\"Error reading from database, shutting down.\"),\n-                                                 \"\", CClientUIInterface::MSG_ERROR);\n-                                         },\n-                                         []() {\n-                                             uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);\n-                                         });\n+        std::optional<ChainstateLoadingError> rv;\n+        try {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749574770",
      "id" : 749574770,
      "in_reply_to_id" : 743969616,
      "line" : 1389,
      "node_id" : "PRRC_kwDOABII584srZpy",
      "original_commit_id" : "38d88e2950afc99caca31388fd75f03c4d06bcc9",
      "original_line" : 1389,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 62,
      "pull_request_review_id" : 806406435,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749574770/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:19:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749574770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749575067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749575067"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed as of 6736e24a490d756e0e1e70b9e212775cf305ebe6",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:20:08Z",
      "diff_hunk" : "@@ -136,10 +136,6 @@ std::optional<ChainstateLoadingError> LoadChainstateSequence(bool fReset,\n                 if (verifying_blocks_cb.has_value()) {\n                     verifying_blocks_cb.value()();\n                 }\n-                if (fHavePruned && check_blocks > MIN_BLOCKS_TO_KEEP) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749575067",
      "id" : 749575067,
      "in_reply_to_id" : 743971845,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srZub",
      "original_commit_id" : "10564583429762ddfb6601d1f64ac663406bf8e2",
      "original_line" : 139,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 806406823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749575067/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:20:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749575067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749578481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749578481"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In my latest push (6736e24a490d756e0e1e70b9e212775cf305ebe6), I ended up having `CalculateCacheSizes` return a CacheSize, which is perhaps a bit more readable.",
      "commit_id" : "2c8f0e948d1ffe2fc729ce51fa42544616b51b5b",
      "created_at" : "2021-11-15T18:25:30Z",
      "diff_hunk" : "@@ -0,0 +1,22 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INIT_CACHES_H\n+#define BITCOIN_INIT_CACHES_H\n+\n+#include <cstddef> // for size_t\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+\n+struct CacheSizes {\n+    int64_t block_tree_db_cache_size;\n+    int64_t coin_db_cache_size;\n+    int64_t coin_cache_usage_size;\n+    int64_t tx_index_cache_size;\n+    int64_t filter_index_cache_size;\n+};\n+void CalculateCacheSizes(const ArgsManager& args, CacheSizes& cache_sizes, size_t n_indexes = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r749578481",
      "id" : 749578481,
      "in_reply_to_id" : 743767227,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srajx",
      "original_commit_id" : "7dd898c0df678859ca92773b6990e4e28a83ab24",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/init/caches.h",
      "position" : null,
      "pull_request_review_id" : 806411467,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749578481/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:25:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749578481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks all for the reviews! I addressed a subset of the concerns in my latest 2 pushes. One thing I'd like some help with:\r\n\r\nFor the RPC block change notification, I decided to go with jnewbery's method here:\r\n     \r\n> In _validation: Call NotifyBlockTip in CCS::LoadChainTip_, you're moving the RPC notification into `CChainstate::LoadChainTip()`. However, that function is also called by `ChainstateManager::ActivateSnapshot()`, so that's potentially a behavior change there. You also change the call from `RPCNotifyBlockChange()` to `uiInterface.NotifyBlockTip()`. However, `uiInterface.NotifyBlockTip` has multiple other \"slots\", e.g. `BlockNotifyGenesisWait`. Are we sure that isn't also a behavior change?\r\n> \r\n> I think that the `RPCNotifyBlockChange()` call can just be brought down to immediately before RPC leaves warmup:\r\n> \r\n> https://github.com/bitcoin/bitcoin/blob/77a2f5d30c5ecb764b8a7c098492e1f5cdec90f0/src/init.cpp#L1842\r\n> \r\n> There can't be any pending RPC calls waiting for the blockchange notification (since RPC is still in warmup) so I think the only purpose of this call is to set the `latestblock` fields.\r\n\r\nThis change is in this commit: dea5766ccaed1db77f8ca335d913ecf1ea4d41d1. This seems quite safe to me, and answers some of the questions ryanofsky posed in https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743895731. However, I'm not well-versed in RPC and how that interacts with our multiple chainstates. So I'd love some input on that.\r\n",
      "created_at" : "2021-11-15T18:45:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-969209205",
      "id" : 969209205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5845xPV1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969209205/reactions"
      },
      "updated_at" : "2021-11-15T18:45:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969209205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK https://github.com/bitcoin/bitcoin/pull/23280/commits/2c8f0e948d1ffe2fc729ce51fa42544616b51b5b\r\n\r\nI re-reviewed this from scratch (no easier way to do it) after rebasing on master to avoid the peers.dat v3/v4 startup error. Notable changes were `LoadChainstate`/`VerifyLoadedChainstate` split, import comment removal, and `cs::main` lock consolidation, which I think are all fine.\r\n\r\nEdit: forgot to mention the `RPCNotifyBlockChange()` change. While that looks fine to me, in general I would have preferred preserving `master`'s behavior in this changeset (by, say, parameterizing and injecting that method as we have done with others). But the change seems fine to me; just wish it wasn't blended in with this larger, ideally-non-behavioral change.\r\n\r\nRerunning my proposed functional tests (#23289) works for the most part, but there is a failure at the end when we intentionally create an init failure by removing block index *.ldb files (https://github.com/bitcoin/bitcoin/pull/23289/commits/d9803f7a0a33688f7429cf10384244f4770851ca#diff-1eb9875f38625ed8a456749c0a96ef72f7a5dc666c7c486f0b585d65680035a0R146). So I guess this change doesn't maintain strict output backwards compatibility, but personally I don't think that matters so much if the issue really is just what messages are shown. \r\n\r\n```\r\n node0 2021-11-18T00:06:03.158933Z [init] [dbwrapper.cpp:137] [CDBWrapper] Opening LevelDB in /tmp/bitcoin_func_test_y5h3tzr2/node0/regtest/blocks/index\r\n node0 2021-11-18T00:06:03.159032Z [init] [dbwrapper.cpp:253] [HandleError] Fatal LevelDB error: Corruption: 1 missing files; e.g.: /tmp/bitcoin_func_test_y5h3tzr2/node0/regtest/blocks/index/000035.ldb\r\n node0 2021-11-18T00:06:03.159039Z [init] [dbwrapper.cpp:254] [HandleError] You can use -debug=leveldb to get more complete diagnostic messages\r\n node0 2021-11-18T00:06:03.159101Z [init] [init.cpp:1420] [AppInitMain] Fatal LevelDB error: Corruption: 1 missing files; e.g.: /tmp/bitcoin_func_test_y5h3tzr2/node0/regtest/blocks/index/000035.ldb\r\n node0 2021-11-18T00:06:03.159121Z [init] [noui.cpp:56] [noui_InitMessage] init message: Verifying blocksâ¦\r\n test  2021-11-18T00:06:03.190000Z TestFramework.node0 (DEBUG): [node 0] bitcoind exited with status -11 during initialization\r\n test  2021-11-18T00:06:03.191000Z TestFramework (ERROR): Assertion failed\r\n                                   Traceback (most recent call last):\r\n                                     File \"/home/james/src/bitcoin/test/functional/test_framework/test_framework.py\", line 132, in main\r\n                                       self.run_test()\r\n                                     File \"/home/james/src/bitcoin/./test/functional/feature_init.py\", line 163, in run_test\r\n                                       node.assert_start_raises_init_error(\r\n                                     File \"/home/james/src/bitcoin/test/functional/test_framework/test_node.py\", line 523, in assert_start_raises_init_error\r\n                                       self._raise_assertion_error(\r\n                                     File \"/home/james/src/bitcoin/test/functional/test_framework/test_node.py\", line 167, in _raise_assertion_error\r\n                                       raise AssertionError(self._node_msg(msg))\r\n                                   AssertionError: [node 0] Expected message \"Error opening block database.\" does not partially match stderr:\r\n                                   \"\"\r\n ```\r\nFor what it's worth, the failure is due to this change: https://github.com/bitcoin/bitcoin/pull/23280/commits/18be9fec4967327158ed05f4c3e2531178ba3f86#diff-1767ee60ee6478aaca24348d0fdc0ccdfcf82c35b4543823d9ef39950b50be14L161\r\n\r\n### Process note\r\n\r\nI'd request that we scope future reviews to matters of correctness (vs. style) and leave the latter for follow-up in smaller PRs. ACK invalidation on this PR is painful, and as-written it's a very substantial improvement (e.g. unittest init reuse) over what we have now.",
      "created_at" : "2021-11-18T00:19:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-972365657",
      "id" : 972365657,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII58459R9Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972365657/reactions"
      },
      "updated_at" : "2021-11-18T00:32:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972365657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> reACK [2c8f0e9](https://github.com/bitcoin/bitcoin/commit/2c8f0e948d1ffe2fc729ce51fa42544616b51b5b)\r\n> \r\n> I re-reviewed this from scratch (no easier way to do it)\r\n\r\nBlah, but thanks for confirming the best approach :)\r\n\r\nThanks @jamesob for another thorough review. I'll re-review from scratch soon as well.",
      "created_at" : "2021-11-18T14:07:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-972897080",
      "id" : 972897080,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5845_Ts4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972897080/reactions"
      },
      "updated_at" : "2021-11-18T14:07:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972897080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The main thing I'm waiting for is for the new code to be moved out of `src/init/` which is for generic process initialization to `src/node/` which is for libbitcoin_server node code. Should be easy to do this with a plain git rebase, or in the worst case with `git filter-branch mv` (https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743858865) if git rename detection chokes.\r\n\r\nIt would also be nice if LoadChainstate documentation was moved out of commit messages into a code comment for the LoadChainstate declaration so the PR would be easier to understand and review (https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743133511, https://github.com/bitcoin/bitcoin/pull/23280#discussion_r743637480)",
      "created_at" : "2021-11-18T14:55:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-972940682",
      "id" : 972940682,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5845_eWK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972940682/reactions"
      },
      "updated_at" : "2021-11-18T14:57:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972940682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed 2c8f0e948d1ffe2fc729ce51fa42544616b51b5b -> fdc07a1d2916a85add9b11130a8c2cf6c02a09eb\r\n1. Moved some `LoadChainstate` documentation from commit messages to actual code as suggested by ryanofsky (actually a great idea and made things clearer)\r\n2. Moved the newly added files to `node/` instead of `init/`, fixed up alphabetical ordering where appropriate\r\n3. Added some comments about the nuance of the SHUTDOWN_REQUESTED/PROBED enum return value\r\n\r\nw/re point number 3, although I've implemented the reviewers' suggestion (returning an enum variant), I think this solution may actually be a bit more complicated than my original one. This is mostly because we can only guarantee that we detect shutdown requests up to our last call to `ShutdownRequested`, and there may be indirect shutdown requests after that that we won't catch. So in order to maintain behavior / be correct we still need to check `ShutdownRequested()` after we exit the sequence, and the enum return value is rendered somewhat useless: https://github.com/bitcoin/bitcoin/pull/23280/commits/64195bf2e4b8c6f74d0df7ba85a1ee0f0b6c4e5f#diff-b1e19192258d83199d8adaa5ac31f067af98f63554bfdd679bd8e8073815e69dR1450-R1451",
      "created_at" : "2021-11-29T21:45:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-982052626",
      "id" : 982052626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846iO8S",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982052626/reactions"
      },
      "updated_at" : "2021-11-29T21:45:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982052626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for updates! Will look more, but I don't think the fact that code might need to call `ShutdownRequested()` later makes having distinct `SUCCESS` / `FAILURE` / `INTERRUPTED` return codes useless. If calling code wants to treat `SUCCESS` and `INTERRUPTED` values the same way (by not printing errors, and going on to check whether a shutdown is currently requested), that's great, but it doesn't suggest to me that `SUCCESS` and `INTERRUPTED` should be merged together. `SUCCESS` and `INTERRUPTED` do actually mean different things, and it also would be reasonable for calling code to treat them differently, even if it isn't now, for example by logging the interruption when `INTERRUPTED` is returned, or by returning `INTERRUPTED` to the caller of the caller, and moving Shutdown handling to a higher level.",
      "created_at" : "2021-11-29T22:26:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-982080608",
      "id" : 982080608,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846iVxg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982080608/reactions"
      },
      "updated_at" : "2021-11-29T22:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982080608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK fdc07a1d2916a85add9b11130a8c2cf6c02a09eb ([`jamesob/ackr/23280.5.dongcarl.init_coalesce_chainstate`](https://github.com/jamesob/bitcoin/tree/ackr/23280.5.dongcarl.init_coalesce_chainstate))\r\n\r\nExamined interdiff, built, merged & tested recent master and my init functional tests. Changes are as Carl describes.\r\n\r\n<details><summary>Show signature data</summary>\r\n<p>\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nACK fdc07a1d2916a85add9b11130a8c2cf6c02a09eb ([`jamesob/ackr/23280.5.dongcarl.init_coalesce_chainstate`](https://github.com/jamesob/bitcoin/tree/ackr/23280.5.dongcarl.init_coalesce_chainstate))\r\n\r\nExamined interdiff, built, merged & tested recent master and my init functional tests. Changes are as Carl describes.\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQIzBAEBCgAdFiEEGNRVI1NPYuZCSIrGepNdrbLETwUFAmGmduoACgkQepNdrbLE\r\nTwUqWRAAmizHsXiSXi+daWs5gX85JJUb/uetyo2r2qoNFsJh2YDCkrYj3VS/EM5D\r\nJzyscNQKRWSKEhGH7dCP8B1SwK8/7xpcTxw2orOw5Zy4QrbQoZzUy3zKZiV7mrwq\r\neiWeUlHq2qdruayNIwuWK0JsCDLkPc24jTmsi9Jr+OtvhHDVqfVWz5hRMzP590JX\r\nlDpi92cp7EauuLvrort41uir71WXt7id/n1lusqMRwkvjYDhgAFNG3PS8ooO+kNy\r\nbJRObP55GOizEWoIQ08mIrkbt0wq2ALiQEUFmTvg0ZCFFfuMk4brRrQFoYQwyqc0\r\nRfQrIfaTblLOefRycdDY+wbmNhEhS0ATmeBFrbikzzEcm5Zd9vaV4IaoD5cBsy5e\r\niKA8mQPX5IW1QC0hHxIEm7bJmJ+5dpwJbqxjm9KzVekw/nR/OjHpPIWj5rGG6xFV\r\nz7Iub6XSjY6w9h/3WSf3hEyTeCnq3kZ5aCUe40tOps1h4jXho70Qtu24l3zA9oza\r\n95dozmg6G2W6JyGl7nPGLoZE27++z2nkBkScs6zOQL8f16uCvXT5FIIM7xt9/uKg\r\nvoCeCFE4b3dfSSC4Cce1fx4bt4oGIFfhz6V4nlHcXJdRxaaAs+wcepD8uIR+gdZZ\r\n6Q0oWUrYIQHAi/+ZUqDax2YvNcuZJ6S9fewuS2tQIt+BZG88pMc=\r\n=N1CN\r\n-----END PGP SIGNATURE-----\r\n\r\n```\r\n\r\n</p></details>\r\n\r\n<details><summary>Show platform data</summary>\r\n<p>\r\n\r\n```\r\nTested on Linux-5.10.0-9-amd64-x86_64-with-glibc2.28\r\n\r\nConfigured with ./configure LDFLAGS=-L/home/james/src/bitcoin/db4/lib/ CPPFLAGS=-I/home/james/src/bitcoin/db4/include/ CXXFLAGS=-fPIE -pipe -O2 -g -Wthread-safety-analysis -Wall -Werror=sign-compare -Wsign-compare -Werror=thread-safety-analysis --enable-wallet --enable-debug --with-daemon --enable-natpmp-default CXX=/usr/bin/clang++ CC=/usr/bin/clang PYTHONPATH= --disable-shared --with-pic --enable-benchmark=no --enable-module-recovery --enable-module-schnorrsig --enable-experimental --disable-openssl-tests --disable-shared --with-pic --enable-benchmark=no --enable-module-recovery --enable-module-schnorrsig --enable-experimental --no-create --no-recursion\r\n\r\nCompiled with /usr/bin/ccache /usr/bin/clang++ -std=c++17 -mavx -mavx2 -fPIE -pipe -O2 -g -Wthread-safety-analysis -Wall -Werror=sign-compare -Wsign-compare -Werror=thread-safety-analysis -O0 -g3 -ftrapv -fdebug-prefix-map=$(abs_top_srcdir)=.  -Wstack-protector -fstack-protector-all -fcf-protection=full -fstack-clash-protection -msse4 -msha -msse4.1 -msse4.2  i\r\n\r\nCompiler version: Debian clang version 13.0.1-++20211110052940+162f3f18c945-1~exp1~20211110053502.25\r\n```\r\n\r\n</p></details>\r\n\r\n",
      "created_at" : "2021-11-30T19:10:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-982935352",
      "id" : 982935352,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846lmc4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982935352/reactions"
      },
      "updated_at" : "2021-11-30T19:10:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982935352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "`C:\\Users\\ContainerAdministrator\\AppData\\Local\\Temp\\cirrus-ci-build\\src\\node\\caches.cpp(32,9): error C7555: use of designated initializers requires at least '/std:c++20' [C:\\Users\\ContainerAdministrator\\AppData\\Local\\Temp\\cirrus-ci-build\\build_msvc\\libbitcoin_server\\libbitcoin_server.vcxproj]`",
      "created_at" : "2021-11-30T19:24:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-982947060",
      "id" : 982947060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846lpT0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982947060/reactions"
      },
      "updated_at" : "2021-11-30T19:24:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982947060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r759652338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759652338"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"node/chainstate: Decouple from GetTimeMillis\" (165b30b649923da4ed19749a399c4a4589da326b)\r\n\r\nCommit description seems out of date. This commit is not passing a std::function to replace GetTimeMillis, it is just moving the GetTimeMillis call ",
      "commit_id" : "903d4599eea106e430149e69676e12f0b82a45c3",
      "created_at" : "2021-11-30T20:54:49Z",
      "diff_hunk" : "@@ -1400,6 +1400,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n \n+        const int64_t load_block_index_start_time = GetTimeMillis();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r759652338",
      "id" : 759652338,
      "line" : 1387,
      "node_id" : "PRRC_kwDOABII584tR1_y",
      "original_commit_id" : "165b30b649923da4ed19749a399c4a4589da326b",
      "original_line" : 1403,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 60,
      "pull_request_review_id" : 819546004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759652338/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-30T22:57:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759652338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Did not realize designated initializers is a GNU extension, my bad.",
      "created_at" : "2021-11-30T21:50:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-983051896",
      "id" : 983051896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846mC54",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983051896/reactions"
      },
      "updated_at" : "2021-11-30T21:50:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983051896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r759714243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759714243"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Split off VerifyLoadedChainstate\" (019da3dc8493054b456222ef23761dd95130b6a7)\r\n\r\nSeems like this only be called if `rv` is `nullopt`, and it should be skipped if `LoadChainstate` fails or is interrupted for shutdown. Otherwise this is running verification code that did not run previously.\r\n\r\nWould be better to preserve behavior I think. Either way it would also be good to say in commit description whether behavior is changing or not.",
      "commit_id" : "903d4599eea106e430149e69676e12f0b82a45c3",
      "created_at" : "2021-11-30T22:36:22Z",
      "diff_hunk" : "@@ -1408,9 +1408,14 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                  fReindexChainState,\n                                  nBlockTreeDBCache,\n                                  nCoinDBCache,\n-                                 nCoinCacheUsage,\n-                                 args.GetIntArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS),\n-                                 args.GetIntArg(\"-checklevel\", DEFAULT_CHECKLEVEL));\n+                                 nCoinCacheUsage);\n+        auto rv2 = VerifyLoadedChainstate(chainman,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r759714243",
      "id" : 759714243,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tSFHD",
      "original_commit_id" : "019da3dc8493054b456222ef23761dd95130b6a7",
      "original_line" : 1412,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 819546004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759714243/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-30T22:57:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759714243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r759717906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759717906"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"node/chainstate: Decouple from concept of uiInterface\" (efe9bd287656925a3bda50a809edeabe9824e37a)\r\n\r\nSeems like there is a minor change in behavior with the verifying blocks message being shown even if is_coinsview_empty is true. This seems ok, but would be good to mention whether behavior change is intentional in commit message.",
      "commit_id" : "903d4599eea106e430149e69676e12f0b82a45c3",
      "created_at" : "2021-11-30T22:43:07Z",
      "diff_hunk" : "@@ -1408,7 +1408,14 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                  fReindexChainState,\n                                  nBlockTreeDBCache,\n                                  nCoinDBCache,\n-                                 nCoinCacheUsage);\n+                                 nCoinCacheUsage,\n+                                 []() {\n+                                     uiInterface.ThreadSafeMessageBox(\n+                                         _(\"Error reading from database, shutting down.\"),\n+                                         \"\", CClientUIInterface::MSG_ERROR);\n+                                 });\n+\n+        uiInterface.InitMessage(_(\"Verifying blocksâ¦\").translated);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r759717906",
      "id" : 759717906,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tSGAS",
      "original_commit_id" : "efe9bd287656925a3bda50a809edeabe9824e37a",
      "original_line" : 1418,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 819546004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759717906/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-30T22:57:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759717906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-12-01T11:03:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-983527556",
      "id" : 983527556,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846n3CE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983527556/reactions"
      },
      "updated_at" : "2021-12-01T11:03:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983527556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nï¿½[0;36m test  2021-11-30T22:50:44.631000Z TestFramework.node0 (DEBUG): [node 0] bitcoind exited with status -11 during initialization ï¿½[0m\r\nï¿½[0;36m test  2021-11-30T22:50:44.632000Z TestFramework (ERROR): Assertion failed ï¿½[0m\r\nï¿½[0;36m                                   Traceback (most recent call last):ï¿½[0m\r\nï¿½[0;36m                                     File \"/private/var/folders/tn/f_9sf1xx5t14qm_6f83q3b840000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin19/test/functional/test_framework/test_framework.py\", line 132, in mainï¿½[0m\r\nï¿½[0;36m                                       self.run_test()ï¿½[0m\r\nï¿½[0;36m                                     File \"/private/var/folders/tn/f_9sf1xx5t14qm_6f83q3b840000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin19/test/functional/feature_init.py\", line 168, in run_testï¿½[0m\r\nï¿½[0;36m                                       node.assert_start_raises_init_error(ï¿½[0m\r\nï¿½[0;36m                                     File \"/private/var/folders/tn/f_9sf1xx5t14qm_6f83q3b840000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin19/test/functional/test_framework/test_node.py\", line 523, in assert_start_raises_init_errorï¿½[0m\r\nï¿½[0;36m                                       self._raise_assertion_error(ï¿½[0m\r\nï¿½[0;36m                                     File \"/private/var/folders/tn/f_9sf1xx5t14qm_6f83q3b840000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin19/test/functional/test_framework/test_node.py\", line 167, in _raise_assertion_errorï¿½[0m\r\nï¿½[0;36m                                       raise AssertionError(self._node_msg(msg))ï¿½[0m\r\nï¿½[0;36m                                   AssertionError: [node 0] Expected message \"Error opening block database.\" does not partially match stderr:ï¿½[0m\r\nï¿½[0;36m                                   \"\"ï¿½[0m",
      "created_at" : "2021-12-01T11:22:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-983543901",
      "id" : 983543901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846n7Bd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983543901/reactions"
      },
      "updated_at" : "2021-12-01T11:22:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983543901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> ```\r\n> ï¿½[0;36m test  2021-11-30T22:50:44.631000Z TestFramework.node0 (DEBUG): [node 0] bitcoind exited with status -11 during initialization ï¿½[0m\r\n> ï¿½[0;36m test  2021-11-30T22:50:44.632000Z TestFramework (ERROR): Assertion failed ï¿½[0m\r\n> ï¿½[0;36m                                   Traceback (most recent call last):ï¿½[0m\r\n> ï¿½[0;36m                                     File \"/private/var/folders/tn/f_9sf1xx5t14qm_6f83q3b840000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin19/test/functional/test_framework/test_framework.py\", line 132, in mainï¿½[0m\r\n> ï¿½[0;36m                                       self.run_test()ï¿½[0m\r\n> ï¿½[0;36m                                     File \"/private/var/folders/tn/f_9sf1xx5t14qm_6f83q3b840000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin19/test/functional/feature_init.py\", line 168, in run_testï¿½[0m\r\n> ï¿½[0;36m                                       node.assert_start_raises_init_error(ï¿½[0m\r\n> ï¿½[0;36m                                     File \"/private/var/folders/tn/f_9sf1xx5t14qm_6f83q3b840000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin19/test/functional/test_framework/test_node.py\", line 523, in assert_start_raises_init_errorï¿½[0m\r\n> ï¿½[0;36m                                       self._raise_assertion_error(ï¿½[0m\r\n> ï¿½[0;36m                                     File \"/private/var/folders/tn/f_9sf1xx5t14qm_6f83q3b840000gn/T/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-apple-darwin19/test/functional/test_framework/test_node.py\", line 167, in _raise_assertion_errorï¿½[0m\r\n> ï¿½[0;36m                                       raise AssertionError(self._node_msg(msg))ï¿½[0m\r\n> ï¿½[0;36m                                   AssertionError: [node 0] Expected message \"Error opening block database.\" does not partially match stderr:ï¿½[0m\r\n> ï¿½[0;36m                                   \"\"ï¿½[0m\r\n> ```\r\n\r\nAh yeah, see my comment above (https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-972365657). This should be a simple matter of tacking on a commit to this branch that updates output expectations in the functional test.",
      "created_at" : "2021-12-01T15:38:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-983763767",
      "id" : 983763767,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846ows3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983763767/reactions"
      },
      "updated_at" : "2021-12-01T15:38:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983763767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760525288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760525288"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init: Delay RPC block notif until warmup finished\" (9217003327b6849d67dcd5c427e232157854997d)\r\n\r\nWould be good to have a code comment saying why this is needed, since no block is changing here.\r\n\r\n(Previous commit message b229024932ebd4775070149ff0f27d0fd329bf0a had some information, but I'm not sure how much of it is relevant)",
      "commit_id" : "8301c696d0a0be921ce01b6e9f74f7ff6e8c0f2f",
      "created_at" : "2021-12-01T19:55:37Z",
      "diff_hunk" : "@@ -1759,6 +1759,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n \n     // ********************************************************* Step 13: finished\n \n+    RPCNotifyBlockChange(chainman.ActiveTip());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760525288",
      "id" : 760525288,
      "line" : 1769,
      "node_id" : "PRRC_kwDOABII584tVLHo",
      "original_commit_id" : "ca13555758e6d868d3cfa5b55e679fca74381b03",
      "original_line" : 1769,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 339,
      "pull_request_review_id" : 820742565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760525288/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T21:29:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760525288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760560829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760560829"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"node/caches: Extract cache calculation logic\" (79ae725d8062761a6650862fd49b7de96ce7616e)\r\n\r\nIt's good that this is a moveonly commit, but it would be nice to avoid the intermediate variables in a followup\r\n\r\n```c++\r\nCacheSizes CalculateCacheSizes(const ArgsManager& args, size_t n_indexes)\r\n{\r\n    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\r\n    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\r\n    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\r\n    CacheSizes sizes;\r\n    sizes.block_tree_db = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\r\n    nTotalCache -= sizes.block_tree_db;\r\n    sizes.tx_index = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\r\n    nTotalCache -= sizes.tx_index;\r\n    sizes.filter_index = 0;\r\n    if (n_indexes > 0) {\r\n        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\r\n        sizes.filter_index = max_cache / n_indexes;\r\n        nTotalCache -= sizes.filter_index * n_indexes;\r\n    }\r\n    sizes.coins_db = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\r\n    sizes.coins_db = std::min(sizes.coins_db, nMaxCoinsDBCache << 20); // cap total coins db cache\r\n    nTotalCache -= sizes.coins_db;\r\n    sizes.coins = nTotalCache; // the rest goes to in-memory cache\r\n    return sizes;\r\n}\r\n```",
      "commit_id" : "8301c696d0a0be921ce01b6e9f74f7ff6e8c0f2f",
      "created_at" : "2021-12-01T20:51:13Z",
      "diff_hunk" : "@@ -0,0 +1,38 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/caches.h>\n+\n+#include <txdb.h>\n+#include <util/system.h>\n+#include <validation.h>\n+\n+CacheSizes CalculateCacheSizes(const ArgsManager& args, size_t n_indexes)\n+{\n+    int64_t nTotalCache = (args.GetIntArg(\"-dbcache\", nDefaultDbCache) << 20);\n+    nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n+    nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n+    int64_t nBlockTreeDBCache = std::min(nTotalCache / 8, nMaxBlockDBCache << 20);\n+    nTotalCache -= nBlockTreeDBCache;\n+    int64_t nTxIndexCache = std::min(nTotalCache / 8, args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);\n+    nTotalCache -= nTxIndexCache;\n+    int64_t filter_index_cache = 0;\n+    if (n_indexes > 0) {\n+        int64_t max_cache = std::min(nTotalCache / 8, max_filter_index_cache << 20);\n+        filter_index_cache = max_cache / n_indexes;\n+        nTotalCache -= filter_index_cache * n_indexes;\n+    }\n+    int64_t nCoinDBCache = std::min(nTotalCache / 2, (nTotalCache / 4) + (1 << 23)); // use 25%-50% of the remainder for disk cache\n+    nCoinDBCache = std::min(nCoinDBCache, nMaxCoinsDBCache << 20); // cap total coins db cache\n+    nTotalCache -= nCoinDBCache;\n+    int64_t nCoinCacheUsage = nTotalCache; // the rest goes to in-memory cache\n+\n+    return {\n+        nBlockTreeDBCache,\n+        nCoinDBCache,\n+        nCoinCacheUsage,\n+        nTxIndexCache,\n+        filter_index_cache,\n+    };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760560829",
      "id" : 760560829,
      "line" : 37,
      "node_id" : "PRRC_kwDOABII584tVTy9",
      "original_commit_id" : "79ae725d8062761a6650862fd49b7de96ce7616e",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : 31,
      "path" : "src/node/caches.cpp",
      "position" : 37,
      "pull_request_review_id" : 820742565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760560829/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 31,
      "start_side" : "RIGHT",
      "updated_at" : "2021-12-01T21:29:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760560829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760574720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760574720"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test/setup: Unify m_args and gArgs\" (7ede150299ea46d38a0797910c95028e7e948e0d)\r\n\r\nI think it would be better to drop this change, and let `BasicTestingSetup::m_args` keep being a variable instead of a `gArgs` reference. The reason the `BasicTestingSetup::m_args` member exists is to provide a way for tests to stop using a shared `gArgs` instance and let each test have it's own standalone ArgsManager. This way tests can do `m_args.ForceSetArg` and other operations without affecting global state and potentially breaking each other.\r\n\r\nThe other change below which stops using `gArgs` would be good to keep if it still works:\r\n\r\n```diff\r\n-    m_node.args = &gArgs;\r\n+    m_node.args = &m_args;\r\n```\r\n\r\nIf it doesn't work now, it should work later when @kiminuo gets around to removing more `gArgs` uses in other code https://github.com/bitcoin/bitcoin/pull/21244#discussion_r610080299",
      "commit_id" : "8301c696d0a0be921ce01b6e9f74f7ff6e8c0f2f",
      "created_at" : "2021-12-01T21:13:31Z",
      "diff_hunk" : "@@ -77,9 +77,9 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n     : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n-      m_args{}\n+      m_args{gArgs}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760574720",
      "id" : 760574720,
      "line" : 80,
      "node_id" : "PRRC_kwDOABII584tVXMA",
      "original_commit_id" : "7ede150299ea46d38a0797910c95028e7e948e0d",
      "original_line" : 80,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 22,
      "pull_request_review_id" : 820742565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760574720/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T21:29:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760574720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760598661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760598661"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"node/chainstate: Decouple from ShutdownRequested\" (258ce97cf72043ffa69d2b77a4438df723c734a6)\r\n\r\nFunction objects can be null so here and other places should replace `optional<function<X>>` with `function<X>` so there is one null value instead of two",
      "commit_id" : "8301c696d0a0be921ce01b6e9f74f7ff6e8c0f2f",
      "created_at" : "2021-12-01T21:52:23Z",
      "diff_hunk" : "@@ -18,6 +17,7 @@ std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n                                                      int64_t nBlockTreeDBCache,\n                                                      int64_t nCoinDBCache,\n                                                      int64_t nCoinCacheUsage,\n+                                                     std::optional<std::function<bool()>> shutdown_requested,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760598661",
      "id" : 760598661,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII584tVdCF",
      "original_commit_id" : "258ce97cf72043ffa69d2b77a4438df723c734a6",
      "original_line" : 20,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 22,
      "pull_request_review_id" : 820842452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760598661/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T21:52:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760598661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Following up on the return codes discussion https://github.com/bitcoin/bitcoin/pull/23280#discussion_r748465779, I still think it would be good to reduce the number of status codes the caller needs to handle, and number of function parameters. Experimenting a little, I pushed a change (compiles, but untested) to do this here: b7c7f64dc86f0fcdf07cb1e765f7cccc3a3c8897 (+129/-210). It could be a followup, or feel free to adopt parts of this if they seem useful.\r\n\r\n\r\n\r\n",
      "created_at" : "2021-12-01T23:24:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-984149564",
      "id" : 984149564,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846qO48",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/984149564/reactions"
      },
      "updated_at" : "2021-12-01T23:24:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/984149564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-12-02T15:33:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-984738567",
      "id" : 984738567,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846sesH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/984738567/reactions"
      },
      "updated_at" : "2021-12-02T15:33:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/984738567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762078294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762078294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit for follow-up: we can probably just eliminate these braces/indent, eh?",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-03T16:27:50Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/chainstate.h>\n+\n+#include <consensus/params.h>\n+#include <node/blockstorage.h>\n+#include <validation.h>\n+\n+std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n+                                                     ChainstateManager& chainman,\n+                                                     CTxMemPool* mempool,\n+                                                     bool fPruneMode,\n+                                                     const Consensus::Params& consensus_params,\n+                                                     bool fReindexChainState,\n+                                                     int64_t nBlockTreeDBCache,\n+                                                     int64_t nCoinDBCache,\n+                                                     int64_t nCoinCacheUsage,\n+                                                     bool block_tree_db_in_memory,\n+                                                     bool coins_db_in_memory,\n+                                                     std::optional<std::function<bool()>> shutdown_requested,\n+                                                     std::optional<std::function<void()>> coins_error_cb)\n+{\n+    auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n+    };\n+\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762078294",
      "id" : 762078294,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tbGRW",
      "original_commit_id" : "8301c696d0a0be921ce01b6e9f74f7ff6e8c0f2f",
      "original_line" : 29,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 822853111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762078294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-03T17:02:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762078294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762079030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762079030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit for follow-up: same here.",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-03T16:28:49Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/chainstate.h>\n+\n+#include <consensus/params.h>\n+#include <node/blockstorage.h>\n+#include <validation.h>\n+\n+std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n+                                                     ChainstateManager& chainman,\n+                                                     CTxMemPool* mempool,\n+                                                     bool fPruneMode,\n+                                                     const Consensus::Params& consensus_params,\n+                                                     bool fReindexChainState,\n+                                                     int64_t nBlockTreeDBCache,\n+                                                     int64_t nCoinDBCache,\n+                                                     int64_t nCoinCacheUsage,\n+                                                     bool block_tree_db_in_memory,\n+                                                     bool coins_db_in_memory,\n+                                                     std::optional<std::function<bool()>> shutdown_requested,\n+                                                     std::optional<std::function<void()>> coins_error_cb)\n+{\n+    auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n+    };\n+\n+    {\n+        LOCK(cs_main);\n+        chainman.InitializeChainstate(mempool);\n+        chainman.m_total_coinstip_cache = nCoinCacheUsage;\n+        chainman.m_total_coinsdb_cache = nCoinDBCache;\n+\n+        UnloadBlockIndex(mempool, chainman);\n+\n+        auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n+        // new CBlockTreeDB tries to delete the existing file, which\n+        // fails if it's still open from the previous loop. Close it first:\n+        pblocktree.reset();\n+        pblocktree.reset(new CBlockTreeDB(nBlockTreeDBCache, block_tree_db_in_memory, fReset));\n+\n+        if (fReset) {\n+            pblocktree->WriteReindexing(true);\n+            //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n+            if (fPruneMode)\n+                CleanupBlockRevFiles();\n+        }\n+\n+        if (shutdown_requested && (*shutdown_requested)()) return ChainstateLoadingError::SHUTDOWN_PROBED;\n+\n+        // LoadBlockIndex will load fHavePruned if we've ever removed a\n+        // block file from disk.\n+        // Note that it also sets fReindex based on the disk flag!\n+        // From here on out fReindex and fReset mean something different!\n+        if (!chainman.LoadBlockIndex()) {\n+            if (shutdown_requested && (*shutdown_requested)()) return ChainstateLoadingError::SHUTDOWN_PROBED;\n+            return ChainstateLoadingError::ERROR_LOADING_BLOCK_DB;\n+        }\n+\n+        if (!chainman.BlockIndex().empty() &&\n+                !chainman.m_blockman.LookupBlockIndex(consensus_params.hashGenesisBlock)) {\n+            return ChainstateLoadingError::ERROR_BAD_GENESIS_BLOCK;\n+        }\n+\n+        // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n+        // in the past, but is now trying to run unpruned.\n+        if (fHavePruned && !fPruneMode) {\n+            return ChainstateLoadingError::ERROR_PRUNED_NEEDS_REINDEX;\n+        }\n+\n+        // At this point blocktree args are consistent with what's on disk.\n+        // If we're not mid-reindex (based on disk + args), add a genesis block on disk\n+        // (otherwise we use the one already on disk).\n+        // This is called again in ThreadImport after the reindex completes.\n+        if (!fReindex && !chainman.ActiveChainstate().LoadGenesisBlock()) {\n+            return ChainstateLoadingError::ERROR_LOAD_GENESIS_BLOCK_FAILED;\n+        }\n+\n+        // At this point we're either in reindex or we've loaded a useful\n+        // block tree into BlockIndex()!\n+\n+        for (CChainState* chainstate : chainman.GetAll()) {\n+            chainstate->InitCoinsDB(\n+                /* cache_size_bytes */ nCoinDBCache,\n+                /* in_memory */ coins_db_in_memory,\n+                /* should_wipe */ fReset || fReindexChainState);\n+\n+            if (coins_error_cb.has_value()) {\n+                chainstate->CoinsErrorCatcher().AddReadErrCallback(coins_error_cb.value());\n+            }\n+\n+            // If necessary, upgrade from older database format.\n+            // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n+            if (!chainstate->CoinsDB().Upgrade()) {\n+                return ChainstateLoadingError::ERROR_CHAINSTATE_UPGRADE_FAILED;\n+            }\n+\n+            // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n+            if (!chainstate->ReplayBlocks()) {\n+                return ChainstateLoadingError::ERROR_REPLAYBLOCKS_FAILED;\n+            }\n+\n+            // The on-disk coinsdb is now in a good state, create the cache\n+            chainstate->InitCoinsCache(nCoinCacheUsage);\n+            assert(chainstate->CanFlushToDisk());\n+\n+            if (!is_coinsview_empty(chainstate)) {\n+                // LoadChainTip initializes the chain based on CoinsTip()'s best block\n+                if (!chainstate->LoadChainTip()) {\n+                    return ChainstateLoadingError::ERROR_LOADCHAINTIP_FAILED;\n+                }\n+                assert(chainstate->m_chain.Tip() != nullptr);\n+            }\n+        }\n+\n+        if (!fReset) {\n+            auto chainstates{chainman.GetAll()};\n+            if (std::any_of(chainstates.begin(), chainstates.end(),\n+                            [](const CChainState* cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->NeedsRedownload(); })) {\n+                return ChainstateLoadingError::ERROR_BLOCKS_WITNESS_INSUFFICIENTLY_VALIDATED;\n+            }\n+        }\n+    }\n+\n+    return std::nullopt;\n+}\n+\n+std::optional<ChainstateLoadVerifyError> VerifyLoadedChainstate(ChainstateManager& chainman,\n+                                                                bool fReset,\n+                                                                bool fReindexChainState,\n+                                                                const Consensus::Params& consensus_params,\n+                                                                unsigned int check_blocks,\n+                                                                unsigned int check_level,\n+                                                                std::function<int64_t()> get_unix_time_seconds)\n+{\n+    auto is_coinsview_empty = [&](CChainState* chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        return fReset || fReindexChainState || chainstate->CoinsTip().GetBestBlock().IsNull();\n+    };\n+\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762079030",
      "id" : 762079030,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tbGc2",
      "original_commit_id" : "8301c696d0a0be921ce01b6e9f74f7ff6e8c0f2f",
      "original_line" : 141,
      "original_position" : 141,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 822853111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762079030/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-03T17:02:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762079030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762081278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762081278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree that we can (should?) leave this out provided it doesn't make things too difficult in subsequent commits. I do like the idea of shedding use of `gArgs` from within this test class, but maybe that should be handled separately if there are non-obvious behavior changes as Russ is mentioning.",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-03T16:31:45Z",
      "diff_hunk" : "@@ -77,9 +77,9 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::vector<const char*>& extra_args)\n     : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / g_insecure_rand_ctx_temp_path.rand256().ToString()},\n-      m_args{}\n+      m_args{gArgs}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762081278",
      "id" : 762081278,
      "in_reply_to_id" : 760574720,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tbG_-",
      "original_commit_id" : "7ede150299ea46d38a0797910c95028e7e948e0d",
      "original_line" : 80,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 822853111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762081278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-03T17:02:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762081278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762083060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762083060"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Out of curiosity and not-blocking, is there any reason we shouldn't also call `VerifyLoadedChainstate` here just for the sake of coverage?\r\n\r\nE.g. this seems to work: https://github.com/jamesob/bitcoin/commit/f8d386913ce8b0dd012b42268926c1501c6b0f03. Feel free to cherry-pick/steal. ",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-03T16:34:18Z",
      "diff_hunk" : "@@ -177,15 +181,18 @@ TestingSetup::TestingSetup(const std::string& chainName, const std::vector<const\n     // instead of unit tests, but for now we need these here.\n     RegisterAllCoreRPCCommands(tableRPC);\n \n-    m_node.chainman->InitializeChainstate(m_node.mempool.get());\n-    m_node.chainman->ActiveChainstate().InitCoinsDB(\n-        /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n-    assert(!m_node.chainman->ActiveChainstate().CanFlushToDisk());\n-    m_node.chainman->ActiveChainstate().InitCoinsCache(1 << 23);\n-    assert(m_node.chainman->ActiveChainstate().CanFlushToDisk());\n-    if (!m_node.chainman->ActiveChainstate().LoadGenesisBlock()) {\n-        throw std::runtime_error(\"LoadGenesisBlock failed.\");\n-    }\n+    auto rv = LoadChainstate(fReindex.load(),\n+                             *Assert(m_node.chainman.get()),\n+                             Assert(m_node.mempool.get()),\n+                             fPruneMode,\n+                             chainparams.GetConsensus(),\n+                             m_args.GetBoolArg(\"-reindex-chainstate\", false),\n+                             m_cache_sizes.block_tree_db,\n+                             m_cache_sizes.coins_db,\n+                             m_cache_sizes.coins,\n+                             true,\n+                             true);\n+    assert(!rv.has_value());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762083060",
      "id" : 762083060,
      "line" : 196,
      "node_id" : "PRRC_kwDOABII584tbHb0",
      "original_commit_id" : "8301c696d0a0be921ce01b6e9f74f7ff6e8c0f2f",
      "original_line" : 196,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 53,
      "pull_request_review_id" : 822853111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762083060/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-03T17:02:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762083060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs rebase, though.",
      "created_at" : "2021-12-03T17:03:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-985681773",
      "id" : 985681773,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846wE9t",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/985681773/reactions"
      },
      "updated_at" : "2021-12-03T17:03:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/985681773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Approach ACK. Debug build clean, needs rebase.",
      "created_at" : "2021-12-05T15:02:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-986245853",
      "id" : 986245853,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5846yOrd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/986245853/reactions"
      },
      "updated_at" : "2021-12-05T15:02:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/986245853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\nDarwin â¿ 20.5.0 Darwin Kernel Version 20.5.0: Sat May  8 05:10:31 PDT 2021; root:xnu-7195.121.3~9/RELEASE_ARM64_T8101 arm64\r\n\r\n```\r\n\r\n![Screen Shot 2021-12-06 at 5 32 34 PM](https://user-images.githubusercontent.com/152159/144936209-1fb98b7b-1506-48d9-b18e-c73281fbedc5.png)\r\n\r\n![Screen Shot 2021-12-06 at 5 27 26 PM](https://user-images.githubusercontent.com/152159/144936292-2475f52d-6afd-4468-9ed4-611386f63150.png)\r\n\r\n\r\n",
      "created_at" : "2021-12-06T22:59:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-987334304",
      "id" : 987334304,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII58462Yag",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987334304/reactions"
      },
      "updated_at" : "2021-12-06T22:59:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987334304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/152159?v=4",
         "events_url" : "https://api.github.com/users/RandyMcMillan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/RandyMcMillan/followers",
         "following_url" : "https://api.github.com/users/RandyMcMillan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/RandyMcMillan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/RandyMcMillan",
         "id" : 152159,
         "login" : "RandyMcMillan",
         "node_id" : "MDQ6VXNlcjE1MjE1OQ==",
         "organizations_url" : "https://api.github.com/users/RandyMcMillan/orgs",
         "received_events_url" : "https://api.github.com/users/RandyMcMillan/received_events",
         "repos_url" : "https://api.github.com/users/RandyMcMillan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/RandyMcMillan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/RandyMcMillan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/RandyMcMillan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@RandyMcMillan: That happens on current master too when building without bdb, see #23684 -  so it's very likely not related to this PR.",
      "created_at" : "2021-12-06T23:19:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-987350585",
      "id" : 987350585,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII58462cY5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987350585/reactions"
      },
      "updated_at" : "2021-12-06T23:19:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987350585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed c6861476f7e58f7b6b2e5416d2a7b774d1796a0e -> 7f15eff2ddd86034e84a19413e1a42883987f660\r\n- Use `std::function`'s inherent nullability (https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760598661)\r\n- Added code comment in commit \"init: Delay RPC block notif until warmup finished\" (https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760525288)\r\n- Added commit removing intermediate variables in `CalculateCacheSizes` (https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760560829)\r\n- Removed commit \"test/setup: Unify m_args and gArgs\" (https://github.com/bitcoin/bitcoin/pull/23280#discussion_r760574720)\r\n- Added commit \"style-only: Remove redundant scope in *Chainstate\" (https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762078294, https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762079030)",
      "created_at" : "2021-12-07T20:03:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-988227398",
      "id" : 988227398,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII58465ydG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988227398/reactions"
      },
      "updated_at" : "2021-12-07T20:03:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988227398",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I also think argument and error code code handling here could be simplified, suggested previously in [b7c7f64](https://github.com/bitcoin/bitcoin/commit/b7c7f64dc86f0fcdf07cb1e765f7cccc3a3c8897) (+129/-210) [#23280 (comment)](https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-984149564)\r\n\r\nI think we could put that in a followup PR for discussion, perhaps along with https://github.com/bitcoin/bitcoin/pull/23280#discussion_r762083060",
      "created_at" : "2021-12-07T20:04:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-988228044",
      "id" : 988228044,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII58465ynM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988228044/reactions"
      },
      "updated_at" : "2021-12-07T20:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988228044",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r764984657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764984657"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please use named argument style here",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-08T15:42:57Z",
      "diff_hunk" : "@@ -1415,6 +1415,8 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                 cache_sizes.block_tree_db,\n                                 cache_sizes.coins_db,\n                                 cache_sizes.coins,\n+                                false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r764984657",
      "id" : 764984657,
      "line" : 1418,
      "node_id" : "PRRC_kwDOABII584tmL1R",
      "original_commit_id" : "c541da0d62eaf5e96eca00d7508899f98bdfc1bc",
      "original_line" : 1418,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 108,
      "pull_request_review_id" : 826601342,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764984657/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T15:42:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764984657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r765041498"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765041498"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Please use named argument style here\r\n\r\nThis suggestion makes sense. But one way or the other I would also like to incorporate or follow up with b7c7f64dc86f0fcdf07cb1e765f7cccc3a3c8897 (+129/-210) [#23280 (comment)](https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-984149564) which gets rid of these arguments.",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-08T16:46:34Z",
      "diff_hunk" : "@@ -1415,6 +1415,8 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                 cache_sizes.block_tree_db,\n                                 cache_sizes.coins_db,\n                                 cache_sizes.coins,\n+                                false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r765041498",
      "id" : 765041498,
      "in_reply_to_id" : 764984657,
      "line" : 1418,
      "node_id" : "PRRC_kwDOABII584tmZta",
      "original_commit_id" : "c541da0d62eaf5e96eca00d7508899f98bdfc1bc",
      "original_line" : 1418,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 108,
      "pull_request_review_id" : 826679124,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765041498/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T16:46:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765041498",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r765051533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765051533"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As there is no need for precision here, wouldn't it be simpler to pass in the time here instead of a function that returns the time?\r\n(or can this function take that long to run?)",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-08T16:58:09Z",
      "diff_hunk" : "@@ -143,7 +143,7 @@ std::optional<ChainstateLoadVerifyError> VerifyLoadedChainstate(ChainstateManage\n         for (CChainState* chainstate : chainman.GetAll()) {\n             if (!is_coinsview_empty(chainstate)) {\n                 const CBlockIndex* tip = chainstate->m_chain.Tip();\n-                if (tip && tip->nTime > GetTime() + MAX_FUTURE_BLOCK_TIME) {\n+                if (tip && tip->nTime > get_unix_time_seconds() + 2 * 60 * 60) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r765051533",
      "id" : 765051533,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tmcKN",
      "original_commit_id" : "05441c2dc5f60e2025476d8ec94c9025032d118c",
      "original_line" : 146,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 826692527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765051533/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T16:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765051533",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r765055266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765055266"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure, getting rid of them is even better.",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-08T17:02:42Z",
      "diff_hunk" : "@@ -1415,6 +1415,8 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                                 cache_sizes.block_tree_db,\n                                 cache_sizes.coins_db,\n                                 cache_sizes.coins,\n+                                false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r765055266",
      "id" : 765055266,
      "in_reply_to_id" : 764984657,
      "line" : 1418,
      "node_id" : "PRRC_kwDOABII584tmdEi",
      "original_commit_id" : "c541da0d62eaf5e96eca00d7508899f98bdfc1bc",
      "original_line" : 1418,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 108,
      "pull_request_review_id" : 826697758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765055266/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T17:02:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765055266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r765057869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765057869"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why is this removing `MAX_FUTURE_BLOCK_TIME`?\r\n\r\nThis reverts https://github.com/bitcoin/bitcoin/commit/26a1147ce56083d7aa820ac115c16b01e47d911c",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-08T17:05:58Z",
      "diff_hunk" : "@@ -143,7 +143,7 @@ std::optional<ChainstateLoadVerifyError> VerifyLoadedChainstate(ChainstateManage\n         for (CChainState* chainstate : chainman.GetAll()) {\n             if (!is_coinsview_empty(chainstate)) {\n                 const CBlockIndex* tip = chainstate->m_chain.Tip();\n-                if (tip && tip->nTime > GetTime() + MAX_FUTURE_BLOCK_TIME) {\n+                if (tip && tip->nTime > get_unix_time_seconds() + 2 * 60 * 60) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r765057869",
      "id" : 765057869,
      "in_reply_to_id" : 765051533,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tmdtN",
      "original_commit_id" : "05441c2dc5f60e2025476d8ec94c9025032d118c",
      "original_line" : 146,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 826701422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765057869/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T17:05:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765057869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK\r\nThis is a big refactor but I think it moves things in the right direction:\r\n- Some welcome decoupling, only passing things to functions which they need is great\r\n- Much better to use error codes than string-y errors\r\n- Nice to have `CalculateCacheSizes` return a structure rather than the usual way with tons of output argument",
      "created_at" : "2021-12-08T17:16:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-989010326",
      "id" : 989010326,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII58468xmW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989010326/reactions"
      },
      "updated_at" : "2021-12-08T17:16:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989010326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'll reACK after the `MAX_FUTURE_BLOCK_TIME` rebase reversion is fixed",
      "created_at" : "2021-12-08T18:03:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-989047194",
      "id" : 989047194,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII584686ma",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989047194/reactions"
      },
      "updated_at" : "2021-12-08T18:03:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989047194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766766339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766766339"
         }
      },
      "author_association" : "MEMBER",
      "body" : "any reason to call this rv when better names can be chosen? Like `err`?",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-10T15:24:45Z",
      "diff_hunk" : "@@ -1418,11 +1418,8 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         bilingual_str strLoadError;\n \n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\n-\n         const int64_t load_block_index_start_time = GetTimeMillis();\n-        bool rv = LoadChainstate(fLoaded,\n-                                 strLoadError,\n-                                 fReset,\n+        auto rv = LoadChainstate(fReset,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766766339",
      "id" : 766766339,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584ts-0D",
      "original_commit_id" : "ae9121f958a4124ea6238cad0c3f2acb8b9eb4bb",
      "original_line" : 1422,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 829020675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766766339/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-10T16:16:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766766339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766793777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766793777"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-10T15:59:18Z",
      "diff_hunk" : "@@ -1461,20 +1459,34 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                 strLoadError = strprintf(_(\"Witness data for blocks after height %d requires validation. Please restart with -reindex.\"),\n                                          chainparams.GetConsensus().SegwitHeight);\n                 break;\n-            case ChainstateLoadingError::ERROR_BLOCK_FROM_FUTURE:\n-                strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n-                                 \"This may be due to your computer's date and time being set incorrectly. \"\n-                                 \"Only rebuild the block database if you are sure that your computer's date and time are correct\");\n-                break;\n-            case ChainstateLoadingError::ERROR_CORRUPTED_BLOCK_DB:\n-                strLoadError = _(\"Corrupted block database detected\");\n-                break;\n             case ChainstateLoadingError::SHUTDOWN_PROBED:\n                 break;\n             }\n         } else {\n-            fLoaded = true;\n-            LogPrintf(\" block index %15dms\\n\", GetTimeMillis() - load_block_index_start_time);\n+            auto rv2 = VerifyLoadedChainstate(chainman,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766793777",
      "id" : 766793777,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584ttFgx",
      "original_commit_id" : "ca7c0b934db68acdc410e3a82f1ed898382da2e5",
      "original_line" : 1466,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 829020675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766793777/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-10T16:16:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766793777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766794627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766794627"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, agree with laanwj. This only calls `is_coinsview_empty`, which shouldn't take more than a second (aka the precision of our clock), so it might be better to just pass in the time.",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-10T16:00:25Z",
      "diff_hunk" : "@@ -143,7 +143,7 @@ std::optional<ChainstateLoadVerifyError> VerifyLoadedChainstate(ChainstateManage\n         for (CChainState* chainstate : chainman.GetAll()) {\n             if (!is_coinsview_empty(chainstate)) {\n                 const CBlockIndex* tip = chainstate->m_chain.Tip();\n-                if (tip && tip->nTime > GetTime() + MAX_FUTURE_BLOCK_TIME) {\n+                if (tip && tip->nTime > get_unix_time_seconds() + 2 * 60 * 60) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766794627",
      "id" : 766794627,
      "in_reply_to_id" : 765051533,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584ttFuD",
      "original_commit_id" : "05441c2dc5f60e2025476d8ec94c9025032d118c",
      "original_line" : 146,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 829020675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766794627/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-10T16:16:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766794627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766797325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766797325"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this comment is \"wrong\". `shutdown_requested` is a local symbol to the function, so there is no other place calling it.\r\n\r\nMaybe just rephrase as \"shutdown hasn't been requested indirectly\"",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-10T16:03:56Z",
      "diff_hunk" : "@@ -45,10 +45,10 @@ enum class ChainstateLoadingError {\n  *        differentiable by the specific enumerator.\n  *\n  *        Note that a return value of SHUTDOWN_PROBED means ONLY that \"during\n- *        this sequence, when we explicitly checked ShutdownRequested() at\n+ *        this sequence, when we explicitly checked shutdown_requested() at\n  *        arbitrary points, one of those calls returned true\". Therefore, a\n  *        return value other than SHUTDOWN_PROBED does not guarantee that\n- *        ShutdownRequested() hasn't been called indirectly.\n+ *        shutdown_requested() hasn't been called indirectly.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766797325",
      "id" : 766797325,
      "line" : 53,
      "node_id" : "PRRC_kwDOABII584ttGYN",
      "original_commit_id" : "4da9c076d1cf12728730bb1f7e8906d4e9bfaba5",
      "original_line" : 51,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/node/chainstate.h",
      "position" : 53,
      "pull_request_review_id" : 829020675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766797325/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-10T16:16:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766797325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766802045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766802045"
         }
      },
      "author_association" : "MEMBER",
      "body" : "seems fragile to provide a default value that is unused, no?",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-10T16:10:23Z",
      "diff_hunk" : "@@ -0,0 +1,22 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_NODE_CACHES_H\n+#define BITCOIN_NODE_CACHES_H\n+\n+#include <cstddef> // for size_t\n+#include <cstdint> // for int64_t\n+\n+class ArgsManager;\n+\n+struct CacheSizes {\n+    int64_t block_tree_db;\n+    int64_t coins_db;\n+    int64_t coins;\n+    int64_t tx_index;\n+    int64_t filter_index;\n+};\n+CacheSizes CalculateCacheSizes(const ArgsManager& args, size_t n_indexes = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r766802045",
      "id" : 766802045,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII584ttHh9",
      "original_commit_id" : "ac4bf138b849a8544798f3891d6623803040c265",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/caches.h",
      "position" : 20,
      "pull_request_review_id" : 829020675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766802045/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-10T16:16:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766802045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r774304965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/774304965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Followed up with in #23736.",
      "commit_id" : "7f15eff2ddd86034e84a19413e1a42883987f660",
      "created_at" : "2021-12-23T04:10:02Z",
      "diff_hunk" : "@@ -177,15 +181,18 @@ TestingSetup::TestingSetup(const std::string& chainName, const std::vector<const\n     // instead of unit tests, but for now we need these here.\n     RegisterAllCoreRPCCommands(tableRPC);\n \n-    m_node.chainman->InitializeChainstate(m_node.mempool.get());\n-    m_node.chainman->ActiveChainstate().InitCoinsDB(\n-        /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n-    assert(!m_node.chainman->ActiveChainstate().CanFlushToDisk());\n-    m_node.chainman->ActiveChainstate().InitCoinsCache(1 << 23);\n-    assert(m_node.chainman->ActiveChainstate().CanFlushToDisk());\n-    if (!m_node.chainman->ActiveChainstate().LoadGenesisBlock()) {\n-        throw std::runtime_error(\"LoadGenesisBlock failed.\");\n-    }\n+    auto rv = LoadChainstate(fReindex.load(),\n+                             *Assert(m_node.chainman.get()),\n+                             Assert(m_node.mempool.get()),\n+                             fPruneMode,\n+                             chainparams.GetConsensus(),\n+                             m_args.GetBoolArg(\"-reindex-chainstate\", false),\n+                             m_cache_sizes.block_tree_db,\n+                             m_cache_sizes.coins_db,\n+                             m_cache_sizes.coins,\n+                             true,\n+                             true);\n+    assert(!rv.has_value());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#discussion_r774304965",
      "id" : 774304965,
      "in_reply_to_id" : 762083060,
      "line" : 196,
      "node_id" : "PRRC_kwDOABII584uJvTF",
      "original_commit_id" : "8301c696d0a0be921ce01b6e9f74f7ff6e8c0f2f",
      "original_line" : 196,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 53,
      "pull_request_review_id" : 838992636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/774304965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-23T04:10:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/774304965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dongcarl Are you going to address the feedback or do you want someone else to do it? Either is fine, just let us know.",
      "created_at" : "2021-12-23T07:23:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-1000098754",
      "id" : 1000098754,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5847nEvC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1000098754/reactions"
      },
      "updated_at" : "2021-12-23T07:23:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1000098754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke Thanks for the reminder! Opened #23855.",
      "created_at" : "2021-12-23T22:50:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23280#issuecomment-1000553037",
      "id" : 1000553037,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23280",
      "node_id" : "IC_kwDOABII5847ozpN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1000553037/reactions"
      },
      "updated_at" : "2021-12-23T22:50:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1000553037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   }
]
