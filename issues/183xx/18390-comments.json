[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "There is a lot of related discussion in the [PR](https://github.com/bitcoin/bitcoin/pull/8393) introducing this behaviour along with a [change](https://github.com/bitcoin/bips/pull/423) to the corresponding BIP-151.\r\n\r\nMore specifically, the updated BIP says:\r\n> Upon connection establishment, a node SHOULD send a burst of sendcmpct messages containing every version of compact block encodings for which they are willing to support sending cmpctblock and blocktxn messages, and receiving getblocktxn messages. These messages SHOULD be ordered in the order of the priority which the node wishes to receive cmpctblock/blocktxn messages, with the highest-priority version sendcmpct message sent first.\r\n\r\nI believe that this is done to enable the possible future where SegWit-supporting nodes (NODE_WITNESS) to participate in both v1 and v2 compact block relay, and this would allow current nodes to talk to them (by not implying that SegWit is always v2-cmpctblocks).\r\n\r\nTo be clear, I just spent about 30 minutes trying to figure out, and I'm still unsure that my rationale is correct. Maybe this means we should add a comment.",
      "created_at" : "2020-03-20T14:57:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/18390#issuecomment-601742963",
      "id" : 601742963,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18390",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMTc0Mjk2Mw==",
      "updated_at" : "2020-03-20T15:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/601742963",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "There is a comment already:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/5bf45fe2a9642f8ae8f8a12bcbf8f8b4770421ad/src/net_processing.cpp#L2132\r\n\r\nBut I don't understand why we still support non-witness compact blocks these days. To simplify our code, we could just remove those things?",
      "created_at" : "2020-03-20T15:02:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/18390#issuecomment-601745889",
      "id" : 601745889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18390",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMTc0NTg4OQ==",
      "updated_at" : "2020-03-20T15:02:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/601745889",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke yes, that comment is there, but it doesn't make clear why it is useful to announce cmpctblocks-v1 for segwit nodes. The confusing part is that it's definitely not useful if everybody uses current implementation, so one have to think about either past or future scenarios, where this could be useful via compatibility.",
      "created_at" : "2020-03-20T15:08:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/18390#issuecomment-601748548",
      "id" : 601748548,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18390",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMTc0ODU0OA==",
      "updated_at" : "2020-03-20T15:08:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/601748548",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I accidentally clicked on the 'close issue' :).\r\nI understand that sending one more SENDCMPCT msg for some nodes that only support version 1.\r\n\r\nI still have something to discuss.\r\n\r\nWithout considering the version (1 or 2), I just understand the meaning of `nCMPCTBLOCKVersion` determines whether this node wants to send or receive witness data. This is because some nodes (supporting version 2) may not want to receive witness data. Also, I think `fWantsCmpctWitness` has the same role as `nCMPCTBLOCKVersion`.\r\n```\r\n// ! Whether this peer wants witnesses in cmpctblocks/blocktxns\r\nbool fWantsCmpctWitness;\r\n```\r\n\r\nBut, in receiving SENDCMPCT part,\r\nhttps://github.com/bitcoin/bitcoin/blob/5bf45fe2a9642f8ae8f8a12bcbf8f8b4770421ad/src/net_processing.cpp#L2215\r\nIf a peer sends any SENDCMPCT msg with `nCMPCTBLOCKVersion == 2`, there is no logic to change `fWantsCmpctWitness` to `False` even if the peer sends SENDCMPCT msg with `nCMPCTBLOCKVersion == 1`.\r\n\r\nIs there anything I misunderstand?\r\n",
      "created_at" : "2020-03-20T17:22:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/18390#issuecomment-601818966",
      "id" : 601818966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18390",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMTgxODk2Ng==",
      "updated_at" : "2020-03-20T17:26:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/601818966",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/48233791?v=4",
         "events_url" : "https://api.github.com/users/seungww/events{/privacy}",
         "followers_url" : "https://api.github.com/users/seungww/followers",
         "following_url" : "https://api.github.com/users/seungww/following{/other_user}",
         "gists_url" : "https://api.github.com/users/seungww/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/seungww",
         "id" : 48233791,
         "login" : "seungww",
         "node_id" : "MDQ6VXNlcjQ4MjMzNzkx",
         "organizations_url" : "https://api.github.com/users/seungww/orgs",
         "received_events_url" : "https://api.github.com/users/seungww/received_events",
         "repos_url" : "https://api.github.com/users/seungww/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/seungww/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/seungww/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/seungww"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "You are correct,  this is done to follow this part of BIP-152:\r\n\r\n>These messages SHOULD be ordered in the order of the priority which the node wishes to receive cmpctblock/blocktxn messages, with the highest-priority version sendcmpct message sent first.\r\n\r\nNotice that upgrade from v1 to v2 is also not allowed by this code (because it will stick to v1 which is received first).\r\n\r\nWhat **is** possible for future implementations of the node is to ignore v2 for some reason, and stick to v1, even if v1 is received later.",
      "created_at" : "2020-03-20T18:14:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/18390#issuecomment-601843295",
      "id" : 601843295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18390",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMTg0MzI5NQ==",
      "updated_at" : "2020-03-20T18:14:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/601843295",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It appears that Bitcoin Core no longer sends multiple _versions_ of the `SENDCMPT` message:\r\n\r\n```fish\r\n$ rg NetMsgType::SENDCMPCT\r\nsrc/net_processing.cpp\r\n1220:                m_connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*high_bandwidth=*/false, /*version=*/CMPCTBLOCKS_VERSION));\r\n1227:        m_connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*high_bandwidth=*/true, /*version=*/CMPCTBLOCKS_VERSION));\r\n3418:            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /*high_bandwidth=*/false, /*version=*/CMPCTBLOCKS_VERSION));\r\n3454:    if (msg_type == NetMsgType::SENDCMPCT) {\r\n\r\nsrc/protocol.cpp\r\n77:    NetMsgType::SENDCMPCT,\r\n``` \r\n\r\n...and when we do, we only specify V2 by sending `CMPCTBLOCKS_VERSION`:\r\n\r\n```\r\n/** The compactblocks version we support. See BIP 152. */\r\nstatic constexpr uint64_t CMPCTBLOCKS_VERSION{2};\r\n```\r\nIn addition to this, we now **ony** support V2 compact blocks:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/f088949fcfe6ba5000caa2f6adc6803e81925afb/src/net_processing.cpp#L3454-L3460\r\n\r\nTherefore I think this issue can be closed now.",
      "created_at" : "2023-03-13T15:26:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/18390#issuecomment-1466364121",
      "id" : 1466364121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18390",
      "node_id" : "IC_kwDOABII585XZvDZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1466364121/reactions"
      },
      "updated_at" : "2023-03-13T15:26:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1466364121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
