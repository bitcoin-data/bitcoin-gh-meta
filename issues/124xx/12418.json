{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "I'm working on a [paper multisig system](https://glacierprotocol.org), improving it to use p2sh-segwit instead of legacy p2sh. I'm using my own Linux build of Bitcoin Core tag v0.16.0rc3 and using bitcoin-cli to build transactions.\r\n\r\nI used `addmultisigaddress` to create a 2-of-4 p2sh-segwit address and funded it on testnet. I created a transaction to spend those coins using `createrawtransaction` and I'm attempting to sign it.\r\n\r\n# Actual behavior\r\nIf I provide no keys to `signrawtransaction` and let it use the wallet keys, everything works. But if I provide the keys explicitly, I get the error: \"Unable to sign input, invalid stack size (possibly missing key)\".\r\n\r\n# Expected behavior\r\nI expect `signrawtransaction` to be able to sign the transaction using the explicltly-provided keys. (For a paper wallet, the bitcoind wallet will not know the keys or the multisig address.)\r\n\r\nThis flow works as expected when I use type 'legacy' for the `addmultisigaddress`. It fails when I use type 'p2sh-segwit'.\r\n\r\nMy guess is that it assumes it's legacy p2sh and therefore the signature fails. Shouldn't bitcoind be able to figure out (based on the scriptPubKey and the redeemScript) that this is p2sh-segwit, and construct the appropriate signatures? Or is there a different/better way to use the CLI to accomplish this?\r\n\r\n# To recreate\r\n[This script](https://pastebin.com/2KLHkV9Y) shows the problem. The final `signrawtransaction` step should succeed. [[output]](https://pastebin.com/k5wwERLG)\r\n\r\n# Ugly workaround\r\nI could use `addmultisigaddress` to teach the wallet about the p2sh-segwit address, and `importprivkey` to teach it 2-of-4 keys, then use `signrawtransaction` without providing any keys. [This](https://pastebin.com/MMJhWCfP) seems to work [[output]](https://pastebin.com/M5gw7FkG) but is very ugly because at the time of signing, I only have 2 of 4 keys, so in order to run `addmultisigaddress` I have to decode the redeemScript and parse its \"asm\" field to find the 4 pubkeys.\r\n\r\n# Related\r\nSomewhat related issue, never merged: issue #11693 and its associated PR #11708\r\n",
   "closed_at" : "2018-02-28T18:36:26Z",
   "closed_by" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/31543633?v=4",
      "events_url" : "https://api.github.com/users/bitcoinhodler/events{/privacy}",
      "followers_url" : "https://api.github.com/users/bitcoinhodler/followers",
      "following_url" : "https://api.github.com/users/bitcoinhodler/following{/other_user}",
      "gists_url" : "https://api.github.com/users/bitcoinhodler/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/bitcoinhodler",
      "id" : 31543633,
      "login" : "bitcoinhodler",
      "node_id" : "MDQ6VXNlcjMxNTQzNjMz",
      "organizations_url" : "https://api.github.com/users/bitcoinhodler/orgs",
      "received_events_url" : "https://api.github.com/users/bitcoinhodler/received_events",
      "repos_url" : "https://api.github.com/users/bitcoinhodler/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/bitcoinhodler/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/bitcoinhodler/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/bitcoinhodler"
   },
   "comments" : 10,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418/comments",
   "created_at" : "2018-02-12T23:25:28Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/12418",
   "id" : 296561083,
   "labels" : [
      {
         "color" : "0052cc",
         "default" : false,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "node_id" : "MDU6TGFiZWw5ODI3OTE3Nw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUyOTY1NjEwODM=",
   "number" : 12418,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "signrawtransaction unable to sign p2sh-segwit multisig transaction",
   "updated_at" : "2018-12-22T17:29:16Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12418",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/31543633?v=4",
      "events_url" : "https://api.github.com/users/bitcoinhodler/events{/privacy}",
      "followers_url" : "https://api.github.com/users/bitcoinhodler/followers",
      "following_url" : "https://api.github.com/users/bitcoinhodler/following{/other_user}",
      "gists_url" : "https://api.github.com/users/bitcoinhodler/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/bitcoinhodler",
      "id" : 31543633,
      "login" : "bitcoinhodler",
      "node_id" : "MDQ6VXNlcjMxNTQzNjMz",
      "organizations_url" : "https://api.github.com/users/bitcoinhodler/orgs",
      "received_events_url" : "https://api.github.com/users/bitcoinhodler/received_events",
      "repos_url" : "https://api.github.com/users/bitcoinhodler/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/bitcoinhodler/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/bitcoinhodler/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/bitcoinhodler"
   }
}
