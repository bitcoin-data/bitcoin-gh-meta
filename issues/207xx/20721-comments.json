[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-19T13:22:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-748474312",
      "id" : 748474312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODQ3NDMxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-19T13:22:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748474312",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Hello John,Is this regarding the request I made yesterday.?\n\nOn Sat, Dec 19, 2020 at 6:26 AM John Newbery <notifications@github.com>\nwrote:\n\n> This continues the work of moving application layer data into\n> net_processing, by moving all ping data into the new Peer object added in\n> #19607 <https://github.com/bitcoin/bitcoin/pull/19607>.\n>\n> For motivation, see #19398\n> <https://github.com/bitcoin/bitcoin/issues/19398>.\n>\n> The first three commits are review suggestions from #19829\n> <https://github.com/bitcoin/bitcoin/pull/19829>.\n> ------------------------------\n> You can view, comment on, or merge this pull request online at:\n>\n>   https://github.com/bitcoin/bitcoin/pull/20721\n> Commit Summary\n>\n>    - [net processing] Add comment about destructing Peer objects\n>    - [net processing] Move nStartingHeight to Peer\n>    - [net processing] Rename nStartingHeight to m_starting_height\n>    - [net processing] Move block inventory data to Peer\n>    - scripted-diff: rename vBlockHashesToAnnounce and\n>    vInventoryBlockToSend\n>    - [net processing] Move hashContinue to net processing\n>    - [net processing] Fix/improve comments for Peer\n>    - [rpc] Fix ordering of fields in getpeerinfo help text\n>    - [net processing] Guard m_hash_continue with m_block_inv_mutex\n>    - [net processing] Move send ping message logic into function\n>    - [net processing] Move ping timeout logic to net processing\n>    - [net processing] Move ping data fields to net processing\n>    - scripted-diff: rename ping members\n>\n> File Changes\n>\n>    - *M* src/net.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-00021eed586a482abdb09d6cdada1d90115abe988a91421851960e26658bed02>\n>    (29)\n>    - *M* src/net.h\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-422879cc8bfac56d4380c865f381b58afeb344bc355bbc7f47c581e4491b6b4b>\n>    (27)\n>    - *M* src/net_processing.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3>\n>    (203)\n>    - *M* src/net_processing.h\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-2a4e846ad2d76a4e7a6f6c46a68b3603de372f435a93b7c0fcabadccc0ed86a5>\n>    (49)\n>    - *M* src/qt/rpcconsole.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-cec3a0a10196329610d46fbd0e01ce6496e5ae9e23c057d8012d48c2f0d3b5c9>\n>    (7)\n>    - *M* src/rpc/net.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-2ae094f9329ce9498e1b4a9cb7767945b54a33b4ee9fed4f0ba401a98e1683c1>\n>    (23)\n>    - *M* src/test/denialofservice_tests.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-a4c9875091483bafb92d8ccaa035dff408a7a5c44e5b4eb55ff51fb0e5112ed2>\n>    (18)\n>\n> Patch Links:\n>\n>    - https://github.com/bitcoin/bitcoin/pull/20721.patch\n>    - https://github.com/bitcoin/bitcoin/pull/20721.diff\n>\n> â\n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/20721>, or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AJ3ZHMLNHNH6WYDANXUXQOLSVSEWZANCNFSM4VCHGLWQ>\n> .\n>\n",
      "created_at" : "2020-12-19T14:16:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-748480409",
      "id" : 748480409,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODQ4MDQwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-19T14:16:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748480409",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/41391025?v=4",
         "events_url" : "https://api.github.com/users/sheffine/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sheffine/followers",
         "following_url" : "https://api.github.com/users/sheffine/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sheffine/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sheffine",
         "id" : 41391025,
         "login" : "sheffine",
         "node_id" : "MDQ6VXNlcjQxMzkxMDI1",
         "organizations_url" : "https://api.github.com/users/sheffine/orgs",
         "received_events_url" : "https://api.github.com/users/sheffine/received_events",
         "repos_url" : "https://api.github.com/users/sheffine/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sheffine/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sheffine/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sheffine"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Is it okay for me to go ahead and pull this file. I have no idea with\nregards to whatâs going on and if my request has been completed .\nCan some one give me some answer please\n\nSheffine\n\nOn Sat, Dec 19, 2020 at 6:26 AM John Newbery <notifications@github.com>\nwrote:\n\n> This continues the work of moving application layer data into\n> net_processing, by moving all ping data into the new Peer object added in\n> #19607 <https://github.com/bitcoin/bitcoin/pull/19607>.\n>\n> For motivation, see #19398\n> <https://github.com/bitcoin/bitcoin/issues/19398>.\n>\n> The first three commits are review suggestions from #19829\n> <https://github.com/bitcoin/bitcoin/pull/19829>.\n> ------------------------------\n> You can view, comment on, or merge this pull request online at:\n>\n>   https://github.com/bitcoin/bitcoin/pull/20721\n> Commit Summary\n>\n>    - [net processing] Add comment about destructing Peer objects\n>    - [net processing] Move nStartingHeight to Peer\n>    - [net processing] Rename nStartingHeight to m_starting_height\n>    - [net processing] Move block inventory data to Peer\n>    - scripted-diff: rename vBlockHashesToAnnounce and\n>    vInventoryBlockToSend\n>    - [net processing] Move hashContinue to net processing\n>    - [net processing] Fix/improve comments for Peer\n>    - [rpc] Fix ordering of fields in getpeerinfo help text\n>    - [net processing] Guard m_hash_continue with m_block_inv_mutex\n>    - [net processing] Move send ping message logic into function\n>    - [net processing] Move ping timeout logic to net processing\n>    - [net processing] Move ping data fields to net processing\n>    - scripted-diff: rename ping members\n>\n> File Changes\n>\n>    - *M* src/net.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-00021eed586a482abdb09d6cdada1d90115abe988a91421851960e26658bed02>\n>    (29)\n>    - *M* src/net.h\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-422879cc8bfac56d4380c865f381b58afeb344bc355bbc7f47c581e4491b6b4b>\n>    (27)\n>    - *M* src/net_processing.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3>\n>    (203)\n>    - *M* src/net_processing.h\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-2a4e846ad2d76a4e7a6f6c46a68b3603de372f435a93b7c0fcabadccc0ed86a5>\n>    (49)\n>    - *M* src/qt/rpcconsole.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-cec3a0a10196329610d46fbd0e01ce6496e5ae9e23c057d8012d48c2f0d3b5c9>\n>    (7)\n>    - *M* src/rpc/net.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-2ae094f9329ce9498e1b4a9cb7767945b54a33b4ee9fed4f0ba401a98e1683c1>\n>    (23)\n>    - *M* src/test/denialofservice_tests.cpp\n>    <https://github.com/bitcoin/bitcoin/pull/20721/files#diff-a4c9875091483bafb92d8ccaa035dff408a7a5c44e5b4eb55ff51fb0e5112ed2>\n>    (18)\n>\n> Patch Links:\n>\n>    - https://github.com/bitcoin/bitcoin/pull/20721.patch\n>    - https://github.com/bitcoin/bitcoin/pull/20721.diff\n>\n> â\n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/20721>, or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AJ3ZHMLNHNH6WYDANXUXQOLSVSEWZANCNFSM4VCHGLWQ>\n> .\n>\n",
      "created_at" : "2020-12-20T23:27:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-748686574",
      "id" : 748686574,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODY4NjU3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-20T23:27:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748686574",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/41391025?v=4",
         "events_url" : "https://api.github.com/users/sheffine/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sheffine/followers",
         "following_url" : "https://api.github.com/users/sheffine/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sheffine/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sheffine",
         "id" : 41391025,
         "login" : "sheffine",
         "node_id" : "MDQ6VXNlcjQxMzkxMDI1",
         "organizations_url" : "https://api.github.com/users/sheffine/orgs",
         "received_events_url" : "https://api.github.com/users/sheffine/received_events",
         "repos_url" : "https://api.github.com/users/sheffine/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sheffine/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sheffine/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sheffine"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sheffine You seem pretty confused, and I have no idea what you're trying to do. This is the discussion page for a proposed change to the Bitcoin Core software project, and your comments seem unrelated. Please stop.",
      "created_at" : "2020-12-21T03:31:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-748737513",
      "id" : 748737513,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODczNzUxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-21T03:31:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748737513",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased on master. This is now ready for review.",
      "created_at" : "2020-12-22T13:46:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-749547642",
      "id" : 749547642,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0OTU0NzY0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-22T13:46:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/749547642",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548265029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548265029"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you're changing every reference to `pto` anyway because it's now a reference not a pointer, maybe also call it `node_to` or similar, since it's not a \"p\" anymore?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-23T21:43:57Z",
      "diff_hunk" : "@@ -4076,31 +4076,15 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManager::SendMessages(CNode* pto)\n+void PeerManager::MaybeSendPing(CNode& pto)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548265029",
      "id" : 548265029,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2NTAyOQ==",
      "original_commit_id" : "cc0e0fc8d054d3a331256dd65a794174ad39fe3d",
      "original_line" : 4079,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 558241240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548265029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548266275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548266275"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think exposing more implementation details in net_processing.h is a good idea. Fortunately it's fixable: #20758 ",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-23T21:45:34Z",
      "diff_hunk" : "@@ -217,6 +217,9 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /** Send a ping message on a regular schedule or if requested manually */\n+    void MaybeSendPing(CNode& pto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548266275",
      "id" : 548266275,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2NjI3NQ==",
      "original_commit_id" : "cc0e0fc8d054d3a331256dd65a794174ad39fe3d",
      "original_line" : 221,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 558241240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548266275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548268168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548268168"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Move the test change to its own commit so it's easy to verify behaviour doesn't change with the move logic to net_processing commit? I don't follow why the test change is necessary/desirable though.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-23T21:48:14Z",
      "diff_hunk" : "@@ -109,9 +109,17 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n         dummyNode1.vSendMsg.clear();\n     }\n \n-    int64_t nStartTime = GetTime();\n-    // Wait 21 minutes\n-    SetMockTime(nStartTime+21*60);\n+    int64_t time{GetTime()};\n+    // Wait 10 minutes\n+    time += 10 * 60;\n+    SetMockTime(time);\n+\n+    // Clear nPingNonceSent so we don't disconnect for a ping timeout\n+    dummyNode1.nPingNonceSent = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548268168",
      "id" : 548268168,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2ODE2OA==",
      "original_commit_id" : "a54ba871666ccab23400894832e05a1bb9c53c32",
      "original_line" : 118,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 558241240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548268168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21190 (net: Avoid discouraging the onion proxy when one inbound onion misbehaves by MarcoFalke)\n* #21015 (Make all of net_processing (and some of net) use std::chrono types by dhruv)\n* #20845 (net: Log to net debug in MaybeDiscourageAndDisconnect except for noban and manual peers by MarcoFalke)\n* #20758 (net-processing refactoring -- lose globals, move implementation details from .h to .cpp by ajtowns)\n* #18261 (Erlay: bandwidth-efficient transaction relay protocol by naumenkogs)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-12-23T21:54:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-750488019",
      "id" : 750488019,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MDQ4ODAxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T08:08:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/750488019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> \"jnewbery deleted a comment from sipa 3 days ago\" ?\r\n\r\nha. There were two comments from sheffine saying \"why are you emailing me?\" and one from sipa saying \"sheffine, you're confused\", so I deleted them all to reduce noise.",
      "created_at" : "2020-12-23T22:19:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-750494700",
      "id" : 750494700,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MDQ5NDcwMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-23T22:19:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/750494700",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Censorship!!!\n\n(yes, that's indeed what happened)",
      "created_at" : "2020-12-23T22:20:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-750495167",
      "id" : 750495167,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MDQ5NTE2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-23T22:20:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/750495167",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548317053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548317053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Move the test change to its own commit so it's easy to verify behaviour doesn't change\r\n\r\ngood idea. Will do.\r\n\r\n> I don't follow why the test change is necessary/desirable though.\r\n\r\nThe change is required because previously ping timeouts happened in in CConnman, so it was fine to bump the time in this test because there's no CConnman to time out the connection. When the ping data and timout logic is moved to PeerManager, then the connection times out in this test if you bump the time forwards by 21 minutes without resetting the ping nonce.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-23T23:22:51Z",
      "diff_hunk" : "@@ -109,9 +109,17 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n         dummyNode1.vSendMsg.clear();\n     }\n \n-    int64_t nStartTime = GetTime();\n-    // Wait 21 minutes\n-    SetMockTime(nStartTime+21*60);\n+    int64_t time{GetTime()};\n+    // Wait 10 minutes\n+    time += 10 * 60;\n+    SetMockTime(time);\n+\n+    // Clear nPingNonceSent so we don't disconnect for a ping timeout\n+    dummyNode1.nPingNonceSent = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548317053",
      "id" : 548317053,
      "in_reply_to_id" : 548268168,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMxNzA1Mw==",
      "original_commit_id" : "a54ba871666ccab23400894832e05a1bb9c53c32",
      "original_line" : 118,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 558270431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548317053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548317225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548317225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Totally agree! I think #20758 can happen before or after this PR.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-23T23:23:38Z",
      "diff_hunk" : "@@ -217,6 +217,9 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /** Send a ping message on a regular schedule or if requested manually */\n+    void MaybeSendPing(CNode& pto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548317225",
      "id" : 548317225,
      "in_reply_to_id" : 548266275,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMxNzIyNQ==",
      "original_commit_id" : "cc0e0fc8d054d3a331256dd65a794174ad39fe3d",
      "original_line" : 221,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 558270594,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548317225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548317373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548317373"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure. I'll split the commit into a move and a rename/change to reference to make it easier to review.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-23T23:24:14Z",
      "diff_hunk" : "@@ -4076,31 +4076,15 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManager::SendMessages(CNode* pto)\n+void PeerManager::MaybeSendPing(CNode& pto)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548317373",
      "id" : 548317373,
      "in_reply_to_id" : 548265029,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMxNzM3Mw==",
      "original_commit_id" : "cc0e0fc8d054d3a331256dd65a794174ad39fe3d",
      "original_line" : 4079,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 558270749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548317373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @ajtowns. I'll move the commits around a bit to address your comments.",
      "created_at" : "2020-12-23T23:27:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-750559337",
      "id" : 750559337,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MDU1OTMzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-23T23:27:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/750559337",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548357896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548357896"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I don't think either need gate the other, the above was literally my thought process in getting to that PR -- sipa may not have nerd sniped me with twitter maths, but that doesn't mean I didn't get nerd sniped anyway...",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-24T02:47:29Z",
      "diff_hunk" : "@@ -217,6 +217,9 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /** Send a ping message on a regular schedule or if requested manually */\n+    void MaybeSendPing(CNode& pto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548357896",
      "id" : 548357896,
      "in_reply_to_id" : 548266275,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM1Nzg5Ng==",
      "original_commit_id" : "cc0e0fc8d054d3a331256dd65a794174ad39fe3d",
      "original_line" : 221,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 558311099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548357896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548362767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548362767"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Makes sense; might be a useful commit message for the test change?\r\n\r\nSeems kind-of annoying to have to remember to constrain your mocktime bumps by random ping timeout limits. Shouldn't this also (already) cause problems in functional tests?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-24T03:11:43Z",
      "diff_hunk" : "@@ -109,9 +109,17 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n         dummyNode1.vSendMsg.clear();\n     }\n \n-    int64_t nStartTime = GetTime();\n-    // Wait 21 minutes\n-    SetMockTime(nStartTime+21*60);\n+    int64_t time{GetTime()};\n+    // Wait 10 minutes\n+    time += 10 * 60;\n+    SetMockTime(time);\n+\n+    // Clear nPingNonceSent so we don't disconnect for a ping timeout\n+    dummyNode1.nPingNonceSent = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548362767",
      "id" : 548362767,
      "in_reply_to_id" : 548268168,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM2Mjc2Nw==",
      "original_commit_id" : "a54ba871666ccab23400894832e05a1bb9c53c32",
      "original_line" : 118,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 558316103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548362767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548363032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548363032"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems like a more productive form of aj-sniping.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-24T03:13:14Z",
      "diff_hunk" : "@@ -217,6 +217,9 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /** Send a ping message on a regular schedule or if requested manually */\n+    void MaybeSendPing(CNode& pto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548363032",
      "id" : 548363032,
      "in_reply_to_id" : 548266275,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM2MzAzMg==",
      "original_commit_id" : "cc0e0fc8d054d3a331256dd65a794174ad39fe3d",
      "original_line" : 221,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 558316396,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548363032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548586608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548586608"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The functional tests have an asyncio event loop thread that will automatically respond to ping messages:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/f656165e9c0d09e654efabd56e6581638e35c26c/test/functional/test_framework/p2p.py#L392-L393\r\n\r\nThe unit tests are single threaded, so any logic to handle messages needs to be done in the main test logic.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-24T16:10:02Z",
      "diff_hunk" : "@@ -109,9 +109,17 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n         dummyNode1.vSendMsg.clear();\n     }\n \n-    int64_t nStartTime = GetTime();\n-    // Wait 21 minutes\n-    SetMockTime(nStartTime+21*60);\n+    int64_t time{GetTime()};\n+    // Wait 10 minutes\n+    time += 10 * 60;\n+    SetMockTime(time);\n+\n+    // Clear nPingNonceSent so we don't disconnect for a ping timeout\n+    dummyNode1.nPingNonceSent = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548586608",
      "id" : 548586608,
      "in_reply_to_id" : 548268168,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU4NjYwOA==",
      "original_commit_id" : "a54ba871666ccab23400894832e05a1bb9c53c32",
      "original_line" : 118,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 558675860,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548586608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548593918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548593918"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-24T16:20:47Z",
      "diff_hunk" : "@@ -4076,31 +4076,15 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManager::SendMessages(CNode* pto)\n+void PeerManager::MaybeSendPing(CNode& pto)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548593918",
      "id" : 548593918,
      "in_reply_to_id" : 548265029,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU5MzkxOA==",
      "original_commit_id" : "cc0e0fc8d054d3a331256dd65a794174ad39fe3d",
      "original_line" : 4079,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 558678259,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548593918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548596150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548596150"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I like this kind of aj-sniping.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-24T16:24:04Z",
      "diff_hunk" : "@@ -217,6 +217,9 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /** Send a ping message on a regular schedule or if requested manually */\n+    void MaybeSendPing(CNode& pto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548596150",
      "id" : 548596150,
      "in_reply_to_id" : 548266275,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU5NjE1MA==",
      "original_commit_id" : "cc0e0fc8d054d3a331256dd65a794174ad39fe3d",
      "original_line" : 221,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 558678955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548596150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548596374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548596374"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, split this into its own commit.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-24T16:24:19Z",
      "diff_hunk" : "@@ -109,9 +109,17 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n         dummyNode1.vSendMsg.clear();\n     }\n \n-    int64_t nStartTime = GetTime();\n-    // Wait 21 minutes\n-    SetMockTime(nStartTime+21*60);\n+    int64_t time{GetTime()};\n+    // Wait 10 minutes\n+    time += 10 * 60;\n+    SetMockTime(time);\n+\n+    // Clear nPingNonceSent so we don't disconnect for a ping timeout\n+    dummyNode1.nPingNonceSent = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r548596374",
      "id" : 548596374,
      "in_reply_to_id" : 548268168,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU5NjM3NA==",
      "original_commit_id" : "a54ba871666ccab23400894832e05a1bb9c53c32",
      "original_line" : 118,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 558679026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548596374",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549455568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549455568"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Noob / practices question: why not just create this with a `bool` return type, since you change it 3 commits later? I don't have an opinion, but why is it better to do it this way?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-28T19:06:12Z",
      "diff_hunk" : "@@ -217,6 +217,9 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /** Send a ping message on a regular schedule or if requested manually */\n+    void MaybeSendPing(CNode* pto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549455568",
      "id" : 549455568,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ1NTU2OA==",
      "original_commit_id" : "9466feef40aec209c2a3975fa04e75e0f90f42b5",
      "original_line" : 221,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 559267216,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549455568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549486291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549486291"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Genuine question, why should best ping time be in `CNode` but all the others in `Peer`? We use best ping time for eviction logic which seems like an application-layer thing...",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-28T21:04:07Z",
      "diff_hunk" : "@@ -1048,17 +1046,7 @@ class CNode\n      * in CConnman::AttemptToEvictConnection. */\n     std::atomic<int64_t> nLastTXTime{0};\n \n-    // Ping time measurement:\n-    // The pong reply we're expecting, or 0 if no pong expected.\n-    std::atomic<uint64_t> nPingNonceSent{0};\n-    /** When the last ping was sent, or 0 if no ping was ever sent */\n-    std::atomic<std::chrono::microseconds> m_ping_start{0us};\n-    // Last measured round-trip time.\n-    std::atomic<int64_t> nPingUsecTime{0};\n-    // Best measured round-trip time.\n     std::atomic<int64_t> nMinPingUsecTime{std::numeric_limits<int64_t>::max()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549486291",
      "id" : 549486291,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ4NjI5MQ==",
      "original_commit_id" : "2c1c3ec6e4e55c53157ec80f192331044e19d73d",
      "original_line" : 1049,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 559267216,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549486291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549492180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549492180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since you removed this, `CNodeStats` doesn't know min ping time anymore. The p2p_eviction and p2p_ping functional tests fail since `getpeerinfo()` always returns 0 for minping :(\r\n\r\nAdding it back fixed the tests for me:\r\n```c\r\nstats.m_min_ping_usec  = m_best_ping_time;\r\n```",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-28T21:28:04Z",
      "diff_hunk" : "@@ -609,22 +609,6 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n         stats.minFeeFilter = 0;\n     }\n \n-    // It is common for nodes with good ping times to suddenly become lagged,\n-    // due to a new block arriving or other large transfer.\n-    // Merely reporting pingtime might fool the caller into thinking the node was still responsive,\n-    // since pingtime does not update until the ping is complete, which might take a while.\n-    // So, if a ping is taking an unusually long time in flight,\n-    // the caller can immediately detect that this is happening.\n-    std::chrono::microseconds ping_wait{0};\n-    if ((0 != nPingNonceSent) && (0 != m_ping_start.load().count())) {\n-        ping_wait = GetTime<std::chrono::microseconds>() - m_ping_start.load();\n-    }\n-\n-    // Raw ping time is in microseconds, but show it to user as whole seconds (Bitcoin users should be well used to small numbers with many decimal places by now :)\n-    stats.m_ping_usec = nPingUsecTime;\n-    stats.m_min_ping_usec  = nMinPingUsecTime;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549492180",
      "id" : 549492180,
      "line" : 617,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ5MjE4MA==",
      "original_commit_id" : "2c1c3ec6e4e55c53157ec80f192331044e19d73d",
      "original_line" : 617,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 17,
      "pull_request_review_id" : 559267216,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549492180",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549497650"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549497650"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh hey, if s/m_min_ping_usec/m_best_ping_time then\r\n```\r\nX(m_best_ping_time);\r\n```\r\n(wow so clean)",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-28T21:50:35Z",
      "diff_hunk" : "@@ -609,22 +609,6 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n         stats.minFeeFilter = 0;\n     }\n \n-    // It is common for nodes with good ping times to suddenly become lagged,\n-    // due to a new block arriving or other large transfer.\n-    // Merely reporting pingtime might fool the caller into thinking the node was still responsive,\n-    // since pingtime does not update until the ping is complete, which might take a while.\n-    // So, if a ping is taking an unusually long time in flight,\n-    // the caller can immediately detect that this is happening.\n-    std::chrono::microseconds ping_wait{0};\n-    if ((0 != nPingNonceSent) && (0 != m_ping_start.load().count())) {\n-        ping_wait = GetTime<std::chrono::microseconds>() - m_ping_start.load();\n-    }\n-\n-    // Raw ping time is in microseconds, but show it to user as whole seconds (Bitcoin users should be well used to small numbers with many decimal places by now :)\n-    stats.m_ping_usec = nPingUsecTime;\n-    stats.m_min_ping_usec  = nMinPingUsecTime;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549497650",
      "id" : 549497650,
      "in_reply_to_id" : 549492180,
      "line" : 617,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ5NzY1MA==",
      "original_commit_id" : "2c1c3ec6e4e55c53157ec80f192331044e19d73d",
      "original_line" : 617,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 17,
      "pull_request_review_id" : 559313840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549497650",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549501774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549501774"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    std::atomic<int64_t> m_min_ping_time{std::numeric_limits<int64_t>::max()};\r\n```\r\nI think renaming from \"min\" to \"best\" needlessly sows confusion or more needed code churn for no gain:\r\n\r\n- \"min\" is more precise than \"best\" (best how?)\r\n- getpeerinfo and its help, -netinfo and its new help (#20764), and the GUI refer to \"min ping\", \"Min Ping\", \"mping\", \"minimum observed ping time\". Updating all of them would create unneeded churn; not updating them would create unnecessary confusion.\r\n",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-28T22:07:34Z",
      "diff_hunk" : "@@ -1048,17 +1046,7 @@ class CNode\n      * in CConnman::AttemptToEvictConnection. */\n     std::atomic<int64_t> nLastTXTime{0};\n \n-    // Ping time measurement:\n-    // The pong reply we're expecting, or 0 if no pong expected.\n-    std::atomic<uint64_t> nPingNonceSent{0};\n-    /** When the last ping was sent, or 0 if no ping was ever sent */\n-    std::atomic<std::chrono::microseconds> m_ping_start{0us};\n-    // Last measured round-trip time.\n-    std::atomic<int64_t> nPingUsecTime{0};\n-    // Best measured round-trip time.\n-    std::atomic<int64_t> nMinPingUsecTime{std::numeric_limits<int64_t>::max()};\n-    // Whether a ping is requested.\n-    std::atomic<bool> fPingQueued{false};\n+    std::atomic<int64_t> m_best_ping_time{std::numeric_limits<int64_t>::max()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549501774",
      "id" : 549501774,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwMTc3NA==",
      "original_commit_id" : "6f0309b4743d05c512fc86d2d206f72d512c5c93",
      "original_line" : 1049,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 559317841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549501774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549502248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549502248"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you use named casts in lines 234 and 237 while touching this code?\r\n\r\nhttps://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines.html#Res-casts-named\r\n",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-28T22:09:48Z",
      "diff_hunk" : "@@ -237,6 +230,12 @@ static RPCHelpMan getpeerinfo()\n                 heights.push_back(height);\n             }\n             obj.pushKV(\"inflight\", heights);\n+            if (statestats.m_ping_usec > 0) {\n+                obj.pushKV(\"pingtime\", ((double)statestats.m_ping_usec) / 1e6);\n+            }\n+            if (statestats.m_ping_wait_usec > 0) {\n+                obj.pushKV(\"pingwait\", ((double)statestats.m_ping_wait_usec) / 1e6);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549502248",
      "id" : 549502248,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwMjI0OA==",
      "original_commit_id" : "6f0309b4743d05c512fc86d2d206f72d512c5c93",
      "original_line" : 228,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 559317841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549502248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-28T23:05:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-751890762",
      "id" : 751890762,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MTg5MDc2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-28T23:05:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/751890762",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549648962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549648962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just so that the commits are hygienic. For people reviewing commit by commit, it wouldn't make sense to have a function that returns a bool which is just ignored. Changing the return type in a subsequent commit is as easy as changing void to bool in the declaration and definition.\r\n\r\nI was considering not returning a bool here, since it's a bit of a strange interface (the function sets `pto.fDisconnect` _and_ returns false. Perhaps it should stay as returning `void`, and have `SendMessages()` check for `fDisconnect` after calling this function?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-29T10:16:40Z",
      "diff_hunk" : "@@ -217,6 +217,9 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /** Send a ping message on a regular schedule or if requested manually */\n+    void MaybeSendPing(CNode* pto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549648962",
      "id" : 549648962,
      "in_reply_to_id" : 549455568,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0ODk2Mg==",
      "original_commit_id" : "9466feef40aec209c2a3975fa04e75e0f90f42b5",
      "original_line" : 221,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 559465988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549648962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549656149"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549656149"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch! I lost this in a rebase. I've now restored it.\r\n\r\nI'm going to leave the `m_min_ping_usec` name to avoid increasing the diff further.\r\n",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-29T10:39:21Z",
      "diff_hunk" : "@@ -609,22 +609,6 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n         stats.minFeeFilter = 0;\n     }\n \n-    // It is common for nodes with good ping times to suddenly become lagged,\n-    // due to a new block arriving or other large transfer.\n-    // Merely reporting pingtime might fool the caller into thinking the node was still responsive,\n-    // since pingtime does not update until the ping is complete, which might take a while.\n-    // So, if a ping is taking an unusually long time in flight,\n-    // the caller can immediately detect that this is happening.\n-    std::chrono::microseconds ping_wait{0};\n-    if ((0 != nPingNonceSent) && (0 != m_ping_start.load().count())) {\n-        ping_wait = GetTime<std::chrono::microseconds>() - m_ping_start.load();\n-    }\n-\n-    // Raw ping time is in microseconds, but show it to user as whole seconds (Bitcoin users should be well used to small numbers with many decimal places by now :)\n-    stats.m_ping_usec = nPingUsecTime;\n-    stats.m_min_ping_usec  = nMinPingUsecTime;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549656149",
      "id" : 549656149,
      "in_reply_to_id" : 549492180,
      "line" : 617,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1NjE0OQ==",
      "original_commit_id" : "2c1c3ec6e4e55c53157ec80f192331044e19d73d",
      "original_line" : 617,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 17,
      "pull_request_review_id" : 559474533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549656149",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549656532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549656532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree. I've changed it to `m_min_ping_time` (it's still code churn since it was previously named `nMinPingUsecTime`, but I agree with you about the consistent naming).",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-29T10:40:47Z",
      "diff_hunk" : "@@ -1048,17 +1046,7 @@ class CNode\n      * in CConnman::AttemptToEvictConnection. */\n     std::atomic<int64_t> nLastTXTime{0};\n \n-    // Ping time measurement:\n-    // The pong reply we're expecting, or 0 if no pong expected.\n-    std::atomic<uint64_t> nPingNonceSent{0};\n-    /** When the last ping was sent, or 0 if no ping was ever sent */\n-    std::atomic<std::chrono::microseconds> m_ping_start{0us};\n-    // Last measured round-trip time.\n-    std::atomic<int64_t> nPingUsecTime{0};\n-    // Best measured round-trip time.\n-    std::atomic<int64_t> nMinPingUsecTime{std::numeric_limits<int64_t>::max()};\n-    // Whether a ping is requested.\n-    std::atomic<bool> fPingQueued{false};\n+    std::atomic<int64_t> m_best_ping_time{std::numeric_limits<int64_t>::max()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549656532",
      "id" : 549656532,
      "in_reply_to_id" : 549501774,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1NjUzMg==",
      "original_commit_id" : "6f0309b4743d05c512fc86d2d206f72d512c5c93",
      "original_line" : 1049,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 559474998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549656532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549660285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549660285"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd rather not change this while moving it. There's another C-style cast from int64_t to double on line 206. Let's fix them all at the same time.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-29T10:53:31Z",
      "diff_hunk" : "@@ -237,6 +230,12 @@ static RPCHelpMan getpeerinfo()\n                 heights.push_back(height);\n             }\n             obj.pushKV(\"inflight\", heights);\n+            if (statestats.m_ping_usec > 0) {\n+                obj.pushKV(\"pingtime\", ((double)statestats.m_ping_usec) / 1e6);\n+            }\n+            if (statestats.m_ping_wait_usec > 0) {\n+                obj.pushKV(\"pingwait\", ((double)statestats.m_ping_wait_usec) / 1e6);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549660285",
      "id" : 549660285,
      "in_reply_to_id" : 549502248,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY2MDI4NQ==",
      "original_commit_id" : "6f0309b4743d05c512fc86d2d206f72d512c5c93",
      "original_line" : 228,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 559479548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549660285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the reviews, @glozow and @jonatack. I've addressed your comments: https://github.com/bitcoin/bitcoin/compare/6f0309b4743d05c512fc86d2d206f72d512c5c93..d666804b7b2d5006c37b86f5f88e344216ad0862.",
      "created_at" : "2020-12-29T10:56:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-752034748",
      "id" : 752034748,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjAzNDc0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T10:56:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752034748",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-12-29T11:01:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-752036122",
      "id" : 752036122,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjAzNjEyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T11:01:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752036122",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Genuine question, why should best ping time be in CNode but all the others in Peer? We use best ping time for eviction logic which seems like an application-layer thing...\r\n\r\nThis is a very good question. I haven't specified the difference between connection-layer and application-layer well enough with respect to ping times.\r\n\r\nFunctionally, ping times are used in two places: timeout logic and eviction logic (they're also presented to the user through the RPC and GUI, but that doesn't affect what follows). \r\n\r\n##### Timeout logic\r\n\r\nThere's timeout logic in the connection layer (in `InactivityCheck()`), which should detect when there's a problem with the connection, such as:\r\n\r\n- no bytes being sent or received on the connection\r\n- a connection is opened, but no application data received.\r\n\r\nThere's also timeout logic in the application layer, such as here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/f1f26b8d5baec4a45a3a9ba0440cd4eff7af8407/src/net_processing.cpp#L4527-L4528\r\n\r\nwhere we detect if block download has timed out. Ping timeouts belong in the application layer, since failing to respond to a ping message with a pong message is a P2P protocol violation. However, that ping timeout logic has previously existed in net.cpp because the ping data existed in CNode. In this PR, we move the ping timout logic to the application layer, where it logically belongs. This logic requires the `nPingNonceSent`, `m_ping_start` and `fPingQueued` data to be in the net_processing layer.\r\n\r\n(You may be asking the question: \"isn't the connection layer timeout logic somewhat redundant with the ping timeout logic?\" and you'd be right - if pings are not timing out, then we must be sending/receiving data from the peer, so the connection cannot time out. However, a bit of redundancy here is fine - the net layer is responsible for maintaining the data connection, and the net_processing layer is responsible for maintaining the p2p protocol peering.)\r\n\r\n##### Inbound eviction logic\r\n\r\nThis exists entirely in the connection layer, in `CConnman::AttemptToEvictConnection()`. It requires data from both the connection layer (e.g. connection time, connection type, whether the connection is local, etc) and from the application layer (e.g. last block received time, last tx received time, etc). For that to work, the application layer must inform the connection layer of events, such as a valid tx received, a valid block received, and (now) a valid pong received, and the connection layer must store that data (as `nLastBlockTime`, `nLastTXTime` and `m_min_ping_time`) for use in the eviction logic. We could group those members in a structure called `EvictionCriteria` or similar to make it clearer what they're used for. For now, I've just expanded the comment for `m_min_ping_time`.\r\n\r\nWriting this has made me realize that `nPingUsecTime` should probably stay in `CNode`, since it doesn't need to be used for any application logic. I've done that in the latest force-push.",
      "created_at" : "2020-12-29T12:05:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-752052378",
      "id" : 752052378,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjA1MjM3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T12:05:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752052378",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549679809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549679809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Answered here: https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-752052378",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2020-12-29T12:05:25Z",
      "diff_hunk" : "@@ -1048,17 +1046,7 @@ class CNode\n      * in CConnman::AttemptToEvictConnection. */\n     std::atomic<int64_t> nLastTXTime{0};\n \n-    // Ping time measurement:\n-    // The pong reply we're expecting, or 0 if no pong expected.\n-    std::atomic<uint64_t> nPingNonceSent{0};\n-    /** When the last ping was sent, or 0 if no ping was ever sent */\n-    std::atomic<std::chrono::microseconds> m_ping_start{0us};\n-    // Last measured round-trip time.\n-    std::atomic<int64_t> nPingUsecTime{0};\n-    // Best measured round-trip time.\n     std::atomic<int64_t> nMinPingUsecTime{std::numeric_limits<int64_t>::max()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r549679809",
      "id" : 549679809,
      "in_reply_to_id" : 549486291,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY3OTgwOQ==",
      "original_commit_id" : "2c1c3ec6e4e55c53157ec80f192331044e19d73d",
      "original_line" : 1049,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 559503127,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549679809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ping timeouts are being triggered on feature_bip68_sequence.py test when run on cirrus. That test uses lots of mocktime jumps, so it's not surprising. I'll see if there's a way to make sure that pings don't timeout when using mocktime.",
      "created_at" : "2020-12-29T19:58:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-752222792",
      "id" : 752222792,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjIyMjc5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T19:58:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752222792",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> This exists entirely in the connection layer, in `CConnman::AttemptToEvictConnection()`. It requires data from both the connection layer (e.g. connection time, connection type, whether the connection is local, etc)\r\n\r\nNot convinced that makes sense -- \"connection type\" and \"how many local connections to evict\" both seem like application logic to me. I was certainly expecting `m_conn_type` to eventually make its way into net_processing, given it deals with message types (block/tx relay/addrfetch/feeler) and trust issues (inbound/outbound/manual) which are all application level concepts.",
      "created_at" : "2020-12-30T03:11:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-752311889",
      "id" : 752311889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjMxMTg4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-30T03:11:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752311889",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-02T09:09:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-753450336",
      "id" : 753450336,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzQ1MDMzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-02T09:09:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753450336",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm going to hold off rebasing this until https://github.com/bitcoin/bitcoin/pull/20811 lands. Once #20811 is merged, we'll be able to continue this series of PRs with much less churn in the header files. Marking as draft for now.",
      "created_at" : "2021-01-02T09:46:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-753453152",
      "id" : 753453152,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzQ1MzE1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-07T19:48:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753453152",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've rebased on master now that #20811 is merge and added a (hidden) `-pingtimeout` option which avoids having to expose `Peer` to the tests.\r\n\r\nThere are still a couple of tests timing out, which I'll fix up next.",
      "created_at" : "2021-01-13T14:30:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-759485838",
      "id" : 759485838,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1OTQ4NTgzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-13T14:30:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/759485838",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm going to leave this as WIP for now. I think #20927 should go in before this to make review of this PR easier. Please review that PR first.",
      "created_at" : "2021-01-13T16:40:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-759572472",
      "id" : 759572472,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1OTU3MjQ3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-13T16:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/759572472",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r557610974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557610974"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: docs specify minimum is 1, but it seems here min is 0?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-01-14T18:42:13Z",
      "diff_hunk" : "@@ -1143,6 +1144,10 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"peertimeout cannot be configured with a negative value.\"));\n     }\n \n+    if (args.GetArg(\"-pingtimeout\", TIMEOUT_INTERVAL) <= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r557610974",
      "id" : 557610974,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYxMDk3NA==",
      "original_commit_id" : "eddbcc18b4fc81c0092f7a167e8b5677b683213f",
      "original_line" : 1148,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 568519172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557610974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r558839703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558839703"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This error condition is hit if `pingtimeout` is set to 0.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-01-16T10:56:34Z",
      "diff_hunk" : "@@ -1143,6 +1144,10 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"peertimeout cannot be configured with a negative value.\"));\n     }\n \n+    if (args.GetArg(\"-pingtimeout\", TIMEOUT_INTERVAL) <= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r558839703",
      "id" : 558839703,
      "in_reply_to_id" : 557610974,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODgzOTcwMw==",
      "original_commit_id" : "eddbcc18b4fc81c0092f7a167e8b5677b683213f",
      "original_line" : 1148,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 569900170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558839703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pushed a fix for the intermittent ping timeout in wallet_resendwallettransactions.py",
      "created_at" : "2021-01-16T11:04:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-761544843",
      "id" : 761544843,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MTU0NDg0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-16T11:04:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/761544843",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased on master. All tests are now passing for me locally. Marking this as ready for review.",
      "created_at" : "2021-01-23T11:14:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-765907224",
      "id" : 765907224,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NTkwNzIyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-23T11:14:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/765907224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-29T08:11:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-769649943",
      "id" : 769649943,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTY0OTk0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-29T08:11:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769649943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2021-01-29T09:25:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-769687320",
      "id" : 769687320,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTY4NzMyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-29T09:25:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769687320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r567464686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567464686"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Are cases where the response is malformed (e.g. user inputs a string instead of a number) handled elsewhere?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-01-31T18:26:50Z",
      "diff_hunk" : "@@ -1144,6 +1145,10 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"peertimeout cannot be configured with a negative value.\"));\n     }\n \n+    if (args.GetArg(\"-pingtimeout\", TIMEOUT_INTERVAL) <= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r567464686",
      "id" : 567464686,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzQ2NDY4Ng==",
      "original_commit_id" : "2cfa278c355f22d9396b58d346f2c485e8763bfb",
      "original_line" : 1148,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 579920941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567464686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/708562?v=4",
         "events_url" : "https://api.github.com/users/murtyjones/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murtyjones/followers",
         "following_url" : "https://api.github.com/users/murtyjones/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murtyjones/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murtyjones",
         "id" : 708562,
         "login" : "murtyjones",
         "node_id" : "MDQ6VXNlcjcwODU2Mg==",
         "organizations_url" : "https://api.github.com/users/murtyjones/orgs",
         "received_events_url" : "https://api.github.com/users/murtyjones/received_events",
         "repos_url" : "https://api.github.com/users/murtyjones/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murtyjones/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murtyjones/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murtyjones"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r567465455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567465455"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Are the inner sets of parenthesis required or is this a code-style thing?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-01-31T18:33:03Z",
      "diff_hunk" : "@@ -1060,6 +1072,18 @@ bool PeerManagerImpl::GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats)\n     PeerRef peer = GetPeerRef(nodeid);\n     if (peer == nullptr) return false;\n     stats.m_starting_height = peer->m_starting_height;\n+    // It is common for nodes with good ping times to suddenly become lagged,\n+    // due to a new block arriving or other large transfer.\n+    // Merely reporting pingtime might fool the caller into thinking the node was still responsive,\n+    // since pingtime does not update until the ping is complete, which might take a while.\n+    // So, if a ping is taking an unusually long time in flight,\n+    // the caller can immediately detect that this is happening.\n+    std::chrono::microseconds ping_wait{0};\n+    if ((0 != peer->m_ping_nonce_sent) && (0 != peer->m_ping_start.load().count())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r567465455",
      "id" : 567465455,
      "line" : 1111,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzQ2NTQ1NQ==",
      "original_commit_id" : "2cfa278c355f22d9396b58d346f2c485e8763bfb",
      "original_line" : 1111,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 56,
      "pull_request_review_id" : 579921461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567465455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/708562?v=4",
         "events_url" : "https://api.github.com/users/murtyjones/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murtyjones/followers",
         "following_url" : "https://api.github.com/users/murtyjones/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murtyjones/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murtyjones",
         "id" : 708562,
         "login" : "murtyjones",
         "node_id" : "MDQ6VXNlcjcwODU2Mg==",
         "organizations_url" : "https://api.github.com/users/murtyjones/orgs",
         "received_events_url" : "https://api.github.com/users/murtyjones/received_events",
         "repos_url" : "https://api.github.com/users/murtyjones/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murtyjones/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murtyjones/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murtyjones"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r567520925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567520925"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    // Don't let pings time out due to mocktime\r\n```",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-01T01:34:46Z",
      "diff_hunk" : "@@ -83,6 +83,9 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n     auto peerLogic = PeerManager::make(chainparams, *connman, nullptr, *m_node.scheduler,\n                                        *m_node.chainman, *m_node.mempool, false);\n \n+    // Don't let pings time out",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r567520925",
      "id" : 567520925,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUyMDkyNQ==",
      "original_commit_id" : "9099ee6f6b5102a5cb71f3b6f0c8322ed3003286",
      "original_line" : 86,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 579965301,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567520925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r567521625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567521625"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(Rookie question) Would the previous commit(9ad48f3965a32a6eba67ba49da19499fbe9b89e3) change anything with respect to mocktime unless `-pingtimeout` is used?  If not, why did some tests start to fail due to ping timeouts?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-01T01:38:00Z",
      "diff_hunk" : "@@ -33,6 +33,7 @@ def set_test_params(self):\n             [\n                 \"-acceptnonstdtxn=1\",\n                 \"-peertimeout=9999\",  # bump because mocktime might cause a disconnect otherwise\n+                \"-pingtimeout=9999\",  # bump because mocktime might cause a disconnect otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r567521625",
      "id" : 567521625,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUyMTYyNQ==",
      "original_commit_id" : "9099ee6f6b5102a5cb71f3b6f0c8322ed3003286",
      "original_line" : 36,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/feature_bip68_sequence.py",
      "position" : null,
      "pull_request_review_id" : 579965301,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567521625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568013403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568013403"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    /** Send a ping message every PING_INTERVAL or if requested via rpc. Disconnect\r\n     * the peer if a ping has timed out. Return true upon disconnection. */\r\n    [[nodiscard]] bool ManagePing(CNode& node_to);\r\n```",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-01T17:38:52Z",
      "diff_hunk" : "@@ -315,7 +315,8 @@ class PeerManagerImpl final : public PeerManager\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n-    /** Send a ping message on a regular schedule or if requested manually */\n+    /** Send a ping message on a regular schedule or if requested manually. May\n+     *  disconnect the peer if a ping has timed out. */\n     void MaybeSendPing(CNode& node_to);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568013403",
      "id" : 568013403,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODAxMzQwMw==",
      "original_commit_id" : "f53ee86f489ba3f6e3c12edea1d869135c2c2dcf",
      "original_line" : 320,
      "original_position" : 7,
      "original_start_line" : 318,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 579965301,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568013403",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568643037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568643037"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, these aren't required. In C++ `&&` has a lower precedence than `!=` so the parens aren't changing the order of operations (https://en.cppreference.com/w/cpp/language/operator_precedence). They're not doing any harm either.\r\n\r\nThis code is moved unaltered in this PR. I think it's fine to keep it as it is.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-02T14:27:15Z",
      "diff_hunk" : "@@ -1060,6 +1072,18 @@ bool PeerManagerImpl::GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats)\n     PeerRef peer = GetPeerRef(nodeid);\n     if (peer == nullptr) return false;\n     stats.m_starting_height = peer->m_starting_height;\n+    // It is common for nodes with good ping times to suddenly become lagged,\n+    // due to a new block arriving or other large transfer.\n+    // Merely reporting pingtime might fool the caller into thinking the node was still responsive,\n+    // since pingtime does not update until the ping is complete, which might take a while.\n+    // So, if a ping is taking an unusually long time in flight,\n+    // the caller can immediately detect that this is happening.\n+    std::chrono::microseconds ping_wait{0};\n+    if ((0 != peer->m_ping_nonce_sent) && (0 != peer->m_ping_start.load().count())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568643037",
      "id" : 568643037,
      "in_reply_to_id" : 567465455,
      "line" : 1111,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY0MzAzNw==",
      "original_commit_id" : "2cfa278c355f22d9396b58d346f2c485e8763bfb",
      "original_line" : 1111,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 56,
      "pull_request_review_id" : 581397957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568643037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568648896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568648896"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Argument handling is in `ArgsManager::GetArg()`. Since the second argument here is an int, the `GetArg(string, int)` version is called:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/1e69800d5e60c7805931f2c5b978720c6aee180b/src/util/system.cpp#L473-L477\r\n\r\nwhich will try to convert the string into an int.\r\n\r\nThis might result in a slightly inaccurate error message, but I think it's fine. It's the same behaviour as for `-peertimeout`:\r\n\r\n```\r\nâ ./src/bitcoind --pingtimeout=abc\r\nError: pingtimeout cannot be configured with a negative value.\r\n```",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-02T14:34:22Z",
      "diff_hunk" : "@@ -1144,6 +1145,10 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"peertimeout cannot be configured with a negative value.\"));\n     }\n \n+    if (args.GetArg(\"-pingtimeout\", TIMEOUT_INTERVAL) <= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568648896",
      "id" : 568648896,
      "in_reply_to_id" : 567464686,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY0ODg5Ng==",
      "original_commit_id" : "2cfa278c355f22d9396b58d346f2c485e8763bfb",
      "original_line" : 1148,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 581405777,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568648896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568649911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568649911"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sounds good. Added!",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-02T14:35:40Z",
      "diff_hunk" : "@@ -83,6 +83,9 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n     auto peerLogic = PeerManager::make(chainparams, *connman, nullptr, *m_node.scheduler,\n                                        *m_node.chainman, *m_node.mempool, false);\n \n+    // Don't let pings time out",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568649911",
      "id" : 568649911,
      "in_reply_to_id" : 567520925,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY0OTkxMQ==",
      "original_commit_id" : "9099ee6f6b5102a5cb71f3b6f0c8322ed3003286",
      "original_line" : 86,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 581407187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568649911",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568651714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568651714"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Previously, when ping timeouts were handled in `CConnman::InactivityCheck()`, the whole logic was gated on the following guard:\r\n\r\n```\r\n    if (now <= node.nTimeConnected + m_peer_connect_timeout) {\r\n        // Only run inactivity checks if the peer has been connected longer\r\n        // than m_peer_connect_timeout.\r\n        return false;\r\n    }\r\n```\r\n\r\nBecause tests generally run for less than m_peer_connect_timeout, the ping timeout logic was not hit at all. Once the logic moves to net_processing, that guard no longer exists, so we start testing for ping timeouts as soon as the peer is connected.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-02T14:37:47Z",
      "diff_hunk" : "@@ -33,6 +33,7 @@ def set_test_params(self):\n             [\n                 \"-acceptnonstdtxn=1\",\n                 \"-peertimeout=9999\",  # bump because mocktime might cause a disconnect otherwise\n+                \"-pingtimeout=9999\",  # bump because mocktime might cause a disconnect otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568651714",
      "id" : 568651714,
      "in_reply_to_id" : 567521625,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY1MTcxNA==",
      "original_commit_id" : "9099ee6f6b5102a5cb71f3b6f0c8322ed3003286",
      "original_line" : 36,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/feature_bip68_sequence.py",
      "position" : null,
      "pull_request_review_id" : 581409506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568651714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568655894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568655894"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've changed the signature to return a void, so the nodiscard tag is no longer required (good suggestion though!)\r\n\r\nI've taken the suggested comment changes.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-02T14:42:43Z",
      "diff_hunk" : "@@ -315,7 +315,8 @@ class PeerManagerImpl final : public PeerManager\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n-    /** Send a ping message on a regular schedule or if requested manually */\n+    /** Send a ping message on a regular schedule or if requested manually. May\n+     *  disconnect the peer if a ping has timed out. */\n     void MaybeSendPing(CNode& node_to);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r568655894",
      "id" : 568655894,
      "in_reply_to_id" : 568013403,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODY1NTg5NA==",
      "original_commit_id" : "f53ee86f489ba3f6e3c12edea1d869135c2c2dcf",
      "original_line" : 320,
      "original_position" : 7,
      "original_start_line" : 318,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 581414782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568655894",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I see around ~20 functional tests that use `setmocktime`... but you only added `-pingtimeout=9999` to two of them. Are you not worried about ping timeouts due to mocktime in any of the other tests?\r\n\r\n",
      "created_at" : "2021-02-03T15:52:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-772612030",
      "id" : 772612030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MjYxMjAzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-03T15:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/772612030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "concept ACK, tests pass locally, scripted diff verified in 4180381f683fad8755b30a3a8e65edc26c1ce5e2\r\nMakes sense to me, moves ping properties from `CNode` in net to `Peer` in net_processing.\r\nTesting also by running `src/bitcoind -pingtimeout=1 -signet` (didn't want to disrupt mainnet peers) and got some expected log messages:\r\n`2021-02-03T15:34:23Z ping timeout: 1.018515s peer=5`",
      "created_at" : "2021-02-03T16:47:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-772653640",
      "id" : 772653640,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MjY1MzY0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-03T16:47:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/772653640",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r569596508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569596508"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: Is it a bit pedantic to call it a `nonpositive value` here to include zero? \r\n\r\nAlthough I see it's consistent with `-peertimeout` error so that's probably why :)",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-03T17:19:04Z",
      "diff_hunk" : "@@ -1144,6 +1145,10 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"peertimeout cannot be configured with a negative value.\"));\n     }\n \n+    if (args.GetArg(\"-pingtimeout\", TIMEOUT_INTERVAL) <= 0) {\n+        return InitError(Untranslated(\"pingtimeout cannot be configured with a negative value.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r569596508",
      "id" : 569596508,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTU5NjUwOA==",
      "original_commit_id" : "4180381f683fad8755b30a3a8e65edc26c1ce5e2",
      "original_line" : 1149,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 582606411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569596508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/duncandean/events{/privacy}",
         "followers_url" : "https://api.github.com/users/duncandean/followers",
         "following_url" : "https://api.github.com/users/duncandean/following{/other_user}",
         "gists_url" : "https://api.github.com/users/duncandean/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/duncandean",
         "id" : 3072149,
         "login" : "duncandean",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/duncandean/orgs",
         "received_events_url" : "https://api.github.com/users/duncandean/received_events",
         "repos_url" : "https://api.github.com/users/duncandean/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/duncandean/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/duncandean/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/duncandean"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I see around ~20 functional tests that use setmocktime... but you only added -pingtimeout=9999 to two of them. Are you not worried about ping timeouts due to mocktime in any of the other tests?\r\n\r\n@pinheadmz I imagine it's only necessary where `setmocktime` does an increase of more than the default ping timeout.\r\n\r\nDug into this a little bit looking for `setmocktime` calls with big jumps - @jnewbery do you think [p2p_addr_relay.py](https://github.com/bitcoin/bitcoin/blob/ea96e17e1f2c2b0a949366260906ef02e560a425/test/functional/p2p_addr_relay.py#L75), [p2p_addrv2_relay.py](https://github.com/bitcoin/bitcoin/blob/ea96e17e1f2c2b0a949366260906ef02e560a425/test/functional/p2p_addrv2_relay.py#L72), and/or [p2p_getaddr_caching.py](https://github.com/bitcoin/bitcoin/blob/ea96e17e1f2c2b0a949366260906ef02e560a425/test/functional/p2p_getaddr_caching.py#L75-L76) need a `-pingtimeout`?\r\n\r\nAlso a question that may or may not be relevant - how do the inactivity timers handle when `setmocktime` goes backwards in time?",
      "created_at" : "2021-02-03T20:19:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-772795602",
      "id" : 772795602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3Mjc5NTYwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-03T20:38:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/772795602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570127729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570127729"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've changed to option to be a binary true/false, so this check is no longer required.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-04T10:51:43Z",
      "diff_hunk" : "@@ -1144,6 +1145,10 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"peertimeout cannot be configured with a negative value.\"));\n     }\n \n+    if (args.GetArg(\"-pingtimeout\", TIMEOUT_INTERVAL) <= 0) {\n+        return InitError(Untranslated(\"pingtimeout cannot be configured with a negative value.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570127729",
      "id" : 570127729,
      "in_reply_to_id" : 569596508,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDEyNzcyOQ==",
      "original_commit_id" : "4180381f683fad8755b30a3a8e65edc26c1ce5e2",
      "original_line" : 1149,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 583265090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570127729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've updated the `-pingtimeout` option to be a binary enable/disable. We don't need fine control over it in the tests, and it was essentially being used to disable ping timeouts entirely.\r\n\r\n> Dug into this a little bit looking for setmocktime calls with big jumps - @jnewbery do you think p2p_addr_relay.py, p2p_addrv2_relay.py, and/or p2p_getaddr_caching.py need a -pingtimeout?\r\n\r\nVery nice. Thanks @glozow. I've updated those tests to disable ping timeouts.\r\n\r\n> Also a question that may or may not be relevant - how do the inactivity timers handle when setmocktime goes backwards in time?\r\n\r\nThat's not a problem for the ping timeout. The ping timeout condition is `now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}` i.e. \"(the time now) is after (when the ping was sent) plus (the timeout interval)\". If time goes backwards, then (the time now) is decreased and we won't hit this condition.",
      "created_at" : "2021-02-04T11:09:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-773227475",
      "id" : 773227475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MzIyNzQ3NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-04T11:09:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/773227475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks everyone for the reviews. All comments have now been addressed.",
      "created_at" : "2021-02-04T11:10:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-773227934",
      "id" : 773227934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MzIyNzkzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-04T11:10:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/773227934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570598796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570598796"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "So would `-pingtimeout` means timeout=true? And `-nopingtimeout` is the same thing as `-pingtimeout=0`? I couldn't find where the implicit \"no\" logic was :( ",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-04T22:51:07Z",
      "diff_hunk" : "@@ -48,6 +48,7 @@ class AddrTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.setup_clean_chain = False\n         self.num_nodes = 1\n+        self.extra_args = [[\"-nopingtimeout\"]]  # mocktime might cause a disconnect otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570598796",
      "id" : 570598796,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDU5ODc5Ng==",
      "original_commit_id" : "17029adf43cb399f462d1550ac4e148bd7f6c0e7",
      "original_line" : 50,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 583882358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570598796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570606043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570606043"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I appreciate the added documentation ð \r\n\r\nnit\r\n```suggestion\r\n    /** We have completed a successful ping-pong keepalive. Update latest and best ping times. */\r\n```",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-04T23:06:56Z",
      "diff_hunk" : "@@ -713,6 +707,12 @@ class CNode\n \n     std::string ConnectionTypeAsString() const { return ::ConnectionTypeAsString(m_conn_type); }\n \n+    //* We have completed a successful ping-pong keepalive. Update latest and best ping times. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570606043",
      "id" : 570606043,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDYwNjA0Mw==",
      "original_commit_id" : "17029adf43cb399f462d1550ac4e148bd7f6c0e7",
      "original_line" : 710,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 583882358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570606043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570686167"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570686167"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it's done in [InterpretOption()](https://github.com/bitcoin/bitcoin/blob/ea5a50f92a6ff81b1d2dd67cdc3663e0e66733ac/src/util/system.cpp#L209) invoked from [ArgsManager::ParseParameters()](https://github.com/bitcoin/bitcoin/blob/ea5a50f92a6ff81b1d2dd67cdc3663e0e66733ac/src/util/system.cpp#L338) which is invoked in [AppInit()](https://github.com/bitcoin/bitcoin/blob/ea5a50f92a6ff81b1d2dd67cdc3663e0e66733ac/src/bitcoind.cpp#L43).",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-05T02:53:03Z",
      "diff_hunk" : "@@ -48,6 +48,7 @@ class AddrTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.setup_clean_chain = False\n         self.num_nodes = 1\n+        self.extra_args = [[\"-nopingtimeout\"]]  # mocktime might cause a disconnect otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570686167",
      "id" : 570686167,
      "in_reply_to_id" : 570598796,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDY4NjE2Nw==",
      "original_commit_id" : "17029adf43cb399f462d1550ac4e148bd7f6c0e7",
      "original_line" : 50,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 583984378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570686167",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570826114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570826114"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @dhruv!",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-05T09:18:13Z",
      "diff_hunk" : "@@ -48,6 +48,7 @@ class AddrTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.setup_clean_chain = False\n         self.num_nodes = 1\n+        self.extra_args = [[\"-nopingtimeout\"]]  # mocktime might cause a disconnect otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570826114",
      "id" : 570826114,
      "in_reply_to_id" : 570598796,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDgyNjExNA==",
      "original_commit_id" : "17029adf43cb399f462d1550ac4e148bd7f6c0e7",
      "original_line" : 50,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 584152431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570826114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570828055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570828055"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":facepalm: I've fixed the doxygen style and also tweaked the comment wording a bit.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-05T09:20:49Z",
      "diff_hunk" : "@@ -713,6 +707,12 @@ class CNode\n \n     std::string ConnectionTypeAsString() const { return ::ConnectionTypeAsString(m_conn_type); }\n \n+    //* We have completed a successful ping-pong keepalive. Update latest and best ping times. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r570828055",
      "id" : 570828055,
      "in_reply_to_id" : 570606043,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDgyODA1NQ==",
      "original_commit_id" : "17029adf43cb399f462d1550ac4e148bd7f6c0e7",
      "original_line" : 710,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 584154581,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/570828055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the reviews!\r\n\r\n> I feel like the interface would be more intuitive if it was just called -disablepingtimeout since it's an optional flag, but perhaps just personal preference?\r\n\r\nI think it's best to avoid negative configuration names. `-disablepingtimeout=0` would mean \"do not disable ping timeout\", which is a double negative and slightly harder to parse than \"enable ping timeout\". See other options like `-listen`, `-persistmempool`, etc, where the default is true, and `-nolisten`, `-nopersistmempool` is used to disable.\r\n\r\n> my suggestions still make sense to me and I remember lightlike mentioning wallet_resendwallettransactions.py failing so maybe it was a race, no pings in flight?\r\n\r\nRight, these are all races, so they won't fail consistently. I think it's just safer to disable pings timeouts on any test which makes large mocktime leaps.",
      "created_at" : "2021-02-05T09:24:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-773908504",
      "id" : 773908504,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MzkwODUwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-05T09:24:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/773908504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2021-02-05T09:41:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-773918182",
      "id" : 773918182,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MzkxODE4Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-05T09:41:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/773918182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r571087717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571087717"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ahhhh thank you @dhruv!",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-05T16:23:14Z",
      "diff_hunk" : "@@ -48,6 +48,7 @@ class AddrTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.setup_clean_chain = False\n         self.num_nodes = 1\n+        self.extra_args = [[\"-nopingtimeout\"]]  # mocktime might cause a disconnect otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r571087717",
      "id" : 571087717,
      "in_reply_to_id" : 570598796,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTA4NzcxNw==",
      "original_commit_id" : "17029adf43cb399f462d1550ac4e148bd7f6c0e7",
      "original_line" : 50,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 584496267,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571087717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK https://github.com/bitcoin/bitcoin/pull/20721/commits/bbd970a2123aec5071dd3dd901e478844c6e0fea ð¿ \r\n\r\nThe negative config option stuff makes more sense to me now, thanks for explaining!",
      "created_at" : "2021-02-05T16:36:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-774143603",
      "id" : 774143603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NDE0MzYwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-05T16:36:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/774143603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Light Code-Review ACK bbd970a2123aec5071dd3dd901e478844c6e0fea\r\n\r\nThis may have been answered before but could someone tell me the exact sequence of events in the test framework involving `setmocktime` that would make `-nopingtimeout` necessary? My naive reading is that `send_and_ping` blocks until it receives the `pong` and is therefore not going to timeout if the next call is a `setmocktime`.\r\n\r\nI'll also do a deeper read into `[net processing] Move ping timeout logic to net processing` later this week to make sure that this move is indeed safe and doesn't cause us to miss any opportunities to disconnect a peer.",
      "created_at" : "2021-02-08T21:17:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-775468156",
      "id" : 775468156,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTQ2ODE1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-08T21:17:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775468156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572489932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572489932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "just noting that this changed from `>=` to `>`. makes sense to call it a \"timing mishap\" if the pong was received in the same microsecond as we recorded for the ping going out, so seems fine. just highlighting the change since it's easy to miss. ",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T01:01:24Z",
      "diff_hunk" : "@@ -3811,15 +3837,14 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             vRecv >> nonce;\n \n             // Only process pong message if there is an outstanding ping (old ping without nonce should never pong)\n-            if (pfrom.nPingNonceSent != 0) {\n-                if (nonce == pfrom.nPingNonceSent) {\n+            if (peer->nPingNonceSent != 0) {\n+                if (nonce == peer->nPingNonceSent) {\n                     // Matching pong received, this ping is no longer outstanding\n                     bPingFinished = true;\n-                    const auto ping_time = ping_end - pfrom.m_ping_start.load();\n-                    if (ping_time.count() >= 0) {\n-                        // Successful ping time measurement, replace previous\n-                        pfrom.nPingUsecTime = count_microseconds(ping_time);\n-                        pfrom.nMinPingUsecTime = std::min(pfrom.nMinPingUsecTime.load(), count_microseconds(ping_time));\n+                    const auto ping_time = ping_end - peer->m_ping_start.load();\n+                    if (ping_time.count() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572489932",
      "id" : 572489932,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjQ4OTkzMg==",
      "original_commit_id" : "831f8c36e2f7e8f4af136a306b428a30072e5fcf",
      "original_line" : 3845,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 586061906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572489932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572493215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572493215"
         }
      },
      "author_association" : "MEMBER",
      "body" : "tangential because you didn't change this logic, but what's the point of sending a ping message to peers who are too old to support / respond with a pong?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T01:10:38Z",
      "diff_hunk" : "@@ -4286,50 +4289,56 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n-\n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (node_to.fPingQueued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (node_to.nPingNonceSent == 0 && node_to.m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        node_to.fPingQueued = false;\n+        node_to.m_ping_start = GetTime<std::chrono::microseconds>();\n+        if (node_to.GetCommonVersion() > BIP0031_VERSION) {\n+            node_to.nPingNonceSent = nonce;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING, nonce));\n         } else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572493215",
      "id" : 572493215,
      "line" : 4360,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjQ5MzIxNQ==",
      "original_commit_id" : "f6e13955d46c6d5fdca08607cf781ea7ebd3a41d",
      "original_line" : 4360,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 205,
      "pull_request_review_id" : 586061906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572493215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572493715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572493715"
         }
      },
      "author_association" : "MEMBER",
      "body" : "isn't this more of a `PongReceived`?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T01:12:14Z",
      "diff_hunk" : "@@ -716,6 +710,12 @@ class CNode\n \n     std::string ConnectionTypeAsString() const { return ::ConnectionTypeAsString(m_conn_type); }\n \n+    /** A ping-pong keepalive has completed successfully. Update latest and minimum ping times. */\n+    void PingReceived(std::chrono::microseconds ping_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572493715",
      "id" : 572493715,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjQ5MzcxNQ==",
      "original_commit_id" : "831f8c36e2f7e8f4af136a306b428a30072e5fcf",
      "original_line" : 714,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 586061906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572493715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572499884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572499884"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this comment previously followed the `fSuccesfullyConnected` check, which I think(?) was the intent -> `fSuccesfullyConnected` is set when processing the `VERACK` message, and `m_greatest_common_version` gets set when processing the `VERSION` message.\r\n\r\nbut now this comment is below `MaybeSendPing`, which also might retrieve `m_greatest_common_version` to construct the ping message. I find the intent of this comment to be less clear after these changes.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T01:24:49Z",
      "diff_hunk" : "@@ -4286,50 +4315,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - peer.m_ping_start.load()), peer.m_id);\n+        node_to.fDisconnect = true;\n+        return;\n+    }\n \n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (peer.m_ping_queued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (peer.m_ping_nonce_sent == 0 && now > peer.m_ping_start.load() + PING_INTERVAL) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        peer.m_ping_queued = false;\n+        peer.m_ping_start = GetTime<std::chrono::microseconds>();\n+        if (node_to.GetCommonVersion() > BIP0031_VERSION) {\n+            peer.m_ping_nonce_sent = nonce;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING, nonce));\n         } else {\n             // Peer is too old to support ping command with nonce, pong will never arrive.\n-            pto->nPingNonceSent = 0;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING));\n+            peer.m_ping_nonce_sent = 0;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING));\n         }\n     }\n+}\n+\n+bool PeerManagerImpl::SendMessages(CNode* pto)\n+{\n+    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n+    // disconnect misbehaving peers even before the version handshake is complete.\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n+\n+    // Don't send anything until the version handshake is complete\n+    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n+        return true;\n+\n+    PeerRef peer = GetPeerRef(pto->GetId());\n+\n+    MaybeSendPing(*pto, *peer);\n+\n+    // MaybeSendPing may have marked peer for disconnection\n+    if (pto->fDisconnect) return true;\n+\n+    // If we get here, the outgoing message serialization version is set and can't change.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572499884",
      "id" : 572499884,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjQ5OTg4NA==",
      "original_commit_id" : "bbd970a2123aec5071dd3dd901e478844c6e0fea",
      "original_line" : 4380,
      "original_position" : 194,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 586061906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572499884",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572501852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572501852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I know you only moved this code, but I think we could handle `fDisconnect` better. \r\n\r\nThis comment seems misleading since I think it only refers to `fSuccesfullyConnected`. Then, we might set `fDisconnect` to true in `MaybeSendPing`, so we check this bool again a couple lines down to also return early.\r\n\r\nA simpler logic flow might be removing this check here, starting `MaybeSendPing` with `return if node_to.fDisconnect`, and then removing this first early return from `SendMessages`. And the comment on 4377 could be updated to something along the lines of `Don't send messages to peers that are marked for disconnection`",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T01:29:54Z",
      "diff_hunk" : "@@ -4286,50 +4315,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - peer.m_ping_start.load()), peer.m_id);\n+        node_to.fDisconnect = true;\n+        return;\n+    }\n \n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (peer.m_ping_queued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (peer.m_ping_nonce_sent == 0 && now > peer.m_ping_start.load() + PING_INTERVAL) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        peer.m_ping_queued = false;\n+        peer.m_ping_start = GetTime<std::chrono::microseconds>();\n+        if (node_to.GetCommonVersion() > BIP0031_VERSION) {\n+            peer.m_ping_nonce_sent = nonce;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING, nonce));\n         } else {\n             // Peer is too old to support ping command with nonce, pong will never arrive.\n-            pto->nPingNonceSent = 0;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING));\n+            peer.m_ping_nonce_sent = 0;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING));\n         }\n     }\n+}\n+\n+bool PeerManagerImpl::SendMessages(CNode* pto)\n+{\n+    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n+    // disconnect misbehaving peers even before the version handshake is complete.\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n+\n+    // Don't send anything until the version handshake is complete",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572501852",
      "id" : 572501852,
      "line" : 4399,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjUwMTg1Mg==",
      "original_commit_id" : "bbd970a2123aec5071dd3dd901e478844c6e0fea",
      "original_line" : 4399,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 228,
      "pull_request_review_id" : 586061906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572501852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572502484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572502484"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    /** Send a ping message every PING_INTERVAL or if requested via RPC. May  \r\n     *  mark the peer to be disconnected if a ping has timed out. */\r\n```",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T01:31:45Z",
      "diff_hunk" : "@@ -315,6 +323,10 @@ class PeerManagerImpl final : public PeerManager\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n+     *  disconnect the peer if a ping has timed out. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572502484",
      "id" : 572502484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjUwMjQ4NA==",
      "original_commit_id" : "bbd970a2123aec5071dd3dd901e478844c6e0fea",
      "original_line" : 327,
      "original_position" : 27,
      "original_start_line" : 326,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 586061906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572502484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572503697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572503697"
         }
      },
      "author_association" : "MEMBER",
      "body" : "another comment on code that you simply moved-\r\n\r\nI found this definition odd. Why is it defined as an int but set as a boolean? Also, why is it an `int64_t`, that seems like more space needed than for a simple bool value? \r\n\r\nalso note that this could be constexpr, but I don't know if that actually impacts anything. I tried it out in [godbolt explorer](https://godbolt.org/z/61anP3) and looks like for such simple  logic, it compiled down to the same assembly regardless ð¤·ð½ââï¸",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T01:35:21Z",
      "diff_hunk" : "@@ -25,11 +25,14 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** -pingtimeout default */\n+static const int64_t DEFAULT_PING_TIMEOUT = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572503697",
      "id" : 572503697,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjUwMzY5Nw==",
      "original_commit_id" : "bbd970a2123aec5071dd3dd901e478844c6e0fea",
      "original_line" : 29,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 586061906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572503697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572777257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572777257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "pong messages were introduced in 2012 with p2p version 60000. I imagine that prior to that, the reason for a ping message was simply a keepalive (make sure that TCP connections stay up, NAT pinholes stay open, etc). This logic maintains backwards compatibility with clients older than 60000.\r\n\r\nIn practice, I expect there are almost no clients older than 60000, but if there are any it'd be a shame to arbitrarily disconnect them for failing ping timeouts.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T10:44:03Z",
      "diff_hunk" : "@@ -4286,50 +4289,56 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n-\n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (node_to.fPingQueued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (node_to.nPingNonceSent == 0 && node_to.m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        node_to.fPingQueued = false;\n+        node_to.m_ping_start = GetTime<std::chrono::microseconds>();\n+        if (node_to.GetCommonVersion() > BIP0031_VERSION) {\n+            node_to.nPingNonceSent = nonce;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING, nonce));\n         } else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572777257",
      "id" : 572777257,
      "in_reply_to_id" : 572493215,
      "line" : 4360,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc3NzI1Nw==",
      "original_commit_id" : "f6e13955d46c6d5fdca08607cf781ea7ebd3a41d",
      "original_line" : 4360,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 205,
      "pull_request_review_id" : 586407170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572777257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572778977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572778977"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a comment on the line below, which is contructing a `CNetMsgMaker` object with the correct serialization version:\r\n\r\n`const CNetMsgMaker msgMaker(pto->GetCommonVersion());`",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T10:46:01Z",
      "diff_hunk" : "@@ -4286,50 +4315,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - peer.m_ping_start.load()), peer.m_id);\n+        node_to.fDisconnect = true;\n+        return;\n+    }\n \n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (peer.m_ping_queued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (peer.m_ping_nonce_sent == 0 && now > peer.m_ping_start.load() + PING_INTERVAL) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        peer.m_ping_queued = false;\n+        peer.m_ping_start = GetTime<std::chrono::microseconds>();\n+        if (node_to.GetCommonVersion() > BIP0031_VERSION) {\n+            peer.m_ping_nonce_sent = nonce;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING, nonce));\n         } else {\n             // Peer is too old to support ping command with nonce, pong will never arrive.\n-            pto->nPingNonceSent = 0;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING));\n+            peer.m_ping_nonce_sent = 0;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING));\n         }\n     }\n+}\n+\n+bool PeerManagerImpl::SendMessages(CNode* pto)\n+{\n+    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n+    // disconnect misbehaving peers even before the version handshake is complete.\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n+\n+    // Don't send anything until the version handshake is complete\n+    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n+        return true;\n+\n+    PeerRef peer = GetPeerRef(pto->GetId());\n+\n+    MaybeSendPing(*pto, *peer);\n+\n+    // MaybeSendPing may have marked peer for disconnection\n+    if (pto->fDisconnect) return true;\n+\n+    // If we get here, the outgoing message serialization version is set and can't change.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572778977",
      "id" : 572778977,
      "in_reply_to_id" : 572499884,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc3ODk3Nw==",
      "original_commit_id" : "bbd970a2123aec5071dd3dd901e478844c6e0fea",
      "original_line" : 4380,
      "original_position" : 194,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 586410533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572778977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572782743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572782743"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That seems like a reasonable change, but I'm not sure it needs to happen in this PR. Very happy to review a PR that moves this around if you think it'd make it clearer.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T10:49:09Z",
      "diff_hunk" : "@@ -4286,50 +4315,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - peer.m_ping_start.load()), peer.m_id);\n+        node_to.fDisconnect = true;\n+        return;\n+    }\n \n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (peer.m_ping_queued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (peer.m_ping_nonce_sent == 0 && now > peer.m_ping_start.load() + PING_INTERVAL) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        peer.m_ping_queued = false;\n+        peer.m_ping_start = GetTime<std::chrono::microseconds>();\n+        if (node_to.GetCommonVersion() > BIP0031_VERSION) {\n+            peer.m_ping_nonce_sent = nonce;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING, nonce));\n         } else {\n             // Peer is too old to support ping command with nonce, pong will never arrive.\n-            pto->nPingNonceSent = 0;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING));\n+            peer.m_ping_nonce_sent = 0;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING));\n         }\n     }\n+}\n+\n+bool PeerManagerImpl::SendMessages(CNode* pto)\n+{\n+    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n+    // disconnect misbehaving peers even before the version handshake is complete.\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n+\n+    // Don't send anything until the version handshake is complete",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572782743",
      "id" : 572782743,
      "in_reply_to_id" : 572501852,
      "line" : 4399,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc4Mjc0Mw==",
      "original_commit_id" : "bbd970a2123aec5071dd3dd901e478844c6e0fea",
      "original_line" : 4399,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 228,
      "pull_request_review_id" : 586413204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572782743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572783998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572783998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, I added this code. It's an int because originally the config option was to set how long the timeout. I later changed the config option to be binary on/off (https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-773227475), but failed to change the type to bool. Will fix.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T10:51:00Z",
      "diff_hunk" : "@@ -25,11 +25,14 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** -pingtimeout default */\n+static const int64_t DEFAULT_PING_TIMEOUT = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572783998",
      "id" : 572783998,
      "in_reply_to_id" : 572503697,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc4Mzk5OA==",
      "original_commit_id" : "bbd970a2123aec5071dd3dd901e478844c6e0fea",
      "original_line" : 29,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 586414735,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572783998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572800969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572800969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. Much better. Fixed",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T11:17:29Z",
      "diff_hunk" : "@@ -716,6 +710,12 @@ class CNode\n \n     std::string ConnectionTypeAsString() const { return ::ConnectionTypeAsString(m_conn_type); }\n \n+    /** A ping-pong keepalive has completed successfully. Update latest and minimum ping times. */\n+    void PingReceived(std::chrono::microseconds ping_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572800969",
      "id" : 572800969,
      "in_reply_to_id" : 572493715,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjgwMDk2OQ==",
      "original_commit_id" : "831f8c36e2f7e8f4af136a306b428a30072e5fcf",
      "original_line" : 714,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 586436458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572800969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572803578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572803578"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, this was unintentional. You're right that it shouldn't have any impact, but I'm going to revert it to how it was. Good catch!",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T11:21:19Z",
      "diff_hunk" : "@@ -3811,15 +3837,14 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             vRecv >> nonce;\n \n             // Only process pong message if there is an outstanding ping (old ping without nonce should never pong)\n-            if (pfrom.nPingNonceSent != 0) {\n-                if (nonce == pfrom.nPingNonceSent) {\n+            if (peer->nPingNonceSent != 0) {\n+                if (nonce == peer->nPingNonceSent) {\n                     // Matching pong received, this ping is no longer outstanding\n                     bPingFinished = true;\n-                    const auto ping_time = ping_end - pfrom.m_ping_start.load();\n-                    if (ping_time.count() >= 0) {\n-                        // Successful ping time measurement, replace previous\n-                        pfrom.nPingUsecTime = count_microseconds(ping_time);\n-                        pfrom.nMinPingUsecTime = std::min(pfrom.nMinPingUsecTime.load(), count_microseconds(ping_time));\n+                    const auto ping_time = ping_end - peer->m_ping_start.load();\n+                    if (ping_time.count() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572803578",
      "id" : 572803578,
      "in_reply_to_id" : 572489932,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjgwMzU3OA==",
      "original_commit_id" : "831f8c36e2f7e8f4af136a306b428a30072e5fcf",
      "original_line" : 3845,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 586439482,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572803578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @amitiuttarwar. I've resolved all of your review comments.",
      "created_at" : "2021-02-09T11:22:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-775868174",
      "id" : 775868174,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTg2ODE3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-09T11:22:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775868174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572804249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572804249"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done!",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T11:22:25Z",
      "diff_hunk" : "@@ -315,6 +323,10 @@ class PeerManagerImpl final : public PeerManager\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /** Send a ping message every PING_INTERVAL or if requested via RPC. May\n+     *  disconnect the peer if a ping has timed out. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572804249",
      "id" : 572804249,
      "in_reply_to_id" : 572502484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjgwNDI0OQ==",
      "original_commit_id" : "bbd970a2123aec5071dd3dd901e478844c6e0fea",
      "original_line" : 327,
      "original_position" : 27,
      "original_start_line" : 326,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 586440296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572804249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dongcarl \r\n\r\n> This may have been answered before but could someone tell me the exact sequence of events in the test framework involving setmocktime that would make -nopingtimeout necessary? My naive reading is that send_and_ping blocks until it receives the pong and is therefore not going to timeout if the next call is a setmocktime.\r\n\r\nThe `send_and_ping` method involves the python test framework sending a ping message to the bitcoind node and waiting for a pong. The timeout that could cause a problem is the ping message in the other direction. Here's how it could fail:\r\n\r\n- bitcoind sends a `ping` message to test framework at time 0\r\n- test calls `setmocktime` to push the node's mocktime some large number of seconds in the future\r\n- before the test framework's `pong` response has been received/processed, `SendMessages()` is called by the message handler thread for that peer, and the test in `MaybeSetPing()` fails: `now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL})`\r\n- bitcoind disconnects the test framework connection\r\n\r\nbitcoind periodically sends pings to all its peers, and is continually running the message handler thread loop, so this window condition will cause the test to fail intermittently.",
      "created_at" : "2021-02-09T11:29:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-775871829",
      "id" : 775871829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTg3MTgyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-09T11:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775871829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573110570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573110570"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've moved this back to immediately after the `fSuccessfullyConnected` check. Hopefully that's clearer.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-09T18:00:21Z",
      "diff_hunk" : "@@ -4286,50 +4315,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - peer.m_ping_start.load()), peer.m_id);\n+        node_to.fDisconnect = true;\n+        return;\n+    }\n \n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (peer.m_ping_queued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (peer.m_ping_nonce_sent == 0 && now > peer.m_ping_start.load() + PING_INTERVAL) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        peer.m_ping_queued = false;\n+        peer.m_ping_start = GetTime<std::chrono::microseconds>();\n+        if (node_to.GetCommonVersion() > BIP0031_VERSION) {\n+            peer.m_ping_nonce_sent = nonce;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING, nonce));\n         } else {\n             // Peer is too old to support ping command with nonce, pong will never arrive.\n-            pto->nPingNonceSent = 0;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING));\n+            peer.m_ping_nonce_sent = 0;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING));\n         }\n     }\n+}\n+\n+bool PeerManagerImpl::SendMessages(CNode* pto)\n+{\n+    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n+    // disconnect misbehaving peers even before the version handshake is complete.\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n+\n+    // Don't send anything until the version handshake is complete\n+    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n+        return true;\n+\n+    PeerRef peer = GetPeerRef(pto->GetId());\n+\n+    MaybeSendPing(*pto, *peer);\n+\n+    // MaybeSendPing may have marked peer for disconnection\n+    if (pto->fDisconnect) return true;\n+\n+    // If we get here, the outgoing message serialization version is set and can't change.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573110570",
      "id" : 573110570,
      "in_reply_to_id" : 572499884,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzExMDU3MA==",
      "original_commit_id" : "bbd970a2123aec5071dd3dd901e478844c6e0fea",
      "original_line" : 4380,
      "original_position" : 194,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 586840152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573110570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK af23d37cab, all that changed was in response to my feedback (thanks!) ",
      "created_at" : "2021-02-09T18:12:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-776135699",
      "id" : 776135699,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjEzNTY5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-09T18:12:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776135699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573423598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573423598"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Recommend `if (x < y)` rather than `if (y > x)` generally -- smaller numbers generally go to the left of larger numbers, so keeping that convention is one less thing to have to think about. (This patch changes the tests from `timeout < GetTime()` to `now > timeout`)",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T03:38:07Z",
      "diff_hunk" : "@@ -4286,50 +4315,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573423598",
      "id" : 573423598,
      "line" : 4331,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzQyMzU5OA==",
      "original_commit_id" : "af23d37cab48a50172103ef59a29f76470c2e001",
      "original_line" : 4331,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 176,
      "pull_request_review_id" : 587225598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573423598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573439430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573439430"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would probably be better to set `m_pingtimeout = gArgs.GetArg()` in the constructor, rather than re-query it every loop.\r\n\r\nI think losing the check that `GetSystemTimeInSeconds() <= node_to.nTimeConnected + peer_connect_timeout` (which is done in `InactivityCheck` but not `MaybeSendPing`) is a mistake -- the docs for `-peertimeout` say \"Specify a p2p connection timeout delay in seconds. After connecting to a peer, wait this amount of time before considering disconnection based on inactivity\" which seems like it should apply here: not sending a ping reply certainly seems like a form of inactivity to me! (Setting `m_peer_connect_timeout` from `gArgs` in the `PeerManagerImpl` constructor seems like it would work here too, without violating layering)\r\n\r\nHaving `-peertimeout` continue to apply to (a lack of) PONG messages seems to make `-pingtimeout` unnecessary; the tests don't need to be modified anymore, and I'm not seeing any reasons other than initial mocktime confusion as to why you'd want to prevent disconnections?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T04:35:44Z",
      "diff_hunk" : "@@ -4291,6 +4292,18 @@ class CompareInvMempoolOrder\n \n void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        node_to.nPingNonceSent &&\n+        now > node_to.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - node_to.m_ping_start.load()), node_to.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573439430",
      "id" : 573439430,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzQzOTQzMA==",
      "original_commit_id" : "43f190e50c09e4800e41e3bdde13daabcc222c12",
      "original_line" : 4302,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 587225598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573439430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573447152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573447152"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it might make more sense in general to set `-peertimeout=9999` for all the test cases (ie, in the framework generated bitcoin.conf) -- or at least all the test cases that use mocktime -- and override it anywhere that's explicitly testing disconnection due to timeouts (`p2p_ping.py`).",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T04:48:24Z",
      "diff_hunk" : "@@ -32,7 +32,7 @@ def set_test_params(self):\n         self.extra_args = [\n             [\n                 \"-acceptnonstdtxn=1\",\n-                \"-peertimeout=9999\",  # bump because mocktime might cause a disconnect otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573447152",
      "id" : 573447152,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzQ0NzE1Mg==",
      "original_commit_id" : "ec2b67da21ab15a351cd9231f8fcafd103adf042",
      "original_line" : 35,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/feature_bip68_sequence.py",
      "position" : null,
      "pull_request_review_id" : 587225598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573447152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573453477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573453477"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If I'm following the logic here right, then if we backdate mocktime after sending a PING, we'll never send a PING to that node again. I'm not seeing an obvious problem with that (and don't think it's a change in this PR), but it's somewhat surprising.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T05:10:38Z",
      "diff_hunk" : "@@ -4299,7 +4312,7 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n         pingSend = true;\n     }\n \n-    if (node_to.nPingNonceSent == 0 && node_to.m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+    if (node_to.nPingNonceSent == 0 && now > node_to.m_ping_start.load() + PING_INTERVAL) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573453477",
      "id" : 573453477,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzQ1MzQ3Nw==",
      "original_commit_id" : "43f190e50c09e4800e41e3bdde13daabcc222c12",
      "original_line" : 4315,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 587225598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573453477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573464297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573464297"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you're doing disconnects here as well, doesn't that make it `MaybeSendPingOrDisconnectDueToLackOfPong()` ? Not sure the `Maybe` is useful -- `SendMessages` doesn't have a `Maybe` despite it not necessarily doing something every time it's called.\r\n\r\nThis moves ping disconnections from `ThreadSocketHandler` (which calls `SocketHandler` which calls `InactivityCheck`, I think on a 50ms cycle) to `ThreadMessageHandler` (which calls `SendMessages` which calls `MaybeSendPing`, I think on a 100ms cycle, though will reinvoke SendMessages more frequently if any node's `ProcessMessages` indicates there's more work). I think that's fine.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T05:46:20Z",
      "diff_hunk" : "@@ -4291,6 +4292,18 @@ class CompareInvMempoolOrder\n \n void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n+    // Use mockable time for ping timeouts.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573464297",
      "id" : 573464297,
      "line" : 4326,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzQ2NDI5Nw==",
      "original_commit_id" : "43f190e50c09e4800e41e3bdde13daabcc222c12",
      "original_line" : 4326,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 171,
      "pull_request_review_id" : 587225598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573464297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573466306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573466306"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Space after \"if\" if you're changing punctuation?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T05:52:39Z",
      "diff_hunk" : "@@ -77,13 +77,12 @@ static RPCHelpMan ping()\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n {\n     NodeContext& node = EnsureNodeContext(request.context);\n-    if(!node.connman)\n+    if(!node.peerman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573466306",
      "id" : 573466306,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzQ2NjMwNg==",
      "original_commit_id" : "15449ef4cbb3f4f4fa72b42e10e3d50ced048fbf",
      "original_line" : 80,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 587225598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573466306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573471961"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573471961"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `ping_time.count == 0` is expected if you do `setmocktime X`, then a ping goes out, and the pong is received before you call `setmocktime Y`.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T06:09:23Z",
      "diff_hunk" : "@@ -3807,15 +3837,14 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             vRecv >> nonce;\n \n             // Only process pong message if there is an outstanding ping (old ping without nonce should never pong)\n-            if (pfrom.nPingNonceSent != 0) {\n-                if (nonce == pfrom.nPingNonceSent) {\n+            if (peer->m_ping_nonce_sent != 0) {\n+                if (nonce == peer->m_ping_nonce_sent) {\n                     // Matching pong received, this ping is no longer outstanding\n                     bPingFinished = true;\n-                    const auto ping_time = ping_end - pfrom.m_ping_start.load();\n+                    const auto ping_time = ping_end - peer->m_ping_start.load();\n                     if (ping_time.count() >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573471961",
      "id" : 573471961,
      "line" : 3876,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzQ3MTk2MQ==",
      "original_commit_id" : "af23d37cab48a50172103ef59a29f76470c2e001",
      "original_line" : 3876,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 587225598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573471961",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573562651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573562651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I find that \"now < timeout\" or \"now > timeout\" is much more natural to parse and understand - the thing that we're measuring (the time now) is on the left, and the thing that it's being measured against (the timeout) is on the right. That's how most people speak (\"Is it after 10 o'clock?\"), and the other way is a bit yoda-esque (\"was 10 o'clock before now?\"). Ultimately, I think this is a matter of taste.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T09:15:49Z",
      "diff_hunk" : "@@ -4286,50 +4315,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573562651",
      "id" : 573562651,
      "in_reply_to_id" : 573423598,
      "line" : 4331,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2MjY1MQ==",
      "original_commit_id" : "af23d37cab48a50172103ef59a29f76470c2e001",
      "original_line" : 4331,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 176,
      "pull_request_review_id" : 587394139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573562651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573564530"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573564530"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That seems right to me. As you say, that's not changed by this PR.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T09:18:33Z",
      "diff_hunk" : "@@ -4299,7 +4312,7 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n         pingSend = true;\n     }\n \n-    if (node_to.nPingNonceSent == 0 && node_to.m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+    if (node_to.nPingNonceSent == 0 && now > node_to.m_ping_start.load() + PING_INTERVAL) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573564530",
      "id" : 573564530,
      "in_reply_to_id" : 573453477,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2NDUzMA==",
      "original_commit_id" : "43f190e50c09e4800e41e3bdde13daabcc222c12",
      "original_line" : 4315,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 587396514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573564530",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573568813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573568813"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> make it MaybeSendPingOrDisconnectDueToLackOfPong()\r\n\r\nI don't think the function name needs to document all the functionality. It's documented in the function comment:\r\n\r\n```\r\n    /** Send a ping message every PING_INTERVAL or if requested via RPC. May\r\n     *  mark the peer to be disconnected if a ping has timed out. */\r\n```\r\n\r\n> Not sure the Maybe is useful -- SendMessages doesn't have a Maybe despite it not necessarily doing something every time it's called.\r\n\r\nRight, and `MaybeDiscourageAndDisconnect()` does have maybe in it.\r\n\r\nI don't really care what this function is called. If you feel strongly, I can change it.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T09:24:44Z",
      "diff_hunk" : "@@ -4291,6 +4292,18 @@ class CompareInvMempoolOrder\n \n void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n+    // Use mockable time for ping timeouts.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573568813",
      "id" : 573568813,
      "in_reply_to_id" : 573464297,
      "line" : 4326,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2ODgxMw==",
      "original_commit_id" : "43f190e50c09e4800e41e3bdde13daabcc222c12",
      "original_line" : 4326,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 171,
      "pull_request_review_id" : 587401933,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573568813",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573570335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573570335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I think it might make more sense in general to set -peertimeout=9999 for all the test cases (ie, in the framework generated bitcoin.conf)\r\n\r\nChanging the behaviour of all tests is outside the scope of this PR, but I'm happy to review any proposal you have for making the tests more robust.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T09:26:53Z",
      "diff_hunk" : "@@ -32,7 +32,7 @@ def set_test_params(self):\n         self.extra_args = [\n             [\n                 \"-acceptnonstdtxn=1\",\n-                \"-peertimeout=9999\",  # bump because mocktime might cause a disconnect otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573570335",
      "id" : 573570335,
      "in_reply_to_id" : 573447152,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU3MDMzNQ==",
      "original_commit_id" : "ec2b67da21ab15a351cd9231f8fcafd103adf042",
      "original_line" : 35,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/feature_bip68_sequence.py",
      "position" : null,
      "pull_request_review_id" : 587403843,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573570335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think I'm a NACK on the -pingtimeout changes as they stand -- at a minimum it should be clear from the PR description and commit messages why those changes are needed, but there's currently no motivation for them in those places.\r\n> \r\n> I think duplicating the -peertimeout check into net_processing is enough to obsolete the need to change the tests\r\n\r\nOk, done. I've removed `-pingtimeout`, and duplicted the `-peertimeout` setting and logic into MaybeSendPing() as requested.\r\n\r\nMoving the application-layer data and logic is an opportunity to clean up and rationalize the weird edge cases and strange behavior. As you've noted from your observation about the `InactivityCheck` bug, and as sipa pointed out in https://github.com/bitcoin/bitcoin/pull/20027#discussion_r501350411, mixing mockable time and system time is too complicated and a source of bugs and confusion. Moving ping timeouts to the application layer means that we can lose one of those interactions between system time and mockable time - system time timeouts on the socket stay in net, and mockable timeouts live in the application layer. This is really only applicable for tests, and I don't think there's much downside to adding a hidden configuration option where it's needed.\r\n\r\nHowever, I don't think this is important enough to hold up the rest of #19398. I've restored the behaviour to exactly how it was, so no changes are required to tests (except the modified PeerManager ctor signature). We can perhaps rationalize mocktime/system time for pings at some later date.",
      "created_at" : "2021-02-10T10:06:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-776595952",
      "id" : 776595952,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjU5NTk1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T21:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776595952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573599030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573599030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Leaving this so as not to change behaviour",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T10:07:12Z",
      "diff_hunk" : "@@ -3807,15 +3837,14 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             vRecv >> nonce;\n \n             // Only process pong message if there is an outstanding ping (old ping without nonce should never pong)\n-            if (pfrom.nPingNonceSent != 0) {\n-                if (nonce == pfrom.nPingNonceSent) {\n+            if (peer->m_ping_nonce_sent != 0) {\n+                if (nonce == peer->m_ping_nonce_sent) {\n                     // Matching pong received, this ping is no longer outstanding\n                     bPingFinished = true;\n-                    const auto ping_time = ping_end - pfrom.m_ping_start.load();\n+                    const auto ping_time = ping_end - peer->m_ping_start.load();\n                     if (ping_time.count() >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573599030",
      "id" : 573599030,
      "in_reply_to_id" : 573471961,
      "line" : 3876,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU5OTAzMA==",
      "original_commit_id" : "af23d37cab48a50172103ef59a29f76470c2e001",
      "original_line" : 3876,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 587440033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573599030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573599966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573599966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T10:08:28Z",
      "diff_hunk" : "@@ -77,13 +77,12 @@ static RPCHelpMan ping()\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n {\n     NodeContext& node = EnsureNodeContext(request.context);\n-    if(!node.connman)\n+    if(!node.peerman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573599966",
      "id" : 573599966,
      "in_reply_to_id" : 573466306,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU5OTk2Ng==",
      "original_commit_id" : "15449ef4cbb3f4f4fa72b42e10e3d50ced048fbf",
      "original_line" : 80,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 587441138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573599966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573600195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573600195"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've removed `pingtimeout` as requested.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T10:08:48Z",
      "diff_hunk" : "@@ -4291,6 +4292,18 @@ class CompareInvMempoolOrder\n \n void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        node_to.nPingNonceSent &&\n+        now > node_to.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - node_to.m_ping_start.load()), node_to.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573600195",
      "id" : 573600195,
      "in_reply_to_id" : 573439430,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzYwMDE5NQ==",
      "original_commit_id" : "43f190e50c09e4800e41e3bdde13daabcc222c12",
      "original_line" : 4302,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 587441414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573600195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573648637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573648637"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(This was meant to be a reply to https://github.com/bitcoin/bitcoin/pull/20721#discussion_r572489932 except github wasn't let me comment there)",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-10T11:22:04Z",
      "diff_hunk" : "@@ -3807,15 +3837,14 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             vRecv >> nonce;\n \n             // Only process pong message if there is an outstanding ping (old ping without nonce should never pong)\n-            if (pfrom.nPingNonceSent != 0) {\n-                if (nonce == pfrom.nPingNonceSent) {\n+            if (peer->m_ping_nonce_sent != 0) {\n+                if (nonce == peer->m_ping_nonce_sent) {\n                     // Matching pong received, this ping is no longer outstanding\n                     bPingFinished = true;\n-                    const auto ping_time = ping_end - pfrom.m_ping_start.load();\n+                    const auto ping_time = ping_end - peer->m_ping_start.load();\n                     if (ping_time.count() >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r573648637",
      "id" : 573648637,
      "in_reply_to_id" : 573471961,
      "line" : 3876,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzY0ODYzNw==",
      "original_commit_id" : "af23d37cab48a50172103ef59a29f76470c2e001",
      "original_line" : 3876,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 587503344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573648637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574184445"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574184445"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "\"MaybeSendPing\" just kinda bugs me as a name. I'd suggest \"HandleBIP31PingPong()\" or something, but that would bug me a bit too. Maybe some day it'll be possible to just register a `PingPongMessages` class that deals with both the send and receive side :pray:",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-11T00:37:50Z",
      "diff_hunk" : "@@ -4291,6 +4292,18 @@ class CompareInvMempoolOrder\n \n void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n+    // Use mockable time for ping timeouts.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574184445",
      "id" : 574184445,
      "in_reply_to_id" : 573464297,
      "line" : 4326,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDE4NDQ0NQ==",
      "original_commit_id" : "43f190e50c09e4800e41e3bdde13daabcc222c12",
      "original_line" : 4326,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 171,
      "pull_request_review_id" : 588179295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574184445",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574803671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574803671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "think this could just be..\r\n\r\n```suggestion\r\n        peer.m_ping_start = now;\r\n```",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-11T20:25:46Z",
      "diff_hunk" : "@@ -4286,50 +4321,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (GetSystemTimeInSeconds() > node_to.nTimeConnected + m_peer_connect_timeout &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - peer.m_ping_start.load()), peer.m_id);\n+        node_to.fDisconnect = true;\n+        return;\n+    }\n \n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (peer.m_ping_queued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (peer.m_ping_nonce_sent == 0 && now > peer.m_ping_start.load() + PING_INTERVAL) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        peer.m_ping_queued = false;\n+        peer.m_ping_start = GetTime<std::chrono::microseconds>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574803671",
      "id" : 574803671,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDgwMzY3MQ==",
      "original_commit_id" : "31cc466eb055ac4ef6904e3a99feb65c262a5946",
      "original_line" : 4329,
      "original_position" : 210,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 588955329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574803671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574832926"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574832926"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd prefer if this was a chrono duration, but I understand the context of keeping it consistent with net. ",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-11T21:18:00Z",
      "diff_hunk" : "@@ -335,6 +347,10 @@ class PeerManagerImpl final : public PeerManager\n       * on extra block-relay-only peers. */\n     bool m_initial_sync_finished{false};\n \n+    /** After connecting to a peer, wait this amount of time before considering\n+     * disconnection based on inactivity */\n+    const int64_t m_peer_connect_timeout;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574832926",
      "id" : 574832926,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDgzMjkyNg==",
      "original_commit_id" : "31cc466eb055ac4ef6904e3a99feb65c262a5946",
      "original_line" : 352,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 588955329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574832926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574903578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574903578"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Adding:\r\n\r\n```c++\r\n    /** Return true if inactivity checks should be ignored */\r\n    inline bool IgnoreInactivityChecks(const CNode& node) const\r\n    {\r\n        return GetSystemTimeInSeconds() <= node.nTimeConnected + m_peer_connect_timeout;\r\n    }\r\n```\r\n\r\nto `CConnman` would let you avoid adding `m_peer_connect_timeout` in `PeerManagerImpl` and keep the non-mockable times in net.cpp. (You have access to `connman` anyway via `PeerManagerImpl::m_connman` and access to `node` in order to set the disconnect flag)",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-11T23:41:01Z",
      "diff_hunk" : "@@ -4297,6 +4298,20 @@ class CompareInvMempoolOrder\n \n void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (GetSystemTimeInSeconds() > node_to.nTimeConnected + m_peer_connect_timeout &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574903578",
      "id" : 574903578,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDkwMzU3OA==",
      "original_commit_id" : "e588cc6d73789426f6b715af76981fda9cdb77b4",
      "original_line" : 4305,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 589080869,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574903578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574920953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574920953"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should there be a `if (peer == nullptr) return true;` here? We check that everywhere else.\r\n\r\nRather than move this line, might be better to continue doing it first thing and pass the result into  `MaybeDiscourageAndDisconnect` rather than having that function look it up too. (At least, that's where I'm expecting to end up with #20758 eventually)",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-12T00:28:44Z",
      "diff_hunk" : "@@ -4292,50 +4295,56 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n-\n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (node_to.fPingQueued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (node_to.nPingNonceSent == 0 && node_to.m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        node_to.fPingQueued = false;\n+        node_to.m_ping_start = GetTime<std::chrono::microseconds>();\n+        if (node_to.GetCommonVersion() > BIP0031_VERSION) {\n+            node_to.nPingNonceSent = nonce;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING, nonce));\n         } else {\n             // Peer is too old to support ping command with nonce, pong will never arrive.\n-            pto->nPingNonceSent = 0;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING));\n+            node_to.nPingNonceSent = 0;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING));\n         }\n     }\n+}\n+\n+bool PeerManagerImpl::SendMessages(CNode* pto)\n+{\n+    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n+    // disconnect misbehaving peers even before the version handshake is complete.\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n+\n+    // Don't send anything until the version handshake is complete\n+    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n+        return true;\n+\n+    // If we get here, the outgoing message serialization version is set and can't change.\n+    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+\n+    MaybeSendPing(*pto);\n+\n+    PeerRef peer = GetPeerRef(pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574920953",
      "id" : 574920953,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDkyMDk1Mw==",
      "original_commit_id" : "1ae2babd77c7ff26b55cd5bb918c965205ffb9b9",
      "original_line" : 4346,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 589080869,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574920953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574925129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574925129"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you write \"if (10 o'clock < now)\" you've literally put now after 10 o'clock and are asking if that's a true statement. I do get what you're saying; I just find the always less-than strategy lets you read the ordering much more directly in general -- which one comes first is in exactly the order you're reading, and not dictated by a single bit of punctuation. It's also helpful for bounds checking `(low_value < x && x < high_value)`  and `(x < low_value || high_value < x)` read much clearer than `(x > low_value && x < high_value)` and `(x < low_value || x > high_value)`.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-12T00:40:23Z",
      "diff_hunk" : "@@ -4286,50 +4315,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (gArgs.GetArg(\"-pingtimeout\", DEFAULT_PING_TIMEOUT) &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r574925129",
      "id" : 574925129,
      "in_reply_to_id" : 573423598,
      "line" : 4331,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDkyNTEyOQ==",
      "original_commit_id" : "af23d37cab48a50172103ef59a29f76470c2e001",
      "original_line" : 4331,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 176,
      "pull_request_review_id" : 589080869,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574925129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "FYI, I think the scripted diff only touches `net_processing.cpp`, so doesn't need the `.*` there.",
      "created_at" : "2021-02-12T02:38:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-777930322",
      "id" : 777930322,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzkzMDMyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-12T02:38:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777930322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575163252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575163252"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-12T11:37:34Z",
      "diff_hunk" : "@@ -4292,50 +4295,56 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n-\n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (node_to.fPingQueued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (node_to.nPingNonceSent == 0 && node_to.m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        node_to.fPingQueued = false;\n+        node_to.m_ping_start = GetTime<std::chrono::microseconds>();\n+        if (node_to.GetCommonVersion() > BIP0031_VERSION) {\n+            node_to.nPingNonceSent = nonce;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING, nonce));\n         } else {\n             // Peer is too old to support ping command with nonce, pong will never arrive.\n-            pto->nPingNonceSent = 0;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING));\n+            node_to.nPingNonceSent = 0;\n+            m_connman.PushMessage(&node_to, msgMaker.Make(NetMsgType::PING));\n         }\n     }\n+}\n+\n+bool PeerManagerImpl::SendMessages(CNode* pto)\n+{\n+    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n+    // disconnect misbehaving peers even before the version handshake is complete.\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n+\n+    // Don't send anything until the version handshake is complete\n+    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n+        return true;\n+\n+    // If we get here, the outgoing message serialization version is set and can't change.\n+    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+\n+    MaybeSendPing(*pto);\n+\n+    PeerRef peer = GetPeerRef(pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575163252",
      "id" : 575163252,
      "in_reply_to_id" : 574920953,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTE2MzI1Mg==",
      "original_commit_id" : "1ae2babd77c7ff26b55cd5bb918c965205ffb9b9",
      "original_line" : 4346,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 589385297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575163252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575163376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575163376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-12T11:37:43Z",
      "diff_hunk" : "@@ -4297,6 +4298,20 @@ class CompareInvMempoolOrder\n \n void PeerManagerImpl::MaybeSendPing(CNode& node_to)\n {\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (GetSystemTimeInSeconds() > node_to.nTimeConnected + m_peer_connect_timeout &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575163376",
      "id" : 575163376,
      "in_reply_to_id" : 574903578,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTE2MzM3Ng==",
      "original_commit_id" : "e588cc6d73789426f6b715af76981fda9cdb77b4",
      "original_line" : 4305,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 589385418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575163376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @ajtowns. I've addressed both of your comments. This is looking much cleaner now.\r\n\r\nApologies to the other reviewers for the churn. Hopefully we can settle on this approach and move towards getting this merged.",
      "created_at" : "2021-02-12T11:39:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-778144929",
      "id" : 778144929,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3ODE0NDkyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-12T11:39:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/778144929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575164249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575164249"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've now removed this again. Sorry :grimacing: ",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-12T11:39:20Z",
      "diff_hunk" : "@@ -335,6 +347,10 @@ class PeerManagerImpl final : public PeerManager\n       * on extra block-relay-only peers. */\n     bool m_initial_sync_finished{false};\n \n+    /** After connecting to a peer, wait this amount of time before considering\n+     * disconnection based on inactivity */\n+    const int64_t m_peer_connect_timeout;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575164249",
      "id" : 575164249,
      "in_reply_to_id" : 574832926,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTE2NDI0OQ==",
      "original_commit_id" : "31cc466eb055ac4ef6904e3a99feb65c262a5946",
      "original_line" : 352,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 589386476,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575164249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575177094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575177094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done!",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-12T12:05:02Z",
      "diff_hunk" : "@@ -4286,50 +4321,72 @@ class CompareInvMempoolOrder\n };\n }\n \n-bool PeerManagerImpl::SendMessages(CNode* pto)\n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n {\n-    PeerRef peer = GetPeerRef(pto->GetId());\n-    const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n-\n-    // We must call MaybeDiscourageAndDisconnect first, to ensure that we'll\n-    // disconnect misbehaving peers even before the version handshake is complete.\n-    if (MaybeDiscourageAndDisconnect(*pto)) return true;\n-\n-    // Don't send anything until the version handshake is complete\n-    if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-        return true;\n-\n-    // If we get here, the outgoing message serialization version is set and can't change.\n-    const CNetMsgMaker msgMaker(pto->GetCommonVersion());\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (GetSystemTimeInSeconds() > node_to.nTimeConnected + m_peer_connect_timeout &&\n+        peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - peer.m_ping_start.load()), peer.m_id);\n+        node_to.fDisconnect = true;\n+        return;\n+    }\n \n-    //\n-    // Message: ping\n-    //\n+    const CNetMsgMaker msgMaker(node_to.GetCommonVersion());\n     bool pingSend = false;\n-    if (pto->fPingQueued) {\n+\n+    if (peer.m_ping_queued) {\n         // RPC ping request by user\n         pingSend = true;\n     }\n-    if (pto->nPingNonceSent == 0 && pto->m_ping_start.load() + PING_INTERVAL < GetTime<std::chrono::microseconds>()) {\n+\n+    if (peer.m_ping_nonce_sent == 0 && now > peer.m_ping_start.load() + PING_INTERVAL) {\n         // Ping automatically sent as a latency probe & keepalive.\n         pingSend = true;\n     }\n+\n     if (pingSend) {\n         uint64_t nonce = 0;\n         while (nonce == 0) {\n             GetRandBytes((unsigned char*)&nonce, sizeof(nonce));\n         }\n-        pto->fPingQueued = false;\n-        pto->m_ping_start = GetTime<std::chrono::microseconds>();\n-        if (pto->GetCommonVersion() > BIP0031_VERSION) {\n-            pto->nPingNonceSent = nonce;\n-            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));\n+        peer.m_ping_queued = false;\n+        peer.m_ping_start = GetTime<std::chrono::microseconds>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575177094",
      "id" : 575177094,
      "in_reply_to_id" : 574803671,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTE3NzA5NA==",
      "original_commit_id" : "31cc466eb055ac4ef6904e3a99feb65c262a5946",
      "original_line" : 4329,
      "original_position" : 210,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 589402969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575177094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575458057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575458057"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Question about 6a03a1f7e4: Is the idea that, in the future, `MaybeDiscourageAndDisconnect()` will only need to accept a `Peer`? And right now, even though you could grab the `PeerRef` from the `m_peer_map` in here again, passing in a `Peer` is a bit less overhead?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-12T18:59:44Z",
      "diff_hunk" : "@@ -3969,43 +3999,39 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     return;\n }\n \n-bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode)\n+bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575458057",
      "id" : 575458057,
      "line" : 4029,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTQ1ODA1Nw==",
      "original_commit_id" : "a3ec04b7a61378dab0a9a53840e5f504d25ac563",
      "original_line" : 4029,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 118,
      "pull_request_review_id" : 589757123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575458057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575474426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575474426"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "4561423100c1b6a8e778525a027d021b918a6312\r\nDefinitely like peerman asking connman if it should `RunInactivityChecks()` instead of taking a peertimeout param ð\r\nStrictly speaking, I think it's possible for the time to be different from `RunInactivityChecks` to `InactivityChecks` since they each grab the time separately (as opposed to before, where they used the same `now`)? I don't think it'd be a huge issue since it's in seconds and the system time would only move forward though",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-12T19:32:27Z",
      "diff_hunk" : "@@ -1221,18 +1221,17 @@ void CConnman::NotifyNumConnectionsChanged()\n     }\n }\n \n+bool CConnman::RunInactivityChecks(const CNode& node) const\n+{\n+    return GetSystemTimeInSeconds() > node.nTimeConnected + m_peer_connect_timeout;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575474426",
      "id" : 575474426,
      "line" : 1213,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTQ3NDQyNg==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1213,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_review_id" : 589757123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575474426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575890770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575890770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`MaybeDiscourageAndDisconnect` should continue needing a `CNode` in order to signal the disconnection, I think.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T00:30:53Z",
      "diff_hunk" : "@@ -3969,43 +3999,39 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     return;\n }\n \n-bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode)\n+bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575890770",
      "id" : 575890770,
      "in_reply_to_id" : 575458057,
      "line" : 4029,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg5MDc3MA==",
      "original_commit_id" : "a3ec04b7a61378dab0a9a53840e5f504d25ac563",
      "original_line" : 4029,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 118,
      "pull_request_review_id" : 590104221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575890770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575891034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575891034"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "~Currently system time isn't guaranteed to move forwards; and I believe we're now doing these checks in different threads so I don't think it's reasonable to try to use the same exact point in time for the two comparisons. We should be doing both checks 10-20 times per second for each peer anyway, I believe, so any lack of precision shouldn't matter.~",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T00:33:06Z",
      "diff_hunk" : "@@ -1221,18 +1221,17 @@ void CConnman::NotifyNumConnectionsChanged()\n     }\n }\n \n+bool CConnman::RunInactivityChecks(const CNode& node) const\n+{\n+    return GetSystemTimeInSeconds() > node.nTimeConnected + m_peer_connect_timeout;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575891034",
      "id" : 575891034,
      "in_reply_to_id" : 575474426,
      "line" : 1213,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg5MTAzNA==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1213,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_review_id" : 590104538,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575891034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575893265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575893265"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`const NodeId peer_id{peer.m_id};` would've changed fewer lines :)",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T00:47:36Z",
      "diff_hunk" : "@@ -3969,43 +3970,39 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     return;\n }\n \n-bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode)\n+bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)\n {\n-    const NodeId peer_id{pnode.GetId()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575893265",
      "id" : 575893265,
      "line" : 4001,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg5MzI2NQ==",
      "original_commit_id" : "6a03a1f7e4983af863d759776d91b8ed8495a949",
      "original_line" : 4001,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 590106744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575893265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575894343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575894343"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`if the peer should be connected for inactivity` ? -- we could introduce a net permission to prevent that rather than just have a standard timeout for all peers, eg",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T00:54:14Z",
      "diff_hunk" : "@@ -1024,6 +1024,9 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n+    /** Return true if the peer has been connected for long enough to do inactivity checks. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575894343",
      "id" : 575894343,
      "line" : 1025,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg5NDM0Mw==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1025,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 49,
      "pull_request_review_id" : 590106744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575894343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575894665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575894665"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm surprised this is pulled out of `InactivityCheck()`. Seems cleaner to keep the early exit to me",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T00:55:54Z",
      "diff_hunk" : "@@ -1537,7 +1536,7 @@ void CConnman::SocketHandler()\n             if (bytes_sent) RecordBytesSent(bytes_sent);\n         }\n \n-        if (InactivityCheck(*pnode)) pnode->fDisconnect = true;\n+        if (RunInactivityChecks(*pnode) && InactivityCheck(*pnode)) pnode->fDisconnect = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575894665",
      "id" : 575894665,
      "line" : 1518,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg5NDY2NQ==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1518,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 86,
      "pull_request_review_id" : 590106744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575894665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575895661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575895661"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could make this\r\n\r\n```c++\r\nbool CConnman::RunInactivityChecks(const CNode& node, const uint64_t const* pnow=nullptr)\r\n{\r\n    const uint64_t now = (pnow ? *pnow : GetSystemTimeInSeconds());\r\n    return now > node.nTimeconnected + m_peer_connect_timeout;\r\n}\r\n```\r\n\r\nand call it from within `InactivityCheck()` as `if (!RunInactivityChecks(node, &now) return false;` to avoid unnecessarily getting the system time twice in quick succession. Might also make `RunInactivityChecks` easier to test since you could pass in different times and check the answer, without having to worry that `GetSystemTime` isn't mockable.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T01:01:17Z",
      "diff_hunk" : "@@ -1221,18 +1221,17 @@ void CConnman::NotifyNumConnectionsChanged()\n     }\n }\n \n+bool CConnman::RunInactivityChecks(const CNode& node) const\n+{\n+    return GetSystemTimeInSeconds() > node.nTimeConnected + m_peer_connect_timeout;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575895661",
      "id" : 575895661,
      "line" : 1213,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg5NTY2MQ==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1213,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_review_id" : 590106744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575895661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575897478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575897478"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Only mentioning since you've got `RunInactivityChecks` as a separate commit, but I think you could reasonably have pulled `SendPings()` out as a separate commit prior to moving things from net to net_processing too.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T01:13:11Z",
      "diff_hunk" : "@@ -248,6 +255,7 @@ class PeerManagerImpl final : public PeerManager\n     void CheckForStaleTipAndEvictPeers() override;\n     bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats) override;\n     bool IgnoresIncomingTxs() override { return m_ignore_incoming_txs; }\n+    void SendPings() override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575897478",
      "id" : 575897478,
      "line" : 266,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg5NzQ3OA==",
      "original_commit_id" : "bdbd691097c907bc30261a2e2c39a55fdb9df332",
      "original_line" : 266,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 590106744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575897478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576086207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576086207"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Indeed it would, but minimizing lines changed isn't the right metric to judge a commit. Instead we should aim to maximize the clarity and expressiveness of the code after the change. If I was writing this from scratch, I wouldn't create a local copy of the peer id just to use in log lines.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T10:23:48Z",
      "diff_hunk" : "@@ -3969,43 +3970,39 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     return;\n }\n \n-bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode)\n+bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)\n {\n-    const NodeId peer_id{pnode.GetId()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576086207",
      "id" : 576086207,
      "in_reply_to_id" : 575893265,
      "line" : 4001,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjA4NjIwNw==",
      "original_commit_id" : "6a03a1f7e4983af863d759776d91b8ed8495a949",
      "original_line" : 4001,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 590341896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576086207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576098186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576098186"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> MaybeDiscourageAndDisconnect should continue needing a CNode in order to signal the disconnection, I think.\r\n\r\nThis is true. It's also currently needed for the connection type, which I don't think belongs in net_processing.\r\n\r\n> Even though you could grab the PeerRef from the m_peer_map in here again, passing in a Peer is a bit less overhead?\r\n\r\nWe want to grab a `PeerRef` at the entry functions (`ProcessMessages` and `SendMessages` for the message handler thread), and then pass that reference down through the call stack. Grabbing `PeerRef` incurs overhead because `m_peer_mutex` needs to be locked and the shared ptr's refcount needs to be incremented/decremented, so we shouldn't do it unnecessarily.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T10:42:57Z",
      "diff_hunk" : "@@ -3969,43 +3999,39 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     return;\n }\n \n-bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode)\n+bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576098186",
      "id" : 576098186,
      "in_reply_to_id" : 575458057,
      "line" : 4029,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjA5ODE4Ng==",
      "original_commit_id" : "a3ec04b7a61378dab0a9a53840e5f504d25ac563",
      "original_line" : 4029,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 118,
      "pull_request_review_id" : 590341896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576098186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576099605"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576099605"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, good point.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T10:44:57Z",
      "diff_hunk" : "@@ -248,6 +255,7 @@ class PeerManagerImpl final : public PeerManager\n     void CheckForStaleTipAndEvictPeers() override;\n     bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats) override;\n     bool IgnoresIncomingTxs() override { return m_ignore_incoming_txs; }\n+    void SendPings() override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576099605",
      "id" : 576099605,
      "in_reply_to_id" : 575897478,
      "line" : 266,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjA5OTYwNQ==",
      "original_commit_id" : "bdbd691097c907bc30261a2e2c39a55fdb9df332",
      "original_line" : 266,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 590358405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576099605",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @ajtowns! I'll leave your nits for a follow-up PR.\r\n\r\n@dongcarl @amitiuttarwar - I think this would be ready for merge if you reACKed.",
      "created_at" : "2021-02-15T10:45:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-779134854",
      "id" : 779134854,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTEzNDg1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T10:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779134854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576149311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576149311"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, actually I think I disagree with that (well, at least after exaggerating it into a bigger principle) -- review is a much more important bottleneck than just about anything else, so optimising the code to be easier to review is much more helpful than optimising it to make perfect sense if we were going to erase our git history and anonymously post the current tree to a mailing list. I think just about any time there's a choice between correct code that's easier to review and correct code that's better according to some other aesthetic, easier to review should be the winner. At least until review is no longer a serious bottleneck for the project.\r\n\r\nObviously, `peer_id` to `peer.m_id` is trivial, but if we're talking what we should aim to maximise, I think ease of review is the single right answer. I don't think you'll often find that being far off from optimising for clarity, though. (I don't think \"expressiveness\" applies either way tbh)",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T12:12:23Z",
      "diff_hunk" : "@@ -3969,43 +3970,39 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     return;\n }\n \n-bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode)\n+bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)\n {\n-    const NodeId peer_id{pnode.GetId()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576149311",
      "id" : 576149311,
      "in_reply_to_id" : 575893265,
      "line" : 4001,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjE0OTMxMQ==",
      "original_commit_id" : "6a03a1f7e4983af863d759776d91b8ed8495a949",
      "original_line" : 4001,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 590421335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576149311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576158079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576158079"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This discussion is a bit abstract, but I'm going to stand by my assertion. We should always be aiming to improve the quality of the code by standardizing to a clear and consistent style and by taking advantage of higher-level abstractions. One example: if I find a hand written loop that I need to modify, I may well replace it with an stl algorithm. That's undoubtedly a bit more effort to review, but results in higher-quality code. If we always aim to minimize deltas in code changes, then we'll only ever converge to local maxima of quality.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T12:28:36Z",
      "diff_hunk" : "@@ -3969,43 +3970,39 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     return;\n }\n \n-bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode)\n+bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)\n {\n-    const NodeId peer_id{pnode.GetId()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576158079",
      "id" : 576158079,
      "in_reply_to_id" : 575893265,
      "line" : 4001,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjE1ODA3OQ==",
      "original_commit_id" : "6a03a1f7e4983af863d759776d91b8ed8495a949",
      "original_line" : 4001,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 590432573,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576158079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-02-15T15:06:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-779280190",
      "id" : 779280190,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTI4MDE5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T15:06:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779280190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576265810"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576265810"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The point of review being a bottleneck is that we won't ever progress to a global maximum of quality -- if we could do that, by definition we wouldn't be bottlenecked. Every merge is a reflection of that review bottleneck: did we spend our limited review cycles on working out if a while loop does the same thing as the for loop it replaces, or did we spend it on working out if muhash or minisketch does what it claims on the box? If every PR spends 5% of review time checking that shuffling code around is correct, then that's 1-in-20 fewer PRs we can make that affect people that don't see the code. Or it's an incentive to get in the habit of merging code that's not thoroughly reviewed in order to avoid delaying things because we've run out of review resources, which is worse.\r\n\r\nThat doesn't mean we shouldn't always be aiming to improve the quality of the code; just that we should be spending the resources we have on the changes that are most valuable, even if that means leaving some good things for (possibly much) later.\r\n\r\n(Personally, I find most of the STL algorithms worse than the loops they replace -- range based for loops in c++ are pretty pleasant and behave pretty sensibly; for me, dealing explicitly with iterators and lambdas generally isn't pleasant -- they're harder to understand and easier to make mistakes with, for at best a minimal performance benefit, and for me at least any safety benefits are offset by the lack of clarity. There are more important battles to fight, and I'm hoping that perhaps familiarity might eventually breed affection, but for now they certainly don't seem like moving toward even a local maximum to me)",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T15:22:32Z",
      "diff_hunk" : "@@ -3969,43 +3970,39 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     return;\n }\n \n-bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode)\n+bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)\n {\n-    const NodeId peer_id{pnode.GetId()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576265810",
      "id" : 576265810,
      "in_reply_to_id" : 575893265,
      "line" : 4001,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjI2NTgxMA==",
      "original_commit_id" : "6a03a1f7e4983af863d759776d91b8ed8495a949",
      "original_line" : 4001,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 590569545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T16:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576265810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2021-02-15T16:25:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-779328502",
      "id" : 779328502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTMyODUwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T16:25:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779328502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576394790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576394790"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd prefer if this was called something like `InactivityChecksEnabled` or `ShouldRunInactivityChecks` because right now the name suggests this function is where they are run (aka what `InactivityCheck` does).",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T19:46:58Z",
      "diff_hunk" : "@@ -1221,18 +1208,17 @@ void CConnman::NotifyNumConnectionsChanged()\n     }\n }\n \n+bool CConnman::RunInactivityChecks(const CNode& node) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576394790",
      "id" : 576394790,
      "line" : 1211,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjM5NDc5MA==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 1211,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 46,
      "pull_request_review_id" : 590722342,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T21:02:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576394790",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "reACK https://github.com/bitcoin/bitcoin/commit/a5e15ae45ccae7948a6c5b95e6621f01afb88d55 \r\n\r\nrebase-only by `git range-diff a3ec04b...a5e15ae`",
      "created_at" : "2021-02-15T20:07:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-779426239",
      "id" : 779426239,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTQyNjIzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T20:07:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779426239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576405738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576405738"
         }
      },
      "author_association" : "MEMBER",
      "body" : "connected for inactivity?? I don't follow.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T20:18:25Z",
      "diff_hunk" : "@@ -1024,6 +1024,9 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n+    /** Return true if the peer has been connected for long enough to do inactivity checks. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576405738",
      "id" : 576405738,
      "in_reply_to_id" : 575894343,
      "line" : 1025,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjQwNTczOA==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1025,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 49,
      "pull_request_review_id" : 590722342,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T21:02:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576405738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576425696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576425696"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "are y'all talking about the comment being unclear or ?",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-15T21:16:27Z",
      "diff_hunk" : "@@ -1024,6 +1024,9 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n+    /** Return true if the peer has been connected for long enough to do inactivity checks. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576425696",
      "id" : 576425696,
      "in_reply_to_id" : 575894343,
      "line" : 1025,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjQyNTY5Ng==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1025,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 49,
      "pull_request_review_id" : 590756322,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T21:16:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576425696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "In the scripted diff I don't like that it may modify non-git user files (e.g. a `net.h.rej` file) in the same folder. Would be better to use `git grep -l '...'`, which would also simplify review, as reviewers don't have to call `git grep` to verify the replacement was complete over all files, including docs.\r\n\r\n\r\nreview ACK a5e15ae45ccae7948a6c5b95e6621f01afb88d55 ð¥\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nreview ACK a5e15ae45ccae7948a6c5b95e6621f01afb88d55 ð¥\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUhixgv9EHlcd7Eo4IXpSgu8XZbUGYox8iHe1MU0pdDdnGPBjdnoB71xvMNUczaF\r\nvDqmc9jIEfT19pPXGJfnOGQ53oWatA9be22GiLjZtjIA+w7slyjnTJ/WM2LCxA1V\r\nEWX2X57ad+DwEHW7YCzmf5pxxm/KK9TV3h3kE9I1yUGwg6FR5INfIyzssPqULAt2\r\n8BexUMoXXaqeAV6WOJRq/9wdtOcv2WwD7YLc340VjdmRRRkVflySKnx0/m2x6oo8\r\nb3zBYj3YC6+UVmPRD2YIexoG+XHAVGXbc2kFRkeJ/Puknt7pWyurIsF6w+dgzM7B\r\nYrsLzEwgO7mO4xvXfvHYwNKuNX3WJTFJ+gpL1dIN7UlJQis4p3bl56Sxtyw6cKM+\r\nd8VZtjYkTcEpL3jKJYnIk4fHFA6WmHaRp7b4FQr6400G2bznF6AHMC2h0z5Jqhpy\r\n63XIWO9kD89mIPxNgzUxA+id/3SoaNPRN0Mj62RxTWmbpRX2gIvCvF/MRZJsdEuC\r\nTQhwMCuo\r\n=FZw8\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `f094bc0ee463f6bec56659b9f20c20ab75a2f829388e57c839500e90f3c196a3  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e892940108f094bc0ee463f6bec56659b9f20c20ab75a2f829388e57c839500e90f3c196a3f01011beafb947cad5485c5cbf07df1ed1d708fff0101deb36d0ac18416cfc647bf5d2d272b708f104602b897af0085b5f1bb341ea0aa00083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6dfff01021d7398b35dd4b19e20e863e2298081508f104602b7ba7f008d2833fe3968fd4970083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6dfff0108b7e7f3d7b5f7dcdfa4a2b7a001bcae708f104602b897af008a555e78dfc3d70110083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267f010ebbd931c9839016f06c407c2fbd4eba108f020e46db98ffba16a31d27c968cfb431e6b622327ba553b0a656a7a93642f7556fe08f104602b897af0088cc18e4ceadfe6990083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2021-02-16T09:02:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#issuecomment-779689700",
      "id" : 779689700,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20721",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTY4OTcwMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T09:02:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779689700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576688160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576688160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll change this in a follow-up.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T09:50:25Z",
      "diff_hunk" : "@@ -1221,18 +1208,17 @@ void CConnman::NotifyNumConnectionsChanged()\n     }\n }\n \n+bool CConnman::RunInactivityChecks(const CNode& node) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576688160",
      "id" : 576688160,
      "in_reply_to_id" : 576394790,
      "line" : 1211,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY4ODE2MA==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 1211,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 46,
      "pull_request_review_id" : 591053805,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:50:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576688160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576691178"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576691178"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks AJ, these are good points.\r\n\r\nYou're wrong about stl algorithms though :grin:",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T09:54:46Z",
      "diff_hunk" : "@@ -3969,43 +3970,39 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     return;\n }\n \n-bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode)\n+bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)\n {\n-    const NodeId peer_id{pnode.GetId()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576691178",
      "id" : 576691178,
      "in_reply_to_id" : 575893265,
      "line" : 4001,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY5MTE3OA==",
      "original_commit_id" : "6a03a1f7e4983af863d759776d91b8ed8495a949",
      "original_line" : 4001,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 591057724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:54:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576691178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576774527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576774527"
         }
      },
      "author_association" : "MEMBER",
      "body" : "unrelated note: Can use the count seconds double helper from #21015     ",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T12:08:12Z",
      "diff_hunk" : "@@ -209,8 +208,8 @@ static RPCHelpMan getpeerinfo()\n         if (stats.m_min_ping_usec < std::numeric_limits<int64_t>::max()) {\n             obj.pushKV(\"minping\", ((double)stats.m_min_ping_usec) / 1e6);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576774527",
      "id" : 576774527,
      "line" : 209,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Njc3NDUyNw==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 209,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 591162406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T12:09:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576774527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576774686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576774686"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T12:08:30Z",
      "diff_hunk" : "@@ -4295,6 +4321,50 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n+{\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (m_connman.RunInactivityChecks(node_to) && peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - peer.m_ping_start.load()), peer.m_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576774686",
      "id" : 576774686,
      "line" : 4332,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Njc3NDY4Ng==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 4332,
      "original_position" : 177,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 177,
      "pull_request_review_id" : 591162406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T12:08:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576774686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576814259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576814259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @MarcoFalke. I'll address this in the follow-up",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T13:17:07Z",
      "diff_hunk" : "@@ -209,8 +208,8 @@ static RPCHelpMan getpeerinfo()\n         if (stats.m_min_ping_usec < std::numeric_limits<int64_t>::max()) {\n             obj.pushKV(\"minping\", ((double)stats.m_min_ping_usec) / 1e6);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576814259",
      "id" : 576814259,
      "in_reply_to_id" : 576774527,
      "line" : 209,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjgxNDI1OQ==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 209,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 591212840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T13:17:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576814259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576838496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576838496"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#21015 isn't merged yet, but hopefully soon will.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T13:53:22Z",
      "diff_hunk" : "@@ -209,8 +208,8 @@ static RPCHelpMan getpeerinfo()\n         if (stats.m_min_ping_usec < std::numeric_limits<int64_t>::max()) {\n             obj.pushKV(\"minping\", ((double)stats.m_min_ping_usec) / 1e6);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576838496",
      "id" : 576838496,
      "in_reply_to_id" : 576774527,
      "line" : 209,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjgzODQ5Ng==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 209,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 591243147,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T13:53:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576838496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576845394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576845394"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I plan to review it soon",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T14:03:07Z",
      "diff_hunk" : "@@ -209,8 +208,8 @@ static RPCHelpMan getpeerinfo()\n         if (stats.m_min_ping_usec < std::numeric_limits<int64_t>::max()) {\n             obj.pushKV(\"minping\", ((double)stats.m_min_ping_usec) / 1e6);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576845394",
      "id" : 576845394,
      "in_reply_to_id" : 576774527,
      "line" : 209,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Njg0NTM5NA==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 209,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 591252275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T14:03:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576845394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576912987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576912987"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll take aj's suggestion here: https://github.com/bitcoin/bitcoin/pull/20721#discussion_r575895661 in a follow-up",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T15:30:25Z",
      "diff_hunk" : "@@ -1221,18 +1221,17 @@ void CConnman::NotifyNumConnectionsChanged()\n     }\n }\n \n+bool CConnman::RunInactivityChecks(const CNode& node) const\n+{\n+    return GetSystemTimeInSeconds() > node.nTimeConnected + m_peer_connect_timeout;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576912987",
      "id" : 576912987,
      "in_reply_to_id" : 575474426,
      "line" : 1213,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjkxMjk4Nw==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1213,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_review_id" : 591341475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T15:30:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576912987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576935113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576935113"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#21198",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T15:58:08Z",
      "diff_hunk" : "@@ -1221,18 +1208,17 @@ void CConnman::NotifyNumConnectionsChanged()\n     }\n }\n \n+bool CConnman::RunInactivityChecks(const CNode& node) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576935113",
      "id" : 576935113,
      "in_reply_to_id" : 576394790,
      "line" : 1211,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjkzNTExMw==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 1211,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 46,
      "pull_request_review_id" : 591369924,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T15:58:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576935113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576935306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576935306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#21198",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T15:58:24Z",
      "diff_hunk" : "@@ -1221,18 +1221,17 @@ void CConnman::NotifyNumConnectionsChanged()\n     }\n }\n \n+bool CConnman::RunInactivityChecks(const CNode& node) const\n+{\n+    return GetSystemTimeInSeconds() > node.nTimeConnected + m_peer_connect_timeout;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576935306",
      "id" : 576935306,
      "in_reply_to_id" : 575895661,
      "line" : 1213,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjkzNTMwNg==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1213,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 48,
      "pull_request_review_id" : 591370203,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T15:58:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576935306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576935419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576935419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#21198",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T15:58:31Z",
      "diff_hunk" : "@@ -1537,7 +1536,7 @@ void CConnman::SocketHandler()\n             if (bytes_sent) RecordBytesSent(bytes_sent);\n         }\n \n-        if (InactivityCheck(*pnode)) pnode->fDisconnect = true;\n+        if (RunInactivityChecks(*pnode) && InactivityCheck(*pnode)) pnode->fDisconnect = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576935419",
      "id" : 576935419,
      "in_reply_to_id" : 575894665,
      "line" : 1518,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjkzNTQxOQ==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1518,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 86,
      "pull_request_review_id" : 591370354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T15:58:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576935419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576935505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576935505"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#21198",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T15:58:37Z",
      "diff_hunk" : "@@ -1024,6 +1024,9 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n+    /** Return true if the peer has been connected for long enough to do inactivity checks. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576935505",
      "id" : 576935505,
      "in_reply_to_id" : 575894343,
      "line" : 1025,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjkzNTUwNQ==",
      "original_commit_id" : "4561423100c1b6a8e778525a027d021b918a6312",
      "original_line" : 1025,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 49,
      "pull_request_review_id" : 591370483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T15:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576935505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576936047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576936047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll do this in #21198 once #21015 is merged.",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T15:59:14Z",
      "diff_hunk" : "@@ -209,8 +208,8 @@ static RPCHelpMan getpeerinfo()\n         if (stats.m_min_ping_usec < std::numeric_limits<int64_t>::max()) {\n             obj.pushKV(\"minping\", ((double)stats.m_min_ping_usec) / 1e6);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576936047",
      "id" : 576936047,
      "in_reply_to_id" : 576774527,
      "line" : 209,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjkzNjA0Nw==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 209,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 591371180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T15:59:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576936047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576936166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576936166"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same same",
      "commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "created_at" : "2021-02-16T15:59:22Z",
      "diff_hunk" : "@@ -4295,6 +4321,50 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     }\n }\n \n+void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer)\n+{\n+    // Use mockable time for ping timeouts.\n+    // This means that setmocktime may cause pings to time out.\n+    auto now = GetTime<std::chrono::microseconds>();\n+\n+    if (m_connman.RunInactivityChecks(node_to) && peer.m_ping_nonce_sent &&\n+        now > peer.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL}) {\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(now - peer.m_ping_start.load()), peer.m_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576936166",
      "id" : 576936166,
      "in_reply_to_id" : 576774686,
      "line" : 4332,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjkzNjE2Ng==",
      "original_commit_id" : "a5e15ae45ccae7948a6c5b95e6621f01afb88d55",
      "original_line" : 4332,
      "original_position" : 177,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 177,
      "pull_request_review_id" : 591371337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20721",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T15:59:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576936166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
