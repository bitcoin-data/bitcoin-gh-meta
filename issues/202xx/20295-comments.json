[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23599](https://github.com/bitcoin/bitcoin/pull/23599) (Tidy up RPCTxSerializationFlags by MarcoFalke)\n* [#23497](https://github.com/bitcoin/bitcoin/pull/23497) (Add `src/node/` and `src/wallet/` code to `node::` and `wallet::` namespaces by ryanofsky)\n* [#22776](https://github.com/bitcoin/bitcoin/pull/22776) (rpc/wallet: add optional transaction(s) to getbalances by kallewoof)\n* [#17786](https://github.com/bitcoin/bitcoin/pull/17786) (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-11-03T17:47:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-721281373",
      "id" : 721281373,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMTI4MTM3Mw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/721281373/reactions"
      },
      "updated_at" : "2021-12-05T10:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/721281373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@Sjors Please note that I'm very new to C++ and I'm here only to learn.\r\n\r\nConcept AKN, IMO can also be useful if the user need info about a pruned block.\r\n\r\nNot sure if `getblockfrompeer` should persist the block, maybe just print it. For consistency the interface of `getblock` (verbosity 0, 1, 2) could be reused.\r\nMaybe `getblockfrompeer` could just be a flag of `getblock`.\r\n\r\nAlso, IMO `GetBlockChecked` should notify the user to use `getblockfrompeer` for block that are not on disk.\r\n\r\n**Check if the node is connected**\r\nChecking for connectivity could be done with `connman->GetNodeCount` as in [mining.cpp](https://github.com/bitcoin/bitcoin/blob/master/src/rpc/mining.cpp#L666).\r\n\r\n**Mark the block as in flight**\r\nInstead of mark the block as in flight and persist the block, I would add 2 fields to the public interface of `CNode` the first to notify `ProcessMessage` that a block with a certain hash is  expected, the second to check (in a loop) for the requested block.\r\n\r\n",
      "created_at" : "2020-11-06T18:20:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-723228594",
      "id" : 723228594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMzIyODU5NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-06T18:20:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/723228594",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/6207037?v=4",
         "events_url" : "https://api.github.com/users/Fi3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Fi3/followers",
         "following_url" : "https://api.github.com/users/Fi3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Fi3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Fi3",
         "id" : 6207037,
         "login" : "Fi3",
         "node_id" : "MDQ6VXNlcjYyMDcwMzc=",
         "organizations_url" : "https://api.github.com/users/Fi3/orgs",
         "received_events_url" : "https://api.github.com/users/Fi3/received_events",
         "repos_url" : "https://api.github.com/users/Fi3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Fi3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Fi3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Fi3"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Fi3 being able to (temporarily) retrieve pruned blocks is useful too indeed.\r\n\r\nIt can be difficult to find nodes that still have a stale block, so I'd rather hold on to it. That also allows inspection using the regular methods, `getblock`, `getchaintips` and `getrawtransaction` (e.g. to learn about a specific doublespend). Pruned nodes will toss it automatically after a while (IIUC).\r\n\r\nI also want to be able to fully validate the block. It's very time consuming, but it works: call `invalidateblock` on the main chain block for the same height, so reorgs to the block you just downloaded and verified it. Then call `reconsiderblock` to sync to the tip again.",
      "created_at" : "2020-11-11T11:06:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-725359736",
      "id" : 725359736,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNTM1OTczNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-11T11:06:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/725359736",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK\r\n\r\nThis would be useful for https://forkmonitor.info/ to assess the validity of shorter chains\r\n\r\n",
      "created_at" : "2020-11-11T13:59:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-725438758",
      "id" : 725438758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNTQzODc1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-11T13:59:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/725438758",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/42411042?v=4",
         "events_url" : "https://api.github.com/users/BitMEXResearch/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitMEXResearch/followers",
         "following_url" : "https://api.github.com/users/BitMEXResearch/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitMEXResearch/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitMEXResearch",
         "id" : 42411042,
         "login" : "BitMEXResearch",
         "node_id" : "MDQ6VXNlcjQyNDExMDQy",
         "organizations_url" : "https://api.github.com/users/BitMEXResearch/orgs",
         "received_events_url" : "https://api.github.com/users/BitMEXResearch/received_events",
         "repos_url" : "https://api.github.com/users/BitMEXResearch/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitMEXResearch/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitMEXResearch/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitMEXResearch"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nThis would be very useful for testing",
      "created_at" : "2020-11-12T00:30:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-725742916",
      "id" : 725742916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNTc0MjkxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-12T00:30:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/725742916",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/15256660?v=4",
         "events_url" : "https://api.github.com/users/benthecarman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benthecarman/followers",
         "following_url" : "https://api.github.com/users/benthecarman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benthecarman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benthecarman",
         "id" : 15256660,
         "login" : "benthecarman",
         "node_id" : "MDQ6VXNlcjE1MjU2NjYw",
         "organizations_url" : "https://api.github.com/users/benthecarman/orgs",
         "received_events_url" : "https://api.github.com/users/benthecarman/received_events",
         "repos_url" : "https://api.github.com/users/benthecarman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benthecarman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benthecarman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benthecarman"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@Sjors \r\n\r\n> It can be difficult to find nodes that still have a stale block, so I'd rather hold on to it. \r\n\r\nI agree, didn't consider it.",
      "created_at" : "2020-11-13T12:37:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-726741734",
      "id" : 726741734,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNjc0MTczNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-13T12:37:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/726741734",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/6207037?v=4",
         "events_url" : "https://api.github.com/users/Fi3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Fi3/followers",
         "following_url" : "https://api.github.com/users/Fi3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Fi3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Fi3",
         "id" : 6207037,
         "login" : "Fi3",
         "node_id" : "MDQ6VXNlcjYyMDcwMzc=",
         "organizations_url" : "https://api.github.com/users/Fi3/orgs",
         "received_events_url" : "https://api.github.com/users/Fi3/received_events",
         "repos_url" : "https://api.github.com/users/Fi3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Fi3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Fi3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Fi3"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept -1\r\n\r\nI think it would be better to just do the right thing if you `getblock` a block you don't have... Don't make users figure out which peer has it...?",
      "created_at" : "2020-11-13T18:09:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-726929962",
      "id" : 726929962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNjkyOTk2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-13T18:09:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/726929962",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@luke-jr my thinking was to expand it later, to try all peers: `getblockfrompeer HASH *`. Overloading `getblock` in a way that could make it unresponsive would seem controversial. Adding a `fetch_from_peer` argument to `getblock` could make sense as an alternative.\r\n\r\nIn practice none of the existing peers might have it, so you'll have to:\r\n* manually connect to new peers and retry; or\r\n* add an argument with an array of IPs to try (but not keep as a peer); or\r\n* go through peers.dat entries\r\n\r\nThis could get complicated, so a fresh RPC seemed like a more future proof approach.",
      "created_at" : "2020-11-14T12:31:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-727200935",
      "id" : 727200935,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNzIwMDkzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-14T12:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/727200935",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "0xC46086A8e6FD0013c9Fb4a5937fe3E75a7F957C6",
      "created_at" : "2020-11-14T17:29:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-727239208",
      "id" : 727239208,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNzIzOTIwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-14T17:29:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/727239208",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/57122455?v=4",
         "events_url" : "https://api.github.com/users/hamedtayeban/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hamedtayeban/followers",
         "following_url" : "https://api.github.com/users/hamedtayeban/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hamedtayeban/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hamedtayeban",
         "id" : 57122455,
         "login" : "hamedtayeban",
         "node_id" : "MDQ6VXNlcjU3MTIyNDU1",
         "organizations_url" : "https://api.github.com/users/hamedtayeban/orgs",
         "received_events_url" : "https://api.github.com/users/hamedtayeban/received_events",
         "repos_url" : "https://api.github.com/users/hamedtayeban/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hamedtayeban/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hamedtayeban/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hamedtayeban"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "https://freewallet.org/id/5d88cebc/btc",
      "created_at" : "2020-11-14T17:30:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-727239328",
      "id" : 727239328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNzIzOTMyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-14T17:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/727239328",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/57122455?v=4",
         "events_url" : "https://api.github.com/users/hamedtayeban/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hamedtayeban/followers",
         "following_url" : "https://api.github.com/users/hamedtayeban/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hamedtayeban/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hamedtayeban",
         "id" : 57122455,
         "login" : "hamedtayeban",
         "node_id" : "MDQ6VXNlcjU3MTIyNDU1",
         "organizations_url" : "https://api.github.com/users/hamedtayeban/orgs",
         "received_events_url" : "https://api.github.com/users/hamedtayeban/received_events",
         "repos_url" : "https://api.github.com/users/hamedtayeban/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hamedtayeban/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hamedtayeban/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hamedtayeban"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-09T15:24:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-741842599",
      "id" : 741842599,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTg0MjU5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-09T15:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741842599",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I moved `FetchBlock` to the PeerManager while rebasing on #19910. Not sure if that's the right home for it, cc @jnewbery.",
      "created_at" : "2020-12-09T16:15:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-741878271",
      "id" : 741878271,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTg3ODI3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-09T16:15:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741878271",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-13T09:12:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-759313339",
      "id" : 759313339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1OTMxMzMzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-13T09:12:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/759313339",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-28T18:59:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-769302539",
      "id" : 769302539,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTMwMjUzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-28T18:59:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769302539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Does this work with the pruned node too? If yes, then this implements option 2) of https://github.com/bitcoin/bitcoin/issues/19312\r\n",
      "created_at" : "2021-03-26T19:25:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-808460439",
      "id" : 808460439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODQ2MDQzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-26T19:25:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808460439",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It does, however I'm not sure how quickly the node re-prunes it.",
      "created_at" : "2021-03-29T09:16:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-809216580",
      "id" : 809216580,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTIxNjU4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-29T09:16:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809216580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-01T09:06:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-811768014",
      "id" : 811768014,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTc2ODAxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-01T09:06:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811768014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased. No longer needs to haul the mempool around.",
      "created_at" : "2021-04-01T09:36:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-811786284",
      "id" : 811786284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTc4NjI4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-01T09:36:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811786284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-13T14:24:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-818778507",
      "id" : 818778507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODc3ODUwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-13T14:24:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818778507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-21T05:41:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-823792076",
      "id" : 823792076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzc5MjA3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T05:41:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823792076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after #21719",
      "created_at" : "2021-04-21T07:59:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-823861952",
      "id" : 823861952,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzg2MTk1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T07:59:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823861952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Linter:\r\n> A new circular dependency in the form of \"rpc/blockchain -> rpc/net -> rpc/blockchain\" appears to have been introduced.\r\n\r\n@MarcoFalke any thoughts on how to avoid that? I could move this new RPC method to `rpc/net`, or maybe the `EnsurePeerman` and `EnsureConnman` helpers should be in their own file?",
      "created_at" : "2021-04-21T08:09:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-823869122",
      "id" : 823869122,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzg2OTEyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T08:10:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823869122",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I guess by moving the `Ensure*` helpers to `rpc/util` (or a new module)?",
      "created_at" : "2021-04-21T09:14:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-823910779",
      "id" : 823910779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzkxMDc3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T09:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823910779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617408180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617408180"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to make the pass-by-value `NodeId nodeid` const.\r\n\r\nStyle guide is to use snake_case and not hungarian notation for parameter names:\r\n\r\n```suggestion\r\n    bool FetchBlock(const NodeId id, const CBlockIndex* index) override;\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:24:40Z",
      "diff_hunk" : "@@ -246,6 +246,7 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Implement PeerManager */\n     void CheckForStaleTipAndEvictPeers() override;\n+    bool FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617408180",
      "id" : 617408180,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQwODE4MA==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 249,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617408180",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617411027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617411027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this `EXCLUSIVE_LOCKS_REQUIRED(cs_main)` is doing anything. This function is being called without `cs_main` (by `getblockfrompeer()`).\r\n\r\nI think it's better to remove this annotation and lock `cs_main` within this function.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:27:29Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617411027",
      "id" : 617411027,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQxMTAyNw==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1256,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617411027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617412992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617412992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Move this down to where it's first used, and make const:\r\n\r\n```suggestion\r\n    const uint32_t nFetchFlags = state->fHaveWitness ? MSG_WITNESS_FLAG : 0;\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:29:27Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{\n+    PeerRef peer = GetPeerRef(nodeid);\n+    if (peer == nullptr) return false;\n+    uint32_t nFetchFlags = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617412992",
      "id" : 617412992,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQxMjk5Mg==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1260,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617412992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617422387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617422387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Use initializer list ctor:\r\n\r\n```suggestion\r\n    std::vector<CInv> vInv{CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash())};\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:42:56Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{\n+    PeerRef peer = GetPeerRef(nodeid);\n+    if (peer == nullptr) return false;\n+    uint32_t nFetchFlags = 0;\n+    CNodeState* state = State(nodeid);\n+    if (state == nullptr) {\n+        return false;\n+    }\n+    const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n+    if (pindex->nHeight > node_sync_height) {\n+        return false;\n+    }\n+    if (state->fHaveWitness) {\n+        nFetchFlags |= MSG_WITNESS_FLAG;\n+    }\n+    std::vector<CInv> vInv(1);\n+    vInv[0] = CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617422387",
      "id" : 617422387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyMjM4Nw==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1273,
      "original_position" : 29,
      "original_start_line" : 1272,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617422387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617422621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617422621"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps return false if we're importing or reindexing (since the received `block` message will be ignored)",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:43:22Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617422621",
      "id" : 617422621,
      "line" : 1261,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyMjYyMQ==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1261,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617422621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617423719"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617423719"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps just return false if the peer doesn't have `MSG_WITNESS_FLAG`. It's 2021. Receiving a block without witnesses isn't going to be useful.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:45:21Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{\n+    PeerRef peer = GetPeerRef(nodeid);\n+    if (peer == nullptr) return false;\n+    uint32_t nFetchFlags = 0;\n+    CNodeState* state = State(nodeid);\n+    if (state == nullptr) {\n+        return false;\n+    }\n+    const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n+    if (pindex->nHeight > node_sync_height) {\n+        return false;\n+    }\n+    if (state->fHaveWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617423719",
      "id" : 617423719,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyMzcxOQ==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1269,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617423719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617425121"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617425121"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps move this above the `ForNode()` call and don't send the `getdata` if it returns false, since that indicates that the block is already in flight. We don't want a faulty RPC client causing us to spam a peer with multiple requests for the same block.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:47:36Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{\n+    PeerRef peer = GetPeerRef(nodeid);\n+    if (peer == nullptr) return false;\n+    uint32_t nFetchFlags = 0;\n+    CNodeState* state = State(nodeid);\n+    if (state == nullptr) {\n+        return false;\n+    }\n+    const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n+    if (pindex->nHeight > node_sync_height) {\n+        return false;\n+    }\n+    if (state->fHaveWitness) {\n+        nFetchFlags |= MSG_WITNESS_FLAG;\n+    }\n+    std::vector<CInv> vInv(1);\n+    vInv[0] = CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash());\n+    bool success = m_connman.ForNode(nodeid, [this, vInv](CNode* pnode) {\n+        const CNetMsgMaker msgMaker(pnode->GetCommonVersion());\n+        this->m_connman.PushMessage(pnode, msgMaker.Make(NetMsgType::GETDATA, vInv));\n+        return true;\n+    });\n+    MarkBlockAsInFlight(nodeid, pindex->GetBlockHash(), pindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617425121",
      "id" : 617425121,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyNTEyMQ==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1279,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617425121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617425468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617425468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe add a log if the message is sent.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:48:11Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{\n+    PeerRef peer = GetPeerRef(nodeid);\n+    if (peer == nullptr) return false;\n+    uint32_t nFetchFlags = 0;\n+    CNodeState* state = State(nodeid);\n+    if (state == nullptr) {\n+        return false;\n+    }\n+    const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n+    if (pindex->nHeight > node_sync_height) {\n+        return false;\n+    }\n+    if (state->fHaveWitness) {\n+        nFetchFlags |= MSG_WITNESS_FLAG;\n+    }\n+    std::vector<CInv> vInv(1);\n+    vInv[0] = CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash());\n+    bool success = m_connman.ForNode(nodeid, [this, vInv](CNode* pnode) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617425468",
      "id" : 617425468,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyNTQ2OA==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1274,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617425468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617425832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617425832"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style guide:\r\n\r\n```suggestion\r\n    std::vector<CInv> invs(1);\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:48:46Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{\n+    PeerRef peer = GetPeerRef(nodeid);\n+    if (peer == nullptr) return false;\n+    uint32_t nFetchFlags = 0;\n+    CNodeState* state = State(nodeid);\n+    if (state == nullptr) {\n+        return false;\n+    }\n+    const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n+    if (pindex->nHeight > node_sync_height) {\n+        return false;\n+    }\n+    if (state->fHaveWitness) {\n+        nFetchFlags |= MSG_WITNESS_FLAG;\n+    }\n+    std::vector<CInv> vInv(1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617425832",
      "id" : 617425832,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyNTgzMg==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1272,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617425832",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617426187"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617426187"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Don't use the global chainman - use `EnsureChainman()`",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:49:20Z",
      "diff_hunk" : "@@ -764,6 +767,46 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempts to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::NONE, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const CBlockIndex* pblockindex;\n+    {\n+        LOCK(cs_main);\n+        pblockindex = g_chainman.m_blockman.LookupBlockIndex(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617426187",
      "id" : 617426187,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyNjE4Nw==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 790,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617426187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617426660"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617426660"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Move these to the top of the function - if these assumptions fail we should throw immediately instead of taking cs_main and looking up the block.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:50:05Z",
      "diff_hunk" : "@@ -764,6 +767,46 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempts to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::NONE, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const CBlockIndex* pblockindex;\n+    {\n+        LOCK(cs_main);\n+        pblockindex = g_chainman.m_blockman.LookupBlockIndex(hash);\n+    }\n+\n+    if (!pblockindex) {\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n+    }\n+\n+    const UniValue &id_arg = request.params[1];\n+    const NodeId nodeid = (NodeId) id_arg.get_int64();\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    PeerManager& peerman = EnsurePeerman(node);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617426660",
      "id" : 617426660,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyNjY2MA==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 800,
      "original_position" : 51,
      "original_start_line" : 798,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617426660",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617427542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617427542"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const CBlockIndex* const pblockindex = WITH_LOCK(cs_main, return g_chainman.m_blockman.LookupBlockIndex(hash););\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:51:38Z",
      "diff_hunk" : "@@ -764,6 +767,46 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempts to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::NONE, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const CBlockIndex* pblockindex;\n+    {\n+        LOCK(cs_main);\n+        pblockindex = g_chainman.m_blockman.LookupBlockIndex(hash);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617427542",
      "id" : 617427542,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyNzU0Mg==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 791,
      "original_position" : 42,
      "original_start_line" : 787,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617427542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617427934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617427934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Return an empty object in case we want to extend the API in the future.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:52:17Z",
      "diff_hunk" : "@@ -764,6 +767,46 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempts to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::NONE, \"\", \"\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617427934",
      "id" : 617427934,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyNzkzNA==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 778,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617427934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617428096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617428096"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Imperative mood:\r\n\r\n```suggestion\r\n                \"\\nAttempt to fetch block from a given peer.\\n\",\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T10:52:34Z",
      "diff_hunk" : "@@ -764,6 +767,46 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempts to fetch block from a given peer.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617428096",
      "id" : 617428096,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQyODA5Ng==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 773,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 640903582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617428096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I moved FetchBlock to the PeerManager while rebasing on #19910. Not sure if that's the right home for it, cc @jnewbery.\r\n\r\nIt's exactly the right place for it. `PeerManager` is the node's interface to net_processing.",
      "created_at" : "2021-04-21T10:54:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-823970129",
      "id" : 823970129,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzk3MDEyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T10:54:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823970129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617620994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617620994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I followed your suggestion below to just ignore pre-segwit nodes, so no need to have `nFetchFlags` around...",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T14:49:56Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{\n+    PeerRef peer = GetPeerRef(nodeid);\n+    if (peer == nullptr) return false;\n+    uint32_t nFetchFlags = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617620994",
      "id" : 617620994,
      "in_reply_to_id" : 617412992,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzYyMDk5NA==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1260,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 641190502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617620994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the feedback! I moved the Ensure* helpers to `util.h` and addressed the above comments.",
      "created_at" : "2021-04-21T15:18:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-824145867",
      "id" : 824145867,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNDE0NTg2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T15:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824145867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617647027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617647027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure if I got this right now...",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T15:19:02Z",
      "diff_hunk" : "@@ -1252,6 +1253,33 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{\n+    PeerRef peer = GetPeerRef(nodeid);\n+    if (peer == nullptr) return false;\n+    uint32_t nFetchFlags = 0;\n+    CNodeState* state = State(nodeid);\n+    if (state == nullptr) {\n+        return false;\n+    }\n+    const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n+    if (pindex->nHeight > node_sync_height) {\n+        return false;\n+    }\n+    if (state->fHaveWitness) {\n+        nFetchFlags |= MSG_WITNESS_FLAG;\n+    }\n+    std::vector<CInv> vInv(1);\n+    vInv[0] = CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash());\n+    bool success = m_connman.ForNode(nodeid, [this, vInv](CNode* pnode) {\n+        const CNetMsgMaker msgMaker(pnode->GetCommonVersion());\n+        this->m_connman.PushMessage(pnode, msgMaker.Make(NetMsgType::GETDATA, vInv));\n+        return true;\n+    });\n+    MarkBlockAsInFlight(nodeid, pindex->GetBlockHash(), pindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617647027",
      "id" : 617647027,
      "in_reply_to_id" : 617425121,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzY0NzAyNw==",
      "original_commit_id" : "f8d9dbf7960f3bf40ef3f87501cf903b5a4115d0",
      "original_line" : 1279,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 641225145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617647027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617676009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617676009"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Prefer a named cast to c-style casts (https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#es49-if-you-must-use-a-cast-use-a-named-cast)\r\n\r\n```suggestion\r\n    const NodeId nodeid = static_cast<NodeId>(id_arg.get_int64());\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T15:52:52Z",
      "diff_hunk" : "@@ -764,6 +716,43 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::ANY, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const UniValue &id_arg = request.params[1];\n+    const NodeId nodeid = (NodeId) id_arg.get_int64();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617676009",
      "id" : 617676009,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzY3NjAwOQ==",
      "original_commit_id" : "91abc3760e8eff5ee30fa0b29b93754438ba16d2",
      "original_line" : 735,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 641263501,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617676009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617677445"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617677445"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This ordering seems weird to me (read param 1, then state assumptions, then read param 0). I'd suggest:\r\n\r\n```suggestion\r\n    const NodeContext& node = EnsureAnyNodeContext(request.context);\r\n    ChainstateManager& chainman = EnsureChainman(node);\r\n    PeerManager& peerman = EnsurePeerman(node);\r\n\r\n    uint256 hash(ParseHashV(request.params[0], \"hash\"));\r\n\r\n    const UniValue &id_arg = request.params[1];\r\n    const NodeId nodeid = (NodeId) id_arg.get_int64();\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T15:54:36Z",
      "diff_hunk" : "@@ -764,6 +716,43 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::ANY, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const UniValue &id_arg = request.params[1];\n+    const NodeId nodeid = (NodeId) id_arg.get_int64();\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617677445",
      "id" : 617677445,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzY3NzQ0NQ==",
      "original_commit_id" : "91abc3760e8eff5ee30fa0b29b93754438ba16d2",
      "original_line" : 767,
      "original_position" : 98,
      "original_start_line" : 734,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 641263501,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617677445",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617684847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617684847"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps join these two lines. No point in having a `id_arg` var that just gets used once and thrown away:\r\n\r\n```suggestion\r\n    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T16:03:31Z",
      "diff_hunk" : "@@ -764,6 +716,43 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::ANY, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const UniValue &id_arg = request.params[1];\n+    const NodeId nodeid = (NodeId) id_arg.get_int64();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617684847",
      "id" : 617684847,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzY4NDg0Nw==",
      "original_commit_id" : "91abc3760e8eff5ee30fa0b29b93754438ba16d2",
      "original_line" : 735,
      "original_position" : 93,
      "original_start_line" : 734,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 641263501,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617684847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617809637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617809637"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This causes a link failure for libbitcoin_common.\r\n\r\nPerhaps move these `Ensure*` functions to a new `src/rpc/server_util.cpp` which is part of libbitcoin_server. `src/rpc/util` is for utility functions that are shared between server and client.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T19:10:36Z",
      "diff_hunk" : "@@ -20,6 +25,71 @@\n const std::string UNIX_EPOCH_TIME = \"UNIX epoch time\";\n const std::string EXAMPLE_ADDRESS[2] = {\"bc1q09vm5lfy0j5reeulh4x5752q25uqqvz34hufdl\", \"bc1q02ad21edsxd23d32dfgqqsz4vv4nmtfzuklhy3\"};\n \n+NodeContext& EnsureAnyNodeContext(const std::any& context)\n+{\n+    auto node_context = util::AnyPtr<NodeContext>(context);\n+    if (!node_context) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Node context not found\");\n+    }\n+    return *node_context;\n+}\n+\n+CTxMemPool& EnsureMemPool(const NodeContext& node)\n+{\n+    if (!node.mempool) {\n+        throw JSONRPCError(RPC_CLIENT_MEMPOOL_DISABLED, \"Mempool disabled or instance not found\");\n+    }\n+    return *node.mempool;\n+}\n+\n+CTxMemPool& EnsureAnyMemPool(const std::any& context)\n+{\n+    return EnsureMemPool(EnsureAnyNodeContext(context));\n+}\n+\n+ChainstateManager& EnsureChainman(const NodeContext& node)\n+{\n+    if (!node.chainman) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Node chainman not found\");\n+    }\n+    WITH_LOCK(::cs_main, CHECK_NONFATAL(std::addressof(g_chainman) == std::addressof(*node.chainman)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617809637",
      "id" : 617809637,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzgwOTYzNw==",
      "original_commit_id" : "065540ad54940bd5b03c4275b7ea16001b91b80b",
      "original_line" : 55,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/rpc/util.cpp",
      "position" : null,
      "pull_request_review_id" : 641437093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617809637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617812676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617812676"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I see. For some reason macOS is totally happy with it, but on Linux I can see it blow up.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T19:16:03Z",
      "diff_hunk" : "@@ -20,6 +25,71 @@\n const std::string UNIX_EPOCH_TIME = \"UNIX epoch time\";\n const std::string EXAMPLE_ADDRESS[2] = {\"bc1q09vm5lfy0j5reeulh4x5752q25uqqvz34hufdl\", \"bc1q02ad21edsxd23d32dfgqqsz4vv4nmtfzuklhy3\"};\n \n+NodeContext& EnsureAnyNodeContext(const std::any& context)\n+{\n+    auto node_context = util::AnyPtr<NodeContext>(context);\n+    if (!node_context) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Node context not found\");\n+    }\n+    return *node_context;\n+}\n+\n+CTxMemPool& EnsureMemPool(const NodeContext& node)\n+{\n+    if (!node.mempool) {\n+        throw JSONRPCError(RPC_CLIENT_MEMPOOL_DISABLED, \"Mempool disabled or instance not found\");\n+    }\n+    return *node.mempool;\n+}\n+\n+CTxMemPool& EnsureAnyMemPool(const std::any& context)\n+{\n+    return EnsureMemPool(EnsureAnyNodeContext(context));\n+}\n+\n+ChainstateManager& EnsureChainman(const NodeContext& node)\n+{\n+    if (!node.chainman) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Node chainman not found\");\n+    }\n+    WITH_LOCK(::cs_main, CHECK_NONFATAL(std::addressof(g_chainman) == std::addressof(*node.chainman)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617812676",
      "id" : 617812676,
      "in_reply_to_id" : 617809637,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzgxMjY3Ng==",
      "original_commit_id" : "065540ad54940bd5b03c4275b7ea16001b91b80b",
      "original_line" : 55,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/rpc/util.cpp",
      "position" : null,
      "pull_request_review_id" : 641441176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617812676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I added `server_util.cpp`. This seems to make the linker happy.",
      "created_at" : "2021-04-21T19:38:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-824307731",
      "id" : 824307731,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNDMwNzczMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T19:38:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824307731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617840061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617840061"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "use spaces, not tab",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T20:02:50Z",
      "diff_hunk" : "@@ -199,12 +199,12 @@ BITCOIN_CORE_H = \\\n   rpc/blockchain.h \\\n   rpc/client.h \\\n   rpc/mining.h \\\n-  rpc/net.h \\\n   rpc/protocol.h \\\n   rpc/rawtransaction_util.h \\\n   rpc/register.h \\\n   rpc/request.h \\\n   rpc/server.h \\\n+\trpc/server_util.h \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617840061",
      "id" : 617840061,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzg0MDA2MQ==",
      "original_commit_id" : "f2208cf5d416a3c334e3d9833f41eb29e53ac5f4",
      "original_line" : 207,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/Makefile.am",
      "position" : null,
      "pull_request_review_id" : 641475969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617840061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617840149"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617840149"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "use spaces, not tab",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T20:02:57Z",
      "diff_hunk" : "@@ -345,6 +345,7 @@ libbitcoin_server_a_SOURCES = \\\n   rpc/net.cpp \\\n   rpc/rawtransaction.cpp \\\n   rpc/server.cpp \\\n+\trpc/server_util.cpp \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617840149",
      "id" : 617840149,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzg0MDE0OQ==",
      "original_commit_id" : "f2208cf5d416a3c334e3d9833f41eb29e53ac5f4",
      "original_line" : 348,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/Makefile.am",
      "position" : null,
      "pull_request_review_id" : 641475969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617840149",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617840256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617840256"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "use spaces, not tab",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-21T20:03:09Z",
      "diff_hunk" : "@@ -534,7 +535,7 @@ libbitcoin_common_a_SOURCES = \\\n   psbt.cpp \\\n   rpc/rawtransaction_util.cpp \\\n   rpc/external_signer.cpp \\\n-  rpc/util.cpp \\\n+\trpc/util.cpp \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r617840256",
      "id" : 617840256,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzg0MDI1Ng==",
      "original_commit_id" : "f2208cf5d416a3c334e3d9833f41eb29e53ac5f4",
      "original_line" : 538,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/Makefile.am",
      "position" : null,
      "pull_request_review_id" : 641475969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617840256",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618109487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618109487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can remove this comment? The code is already self-documenting and one can see that all helpers in this section start with `Ensure`.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T06:18:33Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_RPC_SERVER_UTIL_H\n+#define BITCOIN_RPC_SERVER_UTIL_H\n+\n+#include <rpc/protocol.h>\n+#include <rpc/request.h>\n+\n+class CBlockPolicyEstimator;\n+class CConnman;\n+class CTxMemPool;\n+struct NodeContext;\n+class PeerManager;\n+\n+/**\n+ * Ensure* helpers\n+ */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618109487",
      "id" : 618109487,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODEwOTQ4Nw==",
      "original_commit_id" : "f2208cf5d416a3c334e3d9833f41eb29e53ac5f4",
      "original_line" : 19,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/rpc/server_util.h",
      "position" : null,
      "pull_request_review_id" : 641812202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618109487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Comments addressed.",
      "created_at" : "2021-04-22T07:14:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-824600917",
      "id" : 824600917,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNDYwMDkxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-22T07:14:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824600917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The includes could be improved to include what's needed and not include what's not needed:\r\n\r\n```diff\r\ndiff --git a/src/rpc/server_util.cpp b/src/rpc/server_util.cpp\r\nindex dfe07f5c3d..046a630b51 100644\r\n--- a/src/rpc/server_util.cpp\r\n+++ b/src/rpc/server_util.cpp\r\n@@ -2,12 +2,18 @@\r\n // Distributed under the MIT software license, see the accompanying\r\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n \r\n+#include <rpc/server_util.h>\r\n+\r\n #include <net_processing.h>\r\n #include <node/context.h>\r\n-#include <rpc/server_util.h>\r\n+#include <policy/fees.h>\r\n+#include <rpc/protocol.h>\r\n+#include <rpc/request.h>\r\n+#include <txmempool.h>\r\n #include <util/system.h>\r\n #include <validation.h>\r\n-#include <validationinterface.h>\r\n+\r\n+#include <any>\r\n \r\n NodeContext& EnsureAnyNodeContext(const std::any& context)\r\n {\r\ndiff --git a/src/rpc/server_util.h b/src/rpc/server_util.h\r\nindex c330efd0e6..dd8e8a6042 100644\r\n--- a/src/rpc/server_util.h\r\n+++ b/src/rpc/server_util.h\r\n@@ -5,11 +5,11 @@\r\n #ifndef BITCOIN_RPC_SERVER_UTIL_H\r\n #define BITCOIN_RPC_SERVER_UTIL_H\r\n \r\n-#include <rpc/protocol.h>\r\n-#include <rpc/request.h>\r\n+#include <any>\r\n \r\n class CBlockPolicyEstimator;\r\n class CConnman;\r\n+class ChainstateManager;\r\n class CTxMemPool;\r\n struct NodeContext;\r\n class PeerManager;\r\n```",
      "created_at" : "2021-04-22T08:04:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-824632537",
      "id" : 824632537,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNDYzMjUzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-22T08:04:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824632537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Also done.",
      "created_at" : "2021-04-22T08:23:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-824644479",
      "id" : 824644479,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNDY0NDQ3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-22T08:23:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824644479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618283846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618283846"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you're taking a pointer, you should check that it's non-null before dereferencing it. Even better, pass by reference to communicate that this *must* be called with a valid `CBlockIndex`:\r\n\r\n<details>\r\n<summary>Diff</summary>\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex a822960dc2..f552aa36b5 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -246,7 +246,7 @@ public:\r\n \r\n     /** Implement PeerManager */\r\n     void CheckForStaleTipAndEvictPeers() override;\r\n-    bool FetchBlock(NodeId id, const CBlockIndex* index) override;\r\n+    bool FetchBlock(NodeId id, const CBlockIndex& index) override;\r\n     bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats) const override;\r\n     bool IgnoresIncomingTxs() override { return m_ignore_incoming_txs; }\r\n     void SendPings() override;\r\n@@ -1253,7 +1253,7 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\r\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\r\n }\r\n \r\n-bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex* index)\r\n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\r\n {\r\n     PeerRef peer = GetPeerRef(id);\r\n     if (peer == nullptr) return false;\r\n@@ -1263,12 +1263,12 @@ bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex* index)\r\n     if (state == nullptr) return false;\r\n     if (!state->fHaveWitness) return false;\r\n     const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\r\n-    if (index->nHeight > node_sync_height) {\r\n+    if (index.nHeight > node_sync_height) {\r\n         return false;\r\n     }\r\n-    std::vector<CInv> invs{CInv(MSG_BLOCK | MSG_WITNESS_FLAG, index->GetBlockHash())};\r\n+    std::vector<CInv> invs{CInv(MSG_BLOCK | MSG_WITNESS_FLAG, index.GetBlockHash())};\r\n     // Mark block as in-flight unless it already is\r\n-    if (!MarkBlockAsInFlight(id, index->GetBlockHash(), index)) return false;\r\n+    if (!MarkBlockAsInFlight(id, index.GetBlockHash(), &index)) return false;\r\n     bool success = m_connman.ForNode(id, [this, invs](CNode* pnode) {\r\n         const CNetMsgMaker msgMaker(pnode->GetCommonVersion());\r\n         this->m_connman.PushMessage(pnode, msgMaker.Make(NetMsgType::GETDATA, invs));\r\n@@ -1276,12 +1276,12 @@ bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex* index)\r\n     });\r\n     if (success) {\r\n         LogPrint(BCLog::NET, \"Requesting block %s from peer=%d\\n\",\r\n-                index->GetBlockHash().ToString(), id);\r\n+                index.GetBlockHash().ToString(), id);\r\n     } else {\r\n         // Remove block from in-flight\r\n-        MarkBlockAsReceived(index->GetBlockHash());\r\n+        MarkBlockAsReceived(index.GetBlockHash());\r\n         LogPrint(BCLog::NET, \"Failed to request block %s from peer=%d\\n\",\r\n-                index->GetBlockHash().ToString(), id);\r\n+                index.GetBlockHash().ToString(), id);\r\n     }\r\n     return success;\r\n }\r\ndiff --git a/src/net_processing.h b/src/net_processing.h\r\nindex 577c925562..659504397f 100644\r\n--- a/src/net_processing.h\r\n+++ b/src/net_processing.h\r\n@@ -43,7 +43,7 @@ public:\r\n     virtual ~PeerManager() { }\r\n \r\n     /** Attempt to manually fetch block from a given node. */\r\n-    virtual bool FetchBlock(const NodeId nodeid, const CBlockIndex* pindex) = 0;\r\n+    virtual bool FetchBlock(const NodeId nodeid, const CBlockIndex& pindex) = 0;\r\n \r\n     /** Get statistics from node state */\r\n     virtual bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats) const = 0;\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex aa6b216ab1..cb3f2f3abc 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -746,7 +746,7 @@ static RPCHelpMan getblockfrompeer()\r\n         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\r\n     }\r\n \r\n-    if (!peerman.FetchBlock(nodeid, pblockindex)) {\r\n+    if (!peerman.FetchBlock(nodeid, *pblockindex)) {\r\n         throw JSONRPCError(RPC_MISC_ERROR, \"Failed to fetch block from peer\");\r\n     }\r\n     return UniValue::VOBJ;\r\n```\r\n\r\n</details>",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T10:35:23Z",
      "diff_hunk" : "@@ -1252,6 +1253,39 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex* index)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618283846",
      "id" : 618283846,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODI4Mzg0Ng==",
      "original_commit_id" : "7544381c2e755a418b1648a2d8b14ca1c39c5345",
      "original_line" : 1256,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 642040116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618283846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618284866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618284866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider adding some line breaks to this function to split up the units of logic. It's a bit of a wall of text right now.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T10:36:57Z",
      "diff_hunk" : "@@ -1252,6 +1253,39 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex* index)\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618284866",
      "id" : 618284866,
      "line" : 1261,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODI4NDg2Ng==",
      "original_commit_id" : "7544381c2e755a418b1648a2d8b14ca1c39c5345",
      "original_line" : 1261,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 642041410,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618284866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618364702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618364702"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I added some line breaks and prose.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T12:42:12Z",
      "diff_hunk" : "@@ -1252,6 +1253,39 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex* index)\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618364702",
      "id" : 618364702,
      "in_reply_to_id" : 618284866,
      "line" : 1261,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODM2NDcwMg==",
      "original_commit_id" : "7544381c2e755a418b1648a2d8b14ca1c39c5345",
      "original_line" : 1261,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 642149407,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618364702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618443929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618443929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`peer` isn't used. You can remove it.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:17:16Z",
      "diff_hunk" : "@@ -1252,6 +1253,47 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\n+{\n+    PeerRef peer = GetPeerRef(id);\n+    if (peer == nullptr) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618443929",
      "id" : 618443929,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ0MzkyOQ==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 1264,
      "original_position" : 15,
      "original_start_line" : 1258,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618443929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618445093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618445093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not match the logic in `ProcessMessage()` when receiving a block:\r\n\r\n```suggestion\r\n    if (fImporting || fReindex) return false;\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:18:33Z",
      "diff_hunk" : "@@ -1252,6 +1253,47 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\n+{\n+    PeerRef peer = GetPeerRef(id);\n+    if (peer == nullptr) return false;\n+    if (fImporting && !fReindex) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618445093",
      "id" : 618445093,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ0NTA5Mw==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 1260,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618445093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618452192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618452192"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remove `const` from the pass-by-value argument:\r\n\r\n```suggestion\r\n    virtual bool FetchBlock(NodeId nodeid, const CBlockIndex& pindex) = 0;\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:26:16Z",
      "diff_hunk" : "@@ -42,6 +42,9 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n                                              CTxMemPool& pool, bool ignore_incoming_txs);\n     virtual ~PeerManager() { }\n \n+    /** Attempt to manually fetch block from a given node. */\n+    virtual bool FetchBlock(const NodeId nodeid, const CBlockIndex& pindex) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618452192",
      "id" : 618452192,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ1MjE5Mg==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 46,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618452192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618464212"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618464212"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Prefer to capture `invs` by reference than making a copy:\r\n\r\n```suggestion\r\n    bool success = m_connman.ForNode(id, [this, &invs](CNode* pnode) {\r\n```\r\n\r\nAlso maybe rename pnode to node if you're touching this part again.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:39:42Z",
      "diff_hunk" : "@@ -1252,6 +1253,47 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\n+{\n+    PeerRef peer = GetPeerRef(id);\n+    if (peer == nullptr) return false;\n+    if (fImporting && !fReindex) return false;\n+\n+    // Ignore pre-segwit peers\n+    LOCK(cs_main);\n+    CNodeState* state = State(id);\n+    if (state == nullptr) return false;\n+    if (!state->fHaveWitness) return false;\n+\n+    // Ensure the peer has blocks at the height we need\n+    const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n+    if (index.nHeight > node_sync_height) return false;\n+\n+    // Construct message to request the block\n+    std::vector<CInv> invs{CInv(MSG_BLOCK | MSG_WITNESS_FLAG, index.GetBlockHash())};\n+\n+    // Mark block as in-flight unless it already is\n+    if (!MarkBlockAsInFlight(id, index.GetBlockHash(), &index)) return false;\n+\n+    // Send block request message to the peer\n+    bool success = m_connman.ForNode(id, [this, invs](CNode* pnode) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618464212",
      "id" : 618464212,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ2NDIxMg==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 1279,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618464212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618464833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618464833"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Import standard library modules first, then local modules.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:40:26Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+import time",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618464833",
      "id" : 618464833,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ2NDgzMw==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 13,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618464833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618465902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618465902"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        self.nodes[0].generate(4)\r\n```\r\n\r\nSame below.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:41:40Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+import time\n+\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generatetoaddress(4, self.nodes[0].get_deterministic_priv_key().address)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618465902",
      "id" : 618465902,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ2NTkwMg==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 25,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618465902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618468253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618468253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        self.sync_blocks()\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:44:21Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+import time\n+\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generatetoaddress(4, self.nodes[0].get_deterministic_priv_key().address)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generatetoaddress(3, self.nodes[1].get_deterministic_priv_key().address)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks(self.nodes[0:2])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618468253",
      "id" : 618468253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ2ODI1Mw==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618468253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618469828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618469828"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps poll with `wait_until` rather than a sleep (sleep will take needlessly long on a fast system and may time out on a slow system).",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:46:07Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+import time\n+\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generatetoaddress(4, self.nodes[0].get_deterministic_priv_key().address)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generatetoaddress(3, self.nodes[1].get_deterministic_priv_key().address)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks(self.nodes[0:2])\n+\n+        self.log.info(\"Node 0 should only have the header for node 1's block 3\")\n+        short_tip_synced = False\n+        for x in self.nodes[0].getchaintips():\n+            if x['hash'] == short_tip:\n+                assert_equal(x['status'], \"headers-only\")\n+                short_tip_synced = True\n+        assert short_tip_synced\n+        assert_raises_rpc_error(-1, \"Block not found on disk\", self.nodes[0].getblock, short_tip)\n+\n+        self.log.info(\"Fetch block from node 1\")\n+        peers = self.nodes[0].getpeerinfo()\n+        assert_equal(len(peers), 1)\n+        peer_0_peer_1_id = peers[0][\"id\"]\n+        self.nodes[0].getblockfrompeer(short_tip, peer_0_peer_1_id)\n+        time.sleep(1)\n+        self.nodes[0].getblock(short_tip)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618469828",
      "id" : 618469828,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ2OTgyOA==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 52,
      "original_position" : 52,
      "original_start_line" : 51,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618469828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618470758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618470758"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                 index.GetBlockHash().ToString(), id);\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:47:07Z",
      "diff_hunk" : "@@ -1252,6 +1253,47 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\n+{\n+    PeerRef peer = GetPeerRef(id);\n+    if (peer == nullptr) return false;\n+    if (fImporting && !fReindex) return false;\n+\n+    // Ignore pre-segwit peers\n+    LOCK(cs_main);\n+    CNodeState* state = State(id);\n+    if (state == nullptr) return false;\n+    if (!state->fHaveWitness) return false;\n+\n+    // Ensure the peer has blocks at the height we need\n+    const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n+    if (index.nHeight > node_sync_height) return false;\n+\n+    // Construct message to request the block\n+    std::vector<CInv> invs{CInv(MSG_BLOCK | MSG_WITNESS_FLAG, index.GetBlockHash())};\n+\n+    // Mark block as in-flight unless it already is\n+    if (!MarkBlockAsInFlight(id, index.GetBlockHash(), &index)) return false;\n+\n+    // Send block request message to the peer\n+    bool success = m_connman.ForNode(id, [this, invs](CNode* pnode) {\n+        const CNetMsgMaker msgMaker(pnode->GetCommonVersion());\n+        this->m_connman.PushMessage(pnode, msgMaker.Make(NetMsgType::GETDATA, invs));\n+        return true;\n+    });\n+\n+    if (success) {\n+        LogPrint(BCLog::NET, \"Requesting block %s from peer=%d\\n\",\n+                index.GetBlockHash().ToString(), id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618470758",
      "id" : 618470758,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ3MDc1OA==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 1287,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618470758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618470858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618470858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                 index.GetBlockHash().ToString(), id);\r\n```",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T14:47:14Z",
      "diff_hunk" : "@@ -1252,6 +1253,47 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\n+{\n+    PeerRef peer = GetPeerRef(id);\n+    if (peer == nullptr) return false;\n+    if (fImporting && !fReindex) return false;\n+\n+    // Ignore pre-segwit peers\n+    LOCK(cs_main);\n+    CNodeState* state = State(id);\n+    if (state == nullptr) return false;\n+    if (!state->fHaveWitness) return false;\n+\n+    // Ensure the peer has blocks at the height we need\n+    const int node_sync_height = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n+    if (index.nHeight > node_sync_height) return false;\n+\n+    // Construct message to request the block\n+    std::vector<CInv> invs{CInv(MSG_BLOCK | MSG_WITNESS_FLAG, index.GetBlockHash())};\n+\n+    // Mark block as in-flight unless it already is\n+    if (!MarkBlockAsInFlight(id, index.GetBlockHash(), &index)) return false;\n+\n+    // Send block request message to the peer\n+    bool success = m_connman.ForNode(id, [this, invs](CNode* pnode) {\n+        const CNetMsgMaker msgMaker(pnode->GetCommonVersion());\n+        this->m_connman.PushMessage(pnode, msgMaker.Make(NetMsgType::GETDATA, invs));\n+        return true;\n+    });\n+\n+    if (success) {\n+        LogPrint(BCLog::NET, \"Requesting block %s from peer=%d\\n\",\n+                index.GetBlockHash().ToString(), id);\n+    } else {\n+        // Remove block from in-flight\n+        MarkBlockAsReceived(index.GetBlockHash());\n+        LogPrint(BCLog::NET, \"Failed to request block %s from peer=%d\\n\",\n+                index.GetBlockHash().ToString(), id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618470858",
      "id" : 618470858,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODQ3MDg1OA==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 1292,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 642260079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618470858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618649847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618649847"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think I copied this one from another method. But fewer negations make sense.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T18:37:53Z",
      "diff_hunk" : "@@ -1252,6 +1253,47 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\n+{\n+    PeerRef peer = GetPeerRef(id);\n+    if (peer == nullptr) return false;\n+    if (fImporting && !fReindex) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618649847",
      "id" : 618649847,
      "in_reply_to_id" : 618445093,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODY0OTg0Nw==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 1260,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 642551234,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618649847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618652918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618652918"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is the only place where we check that this peer actually exists (i.e. wasn't disconnected). I'll add a comment.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T18:42:39Z",
      "diff_hunk" : "@@ -1252,6 +1253,47 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\n+{\n+    PeerRef peer = GetPeerRef(id);\n+    if (peer == nullptr) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618652918",
      "id" : 618652918,
      "in_reply_to_id" : 618443929,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODY1MjkxOA==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 1264,
      "original_position" : 15,
      "original_start_line" : 1258,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 642555182,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618652918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618670004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618670004"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, though it's rather involved afaik there's no one-liner to say \"True if x doesn't throw\"",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-04-22T19:09:31Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+import time\n+\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generatetoaddress(4, self.nodes[0].get_deterministic_priv_key().address)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generatetoaddress(3, self.nodes[1].get_deterministic_priv_key().address)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks(self.nodes[0:2])\n+\n+        self.log.info(\"Node 0 should only have the header for node 1's block 3\")\n+        short_tip_synced = False\n+        for x in self.nodes[0].getchaintips():\n+            if x['hash'] == short_tip:\n+                assert_equal(x['status'], \"headers-only\")\n+                short_tip_synced = True\n+        assert short_tip_synced\n+        assert_raises_rpc_error(-1, \"Block not found on disk\", self.nodes[0].getblock, short_tip)\n+\n+        self.log.info(\"Fetch block from node 1\")\n+        peers = self.nodes[0].getpeerinfo()\n+        assert_equal(len(peers), 1)\n+        peer_0_peer_1_id = peers[0][\"id\"]\n+        self.nodes[0].getblockfrompeer(short_tip, peer_0_peer_1_id)\n+        time.sleep(1)\n+        self.nodes[0].getblock(short_tip)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r618670004",
      "id" : 618670004,
      "in_reply_to_id" : 618469828,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODY3MDAwNA==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 52,
      "original_position" : 52,
      "original_start_line" : 51,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : null,
      "pull_request_review_id" : 642576966,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618670004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-30T16:39:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-830218408",
      "id" : 830218408,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMDIxODQwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-30T16:39:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/830218408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think it would be better to just do the right thing if you `getblock` a block you don't have... Don't make users figure out which peer has it...?\r\n\r\nI agree with @luke-jr \r\n\r\nOr this RPC can make sense if all peers would reject such request by _default_ but if someone is okay with it, can save something like `allowgetblockfrompeer=1` in bitcoin.conf",
      "created_at" : "2021-05-13T01:41:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840223499",
      "id" : 840223499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDIyMzQ5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T01:41:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840223499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It's not that simple. Do we fetch the block from all peers at once? That's a huge bandwidth waste if you have 100 connection. Do we ask them one by one in sequence? What's the timeout? Do we do in parallel? Hence my suggestion to leave that to a followup.\r\n\r\n> `allowgetblockfrompeer=1`\r\n\r\nPeers will have no idea someone used this RPC call so that's not a concern. Nodes request blocks from each other all the time. This PR does not introduce a new p2p message.",
      "created_at" : "2021-05-13T11:02:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840484248",
      "id" : 840484248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDQ4NDI0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T11:03:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840484248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631787712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631787712"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T12:54:44Z",
      "diff_hunk" : "@@ -0,0 +1,62 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.authproxy import JSONRPCException",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631787712",
      "id" : 631787712,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTc4NzcxMg==",
      "original_commit_id" : "73c49b6d836dec448c219468fc6b392b0be807d7",
      "original_line" : 7,
      "original_position" : 8,
      "original_start_line" : 7,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : null,
      "pull_request_review_id" : 658871950,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T13:10:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631787712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631796608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631796608"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps document that this node must already have the block header in order to fetch the block (or relax that requirement?)",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T13:09:11Z",
      "diff_hunk" : "@@ -792,6 +745,43 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631796608",
      "id" : 631796608,
      "line" : 751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTc5NjYwOA==",
      "original_commit_id" : "73c49b6d836dec448c219468fc6b392b0be807d7",
      "original_line" : 751,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 88,
      "pull_request_review_id" : 658871950,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T13:10:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631796608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631797759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631797759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Change looks good. Thanks!",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T13:10:47Z",
      "diff_hunk" : "@@ -0,0 +1,58 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+import time\n+\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generatetoaddress(4, self.nodes[0].get_deterministic_priv_key().address)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generatetoaddress(3, self.nodes[1].get_deterministic_priv_key().address)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks(self.nodes[0:2])\n+\n+        self.log.info(\"Node 0 should only have the header for node 1's block 3\")\n+        short_tip_synced = False\n+        for x in self.nodes[0].getchaintips():\n+            if x['hash'] == short_tip:\n+                assert_equal(x['status'], \"headers-only\")\n+                short_tip_synced = True\n+        assert short_tip_synced\n+        assert_raises_rpc_error(-1, \"Block not found on disk\", self.nodes[0].getblock, short_tip)\n+\n+        self.log.info(\"Fetch block from node 1\")\n+        peers = self.nodes[0].getpeerinfo()\n+        assert_equal(len(peers), 1)\n+        peer_0_peer_1_id = peers[0][\"id\"]\n+        self.nodes[0].getblockfrompeer(short_tip, peer_0_peer_1_id)\n+        time.sleep(1)\n+        self.nodes[0].getblock(short_tip)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631797759",
      "id" : 631797759,
      "in_reply_to_id" : 618469828,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTc5Nzc1OQ==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 52,
      "original_position" : 52,
      "original_start_line" : 51,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : null,
      "pull_request_review_id" : 658871950,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T13:10:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631797759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631799792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631799792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually, you check below that a `CNodeState` exists, which can only happen if the peer isn't disconnected, which makes this check redundant.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T13:14:02Z",
      "diff_hunk" : "@@ -1252,6 +1253,47 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\n+{\n+    PeerRef peer = GetPeerRef(id);\n+    if (peer == nullptr) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631799792",
      "id" : 631799792,
      "in_reply_to_id" : 618443929,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTc5OTc5Mg==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 1264,
      "original_position" : 15,
      "original_start_line" : 1258,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 658888346,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T13:14:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631799792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631817337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631817337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "By \"this node\" you mean the node itself? What happens when you fetch a block that you don't have the header for?",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T13:39:57Z",
      "diff_hunk" : "@@ -792,6 +745,43 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631817337",
      "id" : 631817337,
      "in_reply_to_id" : 631796608,
      "line" : 751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTgxNzMzNw==",
      "original_commit_id" : "73c49b6d836dec448c219468fc6b392b0be807d7",
      "original_line" : 751,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 88,
      "pull_request_review_id" : 658912388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T13:39:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631817337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631820873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631820873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I see `MarkBlockAsInFlight` can handle a `nullprtr` index. It might indeed be simpler to drop this requirement, as well as the `index.nHeight > node_sync_height` check.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T13:44:58Z",
      "diff_hunk" : "@@ -792,6 +745,43 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631820873",
      "id" : 631820873,
      "in_reply_to_id" : 631796608,
      "line" : 751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTgyMDg3Mw==",
      "original_commit_id" : "73c49b6d836dec448c219468fc6b392b0be807d7",
      "original_line" : 751,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 88,
      "pull_request_review_id" : 658917211,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T13:45:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631820873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631826325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631826325"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, I'll remove it then.",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T13:52:33Z",
      "diff_hunk" : "@@ -1252,6 +1253,47 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const CBlockIndex& index)\n+{\n+    PeerRef peer = GetPeerRef(id);\n+    if (peer == nullptr) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631826325",
      "id" : 631826325,
      "in_reply_to_id" : 618443929,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTgyNjMyNQ==",
      "original_commit_id" : "c8df3f32386e677ef7b84882d398a6f6c3ea348a",
      "original_line" : 1264,
      "original_position" : 15,
      "original_start_line" : 1258,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 658924794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T13:52:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631826325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased, dropped requirement for local node to have the header, dropped redundant `GetPeerRef`, dropped requirement for other node to be at the right height.",
      "created_at" : "2021-05-13T13:56:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840578711",
      "id" : 840578711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDU3ODcxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T13:56:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840578711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631845232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631845232"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry, yes I meant \"we\" as \"this node\" (the node that you're running this command on)",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T14:19:07Z",
      "diff_hunk" : "@@ -792,6 +745,43 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631845232",
      "id" : 631845232,
      "in_reply_to_id" : 631796608,
      "line" : 751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTg0NTIzMg==",
      "original_commit_id" : "73c49b6d836dec448c219468fc6b392b0be807d7",
      "original_line" : 751,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 88,
      "pull_request_review_id" : 658951770,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T14:19:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631845232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631850675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631850675"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider passing `uint256` by const reference (to avoid unnecessary copying, generally only basic types should be passed by value).",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T14:26:31Z",
      "diff_hunk" : "@@ -247,6 +247,7 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Implement PeerManager */\n     void CheckForStaleTipAndEvictPeers() override;\n+    bool FetchBlock(NodeId id, uint256 hash, const CBlockIndex* index) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631850675",
      "id" : 631850675,
      "line" : 250,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTg1MDY3NQ==",
      "original_commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "original_line" : 250,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 658959454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T14:28:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631850675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631852281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631852281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe document that `index` may be null here?",
      "commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "created_at" : "2021-05-13T14:28:35Z",
      "diff_hunk" : "@@ -247,6 +247,7 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Implement PeerManager */\n     void CheckForStaleTipAndEvictPeers() override;\n+    bool FetchBlock(NodeId id, uint256 hash, const CBlockIndex* index) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631852281",
      "id" : 631852281,
      "line" : 250,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTg1MjI4MQ==",
      "original_commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "original_line" : 250,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 658959454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T14:28:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631852281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631955833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631955833"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added function documentation.",
      "commit_id" : "4c504a241a2353ed951b4949273b785c8f7846ed",
      "created_at" : "2021-05-13T16:52:40Z",
      "diff_hunk" : "@@ -247,6 +247,7 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Implement PeerManager */\n     void CheckForStaleTipAndEvictPeers() override;\n+    bool FetchBlock(NodeId id, uint256 hash, const CBlockIndex* index) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r631955833",
      "id" : 631955833,
      "in_reply_to_id" : 631852281,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTk1NTgzMw==",
      "original_commit_id" : "803d2f568f7f24557543f61bf9d5a73952caedb5",
      "original_line" : 250,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 659102663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T16:52:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631955833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Is it really necessary to make this specify which peer? It doesn't sound too hard to make the existing block fetching logic support extra requested blocks, I think.",
      "created_at" : "2021-05-13T16:53:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840691118",
      "id" : 840691118,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDY5MTExOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T16:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840691118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipa the current block fetching logic is buried deep inside net_processing. A `MSG_BLOCK` is generated when processing received headers:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/4741aec1dd28829f45abcc529cddaa0ff04d07a0/src/net_processing.cpp#L2011-L2021\r\n\r\nOr when receiving a block:\r\nhttps://github.com/bitcoin/bitcoin/blob/4741aec1dd28829f45abcc529cddaa0ff04d07a0/src/net_processing.cpp#L1733-L1739\r\n\r\nThere doesn't seem to be a queue of blocks to fetch that's distributed over peers and checked in a background process.",
      "created_at" : "2021-05-13T17:00:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840695083",
      "id" : 840695083,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDY5NTA4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T17:00:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840695083",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors Sure, but that doesn't sound too hard to add. And doing it that way sounds a lot more useful.",
      "created_at" : "2021-05-13T17:01:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840695885",
      "id" : 840695885,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDY5NTg4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T17:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840695885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "In practice I'm already able to use this PR to fetch stale blocks by simply looping over my peers and \"spamming\" them all. I then disconnect if the block doesn't show up, connect to random new peers and then try again. But those are behaviors we probably shouldn't implement here.\r\n\r\nSo although the current incarnation is not ideal, it's already useful. A revamp of `ProcessHeadersMessage` with a separate block download manager sounds doesn't sound easy to me. It also needs different timeout rules than IBD, because most of the time a peer won't have the block.\r\n\r\nThe use case of re-fetching pruned blocks is more similar to IBD, since you can expect every non-pruned node  with sufficiently high `pindexLastCommonBlock` to have it.",
      "created_at" : "2021-05-13T17:13:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840702994",
      "id" : 840702994,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDcwMjk5NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T17:13:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840702994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, I imagine it'd use the \"background' fetching logic in SendMessages, not the direct fetch in response to an announcement one.\n\nWhy would it need different timeout, or why would most blocks not have it? We know which peers are pruned.",
      "created_at" : "2021-05-13T17:30:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840712874",
      "id" : 840712874,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDcxMjg3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T17:31:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840712874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipa we don't fetch a block if we already have (a valid) one for that height. So if you're trying retrieve the losing block from a race, most likely your peers also saw it later and didn't fetch it.",
      "created_at" : "2021-05-13T18:13:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840738472",
      "id" : 840738472,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDczODQ3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T18:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840738472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Oh, I see. I missed that fetching non-main-chain blocks was a goal here.\n\nWhy would you want that?",
      "created_at" : "2021-05-13T18:45:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840756999",
      "id" : 840756999,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDc1Njk5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T18:45:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840756999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "That's indeed the main reason I wrote this, though I can see how it's useful for redownloading pruned blocks too.\r\n\r\nI'm using this for ForkMonitor to fetch stale blocks and compare the transactions, to see if there was a double-spend: https://forkmonitor.info/stale/btc/679823 (we haven't found a proper one in the past few months)",
      "created_at" : "2021-05-13T18:48:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-840759391",
      "id" : 840759391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDc1OTM5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T18:49:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840759391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Error: RPC command \"getblockfrompeer\" not found in RPC_COMMANDS_SAFE_FOR_FUZZING or RPC_COMMANDS_NOT_SAFE_FOR_FUZZING. Please update test/fuzz/rpc.cpp.",
      "created_at" : "2021-06-03T07:11:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-853632954",
      "id" : 853632954,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MzYzMjk1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-03T07:11:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/853632954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and marked safe for fuzzing (but I haven't tried that).",
      "created_at" : "2021-06-03T17:02:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-854032885",
      "id" : 854032885,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NDAzMjg4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-03T17:02:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/854032885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 1df0fd9aceaeaf8b45cb0474ce44135418c7d5b7",
      "created_at" : "2021-06-04T12:35:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-854675957",
      "id" : 854675957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NDY3NTk1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-04T12:35:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/854675957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased due to silent merge conflict with #22141, which I randomly caught while looking at IRC notifications :-) But it's a welcome simplification.",
      "created_at" : "2021-06-10T15:40:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-858730120",
      "id" : 858730120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1ODczMDEyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-10T15:40:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/858730120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-12T04:42:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-859997425",
      "id" : 859997425,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1OTk5NzQyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-12T04:42:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/859997425",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after some `Ensure*` methods were renamed in #21391.\r\n\r\nIn addition since #22221, `BlockRequested` no longer takes a pointer. Which means we can't call it for blocks for which we don't have a header. Paging @MarcoFalke to check if that was indeed the intention.",
      "created_at" : "2021-06-13T16:32:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-860238151",
      "id" : 860238151,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MDIzODE1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-13T16:32:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/860238151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "See also #10794 ",
      "created_at" : "2021-07-29T08:04:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-888895395",
      "id" : 888895395,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5840-3ej",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-29T08:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/888895395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke specifically its `requestblock` RPC? There's been too much refactoring to simply cherry-pick it, but it could contain inspiration for improvement.",
      "created_at" : "2021-07-29T15:31:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-889244846",
      "id" : 889244846,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5841AMyu",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-29T15:31:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889244846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, just left the comment to remind myself that this has been worked on in the past already. No need to change anything here, but if someone wants to read some related threads, it might be helpful.",
      "created_at" : "2021-07-29T16:21:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-889285858",
      "id" : 889285858,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5841AWzi",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-29T16:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889285858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-08-04T15:43:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-892766302",
      "id" : 892766302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5841Nohe",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-04T15:43:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/892766302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-08-11T03:51:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-896478214",
      "id" : 896478214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5841bywG",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-11T03:51:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896478214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r686938856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686938856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\r\n```\r\n\r\n(we no longer use hungarian notation to show what type the variable is)",
      "commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "created_at" : "2021-08-11T15:25:28Z",
      "diff_hunk" : "@@ -795,6 +749,39 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::ANY, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const pblockindex = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r686938856",
      "id" : 686938856,
      "line" : 775,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjkzODg1Ng==",
      "original_commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "original_line" : 775,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 107,
      "pull_request_review_id" : 727630680,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T15:31:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686938856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r686972430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686972430"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why do we not return `NullUniValue` here? Returning `UniValue::VOBJ` causes `bitcoin-cli` to print empty JSON object; returning `NullUniValue` would print nothing (as many other RPCs do). Is it to make this more backward-compatible if we later make it return something, like the block?",
      "commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "created_at" : "2021-08-11T16:04:35Z",
      "diff_hunk" : "@@ -747,6 +749,39 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::ANY, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const pblockindex = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!peerman.FetchBlock(nodeid, hash, pblockindex)) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Failed to fetch block from peer\");\n+    }\n+    return UniValue::VOBJ;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r686972430",
      "id" : 686972430,
      "line" : 780,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk3MjQzMA==",
      "original_commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "original_line" : 780,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 112,
      "pull_request_review_id" : 727674987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T16:56:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686972430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r686993091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686993091"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        for x in self.nodes[0].getchaintips():\r\n            if x['hash'] == short_tip:\r\n                assert_equal(x['status'], \"headers-only\")\r\n                break\r\n        else:\r\n            raise AssertionError(\"short tip not synced\")\r\n```",
      "commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "created_at" : "2021-08-11T16:30:48Z",
      "diff_hunk" : "@@ -0,0 +1,62 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.authproxy import JSONRPCException\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def check_for_block(self, hash):\n+        try:\n+            self.nodes[0].getblock(hash)\n+            return True\n+        except JSONRPCException:\n+            return False\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generate(4)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generate(3)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Node 0 should only have the header for node 1's block 3\")\n+        short_tip_synced = False\n+        for x in self.nodes[0].getchaintips():\n+            if x['hash'] == short_tip:\n+                assert_equal(x['status'], \"headers-only\")\n+                short_tip_synced = True\n+        assert short_tip_synced",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r686993091",
      "id" : 686993091,
      "line" : 48,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk5MzA5MQ==",
      "original_commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "original_line" : 48,
      "original_position" : 48,
      "original_start_line" : 43,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : 48,
      "pull_request_review_id" : 727674987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : 43,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-11T16:56:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686993091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687009270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687009270"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Suggestions for additional tests:\r\n```\r\n        self.log.info(\"No error if block is not found in the index\")\r\n        assert_equal(self.nodes[0].getblockfrompeer(\"12\" * 32, peer_0_peer_1_id), None)\r\n        self.log.info(\"Non-existent peer generates error\")\r\n        assert_raises_rpc_error(-1, \"Failed to fetch block from peer\", self.nodes[0].getblockfrompeer, short_tip, peer_0_peer_1_id + 1)\r\n```",
      "commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "created_at" : "2021-08-11T16:53:02Z",
      "diff_hunk" : "@@ -0,0 +1,62 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.authproxy import JSONRPCException\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def check_for_block(self, hash):\n+        try:\n+            self.nodes[0].getblock(hash)\n+            return True\n+        except JSONRPCException:\n+            return False\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generate(4)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generate(3)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Node 0 should only have the header for node 1's block 3\")\n+        short_tip_synced = False\n+        for x in self.nodes[0].getchaintips():\n+            if x['hash'] == short_tip:\n+                assert_equal(x['status'], \"headers-only\")\n+                short_tip_synced = True\n+        assert short_tip_synced\n+        assert_raises_rpc_error(-1, \"Block not found on disk\", self.nodes[0].getblock, short_tip)\n+\n+        self.log.info(\"Fetch block from node 1\")\n+        peers = self.nodes[0].getpeerinfo()\n+        assert_equal(len(peers), 1)\n+        peer_0_peer_1_id = peers[0][\"id\"]\n+        self.nodes[0].getblockfrompeer(short_tip, peer_0_peer_1_id)\n+        self.wait_until(lambda: self.check_for_block(short_tip), timeout=1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687009270",
      "id" : 687009270,
      "line" : 56,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzAwOTI3MA==",
      "original_commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : 56,
      "pull_request_review_id" : 727674987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T16:56:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687009270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> What do you think about restricting this RPC to where the node already has the header, by returning in `getblockfrompeer()` if `LookupBlockIndex()` fails?\r\n\r\nI agree that this would make sense. My understanding is that if we'd request a block for which we don't  have the header and which has less work than our tip, then `getblockfrompeer` would currently signal success, we might also get the block delivered by the peer, but then `AcceptBlock()` would never store it because `fRequested` and `fHasMoreOrSameWork` would be false ([code](https://github.com/bitcoin/bitcoin/blob/e614cc8cd808902c843568f1790730622d619620/src/validation.cpp#L3421-L3431 ))\r\nBut if we cannot accept the block, I don't think it makes sense to request it in the first place (and we should instead report an RPC error).\r\n",
      "created_at" : "2021-08-11T22:27:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-897202731",
      "id" : 897202731,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5841ejor",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-11T22:27:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/897202731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687551109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687551109"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Much more pythonic :+1: ",
      "commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "created_at" : "2021-08-12T09:35:54Z",
      "diff_hunk" : "@@ -0,0 +1,62 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.authproxy import JSONRPCException\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def check_for_block(self, hash):\n+        try:\n+            self.nodes[0].getblock(hash)\n+            return True\n+        except JSONRPCException:\n+            return False\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generate(4)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generate(3)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Node 0 should only have the header for node 1's block 3\")\n+        short_tip_synced = False\n+        for x in self.nodes[0].getchaintips():\n+            if x['hash'] == short_tip:\n+                assert_equal(x['status'], \"headers-only\")\n+                short_tip_synced = True\n+        assert short_tip_synced",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687551109",
      "id" : 687551109,
      "in_reply_to_id" : 686993091,
      "line" : 48,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzU1MTEwOQ==",
      "original_commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "original_line" : 48,
      "original_position" : 48,
      "original_start_line" : 43,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : 48,
      "pull_request_review_id" : 728387355,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : 43,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-12T09:35:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687551109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687684521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687684521"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The first version of this PR included a `success` boolean, but that didn't make sense because we don't know if we actually get the block. So I guess I made the response an empty VOBJ. I'll switch to Null.",
      "commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "created_at" : "2021-08-12T12:55:17Z",
      "diff_hunk" : "@@ -747,6 +749,39 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::ANY, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const pblockindex = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!peerman.FetchBlock(nodeid, hash, pblockindex)) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Failed to fetch block from peer\");\n+    }\n+    return UniValue::VOBJ;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687684521",
      "id" : 687684521,
      "in_reply_to_id" : 686972430,
      "line" : 780,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzY4NDUyMQ==",
      "original_commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "original_line" : 780,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 112,
      "pull_request_review_id" : 728562035,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-12T12:55:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687684521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yesterdays PR Review Club covered this PR, thanks everyone! https://bitcoincore.reviews/20295\r\n\r\nRebased and addressed feedback.\r\n\r\n@jnewbery in the use case I have in mind the node already has the header. We could always add a `getheaderfrompeer` RPC method if anyone needs it, though that seems a bit tedious to use. Alternative we can later expand `getblockfrompeer` to be smart about fetching headers first. For now I'll add the check you suggested so the user gets a clear error when requesting a block for which we don't have a header.\r\n\r\nI'll ponder this a bit, but for now I just added a line to the TODO warning about potentially breaking `getblockfrompeer`.\r\n<img width=\"1104\" alt=\"Schermafbeelding 2021-08-12 om 13 49 18\" src=\"https://user-images.githubusercontent.com/10217/129199510-c8bdfb75-95c5-43de-a2a6-d63a9b39b067.png\">",
      "created_at" : "2021-08-12T12:56:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-897616547",
      "id" : 897616547,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5841gIqj",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-12T14:20:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/897616547",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687754011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687754011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Tastes the same to me, but changed...",
      "commit_id" : "529ab96a95fdd64a2bb789285d1bf691b4bf8157",
      "created_at" : "2021-08-12T14:14:42Z",
      "diff_hunk" : "@@ -0,0 +1,62 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.authproxy import JSONRPCException\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def check_for_block(self, hash):\n+        try:\n+            self.nodes[0].getblock(hash)\n+            return True\n+        except JSONRPCException:\n+            return False\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generate(4)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generate(3)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Node 0 should only have the header for node 1's block 3\")\n+        short_tip_synced = False\n+        for x in self.nodes[0].getchaintips():\n+            if x['hash'] == short_tip:\n+                assert_equal(x['status'], \"headers-only\")\n+                short_tip_synced = True\n+        assert short_tip_synced",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687754011",
      "id" : 687754011,
      "in_reply_to_id" : 686993091,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Nzc1NDAxMQ==",
      "original_commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "original_line" : 48,
      "original_position" : 48,
      "original_start_line" : 43,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : null,
      "pull_request_review_id" : 728657049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-12T14:14:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687754011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687756311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687756311"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, added the second one.",
      "commit_id" : "529ab96a95fdd64a2bb789285d1bf691b4bf8157",
      "created_at" : "2021-08-12T14:16:57Z",
      "diff_hunk" : "@@ -0,0 +1,62 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.authproxy import JSONRPCException\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def check_for_block(self, hash):\n+        try:\n+            self.nodes[0].getblock(hash)\n+            return True\n+        except JSONRPCException:\n+            return False\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generate(4)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generate(3)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Node 0 should only have the header for node 1's block 3\")\n+        short_tip_synced = False\n+        for x in self.nodes[0].getchaintips():\n+            if x['hash'] == short_tip:\n+                assert_equal(x['status'], \"headers-only\")\n+                short_tip_synced = True\n+        assert short_tip_synced\n+        assert_raises_rpc_error(-1, \"Block not found on disk\", self.nodes[0].getblock, short_tip)\n+\n+        self.log.info(\"Fetch block from node 1\")\n+        peers = self.nodes[0].getpeerinfo()\n+        assert_equal(len(peers), 1)\n+        peer_0_peer_1_id = peers[0][\"id\"]\n+        self.nodes[0].getblockfrompeer(short_tip, peer_0_peer_1_id)\n+        self.wait_until(lambda: self.check_for_block(short_tip), timeout=1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r687756311",
      "id" : 687756311,
      "in_reply_to_id" : 687009270,
      "line" : 56,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Nzc1NjMxMQ==",
      "original_commit_id" : "30e2ba6c4cef9248c53542faeb8ec768079fc5fb",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : 56,
      "pull_request_review_id" : 728659861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-12T14:16:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687756311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I reverted back to returning an empty object as per the [developer notes](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#rpc-interface-guidelines) \"Try to make the RPC response a JSON object\".\r\n\r\nAlso made `FetchBlock` take `CBlockIndex` as a reference rather than a pointer, since it's now mandatory.",
      "created_at" : "2021-08-16T13:51:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-899528289",
      "id" : 899528289,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5841nbZh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-16T13:51:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/899528289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK 29263ae14a81d4cc55de61f51db981edf54399d0",
      "created_at" : "2021-08-16T13:55:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-899531341",
      "id" : 899531341,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5841ncJN",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-16T13:55:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/899531341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-08-16T14:01:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-899535444",
      "id" : 899535444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5841ndJU",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-16T14:01:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/899535444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r690649211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/690649211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit:\r\n\r\n```suggestion\r\n        x = next(x for x in self.nodes[0].getchaintips() if x['hash'] == short_tip)\r\n        assert_equal(x['status'], \"headers-only\")\r\n```",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-08-17T19:10:27Z",
      "diff_hunk" : "@@ -0,0 +1,68 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblockfrompeer RPC.\"\"\"\n+\n+from test_framework.authproxy import JSONRPCException\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+\n+class GetBlockFromPeerTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+\n+    def check_for_block(self, hash):\n+        try:\n+            self.nodes[0].getblock(hash)\n+            return True\n+        except JSONRPCException:\n+            return False\n+\n+    def run_test(self):\n+        self.log.info(\"Mine 4 blocks on Node 0\")\n+        self.nodes[0].generate(4)\n+        assert_equal(self.nodes[0].getblockcount(), 204)\n+\n+        self.log.info(\"Mine competing 3 blocks on Node 1\")\n+        self.nodes[1].generate(3)\n+        assert_equal(self.nodes[1].getblockcount(), 203)\n+        short_tip = self.nodes[1].getbestblockhash()\n+\n+        self.log.info(\"Connect nodes to sync headers\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Node 0 should only have the header for node 1's block 3\")\n+        for x in self.nodes[0].getchaintips():\n+            if x['hash'] == short_tip:\n+                assert_equal(x['status'], \"headers-only\")\n+                break\n+        else:\n+            raise AssertionError(\"short tip not synced\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r690649211",
      "id" : 690649211,
      "line" : 48,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MDY0OTIxMQ==",
      "original_commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "original_line" : 48,
      "original_position" : 48,
      "original_start_line" : 43,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : 48,
      "pull_request_review_id" : 732130483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/690649211/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 43,
      "start_side" : "RIGHT",
      "updated_at" : "2021-12-08T10:19:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/690649211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709528521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709528521"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: not sure if there is need for a `// For NodeId` comment here. I think comments like these tend to be overlooked when adding something else that needs `net.h` and thus out-dating the comment.",
      "commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "created_at" : "2021-09-15T19:55:53Z",
      "diff_hunk" : "@@ -18,6 +18,8 @@\n #include <hash.h>\n #include <index/blockfilterindex.h>\n #include <index/coinstatsindex.h>\n+#include <net.h> // For NodeId",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709528521",
      "id" : 709528521,
      "line" : 21,
      "node_id" : "PRRC_kwDOABII584qSovJ",
      "original_commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "original_line" : 21,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 4,
      "pull_request_review_id" : 755562997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T19:55:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709528521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709530801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709530801"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "As a user I'd expect some documentation that the RPC call returns `{}` once the block-request has been successfully scheduled and that I have to manually check if my node now has the block.  ",
      "commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "created_at" : "2021-09-15T19:59:28Z",
      "diff_hunk" : "@@ -748,6 +750,44 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709530801",
      "id" : 709530801,
      "line" : 756,
      "node_id" : "PRRC_kwDOABII584qSpSx",
      "original_commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "original_line" : 756,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 87,
      "pull_request_review_id" : 755566003,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T20:22:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709530801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709533364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709533364"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "optional but maybe worthwile: could check if the block is already available and return true if it is. Could reduce bandwidth usage in cases where users spam/iterate their all their peers with a `getblockfrompeer`.",
      "commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "created_at" : "2021-09-15T20:03:47Z",
      "diff_hunk" : "@@ -748,6 +750,44 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::ANY, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!index) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Block header missing\");\n+    }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709533364",
      "id" : 709533364,
      "line" : 782,
      "node_id" : "PRRC_kwDOABII584qSp60",
      "original_commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "original_line" : 782,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 113,
      "pull_request_review_id" : 755566003,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T20:22:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709533364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709685368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709685368"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yea, please don't add comments like these.",
      "commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "created_at" : "2021-09-16T01:30:46Z",
      "diff_hunk" : "@@ -18,6 +18,8 @@\n #include <hash.h>\n #include <index/blockfilterindex.h>\n #include <index/coinstatsindex.h>\n+#include <net.h> // For NodeId",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709685368",
      "id" : 709685368,
      "in_reply_to_id" : 709528521,
      "line" : 21,
      "node_id" : "PRRC_kwDOABII584qTPB4",
      "original_commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "original_line" : 21,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 4,
      "pull_request_review_id" : 755750895,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T01:30:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709685368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709953863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709953863"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I added a sentence to the RPC doc.",
      "commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "created_at" : "2021-09-16T09:37:06Z",
      "diff_hunk" : "@@ -748,6 +750,44 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709953863",
      "id" : 709953863,
      "in_reply_to_id" : 709530801,
      "line" : 756,
      "node_id" : "PRRC_kwDOABII584qUQlH",
      "original_commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "original_line" : 756,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 87,
      "pull_request_review_id" : 756079368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T09:37:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709953863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709972875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709972875"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The result now includes a warning if we already had the block. This seems better than throwing an error, since an RPC client might attempt fetching for multiple peers in parallel.",
      "commit_id" : "8ca1ce0f2b330296fb2a272655cf8218cc75fced",
      "created_at" : "2021-09-16T10:02:27Z",
      "diff_hunk" : "@@ -748,6 +750,44 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::ANY, \"\", \"\"},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!index) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Block header missing\");\n+    }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r709972875",
      "id" : 709972875,
      "in_reply_to_id" : 709533364,
      "line" : 786,
      "node_id" : "PRRC_kwDOABII584qUVOL",
      "original_commit_id" : "29263ae14a81d4cc55de61f51db981edf54399d0",
      "original_line" : 786,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 117,
      "pull_request_review_id" : 756104742,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T10:02:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709972875",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the thorough testing @0xB10C.\r\n\r\nRegarding (3) and (6): if a peer doesn't give us the block, there's nothing we can do. Since the call is not asynchronous, we can't give the user much useful feedback either. Changing p2p behavior for peers to give us a block before it's evaluated, or one it considers invalid, is beyond the scope of this PR.\r\n\r\n> Requesting an unavailable block from a peer `A` multiple times in a row fails with the error message `Failed to fetch block from peer` starting with the second request. A `getdata` message is only send to the peer on the first attempt.\r\n\r\nInteresting. I'd rather not make the RPC aware of too much internal magic of netmanager. If the user calls an RPC again after an error message, I guess they're on their own :-)\r\n\r\n> The error message is not displayed when requesting from a peer `B` in between the requests to peer `A`.\r\n\r\nThe only reason I can think of for requesting a block from multiple peers, is that the user is happy as long as at least one succeeds. So this is probably not a huge deal, but still strange. I could add a recommendation to the help that it's safer to call this method in sequence with a few second delay?",
      "created_at" : "2021-09-16T10:14:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-920772012",
      "id" : 920772012,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII58424d2s",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T10:14:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/920772012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-28T22:13:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-929664051",
      "id" : 929664051,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5843aYwz",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-28T22:13:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929664051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after #22650 (trivial conflict with first commit).",
      "created_at" : "2021-09-29T08:22:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-929951709",
      "id" : 929951709,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5843be_d",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-29T08:22:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929951709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK 4096e6fb013aa3fbe3463d24b70310ad8517da5f",
      "created_at" : "2021-09-30T08:54:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-931074173",
      "id" : 931074173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5843fxB9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931074173/reactions"
      },
      "updated_at" : "2021-09-30T08:54:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931074173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-10-05T15:10:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-934498474",
      "id" : 934498474,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5843s1Cq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934498474/reactions"
      },
      "updated_at" : "2021-10-05T15:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934498474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased once more (dd8f7f250095e58bbf4cd4effb481b52143bd1ed touched `PeerManager::make` directly under the new `FetchBlock`, though I'm disappointed Git couldn't figure that out).",
      "created_at" : "2021-10-07T08:54:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-937590001",
      "id" : 937590001,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII58434nzx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937590001/reactions"
      },
      "updated_at" : "2021-10-07T08:54:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937590001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "trivial reACK 9181e2e217\r\n\r\nConfirmed with `git rangediff` that the only conflict was for touching lines.",
      "created_at" : "2021-10-07T09:34:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-937621235",
      "id" : 937621235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII58434vbz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 1,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937621235/reactions"
      },
      "updated_at" : "2021-10-07T09:34:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937621235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'd love to see this merged in. ð \r\n",
      "created_at" : "2021-10-19T14:42:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-946796031",
      "id" : 946796031,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII5844bvX_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/946796031/reactions"
      },
      "updated_at" : "2021-10-19T14:42:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/946796031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r741610324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741610324"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, if you have a chance to retouch, could this be moved down to just before it's first used by the `m_connman.ForNode()` call below?",
      "commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "created_at" : "2021-11-03T04:15:22Z",
      "diff_hunk" : "@@ -1426,6 +1427,41 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const uint256& hash, const CBlockIndex& index)\n+{\n+    if (fImporting || fReindex) return false;\n+\n+    LOCK(cs_main);\n+    // Ensure this peer exists and hasn't been disconnected\n+    CNodeState* state = State(id);\n+    if (state == nullptr) return false;\n+    // Ignore pre-segwit peers\n+    if (!state->fHaveWitness) return false;\n+\n+    // Construct message to request the block\n+    std::vector<CInv> invs{CInv(MSG_BLOCK | MSG_WITNESS_FLAG, hash)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r741610324",
      "id" : 741610324,
      "line" : 1442,
      "node_id" : "PRRC_kwDOABII584sNBNU",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 1442,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 24,
      "pull_request_review_id" : 796102007,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741610324/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-03T04:21:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741610324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, will review in the next few days.",
      "created_at" : "2021-11-17T20:26:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-971961777",
      "id" : 971961777,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII58457vWx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/971961777/reactions"
      },
      "updated_at" : "2021-11-17T20:26:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/971961777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r753897686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753897686"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is it intentional that this succeeds even with an invalid nodeid?\r\n\r\nPerhaps the tests should check for the expected behaviour.",
      "commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "created_at" : "2021-11-22T02:05:03Z",
      "diff_hunk" : "@@ -796,6 +750,52 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}\n+                }},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!index) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Block header missing\");\n+    }\n+\n+    UniValue result = UniValue::VOBJ;\n+\n+    if (index->nStatus & BLOCK_HAVE_DATA) {\n+        result.pushKV(\"warnings\", \"Block already downloaded\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r753897686",
      "id" : 753897686,
      "line" : 790,
      "node_id" : "PRRC_kwDOABII584s75DW",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 790,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 121,
      "pull_request_review_id" : 812022352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753897686/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-22T02:05:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753897686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r754202663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/754202663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's probably a good sanity check to add. I could call `GetNodeStateStats` on the peer as a way to find out if it's valid, though that's not strictly what that PeerMan function is for. @jnewbery?",
      "commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "created_at" : "2021-11-22T11:57:56Z",
      "diff_hunk" : "@@ -796,6 +750,52 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}\n+                }},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!index) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Block header missing\");\n+    }\n+\n+    UniValue result = UniValue::VOBJ;\n+\n+    if (index->nStatus & BLOCK_HAVE_DATA) {\n+        result.pushKV(\"warnings\", \"Block already downloaded\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r754202663",
      "id" : 754202663,
      "in_reply_to_id" : 753897686,
      "line" : 790,
      "node_id" : "PRRC_kwDOABII584s9Dgn",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 790,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 121,
      "pull_request_review_id" : 812434330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/754202663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-22T11:58:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/754202663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r757816731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757816731"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it would be good to add more information for pruned node users of how long the block will be around. If my understanding is correct, something like this: `Note: On a pruned node this block will be pruned again when the pruneheight surpasses the blockheight at the time of fetching the block.`",
      "commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "created_at" : "2021-11-27T20:19:31Z",
      "diff_hunk" : "@@ -748,6 +750,52 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r757816731",
      "id" : 757816731,
      "line" : 758,
      "node_id" : "PRRC_kwDOABII584tK12b",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 758,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 89,
      "pull_request_review_id" : 817157738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757816731/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-27T22:14:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757816731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r757818887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757818887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Even that is not guaranteed at the moment (albeit very likely to hold in practice).\r\n\r\nCombined with #19463, the caller could set a prune lock to ensure it doesn't get re-pruned before the caller is done with it.",
      "commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "created_at" : "2021-11-27T22:18:28Z",
      "diff_hunk" : "@@ -748,6 +750,52 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r757818887",
      "id" : 757818887,
      "in_reply_to_id" : 757816731,
      "line" : 758,
      "node_id" : "PRRC_kwDOABII584tK2YH",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 758,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 89,
      "pull_request_review_id" : 817159578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757818887/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-27T22:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757818887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760200854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760200854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You could use `CConnman::ForNode()` to determine whether the peer with that nodeid exists. Here's the diff (with the required changes to make the tests run on master):\r\n\r\n```diff\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex 9fc586c122..fdbfe55aaf 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -780,11 +780,17 @@ static RPCHelpMan getblockfrompeer()\r\n     const NodeContext& node = EnsureAnyNodeContext(request.context);\r\n     ChainstateManager& chainman = EnsureChainman(node);\r\n     PeerManager& peerman = EnsurePeerman(node);\r\n+    CConnman& connman = EnsureConnman(node);\r\n \r\n     uint256 hash(ParseHashV(request.params[0], \"hash\"));\r\n \r\n     const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\r\n \r\n+    // Check that the peer with nodeid exists\r\n+    if (!connman.ForNode(nodeid, [](CNode* node) {return true;})) {\r\n+        throw JSONRPCError(RPC_MISC_ERROR, strprintf(\"Peer nodeid %d does not exist\", nodeid));\r\n+    }\r\n+\r\n     const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\r\n \r\n     if (!index) {\r\ndiff --git a/test/functional/rpc_getblockfrompeer.py b/test/functional/rpc_getblockfrompeer.py\r\nindex ec562c94f9..e841cba70e 100755\r\n--- a/test/functional/rpc_getblockfrompeer.py\r\n+++ b/test/functional/rpc_getblockfrompeer.py\r\n@@ -27,11 +27,11 @@ class GetBlockFromPeerTest(BitcoinTestFramework):\r\n \r\n     def run_test(self):\r\n         self.log.info(\"Mine 4 blocks on Node 0\")\r\n-        self.nodes[0].generate(4)\r\n+        self.generate(self.nodes[0], 4, sync_fun=self.no_op)\r\n         assert_equal(self.nodes[0].getblockcount(), 204)\r\n \r\n         self.log.info(\"Mine competing 3 blocks on Node 1\")\r\n-        self.nodes[1].generate(3)\r\n+        self.generate(self.nodes[1], 3, sync_fun=self.no_op)\r\n         assert_equal(self.nodes[1].getblockcount(), 203)\r\n         short_tip = self.nodes[1].getbestblockhash()\r\n \r\n@@ -60,7 +60,7 @@ class GetBlockFromPeerTest(BitcoinTestFramework):\r\n         assert_raises_rpc_error(-1, \"Block header missing\", self.nodes[0].getblockfrompeer, \"00\" * 32, 0)\r\n \r\n         self.log.info(\"Non-existent peer generates error\")\r\n-        assert_raises_rpc_error(-1, \"Failed to fetch block from peer\", self.nodes[0].getblockfrompeer, short_tip, peer_0_peer_1_id + 1)\r\n+        assert_raises_rpc_error(-1, f\"Peer nodeid {peer_0_peer_1_id + 1} does not exist\", self.nodes[0].getblockfrompeer, short_tip, peer_0_peer_1_id + 1)\r\n \r\n         self.log.info(\"Successful fetch\")\r\n         result = self.nodes[0].getblockfrompeer(short_tip, peer_0_peer_1_id)\r\n```",
      "commit_id" : "434dbbce705ba4c4743d2a6760893bfe077cab5e",
      "created_at" : "2021-12-01T13:49:43Z",
      "diff_hunk" : "@@ -796,6 +750,52 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}\n+                }},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!index) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Block header missing\");\n+    }\n+\n+    UniValue result = UniValue::VOBJ;\n+\n+    if (index->nStatus & BLOCK_HAVE_DATA) {\n+        result.pushKV(\"warnings\", \"Block already downloaded\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760200854",
      "id" : 760200854,
      "in_reply_to_id" : 753897686,
      "line" : 796,
      "node_id" : "PRRC_kwDOABII584tT76W",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 796,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 127,
      "pull_request_review_id" : 820279950,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 1,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760200854/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T13:49:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760200854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760236497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760236497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I moved it down a bit.",
      "commit_id" : "434dbbce705ba4c4743d2a6760893bfe077cab5e",
      "created_at" : "2021-12-01T14:29:03Z",
      "diff_hunk" : "@@ -1426,6 +1427,41 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const uint256& hash, const CBlockIndex& index)\n+{\n+    if (fImporting || fReindex) return false;\n+\n+    LOCK(cs_main);\n+    // Ensure this peer exists and hasn't been disconnected\n+    CNodeState* state = State(id);\n+    if (state == nullptr) return false;\n+    // Ignore pre-segwit peers\n+    if (!state->fHaveWitness) return false;\n+\n+    // Construct message to request the block\n+    std::vector<CInv> invs{CInv(MSG_BLOCK | MSG_WITNESS_FLAG, hash)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760236497",
      "id" : 760236497,
      "in_reply_to_id" : 741610324,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tUEnR",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 1442,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 820330991,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760236497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T14:31:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760236497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760236809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760236809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done. I left out the `sync_fun=self.no_op` bit, as it results in: `AttributeError: 'GetBlockFromPeerTest' object has no attribute 'no_op'`",
      "commit_id" : "434dbbce705ba4c4743d2a6760893bfe077cab5e",
      "created_at" : "2021-12-01T14:29:22Z",
      "diff_hunk" : "@@ -796,6 +750,52 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}\n+                }},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!index) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Block header missing\");\n+    }\n+\n+    UniValue result = UniValue::VOBJ;\n+\n+    if (index->nStatus & BLOCK_HAVE_DATA) {\n+        result.pushKV(\"warnings\", \"Block already downloaded\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760236809",
      "id" : 760236809,
      "in_reply_to_id" : 753897686,
      "line" : 796,
      "node_id" : "PRRC_kwDOABII584tUEsJ",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 796,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 127,
      "pull_request_review_id" : 820331448,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760236809/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T14:36:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760236809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760249680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760249680"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This branch currently has a silent merge conflict with master. You'll need to rebase and take the `sync_fun=self.no_op` bit before merge.",
      "commit_id" : "434dbbce705ba4c4743d2a6760893bfe077cab5e",
      "created_at" : "2021-12-01T14:42:19Z",
      "diff_hunk" : "@@ -796,6 +750,52 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}\n+                }},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!index) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Block header missing\");\n+    }\n+\n+    UniValue result = UniValue::VOBJ;\n+\n+    if (index->nStatus & BLOCK_HAVE_DATA) {\n+        result.pushKV(\"warnings\", \"Block already downloaded\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760249680",
      "id" : 760249680,
      "in_reply_to_id" : 753897686,
      "line" : 796,
      "node_id" : "PRRC_kwDOABII584tUH1Q",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 796,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 127,
      "pull_request_review_id" : 820349016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760249680/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T14:42:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760249680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760789645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760789645"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-02T06:16:31Z",
      "diff_hunk" : "@@ -796,6 +750,52 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}\n+                }},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    const CBlockIndex* const index = WITH_LOCK(cs_main, return chainman.m_blockman.LookupBlockIndex(hash););\n+\n+    if (!index) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Block header missing\");\n+    }\n+\n+    UniValue result = UniValue::VOBJ;\n+\n+    if (index->nStatus & BLOCK_HAVE_DATA) {\n+        result.pushKV(\"warnings\", \"Block already downloaded\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r760789645",
      "id" : 760789645,
      "in_reply_to_id" : 753897686,
      "line" : 803,
      "node_id" : "PRRC_kwDOABII584tWLqN",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 803,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 127,
      "pull_request_review_id" : 821085588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760789645/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-02T06:16:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760789645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-07T12:38:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-987887624",
      "id" : 987887624,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII58464fgI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987887624/reactions"
      },
      "updated_at" : "2021-12-07T12:38:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987887624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : " re-ACK dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-07T21:05:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-988263228",
      "id" : 988263228,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII584657M8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988263228/reactions"
      },
      "updated_at" : "2021-12-07T21:05:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988263228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764710614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764710614"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What about returning the error string on failure `std::optional<std::string>`?\r\n\r\nThe caller could then\r\n\r\n```cpp\r\nif(const auto err{Fetch()}){\r\n throw err.value();\r\n}\r\n```\r\n\r\nThis will make users and tests more happy",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T09:55:04Z",
      "diff_hunk" : "@@ -1427,6 +1428,41 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const uint256& hash, const CBlockIndex& index)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764710614",
      "id" : 764710614,
      "line" : 1431,
      "node_id" : "PRRC_kwDOABII584tlI7W",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 1431,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 732130483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764710614/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:19:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764710614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764718435"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764718435"
         }
      },
      "author_association" : "MEMBER",
      "body" : "maybe add a comment that this will re-assign the block if it is in flight from another peer?",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T10:04:46Z",
      "diff_hunk" : "@@ -1427,6 +1428,41 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const uint256& hash, const CBlockIndex& index)\n+{\n+    if (fImporting || fReindex) return false;\n+\n+    LOCK(cs_main);\n+    // Ensure this peer exists and hasn't been disconnected\n+    CNodeState* state = State(id);\n+    if (state == nullptr) return false;\n+    // Ignore pre-segwit peers\n+    if (!state->fHaveWitness) return false;\n+\n+    // Mark block as in-flight unless it already is\n+    if (!BlockRequested(id, index)) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764718435",
      "id" : 764718435,
      "line" : 1443,
      "node_id" : "PRRC_kwDOABII584tlK1j",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 1443,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 24,
      "pull_request_review_id" : 732130483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764718435/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:19:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764718435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764720703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764720703"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems odd to log a failure to the debug log on an rpc call. I'd expect the error to go to the user instead. Also, shouldn't this say \"peer not found\"?",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T10:07:38Z",
      "diff_hunk" : "@@ -1427,6 +1428,41 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const uint256& hash, const CBlockIndex& index)\n+{\n+    if (fImporting || fReindex) return false;\n+\n+    LOCK(cs_main);\n+    // Ensure this peer exists and hasn't been disconnected\n+    CNodeState* state = State(id);\n+    if (state == nullptr) return false;\n+    // Ignore pre-segwit peers\n+    if (!state->fHaveWitness) return false;\n+\n+    // Mark block as in-flight unless it already is\n+    if (!BlockRequested(id, index)) return false;\n+\n+    // Construct message to request the block\n+    std::vector<CInv> invs{CInv(MSG_BLOCK | MSG_WITNESS_FLAG, hash)};\n+\n+    // Send block request message to the peer\n+    bool success = m_connman.ForNode(id, [this, &invs](CNode* node) {\n+        const CNetMsgMaker msgMaker(node->GetCommonVersion());\n+        this->m_connman.PushMessage(node, msgMaker.Make(NetMsgType::GETDATA, invs));\n+        return true;\n+    });\n+\n+    if (success) {\n+        LogPrint(BCLog::NET, \"Requesting block %s from peer=%d\\n\",\n+                 hash.ToString(), id);\n+    } else {\n+        RemoveBlockRequest(hash);\n+        LogPrint(BCLog::NET, \"Failed to request block %s from peer=%d\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764720703",
      "id" : 764720703,
      "line" : 1460,
      "node_id" : "PRRC_kwDOABII584tlLY_",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 1460,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 41,
      "pull_request_review_id" : 732130483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764720703/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:19:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764720703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764722720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764722720"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why are you passing the hash twice? the blockindex already holds its own hash, no?\r\n\r\nAlso, `pindex` is not a pointer, so should be called `block_index`.",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T10:10:09Z",
      "diff_hunk" : "@@ -42,6 +42,16 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n                                              CTxMemPool& pool, bool ignore_incoming_txs);\n     virtual ~PeerManager() { }\n \n+    /**\n+     * Attempt to manually fetch block from a given peer. We must already have the header.\n+     *\n+     * @param[in]  id       The peer id\n+     * @param[in]  hash     The block hash\n+     * @param[in]  pindex   The blockindex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764722720",
      "id" : 764722720,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII584tlL4g",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 50,
      "original_position" : 9,
      "original_start_line" : 49,
      "path" : "src/net_processing.h",
      "position" : 9,
      "pull_request_review_id" : 732130483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764722720/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 49,
      "start_side" : "RIGHT",
      "updated_at" : "2021-12-08T10:19:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764722720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764724737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764724737"
         }
      },
      "author_association" : "MEMBER",
      "body" : "missing optional",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T10:12:45Z",
      "diff_hunk" : "@@ -803,6 +757,58 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764724737",
      "id" : 764724737,
      "line" : 772,
      "node_id" : "PRRC_kwDOABII584tlMYB",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 772,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 96,
      "pull_request_review_id" : 732130483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764724737/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:19:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764724737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764725037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764725037"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: can be const",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T10:13:08Z",
      "diff_hunk" : "@@ -803,6 +757,58 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}\n+                }},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+    CConnman& connman = EnsureConnman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764725037",
      "id" : 764725037,
      "line" : 785,
      "node_id" : "PRRC_kwDOABII584tlMct",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 785,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 109,
      "pull_request_review_id" : 732130483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764725037/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:19:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764725037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764725643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764725643"
         }
      },
      "author_association" : "MEMBER",
      "body" : "any reason to use a narrowing cast and not the safe alternative?\r\n\r\n```cpp\r\n     const NodeId nodeid{request.params[1].get_int64()};\r\n",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T10:13:54Z",
      "diff_hunk" : "@@ -803,6 +757,58 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}\n+                }},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+    CConnman& connman = EnsureConnman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764725643",
      "id" : 764725643,
      "line" : 787,
      "node_id" : "PRRC_kwDOABII584tlMmL",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 787,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 111,
      "pull_request_review_id" : 732130483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764725643/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:19:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764725643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764726512"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764726512"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since the FetchBlock call has to deal with this anyway, might be better to remove this code and let FetchBlock deal with it.",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T10:14:54Z",
      "diff_hunk" : "@@ -803,6 +757,58 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}\n+                }},\n+                RPCExamples{\n+                    HelpExampleCli(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                + HelpExampleRpc(\"getblockfrompeer\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 0\")\n+                },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    const NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    PeerManager& peerman = EnsurePeerman(node);\n+    CConnman& connman = EnsureConnman(node);\n+\n+    uint256 hash(ParseHashV(request.params[0], \"hash\"));\n+\n+    const NodeId nodeid = static_cast<NodeId>(request.params[1].get_int64());\n+\n+    // Check that the peer with nodeid exists\n+    if (!connman.ForNode(nodeid, [](CNode* node) {return true;})) {\n+        throw JSONRPCError(RPC_MISC_ERROR, strprintf(\"Peer nodeid %d does not exist\", nodeid));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764726512",
      "id" : 764726512,
      "line" : 791,
      "node_id" : "PRRC_kwDOABII584tlMzw",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 791,
      "original_position" : 115,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 115,
      "pull_request_review_id" : 732130483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764726512/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:19:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764726512",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764737276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764737276"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should also mention that this will disconnect the peer if the peer pretends to not have the block ",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T10:28:38Z",
      "diff_hunk" : "@@ -803,6 +757,58 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764737276",
      "id" : 764737276,
      "line" : 763,
      "node_id" : "PRRC_kwDOABII584tlPb8",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 763,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 87,
      "pull_request_review_id" : 826261695,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764737276/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:28:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764737276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke thanks, working on a followup PR...",
      "created_at" : "2021-12-08T11:29:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-988731208",
      "id" : 988731208,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII58467tdI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988731208/reactions"
      },
      "updated_at" : "2021-12-08T11:29:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988731208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "could make sense to base on https://github.com/bitcoin/bitcoin/pull/23702 to avoid conflicts",
      "created_at" : "2021-12-08T11:34:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-988734255",
      "id" : 988734255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII58467uMv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988734255/reactions"
      },
      "updated_at" : "2021-12-08T11:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988734255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764788244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764788244"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for adding in #23702",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T11:38:48Z",
      "diff_hunk" : "@@ -803,6 +757,58 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nodeid\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The node ID (see getpeerinfo for node IDs)\"},\n+                },\n+                RPCResult{RPCResult::Type::OBJ, \"\", \"\",\n+                {\n+                    {RPCResult::Type::STR, \"warnings\", \"any warnings\"}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764788244",
      "id" : 764788244,
      "in_reply_to_id" : 764724737,
      "line" : 772,
      "node_id" : "PRRC_kwDOABII584tlb4U",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 772,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 96,
      "pull_request_review_id" : 826330635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764788244/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T11:38:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764788244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764788775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764788775"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That may have gotten mixed up over the course of rebases and changes, I'll take a second look.",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T11:39:40Z",
      "diff_hunk" : "@@ -42,6 +42,16 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n                                              CTxMemPool& pool, bool ignore_incoming_txs);\n     virtual ~PeerManager() { }\n \n+    /**\n+     * Attempt to manually fetch block from a given peer. We must already have the header.\n+     *\n+     * @param[in]  id       The peer id\n+     * @param[in]  hash     The block hash\n+     * @param[in]  pindex   The blockindex",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764788775",
      "id" : 764788775,
      "in_reply_to_id" : 764722720,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII584tlcAn",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 50,
      "original_position" : 9,
      "original_start_line" : 49,
      "path" : "src/net_processing.h",
      "position" : 9,
      "pull_request_review_id" : 826331400,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764788775/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 49,
      "start_side" : "RIGHT",
      "updated_at" : "2021-12-08T11:39:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764788775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764816915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764816915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That seems a bit too deep in the net_processing weeds?",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T12:21:47Z",
      "diff_hunk" : "@@ -803,6 +757,58 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764816915",
      "id" : 764816915,
      "in_reply_to_id" : 764737276,
      "line" : 763,
      "node_id" : "PRRC_kwDOABII584tli4T",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 763,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 87,
      "pull_request_review_id" : 826369394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764816915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T12:21:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764816915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764827647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764827647"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll also update the RPC doc, because it looks like `BLOCKTXN` are ignored entirely if they're no longer on the in flight list for a given peer.",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T12:37:32Z",
      "diff_hunk" : "@@ -1427,6 +1428,41 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const uint256& hash, const CBlockIndex& index)\n+{\n+    if (fImporting || fReindex) return false;\n+\n+    LOCK(cs_main);\n+    // Ensure this peer exists and hasn't been disconnected\n+    CNodeState* state = State(id);\n+    if (state == nullptr) return false;\n+    // Ignore pre-segwit peers\n+    if (!state->fHaveWitness) return false;\n+\n+    // Mark block as in-flight unless it already is\n+    if (!BlockRequested(id, index)) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764827647",
      "id" : 764827647,
      "in_reply_to_id" : 764718435,
      "line" : 1443,
      "node_id" : "PRRC_kwDOABII584tllf_",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 1443,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 24,
      "pull_request_review_id" : 826384187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764827647/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T12:37:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764827647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764853690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764853690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We already check that the peer exists above, so the failure would be \"not fully connected\"; changed...",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-08T13:14:37Z",
      "diff_hunk" : "@@ -1427,6 +1428,41 @@ bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n            (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n }\n \n+bool PeerManagerImpl::FetchBlock(NodeId id, const uint256& hash, const CBlockIndex& index)\n+{\n+    if (fImporting || fReindex) return false;\n+\n+    LOCK(cs_main);\n+    // Ensure this peer exists and hasn't been disconnected\n+    CNodeState* state = State(id);\n+    if (state == nullptr) return false;\n+    // Ignore pre-segwit peers\n+    if (!state->fHaveWitness) return false;\n+\n+    // Mark block as in-flight unless it already is\n+    if (!BlockRequested(id, index)) return false;\n+\n+    // Construct message to request the block\n+    std::vector<CInv> invs{CInv(MSG_BLOCK | MSG_WITNESS_FLAG, hash)};\n+\n+    // Send block request message to the peer\n+    bool success = m_connman.ForNode(id, [this, &invs](CNode* node) {\n+        const CNetMsgMaker msgMaker(node->GetCommonVersion());\n+        this->m_connman.PushMessage(node, msgMaker.Make(NetMsgType::GETDATA, invs));\n+        return true;\n+    });\n+\n+    if (success) {\n+        LogPrint(BCLog::NET, \"Requesting block %s from peer=%d\\n\",\n+                 hash.ToString(), id);\n+    } else {\n+        RemoveBlockRequest(hash);\n+        LogPrint(BCLog::NET, \"Failed to request block %s from peer=%d\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r764853690",
      "id" : 764853690,
      "in_reply_to_id" : 764720703,
      "line" : 1460,
      "node_id" : "PRRC_kwDOABII584tlr26",
      "original_commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "original_line" : 1460,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 41,
      "pull_request_review_id" : 826420567,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764853690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T13:14:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764853690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Followups in #23706",
      "created_at" : "2021-12-08T13:28:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#issuecomment-988814617",
      "id" : 988814617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20295",
      "node_id" : "IC_kwDOABII58468B0Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988814617/reactions"
      },
      "updated_at" : "2021-12-08T13:28:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988814617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r771817522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771817522"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "So far I wasn't able to figure out in which cases this could not be guaranteed. I opened a follow-up PR in #23813. Please let me know if you have suggestions on improving the text there. Sure #19463 can be helpful but my aim with this for now is to just make sure that users don't get wrong expectations, like that the block would be available forever for example.",
      "commit_id" : "dce8c4c38111556ca480aa0e63c46b71f66b508f",
      "created_at" : "2021-12-18T11:59:15Z",
      "diff_hunk" : "@@ -748,6 +750,52 @@ static RPCHelpMan getmempoolentry()\n     };\n }\n \n+static RPCHelpMan getblockfrompeer()\n+{\n+    return RPCHelpMan{\"getblockfrompeer\",\n+                \"\\nAttempt to fetch block from a given peer.\\n\"\n+                \"\\nWe must have the header for this block, e.g. using submitheader.\\n\"\n+                \"\\nReturns {} if a block-request was successfully scheduled\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20295#discussion_r771817522",
      "id" : 771817522,
      "in_reply_to_id" : 757816731,
      "line" : 765,
      "node_id" : "PRRC_kwDOABII584uAQAy",
      "original_commit_id" : "9181e2e217955fff5f726b0e011afb78fb90af8f",
      "original_line" : 765,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 89,
      "pull_request_review_id" : 835768808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20295",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771817522/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-18T11:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771817522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
