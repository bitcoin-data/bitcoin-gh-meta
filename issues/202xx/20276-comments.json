[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r515471968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515471968"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Pretty sure this is not the parent change. miniwallet should have two outputs at this point. One leftover coinbase and one change. Coin selection favors the largest output, so the coinbase one.\r\n\r\nI might be wrong, but I think it could make sense to check that the child tx really has parent_txid as ancestor via the mempool rpc",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-10-31T08:21:41Z",
      "diff_hunk" : "@@ -27,54 +27,52 @@ class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def test_transaction_expiry(self, timeout):\n         \"\"\"Tests that a transaction expires after the expiry timeout and its\n         children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        wallet = MiniWallet(node)\n+\n+        # Add enough mature utxos to the wallet so that all txs spend confirmed coins.\n+        wallet.generate(2)\n+        node.generate(100)\n \n         # Send a parent transaction that will expire.\n-        parent_address = node.getnewaddress()\n-        parent_txid = node.sendtoaddress(parent_address, 1.0)\n+        parent_txid = wallet.send_self_transfer(from_node=node)['txid']\n \n         # Set the mocktime to the arrival time of the parent transaction.\n         entry_time = node.getmempoolentry(parent_txid)['time']\n         node.setmocktime(entry_time)\n \n-        # Create child transaction spending the parent transaction\n-        vout = find_vout_for_address(node, parent_txid, parent_address)\n-        inputs = [{'txid': parent_txid, 'vout': vout}]\n-        outputs = {node.getnewaddress(): 0.99}\n-        child_raw = node.createrawtransaction(inputs, outputs)\n-        child_signed = node.signrawtransactionwithwallet(child_raw)['hex']\n-\n-        # Let half of the timeout elapse and broadcast the child transaction.\n-        half_expiry_time = entry_time + int(60 * 60 * timeout/2)\n+        # Let half of the timeout elapse.\n+        half_expiry_time = entry_time + 3600 * timeout // 2\n         node.setmocktime(half_expiry_time)\n-        child_txid = node.sendrawtransaction(child_signed)\n+\n+        # Broadcast the child transaction spending the parent transaction.\n+        parent_utxo = wallet.get_utxo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r515471968",
      "id" : 515471968,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3MTk2OA==",
      "original_commit_id" : "98796bba8f394c323a22afcfc6c474c5f0c81f7f",
      "original_line" : 52,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 521122396,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515471968",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r515483272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515483272"
         }
      },
      "author_association" : "NONE",
      "body" : "I added an assertion verifying this to make it clear https://github.com/bitcoin/bitcoin/pull/20276/commits/de4173bacd3a2ce6294515072cb725d5c1074cd8.\r\n\r\nOriginally I had:\r\n```python\r\nparent_utxo = next(filter(lambda utxo: utxo['txid'] == parent_txid, wallet._utxos))\r\n```\r\n\r\nbut then I realized `get_utxo()` would do this for me: ```\"\"\"Return the last utxo. Can be used to get the change output immediately after a send_self_transfer\"\"\"``` ",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-10-31T10:39:51Z",
      "diff_hunk" : "@@ -27,54 +27,52 @@ class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def test_transaction_expiry(self, timeout):\n         \"\"\"Tests that a transaction expires after the expiry timeout and its\n         children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        wallet = MiniWallet(node)\n+\n+        # Add enough mature utxos to the wallet so that all txs spend confirmed coins.\n+        wallet.generate(2)\n+        node.generate(100)\n \n         # Send a parent transaction that will expire.\n-        parent_address = node.getnewaddress()\n-        parent_txid = node.sendtoaddress(parent_address, 1.0)\n+        parent_txid = wallet.send_self_transfer(from_node=node)['txid']\n \n         # Set the mocktime to the arrival time of the parent transaction.\n         entry_time = node.getmempoolentry(parent_txid)['time']\n         node.setmocktime(entry_time)\n \n-        # Create child transaction spending the parent transaction\n-        vout = find_vout_for_address(node, parent_txid, parent_address)\n-        inputs = [{'txid': parent_txid, 'vout': vout}]\n-        outputs = {node.getnewaddress(): 0.99}\n-        child_raw = node.createrawtransaction(inputs, outputs)\n-        child_signed = node.signrawtransactionwithwallet(child_raw)['hex']\n-\n-        # Let half of the timeout elapse and broadcast the child transaction.\n-        half_expiry_time = entry_time + int(60 * 60 * timeout/2)\n+        # Let half of the timeout elapse.\n+        half_expiry_time = entry_time + 3600 * timeout // 2\n         node.setmocktime(half_expiry_time)\n-        child_txid = node.sendrawtransaction(child_signed)\n+\n+        # Broadcast the child transaction spending the parent transaction.\n+        parent_utxo = wallet.get_utxo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r515483272",
      "id" : 515483272,
      "in_reply_to_id" : 515471968,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ4MzI3Mg==",
      "original_commit_id" : "98796bba8f394c323a22afcfc6c474c5f0c81f7f",
      "original_line" : 52,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 521129683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515483272",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r515507542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515507542"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, sorry my bad in that case. Though, the mempool check would still make sense.",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-10-31T15:22:47Z",
      "diff_hunk" : "@@ -27,54 +27,52 @@ class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def test_transaction_expiry(self, timeout):\n         \"\"\"Tests that a transaction expires after the expiry timeout and its\n         children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        wallet = MiniWallet(node)\n+\n+        # Add enough mature utxos to the wallet so that all txs spend confirmed coins.\n+        wallet.generate(2)\n+        node.generate(100)\n \n         # Send a parent transaction that will expire.\n-        parent_address = node.getnewaddress()\n-        parent_txid = node.sendtoaddress(parent_address, 1.0)\n+        parent_txid = wallet.send_self_transfer(from_node=node)['txid']\n \n         # Set the mocktime to the arrival time of the parent transaction.\n         entry_time = node.getmempoolentry(parent_txid)['time']\n         node.setmocktime(entry_time)\n \n-        # Create child transaction spending the parent transaction\n-        vout = find_vout_for_address(node, parent_txid, parent_address)\n-        inputs = [{'txid': parent_txid, 'vout': vout}]\n-        outputs = {node.getnewaddress(): 0.99}\n-        child_raw = node.createrawtransaction(inputs, outputs)\n-        child_signed = node.signrawtransactionwithwallet(child_raw)['hex']\n-\n-        # Let half of the timeout elapse and broadcast the child transaction.\n-        half_expiry_time = entry_time + int(60 * 60 * timeout/2)\n+        # Let half of the timeout elapse.\n+        half_expiry_time = entry_time + 3600 * timeout // 2\n         node.setmocktime(half_expiry_time)\n-        child_txid = node.sendrawtransaction(child_signed)\n+\n+        # Broadcast the child transaction spending the parent transaction.\n+        parent_utxo = wallet.get_utxo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r515507542",
      "id" : 515507542,
      "in_reply_to_id" : 515471968,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwNzU0Mg==",
      "original_commit_id" : "98796bba8f394c323a22afcfc6c474c5f0c81f7f",
      "original_line" : 52,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 521147141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515507542",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@MarcoFalke not to beat this to death, but I added another test case in https://github.com/bitcoin/bitcoin/pull/20276/commits/71081df19a816b5c243a6bcccab9fb11888732fa. While convincing myself that I was using `miniWallet` properly, and not getting lucky with any passing tests, I wrote this and figured it was useful enough to include in the PR",
      "created_at" : "2020-10-31T17:36:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#issuecomment-719964483",
      "id" : 719964483,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20276",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxOTk2NDQ4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-31T17:36:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/719964483",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Rebased and should be ready to merge",
      "created_at" : "2020-11-28T16:17:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#issuecomment-735251035",
      "id" : 735251035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20276",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNTI1MTAzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-28T16:17:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/735251035",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r532085685"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532085685"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I found this function name and doc string not to be super clear. `sync_mempool()` could be confused with something like `self.sync_all()`. If you happen to re-touch this then maybe something along the lines of the suggestion below would make it clearer.\r\n\r\n```suggestion\r\n    def trigger_mempool_expiry(self):\r\n        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked when a new transaction is added to the mempool.\"\"\"\r\n```",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-11-28T17:35:11Z",
      "diff_hunk" : "@@ -26,57 +26,62 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def sync_mempool(self):\n+        \"\"\"Expiry of mempool txs are only checked when a new tx is added to the mempool.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r532085685",
      "id" : 532085685,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA4NTY4NQ==",
      "original_commit_id" : "124c8ab5df85b606e00cfa666de6105e0620de00",
      "original_line" : 32,
      "original_position" : 32,
      "original_start_line" : 31,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 540406220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532085685",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r532090976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532090976"
         }
      },
      "author_association" : "NONE",
      "body" : "Thanks for the suggestion, I made this change and squashed it into the commit",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-11-28T18:21:49Z",
      "diff_hunk" : "@@ -26,57 +26,62 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def sync_mempool(self):\n+        \"\"\"Expiry of mempool txs are only checked when a new tx is added to the mempool.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r532090976",
      "id" : 532090976,
      "in_reply_to_id" : 532085685,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5MDk3Ng==",
      "original_commit_id" : "124c8ab5df85b606e00cfa666de6105e0620de00",
      "original_line" : 32,
      "original_position" : 32,
      "original_start_line" : 31,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 540408879,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532090976",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re-ACK ec66561d87881f54d64c8d633e267efe1b18b4ad\r\n\r\nOnly changes are:\r\n- https://github.com/bitcoin/bitcoin/pull/20276#discussion_r532085685 addressed\r\n- formatting of long lines changed: removed line breaks (multiple lines -> one line)",
      "created_at" : "2020-11-28T22:10:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#issuecomment-735296850",
      "id" : 735296850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20276",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNTI5Njg1MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-28T22:10:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/735296850",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "So since we don't use the wallet in mempool_expiry.py after this PR, does this close https://github.com/bitcoin/bitcoin/issues/19448? Also, since https://github.com/bitcoin/bitcoin/pull/19450 is described as a temp workaround would we revert it after this is merged? cc @hebasto \r\n\r\nCan someone explain why (only?) this test is triggering a data race though? Everything seems pretty simple so I'm confused why only this test would expose it. And I wonder if it's not a hint at an underlying problem?",
      "created_at" : "2020-12-01T20:46:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#issuecomment-736809643",
      "id" : 736809643,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20276",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjgwOTY0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-01T20:46:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736809643",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> So since we don't use the wallet in mempool_expiry.py after this PR, does this close #19448? Also, since #19450 is described as a temp workaround would we revert it after this is merged? cc @hebasto\r\n\r\nAs noted in #19448 OP other similar issues are reported: #19211 and #19417. I think we could just wait until Berkley DB will [no longer used](https://github.com/bitcoin/bitcoin/issues/20160) in Bitcoin Core.\r\n\r\n> Can someone explain why (only?) this test is triggering a data race though? Everything seems pretty simple so I'm confused why only this test would expose it. And I wonder if it's not a hint at an underlying problem?\r\n\r\nI believe something is wrong with Berkeley DB code, but did not check it myself.",
      "created_at" : "2020-12-01T21:16:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#issuecomment-736825467",
      "id" : 736825467,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20276",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjgyNTQ2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-01T21:16:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736825467",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534026969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534026969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can you explain why this is needed? I'd prefer not to call the method when it won't do anything anyway",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-02T09:43:00Z",
      "diff_hunk" : "@@ -26,73 +26,78 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def trigger_mempool_expiry(self):\n+        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked\n+        when a new transaction is added to the mempool.\"\"\"\n+        try:\n+            self.wallet.send_self_transfer(from_node=self.nodes[0])\n+        except JSONRPCException:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534026969",
      "id" : 534026969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNjk2OQ==",
      "original_commit_id" : "ec66561d87881f54d64c8d633e267efe1b18b4ad",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 542656545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534026969",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534028904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534028904"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it looks like you are fixing up style in the same commit as refactors, cleanups and miniwallet changes\r\n\r\nIt would be easier to follow if the formatting changes, the `trigger_mempool_expiry`, and the miniwallet changes were all in separate commits, where each passed on its own and can be reviewed on its own",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-02T09:45:43Z",
      "diff_hunk" : "@@ -26,73 +26,78 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def trigger_mempool_expiry(self):\n+        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked\n+        when a new transaction is added to the mempool.\"\"\"\n+        try:\n+            self.wallet.send_self_transfer(from_node=self.nodes[0])\n+        except JSONRPCException:\n+            pass\n \n     def test_transaction_expiry(self, timeout):\n-        \"\"\"Tests that a transaction expires after the expiry timeout and its\n-        children are removed as well.\"\"\"\n+        \"\"\"Tests that a transaction expires after the expiry timeout and its children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        self.wallet = MiniWallet(node)\n+\n+        # Add enough mature utxos to the wallet so that all txs spend confirmed coins.\n+        self.wallet.generate(2)\n+        node.generate(100)\n \n         # Send a parent transaction that will expire.\n-        parent_address = node.getnewaddress()\n-        parent_txid = node.sendtoaddress(parent_address, 1.0)\n+        parent_txid = self.wallet.send_self_transfer(from_node=node)['txid']\n+        parent_utxo = self.wallet.get_utxo(txid=parent_txid)\n+        independent_utxo = self.wallet.get_utxo()\n \n         # Set the mocktime to the arrival time of the parent transaction.\n         entry_time = node.getmempoolentry(parent_txid)['time']\n         node.setmocktime(entry_time)\n \n-        # Create child transaction spending the parent transaction\n-        vout = find_vout_for_address(node, parent_txid, parent_address)\n-        inputs = [{'txid': parent_txid, 'vout': vout}]\n-        outputs = {node.getnewaddress(): 0.99}\n-        child_raw = node.createrawtransaction(inputs, outputs)\n-        child_signed = node.signrawtransactionwithwallet(child_raw)['hex']\n-\n-        # Let half of the timeout elapse and broadcast the child transaction.\n-        half_expiry_time = entry_time + int(60 * 60 * timeout/2)\n+        # Let half of the timeout elapse.\n+        half_expiry_time = entry_time + 3600 * timeout // 2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534028904",
      "id" : 534028904,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyODkwNA==",
      "original_commit_id" : "ec66561d87881f54d64c8d633e267efe1b18b4ad",
      "original_line" : 58,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 542656545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534028904",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534029583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534029583"
         }
      },
      "author_association" : "MEMBER",
      "body" : "not sure about mixing all the formatting changes in with the other changes. In either case if you want to change this, you can use f-strings",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-02T09:46:45Z",
      "diff_hunk" : "@@ -26,73 +26,78 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def trigger_mempool_expiry(self):\n+        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked\n+        when a new transaction is added to the mempool.\"\"\"\n+        try:\n+            self.wallet.send_self_transfer(from_node=self.nodes[0])\n+        except JSONRPCException:\n+            pass\n \n     def test_transaction_expiry(self, timeout):\n-        \"\"\"Tests that a transaction expires after the expiry timeout and its\n-        children are removed as well.\"\"\"\n+        \"\"\"Tests that a transaction expires after the expiry timeout and its children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        self.wallet = MiniWallet(node)\n+\n+        # Add enough mature utxos to the wallet so that all txs spend confirmed coins.\n+        self.wallet.generate(2)\n+        node.generate(100)\n \n         # Send a parent transaction that will expire.\n-        parent_address = node.getnewaddress()\n-        parent_txid = node.sendtoaddress(parent_address, 1.0)\n+        parent_txid = self.wallet.send_self_transfer(from_node=node)['txid']\n+        parent_utxo = self.wallet.get_utxo(txid=parent_txid)\n+        independent_utxo = self.wallet.get_utxo()\n \n         # Set the mocktime to the arrival time of the parent transaction.\n         entry_time = node.getmempoolentry(parent_txid)['time']\n         node.setmocktime(entry_time)\n \n-        # Create child transaction spending the parent transaction\n-        vout = find_vout_for_address(node, parent_txid, parent_address)\n-        inputs = [{'txid': parent_txid, 'vout': vout}]\n-        outputs = {node.getnewaddress(): 0.99}\n-        child_raw = node.createrawtransaction(inputs, outputs)\n-        child_signed = node.signrawtransactionwithwallet(child_raw)['hex']\n-\n-        # Let half of the timeout elapse and broadcast the child transaction.\n-        half_expiry_time = entry_time + int(60 * 60 * timeout/2)\n+        # Let half of the timeout elapse.\n+        half_expiry_time = entry_time + 3600 * timeout // 2\n         node.setmocktime(half_expiry_time)\n-        child_txid = node.sendrawtransaction(child_signed)\n+\n+        # Broadcast the child transaction spending the parent transaction.\n+        child_txid = self.wallet.send_self_transfer(from_node=node, utxo_to_spend=parent_utxo)['txid']\n+        assert_equal(parent_txid, node.getmempoolentry(child_txid)['depends'][0])\n         self.log.info('Broadcast child transaction after {} hours.'.format(\n-            timedelta(seconds=(half_expiry_time-entry_time))))\n+            timedelta(seconds=(half_expiry_time - entry_time))))\n+\n+        # Broadcast another (independent) transaction.\n+        independent_txid = self.wallet.send_self_transfer(from_node=node, utxo_to_spend=independent_utxo)['txid']\n \n-        # Let most of the timeout elapse and check that the parent tx is still\n-        # in the mempool.\n-        nearly_expiry_time = entry_time + 60 * 60 * timeout - 5\n+        # Let most of the timeout elapse and check that the parent tx is still in the mempool.\n+        nearly_expiry_time = entry_time + 3600 * timeout - 5\n         node.setmocktime(nearly_expiry_time)\n-        # Expiry of mempool transactions is only checked when a new transaction\n-        # is added to the to the mempool.\n-        node.sendtoaddress(node.getnewaddress(), 1.0)\n+        self.trigger_mempool_expiry()\n         self.log.info('Test parent tx not expired after {} hours.'.format(\n-            timedelta(seconds=(nearly_expiry_time-entry_time))))\n+            timedelta(seconds=(nearly_expiry_time - entry_time))))\n         assert_equal(entry_time, node.getmempoolentry(parent_txid)['time'])\n \n-        # Transaction should be evicted from the mempool after the expiry time\n-        # has passed.\n-        expiry_time = entry_time + 60 * 60 * timeout + 5\n+        # Transaction should be evicted from the mempool after the expiry time has passed.\n+        expiry_time = entry_time + 3600 * timeout + 5\n         node.setmocktime(expiry_time)\n-        # Expiry of mempool transactions is only checked when a new transaction\n-        # is added to the to the mempool.\n-        node.sendtoaddress(node.getnewaddress(), 1.0)\n+        self.trigger_mempool_expiry()\n         self.log.info('Test parent tx expiry after {} hours.'.format(\n-            timedelta(seconds=(expiry_time-entry_time))))\n-        assert_raises_rpc_error(-5, 'Transaction not in mempool',\n-                                node.getmempoolentry, parent_txid)\n+            timedelta(seconds=(expiry_time - entry_time))))\n+        assert_raises_rpc_error(-5, 'Transaction not in mempool', node.getmempoolentry, parent_txid)\n \n         # The child transaction should be removed from the mempool as well.\n         self.log.info('Test child tx is evicted as well.')\n-        assert_raises_rpc_error(-5, 'Transaction not in mempool',\n-                                node.getmempoolentry, child_txid)\n+        assert_raises_rpc_error(-5, 'Transaction not in mempool', node.getmempoolentry, child_txid)\n+\n+        # Check that the other tx is still in the mempool.\n+        self.log.info('Test other tx not expired after {} hours.'.format(\n+            timedelta(seconds=(expiry_time - half_expiry_time))))\n+        assert_equal(half_expiry_time, node.getmempoolentry(independent_txid)['time'])\n \n     def run_test(self):\n-        self.log.info('Test default mempool expiry timeout of %d hours.' %\n-                      DEFAULT_MEMPOOL_EXPIRY)\n+        self.log.info('Test default mempool expiry timeout of {} hours.'.format(DEFAULT_MEMPOOL_EXPIRY))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534029583",
      "id" : 534029583,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyOTU4Mw==",
      "original_commit_id" : "ec66561d87881f54d64c8d633e267efe1b18b4ad",
      "original_line" : 96,
      "original_position" : 131,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 542656545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534029583",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534056506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534056506"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "[`CTxMemPool::Expire(..)`](https://github.com/bitcoin/bitcoin/blob/cd720337fe9c27422fe8d507726ca8c79f52b4ba/src/txmempool.cpp#L945) is only called in [ `LimitMempoolSize(..)`](https://github.com/bitcoin/bitcoin/blob/f17e8ba3a17b6516a1b1fb7f45d506a339e99f90/src/validation.cpp#L331) which is only called in [`UpdateMempoolForReorg(..)`](https://github.com/bitcoin/bitcoin/blob/f17e8ba3a17b6516a1b1fb7f45d506a339e99f90/src/validation.cpp#L370) and [`MemPoolAccept::Finalize(..)`](https://github.com/bitcoin/bitcoin/blob/f17e8ba3a17b6516a1b1fb7f45d506a339e99f90/src/validation.cpp#L983). \r\n\r\nTo trigger the expiry of a transaction in the mempool we send an unrelated transaction. For the unrelated transaction `MemPoolAccept::Finalize(..)` is called which calls `LimitMempoolSize(..)` which calls `CTxMemPool::Expire(..)` on all timed-out transactions. If we don't send a new transaction, we can't test if a transaction is really removed.",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-02T10:25:25Z",
      "diff_hunk" : "@@ -26,73 +26,78 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def trigger_mempool_expiry(self):\n+        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked\n+        when a new transaction is added to the mempool.\"\"\"\n+        try:\n+            self.wallet.send_self_transfer(from_node=self.nodes[0])\n+        except JSONRPCException:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534056506",
      "id" : 534056506,
      "in_reply_to_id" : 534026969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA1NjUwNg==",
      "original_commit_id" : "ec66561d87881f54d64c8d633e267efe1b18b4ad",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 542693675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534056506",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534077473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534077473"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I meant the `except: pass` part, sorry for being unclear :sweat_smile: ",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-02T10:58:10Z",
      "diff_hunk" : "@@ -26,73 +26,78 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def trigger_mempool_expiry(self):\n+        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked\n+        when a new transaction is added to the mempool.\"\"\"\n+        try:\n+            self.wallet.send_self_transfer(from_node=self.nodes[0])\n+        except JSONRPCException:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534077473",
      "id" : 534077473,
      "in_reply_to_id" : 534026969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3NzQ3Mw==",
      "original_commit_id" : "ec66561d87881f54d64c8d633e267efe1b18b4ad",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 542720645,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534077473",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534391823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534391823"
         }
      },
      "author_association" : "NONE",
      "body" : "There's a minor problem here, re the **unrelated transaction** part of @0xB10C's explanation. With `MiniWallet` if we don't do any extra bookkeeping in this test, and just do `self.wallet.send_self_transfer(from_node=node)` to trigger the mempool update, the (now expired) utxo will be spent. So this `send_self_transfer` will throw `test_framework.authproxy.JSONRPCException: mempool full (-26)`\r\n\r\nWe'd need to ensure that we don't spend one of the expired UTXOs when we want to `trigger_mempool_expiry` if we don't catch the Exception. ie:\r\n```C++\r\nnode.setmocktime(expiry_time)\r\n# Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked when a new transaction is added to the mempool.\r\nnew_utxo = self.wallet.get_utxo(txid=independent_txid)\r\nnew_txid = self.wallet.send_self_transfer(from_node=self.nodes[0], utxo_to_spend=new_utxo)['txid']\r\n# parent_txid has now been evicted from the mempool.\r\n```\r\n\r\nBecause the mempool is still updated if `send_self_transfer` fails, I thought it was cleaner to catch the Exception rather than have extra logic (that's unrelated to what we're testing) to ensure we're not spending expired UTXOs in this trigger.\r\n\r\nMaybe I need to add a comment along these lines in the `except: pass` to make this clear? I'm realizing this is more confusing than I thought",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-02T18:32:27Z",
      "diff_hunk" : "@@ -26,73 +26,78 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def trigger_mempool_expiry(self):\n+        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked\n+        when a new transaction is added to the mempool.\"\"\"\n+        try:\n+            self.wallet.send_self_transfer(from_node=self.nodes[0])\n+        except JSONRPCException:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534391823",
      "id" : 534391823,
      "in_reply_to_id" : 534026969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM5MTgyMw==",
      "original_commit_id" : "ec66561d87881f54d64c8d633e267efe1b18b4ad",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 543125778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534391823",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534395089"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534395089"
         }
      },
      "author_association" : "NONE",
      "body" : "Ah yeah, I did too much extra stuff in this PR. I'm gonna undo all this unrelated style/refactor stuff. Will undo the string formatting changes as well",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-02T18:37:46Z",
      "diff_hunk" : "@@ -26,73 +26,78 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def trigger_mempool_expiry(self):\n+        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked\n+        when a new transaction is added to the mempool.\"\"\"\n+        try:\n+            self.wallet.send_self_transfer(from_node=self.nodes[0])\n+        except JSONRPCException:\n+            pass\n \n     def test_transaction_expiry(self, timeout):\n-        \"\"\"Tests that a transaction expires after the expiry timeout and its\n-        children are removed as well.\"\"\"\n+        \"\"\"Tests that a transaction expires after the expiry timeout and its children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        self.wallet = MiniWallet(node)\n+\n+        # Add enough mature utxos to the wallet so that all txs spend confirmed coins.\n+        self.wallet.generate(2)\n+        node.generate(100)\n \n         # Send a parent transaction that will expire.\n-        parent_address = node.getnewaddress()\n-        parent_txid = node.sendtoaddress(parent_address, 1.0)\n+        parent_txid = self.wallet.send_self_transfer(from_node=node)['txid']\n+        parent_utxo = self.wallet.get_utxo(txid=parent_txid)\n+        independent_utxo = self.wallet.get_utxo()\n \n         # Set the mocktime to the arrival time of the parent transaction.\n         entry_time = node.getmempoolentry(parent_txid)['time']\n         node.setmocktime(entry_time)\n \n-        # Create child transaction spending the parent transaction\n-        vout = find_vout_for_address(node, parent_txid, parent_address)\n-        inputs = [{'txid': parent_txid, 'vout': vout}]\n-        outputs = {node.getnewaddress(): 0.99}\n-        child_raw = node.createrawtransaction(inputs, outputs)\n-        child_signed = node.signrawtransactionwithwallet(child_raw)['hex']\n-\n-        # Let half of the timeout elapse and broadcast the child transaction.\n-        half_expiry_time = entry_time + int(60 * 60 * timeout/2)\n+        # Let half of the timeout elapse.\n+        half_expiry_time = entry_time + 3600 * timeout // 2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534395089",
      "id" : 534395089,
      "in_reply_to_id" : 534028904,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM5NTA4OQ==",
      "original_commit_id" : "ec66561d87881f54d64c8d633e267efe1b18b4ad",
      "original_line" : 58,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 543129882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534395089",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534850841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534850841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand why spending an non-existent coin will throw 'mempool full' (not missing-inputs) and how that is going to trigger mempool expiry of other txs.\r\n\r\nAnyway, I guess the options are:\r\n\r\n* Add a comment\r\n* Remember the previous utxo (not expired) and use that\r\n* Drop utxos that are about to expire from the wallet (might require fresh coins later on in the script)\r\n* Something else?",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-03T07:54:52Z",
      "diff_hunk" : "@@ -26,73 +26,78 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def trigger_mempool_expiry(self):\n+        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked\n+        when a new transaction is added to the mempool.\"\"\"\n+        try:\n+            self.wallet.send_self_transfer(from_node=self.nodes[0])\n+        except JSONRPCException:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r534850841",
      "id" : 534850841,
      "in_reply_to_id" : 534026969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg1MDg0MQ==",
      "original_commit_id" : "ec66561d87881f54d64c8d633e267efe1b18b4ad",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 543684775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534850841",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Alright, I cleaned this up and got rid of all the fluff that wasn't related to the core of this PR. Should be ready to go now, will make sure I keep PRs focused in the future",
      "created_at" : "2020-12-08T19:59:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#issuecomment-740942858",
      "id" : 740942858,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20276",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MDk0Mjg1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-08T19:59:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/740942858",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r538766997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538766997"
         }
      },
      "author_association" : "NONE",
      "body" : "So I figured out why there were some weird errors that didn't make sense as you point out. After the first subtest some UTXOs were hanging around in the mempool, that ended up being used in the second subtest because MiniWallet sorts for the largest UTXOs. That's why I ensure the mempool is clear at the beginning of each subtest run now.",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-08T20:01:29Z",
      "diff_hunk" : "@@ -26,73 +26,78 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n+        self.setup_clean_chain = True\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+    def trigger_mempool_expiry(self):\n+        \"\"\"Broadcasts an unrelated transaction as the expiry of the transactions in the mempool is only checked\n+        when a new transaction is added to the mempool.\"\"\"\n+        try:\n+            self.wallet.send_self_transfer(from_node=self.nodes[0])\n+        except JSONRPCException:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r538766997",
      "id" : 538766997,
      "in_reply_to_id" : 534026969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc2Njk5Nw==",
      "original_commit_id" : "ec66561d87881f54d64c8d633e267efe1b18b4ad",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 547584603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538766997",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r539138125"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539138125"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is this needed? You are generating a block in the next line, which cleares the mempool",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-09T09:19:05Z",
      "diff_hunk" : "@@ -26,44 +26,48 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n-\n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+        self.setup_clean_chain = True\n \n     def test_transaction_expiry(self, timeout):\n         \"\"\"Tests that a transaction expires after the expiry timeout and its\n         children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        self.wallet = MiniWallet(node)\n+\n+        # Ensure the mempool starts empty.\n+        node.generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r539138125",
      "id" : 539138125,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzODEyNQ==",
      "original_commit_id" : "7a05d47cdf0cf3b2787c4583c4b920f98351b0b3",
      "original_line" : 38,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 547981842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539138125",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r539139300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539139300"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this comment is not true. The \"trigger\" txs are chained txs. More inputs are needed.",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-09T09:20:44Z",
      "diff_hunk" : "@@ -26,44 +26,48 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n-\n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+        self.setup_clean_chain = True\n \n     def test_transaction_expiry(self, timeout):\n         \"\"\"Tests that a transaction expires after the expiry timeout and its\n         children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        self.wallet = MiniWallet(node)\n+\n+        # Ensure the mempool starts empty.\n+        node.generate(1)\n+        assert_equal(set(node.getrawmempool()), set())\n+        # Add enough mature utxos to the wallet so that all txs spend confirmed coins.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r539139300",
      "id" : 539139300,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzOTMwMA==",
      "original_commit_id" : "7a05d47cdf0cf3b2787c4583c4b920f98351b0b3",
      "original_line" : 40,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : 25,
      "pull_request_review_id" : 547981842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:05:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539139300",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r539651046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539651046"
         }
      },
      "author_association" : "NONE",
      "body" : "TLDR; I made everything explicit in this commit https://github.com/bitcoin/bitcoin/pull/20276/commits/4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa because I realized this is all confusing. Thanks for pointing this out. \r\n\r\nIt was because fees from the transactions in the first test run (that are still in the mempool) `self.test_transaction_expiry(DEFAULT_MEMPOOL_EXPIRY)` get included in `MiniWallet`'s utxo set when this runs for the next sub-test `self.test_transaction_expiry(CUSTOM_MEMPOOL_EXPIRY)` if the first block is generated with `self.wallet.generate`\r\n\r\nThen because of the way `MiniWallet` sorts UTXOs based on which is largest it means we end up using an expired transaction for the \"trigger\" transaction, and get a weird error in the 2nd test run, but not the first - which threw me for a loop",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-09T21:12:23Z",
      "diff_hunk" : "@@ -26,44 +26,48 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n-\n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+        self.setup_clean_chain = True\n \n     def test_transaction_expiry(self, timeout):\n         \"\"\"Tests that a transaction expires after the expiry timeout and its\n         children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        self.wallet = MiniWallet(node)\n+\n+        # Ensure the mempool starts empty.\n+        node.generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r539651046",
      "id" : 539651046,
      "in_reply_to_id" : 539138125,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY1MTA0Ng==",
      "original_commit_id" : "7a05d47cdf0cf3b2787c4583c4b920f98351b0b3",
      "original_line" : 38,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : null,
      "pull_request_review_id" : 548613093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:12:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539651046",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r539651684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539651684"
         }
      },
      "author_association" : "NONE",
      "body" : "That's a good point, addressed in most recent commit",
      "commit_id" : "4b99dc5ef62fe1d1a6e23d71f55570dc14aac9fa",
      "created_at" : "2020-12-09T21:13:28Z",
      "diff_hunk" : "@@ -26,44 +26,48 @@\n class MempoolExpiryTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n-\n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n+        self.setup_clean_chain = True\n \n     def test_transaction_expiry(self, timeout):\n         \"\"\"Tests that a transaction expires after the expiry timeout and its\n         children are removed as well.\"\"\"\n         node = self.nodes[0]\n+        self.wallet = MiniWallet(node)\n+\n+        # Ensure the mempool starts empty.\n+        node.generate(1)\n+        assert_equal(set(node.getrawmempool()), set())\n+        # Add enough mature utxos to the wallet so that all txs spend confirmed coins.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#discussion_r539651684",
      "id" : 539651684,
      "in_reply_to_id" : 539139300,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY1MTY4NA==",
      "original_commit_id" : "7a05d47cdf0cf3b2787c4583c4b920f98351b0b3",
      "original_line" : 40,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/mempool_expiry.py",
      "position" : 25,
      "pull_request_review_id" : 548613868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20276",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-09T21:13:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539651684",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Please squash your commits according to https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#squashing-commits",
      "created_at" : "2020-12-10T08:02:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#issuecomment-742345843",
      "id" : 742345843,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20276",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MjM0NTg0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-10T08:02:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742345843",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "This has been squashed/rebased and is ready to go",
      "created_at" : "2020-12-15T17:39:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#issuecomment-745450465",
      "id" : 745450465,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20276",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NTQ1MDQ2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-15T17:39:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/745450465",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 3b064fcb9dd3df6c438a440f0fea86e9cf7b5f57",
      "created_at" : "2020-12-16T13:51:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20276#issuecomment-746315220",
      "id" : 746315220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20276",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NjMxNTIyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-16T13:51:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/746315220",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
