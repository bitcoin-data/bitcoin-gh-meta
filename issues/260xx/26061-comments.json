[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25932](https://github.com/bitcoin/bitcoin/pull/25932) (refactor: Simplify backtrack logic by yancyribbens)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-09-12T16:59:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#issuecomment-1244027511",
      "id" : 1244027511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26061",
      "node_id" : "IC_kwDOABII585KJlp3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1244027511/reactions"
      },
      "updated_at" : "2022-09-12T16:59:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1244027511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "There are two uses for `waste` metric in coin selection:\r\n\r\n1) BnB algorithm is designed to optimise for the `waste`. This is why **keeping track of the current and best `waste` is required to make algorithm work**\r\n2) `waste` is used to compare solutions produced by different algorithms. This is why there is a generic waste calculation for the `SelectionResult`\r\n\r\nAlso, the two definitions of waste are coincidentally equal right now, but they don't have to. There is a possibility that we will use additional heuristics for 2) without changing 1). ",
      "created_at" : "2022-09-14T06:13:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#issuecomment-1246290321",
      "id" : 1246290321,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26061",
      "node_id" : "IC_kwDOABII585KSOGR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1246290321/reactions"
      },
      "updated_at" : "2022-09-14T06:13:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1246290321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970356311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970356311"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "By removing this criteria for backtracking you significantly expand the search space that will lead a) to longer execution time b) overall less less solutions found due to hard cap of `TOTAL_TRIES`.",
      "commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "created_at" : "2022-09-14T06:15:02Z",
      "diff_hunk" : "@@ -93,19 +93,24 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n         bool backtrack = false;\n         if (curr_value + curr_available_value < selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.\n             curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\n-            (curr_waste > best_waste && (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0)) { // Don't select things which we know will be more wasteful if the waste is increasing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970356311",
      "id" : 970356311,
      "line" : 96,
      "node_id" : "PRRC_kwDOABII58451nZX",
      "original_commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "original_line" : 96,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 4,
      "pull_request_review_id" : 1106822661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970356311/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-14T06:16:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970356311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970357571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970357571"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is just the excess not the waste. Check line42 in this file or `GetSelectionWaste` for the waste formula. ",
      "commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "created_at" : "2022-09-14T06:16:53Z",
      "diff_hunk" : "@@ -93,19 +93,24 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n         bool backtrack = false;\n         if (curr_value + curr_available_value < selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.\n             curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\n-            (curr_waste > best_waste && (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0)) { // Don't select things which we know will be more wasteful if the waste is increasing\n+            (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0) { // Don't select more things if the current fee rate is expensive.\n             backtrack = true;\n         } else if (curr_value >= selection_target) {       // Selected value is within range\n-            curr_waste += (curr_value - selection_target); // This is the excess value which is added to the waste for the below comparison\n+\n+            // This is the excess waste for the current iteration.\n+            curr_waste = (curr_value - selection_target);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970357571",
      "id" : 970357571,
      "line" : 101,
      "node_id" : "PRRC_kwDOABII58451ntD",
      "original_commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "original_line" : 101,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 11,
      "pull_request_review_id" : 1106822661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970357571/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-14T06:16:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970357571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970424336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970424336"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This doesn't change the search space.   With this extra condition removed, this [code path](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/coinselection.cpp#L98) is used instead.  And in the case where `curr_waste > best_waste` using the code path L98, nothing different happens because of this [condition](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/coinselection.cpp#L104).  Since `best_waste` is better than `curr_waste`, nothing happens and in both branches, `backtrack=true` is set.  Running the benchmarks will show there's no difference.",
      "commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "created_at" : "2022-09-14T07:23:49Z",
      "diff_hunk" : "@@ -93,19 +93,24 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n         bool backtrack = false;\n         if (curr_value + curr_available_value < selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.\n             curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\n-            (curr_waste > best_waste && (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0)) { // Don't select things which we know will be more wasteful if the waste is increasing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970424336",
      "id" : 970424336,
      "in_reply_to_id" : 970356311,
      "line" : 96,
      "node_id" : "PRRC_kwDOABII584514AQ",
      "original_commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "original_line" : 96,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 4,
      "pull_request_review_id" : 1106929524,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970424336/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-14T07:23:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970424336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/817736?v=4",
         "events_url" : "https://api.github.com/users/yancyribbens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/yancyribbens/followers",
         "following_url" : "https://api.github.com/users/yancyribbens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/yancyribbens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/yancyribbens",
         "id" : 817736,
         "login" : "yancyribbens",
         "node_id" : "MDQ6VXNlcjgxNzczNg==",
         "organizations_url" : "https://api.github.com/users/yancyribbens/orgs",
         "received_events_url" : "https://api.github.com/users/yancyribbens/received_events",
         "repos_url" : "https://api.github.com/users/yancyribbens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/yancyribbens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/yancyribbens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/yancyribbens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970429168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970429168"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@S3RK The search space is not changed.  The code is now simpler, however, the change could be pulled from this PR and added to a new PR since it's independent of other improvements.",
      "commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "created_at" : "2022-09-14T07:28:33Z",
      "diff_hunk" : "@@ -93,19 +93,24 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n         bool backtrack = false;\n         if (curr_value + curr_available_value < selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.\n             curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\n-            (curr_waste > best_waste && (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0)) { // Don't select things which we know will be more wasteful if the waste is increasing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970429168",
      "id" : 970429168,
      "in_reply_to_id" : 970356311,
      "line" : 96,
      "node_id" : "PRRC_kwDOABII584515Lw",
      "original_commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "original_line" : 96,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 4,
      "pull_request_review_id" : 1106937110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970429168/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-14T14:41:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970429168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/817736?v=4",
         "events_url" : "https://api.github.com/users/yancyribbens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/yancyribbens/followers",
         "following_url" : "https://api.github.com/users/yancyribbens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/yancyribbens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/yancyribbens",
         "id" : 817736,
         "login" : "yancyribbens",
         "node_id" : "MDQ6VXNlcjgxNzczNg==",
         "organizations_url" : "https://api.github.com/users/yancyribbens/orgs",
         "received_events_url" : "https://api.github.com/users/yancyribbens/received_events",
         "repos_url" : "https://api.github.com/users/yancyribbens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/yancyribbens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/yancyribbens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/yancyribbens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970974014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970974014"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@S3RK shouldn't the variable be called `excess_val` or something instead of `curr_waste` then?  To me either would make sense although as the variable is named right now, it doesn't seem to be called `excess`.",
      "commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "created_at" : "2022-09-14T15:27:50Z",
      "diff_hunk" : "@@ -93,19 +93,24 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n         bool backtrack = false;\n         if (curr_value + curr_available_value < selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.\n             curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\n-            (curr_waste > best_waste && (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0)) { // Don't select things which we know will be more wasteful if the waste is increasing\n+            (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0) { // Don't select more things if the current fee rate is expensive.\n             backtrack = true;\n         } else if (curr_value >= selection_target) {       // Selected value is within range\n-            curr_waste += (curr_value - selection_target); // This is the excess value which is added to the waste for the below comparison\n+\n+            // This is the excess waste for the current iteration.\n+            curr_waste = (curr_value - selection_target);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r970974014",
      "id" : 970974014,
      "in_reply_to_id" : 970357571,
      "line" : 101,
      "node_id" : "PRRC_kwDOABII58453-M-",
      "original_commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "original_line" : 101,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 11,
      "pull_request_review_id" : 1107747075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970974014/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-14T15:27:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970974014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/817736?v=4",
         "events_url" : "https://api.github.com/users/yancyribbens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/yancyribbens/followers",
         "following_url" : "https://api.github.com/users/yancyribbens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/yancyribbens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/yancyribbens",
         "id" : 817736,
         "login" : "yancyribbens",
         "node_id" : "MDQ6VXNlcjgxNzczNg==",
         "organizations_url" : "https://api.github.com/users/yancyribbens/orgs",
         "received_events_url" : "https://api.github.com/users/yancyribbens/received_events",
         "repos_url" : "https://api.github.com/users/yancyribbens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/yancyribbens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/yancyribbens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/yancyribbens"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@S3RK thanks for taking a look and your comment.  I understand the idea to formalize a scoring system so we can have a metric that's algorithm independent.  However, the boolean check done here is all that's needed to ensure we minimize our UTXO set when fees are expensive:\r\n\r\n[(utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/coinselection.cpp#L96)\r\n\r\nWhich as I pointed out in a previous [PR](https://github.com/bitcoin/bitcoin/pull/25932) is a more confusing way of saying:\r\n`utxo_pool.at(0).fee > utxo_pool.at(0).long_term_fee`\r\n\r\nI guess we could leave the code as is where it independently computes the waste, although as you can see by this PR, it's not actually needed.   IE if you notice, all tests still pass even though it no longer tracks the \"waste score\".   Instead I suppose we get rid of the other [waste calulation](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/coinselection.cpp#L159).\r\n\r\n> Also, the two definitions of waste are coincidentally equal right now, but they don't have to. There is a possibility that we will use additional heuristics for 2) without changing 1).\r\n\r\nI think what you're saying is we don't acctually need this [assert](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/coinselection.cpp#L160) then to check for equality?",
      "created_at" : "2022-09-14T15:59:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#issuecomment-1246981189",
      "id" : 1246981189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26061",
      "node_id" : "IC_kwDOABII585KU2xF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1246981189/reactions"
      },
      "updated_at" : "2022-09-14T15:59:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1246981189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/817736?v=4",
         "events_url" : "https://api.github.com/users/yancyribbens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/yancyribbens/followers",
         "following_url" : "https://api.github.com/users/yancyribbens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/yancyribbens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/yancyribbens",
         "id" : 817736,
         "login" : "yancyribbens",
         "node_id" : "MDQ6VXNlcjgxNzczNg==",
         "organizations_url" : "https://api.github.com/users/yancyribbens/orgs",
         "received_events_url" : "https://api.github.com/users/yancyribbens/received_events",
         "repos_url" : "https://api.github.com/users/yancyribbens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/yancyribbens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/yancyribbens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/yancyribbens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r971094644"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/971094644"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree that without limitation to the number of iterations you'd get the same result with your algorithm. But we actually have a hard limit of `TOTAL_TRIES`. That means if there are more combinations of coins than `TOTAL_TRIES` we're not going to explore all of them. This is why we want to exit as early as possible, in particular in this condition allows to cut off branches where we didn't reach the target yet but the solution is already worse our current best.",
      "commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "created_at" : "2022-09-14T17:15:15Z",
      "diff_hunk" : "@@ -93,19 +93,24 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n         bool backtrack = false;\n         if (curr_value + curr_available_value < selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.\n             curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\n-            (curr_waste > best_waste && (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0)) { // Don't select things which we know will be more wasteful if the waste is increasing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r971094644",
      "id" : 971094644,
      "in_reply_to_id" : 970356311,
      "line" : 96,
      "node_id" : "PRRC_kwDOABII58454bp0",
      "original_commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "original_line" : 96,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 4,
      "pull_request_review_id" : 1107915043,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/971094644/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-14T17:15:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/971094644",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r971095644"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/971095644"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, `waste` Contains `excess` but there are other components to it",
      "commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "created_at" : "2022-09-14T17:16:12Z",
      "diff_hunk" : "@@ -93,19 +93,24 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n         bool backtrack = false;\n         if (curr_value + curr_available_value < selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.\n             curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\n-            (curr_waste > best_waste && (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0)) { // Don't select things which we know will be more wasteful if the waste is increasing\n+            (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) > 0) { // Don't select more things if the current fee rate is expensive.\n             backtrack = true;\n         } else if (curr_value >= selection_target) {       // Selected value is within range\n-            curr_waste += (curr_value - selection_target); // This is the excess value which is added to the waste for the below comparison\n+\n+            // This is the excess waste for the current iteration.\n+            curr_waste = (curr_value - selection_target);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#discussion_r971095644",
      "id" : 971095644,
      "in_reply_to_id" : 970357571,
      "line" : 101,
      "node_id" : "PRRC_kwDOABII58454b5c",
      "original_commit_id" : "d78589322a071b8fd704f7952025e6793b0898c9",
      "original_line" : 101,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 11,
      "pull_request_review_id" : 1107916315,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26061",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/971095644/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-14T17:16:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/971095644",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> However, the boolean check done here is all that's needed to ensure we minimize our UTXO set when fees are expensive:\r\n\r\nI addressed the question about the Boolean check in the inline thread. Here however, I want to warn against mis-representing the BnB algo. BnB doesn't just minimize UTXO set when fees are high, it optimizes for the `waste` metric that consists of two parts 1) excess 2) opportunity cost of spending inputs at `long_term_fee_rate`\r\n\r\n> I guess we could leave the code as is where it independently computes the waste, although as you can see by this PR, it's not actually needed. IE if you notice, all tests still pass even though it no longer tracks the \"waste score\". \r\n\r\nIf I remember the tests correctly, then this rather shows deficiency in tests rather than the correctness of implemented approach. 1) There is only one test where we hit `TOTAL_TRIES` limit and in this test we just verify there is no solution found 2) There are no tests asserting waste that has both components excess and input opportunity costs\r\n\r\nI'd recommend you contribute these tests first before modifying the algorithm.\r\n\r\n> Instead I suppose we get rid of the other [waste calulation](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/coinselection.cpp#L159).\r\n\r\nThe other waste calculation is used to set waste score for the BnB `SelectionResult` for the purpose of comparing it to other solution. See use-case 2 from my previous comment. \r\n\r\n> I think what you're saying is we don't acctually need this [assert](https://github.com/bitcoin/bitcoin/blob/master/src/wallet/coinselection.cpp#L160) then to check for equality?\r\n\r\nWhile I'd say we don't really need this assert, others might disagree and there's no harm in it.\r\n\r\n",
      "created_at" : "2022-09-14T18:51:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#issuecomment-1247173248",
      "id" : 1247173248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26061",
      "node_id" : "IC_kwDOABII585KVlqA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1247173248/reactions"
      },
      "updated_at" : "2022-09-14T18:51:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1247173248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "NACK\r\n\r\n@S3RK is correct and this change would be detrimental. Waste in BnB is used as an optimizing parameter - it allows us to prune branches when searching. Removing it means that we are searching more branches (which impacts the iteration limit), and the change which makes it only the excess means that we may be pruning branches that we were not pruning previously, in addition to not pruning many branches that we would have.",
      "created_at" : "2022-09-14T19:34:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#issuecomment-1247216638",
      "id" : 1247216638,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26061",
      "node_id" : "IC_kwDOABII585KVwP-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1247216638/reactions"
      },
      "updated_at" : "2022-09-14T19:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1247216638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, @S3RK and @achow101 are correct. In a high-feerate situation (i.e. feerate > long_term_feerate_estimate) adding more inputs will only increase the waste. So if a partial input set already has a higher waste than the current best solution we cannot find a better solution (one with a lower waste) by adding more inputs. Thus, if the waste of a partial input set is higher than the best waste, we can skip the entire subtree from the search space. I believe this backtrack clause to be a major speed-up, because otherwise evaluating all possible subsets of the cut subtree would take up to exponential work in the size of the subtree.\r\n\r\nI think that you were onto this optimization though:\r\nhttps://github.com/bitcoin/bitcoin/pull/26104",
      "created_at" : "2022-09-15T19:44:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26061#issuecomment-1248535918",
      "id" : 1248535918,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26061",
      "node_id" : "IC_kwDOABII585KayVu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1248535918/reactions"
      },
      "updated_at" : "2022-09-15T19:44:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1248535918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   }
]
