[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@sipa: Since you authored the SipHash implementation optimized for 256-bit ints in Python (9c8593d2b4e25ef628172ceadbedf0ef078d01ef) and also the other ones in our main codebase, you could might want to take a look at the first commit. I'm pretty confident that it works as intended, but maybe there are some subtleties or corner-cases that I overlooked.",
      "created_at" : "2022-10-19T17:52:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26341#issuecomment-1284373225",
      "id" : 1284373225,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26341",
      "node_id" : "IC_kwDOABII585Mjfrp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284373225/reactions"
      },
      "updated_at" : "2022-10-19T17:52:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284373225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26341#discussion_r999794603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26341"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999794603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think we need a specialized siphash256 anymore if you've written a generic one; there won't be a noticeable performance difference between the two.\r\n\r\nSo I think you can change `siphash256` to be implemented by just calling `siphash`.",
      "commit_id" : "fa54d3011ed0cbb7bcdc76548423ba41f0042832",
      "created_at" : "2022-10-19T18:14:10Z",
      "diff_hunk" : "@@ -27,6 +29,37 @@ def siphash_round(v0, v1, v2, v3):\n     v2 = rotl64(v2, 32)\n     return (v0, v1, v2, v3)\n \n+\n+def siphash(k0, k1, data):\n+    assert(type(data) == bytes)\n+    v0 = 0x736f6d6570736575 ^ k0\n+    v1 = 0x646f72616e646f6d ^ k1\n+    v2 = 0x6c7967656e657261 ^ k0\n+    v3 = 0x7465646279746573 ^ k1\n+    c = 0\n+    t = 0\n+    for d in data:\n+        t |= d << (8 * (c % 8))\n+        c = (c + 1) & 0xff\n+        if (c & 7) == 0:\n+            v3 ^= t\n+            v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+            v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+            v0 ^= t\n+            t = 0\n+    t = t | (c << 56)\n+    v3 ^= t\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0 ^= t\n+    v2 ^= 0xff\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    return v0 ^ v1 ^ v2 ^ v3\n+\n+\n def siphash256(k0, k1, h):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26341#discussion_r999794603",
      "id" : 999794603,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847l6er",
      "original_commit_id" : "5555e72d10044b10e9970044431109bcec19b575",
      "original_line" : 63,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/siphash.py",
      "position" : null,
      "pull_request_review_id" : 1148071691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26341",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999794603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T18:14:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999794603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, good idea.",
      "created_at" : "2022-10-19T20:30:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26341#issuecomment-1284538414",
      "id" : 1284538414,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26341",
      "node_id" : "IC_kwDOABII585MkIAu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284538414/reactions"
      },
      "updated_at" : "2022-10-19T20:30:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284538414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26341#discussion_r1000018688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26341"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1000018688"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree! Thanks, done.",
      "commit_id" : "fa54d3011ed0cbb7bcdc76548423ba41f0042832",
      "created_at" : "2022-10-19T23:37:46Z",
      "diff_hunk" : "@@ -27,6 +29,37 @@ def siphash_round(v0, v1, v2, v3):\n     v2 = rotl64(v2, 32)\n     return (v0, v1, v2, v3)\n \n+\n+def siphash(k0, k1, data):\n+    assert(type(data) == bytes)\n+    v0 = 0x736f6d6570736575 ^ k0\n+    v1 = 0x646f72616e646f6d ^ k1\n+    v2 = 0x6c7967656e657261 ^ k0\n+    v3 = 0x7465646279746573 ^ k1\n+    c = 0\n+    t = 0\n+    for d in data:\n+        t |= d << (8 * (c % 8))\n+        c = (c + 1) & 0xff\n+        if (c & 7) == 0:\n+            v3 ^= t\n+            v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+            v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+            v0 ^= t\n+            t = 0\n+    t = t | (c << 56)\n+    v3 ^= t\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0 ^= t\n+    v2 ^= 0xff\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    v0, v1, v2, v3 = siphash_round(v0, v1, v2, v3)\n+    return v0 ^ v1 ^ v2 ^ v3\n+\n+\n def siphash256(k0, k1, h):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26341#discussion_r1000018688",
      "id" : 1000018688,
      "in_reply_to_id" : 999794603,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847mxMA",
      "original_commit_id" : "5555e72d10044b10e9970044431109bcec19b575",
      "original_line" : 63,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/siphash.py",
      "position" : null,
      "pull_request_review_id" : 1148387448,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26341",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1000018688/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T23:37:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1000018688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ISTM a simpler test would be to just have a fixed collision with the fixed addresses that we generate blocks to for each node. Then we would not need the siphash or bip158 specific things and could just do normal scanblocks and see that there are false positives for blocks mined by e.g. node 0 for some scriptPubKey that is clearly not used anywhere else.\r\n\r\nA more meta-comment: should we even be scanning block 0 since it's coinbase UTXO is unspendable?",
      "created_at" : "2022-10-24T20:03:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26341#issuecomment-1289535200",
      "id" : 1289535200,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26341",
      "node_id" : "IC_kwDOABII585M3L7g",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1289535200/reactions"
      },
      "updated_at" : "2022-10-24T20:03:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1289535200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> ISTM a simpler test would be to just have a fixed collision with the fixed addresses that we generate blocks to for each node. Then we would not need the siphash or bip158 specific things and could just do normal scanblocks and see that there are false positives for blocks mined by e.g. node 0 for some scriptPubKey that is clearly not used anywhere else.\r\n\r\nWhether two scriptPubKeys BIP158-collide or not is not only dependent on the scripts, but also on the block hash of the block they'd appear in (that's the _k_ used as key passed to SipHash). The only block hash that we know will basically _always_ be constant is the one from genesis block, hence this choice. Though I assume right now the pre-generated functional test chain generates the exact same blocks and thus block hashes between runs (at least per node), the precalculated false-positives wouldn't work anymore if for whatever reason any minor detail of created blocks (e.g. nVersion, timestamp, included tx) ever changes in the future, which could be very annoying. If I didn't miss something, I think there is no easier way than to use the genesis block. The ranged hash BIP158 calculation routines (involving SipHash) are just there for a verification of the false-positive, which IMHO makes sense.\r\n\r\n> A more meta-comment: should we even be scanning block 0 since it's coinbase UTXO is unspendable?\r\n\r\nGood question. I'd say yes, as I see `scanblocks` as a general tool for \"show me all blocks containing txs that involve scriptPubKey xyz\" rather than taking details like spendability into account (there are a lots of UTXOs that are unspendable, some even provably unspendable, like e.g. P2TR outputs with invalid x-only-pubkeys).",
      "created_at" : "2022-10-25T01:44:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26341#issuecomment-1289866222",
      "id" : 1289866222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26341",
      "node_id" : "IC_kwDOABII585M4cvu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1289866222/reactions"
      },
      "updated_at" : "2022-10-25T01:45:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1289866222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK fa54d3011ed0cbb7bcdc76548423ba41f0042832\r\n\r\n> Whether two scriptPubKeys BIP158-collide or not is not only dependent on the scripts, but also on the block hash of the block they'd appear in (that's the k used as key passed to SipHash). The only block hash that we know will basically always be constant is the one from genesis block, hence this choice\r\n\r\nAh, I forgot about that. Although the test could make a fixed block manually as well, and that would sidestep any determinism issues.",
      "created_at" : "2022-10-25T19:34:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26341#issuecomment-1291041983",
      "id" : 1291041983,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26341",
      "node_id" : "IC_kwDOABII585M87y_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1291041983/reactions"
      },
      "updated_at" : "2022-10-25T19:36:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1291041983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
