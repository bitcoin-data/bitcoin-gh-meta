[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ajtowns](https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1420150318), [dhruv](https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1421250665) |\n| Concept ACK | [theStack](https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1264748109) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25325](https://github.com/bitcoin/bitcoin/pull/25325) (Add pool based memory resource by martinus)\n* [#24748](https://github.com/bitcoin/bitcoin/pull/24748) (test/BIP324: functional tests for v2 P2P encryption by stratospher)\n* [#23169](https://github.com/bitcoin/bitcoin/pull/23169) (fix initialization in FastRandomContext: removes undefined behavior & uninitialized read by martinus)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-09-22T06:12:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1254573363",
      "id" : 1254573363,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585Kx0Uz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1254573363/reactions"
      },
      "updated_at" : "2023-02-14T18:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1254573363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @theStack re #25698 & #25712.\r\n\r\n> (by my benchmarking, somewhat faster),\r\n\r\n@aureleoules want to benchmark here as well?",
      "created_at" : "2022-09-22T08:41:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1254711925",
      "id" : 1254711925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585KyWJ1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1254711925/reactions"
      },
      "updated_at" : "2022-09-22T08:41:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1254711925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r977416900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977416900"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n```\r\nnit: can be removed",
      "commit_id" : "d1aa65b2927b0c07d1a875475fb0bdd024351bd4",
      "created_at" : "2022-09-22T09:22:46Z",
      "diff_hunk" : "@@ -8,24 +8,74 @@\n #include <stdint.h>\n #include <stdlib.h>\n \n-/** A class for ChaCha20 256-bit stream cipher developed by Daniel J. Bernstein\n-    https://cr.yp.to/chacha/chacha-20080128.pdf */\n+// classes for ChaCha20 256-bit stream cipher developed by Daniel J. Bernstein\n+// https://cr.yp.to/chacha/chacha-20080128.pdf */\n+\n+/** ChaCha20 cipher that only operates on multiples of 64 bytes. */\n+class ChaCha20Aligned\n+{\n+private:\n+    uint32_t input[12];\n+\n+public:\n+    ChaCha20Aligned();\n+\n+    /** Initialize a cipher with specified 32-byte key. */\n+    ChaCha20Aligned(const unsigned char* key32);\n+\n+    /** set 32-byte key. */\n+    void SetKey32(const unsigned char* key32);\n+\n+    /** set the 64-bit nonce. */\n+    void SetIV(uint64_t iv);\n+\n+    /** set the 64bit block counter (pos seeks to byte position 64*pos). */\n+    void Seek64(uint64_t pos);\n+\n+    /** outputs the keystream of size <64*blocks> into <c> */\n+    void Keystream64(unsigned char* c, size_t blocks);\n+\n+    /** enciphers the message <input> of length <64*blocks> and write the enciphered representation into <output>\n+     *  Used for encryption and decryption (XOR)\n+     */\n+    void Crypt64(const unsigned char* input, unsigned char* output, size_t blocks);\n+};\n+\n+/** Unrestricted ChaCha20 cipher. */\n class ChaCha20\n {\n private:\n-    uint32_t input[16];\n+    ChaCha20Aligned m_aligned;\n+    unsigned char m_buffer[64] = {0};\n+    unsigned m_bufleft{0};\n \n public:\n-    ChaCha20();\n-    ChaCha20(const unsigned char* key, size_t keylen);\n-    void SetKey(const unsigned char* key, size_t keylen); //!< set key with flexible keylength; 256bit recommended */\n-    void SetIV(uint64_t iv); // set the 64bit nonce\n-    void Seek(uint64_t pos); // set the 64bit block counter\n+    ChaCha20() : m_aligned() {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r977416900",
      "id" : 977416900,
      "line" : 53,
      "node_id" : "PRRC_kwDOABII5846QjLE",
      "original_commit_id" : "d1aa65b2927b0c07d1a875475fb0bdd024351bd4",
      "original_line" : 53,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/crypto/chacha20.h",
      "position" : 54,
      "pull_request_review_id" : 1116695351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977416900/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T09:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977416900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r977980275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977980275"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "4d85d8483bbc8fdc8338c1b2ebe62c1ababc85ca",
      "created_at" : "2022-09-22T18:45:37Z",
      "diff_hunk" : "@@ -8,24 +8,74 @@\n #include <stdint.h>\n #include <stdlib.h>\n \n-/** A class for ChaCha20 256-bit stream cipher developed by Daniel J. Bernstein\n-    https://cr.yp.to/chacha/chacha-20080128.pdf */\n+// classes for ChaCha20 256-bit stream cipher developed by Daniel J. Bernstein\n+// https://cr.yp.to/chacha/chacha-20080128.pdf */\n+\n+/** ChaCha20 cipher that only operates on multiples of 64 bytes. */\n+class ChaCha20Aligned\n+{\n+private:\n+    uint32_t input[12];\n+\n+public:\n+    ChaCha20Aligned();\n+\n+    /** Initialize a cipher with specified 32-byte key. */\n+    ChaCha20Aligned(const unsigned char* key32);\n+\n+    /** set 32-byte key. */\n+    void SetKey32(const unsigned char* key32);\n+\n+    /** set the 64-bit nonce. */\n+    void SetIV(uint64_t iv);\n+\n+    /** set the 64bit block counter (pos seeks to byte position 64*pos). */\n+    void Seek64(uint64_t pos);\n+\n+    /** outputs the keystream of size <64*blocks> into <c> */\n+    void Keystream64(unsigned char* c, size_t blocks);\n+\n+    /** enciphers the message <input> of length <64*blocks> and write the enciphered representation into <output>\n+     *  Used for encryption and decryption (XOR)\n+     */\n+    void Crypt64(const unsigned char* input, unsigned char* output, size_t blocks);\n+};\n+\n+/** Unrestricted ChaCha20 cipher. */\n class ChaCha20\n {\n private:\n-    uint32_t input[16];\n+    ChaCha20Aligned m_aligned;\n+    unsigned char m_buffer[64] = {0};\n+    unsigned m_bufleft{0};\n \n public:\n-    ChaCha20();\n-    ChaCha20(const unsigned char* key, size_t keylen);\n-    void SetKey(const unsigned char* key, size_t keylen); //!< set key with flexible keylength; 256bit recommended */\n-    void SetIV(uint64_t iv); // set the 64bit nonce\n-    void Seek(uint64_t pos); // set the 64bit block counter\n+    ChaCha20() : m_aligned() {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r977980275",
      "id" : 977980275,
      "in_reply_to_id" : 977416900,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846Sstz",
      "original_commit_id" : "d1aa65b2927b0c07d1a875475fb0bdd024351bd4",
      "original_line" : 53,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/crypto/chacha20.h",
      "position" : null,
      "pull_request_review_id" : 1117526596,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977980275/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T18:45:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977980275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jarolrod It's possible that these differences are just compiler/cpu cache randomness. E.g. just having functions be layed out slightly differently in memory can cause a difference in slight timing differences. Objectively, this PR does less work per byte for long messages than master, while 25354 does more work per byte, but that's not always possible to benchmark when you're talking about a difference of a few CPU cycles per 64 bytes. The compiler may in some cases just emit slightly better or slightly worse code, just due to e.g. alignment differences in where the functions end up in the binary and the CPU caching effects.",
      "created_at" : "2022-09-27T19:06:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1259932901",
      "id" : 1259932901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585LGQzl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1259932901/reactions"
      },
      "updated_at" : "2022-09-27T19:07:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1259932901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-10-02T22:30:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1264748109",
      "id" : 1264748109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585LYoZN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1264748109/reactions"
      },
      "updated_at" : "2022-10-02T22:30:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1264748109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-10-19T09:30:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1283706271",
      "id" : 1283706271,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585Mg82f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1283706271/reactions"
      },
      "updated_at" : "2022-10-19T09:30:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1283706271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.",
      "created_at" : "2022-10-19T17:54:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1284375966",
      "id" : 1284375966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585MjgWe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284375966/reactions"
      },
      "updated_at" : "2022-10-19T17:54:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284375966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-11-19T01:37:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1320732368",
      "id" : 1320732368,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585OuMbQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1320732368/reactions"
      },
      "updated_at" : "2022-11-19T01:37:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1320732368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-11-21T18:21:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1322473633",
      "id" : 1322473633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585O01ih",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1322473633/reactions"
      },
      "updated_at" : "2022-11-21T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1322473633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-11-30T01:20:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1331524362",
      "id" : 1331524362,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585PXXMK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331524362/reactions"
      },
      "updated_at" : "2022-11-30T01:20:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331524362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.",
      "created_at" : "2022-12-05T19:23:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1338014515",
      "id" : 1338014515,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585PwHsz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338014515/reactions"
      },
      "updated_at" : "2022-12-05T19:23:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338014515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1055466307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1055466307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I checked the test coverage of this PR and this does not seem to be tested (https://btc-coverage.s3.eu-west-1.amazonaws.com/PR-26153/src/crypto/chacha20.cpp.gcov.html).\r\nIs it possible to add a test?",
      "commit_id" : "4d85d8483bbc8fdc8338c1b2ebe62c1ababc85ca",
      "created_at" : "2022-12-22T13:36:35Z",
      "diff_hunk" : "@@ -303,16 +260,65 @@ void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n         WriteLE32(c + 56, x14);\n         WriteLE32(c + 60, x15);\n \n-        if (bytes <= 64) {\n-            if (bytes < 64) {\n-                for (i = 0;i < bytes;++i) ctarget[i] = c[i];\n-            }\n-            input[12] = j12;\n-            input[13] = j13;\n+        if (blocks == 1) {\n+            input[8] = j12;\n+            input[9] = j13;\n             return;\n         }\n-        bytes -= 64;\n+        blocks -= 1;\n         c += 64;\n         m += 64;\n     }\n }\n+\n+void ChaCha20::Keystream(unsigned char* c, size_t bytes)\n+{\n+    if (!bytes) return;\n+    if (m_bufleft) {\n+        unsigned reuse = std::min<size_t>(m_bufleft, bytes);\n+        memcpy(c, m_buffer + 64 - m_bufleft, reuse);\n+        m_bufleft -= reuse;\n+        bytes -= reuse;\n+        c += reuse;\n+    }\n+    if (bytes >= 64) {\n+        size_t blocks = bytes / 64;\n+        m_aligned.Keystream64(c, blocks);\n+        c += blocks * 64;\n+        bytes -= blocks * 64;\n+    }\n+    if (bytes) {\n+        m_aligned.Keystream64(m_buffer, 1);\n+        memcpy(c, m_buffer, bytes);\n+        m_bufleft = 64 - bytes;\n+    }\n+}\n+\n+void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n+{\n+    unsigned reuse = std::min<size_t>(m_bufleft, bytes);\n+    if (!bytes) return;\n+    if (m_bufleft) {\n+        for (unsigned i = 0; i < reuse; i++) {\n+            c[i] = m[i] ^ m_buffer[64 - m_bufleft + i];\n+        }\n+        m_bufleft -= reuse;\n+        bytes -= reuse;\n+        c += reuse;\n+        m += reuse;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1055466307",
      "id" : 1055466307,
      "line" : 308,
      "node_id" : "PRRC_kwDOABII584-6SND",
      "original_commit_id" : "4d85d8483bbc8fdc8338c1b2ebe62c1ababc85ca",
      "original_line" : 308,
      "original_position" : 318,
      "original_start_line" : 302,
      "path" : "src/crypto/chacha20.cpp",
      "position" : 318,
      "pull_request_review_id" : 1227678704,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1055466307/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 302,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-22T13:36:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1055466307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1080574229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1080574229"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@aureleoules Added a commit to that effect, can you check it's now covered?",
      "commit_id" : "013c0dd4cce3fd97ceb384c33149085900fa37f4",
      "created_at" : "2023-01-18T21:27:39Z",
      "diff_hunk" : "@@ -303,16 +260,65 @@ void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n         WriteLE32(c + 56, x14);\n         WriteLE32(c + 60, x15);\n \n-        if (bytes <= 64) {\n-            if (bytes < 64) {\n-                for (i = 0;i < bytes;++i) ctarget[i] = c[i];\n-            }\n-            input[12] = j12;\n-            input[13] = j13;\n+        if (blocks == 1) {\n+            input[8] = j12;\n+            input[9] = j13;\n             return;\n         }\n-        bytes -= 64;\n+        blocks -= 1;\n         c += 64;\n         m += 64;\n     }\n }\n+\n+void ChaCha20::Keystream(unsigned char* c, size_t bytes)\n+{\n+    if (!bytes) return;\n+    if (m_bufleft) {\n+        unsigned reuse = std::min<size_t>(m_bufleft, bytes);\n+        memcpy(c, m_buffer + 64 - m_bufleft, reuse);\n+        m_bufleft -= reuse;\n+        bytes -= reuse;\n+        c += reuse;\n+    }\n+    if (bytes >= 64) {\n+        size_t blocks = bytes / 64;\n+        m_aligned.Keystream64(c, blocks);\n+        c += blocks * 64;\n+        bytes -= blocks * 64;\n+    }\n+    if (bytes) {\n+        m_aligned.Keystream64(m_buffer, 1);\n+        memcpy(c, m_buffer, bytes);\n+        m_bufleft = 64 - bytes;\n+    }\n+}\n+\n+void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n+{\n+    unsigned reuse = std::min<size_t>(m_bufleft, bytes);\n+    if (!bytes) return;\n+    if (m_bufleft) {\n+        for (unsigned i = 0; i < reuse; i++) {\n+            c[i] = m[i] ^ m_buffer[64 - m_bufleft + i];\n+        }\n+        m_bufleft -= reuse;\n+        bytes -= reuse;\n+        c += reuse;\n+        m += reuse;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1080574229",
      "id" : 1080574229,
      "in_reply_to_id" : 1055466307,
      "line" : 308,
      "node_id" : "PRRC_kwDOABII585AaEEV",
      "original_commit_id" : "4d85d8483bbc8fdc8338c1b2ebe62c1ababc85ca",
      "original_line" : 308,
      "original_position" : 318,
      "original_start_line" : 302,
      "path" : "src/crypto/chacha20.cpp",
      "position" : 318,
      "pull_request_review_id" : 1260797481,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1080574229/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 302,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-18T21:27:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1080574229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081097858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081097858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I updated the coverage (same url), and it's well covered now. Well done.",
      "commit_id" : "013c0dd4cce3fd97ceb384c33149085900fa37f4",
      "created_at" : "2023-01-19T10:52:49Z",
      "diff_hunk" : "@@ -303,16 +260,65 @@ void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n         WriteLE32(c + 56, x14);\n         WriteLE32(c + 60, x15);\n \n-        if (bytes <= 64) {\n-            if (bytes < 64) {\n-                for (i = 0;i < bytes;++i) ctarget[i] = c[i];\n-            }\n-            input[12] = j12;\n-            input[13] = j13;\n+        if (blocks == 1) {\n+            input[8] = j12;\n+            input[9] = j13;\n             return;\n         }\n-        bytes -= 64;\n+        blocks -= 1;\n         c += 64;\n         m += 64;\n     }\n }\n+\n+void ChaCha20::Keystream(unsigned char* c, size_t bytes)\n+{\n+    if (!bytes) return;\n+    if (m_bufleft) {\n+        unsigned reuse = std::min<size_t>(m_bufleft, bytes);\n+        memcpy(c, m_buffer + 64 - m_bufleft, reuse);\n+        m_bufleft -= reuse;\n+        bytes -= reuse;\n+        c += reuse;\n+    }\n+    if (bytes >= 64) {\n+        size_t blocks = bytes / 64;\n+        m_aligned.Keystream64(c, blocks);\n+        c += blocks * 64;\n+        bytes -= blocks * 64;\n+    }\n+    if (bytes) {\n+        m_aligned.Keystream64(m_buffer, 1);\n+        memcpy(c, m_buffer, bytes);\n+        m_bufleft = 64 - bytes;\n+    }\n+}\n+\n+void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n+{\n+    unsigned reuse = std::min<size_t>(m_bufleft, bytes);\n+    if (!bytes) return;\n+    if (m_bufleft) {\n+        for (unsigned i = 0; i < reuse; i++) {\n+            c[i] = m[i] ^ m_buffer[64 - m_bufleft + i];\n+        }\n+        m_bufleft -= reuse;\n+        bytes -= reuse;\n+        c += reuse;\n+        m += reuse;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081097858",
      "id" : 1081097858,
      "in_reply_to_id" : 1055466307,
      "line" : 308,
      "node_id" : "PRRC_kwDOABII585AcD6C",
      "original_commit_id" : "4d85d8483bbc8fdc8338c1b2ebe62c1ababc85ca",
      "original_line" : 308,
      "original_position" : 318,
      "original_start_line" : 302,
      "path" : "src/crypto/chacha20.cpp",
      "position" : 318,
      "pull_request_review_id" : 1261549143,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081097858/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 302,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-19T10:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081097858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081854124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081854124"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `reuse` should be inside the `if (m_bufleft)` here as well?",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-19T20:54:41Z",
      "diff_hunk" : "@@ -303,16 +260,65 @@ void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n         WriteLE32(c + 56, x14);\n         WriteLE32(c + 60, x15);\n \n-        if (bytes <= 64) {\n-            if (bytes < 64) {\n-                for (i = 0;i < bytes;++i) ctarget[i] = c[i];\n-            }\n-            input[12] = j12;\n-            input[13] = j13;\n+        if (blocks == 1) {\n+            input[8] = j12;\n+            input[9] = j13;\n             return;\n         }\n-        bytes -= 64;\n+        blocks -= 1;\n         c += 64;\n         m += 64;\n     }\n }\n+\n+void ChaCha20::Keystream(unsigned char* c, size_t bytes)\n+{\n+    if (!bytes) return;\n+    if (m_bufleft) {\n+        unsigned reuse = std::min<size_t>(m_bufleft, bytes);\n+        memcpy(c, m_buffer + 64 - m_bufleft, reuse);\n+        m_bufleft -= reuse;\n+        bytes -= reuse;\n+        c += reuse;\n+    }\n+    if (bytes >= 64) {\n+        size_t blocks = bytes / 64;\n+        m_aligned.Keystream64(c, blocks);\n+        c += blocks * 64;\n+        bytes -= blocks * 64;\n+    }\n+    if (bytes) {\n+        m_aligned.Keystream64(m_buffer, 1);\n+        memcpy(c, m_buffer, bytes);\n+        m_bufleft = 64 - bytes;\n+    }\n+}\n+\n+void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n+{\n+    unsigned reuse = std::min<size_t>(m_bufleft, bytes);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081854124",
      "id" : 1081854124,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ae8is",
      "original_commit_id" : "013c0dd4cce3fd97ceb384c33149085900fa37f4",
      "original_line" : 299,
      "original_position" : 309,
      "original_start_line" : null,
      "path" : "src/crypto/chacha20.cpp",
      "position" : null,
      "pull_request_review_id" : 1262606323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081854124/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-19T21:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081854124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081861264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081861264"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`std::numeric_limits<result_type>::max()` ?",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-19T21:03:50Z",
      "diff_hunk" : "@@ -0,0 +1,71 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TEST_UTIL_XOROSHIRO128PLUSPLUS_H\n+#define BITCOIN_TEST_UTIL_XOROSHIRO128PLUSPLUS_H\n+\n+#include <cstdint>\n+#include <limits>\n+\n+/** xoroshiro128++ PRNG. Extremely fast, not appropriate for cryptographic purposes.\n+ *\n+ * Memory footprint is 128bit, period is 2^128 - 1.\n+ * This class is not thread-safe.\n+ *\n+ * Reference implementation available at https://prng.di.unimi.it/xoroshiro128plusplus.c\n+ * See https://prng.di.unimi.it/\n+ */\n+class XoRoShiRo128PlusPlus\n+{\n+    uint64_t m_s0;\n+    uint64_t m_s1;\n+\n+    [[nodiscard]] constexpr static uint64_t rotl(uint64_t x, int n)\n+    {\n+        return (x << n) | (x >> (64 - n));\n+    }\n+\n+    [[nodiscard]] constexpr static uint64_t SplitMix64(uint64_t& seedval) noexcept\n+    {\n+        uint64_t z = (seedval += UINT64_C(0x9e3779b97f4a7c15));\n+        z = (z ^ (z >> 30U)) * UINT64_C(0xbf58476d1ce4e5b9);\n+        z = (z ^ (z >> 27U)) * UINT64_C(0x94d049bb133111eb);\n+        return z ^ (z >> 31U);\n+    }\n+\n+public:\n+    using result_type = uint64_t;\n+\n+    constexpr explicit XoRoShiRo128PlusPlus(uint64_t seedval) noexcept\n+        : m_s0(SplitMix64(seedval)), m_s1(SplitMix64(seedval))\n+    {\n+    }\n+\n+    // no copy - that is dangerous, we don't want accidentally copy the RNG and then have two streams\n+    // with exactly the same results. If you need a copy, call copy().\n+    XoRoShiRo128PlusPlus(const XoRoShiRo128PlusPlus&) = delete;\n+    XoRoShiRo128PlusPlus& operator=(const XoRoShiRo128PlusPlus&) = delete;\n+\n+    // allow moves\n+    XoRoShiRo128PlusPlus(XoRoShiRo128PlusPlus&&) = default;\n+    XoRoShiRo128PlusPlus& operator=(XoRoShiRo128PlusPlus&&) = default;\n+\n+    ~XoRoShiRo128PlusPlus() = default;\n+\n+    constexpr result_type operator()() noexcept\n+    {\n+        uint64_t s0 = m_s0, s1 = m_s1;\n+        const uint64_t result = rotl(s0 + s1, 17) + s0;\n+        s1 ^= s0;\n+        m_s0 = rotl(s0, 49) ^ s1 ^ (s1 << 21);\n+        m_s1 = rotl(s1, 28);\n+        return result;\n+    }\n+\n+    static constexpr result_type min() noexcept { return std::numeric_limits<uint64_t>::min(); }\n+    static constexpr result_type max() noexcept { return std::numeric_limits<uint64_t>::max(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081861264",
      "id" : 1081861264,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ae-SQ",
      "original_commit_id" : "3e916f17d122306fba8d3fdb39b3553fc431e118",
      "original_line" : 67,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/test/util/xoroshiro128plusplus.h",
      "position" : null,
      "pull_request_review_id" : 1262606323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081861264/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-19T21:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081861264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081934743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081934743"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-19T22:26:02Z",
      "diff_hunk" : "@@ -303,16 +260,65 @@ void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n         WriteLE32(c + 56, x14);\n         WriteLE32(c + 60, x15);\n \n-        if (bytes <= 64) {\n-            if (bytes < 64) {\n-                for (i = 0;i < bytes;++i) ctarget[i] = c[i];\n-            }\n-            input[12] = j12;\n-            input[13] = j13;\n+        if (blocks == 1) {\n+            input[8] = j12;\n+            input[9] = j13;\n             return;\n         }\n-        bytes -= 64;\n+        blocks -= 1;\n         c += 64;\n         m += 64;\n     }\n }\n+\n+void ChaCha20::Keystream(unsigned char* c, size_t bytes)\n+{\n+    if (!bytes) return;\n+    if (m_bufleft) {\n+        unsigned reuse = std::min<size_t>(m_bufleft, bytes);\n+        memcpy(c, m_buffer + 64 - m_bufleft, reuse);\n+        m_bufleft -= reuse;\n+        bytes -= reuse;\n+        c += reuse;\n+    }\n+    if (bytes >= 64) {\n+        size_t blocks = bytes / 64;\n+        m_aligned.Keystream64(c, blocks);\n+        c += blocks * 64;\n+        bytes -= blocks * 64;\n+    }\n+    if (bytes) {\n+        m_aligned.Keystream64(m_buffer, 1);\n+        memcpy(c, m_buffer, bytes);\n+        m_bufleft = 64 - bytes;\n+    }\n+}\n+\n+void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n+{\n+    unsigned reuse = std::min<size_t>(m_bufleft, bytes);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081934743",
      "id" : 1081934743,
      "in_reply_to_id" : 1081854124,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585AfQOX",
      "original_commit_id" : "013c0dd4cce3fd97ceb384c33149085900fa37f4",
      "original_line" : 299,
      "original_position" : 309,
      "original_start_line" : null,
      "path" : "src/crypto/chacha20.cpp",
      "position" : null,
      "pull_request_review_id" : 1262724452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081934743/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-19T22:26:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081934743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081934810"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081934810"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-19T22:26:08Z",
      "diff_hunk" : "@@ -0,0 +1,71 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TEST_UTIL_XOROSHIRO128PLUSPLUS_H\n+#define BITCOIN_TEST_UTIL_XOROSHIRO128PLUSPLUS_H\n+\n+#include <cstdint>\n+#include <limits>\n+\n+/** xoroshiro128++ PRNG. Extremely fast, not appropriate for cryptographic purposes.\n+ *\n+ * Memory footprint is 128bit, period is 2^128 - 1.\n+ * This class is not thread-safe.\n+ *\n+ * Reference implementation available at https://prng.di.unimi.it/xoroshiro128plusplus.c\n+ * See https://prng.di.unimi.it/\n+ */\n+class XoRoShiRo128PlusPlus\n+{\n+    uint64_t m_s0;\n+    uint64_t m_s1;\n+\n+    [[nodiscard]] constexpr static uint64_t rotl(uint64_t x, int n)\n+    {\n+        return (x << n) | (x >> (64 - n));\n+    }\n+\n+    [[nodiscard]] constexpr static uint64_t SplitMix64(uint64_t& seedval) noexcept\n+    {\n+        uint64_t z = (seedval += UINT64_C(0x9e3779b97f4a7c15));\n+        z = (z ^ (z >> 30U)) * UINT64_C(0xbf58476d1ce4e5b9);\n+        z = (z ^ (z >> 27U)) * UINT64_C(0x94d049bb133111eb);\n+        return z ^ (z >> 31U);\n+    }\n+\n+public:\n+    using result_type = uint64_t;\n+\n+    constexpr explicit XoRoShiRo128PlusPlus(uint64_t seedval) noexcept\n+        : m_s0(SplitMix64(seedval)), m_s1(SplitMix64(seedval))\n+    {\n+    }\n+\n+    // no copy - that is dangerous, we don't want accidentally copy the RNG and then have two streams\n+    // with exactly the same results. If you need a copy, call copy().\n+    XoRoShiRo128PlusPlus(const XoRoShiRo128PlusPlus&) = delete;\n+    XoRoShiRo128PlusPlus& operator=(const XoRoShiRo128PlusPlus&) = delete;\n+\n+    // allow moves\n+    XoRoShiRo128PlusPlus(XoRoShiRo128PlusPlus&&) = default;\n+    XoRoShiRo128PlusPlus& operator=(XoRoShiRo128PlusPlus&&) = default;\n+\n+    ~XoRoShiRo128PlusPlus() = default;\n+\n+    constexpr result_type operator()() noexcept\n+    {\n+        uint64_t s0 = m_s0, s1 = m_s1;\n+        const uint64_t result = rotl(s0 + s1, 17) + s0;\n+        s1 ^= s0;\n+        m_s0 = rotl(s0, 49) ^ s1 ^ (s1 << 21);\n+        m_s1 = rotl(s1, 28);\n+        return result;\n+    }\n+\n+    static constexpr result_type min() noexcept { return std::numeric_limits<uint64_t>::min(); }\n+    static constexpr result_type max() noexcept { return std::numeric_limits<uint64_t>::max(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1081934810",
      "id" : 1081934810,
      "in_reply_to_id" : 1081861264,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585AfQPa",
      "original_commit_id" : "3e916f17d122306fba8d3fdb39b3553fc431e118",
      "original_line" : 67,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/test/util/xoroshiro128plusplus.h",
      "position" : null,
      "pull_request_review_id" : 1262724562,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081934810/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-19T22:26:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1081934810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-19T23:37:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1397746270",
      "id" : 1397746270,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585TT-pe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1397746270/reactions"
      },
      "updated_at" : "2023-01-19T23:37:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1397746270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dhruv @real-or-random @jonasnick might be interested in reviewing here?",
      "created_at" : "2023-01-20T10:41:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1398204817",
      "id" : 1398204817,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585TVumR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1398204817/reactions"
      },
      "updated_at" : "2023-01-20T10:41:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1398204817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tACK that the usage of partial `ChaCha20` blocks doesn't advance the block counter anymore when using the unaligned version: The evidence is that the downstream BIP324 PRs #25361, #23233 and #24545, based on this PR have passing test vectors.\r\n\r\n@fanquake I can review this in the coming days too, but I don't know anything about MuHash3072 and xoroshiro128++ yet so it'll take some time. I'll do the partial review first.\r\n",
      "created_at" : "2023-01-20T16:47:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1398654724",
      "id" : 1398654724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585TXccE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1398654724/reactions"
      },
      "updated_at" : "2023-01-20T16:54:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1398654724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084390492"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084390492"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would it be valuable to `inline` the unaligned variant functions too?",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-23T18:13:57Z",
      "diff_hunk" : "@@ -303,16 +283,48 @@ void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n         WriteLE32(c + 56, x14);\n         WriteLE32(c + 60, x15);\n \n-        if (bytes <= 64) {\n-            if (bytes < 64) {\n-                for (i = 0;i < bytes;++i) ctarget[i] = c[i];\n-            }\n+        if (blocks == 1) {\n             input[12] = j12;\n             input[13] = j13;\n             return;\n         }\n-        bytes -= 64;\n+        blocks -= 1;\n         c += 64;\n         m += 64;\n     }\n }\n+\n+void ChaCha20::Keystream(unsigned char* c, size_t bytes)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084390492",
      "id" : 1084390492,
      "line" : 274,
      "node_id" : "PRRC_kwDOABII585Aonxc",
      "original_commit_id" : "b56981e246f5a658bc799cbe24e6c1580729b9e4",
      "original_line" : 297,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/crypto/chacha20.cpp",
      "position" : 140,
      "pull_request_review_id" : 1266098319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084390492/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-23T22:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084390492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084441769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084441769"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm a little confused by what `~(total_bytes >> 6)` is trying to do here. I understand the converting bytes to blocks, but then what's the bitwise not for? Wouldn't it result in [seeking way past](https://godbolt.org/z/ze79ss7ao) the total_bytes? \r\n\r\nThe test of course still works since the seeking is consistent across both instances. I just don't understand the intent yet.",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-23T19:07:58Z",
      "diff_hunk" : "@@ -43,3 +44,109 @@ FUZZ_TARGET(crypto_chacha20)\n             });\n     }\n }\n+\n+namespace\n+{\n+\n+/** Fuzzer that invokes ChaCha20::Crypt() or ChaCha20::Keystream multiple times:\n+    once for a large block at once, and then the same data in chunks, comparing\n+    the outcome.\n+\n+    If UseCrypt, seeded Xoroshiro128++ output is used as input to Crypt().\n+    If not, Keystream() is used directly, or sequences of 0x00 are encrypted.\n+*/\n+template<bool UseCrypt>\n+void ChaCha20SplitFuzz(FuzzedDataProvider& provider)\n+{\n+    // Determine key, iv, start position, length.\n+    unsigned char key[32] = {0};\n+    auto key_bytes = provider.ConsumeBytes<unsigned char>(32);\n+    std::copy(key_bytes.begin(), key_bytes.end(), key);\n+    uint64_t iv = provider.ConsumeIntegral<uint64_t>();\n+    uint64_t total_bytes = provider.ConsumeIntegralInRange<uint64_t>(0, 1000000);\n+    uint64_t seek = provider.ConsumeIntegralInRange<uint64_t>(0, ~(total_bytes >> 6));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084441769",
      "id" : 1084441769,
      "line" : 67,
      "node_id" : "PRRC_kwDOABII585Ao0Sp",
      "original_commit_id" : "167a829147e18fa1e3f7e1e0856ebdfa052dd186",
      "original_line" : 67,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/test/fuzz/crypto_chacha20.cpp",
      "position" : 32,
      "pull_request_review_id" : 1266098319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084441769/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-23T22:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084441769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084487295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084487295"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can we eliminate the `out` variable now by using `hexout.size() / 2` instead of `out.size()`?",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-23T19:58:51Z",
      "diff_hunk" : "@@ -149,7 +149,7 @@ static void TestChaCha20(const std::string &hex_message, const std::string &hexk\n     } else {\n         rng.Keystream(outres.data(), outres.size());\n     }\n-    BOOST_CHECK(out == outres);\n+    BOOST_CHECK_EQUAL(hexout, HexStr(outres));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084487295",
      "id" : 1084487295,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII585Ao_Z_",
      "original_commit_id" : "376c9284eef9e269fd40e03d4f1ada9478703ac9",
      "original_line" : 152,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/crypto_tests.cpp",
      "position" : 5,
      "pull_request_review_id" : 1266098319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084487295/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-23T22:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084487295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084506816"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084506816"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Out of curiosity, since every loop re-seeks to `seek`, why do we repeat this 10 times? Is that primarily for different chunks?\r\n\r\nSeparately, is non-determinism acceptable in unit tests? Is there a way to reproduce failures?",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-23T20:22:06Z",
      "diff_hunk" : "@@ -161,6 +161,27 @@ static void TestChaCha20(const std::string &hex_message, const std::string &hexk\n         }\n         BOOST_CHECK_EQUAL(hexout, HexStr(outres));\n     }\n+\n+    // Repeat 10x, but fragmented into 3 chunks, to exercise the ChaCha20 class's caching.\n+    for (int i = 0; i < 10; ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084506816",
      "id" : 1084506816,
      "line" : 166,
      "node_id" : "PRRC_kwDOABII585ApELA",
      "original_commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "original_line" : 166,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/crypto_tests.cpp",
      "position" : 6,
      "pull_request_review_id" : 1266098319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084506816/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-23T22:26:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084506816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084605430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084605430"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        if (is_last || bytes2 == total_bytes) break;\r\n```",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-23T21:53:54Z",
      "diff_hunk" : "@@ -43,3 +44,109 @@ FUZZ_TARGET(crypto_chacha20)\n             });\n     }\n }\n+\n+namespace\n+{\n+\n+/** Fuzzer that invokes ChaCha20::Crypt() or ChaCha20::Keystream multiple times:\n+    once for a large block at once, and then the same data in chunks, comparing\n+    the outcome.\n+\n+    If UseCrypt, seeded Xoroshiro128++ output is used as input to Crypt().\n+    If not, Keystream() is used directly, or sequences of 0x00 are encrypted.\n+*/\n+template<bool UseCrypt>\n+void ChaCha20SplitFuzz(FuzzedDataProvider& provider)\n+{\n+    // Determine key, iv, start position, length.\n+    unsigned char key[32] = {0};\n+    auto key_bytes = provider.ConsumeBytes<unsigned char>(32);\n+    std::copy(key_bytes.begin(), key_bytes.end(), key);\n+    uint64_t iv = provider.ConsumeIntegral<uint64_t>();\n+    uint64_t total_bytes = provider.ConsumeIntegralInRange<uint64_t>(0, 1000000);\n+    uint64_t seek = provider.ConsumeIntegralInRange<uint64_t>(0, ~(total_bytes >> 6));\n+\n+    // Initialize two ChaCha20 ciphers, with the same key/iv/position.\n+    ChaCha20 crypt1(key, 32);\n+    ChaCha20 crypt2(key, 32);\n+    crypt1.SetIV(iv);\n+    crypt1.Seek64(seek);\n+    crypt2.SetIV(iv);\n+    crypt2.Seek64(seek);\n+\n+    // Construct vectors with data.\n+    std::vector<unsigned char> data1, data2;\n+    data1.resize(total_bytes);\n+    data2.resize(total_bytes);\n+\n+    // If using Crypt(), initialize data1 and data2 with the same Xoroshiro128++ based\n+    // stream.\n+    if constexpr (UseCrypt) {\n+        uint64_t seed = provider.ConsumeIntegral<uint64_t>();\n+        XoRoShiRo128PlusPlus rng(seed);\n+        uint64_t bytes = 0;\n+        while (bytes < (total_bytes & ~uint64_t{7})) {\n+            uint64_t val = rng();\n+            WriteLE64(data1.data() + bytes, val);\n+            WriteLE64(data2.data() + bytes, val);\n+            bytes += 8;\n+        }\n+        if (bytes < total_bytes) {\n+            unsigned char valbytes[8];\n+            uint64_t val = rng();\n+            WriteLE64(valbytes, val);\n+            std::copy(valbytes, valbytes + (total_bytes - bytes), data1.data() + bytes);\n+            std::copy(valbytes, valbytes + (total_bytes - bytes), data2.data() + bytes);\n+        }\n+    }\n+\n+    // Whether UseCrypt is used or not, the two byte arrays must match.\n+    assert(data1 == data2);\n+\n+    // Encrypt data1, the whole array at once.\n+    if constexpr (UseCrypt) {\n+        crypt1.Crypt(data1.data(), data1.data(), total_bytes);\n+    } else {\n+        crypt1.Keystream(data1.data(), total_bytes);\n+    }\n+\n+    // Encrypt data2, in at most 256 chunks.\n+    uint64_t bytes2 = 0;\n+    int iter = 0;\n+    while (true) {\n+        bool is_last = (iter == 255) || provider.ConsumeBool();\n+        ++iter;\n+        // Determine how many bytes to encrypt in this chunk: a fuzzer-determined\n+        // amount for all but the last chunk (which processes all remaining bytes).\n+        uint64_t now = is_last ? total_bytes - bytes2 :\n+            provider.ConsumeIntegralInRange<uint64_t>(0, total_bytes - bytes2);\n+        // For each chunk, consider using Crypt() even when UseCrypt is false.\n+        // This tests that Keystream() has the same behavior as Crypt() applied\n+        // to 0x00 input bytes.\n+        if (UseCrypt || provider.ConsumeBool()) {\n+            crypt2.Crypt(data2.data() + bytes2, data2.data() + bytes2, now);\n+        } else {\n+            crypt2.Keystream(data2.data() + bytes2, now);\n+        }\n+        bytes2 += now;\n+        if (is_last) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084605430",
      "id" : 1084605430,
      "line" : 132,
      "node_id" : "PRRC_kwDOABII585ApcP2",
      "original_commit_id" : "167a829147e18fa1e3f7e1e0856ebdfa052dd186",
      "original_line" : 132,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/test/fuzz/crypto_chacha20.cpp",
      "position" : 97,
      "pull_request_review_id" : 1266098319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084605430/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-23T22:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084605430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084607184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084607184"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If it's useful to test with 0 bytes as a parameter, maybe `bool is_last = (iter == 255) || (bytes2 == total_bytes) || provider.ConsumeBool();` above?",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-23T21:55:32Z",
      "diff_hunk" : "@@ -43,3 +44,109 @@ FUZZ_TARGET(crypto_chacha20)\n             });\n     }\n }\n+\n+namespace\n+{\n+\n+/** Fuzzer that invokes ChaCha20::Crypt() or ChaCha20::Keystream multiple times:\n+    once for a large block at once, and then the same data in chunks, comparing\n+    the outcome.\n+\n+    If UseCrypt, seeded Xoroshiro128++ output is used as input to Crypt().\n+    If not, Keystream() is used directly, or sequences of 0x00 are encrypted.\n+*/\n+template<bool UseCrypt>\n+void ChaCha20SplitFuzz(FuzzedDataProvider& provider)\n+{\n+    // Determine key, iv, start position, length.\n+    unsigned char key[32] = {0};\n+    auto key_bytes = provider.ConsumeBytes<unsigned char>(32);\n+    std::copy(key_bytes.begin(), key_bytes.end(), key);\n+    uint64_t iv = provider.ConsumeIntegral<uint64_t>();\n+    uint64_t total_bytes = provider.ConsumeIntegralInRange<uint64_t>(0, 1000000);\n+    uint64_t seek = provider.ConsumeIntegralInRange<uint64_t>(0, ~(total_bytes >> 6));\n+\n+    // Initialize two ChaCha20 ciphers, with the same key/iv/position.\n+    ChaCha20 crypt1(key, 32);\n+    ChaCha20 crypt2(key, 32);\n+    crypt1.SetIV(iv);\n+    crypt1.Seek64(seek);\n+    crypt2.SetIV(iv);\n+    crypt2.Seek64(seek);\n+\n+    // Construct vectors with data.\n+    std::vector<unsigned char> data1, data2;\n+    data1.resize(total_bytes);\n+    data2.resize(total_bytes);\n+\n+    // If using Crypt(), initialize data1 and data2 with the same Xoroshiro128++ based\n+    // stream.\n+    if constexpr (UseCrypt) {\n+        uint64_t seed = provider.ConsumeIntegral<uint64_t>();\n+        XoRoShiRo128PlusPlus rng(seed);\n+        uint64_t bytes = 0;\n+        while (bytes < (total_bytes & ~uint64_t{7})) {\n+            uint64_t val = rng();\n+            WriteLE64(data1.data() + bytes, val);\n+            WriteLE64(data2.data() + bytes, val);\n+            bytes += 8;\n+        }\n+        if (bytes < total_bytes) {\n+            unsigned char valbytes[8];\n+            uint64_t val = rng();\n+            WriteLE64(valbytes, val);\n+            std::copy(valbytes, valbytes + (total_bytes - bytes), data1.data() + bytes);\n+            std::copy(valbytes, valbytes + (total_bytes - bytes), data2.data() + bytes);\n+        }\n+    }\n+\n+    // Whether UseCrypt is used or not, the two byte arrays must match.\n+    assert(data1 == data2);\n+\n+    // Encrypt data1, the whole array at once.\n+    if constexpr (UseCrypt) {\n+        crypt1.Crypt(data1.data(), data1.data(), total_bytes);\n+    } else {\n+        crypt1.Keystream(data1.data(), total_bytes);\n+    }\n+\n+    // Encrypt data2, in at most 256 chunks.\n+    uint64_t bytes2 = 0;\n+    int iter = 0;\n+    while (true) {\n+        bool is_last = (iter == 255) || provider.ConsumeBool();\n+        ++iter;\n+        // Determine how many bytes to encrypt in this chunk: a fuzzer-determined\n+        // amount for all but the last chunk (which processes all remaining bytes).\n+        uint64_t now = is_last ? total_bytes - bytes2 :\n+            provider.ConsumeIntegralInRange<uint64_t>(0, total_bytes - bytes2);\n+        // For each chunk, consider using Crypt() even when UseCrypt is false.\n+        // This tests that Keystream() has the same behavior as Crypt() applied\n+        // to 0x00 input bytes.\n+        if (UseCrypt || provider.ConsumeBool()) {\n+            crypt2.Crypt(data2.data() + bytes2, data2.data() + bytes2, now);\n+        } else {\n+            crypt2.Keystream(data2.data() + bytes2, now);\n+        }\n+        bytes2 += now;\n+        if (is_last) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084607184",
      "id" : 1084607184,
      "in_reply_to_id" : 1084605430,
      "line" : 132,
      "node_id" : "PRRC_kwDOABII585ApcrQ",
      "original_commit_id" : "167a829147e18fa1e3f7e1e0856ebdfa052dd186",
      "original_line" : 132,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/test/fuzz/crypto_chacha20.cpp",
      "position" : 97,
      "pull_request_review_id" : 1266098319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084607184/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-23T22:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084607184",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084823390"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084823390"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, I just got it. That term + the number of blocks for total_bytes will equal 2^64-1 so it is indeed the max seek position.\n\nA comment might help future readers.",
      "commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "created_at" : "2023-01-24T05:18:05Z",
      "diff_hunk" : "@@ -43,3 +44,109 @@ FUZZ_TARGET(crypto_chacha20)\n             });\n     }\n }\n+\n+namespace\n+{\n+\n+/** Fuzzer that invokes ChaCha20::Crypt() or ChaCha20::Keystream multiple times:\n+    once for a large block at once, and then the same data in chunks, comparing\n+    the outcome.\n+\n+    If UseCrypt, seeded Xoroshiro128++ output is used as input to Crypt().\n+    If not, Keystream() is used directly, or sequences of 0x00 are encrypted.\n+*/\n+template<bool UseCrypt>\n+void ChaCha20SplitFuzz(FuzzedDataProvider& provider)\n+{\n+    // Determine key, iv, start position, length.\n+    unsigned char key[32] = {0};\n+    auto key_bytes = provider.ConsumeBytes<unsigned char>(32);\n+    std::copy(key_bytes.begin(), key_bytes.end(), key);\n+    uint64_t iv = provider.ConsumeIntegral<uint64_t>();\n+    uint64_t total_bytes = provider.ConsumeIntegralInRange<uint64_t>(0, 1000000);\n+    uint64_t seek = provider.ConsumeIntegralInRange<uint64_t>(0, ~(total_bytes >> 6));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1084823390",
      "id" : 1084823390,
      "in_reply_to_id" : 1084441769,
      "line" : 67,
      "node_id" : "PRRC_kwDOABII585AqRde",
      "original_commit_id" : "167a829147e18fa1e3f7e1e0856ebdfa052dd186",
      "original_line" : 67,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/test/fuzz/crypto_chacha20.cpp",
      "position" : 32,
      "pull_request_review_id" : 1266790258,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084823390/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-24T05:19:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084823390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @dhruv @real-or-random @jonasnick might be interested in reviewing here?\r\n\r\nI can review it, but I'll probably find time only in February. (I don't know if it makes sense to wait for me or not.)  ",
      "created_at" : "2023-01-24T11:11:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1401753823",
      "id" : 1401753823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585TjRDf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1401753823/reactions"
      },
      "updated_at" : "2023-01-24T11:11:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1401753823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1071625?v=4",
         "events_url" : "https://api.github.com/users/real-or-random/events{/privacy}",
         "followers_url" : "https://api.github.com/users/real-or-random/followers",
         "following_url" : "https://api.github.com/users/real-or-random/following{/other_user}",
         "gists_url" : "https://api.github.com/users/real-or-random/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/real-or-random",
         "id" : 1071625,
         "login" : "real-or-random",
         "node_id" : "MDQ6VXNlcjEwNzE2MjU=",
         "organizations_url" : "https://api.github.com/users/real-or-random/orgs",
         "received_events_url" : "https://api.github.com/users/real-or-random/received_events",
         "repos_url" : "https://api.github.com/users/real-or-random/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/real-or-random/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/real-or-random"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1091005799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091005799"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, they're never called within this compilation unit, so there shouldn't be any place they even can be inlined?",
      "commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-01-30T18:38:56Z",
      "diff_hunk" : "@@ -303,16 +283,48 @@ void ChaCha20::Crypt(const unsigned char* m, unsigned char* c, size_t bytes)\n         WriteLE32(c + 56, x14);\n         WriteLE32(c + 60, x15);\n \n-        if (bytes <= 64) {\n-            if (bytes < 64) {\n-                for (i = 0;i < bytes;++i) ctarget[i] = c[i];\n-            }\n+        if (blocks == 1) {\n             input[12] = j12;\n             input[13] = j13;\n             return;\n         }\n-        bytes -= 64;\n+        blocks -= 1;\n         c += 64;\n         m += 64;\n     }\n }\n+\n+void ChaCha20::Keystream(unsigned char* c, size_t bytes)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1091005799",
      "id" : 1091005799,
      "in_reply_to_id" : 1084390492,
      "line" : 274,
      "node_id" : "PRRC_kwDOABII585BB21n",
      "original_commit_id" : "b56981e246f5a658bc799cbe24e6c1580729b9e4",
      "original_line" : 274,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/crypto/chacha20.cpp",
      "position" : 284,
      "pull_request_review_id" : 1275731196,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091005799/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-30T18:38:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091005799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1091029294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091029294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I added a comment.",
      "commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-01-30T19:01:19Z",
      "diff_hunk" : "@@ -43,3 +44,109 @@ FUZZ_TARGET(crypto_chacha20)\n             });\n     }\n }\n+\n+namespace\n+{\n+\n+/** Fuzzer that invokes ChaCha20::Crypt() or ChaCha20::Keystream multiple times:\n+    once for a large block at once, and then the same data in chunks, comparing\n+    the outcome.\n+\n+    If UseCrypt, seeded Xoroshiro128++ output is used as input to Crypt().\n+    If not, Keystream() is used directly, or sequences of 0x00 are encrypted.\n+*/\n+template<bool UseCrypt>\n+void ChaCha20SplitFuzz(FuzzedDataProvider& provider)\n+{\n+    // Determine key, iv, start position, length.\n+    unsigned char key[32] = {0};\n+    auto key_bytes = provider.ConsumeBytes<unsigned char>(32);\n+    std::copy(key_bytes.begin(), key_bytes.end(), key);\n+    uint64_t iv = provider.ConsumeIntegral<uint64_t>();\n+    uint64_t total_bytes = provider.ConsumeIntegralInRange<uint64_t>(0, 1000000);\n+    uint64_t seek = provider.ConsumeIntegralInRange<uint64_t>(0, ~(total_bytes >> 6));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1091029294",
      "id" : 1091029294,
      "in_reply_to_id" : 1084441769,
      "line" : 68,
      "node_id" : "PRRC_kwDOABII585BB8ku",
      "original_commit_id" : "167a829147e18fa1e3f7e1e0856ebdfa052dd186",
      "original_line" : 68,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/test/fuzz/crypto_chacha20.cpp",
      "position" : 60,
      "pull_request_review_id" : 1275778972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091029294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-30T19:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091029294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1091030226"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091030226"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Out of curiosity, since every loop re-seeks to seek, why do we repeat this 10 times? Is that primarily for different chunks?\r\n\r\nJust because it's very easy to do, and may result in more interesting cases being hit.\r\n\r\n> Separately, is non-determinism acceptable in unit tests? Is there a way to reproduce failures?\r\n\r\nThe unit tests' RNG is initialized deterministically, so there shouldn't be any non-determinism.",
      "commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-01-30T19:02:22Z",
      "diff_hunk" : "@@ -161,6 +161,27 @@ static void TestChaCha20(const std::string &hex_message, const std::string &hexk\n         }\n         BOOST_CHECK_EQUAL(hexout, HexStr(outres));\n     }\n+\n+    // Repeat 10x, but fragmented into 3 chunks, to exercise the ChaCha20 class's caching.\n+    for (int i = 0; i < 10; ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1091030226",
      "id" : 1091030226,
      "in_reply_to_id" : 1084506816,
      "line" : 165,
      "node_id" : "PRRC_kwDOABII585BB8zS",
      "original_commit_id" : "aca35e568239e02673e23f38c0fad58fc4911fd4",
      "original_line" : 165,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/crypto_tests.cpp",
      "position" : 41,
      "pull_request_review_id" : 1275781451,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091030226/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-30T19:02:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091030226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1091030373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091030373"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've added that last suggestion.",
      "commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-01-30T19:02:34Z",
      "diff_hunk" : "@@ -43,3 +44,109 @@ FUZZ_TARGET(crypto_chacha20)\n             });\n     }\n }\n+\n+namespace\n+{\n+\n+/** Fuzzer that invokes ChaCha20::Crypt() or ChaCha20::Keystream multiple times:\n+    once for a large block at once, and then the same data in chunks, comparing\n+    the outcome.\n+\n+    If UseCrypt, seeded Xoroshiro128++ output is used as input to Crypt().\n+    If not, Keystream() is used directly, or sequences of 0x00 are encrypted.\n+*/\n+template<bool UseCrypt>\n+void ChaCha20SplitFuzz(FuzzedDataProvider& provider)\n+{\n+    // Determine key, iv, start position, length.\n+    unsigned char key[32] = {0};\n+    auto key_bytes = provider.ConsumeBytes<unsigned char>(32);\n+    std::copy(key_bytes.begin(), key_bytes.end(), key);\n+    uint64_t iv = provider.ConsumeIntegral<uint64_t>();\n+    uint64_t total_bytes = provider.ConsumeIntegralInRange<uint64_t>(0, 1000000);\n+    uint64_t seek = provider.ConsumeIntegralInRange<uint64_t>(0, ~(total_bytes >> 6));\n+\n+    // Initialize two ChaCha20 ciphers, with the same key/iv/position.\n+    ChaCha20 crypt1(key, 32);\n+    ChaCha20 crypt2(key, 32);\n+    crypt1.SetIV(iv);\n+    crypt1.Seek64(seek);\n+    crypt2.SetIV(iv);\n+    crypt2.Seek64(seek);\n+\n+    // Construct vectors with data.\n+    std::vector<unsigned char> data1, data2;\n+    data1.resize(total_bytes);\n+    data2.resize(total_bytes);\n+\n+    // If using Crypt(), initialize data1 and data2 with the same Xoroshiro128++ based\n+    // stream.\n+    if constexpr (UseCrypt) {\n+        uint64_t seed = provider.ConsumeIntegral<uint64_t>();\n+        XoRoShiRo128PlusPlus rng(seed);\n+        uint64_t bytes = 0;\n+        while (bytes < (total_bytes & ~uint64_t{7})) {\n+            uint64_t val = rng();\n+            WriteLE64(data1.data() + bytes, val);\n+            WriteLE64(data2.data() + bytes, val);\n+            bytes += 8;\n+        }\n+        if (bytes < total_bytes) {\n+            unsigned char valbytes[8];\n+            uint64_t val = rng();\n+            WriteLE64(valbytes, val);\n+            std::copy(valbytes, valbytes + (total_bytes - bytes), data1.data() + bytes);\n+            std::copy(valbytes, valbytes + (total_bytes - bytes), data2.data() + bytes);\n+        }\n+    }\n+\n+    // Whether UseCrypt is used or not, the two byte arrays must match.\n+    assert(data1 == data2);\n+\n+    // Encrypt data1, the whole array at once.\n+    if constexpr (UseCrypt) {\n+        crypt1.Crypt(data1.data(), data1.data(), total_bytes);\n+    } else {\n+        crypt1.Keystream(data1.data(), total_bytes);\n+    }\n+\n+    // Encrypt data2, in at most 256 chunks.\n+    uint64_t bytes2 = 0;\n+    int iter = 0;\n+    while (true) {\n+        bool is_last = (iter == 255) || provider.ConsumeBool();\n+        ++iter;\n+        // Determine how many bytes to encrypt in this chunk: a fuzzer-determined\n+        // amount for all but the last chunk (which processes all remaining bytes).\n+        uint64_t now = is_last ? total_bytes - bytes2 :\n+            provider.ConsumeIntegralInRange<uint64_t>(0, total_bytes - bytes2);\n+        // For each chunk, consider using Crypt() even when UseCrypt is false.\n+        // This tests that Keystream() has the same behavior as Crypt() applied\n+        // to 0x00 input bytes.\n+        if (UseCrypt || provider.ConsumeBool()) {\n+            crypt2.Crypt(data2.data() + bytes2, data2.data() + bytes2, now);\n+        } else {\n+            crypt2.Keystream(data2.data() + bytes2, now);\n+        }\n+        bytes2 += now;\n+        if (is_last) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1091030373",
      "id" : 1091030373,
      "in_reply_to_id" : 1084605430,
      "line" : 133,
      "node_id" : "PRRC_kwDOABII585BB81l",
      "original_commit_id" : "167a829147e18fa1e3f7e1e0856ebdfa052dd186",
      "original_line" : 133,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/test/fuzz/crypto_chacha20.cpp",
      "position" : 125,
      "pull_request_review_id" : 1275781893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091030373/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-30T19:02:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1091030373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ut reACK 511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-02-07T03:34:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1420150318",
      "id" : 1420150318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585UpcYu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1420150318/reactions"
      },
      "updated_at" : "2023-02-07T03:34:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1420150318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tACK crACK 511aa4f1c7\r\n\r\nReviewed `git range-diff ceb74b844c aca35e5 511aa4f1c7`\r\nDownstream BIP324 branches include 511aa4f1c7 with green CI\r\n",
      "created_at" : "2023-02-07T18:21:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1421250665",
      "id" : 1421250665,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585UtpBp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1421250665/reactions"
      },
      "updated_at" : "2023-02-07T18:22:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1421250665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Going to move this forward. @real-or-random would still be great for you to leave any post-merge commentary, if you get the time.",
      "created_at" : "2023-02-15T14:59:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1431505288",
      "id" : 1431505288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585VUwmI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1431505288/reactions"
      },
      "updated_at" : "2023-02-15T14:59:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1431505288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129293131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129293131"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion \r\n    static_assert(Num3072::BYTE_SIZE % 64 == 0);\r\n    ChaCha20Aligned(hashed_in.data(), hashed_in.size()).Keystream64(tmp, Num3072::BYTE_SIZE / 64);\r\n\r\n```",
      "commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-03-08T11:32:31Z",
      "diff_hunk" : "@@ -299,7 +299,7 @@ Num3072 MuHash3072::ToNum3072(Span<const unsigned char> in) {\n     unsigned char tmp[Num3072::BYTE_SIZE];\n \n     uint256 hashed_in{(HashWriter{} << in).GetSHA256()};\n-    ChaCha20(hashed_in.data(), hashed_in.size()).Keystream(tmp, Num3072::BYTE_SIZE);\n+    ChaCha20Aligned(hashed_in.data(), hashed_in.size()).Keystream64(tmp, Num3072::BYTE_SIZE / 64);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129293131",
      "id" : 1129293131,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585DT6VL",
      "original_commit_id" : "f21994a02e1cc46d41995581b54222abc655be93",
      "original_line" : 302,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/crypto/muhash.cpp",
      "position" : 5,
      "pull_request_review_id" : 1330494666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129293131/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-08T12:02:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129293131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1071625?v=4",
         "events_url" : "https://api.github.com/users/real-or-random/events{/privacy}",
         "followers_url" : "https://api.github.com/users/real-or-random/followers",
         "following_url" : "https://api.github.com/users/real-or-random/following{/other_user}",
         "gists_url" : "https://api.github.com/users/real-or-random/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/real-or-random",
         "id" : 1071625,
         "login" : "real-or-random",
         "node_id" : "MDQ6VXNlcjEwNzE2MjU=",
         "organizations_url" : "https://api.github.com/users/real-or-random/orgs",
         "received_events_url" : "https://api.github.com/users/real-or-random/received_events",
         "repos_url" : "https://api.github.com/users/real-or-random/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/real-or-random/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/real-or-random"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129311426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129311426"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(not this PR)\r\n\r\nShould `SetIV()` also set `m_bufleft = 0`? If the caller sets an IV without seeking, and we have bytes left in the buffer, then the caller will get those remaining bytes which belong to the wrong buffer.\r\n\r\nI mean, setting an IV without seeking is probably not a good idea anyway, and none of the callers currently do this. But I feel that's something that then should be excluded by the interface of the class, i.e., `SetIV()` and `SetKey()` should ideally seek to 0 (and perhaps be renamed to something line `SetIvAndSeek0` or `SetIvAndReset`.",
      "commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-03-08T11:51:51Z",
      "diff_hunk" : "@@ -54,13 +56,21 @@ class ChaCha20\n     ChaCha20(const unsigned char* key, size_t keylen) : m_aligned(key, keylen) {}\n \n     /** set key with flexible keylength (16 or 32 bytes; 32 recommended). */\n-    void SetKey(const unsigned char* key, size_t keylen) { m_aligned.SetKey(key, keylen); }\n+    void SetKey(const unsigned char* key, size_t keylen)\n+    {\n+        m_aligned.SetKey(key, keylen);\n+        m_bufleft = 0;\n+    }\n \n     /** set the 64-bit nonce. */\n     void SetIV(uint64_t iv) { m_aligned.SetIV(iv); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129311426",
      "id" : 1129311426,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII585DT-zC",
      "original_commit_id" : "12ff72476ac0dbf8add736ad3fb5fad2eeab156c",
      "original_line" : 66,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/crypto/chacha20.h",
      "position" : 27,
      "pull_request_review_id" : 1330494666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129311426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-08T12:02:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129311426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1071625?v=4",
         "events_url" : "https://api.github.com/users/real-or-random/events{/privacy}",
         "followers_url" : "https://api.github.com/users/real-or-random/followers",
         "following_url" : "https://api.github.com/users/real-or-random/following{/other_user}",
         "gists_url" : "https://api.github.com/users/real-or-random/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/real-or-random",
         "id" : 1071625,
         "login" : "real-or-random",
         "node_id" : "MDQ6VXNlcjEwNzE2MjU=",
         "organizations_url" : "https://api.github.com/users/real-or-random/orgs",
         "received_events_url" : "https://api.github.com/users/real-or-random/received_events",
         "repos_url" : "https://api.github.com/users/real-or-random/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/real-or-random/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/real-or-random"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129313162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129313162"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(not this PR)\r\n\r\nBut I think initializing with an effective zero key should not be allowed by the interface of the class.",
      "commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-03-08T11:53:26Z",
      "diff_hunk" : "@@ -20,95 +21,69 @@ constexpr static inline uint32_t rotl32(uint32_t v, int c) { return (v << c) | (\n \n #define REPEAT10(a) do { {a}; {a}; {a}; {a}; {a}; {a}; {a}; {a}; {a}; {a}; } while(0)\n \n-static const unsigned char sigma[] = \"expand 32-byte k\";\n-static const unsigned char tau[] = \"expand 16-byte k\";\n-\n-void ChaCha20::SetKey(const unsigned char* k, size_t keylen)\n+void ChaCha20Aligned::SetKey32(const unsigned char* k)\n {\n-    const unsigned char *constants;\n-\n-    input[4] = ReadLE32(k + 0);\n-    input[5] = ReadLE32(k + 4);\n-    input[6] = ReadLE32(k + 8);\n-    input[7] = ReadLE32(k + 12);\n-    if (keylen == 32) { /* recommended */\n-        k += 16;\n-        constants = sigma;\n-    } else { /* keylen == 16 */\n-        constants = tau;\n-    }\n-    input[8] = ReadLE32(k + 0);\n-    input[9] = ReadLE32(k + 4);\n-    input[10] = ReadLE32(k + 8);\n-    input[11] = ReadLE32(k + 12);\n-    input[0] = ReadLE32(constants + 0);\n-    input[1] = ReadLE32(constants + 4);\n-    input[2] = ReadLE32(constants + 8);\n-    input[3] = ReadLE32(constants + 12);\n-    input[12] = 0;\n-    input[13] = 0;\n-    input[14] = 0;\n-    input[15] = 0;\n+    input[0] = ReadLE32(k + 0);\n+    input[1] = ReadLE32(k + 4);\n+    input[2] = ReadLE32(k + 8);\n+    input[3] = ReadLE32(k + 12);\n+    input[4] = ReadLE32(k + 16);\n+    input[5] = ReadLE32(k + 20);\n+    input[6] = ReadLE32(k + 24);\n+    input[7] = ReadLE32(k + 28);\n+    input[8] = 0;\n+    input[9] = 0;\n+    input[10] = 0;\n+    input[11] = 0;\n }\n \n-ChaCha20::ChaCha20()\n+ChaCha20Aligned::ChaCha20Aligned()\n {\n     memset(input, 0, sizeof(input));\n }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129313162",
      "id" : 1129313162,
      "line" : 43,
      "node_id" : "PRRC_kwDOABII585DT_OK",
      "original_commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "original_line" : 43,
      "original_position" : 60,
      "original_start_line" : 40,
      "path" : "src/crypto/chacha20.cpp",
      "position" : 60,
      "pull_request_review_id" : 1330494666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129313162/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 40,
      "start_side" : "RIGHT",
      "updated_at" : "2023-03-08T12:02:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129313162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1071625?v=4",
         "events_url" : "https://api.github.com/users/real-or-random/events{/privacy}",
         "followers_url" : "https://api.github.com/users/real-or-random/followers",
         "following_url" : "https://api.github.com/users/real-or-random/following{/other_user}",
         "gists_url" : "https://api.github.com/users/real-or-random/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/real-or-random",
         "id" : 1071625,
         "login" : "real-or-random",
         "node_id" : "MDQ6VXNlcjEwNzE2MjU=",
         "organizations_url" : "https://api.github.com/users/real-or-random/orgs",
         "received_events_url" : "https://api.github.com/users/real-or-random/received_events",
         "repos_url" : "https://api.github.com/users/real-or-random/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/real-or-random/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/real-or-random"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129318294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129318294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since this is a rekeying operation, consider `memory_cleanse`ing the cache buffer. (It will probably be overwritten soon anyway. but `SetKey()` should not happen frequently, so we don't need to worry about performance.)\r\n\r\nI guess there should also be destructor that does the same. And (not this PR), a destructor of ChaCha20Aligned should `memory_cleanse` the key.",
      "commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-03-08T11:57:57Z",
      "diff_hunk" : "@@ -8,19 +8,69 @@\n #include <cstdlib>\n #include <stdint.h>\n \n-/** A class for ChaCha20 256-bit stream cipher developed by Daniel J. Bernstein\n-    https://cr.yp.to/chacha/chacha-20080128.pdf */\n+// classes for ChaCha20 256-bit stream cipher developed by Daniel J. Bernstein\n+// https://cr.yp.to/chacha/chacha-20080128.pdf */\n+\n+/** ChaCha20 cipher that only operates on multiples of 64 bytes. */\n+class ChaCha20Aligned\n+{\n+private:\n+    uint32_t input[12];\n+\n+public:\n+    ChaCha20Aligned();\n+\n+    /** Initialize a cipher with specified 32-byte key. */\n+    ChaCha20Aligned(const unsigned char* key32);\n+\n+    /** set 32-byte key. */\n+    void SetKey32(const unsigned char* key32);\n+\n+    /** set the 64-bit nonce. */\n+    void SetIV(uint64_t iv);\n+\n+    /** set the 64bit block counter (pos seeks to byte position 64*pos). */\n+    void Seek64(uint64_t pos);\n+\n+    /** outputs the keystream of size <64*blocks> into <c> */\n+    void Keystream64(unsigned char* c, size_t blocks);\n+\n+    /** enciphers the message <input> of length <64*blocks> and write the enciphered representation into <output>\n+     *  Used for encryption and decryption (XOR)\n+     */\n+    void Crypt64(const unsigned char* input, unsigned char* output, size_t blocks);\n+};\n+\n+/** Unrestricted ChaCha20 cipher. */\n class ChaCha20\n {\n private:\n-    uint32_t input[16];\n+    ChaCha20Aligned m_aligned;\n+    unsigned char m_buffer[64] = {0};\n+    unsigned m_bufleft{0};\n \n public:\n-    ChaCha20();\n-    ChaCha20(const unsigned char* key, size_t keylen);\n-    void SetKey(const unsigned char* key, size_t keylen); //!< set key with flexible keylength; 256bit recommended */\n-    void SetIV(uint64_t iv); // set the 64bit nonce\n-    void Seek(uint64_t pos); // set the 64bit block counter\n+    ChaCha20() = default;\n+\n+    /** Initialize a cipher with specified 32-byte key. */\n+    ChaCha20(const unsigned char* key32) : m_aligned(key32) {}\n+\n+    /** set 32-byte key. */\n+    void SetKey32(const unsigned char* key32)\n+    {\n+        m_aligned.SetKey32(key32);\n+        m_bufleft = 0;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129318294",
      "id" : 1129318294,
      "line" : 63,
      "node_id" : "PRRC_kwDOABII585DUAeW",
      "original_commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "original_line" : 63,
      "original_position" : 64,
      "original_start_line" : 58,
      "path" : "src/crypto/chacha20.h",
      "position" : 64,
      "pull_request_review_id" : 1330494666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129318294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 58,
      "start_side" : "RIGHT",
      "updated_at" : "2023-03-08T12:02:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129318294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1071625?v=4",
         "events_url" : "https://api.github.com/users/real-or-random/events{/privacy}",
         "followers_url" : "https://api.github.com/users/real-or-random/followers",
         "following_url" : "https://api.github.com/users/real-or-random/following{/other_user}",
         "gists_url" : "https://api.github.com/users/real-or-random/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/real-or-random",
         "id" : 1071625,
         "login" : "real-or-random",
         "node_id" : "MDQ6VXNlcjEwNzE2MjU=",
         "organizations_url" : "https://api.github.com/users/real-or-random/orgs",
         "received_events_url" : "https://api.github.com/users/real-or-random/received_events",
         "repos_url" : "https://api.github.com/users/real-or-random/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/real-or-random/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/real-or-random"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129322207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129322207"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(not this PR)\r\n\r\nnit: I'd prefer an interface that distinguishes between encryption and decryption. That makes the code easier to change if it will be reused for other ciphers.  ",
      "commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "created_at" : "2023-03-08T12:01:29Z",
      "diff_hunk" : "@@ -8,19 +8,69 @@\n #include <cstdlib>\n #include <stdint.h>\n \n-/** A class for ChaCha20 256-bit stream cipher developed by Daniel J. Bernstein\n-    https://cr.yp.to/chacha/chacha-20080128.pdf */\n+// classes for ChaCha20 256-bit stream cipher developed by Daniel J. Bernstein\n+// https://cr.yp.to/chacha/chacha-20080128.pdf */\n+\n+/** ChaCha20 cipher that only operates on multiples of 64 bytes. */\n+class ChaCha20Aligned\n+{\n+private:\n+    uint32_t input[12];\n+\n+public:\n+    ChaCha20Aligned();\n+\n+    /** Initialize a cipher with specified 32-byte key. */\n+    ChaCha20Aligned(const unsigned char* key32);\n+\n+    /** set 32-byte key. */\n+    void SetKey32(const unsigned char* key32);\n+\n+    /** set the 64-bit nonce. */\n+    void SetIV(uint64_t iv);\n+\n+    /** set the 64bit block counter (pos seeks to byte position 64*pos). */\n+    void Seek64(uint64_t pos);\n+\n+    /** outputs the keystream of size <64*blocks> into <c> */\n+    void Keystream64(unsigned char* c, size_t blocks);\n+\n+    /** enciphers the message <input> of length <64*blocks> and write the enciphered representation into <output>\n+     *  Used for encryption and decryption (XOR)\n+     */\n+    void Crypt64(const unsigned char* input, unsigned char* output, size_t blocks);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#discussion_r1129322207",
      "id" : 1129322207,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII585DUBbf",
      "original_commit_id" : "511aa4f1c7508f15cab8d7e58007900ad6fd3d5d",
      "original_line" : 41,
      "original_position" : 36,
      "original_start_line" : 38,
      "path" : "src/crypto/chacha20.h",
      "position" : 36,
      "pull_request_review_id" : 1330494666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26153",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129322207/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 38,
      "start_side" : "RIGHT",
      "updated_at" : "2023-03-08T12:02:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129322207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1071625?v=4",
         "events_url" : "https://api.github.com/users/real-or-random/events{/privacy}",
         "followers_url" : "https://api.github.com/users/real-or-random/followers",
         "following_url" : "https://api.github.com/users/real-or-random/following{/other_user}",
         "gists_url" : "https://api.github.com/users/real-or-random/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/real-or-random",
         "id" : 1071625,
         "login" : "real-or-random",
         "node_id" : "MDQ6VXNlcjEwNzE2MjU=",
         "organizations_url" : "https://api.github.com/users/real-or-random/orgs",
         "received_events_url" : "https://api.github.com/users/real-or-random/received_events",
         "repos_url" : "https://api.github.com/users/real-or-random/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/real-or-random/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/real-or-random"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@real-or-random thanks for circling around to this post-merge.",
      "created_at" : "2023-03-08T12:04:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26153#issuecomment-1460055753",
      "id" : 1460055753,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26153",
      "node_id" : "IC_kwDOABII585XBq7J",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1460055753/reactions"
      },
      "updated_at" : "2023-03-08T12:04:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1460055753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
