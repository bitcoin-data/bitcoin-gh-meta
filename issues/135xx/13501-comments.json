[
   {
      "author_association" : "MEMBER",
      "body" : "This is an alternative to #13492 that doesn't require bumping the minimum libevent2 version. This was submitted in a different branch to keep the other version available.\r\n\r\nTo test apply\r\n```diff\r\ndiff --git a/src/rpc/server.cpp b/src/rpc/server.cpp\r\nindex 10040b125..57dad383c 100644\r\n--- a/src/rpc/server.cpp\r\n+++ b/src/rpc/server.cpp\r\n@@ -236,6 +236,7 @@ UniValue stop(const JSONRPCRequest& jsonRequest)\r\n     // Event loop will exit after current HTTP requests have been handled, so\r\n     // this reply will get back to the client.\r\n     StartShutdown();\r\n+    MilliSleep(2000);\r\n     return \"Bitcoin server stopping\";\r\n }\r\n```\r\nand then\r\n```sh\r\nbitcoind -regtest\r\nbitcoin-cli -regtest stop\r\n```\r\n",
      "created_at" : "2018-06-18T22:51:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-398219913",
      "id" : 398219913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5ODIxOTkxMw==",
      "updated_at" : "2018-06-18T22:51:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/398219913",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "That `event_base_loopexit` is still requied though.",
      "created_at" : "2018-06-18T23:47:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-398229862",
      "id" : 398229862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5ODIyOTg2Mg==",
      "updated_at" : "2018-06-18T23:47:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/398229862",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "No, it shouldn't be. As soon as there are no more active or pending events, the event loop should exit.",
      "created_at" : "2018-06-19T07:35:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-398303872",
      "id" : 398303872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5ODMwMzg3Mg==",
      "updated_at" : "2018-06-19T07:35:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/398303872",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated.",
      "created_at" : "2018-06-19T15:16:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-398436748",
      "id" : 398436748,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5ODQzNjc0OA==",
      "updated_at" : "2018-06-19T15:16:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/398436748",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->Note to reviewers: This pull request conflicts with the following ones:\n\n* #13211 (Use a semaphore or pipe for shutdown notification (skeees, laanwj) by laanwj)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2018-06-19T22:37:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-398568221",
      "id" : 398568221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5ODU2ODIyMQ==",
      "updated_at" : "2018-06-19T22:37:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/398568221",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ken2812221 care to review?",
      "created_at" : "2018-06-21T13:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-399101259",
      "id" : 399101259,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5OTEwMTI1OQ==",
      "updated_at" : "2018-06-21T13:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/399101259",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like shutdown would take more time, it takes 30 mins to complete tests on travis, I would rather reopen #13485",
      "created_at" : "2018-06-21T14:46:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-399129905",
      "id" : 399129905,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5OTEyOTkwNQ==",
      "updated_at" : "2018-06-21T14:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/399129905",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ken2812221 I'll try to reproduce.",
      "created_at" : "2018-06-23T20:37:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-399709249",
      "id" : 399709249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5OTcwOTI0OQ==",
      "updated_at" : "2018-06-23T20:37:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/399709249",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Going to close and reopen, to get a fresh travis run.\r\n\r\nPrevious run: https://travis-ci.org/bitcoin/bitcoin/builds/394134101",
      "created_at" : "2018-08-08T21:52:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-411564473",
      "id" : 411564473,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMTU2NDQ3Mw==",
      "updated_at" : "2018-08-08T21:52:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/411564473",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "New run: https://travis-ci.org/bitcoin/bitcoin/builds/413803664\r\n\r\nHmm.. Still takes longer than on master, I think",
      "created_at" : "2018-08-08T21:53:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-411564576",
      "id" : 411564576,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMTU2NDU3Ng==",
      "updated_at" : "2018-08-08T22:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/411564576",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @MarcoFalke.",
      "created_at" : "2018-08-08T21:59:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-411566191",
      "id" : 411566191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMTU2NjE5MQ==",
      "updated_at" : "2018-08-08T21:59:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/411566191",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2018-08-09T05:05:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-411637804",
      "id" : 411637804,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMTYzNzgwNA==",
      "updated_at" : "2018-11-02T15:40:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/411637804",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Tried to change client and server timeouts and looks like it terminates earlier. This indicates that either the client or server are not terminating gracefully.",
      "created_at" : "2018-08-12T00:51:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-412310934",
      "id" : 412310934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMjMxMDkzNA==",
      "updated_at" : "2018-08-12T00:51:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/412310934",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke @ken2812221 please test again. Will update OP later.",
      "created_at" : "2018-08-17T00:36:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-413723962",
      "id" : 413723962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMzcyMzk2Mg==",
      "updated_at" : "2018-08-17T00:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/413723962",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated OP.",
      "created_at" : "2018-08-17T01:48:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-413733665",
      "id" : 413733665,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMzczMzY2NQ==",
      "updated_at" : "2018-08-17T01:48:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/413733665",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It still shows \"EOF reached\" on bitcoin-cli when I add `MilliSleep(1000)` at https://github.com/bitcoin/bitcoin/blob/3c8d1ae15352d5c92d5903536c8fe07f771e97a0/src/rpc/server.cpp#L238-L239",
      "created_at" : "2018-08-17T02:20:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-413738236",
      "id" : 413738236,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMzczODIzNg==",
      "updated_at" : "2018-08-17T02:20:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/413738236",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ken2812221 sorry, forgot to add a hunk to the commit Ã°ÂÂÂ",
      "created_at" : "2018-08-17T08:44:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-413799521",
      "id" : 413799521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxMzc5OTUyMQ==",
      "updated_at" : "2018-08-17T08:44:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/413799521",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "~Tested ACK d1c35ed~",
      "created_at" : "2018-08-21T01:01:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-414514730",
      "id" : 414514730,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxNDUxNDczMA==",
      "updated_at" : "2018-08-25T09:17:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/414514730",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r211557678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/211557678"
         }
      },
      "author_association" : "MEMBER",
      "body" : "wouldn't there be unprotected concurrent acceess to `g_http_connections` from multiple threads here? (the HTTP event thread as well as the thread in which `StopHTTPServer` is called)\r\nif so, it needs a mutex",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-08-21T10:37:31Z",
      "diff_hunk" : "@@ -464,21 +476,23 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    // Disable reading on current connections\n+    for (evhttp_connection* conn : g_http_connections) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r211557678",
      "id" : 211557678,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMTU1NzY3OA==",
      "original_commit_id" : "d1c35eda9931c901161b95e9710e650ecb316027",
      "original_position" : 48,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 148000297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/211557678",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r211568890"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/211568890"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I thought the callback would be called from the event loop thread, but looks like it's not the case. Pushed a commit that adds a mutex.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-08-21T11:24:44Z",
      "diff_hunk" : "@@ -464,21 +476,23 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    // Disable reading on current connections\n+    for (evhttp_connection* conn : g_http_connections) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r211568890",
      "id" : 211568890,
      "in_reply_to_id" : 211557678,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMTU2ODg5MA==",
      "original_commit_id" : "d1c35eda9931c901161b95e9710e650ecb316027",
      "original_position" : 48,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 148014230,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/211568890",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Seems that `bitcoind` would hang during shutdown progress on Windows sometimes.\r\n\r\n#14007 :            \r\n      https://ci.appveyor.com/project/DrahtBot/bitcoin/build/master.243\r\n\r\n#14007 + #13501 :\r\n https://ci.appveyor.com/project/ken2812221/bitcoin/build/test-promag-http-shutdown.275",
      "created_at" : "2018-08-25T10:08:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-415958551",
      "id" : 415958551,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxNTk1ODU1MQ==",
      "updated_at" : "2018-08-25T10:08:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415958551",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@promag I would prefer this fix than #13485, but this seems to break things on Windows. Would you mind take a look again?",
      "created_at" : "2018-10-02T22:06:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-426446620",
      "id" : 426446620,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjQ0NjYyMA==",
      "updated_at" : "2018-10-02T22:10:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426446620",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ken2812221 try again Ã°ÂÂÂ",
      "created_at" : "2018-10-04T23:11:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-427198221",
      "id" : 427198221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNzE5ODIyMQ==",
      "updated_at" : "2018-10-04T23:11:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/427198221",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "tACK ee05f25eb600d8dc45d21f43dab899aacc7d6784",
      "created_at" : "2018-10-05T16:47:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-427428837",
      "id" : 427428837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNzQyODgzNw==",
      "updated_at" : "2018-10-05T16:47:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/427428837",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r223100273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/223100273"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `static std::unordered_set<evhttp_connection*> g_http_connections GUARDED_BY(g_http_connections_cs);`",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-10-05T18:26:50Z",
      "diff_hunk" : "@@ -144,6 +144,9 @@ struct evhttp* eventHTTP = nullptr;\n static std::vector<CSubNet> rpc_allow_subnets;\n //! Work queue for handling longer requests off the event loop thread\n static WorkQueue<HTTPClosure>* workQueue = nullptr;\n+//! Set of current HTTP connections\n+static std::set<evhttp_connection*> g_http_connections;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r223100273",
      "id" : 223100273,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyMzEwMDI3Mw==",
      "original_commit_id" : "ee05f25eb600d8dc45d21f43dab899aacc7d6784",
      "original_position" : 5,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 162153651,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/223100273",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r223101635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/223101635"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: use `Mutex` and `LOCK` for easier debugging.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-10-05T18:31:47Z",
      "diff_hunk" : "@@ -144,6 +144,9 @@ struct evhttp* eventHTTP = nullptr;\n static std::vector<CSubNet> rpc_allow_subnets;\n //! Work queue for handling longer requests off the event loop thread\n static WorkQueue<HTTPClosure>* workQueue = nullptr;\n+//! Set of current HTTP connections\n+static std::set<evhttp_connection*> g_http_connections;\n+static std::mutex g_http_connections_cs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r223101635",
      "id" : 223101635,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyMzEwMTYzNQ==",
      "original_commit_id" : "ee05f25eb600d8dc45d21f43dab899aacc7d6784",
      "original_position" : 6,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 162153651,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/223101635",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK f9d60febdc265824d5f183ef6e0756875869ddb0.\r\n\r\nI'm not familiar enough with libevent to judge the API calls, but the Bitcoin Core side of things looks good.\r\n\r\nA review by @laanwj would be good, I think.",
      "created_at" : "2018-10-19T05:35:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-431249981",
      "id" : 431249981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMTI0OTk4MQ==",
      "updated_at" : "2018-10-19T05:35:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/431249981",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r227871328"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/227871328"
         }
      },
      "author_association" : "MEMBER",
      "body" : "unordered_set? there's no traversing here",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-10-24T16:45:48Z",
      "diff_hunk" : "@@ -14,6 +14,7 @@\n #include <ui_interface.h>\n \n #include <memory>\n+#include <set>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r227871328",
      "id" : 227871328,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyNzg3MTMyOA==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 4,
      "path" : "src/httpserver.cpp",
      "position" : 4,
      "pull_request_review_id" : 168010770,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/227871328",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r227955228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/227955228"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIRC for small collections std::set is preferable. I can change if that sounds better to you.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-10-24T20:50:59Z",
      "diff_hunk" : "@@ -14,6 +14,7 @@\n #include <ui_interface.h>\n \n #include <memory>\n+#include <set>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r227955228",
      "id" : 227955228,
      "in_reply_to_id" : 227871328,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyNzk1NTIyOA==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 4,
      "path" : "src/httpserver.cpp",
      "position" : 4,
      "pull_request_review_id" : 168113835,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/227955228",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230144852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230144852"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The changes in this ` if (eventBase)` section don't seem directly related to the other changes in this PR. If I understand the eventlib documentation correctly, the behavior of the new code is identical to previous code except there is no longer a 2 second timeout.\r\n\r\nSo is the point of this change just cleanup? It seems like it might be safer to keep the 2 second timeout.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T18:16:42Z",
      "diff_hunk" : "@@ -457,21 +475,21 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    {\n+        LogPrint(BCLog::HTTP, \"Disabling reading on current connections\\n\");\n+        LOCK(g_http_connections_cs);\n+        for (evhttp_connection* conn : g_http_connections) {\n+            bufferevent* bev = evhttp_connection_get_bufferevent(conn);\n+            if (bev) bufferevent_disable(bev, EV_READ);\n+        }\n+        g_http_connections.clear();\n+    }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Exit the event loop as soon as there are no active events.\n-        event_base_loopexit(eventBase, nullptr);\n-        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n-        // Before this was solved with event_base_loopexit, but that didn't work as expected in\n-        // at least libevent 2.0.21 and always introduced a delay. In libevent\n-        // master that appears to be solved, so in the future that solution\n-        // could be used again (if desirable).\n-        // (see discussion in https://github.com/bitcoin/bitcoin/pull/6990)\n-        if (threadResult.valid() && threadResult.wait_for(std::chrono::milliseconds(2000)) == std::future_status::timeout) {\n-            LogPrintf(\"HTTP event loop did not exit within allotted time, sending loopbreak\\n\");\n-            event_base_loopbreak(eventBase);\n-        }\n+        event_base_loopbreak(eventBase);\n         threadHTTP.join();\n+        // Process remaining events.\n+        event_base_dispatch(eventBase);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230144852",
      "id" : 230144852,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDE0NDg1Mg==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 82,
      "path" : "src/httpserver.cpp",
      "position" : 88,
      "pull_request_review_id" : 170815456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230144852",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230146388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230146388"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is checking `bev` just defensive here? Would it ever be expected to be null? It'd be good to have a sentence or shorter comment here to suggest what this does.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T18:21:09Z",
      "diff_hunk" : "@@ -457,21 +475,21 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    {\n+        LogPrint(BCLog::HTTP, \"Disabling reading on current connections\\n\");\n+        LOCK(g_http_connections_cs);\n+        for (evhttp_connection* conn : g_http_connections) {\n+            bufferevent* bev = evhttp_connection_get_bufferevent(conn);\n+            if (bev) bufferevent_disable(bev, EV_READ);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230146388",
      "id" : 230146388,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDE0NjM4OA==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 61,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 170815456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230146388",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230146825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230146825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Confused by the check. Would this ever be false? Short comment here would be helpful.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T18:22:36Z",
      "diff_hunk" : "@@ -209,9 +213,24 @@ static std::string RequestMethodString(HTTPRequest::RequestMethod m)\n     }\n }\n \n+/** HTTP connection close callback */\n+static void http_connection_close_cb(struct evhttp_connection* conn, void* /* arg */)\n+{\n+    LOCK(g_http_connections_cs);\n+    g_http_connections.erase(conn);\n+}\n+\n /** HTTP request callback */\n-static void http_request_cb(struct evhttp_request* req, void* arg)\n+static void http_request_cb(struct evhttp_request* req, void* /* arg */)\n {\n+    {\n+        LOCK(g_http_connections_cs);\n+        evhttp_connection* conn = evhttp_request_get_connection(req);\n+        if (g_http_connections.insert(conn).second) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230146825",
      "id" : 230146825,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDE0NjgyNQ==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 36,
      "path" : "src/httpserver.cpp",
      "position" : 39,
      "pull_request_review_id" : 170815456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230146825",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230156665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230156665"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe use suffix `_mutex` instead of `_cs`. I think people have generally moved on to calling critical sections mutexes.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T18:51:53Z",
      "diff_hunk" : "@@ -144,6 +145,9 @@ struct evhttp* eventHTTP = nullptr;\n static std::vector<CSubNet> rpc_allow_subnets;\n //! Work queue for handling longer requests off the event loop thread\n static WorkQueue<HTTPClosure>* workQueue = nullptr;\n+//! Set of current HTTP connections\n+static Mutex g_http_connections_cs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230156665",
      "id" : 230156665,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDE1NjY2NQ==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 13,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 170815456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230156665",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230159746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230159746"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you add a comment about what the effect of disabling reading on the current connections is?\r\n\r\nIf this just disables reading and doesn't close the connections or interrupt pending writes, it seems like shutdown code could potentially get stuck forever (if a client isn't reading and there is a pending write and data is backed up).",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T19:01:00Z",
      "diff_hunk" : "@@ -457,21 +475,21 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    {\n+        LogPrint(BCLog::HTTP, \"Disabling reading on current connections\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230159746",
      "id" : 230159746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDE1OTc0Ng==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 57,
      "path" : "src/httpserver.cpp",
      "position" : 60,
      "pull_request_review_id" : 170815456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230159746",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230162376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230162376"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Comment above \"Re-enable reading...\" is out of date, or at least incomplete now, and would be good to update.\r\n\r\nI think I need to look more into the workaround here, but it's not clear to me why this no longer enables write events during shutdown (or what the effect of that is). Hopefully it doesn't mean that a pending writes would never complete...\r\n\r\n",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T19:09:48Z",
      "diff_hunk" : "@@ -586,11 +604,10 @@ void HTTPRequest::WriteReply(int nStatus, const std::string& strReply)\n         // workaround above.\n         if (event_get_version_number() >= 0x02010600 && event_get_version_number() < 0x02020001) {\n             evhttp_connection* conn = evhttp_request_get_connection(req_copy);\n-            if (conn) {\n+            LOCK(g_http_connections_cs);\n+            if (conn && g_http_connections.count(conn)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230162376",
      "id" : 230162376,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDE2MjM3Ng==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 92,
      "path" : "src/httpserver.cpp",
      "position" : 98,
      "pull_request_review_id" : 170815456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230162376",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2018-11-01T19:37:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-435160352",
      "id" : 435160352,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNTE2MDM1Mg==",
      "updated_at" : "2018-11-01T19:37:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/435160352",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230224871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230224871"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So the event base quits when there are no active or pending events. Writing the response is an active event which will go away at the end. Reading can be a pending event (for instance, the client sends stop RPC but keeps the connection open Ã¢ÂÂ which happens in the functional tests) so that will prevent the base to quit automatically.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T22:49:50Z",
      "diff_hunk" : "@@ -457,21 +475,21 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    {\n+        LogPrint(BCLog::HTTP, \"Disabling reading on current connections\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230224871",
      "id" : 230224871,
      "in_reply_to_id" : 230159746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDIyNDg3MQ==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 57,
      "path" : "src/httpserver.cpp",
      "position" : 60,
      "pull_request_review_id" : 170915633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230224871",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230225032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230225032"
         }
      },
      "author_association" : "MEMBER",
      "body" : "One connection can carry multiple request/response pairs.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T22:50:40Z",
      "diff_hunk" : "@@ -209,9 +213,24 @@ static std::string RequestMethodString(HTTPRequest::RequestMethod m)\n     }\n }\n \n+/** HTTP connection close callback */\n+static void http_connection_close_cb(struct evhttp_connection* conn, void* /* arg */)\n+{\n+    LOCK(g_http_connections_cs);\n+    g_http_connections.erase(conn);\n+}\n+\n /** HTTP request callback */\n-static void http_request_cb(struct evhttp_request* req, void* arg)\n+static void http_request_cb(struct evhttp_request* req, void* /* arg */)\n {\n+    {\n+        LOCK(g_http_connections_cs);\n+        evhttp_connection* conn = evhttp_request_get_connection(req);\n+        if (g_http_connections.insert(conn).second) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230225032",
      "id" : 230225032,
      "in_reply_to_id" : 230146825,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDIyNTAzMg==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 36,
      "path" : "src/httpserver.cpp",
      "position" : 39,
      "pull_request_review_id" : 170915845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230225032",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230225067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230225067"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T22:50:51Z",
      "diff_hunk" : "@@ -144,6 +145,9 @@ struct evhttp* eventHTTP = nullptr;\n static std::vector<CSubNet> rpc_allow_subnets;\n //! Work queue for handling longer requests off the event loop thread\n static WorkQueue<HTTPClosure>* workQueue = nullptr;\n+//! Set of current HTTP connections\n+static Mutex g_http_connections_cs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230225067",
      "id" : 230225067,
      "in_reply_to_id" : 230156665,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDIyNTA2Nw==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 13,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 170915889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230225067",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230225944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230225944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No I don't think it can be null, but I'll check libevent code. This \"protection\" is already on master and I followed it.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T22:54:37Z",
      "diff_hunk" : "@@ -457,21 +475,21 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    {\n+        LogPrint(BCLog::HTTP, \"Disabling reading on current connections\\n\");\n+        LOCK(g_http_connections_cs);\n+        for (evhttp_connection* conn : g_http_connections) {\n+            bufferevent* bev = evhttp_connection_get_bufferevent(conn);\n+            if (bev) bufferevent_disable(bev, EV_READ);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230225944",
      "id" : 230225944,
      "in_reply_to_id" : 230146388,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDIyNTk0NA==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 61,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 170916753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230225944",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230227604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230227604"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is necessary in order to have a clean event loop quit, which means all active events processed and there's no pending events. In some cases (long response/slow client) the timeout can cause errors on the client side because the client receives an unexpected connection close.\r\n\r\nIdeally it would be enough:\r\n```cpp\r\n// Wait the event loop to quit\r\nthreadHTTP.join();\r\n```\r\nbut in windows only this works (sorry I don't know why):\r\n```cpp\r\n// Wait the event loop to quit in *this* thread\r\nevent_base_loopbreak(eventBase);\r\nthreadHTTP.join();\r\n// Process remaining events.\r\nevent_base_dispatch(eventBase);\r\n```",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T23:02:59Z",
      "diff_hunk" : "@@ -457,21 +475,21 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    {\n+        LogPrint(BCLog::HTTP, \"Disabling reading on current connections\\n\");\n+        LOCK(g_http_connections_cs);\n+        for (evhttp_connection* conn : g_http_connections) {\n+            bufferevent* bev = evhttp_connection_get_bufferevent(conn);\n+            if (bev) bufferevent_disable(bev, EV_READ);\n+        }\n+        g_http_connections.clear();\n+    }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Exit the event loop as soon as there are no active events.\n-        event_base_loopexit(eventBase, nullptr);\n-        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n-        // Before this was solved with event_base_loopexit, but that didn't work as expected in\n-        // at least libevent 2.0.21 and always introduced a delay. In libevent\n-        // master that appears to be solved, so in the future that solution\n-        // could be used again (if desirable).\n-        // (see discussion in https://github.com/bitcoin/bitcoin/pull/6990)\n-        if (threadResult.valid() && threadResult.wait_for(std::chrono::milliseconds(2000)) == std::future_status::timeout) {\n-            LogPrintf(\"HTTP event loop did not exit within allotted time, sending loopbreak\\n\");\n-            event_base_loopbreak(eventBase);\n-        }\n+        event_base_loopbreak(eventBase);\n         threadHTTP.join();\n+        // Process remaining events.\n+        event_base_dispatch(eventBase);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230227604",
      "id" : 230227604,
      "in_reply_to_id" : 230144852,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDIyNzYwNA==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 82,
      "path" : "src/httpserver.cpp",
      "position" : 88,
      "pull_request_review_id" : 170918733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230227604",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230228055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230228055"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Writes are always enabled and there is no reason to enable reading if `g_http_connections.count(conn) == 0`.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-01T23:05:36Z",
      "diff_hunk" : "@@ -586,11 +604,10 @@ void HTTPRequest::WriteReply(int nStatus, const std::string& strReply)\n         // workaround above.\n         if (event_get_version_number() >= 0x02010600 && event_get_version_number() < 0x02020001) {\n             evhttp_connection* conn = evhttp_request_get_connection(req_copy);\n-            if (conn) {\n+            LOCK(g_http_connections_cs);\n+            if (conn && g_http_connections.count(conn)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230228055",
      "id" : 230228055,
      "in_reply_to_id" : 230162376,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDIyODA1NQ==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 92,
      "path" : "src/httpserver.cpp",
      "position" : 98,
      "pull_request_review_id" : 170919322,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-01T23:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230228055",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky thanks for the review.",
      "created_at" : "2018-11-01T23:16:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-435218305",
      "id" : 435218305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNTIxODMwNQ==",
      "updated_at" : "2018-11-01T23:16:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/435218305",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230437781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230437781"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for explaining, but I keep rereading this and coming away confused, because it is leaving out a lot of specifics. I think the following would be clearer if it is accurate:\r\n\r\n```\r\n// Disable read events so the event loop is able to exit even if there are\r\n// open connections. (The preceding InterruptHTTPServer call stops accepting new\r\n// connections and new requests on existing connections, but does not close\r\n// existing connections.)\r\n//\r\n// Leave write events enabled because there may still be response data waiting\r\n// to be written, and we want to avoid sending incomplete responses.\r\n```",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-02T16:41:31Z",
      "diff_hunk" : "@@ -457,21 +475,21 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    {\n+        LogPrint(BCLog::HTTP, \"Disabling reading on current connections\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230437781",
      "id" : 230437781,
      "in_reply_to_id" : 230159746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDQzNzc4MQ==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 57,
      "path" : "src/httpserver.cpp",
      "position" : 60,
      "pull_request_review_id" : 171182902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-02T20:01:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230437781",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230450852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230450852"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Won't this be buggy if a client opens a connection but doesn't send a complete request before the server starts to shut down? In that case this code won't get called, so the connection pointer will never be added to `g_http_connections`, so `event_base_dispatch` would never return, and bitcoind would hang forever on shutdown.\r\n\r\nI don't see a way to be notified directly about new connections, so maybe there is nothing we can do about this, but it seems worth commenting about if there isn't a better approach or workaround.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-02T17:29:33Z",
      "diff_hunk" : "@@ -209,9 +213,24 @@ static std::string RequestMethodString(HTTPRequest::RequestMethod m)\n     }\n }\n \n+/** HTTP connection close callback */\n+static void http_connection_close_cb(struct evhttp_connection* conn, void* /* arg */)\n+{\n+    LOCK(g_http_connections_cs);\n+    g_http_connections.erase(conn);\n+}\n+\n /** HTTP request callback */\n-static void http_request_cb(struct evhttp_request* req, void* arg)\n+static void http_request_cb(struct evhttp_request* req, void* /* arg */)\n {\n+    {\n+        LOCK(g_http_connections_cs);\n+        evhttp_connection* conn = evhttp_request_get_connection(req);\n+        if (g_http_connections.insert(conn).second) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230450852",
      "id" : 230450852,
      "in_reply_to_id" : 230146825,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDQ1MDg1Mg==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 36,
      "path" : "src/httpserver.cpp",
      "position" : 39,
      "pull_request_review_id" : 171182902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-02T20:01:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230450852",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230465536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230465536"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> This is necessary in order to have a clean event loop quit\r\n\r\nIt seems like only the part of this change needed to exit cleanly is removing the racy `event_base_loopexit` added in #11006. Aside from that, it looks like the previous code would also exit cleanly, unless it took longer than 2 seconds.\r\n\r\nIf the 2 second timeout causes problems, maybe it could be increased, but it doesn't seem like seem like a great idea to me to delay shutdown _forever_ writing data to clients. It also seems nicer that the previous code didn't need an inexplicable windows workaround.\r\n\r\nOn the other hand, if we really do want to wait forever here instead of timing out, it would be good to delete the std::future/std::packaged_task code added in 755aa05174e06effd758eeb78c5af9fb465e9611, since now it is sitting there unused.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-02T18:21:03Z",
      "diff_hunk" : "@@ -457,21 +475,21 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    {\n+        LogPrint(BCLog::HTTP, \"Disabling reading on current connections\\n\");\n+        LOCK(g_http_connections_cs);\n+        for (evhttp_connection* conn : g_http_connections) {\n+            bufferevent* bev = evhttp_connection_get_bufferevent(conn);\n+            if (bev) bufferevent_disable(bev, EV_READ);\n+        }\n+        g_http_connections.clear();\n+    }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Exit the event loop as soon as there are no active events.\n-        event_base_loopexit(eventBase, nullptr);\n-        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n-        // Before this was solved with event_base_loopexit, but that didn't work as expected in\n-        // at least libevent 2.0.21 and always introduced a delay. In libevent\n-        // master that appears to be solved, so in the future that solution\n-        // could be used again (if desirable).\n-        // (see discussion in https://github.com/bitcoin/bitcoin/pull/6990)\n-        if (threadResult.valid() && threadResult.wait_for(std::chrono::milliseconds(2000)) == std::future_status::timeout) {\n-            LogPrintf(\"HTTP event loop did not exit within allotted time, sending loopbreak\\n\");\n-            event_base_loopbreak(eventBase);\n-        }\n+        event_base_loopbreak(eventBase);\n         threadHTTP.join();\n+        // Process remaining events.\n+        event_base_dispatch(eventBase);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230465536",
      "id" : 230465536,
      "in_reply_to_id" : 230144852,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDQ2NTUzNg==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 82,
      "path" : "src/httpserver.cpp",
      "position" : 88,
      "pull_request_review_id" : 171182902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-02T20:01:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230465536",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230473291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230473291"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this is the only use of `threadResult`. Can you remove it entirely (currently declared at L437 and assigned at L446)",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-02T18:47:35Z",
      "diff_hunk" : "@@ -457,21 +478,24 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    {\n+        LogPrint(BCLog::HTTP, \"Disabling reading on current connections\\n\");\n+        // Workers completed their job but there can be events to process\n+        // related to their response in the event loop. For now just disable\n+        // reading on each connection, keep writes enabled.\n+        LOCK(g_http_connections_mutex);\n+        for (evhttp_connection* conn : g_http_connections) {\n+            bufferevent* bev = evhttp_connection_get_bufferevent(conn);\n+            bufferevent_disable(bev, EV_READ);\n+        }\n+        g_http_connections.clear();\n+    }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Exit the event loop as soon as there are no active events.\n-        event_base_loopexit(eventBase, nullptr);\n-        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n-        // Before this was solved with event_base_loopexit, but that didn't work as expected in\n-        // at least libevent 2.0.21 and always introduced a delay. In libevent\n-        // master that appears to be solved, so in the future that solution\n-        // could be used again (if desirable).\n-        // (see discussion in https://github.com/bitcoin/bitcoin/pull/6990)\n-        if (threadResult.valid() && threadResult.wait_for(std::chrono::milliseconds(2000)) == std::future_status::timeout) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230473291",
      "id" : 230473291,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDQ3MzI5MQ==",
      "original_commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "original_position" : 81,
      "path" : "src/httpserver.cpp",
      "position" : 81,
      "pull_request_review_id" : 171226984,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-02T19:58:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230473291",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230473752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230473752"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it would be helpful to update \"Re-enable reading\" to \"Re-enable reading (unless g_http_connections has been cleared and the server is shutting down)\", because I think it's hard to see otherwise how `g_http_connections.count` is relevant in this context.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-02T18:49:09Z",
      "diff_hunk" : "@@ -586,11 +604,10 @@ void HTTPRequest::WriteReply(int nStatus, const std::string& strReply)\n         // workaround above.\n         if (event_get_version_number() >= 0x02010600 && event_get_version_number() < 0x02020001) {\n             evhttp_connection* conn = evhttp_request_get_connection(req_copy);\n-            if (conn) {\n+            LOCK(g_http_connections_cs);\n+            if (conn && g_http_connections.count(conn)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230473752",
      "id" : 230473752,
      "in_reply_to_id" : 230162376,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDQ3Mzc1Mg==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 92,
      "path" : "src/httpserver.cpp",
      "position" : 98,
      "pull_request_review_id" : 171182902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-02T20:01:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230473752",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230726803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230726803"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ryanofsky tried the following:\r\n```\r\nbitcoind -regtest\r\nnc localhost 18443\r\nbitcoin-cli -regtest stop\r\n```\r\nat this point the server waits until it timeouts the request (by default 30 seconds).\r\n\r\nIf a request is sent before the timeout the result is:\r\n```\r\nPOST / HTTP/1.1\r\nAuthorization: Basic ...\r\nContent-Type: application/json\r\nContent-Length: 44\r\n\r\n{\"jsonrpc\": \"2.0\",\"method\":\"help\",\"id\":123}\r\nHTTP/1.1 503 Service Unavailable\r\nContent-Type: text/html\r\nConnection: close\r\nDate: Mon, 05 Nov 2018 11:58:34 GMT\r\nContent-Length: 110\r\n\r\n<HTML><HEAD>\r\n<TITLE>503 Service Unavailable</TITLE>\r\n</HEAD><BODY>\r\n<H1>Service Unavailable</H1>\r\n</BODY></HTML>\r\n```\r\nIf we consider that `stop` RPC triggers a graceful shutdown then this LGTM.",
      "commit_id" : "d14515001bb2bf87602af7553def5ebe0f6bcdbb",
      "created_at" : "2018-11-05T12:06:40Z",
      "diff_hunk" : "@@ -209,9 +213,24 @@ static std::string RequestMethodString(HTTPRequest::RequestMethod m)\n     }\n }\n \n+/** HTTP connection close callback */\n+static void http_connection_close_cb(struct evhttp_connection* conn, void* /* arg */)\n+{\n+    LOCK(g_http_connections_cs);\n+    g_http_connections.erase(conn);\n+}\n+\n /** HTTP request callback */\n-static void http_request_cb(struct evhttp_request* req, void* arg)\n+static void http_request_cb(struct evhttp_request* req, void* /* arg */)\n {\n+    {\n+        LOCK(g_http_connections_cs);\n+        evhttp_connection* conn = evhttp_request_get_connection(req);\n+        if (g_http_connections.insert(conn).second) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#discussion_r230726803",
      "id" : 230726803,
      "in_reply_to_id" : 230146825,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIzMDcyNjgwMw==",
      "original_commit_id" : "f9d60febdc265824d5f183ef6e0756875869ddb0",
      "original_position" : 36,
      "path" : "src/httpserver.cpp",
      "position" : 39,
      "pull_request_review_id" : 171525630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13501",
      "updated_at" : "2018-11-05T14:06:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/230726803",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "After more digging in libevent source code I've realized that sending the header `Connection: close` is the correct way to trigger the connection close. Verified that this behavior exists since `2.0.22`, see https://github.com/libevent/libevent/blob/c51b159cff9f5e86696f5b9a4c6f517276056258/http.c#L472.\r\n\r\nIt is also unnecessary to keep track of connections as `evhttp` already handles that.",
      "created_at" : "2018-11-06T15:19:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-436289865",
      "id" : 436289865,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjI4OTg2NQ==",
      "updated_at" : "2018-11-06T15:19:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436289865",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> sending the header Connection: close is the correct way to trigger the connection close\r\n\r\nThat only signals to the client that the connection should be closed (e.g. no connection reuse), it doesn't actually trigger a close from our side.\r\n(or does it? I'm confused now; at the least it doesn't provide a guarantee that the connection will be closed any time soon, only after the request fully finished)",
      "created_at" : "2018-11-06T16:10:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-436309386",
      "id" : 436309386,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjMwOTM4Ng==",
      "updated_at" : "2018-11-06T16:17:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436309386",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "From testing it does, see https://github.com/libevent/libevent/blob/c51b159cff9f5e86696f5b9a4c6f517276056258/http.c#L784-L786.\r\n\r\nEven with a non-http client, like `nc`, when I send that header the server will then close the \r\nconnection.",
      "created_at" : "2018-11-06T16:26:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13501#issuecomment-436315625",
      "id" : 436315625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13501",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjMxNTYyNQ==",
      "updated_at" : "2018-11-06T16:26:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436315625",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
