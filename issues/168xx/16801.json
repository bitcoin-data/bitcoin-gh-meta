{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This is a custom allocator for node based containers, as described in https://github.com/bitcoin/bitcoin/pull/16718#issuecomment-525878177. Hopefully, this is a less controversial change and easier to review than https://github.com/bitcoin/bitcoin/pull/16718.\r\n\r\nThe allocator retains memory of nodes, and allocates them in bulk. In my benchmarks, using this pool allocator for `CCoinsMap` gives about 16% faster `-reindex-chainstate`, and decreases memory usage by ~8%. The allocator is potentially useful for all node-based containers like `std::list`, `std::map`, `std::unordered_map`, etc. I believe this is especially useful on systems where malloc() and free() are relatively expensive operations, since this allocator will dramatically reduce these calls.\r\n\r\nSome noteworthy properties about this allocator:\r\n\r\n* It relies on the fact that node based containers allocate nodes one at a time. If a container doesn't behave like this, the allocator will still work but won't be any faster.\r\n\r\n* The allocator determines the size of the nodes, which will then be used throughout the pool, by the first call to allocate(1). So if the container would not allocate something with the size of a node in its first call to allocate(1), the pool won't be usable for nodes since it was set up with a different size. With C++17 it would be possible to use a containers type `node_type` to correctly initialize the pool's size, but for now we have to rely on this heuristic.\r\n\r\n* Copying / moving / swapping a map propagates the allocator. So if two different pools are used for two containers a and b, calling `a = b` will from now on use b's pool in a.\r\n\r\n* The pool is not threadsafe. Two containers which use the same pool in different threads won't work.\r\n\r\n* A pool's memory is only actually destroyed in the pool's destructor.\r\n\r\nI've added a benchmark to compare std::map, std::unordered_map with and without the pool allocator for the `CCoinsMap`. ",
   "closed_at" : "2019-11-19T07:24:34Z",
   "closed_by" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/14386?v=4",
      "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
      "followers_url" : "https://api.github.com/users/martinus/followers",
      "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
      "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/martinus",
      "id" : 14386,
      "login" : "martinus",
      "node_id" : "MDQ6VXNlcjE0Mzg2",
      "organizations_url" : "https://api.github.com/users/martinus/orgs",
      "received_events_url" : "https://api.github.com/users/martinus/received_events",
      "repos_url" : "https://api.github.com/users/martinus/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/martinus"
   },
   "comments" : 18,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16801/comments",
   "created_at" : "2019-09-04T06:51:53Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16801/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/16801",
   "id" : 488975805,
   "labels" : [
      {
         "color" : "ebd775",
         "default" : false,
         "id" : 64584,
         "name" : "Brainstorming",
         "node_id" : "MDU6TGFiZWw2NDU4NA==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming"
      },
      {
         "color" : "fef2c0",
         "default" : false,
         "id" : 1392286103,
         "name" : "Needs Conceptual Review",
         "node_id" : "MDU6TGFiZWwxMzkyMjg2MTAz",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20Conceptual%20Review"
      },
      {
         "color" : "5319e7",
         "default" : false,
         "id" : 241832923,
         "name" : "Utils/log/libs",
         "node_id" : "MDU6TGFiZWwyNDE4MzI5MjM=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16801/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0MzEzODg2MTY5",
   "number" : 16801,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/16801.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16801",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/16801.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "faster & less memory for sync: bulk pool allocator for node based containers",
   "updated_at" : "2019-11-19T07:24:34Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16801",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/14386?v=4",
      "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
      "followers_url" : "https://api.github.com/users/martinus/followers",
      "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
      "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/martinus",
      "id" : 14386,
      "login" : "martinus",
      "node_id" : "MDQ6VXNlcjE0Mzg2",
      "organizations_url" : "https://api.github.com/users/martinus/orgs",
      "received_events_url" : "https://api.github.com/users/martinus/received_events",
      "repos_url" : "https://api.github.com/users/martinus/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/martinus"
   }
}
