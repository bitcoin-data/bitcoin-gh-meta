[
   {
      "author_association" : "MEMBER",
      "body" : "Tentative Concept ACK: this seems like a low cost way to make eclipse attacks significantly harder to carry out. Nice idea!\r\n\r\nCan we think of any drawbacks beyond the small amount of additional bandwidth?\r\n\r\nWhat would be the pros/cons of keeping the connect-if-tip-is-stale logic unchanged and only adjust the feeler logic so that feelers sync headers?",
      "created_at" : "2019-09-13T13:00:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16859#issuecomment-531227787",
      "id" : 531227787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16859",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMTIyNzc4Nw==",
      "updated_at" : "2019-09-13T13:00:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/531227787",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I would break this into two features:\r\n\r\n**Feature one: syncing block headers from feelers:**\r\nI don't see any drawbacks to this and it makes eclipse attacks more detectable when all your regular connections are eclipsed but your feeler connections are not since your feelers will tell you about blocks which no one else will.\r\n\r\n**Feature two: evicting stale connections and replacing them with feeler connections:**\r\nI can see the advantages of doing this, however I worry that an attacker with mining power will exploit this eviction strategy to slowly take over your outgoing connections by making your existing outgoing connections stale. I'm not sure how possible this attack is in practice as I'm not familiar with the precise definition of what makes something a stale tip.\r\n\r\nMaybe instead of evicting connections if you get a block header that none of your other peers know about download it from that feeler connection?\r\n",
      "created_at" : "2019-09-17T14:50:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16859#issuecomment-532256051",
      "id" : 532256051,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16859",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMjI1NjA1MQ==",
      "updated_at" : "2019-09-17T14:51:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/532256051",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/274814?v=4",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "node_id" : "MDQ6VXNlcjI3NDgxNA==",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK.\r\n\r\nThis is a trivial way to make eclipsing more expensive, and bandwidth overhead is small. \r\n\r\nPerhaps instead of evicting we should try to tell our peers about this new block? What if they are not attacking us but are just eclipsed too.\r\nOr at least send a signal to that node (I know, adding a new p2p message is maybe a big change for this use-case).",
      "created_at" : "2019-09-25T13:52:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16859#issuecomment-535033942",
      "id" : 535033942,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16859",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNTAzMzk0Mg==",
      "updated_at" : "2019-09-25T13:52:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/535033942",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I'm a little confused how this increases eclipse cost -- can't an attacker just fill up the `new` table with \"trash\"? If the connect-if-tip-is-stale logic is removed then this could potentially backfire and never sync headers if the table is filled with garbage?",
      "created_at" : "2019-12-21T05:43:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16859#issuecomment-568154799",
      "id" : 568154799,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16859",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2ODE1NDc5OQ==",
      "updated_at" : "2019-12-21T05:43:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/568154799",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> however I worry that an attacker with mining power will exploit this eviction strategy to slowly take over your outgoing connections\r\n\r\nSo long as the implementation is such that it accepts the block before disconnecting anyone all it would do is let the attacker disconnect essentially one honest peer each of a few nodes per new block they make at the tip, at a considerable cost of their block getting orphaned (unless they can prevent the orphaning with >50% hashpower).\r\n\r\nThis is because as soon as they relay their new block to you, it'll floodfill the honest network (assuming you're connected to it) and that same block won't be usable to cause any other eviction. This depends, however, on actually accepting the block before disconnecting anyone.\r\n\r\nOne simple way to implement that is that eviction could just eliminate outbound peer which least recently sent us a block we accepted (and if none have, the most recently connected).  The block-denying-header-making attack would then do nothing interesting, as the new connection would be the one that got evicted even if we learned a header from it.\r\n\r\nSuhas may have been assuming this because the existing stale tip eviction works that way... if the new stale tip peer didn't help us after all, it'll be the one that gets evicted.\r\n\r\n> I'm not familiar with the precise definition of what makes something a stale tip.\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/11560\r\n",
      "created_at" : "2019-12-21T06:37:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16859#issuecomment-568157475",
      "id" : 568157475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16859",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2ODE1NzQ3NQ==",
      "updated_at" : "2019-12-21T06:37:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/568157475",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm kinda thinking out loud here so I apologize for any important details I might have missed.\r\n\r\nThanks for that link, if I understand the code correctly after 30 minutes if no block has been announced to us our tip becomes stale.\r\n\r\n```cpp\r\nstatic bool TipMayBeStale(const Consensus::Params &consensusParams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\n{\r\n    AssertLockHeld(cs_main);\r\n    if (g_last_tip_update == 0) {\r\n        g_last_tip_update = GetTime();\r\n    }\r\n    return g_last_tip_update < GetTime() - consensusParams.nPowTargetSpacing * 3 && mapBlocksInFlight.empty();\r\n}\r\n```\r\nhttps://github.com/bitcoin/bitcoin/blob/master/src/net_processing.cpp#L570-L577\r\n\r\nMy understanding of the proposed behavior in this issue:\r\n====\r\n\r\nWhen we make a feeler connection to a node A and it has a new block *AND* our tip is stale, we evict one of our outgoing connections and replace the connection with node A. Assuming I didn't bork up the math the probability that no miner finds a block within 30 minutes is: `0.0497 = e^(-(1/600) * 3*600)`. That is, ~5% of the time a block is found it is found after 30 minutes. This should occur multiple times a day.\r\n\r\nAn attack to exploit this proposed behavior without mining power:\r\n====\r\n\r\nAssume an attacker that can get blocks faster than the rest of the p2p network, say by connecting directly to miners and relaying blocks without verifying all the transactions:\r\n\r\n1. Attacker has many nodes in different /16s.\r\n2. Attacker floods new table with attacker IP addresses.\r\n3. Each time a victim node makes a feeler connection to an attacker node *AND* the tip is stale *AND* a new block has just been announced the attacker has a chance to replace an outgoing connection.\r\n\r\nLet's say a node makes a feeler connection and waits 90 seconds for a header reply (not sure what the actual time limit is). The probability that a block is announced in that 90 second period is: `~0.36 = 1- e^(-(1/600) * 3*90)`. Thus, conditioned on a feeler connection being made to an attacker node AND the tip being stale, the probability that a block is announced allowing an attacker to take over an outgoing connection is 36%.\r\n\r\nThis attack doesn't require restarts. A well connected attacker could just perform this attack against the entire network slowly getting more outgoing connections until it manages to fully eclipse a node. Attacker nodes would never be replaced as outgoing connections by non-attacker nodes because attacker nodes would always get the blocks first. \r\n\r\nOne positive factor is that while this many make eclipsing easier, it makes an eclipse position harder to exploit because once an attacker begins using their eclipse position to filter the view of a victim node, then the attacker is in danger of being replaced as an outgoing connection due to stale tips. Unfortunately this doesn't help much with eclipse attacks on lightning network participants because the attacker could give the victim node an unfiltered view of the Bitcoin's blockchain but just not rebroadcast breach remedy transactions.",
      "created_at" : "2019-12-27T15:10:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16859#issuecomment-569288249",
      "id" : 569288249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16859",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2OTI4ODI0OQ==",
      "updated_at" : "2019-12-27T15:10:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/569288249",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/274814?v=4",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "node_id" : "MDQ6VXNlcjI3NDgxNA==",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   }
]
