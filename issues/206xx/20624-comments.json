[
   {
      "author_association" : "MEMBER",
      "body" : "IRC discussion about this PR: http://www.erisian.com.au/bitcoin-core-dev/log-2020-12-11.html#l-196\r\n",
      "created_at" : "2020-12-11T12:33:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20624#issuecomment-743167485",
      "id" : 743167485,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MzE2NzQ4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-11T12:33:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/743167485",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK f636008\r\n\r\nIIUC: we were already checking `fInitialDownload == false` and this PR drops an additional check `pindexNew->nHeight > pnode->nStartingHeight - 2000`. One of the criteria for initial block download is `m_chain.Tip()->GetBlockTime() < (GetTime() - nMaxTipAge`, i.e. the new block is less than 24 hours old. The most likely reason for a new node to be more than 2000 blocks ahead of us, is if we are in IBD, so in that case the check was indeed redundant.\r\n\r\nAnother reason for a node to be 2000 bocks ahead of us is if they know a longer chain. In that case they won't care about our header announcements (which we now start sending it), but won't punish us either afaik.",
      "created_at" : "2020-12-11T15:40:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20624#issuecomment-743267205",
      "id" : 743267205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MzI2NzIwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-11T15:40:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/743267205",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20624#discussion_r541077566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20624"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541077566"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note, if we do have a failing GetTime() and the node is falsely out-of-IBD, it will start to advertise its new best chain in case of reorg. Before this PR, even assuming a IBD bug, chain advertisement won't happen if peers starting heights are far ahead by 2000 blocks from us IIUC ?\r\n\r\nI think that's okay just to be aware of. ",
      "commit_id" : "f6360088de8ca02f9d198da2f8cca4ea8d64c992",
      "created_at" : "2020-12-11T16:39:56Z",
      "diff_hunk" : "@@ -1296,28 +1296,30 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n     m_connman.SetBestHeight(pindexNew->nHeight);\n     SetServiceFlagsIBDCache(!fInitialDownload);\n \n-    // Relay inventory, but don't relay old inventory during initial block download.\n-    if (!fInitialDownload) {\n-        // Find the hashes of all blocks that weren't previously in the best chain.\n-        std::vector<uint256> vHashes;\n-        const CBlockIndex *pindexToAnnounce = pindexNew;\n-        while (pindexToAnnounce != pindexFork) {\n-            vHashes.push_back(pindexToAnnounce->GetBlockHash());\n-            pindexToAnnounce = pindexToAnnounce->pprev;\n-            if (vHashes.size() == MAX_BLOCKS_TO_ANNOUNCE) {\n-                // Limit announcements in case of a huge reorganization.\n-                // Rely on the peer's synchronization mechanism in that case.\n-                break;\n-            }\n+    // Don't relay inventory during initial block download.\n+    if (fInitialDownload) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20624#discussion_r541077566",
      "id" : 541077566,
      "line" : 1300,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA3NzU2Ng==",
      "original_commit_id" : "f6360088de8ca02f9d198da2f8cca4ea8d64c992",
      "original_line" : 1300,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 23,
      "pull_request_review_id" : 550259796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20624",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-11T16:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541077566",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20624#discussion_r541091628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20624"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541091628"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes, that sounds right. And even if we are announcing a less-good chain to a peer, I don't think that's a big problem.",
      "commit_id" : "f6360088de8ca02f9d198da2f8cca4ea8d64c992",
      "created_at" : "2020-12-11T17:00:44Z",
      "diff_hunk" : "@@ -1296,28 +1296,30 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n     m_connman.SetBestHeight(pindexNew->nHeight);\n     SetServiceFlagsIBDCache(!fInitialDownload);\n \n-    // Relay inventory, but don't relay old inventory during initial block download.\n-    if (!fInitialDownload) {\n-        // Find the hashes of all blocks that weren't previously in the best chain.\n-        std::vector<uint256> vHashes;\n-        const CBlockIndex *pindexToAnnounce = pindexNew;\n-        while (pindexToAnnounce != pindexFork) {\n-            vHashes.push_back(pindexToAnnounce->GetBlockHash());\n-            pindexToAnnounce = pindexToAnnounce->pprev;\n-            if (vHashes.size() == MAX_BLOCKS_TO_ANNOUNCE) {\n-                // Limit announcements in case of a huge reorganization.\n-                // Rely on the peer's synchronization mechanism in that case.\n-                break;\n-            }\n+    // Don't relay inventory during initial block download.\n+    if (fInitialDownload) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20624#discussion_r541091628",
      "id" : 541091628,
      "in_reply_to_id" : 541077566,
      "line" : 1300,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MTYyOA==",
      "original_commit_id" : "f6360088de8ca02f9d198da2f8cca4ea8d64c992",
      "original_line" : 1300,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 23,
      "pull_request_review_id" : 550293021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20624",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-11T17:00:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541091628",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2020-12-11T20:43:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20624#issuecomment-743417285",
      "id" : 743417285,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MzQxNzI4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-11T20:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/743417285",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/60179867?v=4",
         "events_url" : "https://api.github.com/users/decryp2kanon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/decryp2kanon/followers",
         "following_url" : "https://api.github.com/users/decryp2kanon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/decryp2kanon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/decryp2kanon",
         "id" : 60179867,
         "login" : "decryp2kanon",
         "node_id" : "MDQ6VXNlcjYwMTc5ODY3",
         "organizations_url" : "https://api.github.com/users/decryp2kanon/orgs",
         "received_events_url" : "https://api.github.com/users/decryp2kanon/received_events",
         "repos_url" : "https://api.github.com/users/decryp2kanon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/decryp2kanon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/decryp2kanon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/decryp2kanon"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Block announcement seems quirky currently. For example, if a node hasn't requested headers announcements, then we'll not announce blocks invs to nodes that have indicated they have the block, but if they have requested headers announcements, then we'll announce headers to them whether they have the block or not! And also, if we have a lot of headers to announce, then we'll revert to announcing via block invs!\r\n\r\nThe behaviour seems to change over the years without any obvious discussion on github as to why. I think ideally we ought not to be sending headers of a block to nodes that have already sent us the same header - seems kinda pointless to me - if the intention is to let them know what our latest block is, then sending them a block inv would use less bandwidth.",
      "created_at" : "2021-05-11T12:12:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20624#issuecomment-838366722",
      "id" : 838366722,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzODM2NjcyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-11T12:12:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/838366722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=4",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "node_id" : "MDQ6VXNlcjE1MzAyODM=",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   }
]
