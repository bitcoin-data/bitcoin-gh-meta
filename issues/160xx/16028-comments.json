[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It'd be useful to see a stack trace where the assert fails. Probably this is due to an assumeLocked() usage, and at this point I think we can pretty easily remove the assumeLocked method, which was supposed to be temporary. The last hard to replace assumeLocked usage was removed in 52b760fc6a9b26e405a0553ee8285b0f03ca1604 in #15632.",
      "created_at" : "2019-05-15T14:25:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16028#issuecomment-492677536",
      "id" : 492677536,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16028",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MjY3NzUzNg==",
      "updated_at" : "2019-05-15T14:25:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/492677536",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky Here goes:\r\n\r\n```\r\nAssertion failed: lock ::cs_main not held in interfaces/chain.cpp:137; locks held:\r\n\r\nÃ¢ÂÂ¦\r\n(gdb) bt\r\n#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51\r\n#1  0x00007ffff2d23801 in __GI_abort () at abort.c:79\r\n#2  0x0000555555aa7cfd in AssertLockHeldInternal (pszName=0x555556106524 \"::cs_main\", pszFile=0x5555561063b2 \"interfaces/chain.cpp\", nLine=137, cs=<optimized out>) at sync.cpp:175\r\n#3  0x0000555555774537 in interfaces::(anonymous namespace)::LockImpl::getTipLocator (this=<optimized out>) at interfaces/chain.cpp:137\r\n#4  0x0000555555b53630 in CWallet::CreateWalletFromFile (chain=..., location=..., wallet_creation_flags=0) at wallet/wallet.cpp:4078\r\n#5  0x0000555555b07523 in LoadWallets (chain=..., wallet_files=...) at wallet/load.cpp:68\r\n#6  0x0000555555ad383e in interfaces::(anonymous namespace)::WalletClientImpl::load (this=<optimized out>) at interfaces/wallet.cpp:521\r\n#7  0x000055555579282b in AppInitMain (interfaces=...) at init.cpp:1681\r\n#8  0x000055555577c8d7 in interfaces::(anonymous namespace)::NodeImpl::appInitMain (this=<optimized out>) at interfaces/node.cpp:78\r\n#9  0x000055555564b0ec in BitcoinCore::initialize (this=0x555556f2cc60) at qt/bitcoin.cpp:154\r\n```",
      "created_at" : "2019-05-15T14:52:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16028#issuecomment-492688855",
      "id" : 492688855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16028",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MjY4ODg1NQ==",
      "updated_at" : "2019-05-15T14:52:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/492688855",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky Like this?\r\n\r\n```diff\r\ndiff --git a/src/wallet/test/wallet_tests.cpp b/src/wallet/test/wallet_tests.cpp\r\nindex 69a78f1fc..44db2f29b 100644\r\n--- a/src/wallet/test/wallet_tests.cpp\r\n+++ b/src/wallet/test/wallet_tests.cpp\r\n@@ -387,7 +387,7 @@ public:\r\n     }\r\n\r\n     std::unique_ptr<interfaces::Chain> m_chain = interfaces::MakeChain();\r\n-    std::unique_ptr<interfaces::Chain::Lock> m_locked_chain = m_chain->assumeLocked();  // Temporary. Removed in upcoming lock cleanup\r\n+    std::unique_ptr<interfaces::Chain::Lock> m_locked_chain = m_chain->lock();\r\n     std::unique_ptr<CWallet> wallet;\r\n };\r\n\r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\nindex 054329fbd..0822c7c30 100644\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -4074,7 +4074,7 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\r\n             return nullptr;\r\n         }\r\n\r\n-        auto locked_chain = chain.assumeLocked();  // Temporary. Removed in upcoming lock cleanup\r\n+        auto locked_chain = chain.lock();\r\n         walletInstance->ChainStateFlushed(locked_chain->getTipLocator());\r\n     } else if (wallet_creation_flags & WALLET_FLAG_DISABLE_PRIVATE_KEYS) {\r\n         // Make it impossible to disable private keys after creation\r\n```",
      "created_at" : "2019-05-15T15:11:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16028#issuecomment-492696982",
      "id" : 492696982,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16028",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MjY5Njk4Mg==",
      "updated_at" : "2019-05-15T15:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/492696982",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @ryanofsky Like this?\r\n\r\nYes, I think that should work. As followup, the assumeLocked method declarations and definitions could also be removed, the LockingStateImpl class could be deleted, and LockImpl could inherit directly from UniqueLock.",
      "created_at" : "2019-05-15T15:21:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16028#issuecomment-492700773",
      "id" : 492700773,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16028",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MjcwMDc3Mw==",
      "updated_at" : "2019-05-15T15:21:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/492700773",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fix in #16033.",
      "created_at" : "2019-05-16T08:50:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16028#issuecomment-492978866",
      "id" : 492978866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16028",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5Mjk3ODg2Ng==",
      "updated_at" : "2019-05-16T08:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/492978866",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
