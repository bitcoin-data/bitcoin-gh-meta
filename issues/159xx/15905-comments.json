[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hello @pinheadmz,\r\n\r\nhow did you resolve this issue? We're stumbled upon it as well.",
      "created_at" : "2020-07-01T06:54:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15905#issuecomment-652229417",
      "id" : 652229417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15905",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MjIyOTQxNw==",
      "updated_at" : "2020-07-01T06:54:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/652229417",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5836089?v=4",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "node_id" : "MDQ6VXNlcjU4MzYwODk=",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dexX7 which version of Bitcoin Core did you see the issue with? Don't hesitate to provide any other info or steps needed to reproduce what you saw.\r\n\r\nI followed the above steps just now on current master with 50, 64, and 100 blocks in regtest, and was unable to reproduce the error -- it worked as expected.\r\n\r\nI was looking at a similar block propagation issue after `invalidateblock` lately in #19397 with @jnewbery (who just posted an v interesting analysis that I plan to look more into to learn what is going on). Don't hesitate to have a look or review if interested.",
      "created_at" : "2020-07-01T07:18:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15905#issuecomment-652239953",
      "id" : 652239953,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15905",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MjIzOTk1Mw==",
      "updated_at" : "2020-07-01T07:18:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/652239953",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jonatack this happens after running invalidateblock and generating a replacement block at in same second and with the same coinbase address, the resulting block has the same hash as the invalidated block which then generates the \"AcceptBlock FAILED (duplicate (code 0))\" error reported above.\r\n\r\nFor our project (@dexX7 ) we run some bespoke tests that generate blocks, invalidates the chain then generates replacement blocks. This issue only arose after moving from the generate RPC call to generatetoaddress using the same address each time.\r\n\r\nDue to needing to generate replacement blocks in the same second it does not show up in manual tests, if you script it on regtest then this is more likely to show up. After our script failed I did manually recreate the problem by hard coding the block time in CreateNewBlock and skipping its call to UpdateTime.\r\n\r\nYou can see the same blockhash being generated here with block time fixed and the same coinbase address being used. Note that the client being run is based on Bitcoin 0.18.\r\n\r\n    user@disco:/mnt/development/github/omnicore-original/src$ ./omnicore-cli -regtest generatetoaddress 1  moneyqMan7uh8FqdCA2BV5yZ8qVrc9ikLP\r\n    [\r\n      \"1fbfceb118b6303dc3329d912524331fc49d7e92a87996151058ad73f48ccf22\"\r\n    ]\r\n    user@disco:/mnt/development/github/omnicore-original/src$ ./omnicore-cli -regtest stop\r\n    Omni Core server stopping\r\n    user@disco:/mnt/development/github/omnicore-original/src$ rm -Rf ~/.bitcoin\r\n    user@disco:/mnt/development/github/omnicore-original/src$ ./omnicored -regtest -daemon\r\n    Omni Core server starting\r\n    user@disco:/mnt/development/github/omnicore-original/src$ ./omnicore-cli -regtest generatetoaddress 1 moneyqMan7uh8FqdCA2BV5yZ8qVrc9ikLP\r\n    [\r\n      \"1fbfceb118b6303dc3329d912524331fc49d7e92a87996151058ad73f48ccf22\"\r\n    ]\r\n\r\nRunning another manual test with the same set up and using invalidateblock.\r\n\r\n    user@disco:/mnt/development/github/omnicore-original/src$ ./omnicore-cli -regtest generatetoaddress 1 moneyqMan7uh8FqdCA2BV5yZ8qVrc9ikLP\r\n    [\r\n      \"1fbfceb118b6303dc3329d912524331fc49d7e92a87996151058ad73f48ccf22\"\r\n    ]\r\n    user@disco:/mnt/development/github/omnicore-original/src$ ./omnicore-cli -regtest invalidateblock 1fbfceb118b6303dc3329d912524331fc49d7e92a87996151058ad73f48ccf22\r\n    user@disco:/mnt/development/github/omnicore-original/src$ ./omnicore-cli -regtest generatetoaddress 1 moneyqMan7uh8FqdCA2BV5yZ8qVrc9ikLP\r\n    error code: -32603\r\n    error message:\r\n    ProcessNewBlock, block not accepted\r\n\r\nSolutions for this would be to make your script wait a second after running invalidateblock or using a different coinbase address.",
      "created_at" : "2020-07-01T07:35:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15905#issuecomment-652247532",
      "id" : 652247532,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15905",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MjI0NzUzMg==",
      "updated_at" : "2020-07-01T07:38:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/652247532",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/5293433?v=4",
         "events_url" : "https://api.github.com/users/Bushstar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Bushstar/followers",
         "following_url" : "https://api.github.com/users/Bushstar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Bushstar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Bushstar",
         "id" : 5293433,
         "login" : "Bushstar",
         "node_id" : "MDQ6VXNlcjUyOTM0MzM=",
         "organizations_url" : "https://api.github.com/users/Bushstar/orgs",
         "received_events_url" : "https://api.github.com/users/Bushstar/received_events",
         "repos_url" : "https://api.github.com/users/Bushstar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Bushstar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Bushstar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Bushstar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Solutions for this would be to make your script wait a second after running invalidateblock or using a different coinbase address.\r\n\r\nYeah the issue for me was bitcoind was re-creating a new block with the same hash as the previously invalidated block.  Changing any part of the block would fix it - extranonce, nonce, timestamp, coinbase address etc.\r\n\r\nI noticed we didn't have this problem in bcoin, and I think it's because that library adds a random 4-byte nonce to every coinbase scriptSig (after the BIP34 height commitment). On mainnet I think this is usually taken care of by extraNonce, but we could prevent this issue on regtest in bitcoind by adding a similar mechanism.",
      "created_at" : "2020-07-01T11:42:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15905#issuecomment-652369085",
      "id" : 652369085,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15905",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MjM2OTA4NQ==",
      "updated_at" : "2020-07-01T11:42:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/652369085",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I've also come across this issue for `v0.19.1.0-g58ba7c314d552cea8cb024960a8504577aee586f`. \r\n\r\nSame exact process:\r\n\r\n- Run `invalidateblock` on `regtest`\r\n- Generate a new block to the same address.\r\n\r\nThe issue seems to be the exact same, the block that is being generated has the exact same fields as the invalidated one, so the former conflicts with the latter.\r\n",
      "created_at" : "2020-07-23T15:02:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15905#issuecomment-663058445",
      "id" : 663058445,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15905",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MzA1ODQ0NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-23T15:02:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/663058445",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   }
]
