[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20827 (During IBD, prune as much as possible until we get close to where we will eventually keep blocks by luke-jr)\n* #20664 (Add scanblocks RPC call by jonasschnelli)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-05-03T13:40:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-489099020",
      "id" : 489099020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4OTA5OTAyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T23:35:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/489099020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281206430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281206430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0d8f7369cd8b51dfb7b3b9b920e4e11f7962faa9 \r\n\r\nThis doesn't check `status & BLOCK_HAVE_DATA` on the tip, is that intentional?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-06T14:21:58Z",
      "diff_hunk" : "@@ -66,6 +66,29 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n     }\n     m_synced = m_best_block_index.load() == chainActive.Tip();\n+\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // it looks like this index is not built yet\n+            // make sure we have all data back to the genesis\n+            const CBlockIndex* block = chainActive.Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281206430",
      "id" : 281206430,
      "line" : 74,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIwNjQzMA==",
      "original_commit_id" : "0d8f7369cd8b51dfb7b3b9b920e4e11f7962faa9",
      "original_line" : 74,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 10,
      "pull_request_review_id" : 234006796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281206430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281208250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281208250"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d2ab62fede34b7980863617f3669c019ee42d029 \r\n\r\nThese comment were added in the previous commit, could fixup these hunks?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-06T14:26:02Z",
      "diff_hunk" : "@@ -70,21 +70,21 @@ bool BaseIndex::Init()\n     if (!m_synced) {\n         bool prune_violation = false;\n         if (!m_best_block_index) {\n-            // it looks like this index is not built yet\n-            // make sure we have all data back to the genesis\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281208250",
      "id" : 281208250,
      "line" : 72,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIwODI1MA==",
      "original_commit_id" : "d2ab62fede34b7980863617f3669c019ee42d029",
      "original_line" : 72,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 8,
      "pull_request_review_id" : 234006796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281208250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281209023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281209023"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8bb1ca8a276f5f6fc5af3639c2d58c496b71bf8f \r\n\r\n`bool IsSyned() const;`. Any reason to not write implementation here?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-06T14:28:01Z",
      "diff_hunk" : "@@ -100,6 +100,8 @@ class BaseIndex : public CValidationInterface\n     /// not block and immediately returns false.\n     bool BlockUntilSyncedToCurrentChain();\n \n+    bool IsSynced();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281209023",
      "id" : 281209023,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIwOTAyMw==",
      "original_commit_id" : "8bb1ca8a276f5f6fc5af3639c2d58c496b71bf8f",
      "original_line" : 103,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : null,
      "pull_request_review_id" : 234006796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281209023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281210225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bd11606a95022478e6ef1ccaada1589cff13a327\r\n\r\nCan be checked before locking `cs_main`?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-06T14:30:44Z",
      "diff_hunk" : "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281210225",
      "id" : 281210225,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIxMDIyNQ==",
      "original_commit_id" : "bd11606a95022478e6ef1ccaada1589cff13a327",
      "original_line" : 1020,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 234006796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281210459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bd11606a95022478e6ef1ccaada1589cff13a327\r\n\r\nDo you see a way to test this?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-06T14:31:12Z",
      "diff_hunk" : "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) {\n+            throw JSONRPCError(RPC_MISC_ERROR, \"Cannot prune blocks because blockfilterindex is syncing.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281210459",
      "id" : 281210459,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIxMDQ1OQ==",
      "original_commit_id" : "bd11606a95022478e6ef1ccaada1589cff13a327",
      "original_line" : 1022,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 234006796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281213644"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281213644"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bf744288bd58718844841c088c498cd57a8f87d8 \r\n\r\nnit, no need for `{}`. Alternative:\r\n```\r\ndelay_pruning |= !index.IsSynced();\r\n```",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-06T14:38:02Z",
      "diff_hunk" : "@@ -2085,23 +2086,34 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     static int64_t nLastFlush = 0;\n     std::set<int> setFilesToPrune;\n     bool full_flush_completed = false;\n+\n+    // we delay pruning when one of the blockfilterindex is syncing\n+    bool delay_pruning = false;\n+    ForEachBlockFilterIndex([&delay_pruning](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) { delay_pruning = true; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281213644",
      "id" : 281213644,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIxMzY0NA==",
      "original_commit_id" : "bf744288bd58718844841c088c498cd57a8f87d8",
      "original_line" : 2093,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 234006796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281213644",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281218262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281218262"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bf744288bd58718844841c088c498cd57a8f87d8\r\n\r\nAn alternative is to add a global `g_delay_pruning` in validation.h which gets updated every time an index `m_synced` is updated.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-06T14:48:22Z",
      "diff_hunk" : "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/blockfilterindex -> validation -> index/blockfilterindex\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281218262",
      "id" : 281218262,
      "line" : 14,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIxODI2Mg==",
      "original_commit_id" : "bf744288bd58718844841c088c498cd57a8f87d8",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 234006796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281218262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281220802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281220802"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think the tip can ever not have data?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-06T14:53:56Z",
      "diff_hunk" : "@@ -66,6 +66,29 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n     }\n     m_synced = m_best_block_index.load() == chainActive.Tip();\n+\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // it looks like this index is not built yet\n+            // make sure we have all data back to the genesis\n+            const CBlockIndex* block = chainActive.Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281220802",
      "id" : 281220802,
      "in_reply_to_id" : 281206430,
      "line" : 74,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIyMDgwMg==",
      "original_commit_id" : "0d8f7369cd8b51dfb7b3b9b920e4e11f7962faa9",
      "original_line" : 74,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 10,
      "pull_request_review_id" : 234024777,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281220802",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281221080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281221080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or move the \"load block\" function into a separate \"storage\" module.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-06T14:54:39Z",
      "diff_hunk" : "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/blockfilterindex -> validation -> index/blockfilterindex\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281221080",
      "id" : 281221080,
      "in_reply_to_id" : 281218262,
      "line" : 14,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIyMTA4MA==",
      "original_commit_id" : "bf744288bd58718844841c088c498cd57a8f87d8",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 234025177,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281221080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closes #15867?",
      "created_at" : "2019-05-06T17:37:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-489707230",
      "id" : 489707230,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4OTcwNzIzMA==",
      "updated_at" : "2019-05-06T17:37:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/489707230",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-05-07T16:03:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-490143318",
      "id" : 490143318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDE0MzMxOA==",
      "updated_at" : "2019-05-07T16:03:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490143318",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282552651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282552651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm currently working on making the block-/undo-filesize dynamic which would then allow testing this more reliable.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-09T15:58:25Z",
      "diff_hunk" : "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) {\n+            throw JSONRPCError(RPC_MISC_ERROR, \"Cannot prune blocks because blockfilterindex is syncing.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282552651",
      "id" : 282552651,
      "in_reply_to_id" : 281210459,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjU1MjY1MQ==",
      "original_commit_id" : "bd11606a95022478e6ef1ccaada1589cff13a327",
      "original_line" : 1022,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 235678099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282552651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601175"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601175"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The global `g_delay_pruning` smells fragile. Better not do that.\r\n\r\nI like the \"storage\" module approach which though would be something for another PR.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-09T18:04:33Z",
      "diff_hunk" : "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/blockfilterindex -> validation -> index/blockfilterindex\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601175",
      "id" : 282601175,
      "in_reply_to_id" : 281218262,
      "line" : 14,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMTE3NQ==",
      "original_commit_id" : "bf744288bd58718844841c088c498cd57a8f87d8",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 235740443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601885"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I don't think the tip can ever not have data? \r\n\r\nJup.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-09T18:06:33Z",
      "diff_hunk" : "@@ -66,6 +66,29 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n     }\n     m_synced = m_best_block_index.load() == chainActive.Tip();\n+\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // it looks like this index is not built yet\n+            // make sure we have all data back to the genesis\n+            const CBlockIndex* block = chainActive.Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601885",
      "id" : 282601885,
      "in_reply_to_id" : 281206430,
      "line" : 74,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMTg4NQ==",
      "original_commit_id" : "0d8f7369cd8b51dfb7b3b9b920e4e11f7962faa9",
      "original_line" : 74,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 10,
      "pull_request_review_id" : 235741371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601960"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601960"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-09T18:06:46Z",
      "diff_hunk" : "@@ -100,6 +100,8 @@ class BaseIndex : public CValidationInterface\n     /// not block and immediately returns false.\n     bool BlockUntilSyncedToCurrentChain();\n \n+    bool IsSynced();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601960",
      "id" : 282601960,
      "in_reply_to_id" : 281209023,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMTk2MA==",
      "original_commit_id" : "8bb1ca8a276f5f6fc5af3639c2d58c496b71bf8f",
      "original_line" : 103,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : null,
      "pull_request_review_id" : 235741478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282602418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-09T18:08:04Z",
      "diff_hunk" : "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282602418",
      "id" : 282602418,
      "in_reply_to_id" : 281210225,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMjQxOA==",
      "original_commit_id" : "bd11606a95022478e6ef1ccaada1589cff13a327",
      "original_line" : 1020,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 235742086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282602625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602625"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Rather not do `|= !` for code readability, but removed the extra unnecessary block ",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-05-09T18:08:38Z",
      "diff_hunk" : "@@ -2085,23 +2086,34 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     static int64_t nLastFlush = 0;\n     std::set<int> setFilesToPrune;\n     bool full_flush_completed = false;\n+\n+    // we delay pruning when one of the blockfilterindex is syncing\n+    bool delay_pruning = false;\n+    ForEachBlockFilterIndex([&delay_pruning](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) { delay_pruning = true; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282602625",
      "id" : 282602625,
      "in_reply_to_id" : 281213644,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMjYyNQ==",
      "original_commit_id" : "bf744288bd58718844841c088c498cd57a8f87d8",
      "original_line" : 2093,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 235742381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and fixed reported points.",
      "created_at" : "2019-05-09T18:10:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-491008776",
      "id" : 491008776,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MTAwODc3Ng==",
      "updated_at" : "2019-05-09T18:10:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/491008776",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-07-24T18:15:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-514742374",
      "id" : 514742374,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDc0MjM3NA==",
      "updated_at" : "2019-07-24T18:15:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514742374",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315296449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315296449"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Aren't we intentionally keeping the message vague here to avoid confusing users?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-08-19T16:17:53Z",
      "diff_hunk" : "@@ -23,7 +23,7 @@ static void FatalError(const char* fmt, const Args&... args)\n     SetMiscWarning(strMessage);\n     LogPrintf(\"*** %s\\n\", strMessage);\n     uiInterface.ThreadSafeMessageBox(\n-        \"Error: A fatal internal error occurred, see debug.log for details\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315296449",
      "id" : 315296449,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5NjQ0OQ==",
      "original_commit_id" : "a205fc52738088d983c22a3e3dcfa900a33e8a43",
      "original_line" : 26,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 276668382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315296449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297460"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIRC, having the data for block N is not a guarantee we have it for block N+M, since blocks are stored out of order and pruned only as entire files.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-08-19T16:20:20Z",
      "diff_hunk" : "@@ -66,6 +66,28 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(::ChainActive(), locator);\n     }\n     m_synced = m_best_block_index.load() == ::ChainActive().Tip();\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                block = block->pprev;\n+            }\n+            prune_violation = block != ::ChainActive().Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else if (!(m_best_block_index.load()->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297460",
      "id" : 315297460,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5NzQ2MA==",
      "original_commit_id" : "a205fc52738088d983c22a3e3dcfa900a33e8a43",
      "original_line" : 82,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 276668382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297746"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If `m_best_block_index` is not in the main chain, we may need its parent blocks to undo indexing. This should be checked here too.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-08-19T16:21:00Z",
      "diff_hunk" : "@@ -66,6 +66,28 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(::ChainActive(), locator);\n     }\n     m_synced = m_best_block_index.load() == ::ChainActive().Tip();\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                block = block->pprev;\n+            }\n+            prune_violation = block != ::ChainActive().Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else if (!(m_best_block_index.load()->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297746",
      "id" : 315297746,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5Nzc0Ng==",
      "original_commit_id" : "a205fc52738088d983c22a3e3dcfa900a33e8a43",
      "original_line" : 82,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 276668382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "lead*",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-08-19T16:21:34Z",
      "diff_hunk" : "@@ -178,6 +200,10 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n \n     // In the case of a reorg, ensure persisted block locator is not stale.\n+    // Pruning has a minimum of 288 blocks-to-keep and getting the index\n+    // out of sync may be possible but a users fault.\n+    // In case we reorg beyond the pruned depth, ReadBlockFromDisk would\n+    // throw and led to a graceful shutdown",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297976",
      "id" : 315297976,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5Nzk3Ng==",
      "original_commit_id" : "a205fc52738088d983c22a3e3dcfa900a33e8a43",
      "original_line" : 220,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 276668382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315298520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298520"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be nicer to just check if the indexes are beyond the requested prune height...",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-08-19T16:22:52Z",
      "diff_hunk" : "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) {\n+            throw JSONRPCError(RPC_MISC_ERROR, \"Cannot prune blocks because blockfilterindex is syncing.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315298520",
      "id" : 315298520,
      "in_reply_to_id" : 281210459,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5ODUyMA==",
      "original_commit_id" : "bd11606a95022478e6ef1ccaada1589cff13a327",
      "original_line" : 1022,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 276668382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315298813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298813"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Won't this effectively prevent all pruning until IBD completes? Seems important to prune as soon as all indexes are caught up to the given height...",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2019-08-19T16:23:38Z",
      "diff_hunk" : "@@ -2105,23 +2106,34 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     static int64_t nLastFlush = 0;\n     std::set<int> setFilesToPrune;\n     bool full_flush_completed = false;\n+\n+    // we delay pruning when one of the blockfilterindex is syncing\n+    bool delay_pruning = false;\n+    ForEachBlockFilterIndex([&delay_pruning](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) delay_pruning = true;\n+    });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315298813",
      "id" : 315298813,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5ODgxMw==",
      "original_commit_id" : "a205fc52738088d983c22a3e3dcfa900a33e8a43",
      "original_line" : 2114,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 276668382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298813",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Any chance this will be revived? This is a blocker for `lnd` to support a pruned `bitcoind` node, as we want to be able to fetch filters from `bitcoind`, then manually fetch blocks ourselves (if `bitcoind` doesn't have them) to scan them for rescans or just normal wallet sync. ",
      "created_at" : "2020-01-08T01:43:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-571854091",
      "id" : 571854091,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTg1NDA5MQ==",
      "updated_at" : "2020-01-08T01:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571854091",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/998190?v=4",
         "events_url" : "https://api.github.com/users/Roasbeef/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Roasbeef/followers",
         "following_url" : "https://api.github.com/users/Roasbeef/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Roasbeef/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Roasbeef",
         "id" : 998190,
         "login" : "Roasbeef",
         "node_id" : "MDQ6VXNlcjk5ODE5MA==",
         "organizations_url" : "https://api.github.com/users/Roasbeef/orgs",
         "received_events_url" : "https://api.github.com/users/Roasbeef/received_events",
         "repos_url" : "https://api.github.com/users/Roasbeef/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Roasbeef/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Roasbeef/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Roasbeef"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This feature increases the value of running a pruned node significantly. +1 for adding this!",
      "created_at" : "2020-07-08T15:54:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-655605491",
      "id" : 655605491,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NTYwNTQ5MQ==",
      "updated_at" : "2020-07-08T15:54:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655605491",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I suspect #19463 could be useful for this",
      "created_at" : "2020-07-08T16:56:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-655638171",
      "id" : 655638171,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NTYzODE3MQ==",
      "updated_at" : "2020-07-08T16:56:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655638171",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rewrote this PR and tried to fix the reported point by @promag, @MarcoFalke and @luke-jr.\r\nAdded `-fastprune` debug parameter to test pruning more effectively (added a functional-test as well).",
      "created_at" : "2020-12-10T19:30:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-742744931",
      "id" : 742744931,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0Mjc0NDkzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-16T12:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742744931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550900736"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550900736"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`has_blockfilter = true;`?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-01-02T17:08:26Z",
      "diff_hunk" : "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;\n+            }\n+            has_blockfilter = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550900736",
      "id" : 550900736,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwMDczNg==",
      "original_commit_id" : "2541ca8df55295ac34ab9348742283493e590435",
      "original_line" : 2250,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 560645487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550900736",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550901918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550901918"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this whole block of additions can be moved below line 2255 (`if (fPruneMode...`) because it's only relevant for what is inside there.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-01-02T17:22:07Z",
      "diff_hunk" : "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550901918",
      "id" : 550901918,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwMTkxOA==",
      "original_commit_id" : "2541ca8df55295ac34ab9348742283493e590435",
      "original_line" : 2241,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 560645487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550901918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550902448"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902448"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "should this be `index_lowest_blockheight = height;`?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-01-02T17:27:46Z",
      "diff_hunk" : "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550902448",
      "id" : 550902448,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwMjQ0OA==",
      "original_commit_id" : "2541ca8df55295ac34ab9348742283493e590435",
      "original_line" : 2248,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 560645487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550902906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902906"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Shouldn't this be `std::min()` because the lower height number is the one that let's us prune less? (same below)",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-01-02T17:33:23Z",
      "diff_hunk" : "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;\n+            }\n+            has_blockfilter = false;\n+        });\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, has_blockfilter ? std::max(nManualPruneHeight, index_lowest_blockheight) : nManualPruneHeight, m_chain.Height());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550902906",
      "id" : 550902906,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwMjkwNg==",
      "original_commit_id" : "2541ca8df55295ac34ab9348742283493e590435",
      "original_line" : 2259,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 560645487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566674758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566674758"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point. Will change.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-01-29T09:06:25Z",
      "diff_hunk" : "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566674758",
      "id" : 566674758,
      "in_reply_to_id" : 550901918,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY3NDc1OA==",
      "original_commit_id" : "2541ca8df55295ac34ab9348742283493e590435",
      "original_line" : 2241,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 579060882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566674758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681917"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Absolutely. Fixed.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-01-29T09:18:40Z",
      "diff_hunk" : "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;\n+            }\n+            has_blockfilter = false;\n+        });\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, has_blockfilter ? std::max(nManualPruneHeight, index_lowest_blockheight) : nManualPruneHeight, m_chain.Height());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681917",
      "id" : 566681917,
      "in_reply_to_id" : 550902906,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY4MTkxNw==",
      "original_commit_id" : "2541ca8df55295ac34ab9348742283493e590435",
      "original_line" : 2259,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 579070179,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. Fixed.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-01-29T09:18:47Z",
      "diff_hunk" : "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;\n+            }\n+            has_blockfilter = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681970",
      "id" : 566681970,
      "in_reply_to_id" : 550900736,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY4MTk3MA==",
      "original_commit_id" : "2541ca8df55295ac34ab9348742283493e590435",
      "original_line" : 2250,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 579070262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. Fixed.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-01-29T09:18:49Z",
      "diff_hunk" : "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681981",
      "id" : 566681981,
      "in_reply_to_id" : 550902448,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY4MTk4MQ==",
      "original_commit_id" : "2541ca8df55295ac34ab9348742283493e590435",
      "original_line" : 2248,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 579070281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @fjahr for the reviews.\r\nAnd I agree that there should be a test for the FlushStateToDisk() changes.",
      "created_at" : "2021-01-29T09:19:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-769684234",
      "id" : 769684234,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTY4NDIzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-29T09:19:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769684234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code Review ACK 0280274368e2df7c7832549cd581c710875a6be1\r\n\r\nThis is simpler than I expected it to be.",
      "created_at" : "2021-02-08T21:38:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-775480470",
      "id" : 775480470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTQ4MDQ3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-08T21:38:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775480470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r572397573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397573"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The numeric constant could be extracted into `src/validation.h` (on top of the file where `MAX_BLOCKFILE_SIZE` is defined).",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-08T21:48:27Z",
      "diff_hunk" : "@@ -3203,7 +3217,7 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     bool finalize_undo = false;\n     if (!fKnown) {\n-        while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {\n+        while (vinfoBlockFile[nFile].nSize + nAddSize >= (gArgs.GetBoolArg(\"-fastprune\", false) ? 0x10000 /* 64kb */ : MAX_BLOCKFILE_SIZE)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r572397573",
      "id" : 572397573,
      "line" : 3215,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjM5NzU3Mw==",
      "original_commit_id" : "0280274368e2df7c7832549cd581c710875a6be1",
      "original_line" : 3215,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 41,
      "pull_request_review_id" : 585953872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r572397668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397668"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The numeric constant could be extracted to top of the file where `BLOCKFILE_CHUNK_SIZE` is defined.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-08T21:48:36Z",
      "diff_hunk" : "@@ -3986,7 +4000,7 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n \n static FlatFileSeq BlockFileSeq()\n {\n-    return FlatFileSeq(GetBlocksDir(), \"blk\", BLOCKFILE_CHUNK_SIZE);\n+    return FlatFileSeq(GetBlocksDir(), \"blk\", gArgs.GetBoolArg(\"-fastprune\", false) ? 0x4000 /* 16kb */ : BLOCKFILE_CHUNK_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r572397668",
      "id" : 572397668,
      "line" : 4007,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjM5NzY2OA==",
      "original_commit_id" : "0280274368e2df7c7832549cd581c710875a6be1",
      "original_line" : 4007,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 68,
      "pull_request_review_id" : 585953872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573368857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573368857"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Avoid pruning below the blockfilterindex sync height\" (bda1c9fc90a704d1962b16fe4242b5637c930b29)\r\n\r\nEarlier commit can set best_block_height to 0, while FindFilesToPruneManual is asserting prune height > 0, which seems like it could lead to an unlucky crash.\r\n\r\nAlso, the has_blockfilter variable and conditionals below seem unnecessary, and the logic would work fine if it were just assumed always true.\r\n\r\nAlso, the code duplication in prune calls below also seems not great. I think this could all be more straightforward:\r\n\r\n```c++\r\nint last_prune = m_chain.Height(); // last height we can prune\r\nForEachBlockFilterIndex([&](BlockFilterIndex& index) {\r\n   last_prune = std::max(1, std::min(last_prune, index.GetSummary().block_block_height));\r\n});\r\n\r\nif (nManualPruneHeight > 0) {\r\n    FindFilesToPruneManual(setFilesToPrune, std::min(last_prune, nManualPruneHeight), m_chain.Height());\r\n} else {\r\n    FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), last_prune, m_chain.Height());\r\n}\r\n```",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-10T01:08:26Z",
      "diff_hunk" : "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573368857",
      "id" : 573368857,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM2ODg1Nw==",
      "original_commit_id" : "bda1c9fc90a704d1962b16fe4242b5637c930b29",
      "original_line" : 2262,
      "original_position" : 26,
      "original_start_line" : 2256,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 587162834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573368857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573372325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573372325"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Allow blockfilter in conjunction with prune\" (92b4a9cc3eca0897e455e00144a96e88b5c4ea1c)\r\n\r\nOn these two lines it's confusing and appears racy for this code to be referring to the shared `m_best_block_index.load()` value when it could be just be using the private `block_to_test` value. Would suggest `s/m_best_block_index.load()/block_to_test/`",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-10T01:18:07Z",
      "diff_hunk" : "@@ -65,6 +65,43 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(::ChainActive(), locator);\n     }\n     m_synced = m_best_block_index.load() == ::ChainActive().Tip();\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                block = block->pprev;\n+            }\n+            prune_violation = block != ::ChainActive().Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else {\n+            const CBlockIndex* block_to_test = m_best_block_index.load();\n+            if (!ChainActive().Contains(m_best_block_index.load())) {\n+                // if the bestblock is not part of the mainchain, find the fork\n+                // and make sure we have all data down to the fork\n+                block_to_test = ::ChainActive().FindFork(m_best_block_index.load());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573372325",
      "id" : 573372325,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM3MjMyNQ==",
      "original_commit_id" : "92b4a9cc3eca0897e455e00144a96e88b5c4ea1c",
      "original_line" : 86,
      "original_position" : 22,
      "original_start_line" : 83,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 587162834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573372325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573373090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573373090"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Allow blockfilter in conjunction with prune\" (92b4a9cc3eca0897e455e00144a96e88b5c4ea1c)\r\n\r\nThis seems wrong in the fork case. Should be fixed with  `s/m_best_block_index.load()/block_to_test/` again",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-10T01:20:17Z",
      "diff_hunk" : "@@ -65,6 +65,43 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(::ChainActive(), locator);\n     }\n     m_synced = m_best_block_index.load() == ::ChainActive().Tip();\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                block = block->pprev;\n+            }\n+            prune_violation = block != ::ChainActive().Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else {\n+            const CBlockIndex* block_to_test = m_best_block_index.load();\n+            if (!ChainActive().Contains(m_best_block_index.load())) {\n+                // if the bestblock is not part of the mainchain, find the fork\n+                // and make sure we have all data down to the fork\n+                block_to_test = ::ChainActive().FindFork(m_best_block_index.load());\n+            }\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            prune_violation = true;\n+            // check backwards from the tip if we have all block data until we reach the indexes bestblock\n+            while (block_to_test && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                if (m_best_block_index.load() == block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573373090",
      "id" : 573373090,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM3MzA5MA==",
      "original_commit_id" : "92b4a9cc3eca0897e455e00144a96e88b5c4ea1c",
      "original_line" : 92,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 587162834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573373090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573385944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573385944"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Avoid pruning below the blockfilterindex sync height\" (bda1c9fc90a704d1962b16fe4242b5637c930b29)\r\n\r\nThis comment and this commit title seem wrong, should `s/below/above/`",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-10T01:57:16Z",
      "diff_hunk" : "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573385944",
      "id" : 573385944,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM4NTk0NA==",
      "original_commit_id" : "bda1c9fc90a704d1962b16fe4242b5637c930b29",
      "original_line" : 2254,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 587162834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573385944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573391858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573391858"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Avoid pruning below the blockfilterindex sync height\" (bda1c9fc90a704d1962b16fe4242b5637c930b29)\r\n\r\nI don't think just passing a lower `nPruneAfterHeight` argument value is sufficient to avoid pruning here. I think the `index_lowest_blockheight` variable (`last_prune` variable in my previous suggestion) has to be passed as a new argument to `FindFilesToPrune`. If you look at the `FindFilesToPrune` implementation you can see it is not using `nPruneAfterHeight` value at all to compute `nLastBlockWeCanPrune`, which is the value we need to change there.\r\n\r\nIt's also easy to see this code is wrong because it will have no effect at all if index_lowest_blockheight is bigger than chainparams.PruneAfterHeight, which is 100,000.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-10T02:09:03Z",
      "diff_hunk" : "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });\n+\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, has_blockfilter ? std::min(nManualPruneHeight, index_lowest_blockheight) : nManualPruneHeight, m_chain.Height());\n             } else {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), m_chain.Height(), IsInitialBlockDownload());\n+                m_blockman.FindFilesToPrune(setFilesToPrune, has_blockfilter ? std::min(chainparams.PruneAfterHeight(), (uint64_t)index_lowest_blockheight) : chainparams.PruneAfterHeight(), m_chain.Height(), IsInitialBlockDownload());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573391858",
      "id" : 573391858,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM5MTg1OA==",
      "original_commit_id" : "bda1c9fc90a704d1962b16fe4242b5637c930b29",
      "original_line" : 2273,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 587162834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573391858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574358480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574358480"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Using `last_prune` instead of `m_chain.Height()` will lead to preserve 288 blocks below the artificial tip (`last_prune`) which IMO are not subject to reorg.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-11T09:37:13Z",
      "diff_hunk" : "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574358480",
      "id" : 574358480,
      "in_reply_to_id" : 573368857,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDM1ODQ4MA==",
      "original_commit_id" : "bda1c9fc90a704d1962b16fe4242b5637c930b29",
      "original_line" : 2262,
      "original_position" : 26,
      "original_start_line" : 2256,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 588373912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574358480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574366925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574366925"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Using `last_prune` instead of `m_chain.Height()` will lead to preserve 288 blocks below the artificial tip (`last_prune`) which IMO are not subject to reorg.\r\n\r\nIf you're talking about the non-manual case, the you need to FindFilesToPrune a new parameter, not use the existing one, see https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573391858. Not suggesting preserving below the tip.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-11T09:49:56Z",
      "diff_hunk" : "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574366925",
      "id" : 574366925,
      "in_reply_to_id" : 573368857,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDM2NjkyNQ==",
      "original_commit_id" : "bda1c9fc90a704d1962b16fe4242b5637c930b29",
      "original_line" : 2262,
      "original_position" : 26,
      "original_start_line" : 2256,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 588384059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574366925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks a lot for testing @ryanofsky.\r\nAddressed your points (+rebased)(force pushed).",
      "created_at" : "2021-02-11T10:44:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-777355249",
      "id" : 777355249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzM1NTI0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T10:44:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777355249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574402608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574402608"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. You're right. Lets just accept the 288blocks buffer for now (can be changed later if necessary).",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-11T10:46:08Z",
      "diff_hunk" : "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574402608",
      "id" : 574402608,
      "in_reply_to_id" : 573368857,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDQwMjYwOA==",
      "original_commit_id" : "bda1c9fc90a704d1962b16fe4242b5637c930b29",
      "original_line" : 2262,
      "original_position" : 26,
      "original_start_line" : 2256,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 588428964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574402608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574403596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574403596"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I thought about it but since its a debug only parameter I rather keep that inline.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-11T10:47:41Z",
      "diff_hunk" : "@@ -3203,7 +3217,7 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     bool finalize_undo = false;\n     if (!fKnown) {\n-        while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {\n+        while (vinfoBlockFile[nFile].nSize + nAddSize >= (gArgs.GetBoolArg(\"-fastprune\", false) ? 0x10000 /* 64kb */ : MAX_BLOCKFILE_SIZE)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574403596",
      "id" : 574403596,
      "in_reply_to_id" : 572397573,
      "line" : 3215,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDQwMzU5Ng==",
      "original_commit_id" : "0280274368e2df7c7832549cd581c710875a6be1",
      "original_line" : 3215,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 41,
      "pull_request_review_id" : 588430337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574403596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575529707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575529707"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Avoid pruning below the blockfilterindex sync height\" (14c95089fe9727794c1a6101d5cedaca54292bb7)\r\n\r\nPretending `last_prune` as the chain height may be safe, because the only side effect is to not prune blocks that could be pruned, but it is confusing, and also creates a difference in behavior between the manual prune case which uses the real height and this case which pretends the min index sync height is the height.\r\n\r\nIf this behavior is going to be kept, there should be an explanatory comment because it looks broken, and not obviously broken in a safe way instead of a dangerous way.\r\n\r\nBut better than adding a comment would be to make the code straightforward: Stop passing `last_prune` as `chain_tip_height`. Instead, continue passing `m_chain.Height()` as `chain_tip_height`, pass `last_prune` as `prune_height`, and assign `nLastBlockWeCanPrune = min(prune_height, chain_tip_height - MIN_BLOCKS_TO_KEEP)` inside `FindFilesToPrune`. This would be more consistent with the logic in `FindFilesToPruneManual`, as well as more efficient, and more obviously correct.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-12T21:30:12Z",
      "diff_hunk" : "@@ -2249,17 +2250,25 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int last_prune = m_chain.Height(); // last height we can prune\n+            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n+               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n+            });\n+\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, std::min(last_prune, nManualPruneHeight), m_chain.Height());\n             } else {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), m_chain.Height(), IsInitialBlockDownload());\n+                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), last_prune, IsInitialBlockDownload());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575529707",
      "id" : 575529707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTUyOTcwNw==",
      "original_commit_id" : "14c95089fe9727794c1a6101d5cedaca54292bb7",
      "original_line" : 2271,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 589849530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575529707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575840775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575840775"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425:\r\n\r\nDescription needs an update.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-14T17:43:09Z",
      "diff_hunk" : "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575840775",
      "id" : 575840775,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg0MDc3NQ==",
      "original_commit_id" : "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/feature_blockfilterindex_prune.py",
      "position" : null,
      "pull_request_review_id" : 590069277,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575840775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575841826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575841826"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425:\r\n\r\nnit: \"...but no blocks are actually pruned\"",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-14T17:50:51Z",
      "diff_hunk" : "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+    assert_greater_than,\n+)\n+\n+class FeatureBlockfilterindexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-fastprune\", \"-prune=1\"], [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"]]\n+\n+    def run_test(self):\n+        # test basic pruning compatibility & filter access of pruned blocks\n+        self.log.info(\"check if we can access a blockfilter when pruning is enabled but no actual pruned blocks\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575841826",
      "id" : 575841826,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg0MTgyNg==",
      "original_commit_id" : "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
      "original_line" : 19,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "test/functional/feature_blockfilterindex_prune.py",
      "position" : null,
      "pull_request_review_id" : 590069277,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575841826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575846927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575846927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in b5c243c:\r\n\r\nSuggested addition\r\n\r\n```suggestion\r\n        self.log.info(\"make sure the node starts again with the -reindex arg\")\r\n        reindex_args = self.extra_args[1]\r\n        reindex_args.append(\"-reindex\")\r\n        self.start_node(1, extra_args=reindex_args)\r\n```",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-14T18:35:18Z",
      "diff_hunk" : "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+    assert_greater_than,\n+)\n+\n+class FeatureBlockfilterindexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-fastprune\", \"-prune=1\"], [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"]]\n+\n+    def run_test(self):\n+        # test basic pruning compatibility & filter access of pruned blocks\n+        self.log.info(\"check if we can access a blockfilter when pruning is enabled but no actual pruned blocks\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getbestblockhash())['filter']) > 0)\n+        self.nodes[1].generate(500)\n+        self.sync_all()\n+        self.log.info(\"prune some blocks\")\n+        pruneheight = self.nodes[1].pruneblockchain(400)\n+        assert(pruneheight != 0)\n+        self.log.info(\"check if we can access the tips blockfilter when we have pruned some blocks\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getbestblockhash())['filter']) > 0)\n+        self.log.info(\"check if we can access the blockfilter of a pruned block\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getblockhash(2))['filter']) > 0)\n+        self.log.info(\"start node without blockfilterindex\")\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=self.extra_args[0])\n+        self.log.info(\"make sure accessing the blockfilters throws an error\")\n+        assert_raises_rpc_error(-1,\"Index is not enabled for filtertype basic\", self.nodes[1].getblockfilter, self.nodes[1].getblockhash(2))\n+        self.nodes[1].generate(1000)\n+        self.log.info(\"prune below the blockfilterindexes best block while blockfilters are disabled\")\n+        pruneheight_new = self.nodes[1].pruneblockchain(1000)\n+        assert_greater_than(pruneheight_new, pruneheight)\n+        self.stop_node(1)\n+        self.log.info(\"make sure we get an init error when starting the node again with block filters\")\n+        self.nodes[1].assert_start_raises_init_error(extra_args=self.extra_args[1])\n+        self.nodes[1].assert_debug_log([\"basic block filter index best block of the index goes beyond pruned data. Please disable the index or reindex (which will download the whole blockchain again)\"])\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575846927",
      "id" : 575846927,
      "line" : 47,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg0NjkyNw==",
      "original_commit_id" : "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
      "original_line" : 47,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "test/functional/feature_blockfilterindex_prune.py",
      "position" : 47,
      "pull_request_review_id" : 590069277,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575846927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674356"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674356"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. That makes sense. Implemented now as suggested by @ryanofsky.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-16T09:31:38Z",
      "diff_hunk" : "@@ -2249,17 +2250,25 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int last_prune = m_chain.Height(); // last height we can prune\n+            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n+               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n+            });\n+\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, std::min(last_prune, nManualPruneHeight), m_chain.Height());\n             } else {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), m_chain.Height(), IsInitialBlockDownload());\n+                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), last_prune, IsInitialBlockDownload());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674356",
      "id" : 576674356,
      "in_reply_to_id" : 575529707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY3NDM1Ng==",
      "original_commit_id" : "14c95089fe9727794c1a6101d5cedaca54292bb7",
      "original_line" : 2271,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 591035351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674356",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674458"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for spotting. Fixed.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-16T09:31:47Z",
      "diff_hunk" : "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674458",
      "id" : 576674458,
      "in_reply_to_id" : 575840775,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY3NDQ1OA==",
      "original_commit_id" : "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/feature_blockfilterindex_prune.py",
      "position" : null,
      "pull_request_review_id" : 591035690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-16T09:31:53Z",
      "diff_hunk" : "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+    assert_greater_than,\n+)\n+\n+class FeatureBlockfilterindexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-fastprune\", \"-prune=1\"], [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"]]\n+\n+    def run_test(self):\n+        # test basic pruning compatibility & filter access of pruned blocks\n+        self.log.info(\"check if we can access a blockfilter when pruning is enabled but no actual pruned blocks\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674509",
      "id" : 576674509,
      "in_reply_to_id" : 575841826,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY3NDUwOQ==",
      "original_commit_id" : "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
      "original_line" : 19,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "test/functional/feature_blockfilterindex_prune.py",
      "position" : null,
      "pull_request_review_id" : 591035862,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:31:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added that additional test.",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-16T09:32:06Z",
      "diff_hunk" : "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+    assert_greater_than,\n+)\n+\n+class FeatureBlockfilterindexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-fastprune\", \"-prune=1\"], [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"]]\n+\n+    def run_test(self):\n+        # test basic pruning compatibility & filter access of pruned blocks\n+        self.log.info(\"check if we can access a blockfilter when pruning is enabled but no actual pruned blocks\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getbestblockhash())['filter']) > 0)\n+        self.nodes[1].generate(500)\n+        self.sync_all()\n+        self.log.info(\"prune some blocks\")\n+        pruneheight = self.nodes[1].pruneblockchain(400)\n+        assert(pruneheight != 0)\n+        self.log.info(\"check if we can access the tips blockfilter when we have pruned some blocks\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getbestblockhash())['filter']) > 0)\n+        self.log.info(\"check if we can access the blockfilter of a pruned block\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getblockhash(2))['filter']) > 0)\n+        self.log.info(\"start node without blockfilterindex\")\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=self.extra_args[0])\n+        self.log.info(\"make sure accessing the blockfilters throws an error\")\n+        assert_raises_rpc_error(-1,\"Index is not enabled for filtertype basic\", self.nodes[1].getblockfilter, self.nodes[1].getblockhash(2))\n+        self.nodes[1].generate(1000)\n+        self.log.info(\"prune below the blockfilterindexes best block while blockfilters are disabled\")\n+        pruneheight_new = self.nodes[1].pruneblockchain(1000)\n+        assert_greater_than(pruneheight_new, pruneheight)\n+        self.stop_node(1)\n+        self.log.info(\"make sure we get an init error when starting the node again with block filters\")\n+        self.nodes[1].assert_start_raises_init_error(extra_args=self.extra_args[1])\n+        self.nodes[1].assert_debug_log([\"basic block filter index best block of the index goes beyond pruned data. Please disable the index or reindex (which will download the whole blockchain again)\"])\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674666",
      "id" : 576674666,
      "in_reply_to_id" : 575846927,
      "line" : 47,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY3NDY2Ng==",
      "original_commit_id" : "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
      "original_line" : 47,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "test/functional/feature_blockfilterindex_prune.py",
      "position" : 47,
      "pull_request_review_id" : 591036380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T09:32:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @ryanofsky and @fjahr! Fixed the reported points. Thanks for a quick retest.",
      "created_at" : "2021-02-16T09:37:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-779710204",
      "id" : 779710204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTcxMDIwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T09:37:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779710204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review ACK 84716b1\r\n\r\nChecked that only changes since last review were small improvements on the functional test and the added parameter to `FindFilesToPrune()`.",
      "created_at" : "2021-02-17T22:23:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-780894327",
      "id" : 780894327,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDg5NDMyNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-17T22:23:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780894327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r580924696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/580924696"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this making blockfilterindex part of validation code?",
      "commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "created_at" : "2021-02-23T10:31:52Z",
      "diff_hunk" : "@@ -17,6 +17,7 @@\n #include <cuckoocache.h>\n #include <flatfile.h>\n #include <hash.h>\n+#include <index/blockfilterindex.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r580924696",
      "id" : 580924696,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDkyNDY5Ng==",
      "original_commit_id" : "84716b134e9afca2fba7731de4af1f22fa1b1518",
      "original_line" : 20,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 596190423,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-23T10:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/580924696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This change was part of 22.0, removing \"Needs release note\".",
      "created_at" : "2022-09-15T15:13:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-1248243208",
      "id" : 1248243208,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
      "node_id" : "IC_kwDOABII585KZq4I",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1248243208/reactions"
      },
      "updated_at" : "2022-09-15T15:13:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1248243208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
