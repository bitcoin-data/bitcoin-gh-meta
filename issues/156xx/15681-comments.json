[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16409](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16409.html) (Remove mempool expiry, treat txs as replaceable instead by MarcoFalke)\n* [#16401](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16401.html) (Package relay by sdaftuar)\n* [#16400](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16400.html) ([refactor] Rewrite AcceptToMemoryPoolWorker() using smaller parts by sdaftuar)\n* [#16398](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16398.html) (rpc: testmempoolaccept for list of transactions by MarcoFalke)\n* [#15921](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15921.html) (Tidy up ValidationState interface by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-03-28T05:51:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-477458316",
      "id" : 477458316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NzQ1ODMxNg==",
      "updated_at" : "2019-07-18T20:23:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/477458316",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270087859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270087859"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm still chewing on the comment above, but doesn't this line let transactions >40k weight through no matter what?",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-03-28T16:23:20Z",
      "diff_hunk" : "@@ -761,7 +761,14 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         size_t nLimitDescendantSize = gArgs.GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT)*1000;\n         std::string errString;\n         if (!pool.CalculateMemPoolAncestors(entry, setAncestors, nLimitAncestors, nLimitAncestorSize, nLimitDescendants, nLimitDescendantSize, errString)) {\n-            return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n+            setAncestors.clear();\n+            // If the new transaction is relatively small (up to 40k weight)\n+            // and has at most one ancestor (ie ancestor limit of 2, including\n+            // the new transaction), allow it if its parent has exactly the\n+            // descendant limit descendants.\n+            if (nSize <= 10000 && !pool.CalculateMemPoolAncestors(entry, setAncestors, 2, 1000000, nLimitDescendants + 1, nLimitDescendantSize + 10000, errString)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270087859",
      "id" : 270087859,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MDA4Nzg1OQ==",
      "original_commit_id" : "e7e46b3001c10cffa0edcf959fa894d9e6caa56f",
      "original_position" : 10,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 220131280,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270087859",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270106458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270106458"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Lol, oops, one of these days I'll learn to code.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-03-28T17:04:55Z",
      "diff_hunk" : "@@ -761,7 +761,14 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         size_t nLimitDescendantSize = gArgs.GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT)*1000;\n         std::string errString;\n         if (!pool.CalculateMemPoolAncestors(entry, setAncestors, nLimitAncestors, nLimitAncestorSize, nLimitDescendants, nLimitDescendantSize, errString)) {\n-            return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n+            setAncestors.clear();\n+            // If the new transaction is relatively small (up to 40k weight)\n+            // and has at most one ancestor (ie ancestor limit of 2, including\n+            // the new transaction), allow it if its parent has exactly the\n+            // descendant limit descendants.\n+            if (nSize <= 10000 && !pool.CalculateMemPoolAncestors(entry, setAncestors, 2, 1000000, nLimitDescendants + 1, nLimitDescendantSize + 10000, errString)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270106458",
      "id" : 270106458,
      "in_reply_to_id" : 270087859,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MDEwNjQ1OA==",
      "original_commit_id" : "e7e46b3001c10cffa0edcf959fa894d9e6caa56f",
      "original_position" : 10,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 220155486,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270106458",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270107357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270107357"
         }
      },
      "author_association" : "MEMBER",
      "body" : "did the tests work? ;D",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-03-28T17:07:04Z",
      "diff_hunk" : "@@ -761,7 +761,14 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         size_t nLimitDescendantSize = gArgs.GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT)*1000;\n         std::string errString;\n         if (!pool.CalculateMemPoolAncestors(entry, setAncestors, nLimitAncestors, nLimitAncestorSize, nLimitDescendants, nLimitDescendantSize, errString)) {\n-            return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n+            setAncestors.clear();\n+            // If the new transaction is relatively small (up to 40k weight)\n+            // and has at most one ancestor (ie ancestor limit of 2, including\n+            // the new transaction), allow it if its parent has exactly the\n+            // descendant limit descendants.\n+            if (nSize <= 10000 && !pool.CalculateMemPoolAncestors(entry, setAncestors, 2, 1000000, nLimitDescendants + 1, nLimitDescendantSize + 10000, errString)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270107357",
      "id" : 270107357,
      "in_reply_to_id" : 270087859,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MDEwNzM1Nw==",
      "original_commit_id" : "e7e46b3001c10cffa0edcf959fa894d9e6caa56f",
      "original_position" : 10,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 220156680,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270107357",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270107733"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270107733"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Add a test that blowing the 40k weight makes it fail?",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-03-28T17:07:53Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carge-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0001\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for i in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for i in range(MAX_ANCESTORS - 4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [0], value, fee, 1)\n+            value = sent_value\n+            chain.append([txid, value])\n+        (second_chain, second_chain_value) = self.chain_transaction(self.nodes[0], [utxo[1]['txid']], [utxo[1]['vout']], utxo[1]['amount'], fee, 1)\n+\n+        # Check mempool has MAX_ANCESTORS transactions in it, and descendant and ancestor\n+        # count and fees should look correct\n+        assert_equal(len(self.nodes[0].getrawmempool(True)), MAX_ANCESTORS + 1)\n+\n+        # Adding one more transaction on to the chain should fail.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [txid], [0], value, fee, 1)\n+        # ...even if it chains on from some point in the middle of the chain.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[2][0]], [1], chain[2][1], fee, 1)\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[1][0]], [1], chain[1][1], fee, 1)\n+        # ...even if it chains on to two parent transactions with one in the chain.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[0][0], second_chain], [1, 0], chain[0][1] + second_chain_value, fee, 1)\n+        # But not if it chains directly off the first transaction\n+        self.chain_transaction(self.nodes[0], [chain[0][0]], [1], chain[0][1], fee, 1)\n+        # and the second chain should work just fine\n+        self.chain_transaction(self.nodes[0], [second_chain], [0], second_chain_value, fee, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270107733",
      "id" : 270107733,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MDEwNzczMw==",
      "original_commit_id" : "a3053fd871a857fe3394554ea4d48a7d845193c6",
      "original_position" : 79,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 80,
      "pull_request_review_id" : 220157140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270107733",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270130965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270130965"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done!",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-03-28T17:59:36Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carge-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0001\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for i in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for i in range(MAX_ANCESTORS - 4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [0], value, fee, 1)\n+            value = sent_value\n+            chain.append([txid, value])\n+        (second_chain, second_chain_value) = self.chain_transaction(self.nodes[0], [utxo[1]['txid']], [utxo[1]['vout']], utxo[1]['amount'], fee, 1)\n+\n+        # Check mempool has MAX_ANCESTORS transactions in it, and descendant and ancestor\n+        # count and fees should look correct\n+        assert_equal(len(self.nodes[0].getrawmempool(True)), MAX_ANCESTORS + 1)\n+\n+        # Adding one more transaction on to the chain should fail.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [txid], [0], value, fee, 1)\n+        # ...even if it chains on from some point in the middle of the chain.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[2][0]], [1], chain[2][1], fee, 1)\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[1][0]], [1], chain[1][1], fee, 1)\n+        # ...even if it chains on to two parent transactions with one in the chain.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[0][0], second_chain], [1, 0], chain[0][1] + second_chain_value, fee, 1)\n+        # But not if it chains directly off the first transaction\n+        self.chain_transaction(self.nodes[0], [chain[0][0]], [1], chain[0][1], fee, 1)\n+        # and the second chain should work just fine\n+        self.chain_transaction(self.nodes[0], [second_chain], [0], second_chain_value, fee, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r270130965",
      "id" : 270130965,
      "in_reply_to_id" : 270107733,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MDEzMDk2NQ==",
      "original_commit_id" : "a3053fd871a857fe3394554ea4d48a7d845193c6",
      "original_position" : 79,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 80,
      "pull_request_review_id" : 220186213,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270130965",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "CC @rustyrussell.",
      "created_at" : "2019-03-28T18:20:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-477715211",
      "id" : 477715211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NzcxNTIxMQ==",
      "updated_at" : "2019-03-28T18:20:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/477715211",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r271166377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271166377"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be \"carve\" :-)",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-04-02T07:35:12Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carge-out allowing one final transaction in",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r271166377",
      "id" : 271166377,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTE2NjM3Nw==",
      "original_commit_id" : "891ae7b1c4d8f42bdf27baeedb516104bf04519b",
      "original_position" : 5,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : null,
      "pull_request_review_id" : 221489381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271166377",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r271167067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271167067"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: This method doesn't use `self`: could be made a function?",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-04-02T07:37:21Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carge-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r271167067",
      "id" : 271167067,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTE2NzA2Nw==",
      "original_commit_id" : "891ae7b1c4d8f42bdf27baeedb516104bf04519b",
      "original_position" : 28,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 28,
      "pull_request_review_id" : 221490257,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271167067",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r271167375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271167375"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: `for _` is more idiomatic when `_` is unused :-)  Applies also for the other `for i`:s below :-)",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-04-02T07:38:19Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carge-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r271167375",
      "id" : 271167375,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTE2NzM3NQ==",
      "original_commit_id" : "891ae7b1c4d8f42bdf27baeedb516104bf04519b",
      "original_position" : 34,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 34,
      "pull_request_review_id" : 221490640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271167375",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r274493113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274493113"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please expand significantly on the rationale for this change because its a weird little bit of added complication, and basically the only downside is people not understanding why it's there.  You could link to the mailing list post maybe.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-04-11T15:48:40Z",
      "diff_hunk" : "@@ -761,7 +761,14 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         size_t nLimitDescendantSize = gArgs.GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT)*1000;\n         std::string errString;\n         if (!pool.CalculateMemPoolAncestors(entry, setAncestors, nLimitAncestors, nLimitAncestorSize, nLimitDescendants, nLimitDescendantSize, errString)) {\n-            return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n+            setAncestors.clear();\n+            // If the new transaction is relatively small (up to 40k weight)\n+            // and has at most one ancestor (ie ancestor limit of 2, including\n+            // the new transaction), allow it if its parent has exactly the\n+            // descendant limit descendants.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r274493113",
      "id" : 274493113,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDQ5MzExMw==",
      "original_commit_id" : "891ae7b1c4d8f42bdf27baeedb516104bf04519b",
      "original_position" : 9,
      "path" : "src/validation.cpp",
      "position" : 9,
      "pull_request_review_id" : 225624111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274493113",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/4360349?v=4",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "node_id" : "MDQ6VXNlcjQzNjAzNDk=",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-05-04T10:54:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-489316464",
      "id" : 489316464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4OTMxNjQ2NA==",
      "updated_at" : "2019-05-04T10:54:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/489316464",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r299023410"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299023410"
         }
      },
      "author_association" : "NONE",
      "body" : "@TheBlueMatt I have a spill-over question from the PR review club which covered this PR last week. I am unsure of why the LimitAncestorSize for the carve-out tx has been increased to the block-size. \r\n\r\nEDIT: @harding has helped tidy up my understanding of this: \r\n\r\nIn the case of a (to-be-fee-bumped) LN parent TX with two hooks (A and B), which is close or equal to the descendant-size-limit, only a single (carve-out) child can be accepted, since the initial package size limit has been reached with the parent TX alone. This would seem like a race between A and B for the carve-out.\r\n\r\nIn regards to the 1M ancestor-size-limit for the carve-out, is it increased to 1M to prevent the ancestor-size-limit from interfering with the carve-out? I suppose this prevents a custom ancestor-size-limit setting from blocking the carve-out and subsequent network propagation.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-01T12:41:26Z",
      "diff_hunk" : "@@ -761,7 +761,14 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         size_t nLimitDescendantSize = gArgs.GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT)*1000;\n         std::string errString;\n         if (!pool.CalculateMemPoolAncestors(entry, setAncestors, nLimitAncestors, nLimitAncestorSize, nLimitDescendants, nLimitDescendantSize, errString)) {\n-            return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n+            setAncestors.clear();\n+            // If the new transaction is relatively small (up to 40k weight)\n+            // and has at most one ancestor (ie ancestor limit of 2, including\n+            // the new transaction), allow it if its parent has exactly the\n+            // descendant limit descendants.\n+            if (nSize <= 10000 && !pool.CalculateMemPoolAncestors(entry, setAncestors, 2, 1000000, nLimitDescendants + 1, nLimitDescendantSize + 10000, errString)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r299023410",
      "id" : 299023410,
      "in_reply_to_id" : 270087859,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTAyMzQxMA==",
      "original_commit_id" : "e7e46b3001c10cffa0edcf959fa894d9e6caa56f",
      "original_position" : 10,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 256311555,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299023410",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/26572234?v=4",
         "events_url" : "https://api.github.com/users/jachiang/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jachiang/followers",
         "following_url" : "https://api.github.com/users/jachiang/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jachiang/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jachiang",
         "id" : 26572234,
         "login" : "jachiang",
         "node_id" : "MDQ6VXNlcjI2NTcyMjM0",
         "organizations_url" : "https://api.github.com/users/jachiang/orgs",
         "received_events_url" : "https://api.github.com/users/jachiang/received_events",
         "repos_url" : "https://api.github.com/users/jachiang/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jachiang/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jachiang/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jachiang"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r299279645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299279645"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Indeed, we don't really care about the size of the ancestor transaction here (its limited to the standard single-tx size limit, or 100k today), so I just set it to 1M, we already check that there is only, at max, one unconfirmed parent.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-02T02:13:08Z",
      "diff_hunk" : "@@ -761,7 +761,14 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         size_t nLimitDescendantSize = gArgs.GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT)*1000;\n         std::string errString;\n         if (!pool.CalculateMemPoolAncestors(entry, setAncestors, nLimitAncestors, nLimitAncestorSize, nLimitDescendants, nLimitDescendantSize, errString)) {\n-            return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n+            setAncestors.clear();\n+            // If the new transaction is relatively small (up to 40k weight)\n+            // and has at most one ancestor (ie ancestor limit of 2, including\n+            // the new transaction), allow it if its parent has exactly the\n+            // descendant limit descendants.\n+            if (nSize <= 10000 && !pool.CalculateMemPoolAncestors(entry, setAncestors, 2, 1000000, nLimitDescendants + 1, nLimitDescendantSize + 10000, errString)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r299279645",
      "id" : 299279645,
      "in_reply_to_id" : 270087859,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTI3OTY0NQ==",
      "original_commit_id" : "e7e46b3001c10cffa0edcf959fa894d9e6caa56f",
      "original_position" : 10,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 256636097,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299279645",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Resolved comments.",
      "created_at" : "2019-07-02T02:13:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-507490217",
      "id" : 507490217,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwNzQ5MDIxNw==",
      "updated_at" : "2019-07-02T02:13:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/507490217",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nI did some review and light testing, and I noticed that there seems to be a general problem with our RBF logic: if we have some parent transaction whose descendant count is maxed out in the mempool, then we're unable to rbf any child transaction, because we evaluate the descendant limits of a new transactions ancestors prior to looking at what might be evicted by that transaction.  (However, we can generally RBF the parent itself!)\r\n\r\nSo in particular, that means that the new transaction that would be carved out by this policy would not be able to be RBF'ed in the situation that the parent transactions' descendant limit has been reached.\r\n\r\nI'm guessing we may want to fix that to provide additional footgun protection to users that would take advantage of this new behavior, though I'll leave it to the PR author to decide if it is worth doing in this PR or separately.",
      "created_at" : "2019-07-03T18:30:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-508207606",
      "id" : 508207606,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwODIwNzYwNg==",
      "updated_at" : "2019-07-03T18:30:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/508207606",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Might be worth adding an explicit test case for RBF case @sdaftuar points out:\r\n\r\n             # But not if it chains directly off the first transaction\r\n             self.chain_transaction(self.nodes[0], [chain[0][0]], [1], chain[0][1], fee, 1)\r\n    +\r\n    +        # Sadly, RBFing that should fail, however\r\n    +        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, 0, [chain[0][0]], [1], chain[0][1], fee*2, 1)\r\n    +\r\n             # and the second chain should work just fine\r\n             self.chain_transaction(self.nodes[0], [second_chain], [0], second_chain_value, fee, 1)\r\n\r\n(means `createrawtransaction` needs to be called with `replaceable=True` as well)\r\n\r\nCould change `chain_transaction(self, node, ...)` to always use `node=self.nodes[0]` which would simplify calls, and deal with @practicalswift's nit.\r\n\r\nCould define a const for the 10k magic number. Is there any reason to have 1M instead of reusing `nLimitAncestorSize`? (Could not allow the carve out at all if `nLimitAncestors <= 1` though that's probably getting a bit ridiculous)\r\n\r\nI think this should work for two-party lightning channels, because the outputs will be a bunch of CSV-limited ones that won't be in the mempool, and one CPFP output for each party. So at most one output can be spammed, and that only up to the descendent limit, so the plus-one here should work fine. If there were three or more immediately-spendable outputs (for channel factories and multiparty eltoo eg), I don't think this would be enough. But that's fine today.\r\n\r\nI guess it's not very useful to log when this carve out triggers -- it's meant to prevent attacks from being effective, so while it's there there won't be any attacks so it'll hardly ever be used, but if it weren't there there would be attacks and it would be useful.\r\n\r\nShould this carve out be limited to only apply when it's actually raising the parent's effective fee rate? I think you'd have to loop over all the descendents of your parent, work out the best ancestor fee rate of any of them, then see if the new tx and the parent have a better combined fee rate than that. That seems like it would add a chunk of complexity though, so probably isn't worth it.\r\n\r\nThis seems like it's a sufficient workaround for current problems, and is a pretty minimal change, while doing anything much better would be lots more complicated. So: Approach ACK.",
      "created_at" : "2019-07-08T09:15:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-509146925",
      "id" : 509146925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwOTE0NjkyNQ==",
      "updated_at" : "2019-07-08T09:15:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/509146925",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r300998383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300998383"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're only ever using node 0 in this test",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-08T09:23:27Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r300998383",
      "id" : 300998383,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMDk5ODM4Mw==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 21,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : null,
      "pull_request_review_id" : 258782978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/300998383",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301303685"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301303685"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can these constants be named, or at least explained? It seems like 10000 is the 40k weight limit, and 1000000 is just a big number?",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-08T21:16:54Z",
      "diff_hunk" : "@@ -610,7 +610,20 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         size_t nLimitDescendantSize = gArgs.GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT)*1000;\n         std::string errString;\n         if (!pool.CalculateMemPoolAncestors(entry, setAncestors, nLimitAncestors, nLimitAncestorSize, nLimitDescendants, nLimitDescendantSize, errString)) {\n-            return state.Invalid(ValidationInvalidReason::TX_MEMPOOL_POLICY, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", errString);\n+            setAncestors.clear();\n+            // If the new transaction is relatively small (up to 40k weight)\n+            // and has at most one ancestor (ie ancestor limit of 2, including\n+            // the new transaction), allow it if its parent has exactly the\n+            // descendant limit descendants.\n+            //\n+            // This allows protocols which rely on distrusting counterparties\n+            // being able to broadcast descendants of an unconfirmed transaction\n+            // to be secure by simply only having two immediately-spendable\n+            // outputs - one for each counterparty. For more info on the uses for\n+            // this, see https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2018-November/016518.html\n+            if (nSize > 10000 || !pool.CalculateMemPoolAncestors(entry, setAncestors, 2, 1000000, nLimitDescendants + 1, nLimitDescendantSize + 10000, errString)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301303685",
      "id" : 301303685,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTMwMzY4NQ==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 16,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 259161381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301303685",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301309941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301309941"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not great how this function and the test setup here is mostly duplicated from mempool_packages.py. Someone could clean it up later, though.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-08T21:34:11Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301309941",
      "id" : 301309941,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTMwOTk0MQ==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 28,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 28,
      "pull_request_review_id" : 259161381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301309941",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301315975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301315975"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Having two basically identical loops just to add an extra output to the first four transactions seems like an odd choice. Maybe prefer\r\n\r\n```python\r\nfor depth in range(MAX_ANCESTORS):\r\n    num_outputs = 2 if depth < 4 else 1\r\n    ...\r\n```",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-08T21:51:50Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0002\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for _ in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for _ in range(MAX_ANCESTORS - 4):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301315975",
      "id" : 301315975,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTMxNTk3NQ==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 59,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 59,
      "pull_request_review_id" : 259161381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301315975",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301316322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301316322"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Stale comment from the old test, now MAX_ANCESTORS+1",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-08T21:52:55Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0002\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for _ in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for _ in range(MAX_ANCESTORS - 4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [0], value, fee, 1)\n+            value = sent_value\n+            chain.append([txid, value])\n+        (second_chain, second_chain_value) = self.chain_transaction(self.nodes[0], [utxo[1]['txid']], [utxo[1]['vout']], utxo[1]['amount'], fee, 1)\n+\n+        # Check mempool has MAX_ANCESTORS transactions in it, and descendant and ancestor",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301316322",
      "id" : 301316322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTMxNjMyMg==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 65,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : null,
      "pull_request_review_id" : 259161381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301316322",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301317145"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301317145"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "These tests would be more readable, and zip() above could be dropped if chain_transaction just took a list of txid/nout tuples ",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-08T21:55:33Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0002\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for _ in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for _ in range(MAX_ANCESTORS - 4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [0], value, fee, 1)\n+            value = sent_value\n+            chain.append([txid, value])\n+        (second_chain, second_chain_value) = self.chain_transaction(self.nodes[0], [utxo[1]['txid']], [utxo[1]['vout']], utxo[1]['amount'], fee, 1)\n+\n+        # Check mempool has MAX_ANCESTORS transactions in it, and descendant and ancestor\n+        # count and fees should look correct\n+        assert_equal(len(self.nodes[0].getrawmempool(True)), MAX_ANCESTORS + 1)\n+\n+        # Adding one more transaction on to the chain should fail.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [txid], [0], value, fee, 1)\n+        # ...even if it chains on from some point in the middle of the chain.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[2][0]], [1], chain[2][1], fee, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301317145",
      "id" : 301317145,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTMxNzE0NQ==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 72,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 71,
      "pull_request_review_id" : 259161381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301317145",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301317939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301317939"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Imo, tests below would be more reable if this were\r\n\r\n```python\r\nchain.append(txid)\r\nvalues.append(value)\r\n```\r\n\r\nto get rid of all the 0/1 indexing",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-08T21:58:05Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0002\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for _ in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for _ in range(MAX_ANCESTORS - 4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [0], value, fee, 1)\n+            value = sent_value\n+            chain.append([txid, value])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301317939",
      "id" : 301317939,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTMxNzkzOQ==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 62,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 62,
      "pull_request_review_id" : 259161381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301317939",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301515952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301515952"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW, I thought the way it is seemed more readable. YMMV obviously :)",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-09T10:37:02Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0002\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for _ in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for _ in range(MAX_ANCESTORS - 4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [0], value, fee, 1)\n+            value = sent_value\n+            chain.append([txid, value])\n+        (second_chain, second_chain_value) = self.chain_transaction(self.nodes[0], [utxo[1]['txid']], [utxo[1]['vout']], utxo[1]['amount'], fee, 1)\n+\n+        # Check mempool has MAX_ANCESTORS transactions in it, and descendant and ancestor\n+        # count and fees should look correct\n+        assert_equal(len(self.nodes[0].getrawmempool(True)), MAX_ANCESTORS + 1)\n+\n+        # Adding one more transaction on to the chain should fail.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [txid], [0], value, fee, 1)\n+        # ...even if it chains on from some point in the middle of the chain.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[2][0]], [1], chain[2][1], fee, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301515952",
      "id" : 301515952,
      "in_reply_to_id" : 301317145,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTUxNTk1Mg==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 72,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 71,
      "pull_request_review_id" : 259414227,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301515952",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301762770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301762770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I find this more readable.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-09T19:46:44Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0002\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for _ in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for _ in range(MAX_ANCESTORS - 4):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301762770",
      "id" : 301762770,
      "in_reply_to_id" : 301315975,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTc2Mjc3MA==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 59,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 59,
      "pull_request_review_id" : 259721026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301762770",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301762789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301762789"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-09T19:46:47Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r301762789",
      "id" : 301762789,
      "in_reply_to_id" : 300998383,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTc2Mjc4OQ==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 21,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : null,
      "pull_request_review_id" : 259721049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-09T19:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301762789",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ajtowns I'd prefer to not add the proposed test change, as @sdaftuar's comment points out a critical limitation, and one I'd like to get resolved before this gets released, though not necessarily in this PR. I'd rather just fix the bug than add a test to ensure that the bug exists.\r\n\r\nAs for general policy questions: this doesn't result in any new transactions being accepted which violate min fee, nor does it change eviction criteria when mempool fills. What this *does* do, is tweak our already-somewhat-arbitrary-but-sadly-neccessary anti-DoS policies to allow one more (potentially-in-the-future) common case so that we can maximize fee revenue in the case this does get used. Thus, I don't see any reason to need to bend over backwards to make it more restrictive, if anything, less restrictive is better.",
      "created_at" : "2019-07-09T19:46:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-509781430",
      "id" : 509781430,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwOTc4MTQzMA==",
      "updated_at" : "2019-07-09T19:46:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/509781430",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "created_at" : "2019-07-12T15:05:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-510921351",
      "id" : 510921351,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMDkyMTM1MQ==",
      "updated_at" : "2019-07-12T15:05:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/510921351",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 50cede3f5a4d4fbfbb7c420b94e661a6a159bced -- looked over code again, compared with previous commit, compiles, etc.\r\n\r\nI think this is a sufficient improvement even with the problem @sdaftuar points out:\r\n\r\n * if there's no adversarial situation and you hit the descendent limit with low fee children just due to carelessness, this carveout can be used to RBF the first child (paying 25 times the feerate to account for the descendants' fees) and make CPFP actually work in ways where you can't do anything now\r\n * in the event of an adversarial situation with only two immediately spendable outputs, if you do the CPFP first, they can't block you from RBF'ing when you need to (they can't make use of the onemore carve out if they only have one output available -- they need to use it to hit the descant limit, at which point it's not available for onemore).\r\n * to DoS their channel partner, an adversary would need to be confident their partner will CPFP by too small an amount, and do their spam low-fee tx spamming before they do that. If the CPFP is a high enough amount, they'll likely lose the fees for their spam once the mempool clears out, making that not a free attack, as well.\r\n\r\nIt would obviously still be better to find a more general fix, but this seems to me a worthwhile improvement without introducing much of a maintenance cost.",
      "created_at" : "2019-07-16T11:02:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-511770170",
      "id" : 511770170,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMTc3MDE3MA==",
      "updated_at" : "2019-07-16T11:02:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/511770170",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Patch to `mempool_package_onemore.py` for checking the \"can RBF if I've added too many descendants myself\" case. Maybe useful for reviewers, not suitable for inclusion since it kills the checks for the intended usecase:\r\n\r\n```diff\r\n+++ b/test/functional/mempool_package_onemore.py\r\n@@ -33,7 +33,7 @@ class MempoolPackagesTest(BitcoinTestFramework):\r\n         outputs = {}\r\n         for i in range(num_outputs):\r\n             outputs[node.getnewaddress()] = send_value\r\n-        rawtx = node.createrawtransaction(inputs, outputs)\r\n+        rawtx = node.createrawtransaction(inputs, outputs, 0, True)\r\n         signedtx = node.signrawtransactionwithwallet(rawtx)\r\n         txid = node.sendrawtransaction(signedtx['hex'])\r\n         fulltx = node.getrawtransaction(txid, 1)\r\n@@ -74,6 +74,12 @@ class MempoolPackagesTest(BitcoinTestFramework):\r\n         assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[0][0], second_chain], [1, 0], chain[0][1] + second_chain_value, fee, 1)\r\n         # ...especially if its > 40k weight\r\n         assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[0][0]], [1], chain[0][1], fee, 350)\r\n+\r\n+        # can even RBF the original tx\r\n+        self.chain_transaction(self.nodes[0], [chain[0][0]], [0], chain[0][1], fee*25, 10)\r\n+        assert_equal(len(self.nodes[0].getrawmempool(True)), 3) # parent, second_chain, RBF'd original\r\n+        return\r\n+\r\n         # But not if it chains directly off the first transaction\r\n         self.chain_transaction(self.nodes[0], [chain[0][0]], [1], chain[0][1], fee, 1)\r\n         # and the second chain should work just fine\r\n```",
      "created_at" : "2019-07-16T11:12:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-511772799",
      "id" : 511772799,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMTc3Mjc5OQ==",
      "updated_at" : "2019-07-16T11:12:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/511772799",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-19T17:45:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-513316913",
      "id" : 513316913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMzMxNjkxMw==",
      "updated_at" : "2019-07-19T17:45:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/513316913",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306013041"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306013041"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Passing `errString` through to the second call of `CalculateMemPoolAncestors()` means that the error string in the `CValidationState` object will be incorrect because of the changed ancestor/descendant size/count parameters. Really we should declare a `dummy_error_string` to pass into the second call, and use the original `errString` in the call to `state.Invalid()` below.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-22T20:16:23Z",
      "diff_hunk" : "@@ -610,7 +610,21 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         size_t nLimitDescendantSize = gArgs.GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT)*1000;\n         std::string errString;\n         if (!pool.CalculateMemPoolAncestors(entry, setAncestors, nLimitAncestors, nLimitAncestorSize, nLimitDescendants, nLimitDescendantSize, errString)) {\n-            return state.Invalid(ValidationInvalidReason::TX_MEMPOOL_POLICY, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", errString);\n+            setAncestors.clear();\n+            // If the new transaction is relatively small (up to 40k weight)\n+            // and has at most one ancestor (ie ancestor limit of 2, including\n+            // the new transaction), allow it if its parent has exactly the\n+            // descendant limit descendants.\n+            //\n+            // This allows protocols which rely on distrusting counterparties\n+            // being able to broadcast descendants of an unconfirmed transaction\n+            // to be secure by simply only having two immediately-spendable\n+            // outputs - one for each counterparty. For more info on the uses for\n+            // this, see https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2018-November/016518.html\n+            if (nSize >  EXTRA_DESCENDANT_TX_SIZE_LIMIT ||\n+                    !pool.CalculateMemPoolAncestors(entry, setAncestors, 2, nLimitAncestorSize, nLimitDescendants + 1, nLimitDescendantSize + EXTRA_DESCENDANT_TX_SIZE_LIMIT, errString)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306013041",
      "id" : 306013041,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjAxMzA0MQ==",
      "original_commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "original_position" : 17,
      "path" : "src/validation.cpp",
      "position" : 17,
      "pull_request_review_id" : 265031556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-22T20:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306013041",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306013773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306013773"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: virtual size (or define this in terms or transaction weight)",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-22T20:18:15Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306013773",
      "id" : 306013773,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjAxMzc3Mw==",
      "original_commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "original_position" : 7,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 7,
      "pull_request_review_id" : 265031556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-22T20:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306013773",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306015066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306015066"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: it's preferable to use named transactions to make the test more readable.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-22T20:21:26Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [[\"-maxorphantx=1000\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306015066",
      "id" : 306015066,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjAxNTA2Ng==",
      "original_commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "original_position" : 46,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 46,
      "pull_request_review_id" : 265031556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-22T20:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306015066",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306015585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306015585"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: name this class `MempoolPackageOnemoreTest`",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-22T20:22:45Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306015585",
      "id" : 306015585,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjAxNTU4NQ==",
      "original_commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "original_position" : 18,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 18,
      "pull_request_review_id" : 265031556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-22T20:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306015585",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306015631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306015631"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agree that this would be better as a function than a method",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-22T20:22:51Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carge-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306015631",
      "id" : 306015631,
      "in_reply_to_id" : 271167067,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjAxNTYzMQ==",
      "original_commit_id" : "891ae7b1c4d8f42bdf27baeedb516104bf04519b",
      "original_position" : 28,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 28,
      "pull_request_review_id" : 265031556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-22T20:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306015631",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306016033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306016033"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: name this variable `utxos` or define it as `self.nodes[0].listunspent(10)[0]`",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-22T20:23:44Z",
      "diff_hunk" : "@@ -0,0 +1,86 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [[\"-maxorphantx=1000\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306016033",
      "id" : 306016033,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjAxNjAzMw==",
      "original_commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "original_position" : 46,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 46,
      "pull_request_review_id" : 265031556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-22T20:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306016033",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306020081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306020081"
         }
      },
      "author_association" : "MEMBER",
      "body" : "+1, or used a namedtuple",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-22T20:34:03Z",
      "diff_hunk" : "@@ -0,0 +1,87 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carve-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0002\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for _ in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for _ in range(MAX_ANCESTORS - 4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [0], value, fee, 1)\n+            value = sent_value\n+            chain.append([txid, value])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306020081",
      "id" : 306020081,
      "in_reply_to_id" : 301317939,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjAyMDA4MQ==",
      "original_commit_id" : "f1facdd3e27d3b5c0536ab27d1f928984b8ccc25",
      "original_position" : 62,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 62,
      "pull_request_review_id" : 265031556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-22T20:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306020081",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306022260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306022260"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this addresses the edge case that we want. The line you added above:\r\n\r\n`assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[0][0]], [1], chain[0][1], fee, 350)`\r\n\r\nFails both the `nSize >  EXTRA_DESCENDANT_TX_SIZE_LIMIT` _and_ `!pool.CalculateMemPoolAncestors(entry, setAncestors, 2, nLimitAncestorSize, nLimitDescendants + 1, nLimitDescendantSize + EXTRA_DESCENDANT_TX_SIZE_LIMIT, errString)` checks. We want a test that differentitates just the weight > 40k case.",
      "commit_id" : "50cede3f5a4d4fbfbb7c420b94e661a6a159bced",
      "created_at" : "2019-07-22T20:39:28Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2014-2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descendant package tracking carge-out allowing one final transaction in\n+   an otherwise-full package as long as it has only one parent and is <= 10k in\n+   size.\n+\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error, satoshi_round\n+\n+MAX_ANCESTORS = 25\n+MAX_DESCENDANTS = 25\n+\n+class MempoolPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-maxorphantx=1000\"], [\"-maxorphantx=1000\", \"-limitancestorcount=5\"]]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    # Build a transaction that spends parent_txid:vout\n+    # Return amount sent\n+    def chain_transaction(self, node, parent_txids, vouts, value, fee, num_outputs):\n+        send_value = satoshi_round((value - fee)/num_outputs)\n+        inputs = []\n+        for (txid, vout) in zip(parent_txids, vouts):\n+            inputs.append({'txid' : txid, 'vout' : vout})\n+        outputs = {}\n+        for i in range(num_outputs):\n+            outputs[node.getnewaddress()] = send_value\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        signedtx = node.signrawtransactionwithwallet(rawtx)\n+        txid = node.sendrawtransaction(signedtx['hex'])\n+        fulltx = node.getrawtransaction(txid, 1)\n+        assert len(fulltx['vout']) == num_outputs  # make sure we didn't generate a change output\n+        return (txid, send_value)\n+\n+    def run_test(self):\n+        # Mine some blocks and have them mature.\n+        self.nodes[0].generate(101)\n+        utxo = self.nodes[0].listunspent(10)\n+        txid = utxo[0]['txid']\n+        vout = utxo[0]['vout']\n+        value = utxo[0]['amount']\n+\n+        fee = Decimal(\"0.0001\")\n+        # MAX_ANCESTORS transactions off a confirmed tx should be fine\n+        chain = []\n+        for i in range(4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [vout], value, fee, 2)\n+            vout = 0\n+            value = sent_value\n+            chain.append([txid, value])\n+        for i in range(MAX_ANCESTORS - 4):\n+            (txid, sent_value) = self.chain_transaction(self.nodes[0], [txid], [0], value, fee, 1)\n+            value = sent_value\n+            chain.append([txid, value])\n+        (second_chain, second_chain_value) = self.chain_transaction(self.nodes[0], [utxo[1]['txid']], [utxo[1]['vout']], utxo[1]['amount'], fee, 1)\n+\n+        # Check mempool has MAX_ANCESTORS transactions in it, and descendant and ancestor\n+        # count and fees should look correct\n+        assert_equal(len(self.nodes[0].getrawmempool(True)), MAX_ANCESTORS + 1)\n+\n+        # Adding one more transaction on to the chain should fail.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [txid], [0], value, fee, 1)\n+        # ...even if it chains on from some point in the middle of the chain.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[2][0]], [1], chain[2][1], fee, 1)\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[1][0]], [1], chain[1][1], fee, 1)\n+        # ...even if it chains on to two parent transactions with one in the chain.\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", self.chain_transaction, self.nodes[0], [chain[0][0], second_chain], [1, 0], chain[0][1] + second_chain_value, fee, 1)\n+        # But not if it chains directly off the first transaction\n+        self.chain_transaction(self.nodes[0], [chain[0][0]], [1], chain[0][1], fee, 1)\n+        # and the second chain should work just fine\n+        self.chain_transaction(self.nodes[0], [second_chain], [0], second_chain_value, fee, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#discussion_r306022260",
      "id" : 306022260,
      "in_reply_to_id" : 270107733,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjAyMjI2MA==",
      "original_commit_id" : "a3053fd871a857fe3394554ea4d48a7d845193c6",
      "original_position" : 79,
      "path" : "test/functional/mempool_package_onemore.py",
      "position" : 80,
      "pull_request_review_id" : 265031556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15681",
      "updated_at" : "2019-07-22T20:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306022260",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "just FYI: a lot of interesting comments on this PR available at: https://bitcoincore.reviews/15681.html",
      "created_at" : "2019-11-09T19:28:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15681#issuecomment-552129729",
      "id" : 552129729,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MjEyOTcyOQ==",
      "updated_at" : "2019-11-09T19:28:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/552129729",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/284023?v=4",
         "events_url" : "https://api.github.com/users/ysangkok/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ysangkok/followers",
         "following_url" : "https://api.github.com/users/ysangkok/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ysangkok/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ysangkok",
         "id" : 284023,
         "login" : "ysangkok",
         "node_id" : "MDQ6VXNlcjI4NDAyMw==",
         "organizations_url" : "https://api.github.com/users/ysangkok/orgs",
         "received_events_url" : "https://api.github.com/users/ysangkok/received_events",
         "repos_url" : "https://api.github.com/users/ysangkok/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ysangkok/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ysangkok/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ysangkok"
      }
   }
]
