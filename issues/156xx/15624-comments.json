[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've tried to replicate it, but it seems to work.\r\n\r\nLog:\r\n```\r\n$ cat /etc/alpine-release \r\n3.9.2\r\n\r\n$ git log --oneline -1\r\ne45b7f20e (HEAD) Merge #15618: refactor: Remove unused function\r\n\r\n$ ./src/test/test_bitcoin -t flatfile_tests\r\nRunning 4 test cases...\r\n\r\n*** No errors detected\r\n\r\n$ uname -srv\r\nLinux 4.19.26-0-virt #1-Alpine SMP Thu Feb 28 21:29:54 UTC 2019\r\n```\r\n",
      "created_at" : "2019-03-22T14:33:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15624#issuecomment-475643886",
      "id" : 475643886,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NTY0Mzg4Ng==",
      "updated_at" : "2019-03-22T14:33:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/475643886",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/697159?v=4",
         "events_url" : "https://api.github.com/users/lucayepa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/lucayepa/followers",
         "following_url" : "https://api.github.com/users/lucayepa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/lucayepa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/lucayepa",
         "id" : 697159,
         "login" : "lucayepa",
         "node_id" : "MDQ6VXNlcjY5NzE1OQ==",
         "organizations_url" : "https://api.github.com/users/lucayepa/orgs",
         "received_events_url" : "https://api.github.com/users/lucayepa/received_events",
         "repos_url" : "https://api.github.com/users/lucayepa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/lucayepa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/lucayepa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/lucayepa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Hmm, I was running alpine in podman.\r\n\r\n```\r\n$ uname -srv\r\nLinux 4.20.14-200.fc29.x86_64 #1 SMP Tue Mar 5 19:55:32 UTC 2019\r\n",
      "created_at" : "2019-03-22T15:33:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15624#issuecomment-475666814",
      "id" : 475666814,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NTY2NjgxNA==",
      "updated_at" : "2019-03-22T15:33:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/475666814",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe it is related to filesystem. Are you using unionfs or aufs? They don't support posix_fallocate. What do you get, if you try from command line:\r\n```\r\nsudo apk add util-linux\r\nfallocate -l 10M filename\r\n```",
      "created_at" : "2019-03-22T21:47:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15624#issuecomment-475794578",
      "id" : 475794578,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NTc5NDU3OA==",
      "updated_at" : "2019-03-23T01:27:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/475794578",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/697159?v=4",
         "events_url" : "https://api.github.com/users/lucayepa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/lucayepa/followers",
         "following_url" : "https://api.github.com/users/lucayepa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/lucayepa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/lucayepa",
         "id" : 697159,
         "login" : "lucayepa",
         "node_id" : "MDQ6VXNlcjY5NzE1OQ==",
         "organizations_url" : "https://api.github.com/users/lucayepa/orgs",
         "received_events_url" : "https://api.github.com/users/lucayepa/received_events",
         "repos_url" : "https://api.github.com/users/lucayepa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/lucayepa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/lucayepa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/lucayepa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Indeed\r\n\r\n```\r\nfallocate -l 10M filename\r\nfallocate: fallocate failed: Not supported\r\n",
      "created_at" : "2019-03-23T00:18:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15624#issuecomment-475821841",
      "id" : 475821841,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NTgyMTg0MQ==",
      "updated_at" : "2019-03-23T00:18:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/475821841",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is still strange, because, when there is no posix_fallocate, there is an emulation in glibc. Maybe some versions of glibc do not provide this emulation.\r\n\r\n>If the underlying filesystem does not support fallocate(2), then the operation is emulated with the following caveats:\r\n> * The emulation is inefficient.\r\n> * There is a race condition where concurrent writes from another thread or process could be overwritten with null bytes.\r\n> * There is a race condition where concurrent file size increases by another thread or process could result in a file whose size is smaller than expected.\r\n> * If fd has been opened with the O_APPEND or O_WRONLY flags, the function will fail with the error EBADF.\r\n>In  general,  the  emulation is not MT-safe.  On Linux, applications may use fallocate(2) if they cannot tolerate the emulation caveats.  In general, this is only recommended if the application plans to terminate the operation if EOPNOTSUPP is returned, otherwise the application itself will need to implement a fallback with all the same problems as the emulation provided by glibc.\r\n\r\nSince we open the files rb+, it should be fine.",
      "created_at" : "2019-03-23T02:32:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15624#issuecomment-475831918",
      "id" : 475831918,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NTgzMTkxOA==",
      "updated_at" : "2019-03-23T03:42:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/475831918",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/697159?v=4",
         "events_url" : "https://api.github.com/users/lucayepa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/lucayepa/followers",
         "following_url" : "https://api.github.com/users/lucayepa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/lucayepa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/lucayepa",
         "id" : 697159,
         "login" : "lucayepa",
         "node_id" : "MDQ6VXNlcjY5NzE1OQ==",
         "organizations_url" : "https://api.github.com/users/lucayepa/orgs",
         "received_events_url" : "https://api.github.com/users/lucayepa/received_events",
         "repos_url" : "https://api.github.com/users/lucayepa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/lucayepa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/lucayepa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/lucayepa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "We can see the error on strace:\r\n```\r\n$ strace test/test_bitcoin -t flatfile_tests 2>&1 | grep fallocate\r\nfallocate(3, 0, 0, 10000)               = -1 EOPNOTSUPP (Operation not supported)\r\n```",
      "created_at" : "2019-03-23T04:28:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/15624#issuecomment-475838320",
      "id" : 475838320,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15624",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NTgzODMyMA==",
      "updated_at" : "2019-03-23T04:28:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/475838320",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/697159?v=4",
         "events_url" : "https://api.github.com/users/lucayepa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/lucayepa/followers",
         "following_url" : "https://api.github.com/users/lucayepa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/lucayepa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/lucayepa",
         "id" : 697159,
         "login" : "lucayepa",
         "node_id" : "MDQ6VXNlcjY5NzE1OQ==",
         "organizations_url" : "https://api.github.com/users/lucayepa/orgs",
         "received_events_url" : "https://api.github.com/users/lucayepa/received_events",
         "repos_url" : "https://api.github.com/users/lucayepa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/lucayepa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/lucayepa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/lucayepa"
      }
   }
]
