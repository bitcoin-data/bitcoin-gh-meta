{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "#### # Context (Current Flow on Master)\r\n\r\nIn the transaction creation process, in order to select which coins the new transaction will spend,\r\nwe first obtain all the available coins known by the wallet, which means walking-through the\r\nwallet txes map, gathering the ones that fulfill certain spendability requirements in a vector.\r\n\r\nThis coins vector is then provided to the Coin Selection process, which first checks if the user\r\nhas manually selected any input (which could be internal, aka known by the wallet, or external),\r\nand if it does, it fetches them by searching each of them inside the wallet and/or inside the\r\nCoin Control external tx data.\r\n\r\nThen, after finding the pre-selected-inputs and gathering them in a vector, the Coin Selection\r\nprocess walks-through the entire available coins vector once more just to erase coins that are\r\nin both vectors. So the Coin Selection process doesnât pick them twice (duplicate inputs inside\r\nthe same transaction).\r\n\r\n#### # Process Workflow Changes\r\n\r\nNow, a new method, `FetchCoins` will be responsible for:\r\n1) Lookup the user pre-selected-inputs (which can be internal or external).\r\n2) And, fetch the available coins in the wallet (excluding the already fetched ones).\r\n\r\nWhich will occur prior to the Coin Selection process. Which allows us to never include the\r\npre-selected-inputs inside the available coins vector in the first place, as well as doing other\r\nnice improvements (written below).\r\n\r\nSo, Coin Selection can perform its main responsibility without mixing it with having to fetch\r\ninternal/external coins nor any slow and unneeded duplicate coins verification.\r\n\r\n#### # Summarizing the Improvements:\r\n\r\n1) If any pre-selected-input lookup fail, the process will return the error right away.\r\n    (before, the wallet was fetching all the wallet available coins, walking through the\r\n    entire txes map, and then failing for an invalid pre-selected-input inside SelectCoins)\r\n\r\n2) The pre-selected-inputs lookup failure causes are properly described on the return error.\r\n    (before, we were returning an \"Insufficient Funds\" error for everything, even if the failure\r\n    was due a not solvable external input)\r\n\r\n3) **Faster Coin Selection**: no longer need to \"remove the pre-set inputs from the available coins\r\n    vector so that Coin Selection doesn't pick them\" (which meant to loop-over the entire\r\n    available coins vector at Coin Selection time, erasing duplicate coins that were pre-selected).\r\n   \r\n    Now, the available coins vector, which is built after the pre-selected-inputs fetching,\r\n    doesnât include the already selected inputs in the first place.\r\n\r\n4) **Faster transaction creation** for transactions that only use manually selected inputs.\r\n\r\n    We now will return early, as soon as we finish fetching the pre-selected-inputs and\r\n    not perform the resources expensive calculation of walking-through the entire wallet\r\n    txes map to obtain the available coins (coins that we will not use).\r\n\r\n---------------------------\r\n\r\nAdded a new bench (f6d0bb2) measuring the transaction creation process, for a wallet with ~250k UTXO, only using the pre-selected-inputs inside coin control. Setting `m_allow_other_inputs=false` to disallow the wallet to include coins automatically.\r\n\r\n#### Result on this PR (tip f6d0bb2d):\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,048,675.00 |              953.58 |    0.3% |      0.06 | `WalletCreateTransaction`\r\n\r\nvs\r\n\r\n#### Result on master (tip 4a4289e2):\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|       96,373,458.20 |               10.38 |    0.2% |      5.30 | `WalletCreateTransaction`\r\n\r\nThe benchmark took to run in master: **96.37 milliseconds**, while in this PR: **1 millisecond**  ð .",
   "closed_at" : "2022-10-27T21:49:29Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
      "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
      "followers_url" : "https://api.github.com/users/achow101/followers",
      "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/achow101",
      "id" : 3782274,
      "login" : "achow101",
      "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
      "organizations_url" : "https://api.github.com/users/achow101/orgs",
      "received_events_url" : "https://api.github.com/users/achow101/received_events",
      "repos_url" : "https://api.github.com/users/achow101/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/achow101"
   },
   "comments" : 30,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685/comments",
   "created_at" : "2022-07-23T13:19:19Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685",
   "id" : 1315657410,
   "labels" : [
      {
         "color" : "08a781",
         "default" : false,
         "description" : null,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII5847-7hZ",
   "number" : 25685,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/25685.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685",
      "merged_at" : "2022-10-27T21:49:29Z",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/25685.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685/timeline",
   "title" : "wallet: Faster transaction creation by removing pre-set-inputs fetching responsibility from Coin Selection",
   "updated_at" : "2022-10-27T21:49:29Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
      "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
      "followers_url" : "https://api.github.com/users/furszy/followers",
      "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
      "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/furszy",
      "id" : 5377650,
      "login" : "furszy",
      "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
      "organizations_url" : "https://api.github.com/users/furszy/orgs",
      "received_events_url" : "https://api.github.com/users/furszy/received_events",
      "repos_url" : "https://api.github.com/users/furszy/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/furszy"
   }
}
