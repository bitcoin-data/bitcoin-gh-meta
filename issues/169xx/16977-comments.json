[
   {
      "author_association" : "MEMBER",
      "body" : "I think this is expected behavior, though I agree this is a type of thing that would be nice to improve.  Specifically:\r\n\r\n>  I would assume that changing HaveCoinInCache() to optionally return true even for spent coins would partially solve the issue, at least for everyday cases that happen from time to time.\r\n\r\nI imagine that this it is very rare that you'd have a recently mined transaction whose outputs are fully spent that is still in the utxo cache, because our utxo cache can remove entries that were never seen on disk.  When new utxos are created, they are FRESH in the CCoinsViewCache, and when they're fully spent, we can delete them from the map without ever flushing to disk (because our on-disk storage never knew about the utxo in the first place).  So I would think it would make very little difference whether you included spentness for the purposes of `AlreadyHave()`.\r\n\r\nOne way we might be able to optimize this situation is to just cache the txids of what was mined in the last block -- we already cache the last connected block in memory to optimize block relay, so I think we could add a cache of recently mined transactions to optimize out orphan requests due to these timing issues.  (Or even just iterate the cached block, if that's sufficiently fast.)",
      "created_at" : "2019-09-27T18:32:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16977#issuecomment-536051206",
      "id" : 536051206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16977",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNjA1MTIwNg==",
      "updated_at" : "2019-09-27T18:32:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/536051206",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Ok I think I understand why changing HaveCoinInCache() would not help. Caching the txids of the last recent block(s) should work. I also figured out that utilizing the txindex might be helpful, at least in my case (forked coin that has txindex enabled by default). Or maybe a rolling bloom filter is the better solution, but then I'm not sure reorgs would be handled well as entries can't be deleted (which is probably ok because the TXs are still considered \"already seen\").",
      "created_at" : "2019-09-30T08:34:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/16977#issuecomment-536460878",
      "id" : 536460878,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16977",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNjQ2MDg3OA==",
      "updated_at" : "2019-09-30T08:34:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/536460878",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1884269?v=4",
         "events_url" : "https://api.github.com/users/codablock/events{/privacy}",
         "followers_url" : "https://api.github.com/users/codablock/followers",
         "following_url" : "https://api.github.com/users/codablock/following{/other_user}",
         "gists_url" : "https://api.github.com/users/codablock/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/codablock",
         "id" : 1884269,
         "login" : "codablock",
         "node_id" : "MDQ6VXNlcjE4ODQyNjk=",
         "organizations_url" : "https://api.github.com/users/codablock/orgs",
         "received_events_url" : "https://api.github.com/users/codablock/received_events",
         "repos_url" : "https://api.github.com/users/codablock/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/codablock/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/codablock/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/codablock"
      }
   }
]
