[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Somewhat follows the suggestions of [@luke-jr](https://github.com/bitcoin/bitcoin/pull/15558#issuecomment-471239506) and [@jgarzik](https://github.com/bitcoin/bitcoin/pull/15558#issuecomment-471208937) in #15558",
      "created_at" : "2019-09-23T10:53:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-534049877",
      "id" : 534049877,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNDA0OTg3Nw==",
      "updated_at" : "2019-09-23T10:53:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/534049877",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Behaviour looks like:\r\n\r\n```\r\n2019-09-23T10:54:49Z dnsseed thread start\r\n2019-09-23T10:54:49Z Waiting 300 seconds before falling back to DNS seeds.\r\n2019-09-23T10:54:50Z trying connection XXX lastseen=662.4hrs\r\n2019-09-23T10:54:55Z connection to XXX timeout\r\n2019-09-23T10:54:55Z trying connection XXX lastseen=197.4hrs\r\n2019-09-23T10:54:56Z Added connection peer=0\r\n2019-09-23T10:54:56Z New outbound peer connected: ...\r\n2019-09-23T10:54:56Z trying connection XXX lastseen=469.4hrs\r\n```\r\n\r\nDNS thread would previously have decided to contact seeds here.\r\n```\r\n2019-09-23T10:55:01Z connection to XXX timeout\r\n2019-09-23T10:55:02Z trying connection XXX lastseen=685.1hrs\r\n2019-09-23T10:55:07Z connection to XXX timeout\r\n2019-09-23T10:55:07Z trying connection XXX lastseen=232.5hrs\r\n2019-09-23T10:55:12Z connection to XXX timeout\r\n2019-09-23T10:55:13Z trying connection XXX lastseen=388.0hrs\r\n```\r\n\r\nDNS thread checks for early exit here, but doesn't need one so keeps waiting.\r\n\r\n```\r\n2019-09-23T10:55:18Z connection to XXX timeout\r\n2019-09-23T10:55:18Z trying connection XXX lastseen=15.6hrs\r\n2019-09-23T10:55:19Z Added connection peer=1\r\n2019-09-23T10:55:19Z New outbound peer connected: ...\r\n2019-09-23T10:55:19Z trying connection XXX lastseen=36.8hrs\r\n2019-09-23T10:55:24Z connection to XXX timeout\r\n2019-09-23T10:55:25Z trying connection XXX lastseen=214.8hrs\r\n2019-09-23T10:55:30Z connection to XXX timeout\r\n2019-09-23T10:55:30Z trying connection XXX lastseen=524.4hrs\r\n2019-09-23T10:55:35Z connection to XXX timeout\r\n2019-09-23T10:55:36Z trying connection XXX lastseen=1705.3hrs\r\n```\r\n\r\nDNS thread checks again for early exit, and since there's two connections now, does:\r\n\r\n```\r\n2019-09-23T10:55:39Z P2P peers available. Skipped DNS seeding.\r\n2019-09-23T10:55:39Z dnsseed thread exit\r\n```",
      "created_at" : "2019-09-23T11:02:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-534052183",
      "id" : 534052183,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNDA1MjE4Mw==",
      "updated_at" : "2019-09-23T11:02:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/534052183",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK: seed querying should be kept to a minimum for obvious reasons",
      "created_at" : "2019-09-23T14:02:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-534113186",
      "id" : 534113186,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNDExMzE4Ng==",
      "updated_at" : "2019-09-23T14:02:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/534113186",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK.\r\n\r\nThis doesn't make us depend on a single seed, does it?\r\nAlso, perhaps move some of the magic numbers to constants?",
      "created_at" : "2019-09-23T15:53:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-534163054",
      "id" : 534163054,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNDE2MzA1NA==",
      "updated_at" : "2019-09-23T15:53:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/534163054",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed the logic to make it query in batches of 3 more sensibly, and bumped the delay for adding fixed seeds to 6 minutes from startup (fixed nodes are only added if addrman is empty, which will only happen if DNS seeds aren't replying -- but this may be due to the first one we try hanging, rather than all of them failing, so 6m is a compromise).\r\n\r\nBehaviour for empty peers.dat, but no ability to actually connect anywhere is to immediately query 3 random dns seeds, then wait 11 seconds and try the next 3, etc:\r\n\r\n```\r\n2019-09-23T18:02:46Z Loaded 0 addresses from peers.dat  0ms\r\n2019-09-23T18:02:46Z dnsseed thread start\r\n2019-09-23T18:02:46Z Loading addresses from DNS seed dnsseed.bluematt.me\r\n2019-09-23T18:02:47Z Loading addresses from DNS seed dnsseed.bitcoin.dashjr.org\r\n2019-09-23T18:02:52Z Loading addresses from DNS seed seed.bitcoin.jonasschnelli.ch\r\n2019-09-23T18:02:52Z Waiting 11 seconds before querying DNS seeds.\r\n2019-09-23T18:03:03Z Loading addresses from DNS seed dnsseed.emzy.de\r\n2019-09-23T18:03:03Z Loading addresses from DNS seed seed.bitcoin.sipa.be\r\n2019-09-23T18:03:03Z Loading addresses from DNS seed seed.bitcoin.sprovoost.nl\r\n2019-09-23T18:03:03Z Waiting 11 seconds before querying DNS seeds.\r\n2019-09-23T18:03:14Z Loading addresses from DNS seed seed.btc.petertodd.org\r\n2019-09-23T18:03:14Z 33 addresses found from DNS seeds\r\n2019-09-23T18:03:14Z dnsseed thread exit\r\n```\r\n\r\nSame deal if there's some but less than 1k entries in addrman, except it'll wait 11s first:\r\n\r\n```\r\n2019-09-23T18:23:15Z Loaded 33 addresses from peers.dat  0ms\r\n2019-09-23T18:23:15Z dnsseed thread start\r\n2019-09-23T18:23:15Z Waiting 11 seconds before querying DNS seeds.\r\n2019-09-23T18:23:26Z Loading addresses from DNS seed dnsseed.bitcoin.dashjr.org\r\n2019-09-23T18:23:26Z Loading addresses from DNS seed dnsseed.emzy.de\r\n2019-09-23T18:23:26Z Loading addresses from DNS seed dnsseed.bluematt.me\r\n2019-09-23T18:23:27Z Waiting 11 seconds before querying DNS seeds.\r\n2019-09-23T18:23:38Z Loading addresses from DNS seed seed.btc.petertodd.org\r\n2019-09-23T18:23:38Z Loading addresses from DNS seed seed.bitcoin.sipa.be\r\n2019-09-23T18:23:38Z Loading addresses from DNS seed seed.bitcoin.jonasschnelli.ch\r\n2019-09-23T18:23:38Z Waiting 11 seconds before querying DNS seeds.\r\n2019-09-23T18:23:49Z Loading addresses from DNS seed seed.bitcoin.sprovoost.nl\r\n2019-09-23T18:23:49Z 0 addresses found from DNS seeds\r\n2019-09-23T18:23:49Z dnsseed thread exit\r\n```\r\n\r\n(seed.bitcoinstats.com seems to hang for me, so I've dropped it from my chainparams, but that change isn't in this patch)",
      "created_at" : "2019-09-23T18:32:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-534226798",
      "id" : 534226798,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNDIyNjc5OA==",
      "updated_at" : "2019-09-23T18:32:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/534226798",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19029 (net: Fix CThreadInterrupt::sleep_for TSan issues by hebasto)\n* #15502 (p2p: Speed up initial connection to p2p network by ajtowns)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-09-23T20:03:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-534261214",
      "id" : 534261214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNDI2MTIxNA==",
      "updated_at" : "2020-05-21T01:20:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/534261214",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364966153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364966153"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: // 5 minutes, also move them to net.h ?",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-01-09T21:23:21Z",
      "diff_hunk" : "@@ -53,6 +53,15 @@ static constexpr int DUMP_PEERS_INTERVAL = 15 * 60;\n /** Number of DNS seeds to query when the number of connections is low. */\n static constexpr int DNSSEEDS_TO_QUERY_AT_ONCE = 3;\n \n+/** How long to delay before querying DNS seeds\n+ */\n+static constexpr std::chrono::seconds DNSSEEDS_DELAY_FEW_PEERS{11};\n+static constexpr std::chrono::seconds DNSSEEDS_DELAY_MANY_PEERS{300};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364966153",
      "id" : 364966153,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk2NjE1Mw==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 7,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 340823054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364966153",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364966899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364966899"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You can lay out trade-off further: \"Every new DNS seed queried increases the bar for eclipsing node but leaks more privacy.\"",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-01-09T21:25:28Z",
      "diff_hunk" : "@@ -1543,30 +1552,55 @@ void CConnman::ThreadDNSAddressSeed()\n     Shuffle(seeds.begin(), seeds.end(), rng);\n     int seeds_right_now = 0; // Number of seeds left before testing if we have enough connections\n     int found = 0;\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= 1000 ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n \n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364966899",
      "id" : 364966899,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk2Njg5OQ==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 35,
      "path" : "src/net.cpp",
      "position" : 30,
      "pull_request_review_id" : 340823054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364966899",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364970093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364970093"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What the logic for picking 1000 ? If we assume uniform address propagation, what's the ratio of reliable public nodes on others in addrman and what the probability of not connecting successfully to at least 3 outbound peers ? Based on that, I would say intuitively we may scale down number a bit to increase number of nodes who delay DNS query.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-01-09T21:33:19Z",
      "diff_hunk" : "@@ -1543,30 +1552,55 @@ void CConnman::ThreadDNSAddressSeed()\n     Shuffle(seeds.begin(), seeds.end(), rng);\n     int seeds_right_now = 0; // Number of seeds left before testing if we have enough connections\n     int found = 0;\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= 1000 ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364970093",
      "id" : 364970093,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk3MDA5Mw==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 20,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 340823054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364970093",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364971195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364971195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "For fresh nodes, addrman can't be bigger than 1000 after querying 3 dns (because nMaxIPs == 256), but if we change DNSSEEDS_TO_QUERY_AT_ONCE, we may assign  seeds_wait_time before every time evaluation instead",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-01-09T21:36:10Z",
      "diff_hunk" : "@@ -1543,30 +1552,55 @@ void CConnman::ThreadDNSAddressSeed()\n     Shuffle(seeds.begin(), seeds.end(), rng);\n     int seeds_right_now = 0; // Number of seeds left before testing if we have enough connections\n     int found = 0;\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= 1000 ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n \n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364971195",
      "id" : 364971195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk3MTE5NQ==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 56,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 340823054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364971195",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364972769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364972769"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure about this, I would say that's a behavior change. Previously node with  an empty addrman would have query all DNS seeds due to seeds_right_now == -1 as you noticed in #15558. Now you may exit early, if among DNSSEEDS_TO_QUERY_AT_ONCE you find at least 2 outbound peers but with final result of having less address origin diversity in your addrman..",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-01-09T21:39:55Z",
      "diff_hunk" : "@@ -1543,30 +1552,55 @@ void CConnman::ThreadDNSAddressSeed()\n     Shuffle(seeds.begin(), seeds.end(), rng);\n     int seeds_right_now = 0; // Number of seeds left before testing if we have enough connections\n     int found = 0;\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= 1000 ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n \n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;\n+            while (to_wait.count() > 0) {\n+                std::chrono::seconds w{25};\n+                if (w > to_wait) w = to_wait;\n+                if (!interruptNet.sleep_for(w)) return;\n+                to_wait -= w;\n+\n+                int nRelevant = 0;\n+                {\n+                    LOCK(cs_vNodes);\n+                    for (const CNode* pnode : vNodes) {\n+                        nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n+                    }\n+                }\n+                if (nRelevant >= 2) {\n+                    if (found > 0) {\n+                        LogPrintf(\"%d addresses found from DNS seeds\\n\", found);\n+                        LogPrintf(\"P2P peers available. Finished DNS seeding.\\n\");\n+                    } else {\n+                        LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n+                    }\n+                    return;\n+                }\n             }\n             seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n+        } else if (seeds_right_now == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364972769",
      "id" : 364972769,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk3Mjc2OQ==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 81,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 340823054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364972769",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364973333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364973333"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is a behavior change too, I do understand the logic to increase privacy for fresh nodes if DNS  are busy but how did you pick up this number ?",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-01-09T21:41:20Z",
      "diff_hunk" : "@@ -1715,7 +1749,7 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             return;\n \n         // Add seed nodes if DNS seeds are all down (an infrastructure attack?).\n-        if (addrman.size() == 0 && (GetTime() - nStart > 60)) {\n+        if (addrman.size() == 0 && (GetTime() - nStart > FIXEDSEEDS_DELAY)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r364973333",
      "id" : 364973333,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk3MzMzMw==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 91,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 340823054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364973333",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This shouldn't run if the node is not currently making automatic connections (network disable or -noconnect).",
      "created_at" : "2020-01-09T22:14:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-572781406",
      "id" : 572781406,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3Mjc4MTQwNg==",
      "updated_at" : "2020-01-09T22:14:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/572781406",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r377420664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377420664"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "They're not needed from other modules, so doesn't make sense to have them in net.h",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-02-11T02:16:40Z",
      "diff_hunk" : "@@ -53,6 +53,15 @@ static constexpr int DUMP_PEERS_INTERVAL = 15 * 60;\n /** Number of DNS seeds to query when the number of connections is low. */\n static constexpr int DNSSEEDS_TO_QUERY_AT_ONCE = 3;\n \n+/** How long to delay before querying DNS seeds\n+ */\n+static constexpr std::chrono::seconds DNSSEEDS_DELAY_FEW_PEERS{11};\n+static constexpr std::chrono::seconds DNSSEEDS_DELAY_MANY_PEERS{300};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r377420664",
      "id" : 377420664,
      "in_reply_to_id" : 364966153,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQyMDY2NA==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 7,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 356388476,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377420664",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r377426911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377426911"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "1000 is the maximum number of entries the `addr` message can include, so seems a good threshold to indicate you've managed to pick up some live data from the p2p network about potential peers, rather than just some results from DNS lookups.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-02-11T02:52:17Z",
      "diff_hunk" : "@@ -1543,30 +1552,55 @@ void CConnman::ThreadDNSAddressSeed()\n     Shuffle(seeds.begin(), seeds.end(), rng);\n     int seeds_right_now = 0; // Number of seeds left before testing if we have enough connections\n     int found = 0;\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= 1000 ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r377426911",
      "id" : 377426911,
      "in_reply_to_id" : 364970093,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQyNjkxMQ==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 20,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 356395572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377426911",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@gmaxwell\r\n\r\n> This shouldn't run if the node is not currently making automatic connections (network disable or -noconnect).\r\n\r\nFor `-noconnect` we already have \"parameter interaction: -connect set -> setting -dnsseed=0\" which prevents the dns thread from ever starting. Not sure what network disable means, should we not do dns seeding if `-onlynet=onion` or something?",
      "created_at" : "2020-02-11T03:06:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-584460820",
      "id" : 584460820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDQ2MDgyMA==",
      "updated_at" : "2020-02-11T03:06:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584460820",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r377439532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377439532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This change isn't needed -- if addrman is going to end up empty, it will have been empty for each dns seed which means there would have been no delay in querying the seed.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-02-11T04:10:03Z",
      "diff_hunk" : "@@ -1715,7 +1749,7 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             return;\n \n         // Add seed nodes if DNS seeds are all down (an infrastructure attack?).\n-        if (addrman.size() == 0 && (GetTime() - nStart > 60)) {\n+        if (addrman.size() == 0 && (GetTime() - nStart > FIXEDSEEDS_DELAY)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r377439532",
      "id" : 377439532,
      "in_reply_to_id" : 364973333,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzOTUzMg==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 91,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 356409807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377439532",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased, reverted delay for fixed seeds, and changed to explicitly query all dns seeds if we start up with an empty addrman.",
      "created_at" : "2020-02-11T04:39:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-584475372",
      "id" : 584475372,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDQ3NTM3Mg==",
      "updated_at" : "2020-02-11T04:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584475372",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Not sure what network disable means\r\n\r\nThere is a `setnetworkactive` RPC, which can disable the connman",
      "created_at" : "2020-02-11T13:09:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-584626477",
      "id" : 584626477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDYyNjQ3Nw==",
      "updated_at" : "2020-02-11T13:09:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584626477",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added patch to avoid querying DNS seeds while `setnetworkactive` is set to false.",
      "created_at" : "2020-02-11T16:35:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-584725738",
      "id" : 584725738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDcyNTczOA==",
      "updated_at" : "2020-02-11T16:35:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584725738",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r377758118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377758118"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "With the current code:\r\n\r\n * if addrman starts off at 0, it'll query all DNS seeds with no delay\r\n * if addrman starts off under 1000, it'll query all DNS seeds in groups of 3 after waiting 11 seconds before each group\r\n * if addrman starts off over 1000, it'll query all DNS seeds in groups of 3 after waiting 5 minutes before each group\r\n\r\nThat seems mostly fine to me?\r\n\r\n(The timeout for connecting to a peer is nConnectTimeout which is 5 seconds; so 11 seconds will pass if you happen to try three peers that timeout before getting two that succeed)",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-02-11T16:43:45Z",
      "diff_hunk" : "@@ -1543,30 +1552,55 @@ void CConnman::ThreadDNSAddressSeed()\n     Shuffle(seeds.begin(), seeds.end(), rng);\n     int seeds_right_now = 0; // Number of seeds left before testing if we have enough connections\n     int found = 0;\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= 1000 ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n \n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r377758118",
      "id" : 377758118,
      "in_reply_to_id" : 364971195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1ODExOA==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 56,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 356816422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377758118",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-03-11T09:58:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-597542131",
      "id" : 597542131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NzU0MjEzMQ==",
      "updated_at" : "2020-03-11T09:58:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597542131",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r390967622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390967622"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As 25 seconds is a timeout for the _early_ exit from dnsseed thread, we could do not introduce a new heuristic constant at all:\r\n```diff\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -41,9 +41,9 @@\r\n static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\r\n #endif\r\n \r\n-#include <unordered_map>\r\n-\r\n+#include <chrono>\r\n #include <math.h>\r\n+#include <unordered_map>\r\n \r\n // Dump addresses to peers.dat every 15 minutes (900s)\r\n static constexpr int DUMP_PEERS_INTERVAL = 15 * 60;\r\n@@ -1601,12 +1601,12 @@ void CConnman::ThreadDNSAddressSeed()\r\n     for (const std::string& seed : seeds) {\r\n         if (addrman.size() > 0 && seeds_right_now == 0) {\r\n             LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\r\n-            std::chrono::seconds to_wait = seeds_wait_time;\r\n+            std::chrono::milliseconds to_wait{seeds_wait_time};\r\n             while (to_wait.count() > 0) {\r\n-                std::chrono::seconds w{25}; // check for early abort every 25 seconds\r\n-                if (w > to_wait) w = to_wait;\r\n-                if (!interruptNet.sleep_for(w)) return;\r\n-                to_wait -= w;\r\n+                std::chrono::milliseconds recheck_period{nConnectTimeout};\r\n+                if (recheck_period > to_wait) recheck_period = to_wait;\r\n+                if (!interruptNet.sleep_for(recheck_period)) return;\r\n+                to_wait -= recheck_period;\r\n \r\n                 int nRelevant = 0;\r\n                 {\r\n```",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-11T13:26:35Z",
      "diff_hunk" : "@@ -1573,26 +1579,55 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;\n+            while (to_wait.count() > 0) {\n+                std::chrono::seconds w{25}; // check for early abort every 25 seconds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r390967622",
      "id" : 390967622,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2NzYyMg==",
      "original_commit_id" : "5bf16653168cbc3c8bd0814cfa937d0dc8a879ff",
      "original_position" : 55,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 372754053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390967622",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "concept ACK\r\n\r\nWhen DNS seeding was introduced, the idea was to be a backup, for when P2P peer addr exchange is not working for whatever reason.  It seems preferable to make the polling closer to \"24 hours\" or \"never\" in the case where AddrMan is healthy and happy.\r\n\r\nRegardless of that preference, concept ACK as stated above, as this appears to be a strict improvement & resolve an issue.\r\n",
      "created_at" : "2020-03-11T13:55:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-597648742",
      "id" : 597648742,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NzY0ODc0Mg==",
      "updated_at" : "2020-03-11T13:55:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597648742",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/494411?v=4",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "node_id" : "MDQ6VXNlcjQ5NDQxMQ==",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r391002439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391002439"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems this branch will never be executed since all of the dns seeds are explicitly queried if we start up with an empty addrman:\r\nhttps://github.com/bitcoin/bitcoin/blob/5bf16653168cbc3c8bd0814cfa937d0dc8a879ff/src/net.cpp#L1582-L1585",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-11T14:17:25Z",
      "diff_hunk" : "@@ -1573,26 +1579,55 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;\n+            while (to_wait.count() > 0) {\n+                std::chrono::seconds w{25}; // check for early abort every 25 seconds\n+                if (w > to_wait) w = to_wait;\n+                if (!interruptNet.sleep_for(w)) return;\n+                to_wait -= w;\n+\n+                int nRelevant = 0;\n+                {\n+                    LOCK(cs_vNodes);\n+                    for (const CNode* pnode : vNodes) {\n+                        nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n+                    }\n+                }\n+                if (nRelevant >= 2) {\n+                    if (found > 0) {\n+                        LogPrintf(\"%d addresses found from DNS seeds\\n\", found);\n+                        LogPrintf(\"P2P peers available. Finished DNS seeding.\\n\");\n+                    } else {\n+                        LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n+                    }\n+                    return;\n+                }\n             }\n             seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n+        } else if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r391002439",
      "id" : 391002439,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAwMjQzOQ==",
      "original_commit_id" : "5bf16653168cbc3c8bd0814cfa937d0dc8a879ff",
      "original_position" : 79,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 372799147,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391002439",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r391008151"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391008151"
         }
      },
      "author_association" : "MEMBER",
      "body" : "While here mind replacing a magic number 2 with a named constant?",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-11T14:24:59Z",
      "diff_hunk" : "@@ -1573,26 +1579,55 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;\n+            while (to_wait.count() > 0) {\n+                std::chrono::seconds w{25}; // check for early abort every 25 seconds\n+                if (w > to_wait) w = to_wait;\n+                if (!interruptNet.sleep_for(w)) return;\n+                to_wait -= w;\n+\n+                int nRelevant = 0;\n+                {\n+                    LOCK(cs_vNodes);\n+                    for (const CNode* pnode : vNodes) {\n+                        nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n+                    }\n+                }\n+                if (nRelevant >= 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r391008151",
      "id" : 391008151,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAwODE1MQ==",
      "original_commit_id" : "5bf16653168cbc3c8bd0814cfa937d0dc8a879ff",
      "original_position" : 67,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 372806494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391008151",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r391341643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391341643"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It'd make sense for `DNSSEEDS_DELAY_FEW_PEERS` to be calculated from that rather than a constant, but the early exit ought to be based on how long it takes for a connection to _succeed_ rather than the timeout time",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-12T00:22:40Z",
      "diff_hunk" : "@@ -1573,26 +1579,55 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;\n+            while (to_wait.count() > 0) {\n+                std::chrono::seconds w{25}; // check for early abort every 25 seconds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r391341643",
      "id" : 391341643,
      "in_reply_to_id" : 390967622,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM0MTY0Mw==",
      "original_commit_id" : "5bf16653168cbc3c8bd0814cfa937d0dc8a879ff",
      "original_position" : 55,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 373209188,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391341643",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392048614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392048614"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "On the other hand, can easily reuse `DNSSEEDS_DELAY_FEW_PEERS` instead of a new constant, so will just do that.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-13T06:21:22Z",
      "diff_hunk" : "@@ -1573,26 +1579,55 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;\n+            while (to_wait.count() > 0) {\n+                std::chrono::seconds w{25}; // check for early abort every 25 seconds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392048614",
      "id" : 392048614,
      "in_reply_to_id" : 390967622,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0ODYxNA==",
      "original_commit_id" : "5bf16653168cbc3c8bd0814cfa937d0dc8a879ff",
      "original_position" : 55,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 374071152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392048614",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392048829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392048829"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Rearranged to `if (s_r_n == 0) { s_r_n += AT_ONCE; if (addrman.size() == 0) { wait(); } }`",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-13T06:22:09Z",
      "diff_hunk" : "@@ -1573,26 +1579,55 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;\n+            while (to_wait.count() > 0) {\n+                std::chrono::seconds w{25}; // check for early abort every 25 seconds\n+                if (w > to_wait) w = to_wait;\n+                if (!interruptNet.sleep_for(w)) return;\n+                to_wait -= w;\n+\n+                int nRelevant = 0;\n+                {\n+                    LOCK(cs_vNodes);\n+                    for (const CNode* pnode : vNodes) {\n+                        nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n+                    }\n+                }\n+                if (nRelevant >= 2) {\n+                    if (found > 0) {\n+                        LogPrintf(\"%d addresses found from DNS seeds\\n\", found);\n+                        LogPrintf(\"P2P peers available. Finished DNS seeding.\\n\");\n+                    } else {\n+                        LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n+                    }\n+                    return;\n+                }\n             }\n             seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n+        } else if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392048829",
      "id" : 392048829,
      "in_reply_to_id" : 391002439,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0ODgyOQ==",
      "original_commit_id" : "5bf16653168cbc3c8bd0814cfa937d0dc8a879ff",
      "original_position" : 79,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 374071375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392048829",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392733605"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392733605"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay, make sense given we send `GETADDR` at `VERSION` reception which means if you have at only one reliable outbound connection you should be able to bootstrap your addrman without seed assistance.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-16T00:44:42Z",
      "diff_hunk" : "@@ -1543,30 +1552,55 @@ void CConnman::ThreadDNSAddressSeed()\n     Shuffle(seeds.begin(), seeds.end(), rng);\n     int seeds_right_now = 0; // Number of seeds left before testing if we have enough connections\n     int found = 0;\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= 1000 ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392733605",
      "id" : 392733605,
      "in_reply_to_id" : 364970093,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjczMzYwNQ==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 20,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 374854236,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392733605",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392736056"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392736056"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, I think I forget we set `seeds_right_now` to number of seeds if if we don't have any known peers (IIRC my comment motivation)",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-16T01:05:29Z",
      "diff_hunk" : "@@ -1543,30 +1552,55 @@ void CConnman::ThreadDNSAddressSeed()\n     Shuffle(seeds.begin(), seeds.end(), rng);\n     int seeds_right_now = 0; // Number of seeds left before testing if we have enough connections\n     int found = 0;\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= 1000 ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n \n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n         if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n-\n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+            std::chrono::seconds to_wait = seeds_wait_time;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392736056",
      "id" : 392736056,
      "in_reply_to_id" : 364971195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjczNjA1Ng==",
      "original_commit_id" : "899d9f4097a3c23eb2dcb3fe186e9e90a5eb9d83",
      "original_position" : 56,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 374858171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392736056",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ajtowns I think you need to update commit message, it's still mentioning the 25s delays while you now rely on DNSSEED_DELAY_FEW_PEERS?",
      "created_at" : "2020-03-16T01:18:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-599296139",
      "id" : 599296139,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTI5NjEzOQ==",
      "updated_at" : "2020-03-16T01:18:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599296139",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392778614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392778614"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                    std::chrono::seconds w = std::min(DNSSEEDS_DELAY_FEW_PEERS, to_wait);\r\n```",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-16T04:35:14Z",
      "diff_hunk" : "@@ -1573,31 +1579,68 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n-        if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n+        if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n \n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            if (addrman.size() > 0) {\n+                LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+                std::chrono::seconds to_wait = seeds_wait_time;\n+                while (to_wait.count() > 0) {\n+                    std::chrono::seconds w = DNSSEEDS_DELAY_FEW_PEERS;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r392778614",
      "id" : 392778614,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc3ODYxNA==",
      "original_commit_id" : "b1338cc25c0d66a73aea760117e488b6c91d0d43",
      "original_position" : 58,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 374907474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392778614",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r393890788"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393890788"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Took this since I rebased to update the commit description",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-17T18:36:27Z",
      "diff_hunk" : "@@ -1573,31 +1579,68 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n-        if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n+        if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n \n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            if (addrman.size() > 0) {\n+                LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+                std::chrono::seconds to_wait = seeds_wait_time;\n+                while (to_wait.count() > 0) {\n+                    std::chrono::seconds w = DNSSEEDS_DELAY_FEW_PEERS;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r393890788",
      "id" : 393890788,
      "in_reply_to_id" : 392778614,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5MDc4OA==",
      "original_commit_id" : "b1338cc25c0d66a73aea760117e488b6c91d0d43",
      "original_position" : 58,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 376305040,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-17T18:36:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393890788",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r395579741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395579741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could add `#include <chrono>`? See [Source code organization](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#source-code-organization).",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-20T11:34:15Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r395579741",
      "id" : 395579741,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU3OTc0MQ==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_position" : 34,
      "path" : "src/net.cpp",
      "position" : 34,
      "pull_request_review_id" : 378408988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-20T11:44:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395579741",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r395582049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395582049"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Considering https://github.com/bitcoin/bitcoin/blob/96954d17948662672cababc940e453dff08e8cbb/src/net.cpp#L1582-L1585 and https://github.com/bitcoin/bitcoin/blob/96954d17948662672cababc940e453dff08e8cbb/src/net.cpp#L1602\r\n\r\nthis point is not reachable when `addrman.size() == 0`, and `addrman.size() > 0` will always be evaluated to true, so it could be dropped, no?",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-20T11:40:07Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n-        if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n+        if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n \n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            if (addrman.size() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r395582049",
      "id" : 395582049,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU4MjA0OQ==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_position" : 54,
      "path" : "src/net.cpp",
      "position" : 54,
      "pull_request_review_id" : 378408988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-20T11:44:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395582049",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r395582691"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395582691"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                    if (nRelevant >= DNSSEEDS_ENOUGH_PEERS) {\r\n```",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-03-20T11:41:34Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n-        if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n+        if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n \n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            if (addrman.size() > 0) {\n+                LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+                std::chrono::seconds to_wait = seeds_wait_time;\n+                while (to_wait.count() > 0) {\n+                    std::chrono::seconds w = std::min(DNSSEEDS_DELAY_FEW_PEERS, to_wait);\n+                    if (!interruptNet.sleep_for(w)) return;\n+                    to_wait -= w;\n+\n+                    int nRelevant = 0;\n+                    {\n+                        LOCK(cs_vNodes);\n+                        for (const CNode* pnode : vNodes) {\n+                            nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n+                        }\n+                    }\n+                    if (nRelevant >= 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r395582691",
      "id" : 395582691,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU4MjY5MQ==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_position" : 69,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 378408988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "updated_at" : "2020-03-20T11:44:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395582691",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r427450474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427450474"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we should expand this comment into couple sentences. What's \"live network\" is unclear. What if we have 500 peers, is that not a live network?\r\nWould be also nice to briefly rationalize this distinction (yes, one more time).\r\nAlso, long inline comments like this are hard to read :)",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-19T16:49:47Z",
      "diff_hunk" : "@@ -51,6 +51,12 @@ static constexpr int DUMP_PEERS_INTERVAL = 15 * 60;\n /** Number of DNS seeds to query when the number of connections is low. */\n static constexpr int DNSSEEDS_TO_QUERY_AT_ONCE = 3;\n \n+/** How long to delay before querying DNS seeds\n+ */\n+static constexpr std::chrono::seconds DNSSEEDS_DELAY_FEW_PEERS{11}; // 11sec\n+static constexpr std::chrono::seconds DNSSEEDS_DELAY_MANY_PEERS{300}; // 5min\n+static constexpr int DNSSEEDS_DELAY_PEER_THRESHOLD = 1000; // \"many\" vs \"few\" peers -- you should only get this many if you've been on the live network",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r427450474",
      "id" : 427450474,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ1MDQ3NA==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_line" : 58,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 8,
      "pull_request_review_id" : 414638503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-19T18:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427450474",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r427467271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427467271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Comment here would be nice too. What exactly this tells us?\r\nFor example, I spent time thinking \"what if a node was connected to 1 node via --connect\". But then they'd still probably have a big addrman (all learned from that peer)...",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-19T17:16:32Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r427467271",
      "id" : 427467271,
      "line" : 1582,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2NzI3MQ==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_line" : 1582,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 17,
      "pull_request_review_id" : 414638503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-19T18:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427467271",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r427478370"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427478370"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you are right @hebasto. Although it took 5 minutes for me to confirm. I think if we remove this redundant check, a comment should be added.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-19T17:33:39Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n-        if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n+        if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n \n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            if (addrman.size() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r427478370",
      "id" : 427478370,
      "in_reply_to_id" : 395582049,
      "line" : 1605,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3ODM3MA==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_line" : 1605,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 54,
      "pull_request_review_id" : 414638503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-19T18:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427478370",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r430527006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430527006"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If we did reach it with `addrman.size() == 0`, waiting would be pointless, so I don't think the logic is wrong; there's no `else` so there's no unreachable code, just a conditional branch that always happens to go one way. I think double checking is a bit more robust in case we change the code to querying some subset of dns seeds when addrman is empty in future, eg if we had dozens of dns seeds available.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-26T16:00:35Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n-        if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n+        if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n \n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            if (addrman.size() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r430527006",
      "id" : 430527006,
      "in_reply_to_id" : 395582049,
      "line" : 1605,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUyNzAwNg==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_line" : 1605,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 54,
      "pull_request_review_id" : 418447438,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T16:00:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430527006",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r430542113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430542113"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It tells us we don't have any known peers (there's already a comment to that effect) -- perhaps this is the first time you've started bitcoind or you've just restarted after deleting peers.dat. If you previously queried the dns seeds, or have at some point connected to some other peers that aren't in IBD, this shouldn't be true any more.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-26T16:22:18Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r430542113",
      "id" : 430542113,
      "in_reply_to_id" : 427467271,
      "line" : 1582,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU0MjExMw==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_line" : 1582,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 17,
      "pull_request_review_id" : 418466779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T16:22:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430542113",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r430554421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430554421"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We already use std::chrono in net.cpp; I think it's included via net.h via addrman.h via util/system.h via util/time.h. So yeah, could see the value in cleaning that up, but don't think it needs to be in this patch.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-26T16:40:19Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r430554421",
      "id" : 430554421,
      "in_reply_to_id" : 395579741,
      "line" : 1599,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU1NDQyMQ==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_line" : 1599,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 34,
      "pull_request_review_id" : 418483833,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T16:40:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430554421",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r430557396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430557396"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't really think this adds anything -- the logs in the body of the if seems like it documents the value better than giving it a name would, and we don't reuse it anywhere else.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-26T16:43:35Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n-        if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n+        if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n \n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            if (addrman.size() > 0) {\n+                LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+                std::chrono::seconds to_wait = seeds_wait_time;\n+                while (to_wait.count() > 0) {\n+                    std::chrono::seconds w = std::min(DNSSEEDS_DELAY_FEW_PEERS, to_wait);\n+                    if (!interruptNet.sleep_for(w)) return;\n+                    to_wait -= w;\n+\n+                    int nRelevant = 0;\n+                    {\n+                        LOCK(cs_vNodes);\n+                        for (const CNode* pnode : vNodes) {\n+                            nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n+                        }\n+                    }\n+                    if (nRelevant >= 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r430557396",
      "id" : 430557396,
      "in_reply_to_id" : 395582691,
      "line" : 1620,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU1NzM5Ng==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_line" : 1620,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 418486375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T16:43:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430557396",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns Would you prefer to add a new commit with documentation or instead have this merged first or something else?",
      "created_at" : "2020-05-26T17:06:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-634154652",
      "id" : 634154652,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDE1NDY1Mg==",
      "updated_at" : "2020-05-26T17:06:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634154652",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @ajtowns Would you prefer to add a new commit with documentation or instead have this merged first or something else?\r\n\r\nMaybe a separate PR for updating the comments? See #19084 ",
      "created_at" : "2020-05-28T00:15:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#issuecomment-635012553",
      "id" : 635012553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16939",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNTAxMjU1Mw==",
      "updated_at" : "2020-05-28T00:15:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/635012553",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r431984399"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431984399"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This undoes #15558 for the first run. No strong opinion on the matter, but it should probably be in the PR and commit description. It's also not mentioned in the comments below. \r\n\r\nAlso, both here and in the `if` branch it's useful to comment that `seeds_right_now > 0` causes the wait to be skipped.  ",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-28T16:55:47Z",
      "diff_hunk" : "@@ -1573,31 +1579,61 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r431984399",
      "id" : 431984399,
      "line" : 1584,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4NDM5OQ==",
      "original_commit_id" : "fa5894f7f581718ea28bb34b52fcd3b33ff3e644",
      "original_line" : 1584,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 420310676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-28T17:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431984399",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r431998452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431998452"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> in case we change the code to querying some subset of dns seeds when addrman is empty in future\r\n\r\nThat's worth explaining in a comment. It may also be more readable to have a `bool skip_wait`",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-28T17:18:58Z",
      "diff_hunk" : "@@ -1573,31 +1579,67 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n-        if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n+        if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n \n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            if (addrman.size() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r431998452",
      "id" : 431998452,
      "in_reply_to_id" : 395582049,
      "line" : 1605,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5ODQ1Mg==",
      "original_commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "original_line" : 1605,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 54,
      "pull_request_review_id" : 420310676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-28T17:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431998452",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r432002579"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432002579"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use a comment of why you're sleeping in shorter intervals: because we can exit this thread once we have enough nodes.",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-28T17:25:45Z",
      "diff_hunk" : "@@ -1573,31 +1579,61 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();\n     }\n \n+    // goal: only query DNS seed if address need is acute\n+    // * If we have a reasonable number of peers in addrman, spend\n+    //   some time trying them first. This improves user privacy by\n+    //   creating fewer identifying DNS requests, reduces trust by\n+    //   giving seeds less influence on the network topology, and\n+    //   reduces traffic to the seeds.\n+    // * When querying DNS seeds query a few at once, this ensures\n+    //   that we don't give DNS seeds the ability to eclipse nodes\n+    //   that query them.\n+    // * If we continue having problems, eventually query all the\n+    //   DNS seeds, and if that fails too, also try the fixed seeds.\n+    //   (done in ThreadOpenConnections)\n+    const std::chrono::seconds seeds_wait_time = (addrman.size() >= DNSSEEDS_DELAY_PEER_THRESHOLD ? DNSSEEDS_DELAY_MANY_PEERS : DNSSEEDS_DELAY_FEW_PEERS);\n+\n     for (const std::string& seed : seeds) {\n-        // goal: only query DNS seed if address need is acute\n-        // Avoiding DNS seeds when we don't need them improves user privacy by\n-        // creating fewer identifying DNS requests, reduces trust by giving seeds\n-        // less influence on the network topology, and reduces traffic to the seeds.\n-        if (addrman.size() > 0 && seeds_right_now == 0) {\n-            if (!interruptNet.sleep_for(std::chrono::seconds(11))) return;\n+        if (seeds_right_now == 0) {\n+            seeds_right_now += DNSSEEDS_TO_QUERY_AT_ONCE;\n \n-            LOCK(cs_vNodes);\n-            int nRelevant = 0;\n-            for (const CNode* pnode : vNodes) {\n-                nRelevant += pnode->fSuccessfullyConnected && !pnode->fFeeler && !pnode->fOneShot && !pnode->m_manual_connection && !pnode->fInbound;\n-            }\n-            if (nRelevant >= 2) {\n-                LogPrintf(\"P2P peers available. Skipped DNS seeding.\\n\");\n-                return;\n+            if (addrman.size() > 0) {\n+                LogPrintf(\"Waiting %d seconds before querying DNS seeds.\\n\", seeds_wait_time.count());\n+                std::chrono::seconds to_wait = seeds_wait_time;\n+                while (to_wait.count() > 0) {\n+                    std::chrono::seconds w = std::min(DNSSEEDS_DELAY_FEW_PEERS, to_wait);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r432002579",
      "id" : 432002579,
      "line" : 1609,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwMjU3OQ==",
      "original_commit_id" : "fa5894f7f581718ea28bb34b52fcd3b33ff3e644",
      "original_line" : 1609,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 58,
      "pull_request_review_id" : 420310676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-28T17:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432002579",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r432150619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432150619"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In #15558 the first run will set `seeds_right_now = 0` then see that `addrman.size() > 0 && seeds_right_now == 0` is false (since `addrman.size() == 0`) so will not sleep nor bump `seeds_right_now` by `DNSSEEDS_TO_QUERY_AT_ONCE`, it will then query a seed, and decrement `seeds_right_now` so that it's `-1`, at which point `addrman.size() > 0 && seeds_right_now == 0` will continue being false (because `seeds_right_now < 0`) and will query all seeds without waiting between them.\r\n\r\nThis retains that behaviour, but is explicit about it. See [suhas's comment on 15558](https://github.com/bitcoin/bitcoin/pull/15558#discussion_r327643907)",
      "commit_id" : "96954d17948662672cababc940e453dff08e8cbb",
      "created_at" : "2020-05-28T22:05:44Z",
      "diff_hunk" : "@@ -1573,31 +1579,61 @@ void CConnman::ThreadDNSAddressSeed()\n     if (gArgs.GetBoolArg(\"-forcednsseed\", DEFAULT_FORCEDNSSEED)) {\n         // When -forcednsseed is provided, query all.\n         seeds_right_now = seeds.size();\n+    } else if (addrman.size() == 0) {\n+        // If we have no known peers, query all.\n+        seeds_right_now = seeds.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16939#discussion_r432150619",
      "id" : 432150619,
      "in_reply_to_id" : 431984399,
      "line" : 1584,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MDYxOQ==",
      "original_commit_id" : "fa5894f7f581718ea28bb34b52fcd3b33ff3e644",
      "original_line" : 1584,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 420526056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-28T22:05:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432150619",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
