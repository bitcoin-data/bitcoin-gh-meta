[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17737](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17737.html) (Add ChainstateManager, remove BlockManager global by jamesob)\n* [#15606](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15606.html) ([experimental] UTXO snapshots by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-09-23T20:01:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-534260399",
      "id" : 534260399,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNDI2MDM5OQ==",
      "updated_at" : "2020-01-08T00:35:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/534260399",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327669352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327669352"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe avoid introducing `static` here since there was no `static` previously, and in general this isn't a pattern we use with other `GetArg` calls, and and it makes this code harder to test with different sizes, or allow updating the size without restarting.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-24T15:04:04Z",
      "diff_hunk" : "@@ -2206,13 +2206,30 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState()\n+{\n+    static int64_t nMempoolSizeMax = gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327669352",
      "id" : 327669352,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyNzY2OTM1Mg==",
      "original_commit_id" : "e3ac4ebeeb64b9fc9752384177474a53d8bf75c3",
      "original_position" : 6,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 292493041,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327669352",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327681232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327681232"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would it make sense to pass in the mempool as a `tx_pool` argument instead of using the global in this function?",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-24T15:24:58Z",
      "diff_hunk" : "@@ -2206,13 +2206,30 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState()\n+{\n+    static int64_t nMempoolSizeMax = gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n+    int64_t nMempoolUsage = mempool.DynamicMemoryUsage();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327681232",
      "id" : 327681232,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyNzY4MTIzMg==",
      "original_commit_id" : "e3ac4ebeeb64b9fc9752384177474a53d8bf75c3",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 292508828,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327681232",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327692844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327692844"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good points, will fix. Can't remember why I added that.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-24T15:45:51Z",
      "diff_hunk" : "@@ -2206,13 +2206,30 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState()\n+{\n+    static int64_t nMempoolSizeMax = gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327692844",
      "id" : 327692844,
      "in_reply_to_id" : 327669352,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyNzY5Mjg0NA==",
      "original_commit_id" : "e3ac4ebeeb64b9fc9752384177474a53d8bf75c3",
      "original_position" : 6,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 292524313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327692844",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327692899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327692899"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, good idea.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-24T15:45:57Z",
      "diff_hunk" : "@@ -2206,13 +2206,30 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState()\n+{\n+    static int64_t nMempoolSizeMax = gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n+    int64_t nMempoolUsage = mempool.DynamicMemoryUsage();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327692899",
      "id" : 327692899,
      "in_reply_to_id" : 327681232,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyNzY5Mjg5OQ==",
      "original_commit_id" : "e3ac4ebeeb64b9fc9752384177474a53d8bf75c3",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 292524313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327692899",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the looks so far @ryanofsky @MarcoFalke. I've taken all proposed advice, as well as going further to parameterize the maximum coins cache and mempool target sizes. I've also added a unittest exercising this.",
      "created_at" : "2019-09-24T18:16:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-534683144",
      "id" : 534683144,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNDY4MzE0NA==",
      "updated_at" : "2019-09-24T18:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/534683144",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327790044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327790044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looks like this fails:\r\n\r\n```\r\nRunning tests: validation_flush_tests from test/validation_flush_tests.cpp\r\n\r\nRunning 1 test case...\r\n\r\nTest cases order is shuffled using seed: 1589090245\r\n\r\nEntering test module \"Bitcoin Core Test Suite\"\r\n\r\ntest/validation_flush_tests.cpp(12): Entering test suite \"validation_flush_tests\"\r\n\r\ntest/validation_flush_tests.cpp(19): Entering test case \"getcoinscachesizestate\"\r\n\r\nCCoinsViewCache memory usage: 16\r\n\r\ntest/validation_flush_tests.cpp(55): error: in \"validation_flush_tests/getcoinscachesizestate\": check view.DynamicMemoryUsage() == 32 has failed [16 != 32]",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-24T19:18:37Z",
      "diff_hunk" : "@@ -0,0 +1,134 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    print_view_mem_usage(view);\n+    BOOST_CHECK_EQUAL(view.DynamicMemoryUsage(), 32);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327790044",
      "id" : 327790044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyNzc5MDA0NA==",
      "original_commit_id" : "3c66fb4e585f727b2718af8987dcafe1cff05bbb",
      "original_position" : 55,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 292650589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327790044",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327795428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327795428"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah right, forgot to account for 32 bit platforms.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-24T19:31:59Z",
      "diff_hunk" : "@@ -0,0 +1,134 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    print_view_mem_usage(view);\n+    BOOST_CHECK_EQUAL(view.DynamicMemoryUsage(), 32);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r327795428",
      "id" : 327795428,
      "in_reply_to_id" : 327790044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyNzc5NTQyOA==",
      "original_commit_id" : "3c66fb4e585f727b2718af8987dcafe1cff05bbb",
      "original_position" : 55,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 292657569,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/327795428",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r328237794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/328237794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\ntest/validation_flush_tests.cpp(106): error: in \"validation_flush_tests/getcoinscachesizestate\": check chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, 0) == CoinsCacheSizeState::CRITICAL has failed [1 != 2]\r\n```\r\n\r\nhttps://travis-ci.org/bitcoin/bitcoin/jobs/589530820#L2957",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-25T17:06:11Z",
      "diff_hunk" : "@@ -0,0 +1,163 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    void* __ptr;\n+    constexpr bool is_64_bit = sizeof(__ptr) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.\n+\n+        for (int i{0}; i < 1000; ++i) {\n+            COutPoint res = add_coin(view);\n+            BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        }\n+\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::CRITICAL);\n+\n+        return;\n+    }\n+\n+    print_view_mem_usage(view);\n+    BOOST_CHECK_EQUAL(view.DynamicMemoryUsage(), is_64_bit ? 32 : 16);\n+\n+    // We should be able to add COINS_UNTIL_CRITICAL coins to the cache before going CRITICAL.\n+    // This is contingent not only on the dynamic memory usage of the Coins\n+    // that we're adding (COIN_SIZE bytes per), but also on how much memory the\n+    // cacheCoins (unordered_map) preallocates.\n+    //\n+    // I came up with the count by examining the printed memory usage of the\n+    // CCoinsCacheView, so it's sort of arbitrary - but it shouldn't change\n+    // unless we somehow change the way the cacheCoins map allocates memory.\n+    //\n+    constexpr int COINS_UNTIL_CRITICAL = is_64_bit ? 4 : 5;\n+\n+    for (int i{0}; i < COINS_UNTIL_CRITICAL; ++i) {\n+        COutPoint res = add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::OK);\n+    }\n+\n+    // Adding an additional coin will push us over the edge to CRITICAL.\n+    COutPoint res = add_coin(view);\n+    print_view_mem_usage(view);\n+\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::CRITICAL);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r328237794",
      "id" : 328237794,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyODIzNzc5NA==",
      "original_commit_id" : "4708fcbf99725ccb38b1f2f847aa8f7eb0e4849a",
      "original_position" : 106,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 119,
      "pull_request_review_id" : 293230080,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/328237794",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Okay, after some fiddling the unittests are passing.",
      "created_at" : "2019-09-25T19:39:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-535179389",
      "id" : 535179389,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNTE3OTM4OQ==",
      "updated_at" : "2019-09-25T19:39:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/535179389",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r329695559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329695559"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's not clear from the comment when this is expected to happen, like whether it happens on a certain type of plaform. Also it's not clear how if `DynamicMemoryUsage()` is just using `sizeof` internally, the test couldn't take this into account using the same sizeof expressions. Would at least extend comment to explain the issue.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-30T17:25:12Z",
      "diff_hunk" : "@@ -0,0 +1,170 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    void* __ptr;\n+    constexpr bool is_64_bit = sizeof(__ptr) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r329695559",
      "id" : 329695559,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyOTY5NTU1OQ==",
      "original_commit_id" : "d780c6a3ef07715330edec21fcf2882db75d9166",
      "original_position" : 59,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 62,
      "pull_request_review_id" : 295131253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329695559",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r329697146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329697146"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It might be clearer to move these fallback checks into a basic test and have the checks below be an extended test, running the basic test on all platforms and the extended test only on supported platforms. This would make the basic test more robust and easier to debug since it would run everywhere, and improve the extended test by making it shorter.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-30T17:28:43Z",
      "diff_hunk" : "@@ -0,0 +1,170 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    void* __ptr;\n+    constexpr bool is_64_bit = sizeof(__ptr) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r329697146",
      "id" : 329697146,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyOTY5NzE0Ng==",
      "original_commit_id" : "d780c6a3ef07715330edec21fcf2882db75d9166",
      "original_position" : 63,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 66,
      "pull_request_review_id" : 295131253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329697146",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r329703114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329703114"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "These magic `-1` values do not seem like the best thing. They aren't explicitly documented, assign a negative number to an unsigned type, add a runtime condition for something that is known at compile time, and cause the function to be linked against global variables that it doesn't always need.\r\n\r\nWould suggest using an overload instead of default values:\r\n\r\n```c++\r\nCoinsCacheSizeState GetCoinsCacheSizeState(const CTxMemPool& tx_pool, size_t max_coins_cache_size_bytes, int64_t max_mempool_size_bytes);\r\nCoinsCacheSizeState GetCoinsCacheSizeState(const CTxMemPool& tx_pool) {\r\n    return GetCoinsCacheSizeState(tx_pool, ::nCoinCacheUsage, gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000);\r\n}\r\n```",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-09-30T17:42:37Z",
      "diff_hunk" : "@@ -2206,13 +2206,42 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(\n+    const CTxMemPool& tx_pool,\n+    size_t max_coins_cache_size_bytes,\n+    int64_t max_mempool_size_bytes)\n+{\n+    if (max_coins_cache_size_bytes == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r329703114",
      "id" : 329703114,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyOTcwMzExNA==",
      "original_commit_id" : "d780c6a3ef07715330edec21fcf2882db75d9166",
      "original_position" : 9,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 295131253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329703114",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r335832313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/335832313"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried breaking the extended tests out but the two end up sharing so much data that it's a pain to pass it all into the extended function. If you really think this is worthwhile I can think harder about how to break it up cleanly but in the meantime I don't think it's too egregious to leave as-is.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-10-17T06:45:31Z",
      "diff_hunk" : "@@ -0,0 +1,170 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    void* __ptr;\n+    constexpr bool is_64_bit = sizeof(__ptr) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r335832313",
      "id" : 335832313,
      "in_reply_to_id" : 329697146,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzNTgzMjMxMw==",
      "original_commit_id" : "d780c6a3ef07715330edec21fcf2882db75d9166",
      "original_position" : 63,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 66,
      "pull_request_review_id" : 303032495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/335832313",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r335832412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/335832412"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good points, will fix.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-10-17T06:45:51Z",
      "diff_hunk" : "@@ -2206,13 +2206,42 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(\n+    const CTxMemPool& tx_pool,\n+    size_t max_coins_cache_size_bytes,\n+    int64_t max_mempool_size_bytes)\n+{\n+    if (max_coins_cache_size_bytes == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r335832412",
      "id" : 335832412,
      "in_reply_to_id" : 329703114,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzNTgzMjQxMg==",
      "original_commit_id" : "d780c6a3ef07715330edec21fcf2882db75d9166",
      "original_position" : 9,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 303032635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/335832412",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r335834389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/335834389"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wanted to avoid duplicating the `DynamicMemoryUsage()` calculations explicitly because they're not totally trivial and it seemed like something that'd be bad to copy/paste. To be honest I don't understand why some 64-bit Travis platforms didn't slot into these initial allocations and so I can't think of what else to say here.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-10-17T06:52:49Z",
      "diff_hunk" : "@@ -0,0 +1,170 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    void* __ptr;\n+    constexpr bool is_64_bit = sizeof(__ptr) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r335834389",
      "id" : 335834389,
      "in_reply_to_id" : 329695559,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzNTgzNDM4OQ==",
      "original_commit_id" : "d780c6a3ef07715330edec21fcf2882db75d9166",
      "original_position" : 59,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 62,
      "pull_request_review_id" : 303035177,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/335834389",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340836922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340836922"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Even if mempool is passed as a const reference can't we go further and pass only mempool memory usage ?\r\n\r\nAlso if wrapper is for test-only or convenience for its further usage inside `PopulateAndValidateSnapshot` add reason in function comment",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-10-30T20:18:51Z",
      "diff_hunk" : "@@ -720,6 +729,17 @@ class CChainState {\n     /** Update the chain tip based on database information, i.e. CoinsTip()'s best block. */\n     bool LoadChainTip(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Dictates whether we need to flush the cache to disk or not.\n+    //!\n+    //! @return the state of the size of the coins cache.\n+    CoinsCacheSizeState GetCoinsCacheSizeState(const CTxMemPool& tx_pool)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340836922",
      "id" : 340836922,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDgzNjkyMg==",
      "original_commit_id" : "b1f69a3126eb42e07ffdfdaf814c424a8fc5a7d1",
      "original_position" : 23,
      "path" : "src/validation.h",
      "position" : 23,
      "pull_request_review_id" : 309493874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340836922",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340838123"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340838123"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `nLargeThreshold` (naming conv shouldn't be same with nTotalSpace?)",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-10-30T20:21:33Z",
      "diff_hunk" : "@@ -2206,13 +2206,44 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(const CTxMemPool& tx_pool)\n+{\n+    return this->GetCoinsCacheSizeState(\n+        tx_pool,\n+        nCoinCacheUsage,\n+        gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000);\n+}\n+\n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(\n+    const CTxMemPool& tx_pool,\n+    size_t max_coins_cache_size_bytes,\n+    int64_t max_mempool_size_bytes)\n+{\n+    int64_t nMempoolUsage = tx_pool.DynamicMemoryUsage();\n+    int64_t cacheSize = CoinsTip().DynamicMemoryUsage();\n+    int64_t nTotalSpace =\n+        max_coins_cache_size_bytes + std::max<int64_t>(max_mempool_size_bytes - nMempoolUsage, 0);\n+\n+    //! No need to periodic flush if at least this much space still available.\n+    static constexpr int64_t MAX_BLOCK_COINSDB_USAGE_BYTES = 10 * 1024 * 1024;  // 10MB\n+    int64_t large_threshold =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340838123",
      "id" : 340838123,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDgzODEyMw==",
      "original_commit_id" : "b1f69a3126eb42e07ffdfdaf814c424a8fc5a7d1",
      "original_position" : 24,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 309493874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340838123",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340858159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340858159"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could we use `size_t` instead of `int64_t`? `DynamicUsage` is already returning a `size_t`?",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-10-30T21:06:31Z",
      "diff_hunk" : "@@ -720,6 +729,17 @@ class CChainState {\n     /** Update the chain tip based on database information, i.e. CoinsTip()'s best block. */\n     bool LoadChainTip(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Dictates whether we need to flush the cache to disk or not.\n+    //!\n+    //! @return the state of the size of the coins cache.\n+    CoinsCacheSizeState GetCoinsCacheSizeState(const CTxMemPool& tx_pool)\n+        EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    CoinsCacheSizeState GetCoinsCacheSizeState(\n+        const CTxMemPool& tx_pool,\n+        size_t max_coins_cache_size_bytes,\n+        int64_t max_mempool_size_bytes) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340858159",
      "id" : 340858159,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDg1ODE1OQ==",
      "original_commit_id" : "b1f69a3126eb42e07ffdfdaf814c424a8fc5a7d1",
      "original_position" : 29,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 309493874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340858159",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340885423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340885423"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmmm I spent some time trying to do the math for 32 but without a 32-bit platform it's quite hard so I've tried to observe some allocation patterns thanks to `print_view_mem_usage` on 64-bit, but given there are allocation threshold effects on how `std::unordered_map` is behaving (common practices for allocators to multiply some magic numbers by 2 after being full) we can't do hard assumptions...\r\n\r\nAnyway I think this test is really dependent on how the standard library is implemented to get the right max_coins_cache_bytes/max_mempool_size_bytes.\r\n\r\nHave you tried to run this part of the test as it is on 32-bit platform ?",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-10-30T22:19:30Z",
      "diff_hunk" : "@@ -0,0 +1,169 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    constexpr bool is_64_bit = sizeof(void*) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.\n+\n+        for (int i{0}; i < 1000; ++i) {\n+            COutPoint res = add_coin(view);\n+            BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        }\n+\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::CRITICAL);\n+\n+        return;\n+    }\n+\n+    print_view_mem_usage(view);\n+    BOOST_CHECK_EQUAL(view.DynamicMemoryUsage(), is_64_bit ? 32 : 16);\n+\n+    // We should be able to add COINS_UNTIL_CRITICAL coins to the cache before going CRITICAL.\n+    // This is contingent not only on the dynamic memory usage of the Coins\n+    // that we're adding (COIN_SIZE bytes per), but also on how much memory the\n+    // cacheCoins (unordered_map) preallocates.\n+    //\n+    // I came up with the count by examining the printed memory usage of the\n+    // CCoinsCacheView, so it's sort of arbitrary - but it shouldn't change\n+    // unless we somehow change the way the cacheCoins map allocates memory.\n+    //\n+    constexpr int COINS_UNTIL_CRITICAL = is_64_bit ? 4 : 5;\n+\n+    for (int i{0}; i < COINS_UNTIL_CRITICAL; ++i) {\n+        COutPoint res = add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::OK);\n+    }\n+\n+    if (!is_64_bit) {\n+        // On 32 bit hosts, we'll hit LARGE before CRITICAL.\n+        add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::LARGE);\n+    }\n+\n+    // Adding an additional coin will push us over the edge to CRITICAL.\n+    add_coin(view);\n+    print_view_mem_usage(view);\n+\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::CRITICAL);\n+\n+    // Passing non-zero max mempool usage should allow us more headroom.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 1 << 10),\n+        CoinsCacheSizeState::OK);\n+\n+    for (int i{0}; i < 3; ++i) {\n+        add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 1 << 10),\n+            CoinsCacheSizeState::OK);\n+    }\n+\n+    // Adding another coin with the additional mempool room will put us >90%\n+    // but not yet critical.\n+    add_coin(view);\n+    print_view_mem_usage(view);\n+\n+    // Only perform these checks on 64 bit hosts; I haven't done the math for 32.\n+    if (is_64_bit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340885423",
      "id" : 340885423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDg4NTQyMw==",
      "original_commit_id" : "028778a75f03a866b557a463bcee810a454e5404",
      "original_position" : 135,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 140,
      "pull_request_review_id" : 309493874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340885423",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340886240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340886240"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: could use MAX_MEMPOOL_SIZE_BYTES = 1024, I like bitwise but maybe not everyone :p",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-10-30T22:22:14Z",
      "diff_hunk" : "@@ -0,0 +1,169 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    constexpr bool is_64_bit = sizeof(void*) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.\n+\n+        for (int i{0}; i < 1000; ++i) {\n+            COutPoint res = add_coin(view);\n+            BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        }\n+\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::CRITICAL);\n+\n+        return;\n+    }\n+\n+    print_view_mem_usage(view);\n+    BOOST_CHECK_EQUAL(view.DynamicMemoryUsage(), is_64_bit ? 32 : 16);\n+\n+    // We should be able to add COINS_UNTIL_CRITICAL coins to the cache before going CRITICAL.\n+    // This is contingent not only on the dynamic memory usage of the Coins\n+    // that we're adding (COIN_SIZE bytes per), but also on how much memory the\n+    // cacheCoins (unordered_map) preallocates.\n+    //\n+    // I came up with the count by examining the printed memory usage of the\n+    // CCoinsCacheView, so it's sort of arbitrary - but it shouldn't change\n+    // unless we somehow change the way the cacheCoins map allocates memory.\n+    //\n+    constexpr int COINS_UNTIL_CRITICAL = is_64_bit ? 4 : 5;\n+\n+    for (int i{0}; i < COINS_UNTIL_CRITICAL; ++i) {\n+        COutPoint res = add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::OK);\n+    }\n+\n+    if (!is_64_bit) {\n+        // On 32 bit hosts, we'll hit LARGE before CRITICAL.\n+        add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::LARGE);\n+    }\n+\n+    // Adding an additional coin will push us over the edge to CRITICAL.\n+    add_coin(view);\n+    print_view_mem_usage(view);\n+\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::CRITICAL);\n+\n+    // Passing non-zero max mempool usage should allow us more headroom.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 1 << 10),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340886240",
      "id" : 340886240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDg4NjI0MA==",
      "original_commit_id" : "028778a75f03a866b557a463bcee810a454e5404",
      "original_position" : 118,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 123,
      "pull_request_review_id" : 309493874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340886240",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340912856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340912856"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just noting that the test fails on ARM ([travis-log](https://travis-ci.org/bitcoin/bitcoin/jobs/599016306?utm_medium=notification&utm_source=github_status)) because `CoinsCacheSizeState::LARGE` is not hit.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-10-31T00:05:24Z",
      "diff_hunk" : "@@ -0,0 +1,169 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    constexpr bool is_64_bit = sizeof(void*) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.\n+\n+        for (int i{0}; i < 1000; ++i) {\n+            COutPoint res = add_coin(view);\n+            BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        }\n+\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::CRITICAL);\n+\n+        return;\n+    }\n+\n+    print_view_mem_usage(view);\n+    BOOST_CHECK_EQUAL(view.DynamicMemoryUsage(), is_64_bit ? 32 : 16);\n+\n+    // We should be able to add COINS_UNTIL_CRITICAL coins to the cache before going CRITICAL.\n+    // This is contingent not only on the dynamic memory usage of the Coins\n+    // that we're adding (COIN_SIZE bytes per), but also on how much memory the\n+    // cacheCoins (unordered_map) preallocates.\n+    //\n+    // I came up with the count by examining the printed memory usage of the\n+    // CCoinsCacheView, so it's sort of arbitrary - but it shouldn't change\n+    // unless we somehow change the way the cacheCoins map allocates memory.\n+    //\n+    constexpr int COINS_UNTIL_CRITICAL = is_64_bit ? 4 : 5;\n+\n+    for (int i{0}; i < COINS_UNTIL_CRITICAL; ++i) {\n+        COutPoint res = add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::OK);\n+    }\n+\n+    if (!is_64_bit) {\n+        // On 32 bit hosts, we'll hit LARGE before CRITICAL.\n+        add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::LARGE);\n+    }\n+\n+    // Adding an additional coin will push us over the edge to CRITICAL.\n+    add_coin(view);\n+    print_view_mem_usage(view);\n+\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::CRITICAL);\n+\n+    // Passing non-zero max mempool usage should allow us more headroom.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 1 << 10),\n+        CoinsCacheSizeState::OK);\n+\n+    for (int i{0}; i < 3; ++i) {\n+        add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 1 << 10),\n+            CoinsCacheSizeState::OK);\n+    }\n+\n+    // Adding another coin with the additional mempool room will put us >90%\n+    // but not yet critical.\n+    add_coin(view);\n+    print_view_mem_usage(view);\n+\n+    // Only perform these checks on 64 bit hosts; I haven't done the math for 32.\n+    if (is_64_bit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r340912856",
      "id" : 340912856,
      "in_reply_to_id" : 340885423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDkxMjg1Ng==",
      "original_commit_id" : "028778a75f03a866b557a463bcee810a454e5404",
      "original_position" : 135,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 140,
      "pull_request_review_id" : 309589389,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340912856",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r342743813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/342743813"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah I'm beginning to think that this test is a fool's errand. I might early-exit if the first map expansion doesn't match some pattern, but in general everything feels a little flaky here.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-11-05T19:07:02Z",
      "diff_hunk" : "@@ -0,0 +1,169 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    constexpr bool is_64_bit = sizeof(void*) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.\n+\n+        for (int i{0}; i < 1000; ++i) {\n+            COutPoint res = add_coin(view);\n+            BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        }\n+\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::CRITICAL);\n+\n+        return;\n+    }\n+\n+    print_view_mem_usage(view);\n+    BOOST_CHECK_EQUAL(view.DynamicMemoryUsage(), is_64_bit ? 32 : 16);\n+\n+    // We should be able to add COINS_UNTIL_CRITICAL coins to the cache before going CRITICAL.\n+    // This is contingent not only on the dynamic memory usage of the Coins\n+    // that we're adding (COIN_SIZE bytes per), but also on how much memory the\n+    // cacheCoins (unordered_map) preallocates.\n+    //\n+    // I came up with the count by examining the printed memory usage of the\n+    // CCoinsCacheView, so it's sort of arbitrary - but it shouldn't change\n+    // unless we somehow change the way the cacheCoins map allocates memory.\n+    //\n+    constexpr int COINS_UNTIL_CRITICAL = is_64_bit ? 4 : 5;\n+\n+    for (int i{0}; i < COINS_UNTIL_CRITICAL; ++i) {\n+        COutPoint res = add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::OK);\n+    }\n+\n+    if (!is_64_bit) {\n+        // On 32 bit hosts, we'll hit LARGE before CRITICAL.\n+        add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::LARGE);\n+    }\n+\n+    // Adding an additional coin will push us over the edge to CRITICAL.\n+    add_coin(view);\n+    print_view_mem_usage(view);\n+\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::CRITICAL);\n+\n+    // Passing non-zero max mempool usage should allow us more headroom.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 1 << 10),\n+        CoinsCacheSizeState::OK);\n+\n+    for (int i{0}; i < 3; ++i) {\n+        add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 1 << 10),\n+            CoinsCacheSizeState::OK);\n+    }\n+\n+    // Adding another coin with the additional mempool room will put us >90%\n+    // but not yet critical.\n+    add_coin(view);\n+    print_view_mem_usage(view);\n+\n+    // Only perform these checks on 64 bit hosts; I haven't done the math for 32.\n+    if (is_64_bit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r342743813",
      "id" : 342743813,
      "in_reply_to_id" : 340885423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0Mjc0MzgxMw==",
      "original_commit_id" : "028778a75f03a866b557a463bcee810a454e5404",
      "original_position" : 135,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 140,
      "pull_request_review_id" : 311971665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/342743813",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r342783788"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/342783788"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Snake case is preferred in new code per the styleguide (https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c) -- I don't think naming new variables to match the naming convention of old ones is something we've asked for previously.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-11-05T20:34:02Z",
      "diff_hunk" : "@@ -2206,13 +2206,44 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(const CTxMemPool& tx_pool)\n+{\n+    return this->GetCoinsCacheSizeState(\n+        tx_pool,\n+        nCoinCacheUsage,\n+        gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000);\n+}\n+\n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(\n+    const CTxMemPool& tx_pool,\n+    size_t max_coins_cache_size_bytes,\n+    int64_t max_mempool_size_bytes)\n+{\n+    int64_t nMempoolUsage = tx_pool.DynamicMemoryUsage();\n+    int64_t cacheSize = CoinsTip().DynamicMemoryUsage();\n+    int64_t nTotalSpace =\n+        max_coins_cache_size_bytes + std::max<int64_t>(max_mempool_size_bytes - nMempoolUsage, 0);\n+\n+    //! No need to periodic flush if at least this much space still available.\n+    static constexpr int64_t MAX_BLOCK_COINSDB_USAGE_BYTES = 10 * 1024 * 1024;  // 10MB\n+    int64_t large_threshold =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r342783788",
      "id" : 342783788,
      "in_reply_to_id" : 340838123,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0Mjc4Mzc4OA==",
      "original_commit_id" : "b1f69a3126eb42e07ffdfdaf814c424a8fc5a7d1",
      "original_position" : 24,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 312023953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/342783788",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r342783853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/342783853"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-11-05T20:34:11Z",
      "diff_hunk" : "@@ -720,6 +729,17 @@ class CChainState {\n     /** Update the chain tip based on database information, i.e. CoinsTip()'s best block. */\n     bool LoadChainTip(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Dictates whether we need to flush the cache to disk or not.\n+    //!\n+    //! @return the state of the size of the coins cache.\n+    CoinsCacheSizeState GetCoinsCacheSizeState(const CTxMemPool& tx_pool)\n+        EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    CoinsCacheSizeState GetCoinsCacheSizeState(\n+        const CTxMemPool& tx_pool,\n+        size_t max_coins_cache_size_bytes,\n+        int64_t max_mempool_size_bytes) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r342783853",
      "id" : 342783853,
      "in_reply_to_id" : 340858159,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0Mjc4Mzg1Mw==",
      "original_commit_id" : "b1f69a3126eb42e07ffdfdaf814c424a8fc5a7d1",
      "original_position" : 29,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 312024062,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/342783853",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've revised the new unittest so that it passes on Travis. I don't really follow the AppVeyor failure, so would appreciate any hints there.",
      "created_at" : "2019-11-06T18:31:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-550441394",
      "id" : 550441394,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MDQ0MTM5NA==",
      "updated_at" : "2019-11-06T18:31:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/550441394",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I've revised the new unittest so that it passes on Travis. I don't really follow the AppVeyor failure, so would appreciate any hints there.\r\n\r\nAppveyor failure is a known issue and should be fixed by https://github.com/bitcoin/bitcoin/pull/17384#issuecomment-550305021\r\n\r\n\r\n",
      "created_at" : "2019-11-06T18:37:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-550443607",
      "id" : 550443607,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MDQ0MzYwNw==",
      "updated_at" : "2019-11-06T18:37:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/550443607",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r343275568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/343275568"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is fine as-is for tests.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-11-06T19:10:17Z",
      "diff_hunk" : "@@ -0,0 +1,169 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    constexpr bool is_64_bit = sizeof(void*) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.\n+\n+        for (int i{0}; i < 1000; ++i) {\n+            COutPoint res = add_coin(view);\n+            BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        }\n+\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::CRITICAL);\n+\n+        return;\n+    }\n+\n+    print_view_mem_usage(view);\n+    BOOST_CHECK_EQUAL(view.DynamicMemoryUsage(), is_64_bit ? 32 : 16);\n+\n+    // We should be able to add COINS_UNTIL_CRITICAL coins to the cache before going CRITICAL.\n+    // This is contingent not only on the dynamic memory usage of the Coins\n+    // that we're adding (COIN_SIZE bytes per), but also on how much memory the\n+    // cacheCoins (unordered_map) preallocates.\n+    //\n+    // I came up with the count by examining the printed memory usage of the\n+    // CCoinsCacheView, so it's sort of arbitrary - but it shouldn't change\n+    // unless we somehow change the way the cacheCoins map allocates memory.\n+    //\n+    constexpr int COINS_UNTIL_CRITICAL = is_64_bit ? 4 : 5;\n+\n+    for (int i{0}; i < COINS_UNTIL_CRITICAL; ++i) {\n+        COutPoint res = add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(view.AccessCoin(res).DynamicMemoryUsage(), COIN_SIZE);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::OK);\n+    }\n+\n+    if (!is_64_bit) {\n+        // On 32 bit hosts, we'll hit LARGE before CRITICAL.\n+        add_coin(view);\n+        print_view_mem_usage(view);\n+        BOOST_CHECK_EQUAL(\n+            chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+            CoinsCacheSizeState::LARGE);\n+    }\n+\n+    // Adding an additional coin will push us over the edge to CRITICAL.\n+    add_coin(view);\n+    print_view_mem_usage(view);\n+\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::CRITICAL);\n+\n+    // Passing non-zero max mempool usage should allow us more headroom.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 1 << 10),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r343275568",
      "id" : 343275568,
      "in_reply_to_id" : 340886240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MzI3NTU2OA==",
      "original_commit_id" : "028778a75f03a866b557a463bcee810a454e5404",
      "original_position" : 118,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 123,
      "pull_request_review_id" : 312674788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/343275568",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review, Russ.\r\n> replacing int64_t with size_t argument\r\n\r\nI did this to appease @ariard without thinking too hard about it but you're right, I think it doesn't make too much sense. Can revert if preferable. ",
      "created_at" : "2019-11-06T19:11:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-550457355",
      "id" : 550457355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MDQ1NzM1NQ==",
      "updated_at" : "2019-11-06T19:11:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/550457355",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r343756348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/343756348"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah thanks and so snaking case `nTotalSpace`?",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-11-07T16:45:06Z",
      "diff_hunk" : "@@ -2206,13 +2206,44 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(const CTxMemPool& tx_pool)\n+{\n+    return this->GetCoinsCacheSizeState(\n+        tx_pool,\n+        nCoinCacheUsage,\n+        gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000);\n+}\n+\n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(\n+    const CTxMemPool& tx_pool,\n+    size_t max_coins_cache_size_bytes,\n+    int64_t max_mempool_size_bytes)\n+{\n+    int64_t nMempoolUsage = tx_pool.DynamicMemoryUsage();\n+    int64_t cacheSize = CoinsTip().DynamicMemoryUsage();\n+    int64_t nTotalSpace =\n+        max_coins_cache_size_bytes + std::max<int64_t>(max_mempool_size_bytes - nMempoolUsage, 0);\n+\n+    //! No need to periodic flush if at least this much space still available.\n+    static constexpr int64_t MAX_BLOCK_COINSDB_USAGE_BYTES = 10 * 1024 * 1024;  // 10MB\n+    int64_t large_threshold =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r343756348",
      "id" : 343756348,
      "in_reply_to_id" : 340838123,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0Mzc1NjM0OA==",
      "original_commit_id" : "b1f69a3126eb42e07ffdfdaf814c424a8fc5a7d1",
      "original_position" : 24,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 313481017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/343756348",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review ACK 513981f.\r\n\r\n> Changes since last review: replacing int64_t with size_t argument (not actually sure why, since it's called with an int64_t in the commit and only ever passed to std::max<int64_t>).\r\n\r\nI think more variable types need to be updated in `GetCoinsCacheSizeState` to be `size_t` to make sense. IIRC, it's better to use size_t as it let more flexibility to the compiler to optimize for the platform addresses size.",
      "created_at" : "2019-11-07T17:04:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-551171779",
      "id" : 551171779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MTE3MTc3OQ==",
      "updated_at" : "2019-11-07T17:04:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/551171779",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Status of this PR? I guess it needs a little more review. Hopefully it shouldn't take much. The code change is simple even though the test is complicated.",
      "created_at" : "2019-11-18T19:53:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-555182147",
      "id" : 555182147,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTE4MjE0Nw==",
      "updated_at" : "2019-11-18T19:53:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555182147",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Happy to make (or at least investigate) the `size_t` change if reviewers want, but also not eager to invalidate ACKs.",
      "created_at" : "2019-11-18T20:31:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-555196304",
      "id" : 555196304,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTE5NjMwNA==",
      "updated_at" : "2019-11-18T20:31:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555196304",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Happy to make (or at least investigate) the `size_t` change if reviewers want, but also not eager to invalidate ACKs.\r\n\r\nI'm not at all concerned about the size_t thing, so feel to just push for merge or more review",
      "created_at" : "2019-11-18T21:02:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-555207388",
      "id" : 555207388,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTIwNzM4OA==",
      "updated_at" : "2019-11-18T21:02:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555207388",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r347982946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347982946"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`total_space`, `cache_size` and `mempool_usage` would make sense.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-11-19T15:14:26Z",
      "diff_hunk" : "@@ -2206,13 +2206,44 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(const CTxMemPool& tx_pool)\n+{\n+    return this->GetCoinsCacheSizeState(\n+        tx_pool,\n+        nCoinCacheUsage,\n+        gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000);\n+}\n+\n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(\n+    const CTxMemPool& tx_pool,\n+    size_t max_coins_cache_size_bytes,\n+    int64_t max_mempool_size_bytes)\n+{\n+    int64_t nMempoolUsage = tx_pool.DynamicMemoryUsage();\n+    int64_t cacheSize = CoinsTip().DynamicMemoryUsage();\n+    int64_t nTotalSpace =\n+        max_coins_cache_size_bytes + std::max<int64_t>(max_mempool_size_bytes - nMempoolUsage, 0);\n+\n+    //! No need to periodic flush if at least this much space still available.\n+    static constexpr int64_t MAX_BLOCK_COINSDB_USAGE_BYTES = 10 * 1024 * 1024;  // 10MB\n+    int64_t large_threshold =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r347982946",
      "id" : 347982946,
      "in_reply_to_id" : 340838123,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0Nzk4Mjk0Ng==",
      "original_commit_id" : "b1f69a3126eb42e07ffdfdaf814c424a8fc5a7d1",
      "original_position" : 24,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 319113714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347982946",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r347983347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347983347"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is an odd place for a constant.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-11-19T15:15:08Z",
      "diff_hunk" : "@@ -2206,13 +2206,44 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     return true;\n }\n \n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(const CTxMemPool& tx_pool)\n+{\n+    return this->GetCoinsCacheSizeState(\n+        tx_pool,\n+        nCoinCacheUsage,\n+        gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000);\n+}\n+\n+CoinsCacheSizeState CChainState::GetCoinsCacheSizeState(\n+    const CTxMemPool& tx_pool,\n+    size_t max_coins_cache_size_bytes,\n+    size_t max_mempool_size_bytes)\n+{\n+    int64_t nMempoolUsage = tx_pool.DynamicMemoryUsage();\n+    int64_t cacheSize = CoinsTip().DynamicMemoryUsage();\n+    int64_t nTotalSpace =\n+        max_coins_cache_size_bytes + std::max<int64_t>(max_mempool_size_bytes - nMempoolUsage, 0);\n+\n+    //! No need to periodic flush if at least this much space still available.\n+    static constexpr int64_t MAX_BLOCK_COINSDB_USAGE_BYTES = 10 * 1024 * 1024;  // 10MB",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r347983347",
      "id" : 347983347,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0Nzk4MzM0Nw==",
      "original_commit_id" : "73e6503a6c96f2909a766ca464e96826b560e600",
      "original_position" : 23,
      "path" : "src/validation.cpp",
      "position" : 23,
      "pull_request_review_id" : 319113714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347983347",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Happy to make (or at least investigate) the size_t change if reviewers want, but also not eager to invalidate ACKs.\r\n\r\nDon't bother for the `size_t`, not worth invalidating ACKs.",
      "created_at" : "2019-11-19T16:43:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-555597051",
      "id" : 555597051,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTU5NzA1MQ==",
      "updated_at" : "2019-11-19T16:43:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555597051",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this ready to be merged? It's a simple change that's had reviews it looks like from 5 people, including 3 reviews of the latest 513981f (Sjors ACK is for the latest code but has a different hash because he skipped the test-only commit).",
      "created_at" : "2019-11-21T14:34:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-557111829",
      "id" : 557111829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzExMTgyOQ==",
      "updated_at" : "2019-11-21T14:34:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557111829",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\n@jamesob are you going to do something about https://github.com/bitcoin/bitcoin/pull/16945/files#r342743813?",
      "created_at" : "2019-11-24T22:13:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-557933478",
      "id" : 557933478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzkzMzQ3OA==",
      "updated_at" : "2019-11-24T22:13:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557933478",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@promag the tests have been fixed to be stable on CI (see the [changes](https://github.com/bitcoin/bitcoin/compare/028778a75f03a866b557a463bcee810a454e5404..513981fe733564eddfb13de59a0e59a5c10736f9)). I agree with @ryanofsky that this seems ready for merge, but if anyone else has any feedback they feel is blocking the PR, I'm happy to address.",
      "created_at" : "2019-11-26T16:54:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-558721388",
      "id" : 558721388,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODcyMTM4OA==",
      "updated_at" : "2019-11-26T16:54:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558721388",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r351278238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/351278238"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Some explanation would be useful here.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-11-27T13:12:16Z",
      "diff_hunk" : "@@ -0,0 +1,169 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    constexpr bool is_64_bit = sizeof(void*) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r351278238",
      "id" : 351278238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MTI3ODIzOA==",
      "original_commit_id" : "513981fe733564eddfb13de59a0e59a5c10736f9",
      "original_position" : 45,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 49,
      "pull_request_review_id" : 323598154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/351278238",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r351279406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/351279406"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It should probably report when these tests are skipped, which seems to be the case on native 32 bit machines.\r\n\r\nWhy not inspect the value of `view.DynamicMemoryUsage()` to infer how many coins you need to add to reach `CRITICAL`? Alternatively, why not just keep adding coins until you do reach `CRITICAL` (with some upper bound to prevent an infinite loop if there's a serious bug)?\r\n",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-11-27T13:14:58Z",
      "diff_hunk" : "@@ -0,0 +1,170 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    void* __ptr;\n+    constexpr bool is_64_bit = sizeof(__ptr) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r351279406",
      "id" : 351279406,
      "in_reply_to_id" : 329697146,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MTI3OTQwNg==",
      "original_commit_id" : "d780c6a3ef07715330edec21fcf2882db75d9166",
      "original_position" : 63,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 66,
      "pull_request_review_id" : 323598154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/351279406",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r354445776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/354445776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> It should probably report when these tests are skipped\r\n\r\nWhat are you thinking, `BOOST_TEST_MESSAGE`?\r\n\r\n> Why not inspect the value of view.DynamicMemoryUsage() to infer how many coins you need to add to reach CRITICAL?\r\n\r\nI don't think it's that simple - different platforms/std::unordered_map implementations allocate differently, and so the current memory usage doesn't tell us enough about how memory usage will change as individual coins are added.\r\n\r\n> Alternatively, why not just keep adding coins until you do reach CRITICAL (with some upper bound to prevent an infinite loop if there's a serious bug)?\r\n\r\nThat's basically what I do below: https://github.com/bitcoin/bitcoin/pull/16945/files#diff-1c02ab3ed49056a4df577f3db9b53d30R64-R71\r\n",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-12-05T17:23:30Z",
      "diff_hunk" : "@@ -0,0 +1,170 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    void* __ptr;\n+    constexpr bool is_64_bit = sizeof(__ptr) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;\n+\n+    auto print_view_mem_usage = [](CCoinsViewCache& view) {\n+        BOOST_TEST_MESSAGE(\"CCoinsViewCache memory usage: \" << view.DynamicMemoryUsage());\n+    };\n+\n+    constexpr size_t MAX_COINS_CACHE_BYTES = 1024;\n+\n+    // Without any coins in the cache, we shouldn't need to flush.\n+    BOOST_CHECK_EQUAL(\n+        chainstate.GetCoinsCacheSizeState(tx_pool, MAX_COINS_CACHE_BYTES, /*max_mempool_size_bytes*/ 0),\n+        CoinsCacheSizeState::OK);\n+\n+    // If the initial memory allocations of cacheCoins don't match these common\n+    // cases, we can't really continue to make assertions about memory usage.\n+    // End the test early.\n+    if (view.DynamicMemoryUsage() != 32 && view.DynamicMemoryUsage() != 16) {\n+        // Add a bunch of coins to see that we at least flip over to CRITICAL.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r354445776",
      "id" : 354445776,
      "in_reply_to_id" : 329697146,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NDQ0NTc3Ng==",
      "original_commit_id" : "d780c6a3ef07715330edec21fcf2882db75d9166",
      "original_position" : 63,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 66,
      "pull_request_review_id" : 327721504,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/354445776",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r355229672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355229672"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why you choose this order (2,1,0)?",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-12-09T00:49:53Z",
      "diff_hunk" : "@@ -529,6 +529,15 @@ class CoinsViews {\n     void InitCache() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n };\n \n+enum class CoinsCacheSizeState\n+{\n+    //! The coins cache is in immediate need of a flush.\n+    CRITICAL = 2,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r355229672",
      "id" : 355229672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIyOTY3Mg==",
      "original_commit_id" : "73e6503a6c96f2909a766ca464e96826b560e600",
      "original_position" : 7,
      "path" : "src/validation.h",
      "position" : 7,
      "pull_request_review_id" : 328647633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355229672",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r356807361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/356807361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not? It's so we can make statements like https://github.com/bitcoin/bitcoin/pull/15606/commits/f8a21cd1dbde9389523e21a93c0f0b1734336996#diff-24efdb00bfbe56b140fb006b562cc70bR5331",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-12-11T20:04:50Z",
      "diff_hunk" : "@@ -529,6 +529,15 @@ class CoinsViews {\n     void InitCache() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n };\n \n+enum class CoinsCacheSizeState\n+{\n+    //! The coins cache is in immediate need of a flush.\n+    CRITICAL = 2,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r356807361",
      "id" : 356807361,
      "in_reply_to_id" : 355229672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NjgwNzM2MQ==",
      "original_commit_id" : "73e6503a6c96f2909a766ca464e96826b560e600",
      "original_position" : 7,
      "path" : "src/validation.h",
      "position" : 7,
      "pull_request_review_id" : 330808166,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-12T16:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/356807361",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've pushed [changes](https://github.com/bitcoin/bitcoin/compare/513981fe733564eddfb13de59a0e59a5c10736f9..825ab6c3b67b91f01e5d49991cc8d2f956456a13) addressing @Sjors' feedback. \r\n\r\nSo far the ACK tally for the previous HEAD (and current HEAD, less comment changes) is\r\n\r\n@promag - code review ACK\r\n@Sjors - code review ACK\r\n@ryanofsky - code review ACK\r\n@ariard - code review ACK",
      "created_at" : "2019-12-11T20:40:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-564723209",
      "id" : 564723209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDcyMzIwOQ==",
      "updated_at" : "2019-12-11T20:40:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564723209",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Travis bloodbath :-(",
      "created_at" : "2019-12-12T09:00:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-564913486",
      "id" : 564913486,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDkxMzQ4Ng==",
      "updated_at" : "2019-12-12T09:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564913486",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Travis bloodbath :-(\r\n\r\nRebased to avoid carnage by fixing a silent merge conflict.",
      "created_at" : "2019-12-12T16:30:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-565081593",
      "id" : 565081593,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NTA4MTU5Mw==",
      "updated_at" : "2019-12-12T16:30:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/565081593",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Saw this in IRC:\r\n\r\n> it's discouraging to think that #16945 probably just would've sailed through review if I hadn't bothered to add a unittest\r\n\r\nI understand the sentiment, but I also do think the unit test is hard to understand, and I would not like to have to debug it in the future. I'm comfortable acking it now with the hope that maybe it is the type of thing that's a little complicated to put in place, but once there will be reliable and useful. But if it started breaking in the future and the fix wasn't obvious I could see wanting to drop it instead of update it. \r\n\r\nThe basic problem is that is that instead of being a test of the just \r\n`GetCoinsCacheSizeState` function, it is a test of that function plus all the `DynamicMemoryUsage` functions which are very platform specific. I think a more ideal unit test would either mock or wrap the the `DynamicMemoryUsage` functions to be independent of the implementations of those functions.\r\n\r\n",
      "created_at" : "2019-12-17T16:59:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-566653236",
      "id" : 566653236,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NjY1MzIzNg==",
      "updated_at" : "2019-12-17T16:59:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/566653236",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The basic problem is that is that instead of being a test of the just\r\nGetCoinsCacheSizeState function, it is a test of that function plus all the DynamicMemoryUsage functions which are very platform specific. I think a more ideal unit test would either mock or wrap the the DynamicMemoryUsage functions to be independent of the implementations of those functions.\r\n\r\nPersonally I think it's more desirable to have wider/incidental coverage (at the expense of lower specificity in terms of what failed) because the coins cache is a critically important part of the system. We should be alerted if e.g. the size of the coins cache entries changes, since that has pretty drastic effects on performance. Our unittest coverage is paltry as it stands, and when that's the case I tend more towards adding integration- rather than strict unit-tests to get as much coverage out of what few tests we do have.\r\n\r\nI'd much prefer to be hyper-aware of what's going on with the coins cache and have to update a few tests once in a while than risk being unaware of even a small change to such an important part of the system. If there are ways I can make the test clearer or better, I'm all ears, but I am very hesitant to look to mocks - not only because that will probably require substantive changes to code purely for the sake of testing, but because for a system like Bitcoin it seems preferable have overzealous test coverage than the illusion of it thanks to a constellation of mocks.\r\n\r\nThere is an argument to be made that a test about when to flush the cache isn't an appropriate place to make assertions about the size of its contents, but it was convenient and this stuff wasn't tested so I figured better have it somewhere than not at all.",
      "created_at" : "2019-12-17T21:16:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-566752559",
      "id" : 566752559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2Njc1MjU1OQ==",
      "updated_at" : "2019-12-17T21:16:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/566752559",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r359033578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/359033578"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is that change good or would you prefer to see something else?",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2019-12-17T21:18:57Z",
      "diff_hunk" : "@@ -0,0 +1,169 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <sync.h>\n+#include <test/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_flush_tests, BasicTestingSetup)\n+\n+//! Test utilities for detecting when we need to flush the coins cache based\n+//! on estimated memory usage.\n+//!\n+//! @sa CChainState::GetCoinsCacheSizeState()\n+//!\n+BOOST_AUTO_TEST_CASE(getcoinscachesizestate)\n+{\n+    BlockManager blockman{};\n+    CChainState chainstate{blockman};\n+    chainstate.InitCoinsDB(/*cache_size_bytes*/ 1 << 10, /*in_memory*/ true, /*should_wipe*/ false);\n+    WITH_LOCK(::cs_main, chainstate.InitCoinsCache());\n+    CTxMemPool tx_pool{};\n+\n+    constexpr bool is_64_bit = sizeof(void*) == 8;\n+\n+    LOCK(::cs_main);\n+    auto& view = chainstate.CoinsTip();\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    constexpr int COIN_SIZE = is_64_bit ? 80 : 64;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r359033578",
      "id" : 359033578,
      "in_reply_to_id" : 351278238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1OTAzMzU3OA==",
      "original_commit_id" : "513981fe733564eddfb13de59a0e59a5c10736f9",
      "original_position" : 45,
      "path" : "src/test/validation_flush_tests.cpp",
      "position" : 49,
      "pull_request_review_id" : 333586805,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2019-12-17T21:18:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/359033578",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It seems like this has had enough review, but some of the previous reviews are out of date. @promag, @Sjors, @ariard maybe you could reack?",
      "created_at" : "2020-01-08T21:57:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-572276562",
      "id" : 572276562,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MjI3NjU2Mg==",
      "updated_at" : "2020-01-08T21:57:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/572276562",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review ACK 02b9511.\r\n\r\nChanges since 513981f, documenting better new test and printing an exit message in case of exotic archs.",
      "created_at" : "2020-01-09T16:54:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#issuecomment-572653422",
      "id" : 572653422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16945",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MjY1MzQyMg==",
      "updated_at" : "2020-01-09T16:54:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/572653422",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r364914626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364914626"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok.",
      "commit_id" : "02b9511d6bace5711e454d2b685b2fee0d65e341",
      "created_at" : "2020-01-09T19:15:37Z",
      "diff_hunk" : "@@ -529,6 +529,15 @@ class CoinsViews {\n     void InitCache() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n };\n \n+enum class CoinsCacheSizeState\n+{\n+    //! The coins cache is in immediate need of a flush.\n+    CRITICAL = 2,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16945#discussion_r364914626",
      "id" : 364914626,
      "in_reply_to_id" : 355229672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDkxNDYyNg==",
      "original_commit_id" : "73e6503a6c96f2909a766ca464e96826b560e600",
      "original_position" : 7,
      "path" : "src/validation.h",
      "position" : 7,
      "pull_request_review_id" : 340754212,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16945",
      "updated_at" : "2020-01-09T19:15:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364914626",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
