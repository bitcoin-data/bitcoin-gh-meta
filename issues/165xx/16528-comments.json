[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18774 (test: added test for upgradewallet RPC by brakmic)\n* #18727 (test: Add CreateWalletFromFile test by ryanofsky)\n* #18699 (wallet: Avoid translating RPC errors by MarcoFalke)\n* #18654 (rpc: separate bumpfee's psbt creation function into psbtbumpfee by achow101)\n* #18618 (gui: Drop RecentRequestsTableModel dependency to WalletModel by promag)\n* #18617 (test: add factor option to adjust test timeouts by brakmic)\n* #18608 (refactor: Remove CAddressBookData::destdata by ryanofsky)\n* #18570 (rpc: return block hash & height in getbalances, gettransaction & getwalletinfo JSONs by brakmic)\n* #18479 (RPC: Show fee in results for signrawtransaction* for segwit inputs by luke-jr)\n* #18244 (rpc: fundrawtransaction and walletcreatefundedpsbt respect locks even with manual coin selection by Sjors)\n* #17977 ([WIP] Implement BIP 340-342 validation (Schnorr/taproot/tapscript) by sipa)\n* #17877 (qt, refactor: Make enums in BitcoinUnits class scoped by hebasto)\n* #16463 ([BIP 174] Implement serialization support for GLOBAL_XPUB field. by achow101)\n* #16432 (qt: Add privacy to the Overview page by hebasto)\n* #16224 (gui: Bilingual GUI error messages by hebasto)\n* #11413 ([wallet] [rpc] sendtoaddress/sendmany: Add explicit feerate option by kallewoof)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-08-02T03:23:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-517532927",
      "id" : 517532927,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNzUzMjkyNw==",
      "updated_at" : "2020-04-27T00:46:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/517532927",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Strong Concept ACK, this should be much nicer now it is preceded by the rework.",
      "created_at" : "2019-08-02T03:25:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-517533269",
      "id" : 517533269,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNzUzMzI2OQ==",
      "updated_at" : "2019-08-02T03:25:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/517533269",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Approach ACK. It looks pretty straight forward and thanks to The Box feels cleaner than the previous attempt. \r\n\r\nI suggest that, after a bit more progress on #16341, we review this in parallel. That ensures that we don't mess up the division of labour between `ScriptPubKeyMan` and its subclasses.\r\n\r\nAlso concept ACK on using BIP44/49/84 for new descriptor wallets. That may need some discussion, because it means individual addresses are no longer hardened.\r\n\r\nSome issues I found perusing the commits:\r\n* when you restart bitcoind and load a (watch-only) wallet the keypool is empty and `getnewaddress` no longer works\r\n* `importdescriptors` should no longer require a `range` argument (~also I would prefer a singular RPC~ nvm that makes rescan slow)\r\n* when calling `getnewaddress` with an address type for which the wallet misses a descriptor, it returns a blank `error message:` \r\n* can you give each ScriptPubKeyManager it's own file?\r\n* deleting `GetMetadata` and `Upgrade` inside `Introduce WalletDescriptor`; should have its own commit?\r\n* `ScriptPubKeyMap` could be introduced in `Implement IsMine` instead of the earlier commit. Would it make sense to move this into the Descriptor class? How are infinite range descriptors handled, expanded and cached `keypoolsize` items at a time?\r\n* Am I reading this wrong or is `SetupGeneration` creating a fresh seed for each descriptor?\r\n* I'm not a fan of determining the output type in an indirect manner by expanding the descriptor `Optional<OutputType> out_script_type = DetermineOutputType(scripts_temp[0], out_keys);`; that information is already encoded in the descriptor. Shameless plug for #15590.",
      "created_at" : "2019-08-03T08:23:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-517905778",
      "id" : 517905778,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNzkwNTc3OA==",
      "updated_at" : "2019-08-03T09:40:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/517905778",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK.\r\n\r\n@achow101 I just noticed that both the existing `deriveaddressses` & `importmulti` commands treat descriptor `[range_start, range_end]` as inclusive, which is consistent with the common understanding of the notation `[]`. Should we update the new `importdescriptors` command to do the same (make range_end inclusive)?\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/master/src/rpc/misc.cpp#L215\r\nhttps://github.com/bitcoin/bitcoin/blob/master/src/wallet/rpcdump.cpp#L1122",
      "created_at" : "2019-08-12T14:57:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-520460635",
      "id" : 520460635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDQ2MDYzNQ==",
      "updated_at" : "2019-08-12T14:59:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520460635",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4769925?v=4",
         "events_url" : "https://api.github.com/users/hugohn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hugohn/followers",
         "following_url" : "https://api.github.com/users/hugohn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hugohn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hugohn",
         "id" : 4769925,
         "login" : "hugohn",
         "node_id" : "MDQ6VXNlcjQ3Njk5MjU=",
         "organizations_url" : "https://api.github.com/users/hugohn/orgs",
         "received_events_url" : "https://api.github.com/users/hugohn/received_events",
         "repos_url" : "https://api.github.com/users/hugohn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hugohn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hugohn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hugohn"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Should we update the new `importdescriptors` command to do the same (make range_end inclusive)?\r\n\r\nI guess so. Latest pushed should do that.",
      "created_at" : "2019-08-12T16:20:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-520494128",
      "id" : 520494128,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDQ5NDEyOA==",
      "updated_at" : "2019-08-12T16:20:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520494128",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Due to your latest change upstream, this now complains: `scriptpubkeyman.h:516:10: warning: 'CheckDecryptionKey' overrides a member function but is not marked 'override' `",
      "created_at" : "2019-10-10T16:50:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-540675668",
      "id" : 540675668,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MDY3NTY2OA==",
      "updated_at" : "2019-10-10T16:50:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/540675668",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fixed the warning.",
      "created_at" : "2019-10-10T19:13:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-540736034",
      "id" : 540736034,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MDczNjAzNA==",
      "updated_at" : "2019-10-10T19:13:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/540736034",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rescanning is broken for (some?) descriptor wallets, both when importing descriptors and when calling `rescanblockchain`. It does detect new transactions. Example:\r\n\r\n```\r\n# Drop coins on a random address in the default wallet\r\nbitcoin-cli -regtest -rpcwallet=\"\" generatetoaddress 101 `bitcoin-cli -regtest -rpcwallet=\"\" getnewaddress`\r\nsrc/bitcoin-cli -regtest createwallet T false true \"\" true true\r\nsrc/bitcoin-cli -regtest -rpcwallet=T importdescriptors '[{\"desc\": \"wpkh([00000001/84h/1h/0h]tprv8ZgxMBicQKsPd7Uf69XL1XwhmjHopUGep8GuEiJDZmbQz6o58LninorQAfcKZWARbtRtfnLcJ5MQ2AtHcQJCCRUcMRvmDUjyEmNUWwx8UbK/0/*)#slxu8rmv\", \"timestamp\": 0, \"range\": [0,1], \"internal\": false, \"active\": true}]'\r\nbitcoin-cli -regtest -rpcwallet=T getnewaddress\r\nbitcoin-cli -regtest -rpcwallet=T getaddressinfo bcrt1qm90ugl4d48jv8n6e5t9ln6t9zlpm5th68x4f8g\r\nsrc/bitcoin-cli -regtest -rpcwallet=\"\" sendtoaddress bcrt1qm90ugl4d48jv8n6e5t9ln6t9zlpm5th68x4f8g 1\r\nbitcoin-cli -regtest -rpcwallet=\"\" generatetoaddress 1 `bitcoin-cli -regtest -rpcwallet=\"\" getnewaddress`\r\nbitcoin-cli -regtest -rpcwallet=T listunspent 0 9999999 '[]' true\r\n```\r\n\r\nThe last command should show the UTXO.\r\n\r\nCreate another wallet and repeat the `importdescriptors` call. UTXO won't show up:\r\n\r\n```\r\nsrc/bitcoin-cli -regtest createwallet T2 false true \"\" true true\r\nsrc/bitcoin-cli -regtest -rpcwallet=T2 importdescriptors '[{\"desc\": \"wpkh([00000001/84h/1h/0h]tprv8ZgxMBicQKsPd7Uf69XL1XwhmjHopUGep8GuEiJDZmbQz6o58LninorQAfcKZWARbtRtfnLcJ5MQ2AtHcQJCCRUcMRvmDUjyEmNUWwx8UbK/0/*)#slxu8rmv\", \"timestamp\": 0, \"range\": [0,1], \"internal\": false, \"active\": true}]'\r\nbitcoin-cli -regtest -rpcwallet=T2 listunspent 0 9999999 '[]' true\r\n```\r\n\r\nWhen you send it new coins, those do show up.\r\n\r\nAlso note the address is incorrectly marked as `ischange` (but the derivation is correct). Might be unrelated though; the wallet determines IsChange() by checking if it's in the address book (yuck).\r\n\r\nUpdate: I can no longer reproduce this (d7ca9abe4b817913852abbd48082bde64df8e9d9)",
      "created_at" : "2019-11-05T11:18:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-549780152",
      "id" : 549780152,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0OTc4MDE1Mg==",
      "updated_at" : "2019-11-07T15:38:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549780152",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I wrote a test to check `sortedmulti()` origins: https://github.com/Sjors/bitcoin/commit/04610844704aee8fb7cd6f94167a767f5473d281\r\n\r\nUnfortunately this test passes, so I can't reproduce the bug I was chasing just yet. I was seeing an origin-pubkey mismatch for sortedmulti() descriptors.\r\n\r\n_Update: fairly certain I was chasing a ghost. Hopefully the tests are useful._",
      "created_at" : "2020-01-20T18:53:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-576394411",
      "id" : 576394411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NjM5NDQxMQ==",
      "updated_at" : "2020-01-21T19:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/576394411",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I could not replicate any bugs with `sortedmulti` descriptors.",
      "created_at" : "2020-01-21T18:29:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-576816376",
      "id" : 576816376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NjgxNjM3Ng==",
      "updated_at" : "2020-01-21T18:29:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/576816376",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased onto master, now ready for review.",
      "created_at" : "2020-01-30T05:00:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-580083947",
      "id" : 580083947,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDA4Mzk0Nw==",
      "updated_at" : "2020-01-30T05:00:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580083947",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept and approach re-ACK\r\n\r\nI rebased my HWI support PRs on top of this:  #16546 (RPC) and #16549 (GUI).\r\n\r\nThe first commit could go to an independent PR:\r\n* `Output a descriptor in createmultisig`\r\n\r\nAnd a few that could be done before this PR, just to get the number of commits down a bit :-)\r\n* ~`Introduce SetType function to tell ScriptPubKeyMans the type and internal-ness of it`~ (empty for legacy)\r\n* `Change wallet_encryption.py to use signmessage instead of dumpprivkey`\r\n* d3819b681f766a17deef4650bd6297178924f04b  `Change GetMetadata to use unique_ptr<CKeyMetadata>`\r\n* c80e25d8743d7e5bfe866d32bf394cf55166bde5  `Add a function to determine the `OutputType` of a scriptPubKey` (`DetermineOutputType` should be contrasted to getting this information directly from the descriptor like in #15590)\r\n* 0fc666f32ff8472215e05e85dd609901a02dc3ae  `Add IsLegacy to CWallet so that the GUI knows whether to show watchonly`\r\n\r\nSome of my [earlier comments](https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-517905778) are still relevant:\r\n* I'm ambivalent about using BIP44/49/84 for new descriptor wallets. Downside is that individual addresses are no longer hardened. Upside is that this many other wallets use this standard and we could even consider BIP39 backup at some point (#17748). Perhaps `createwallet` (and the GUI) could make the use of BIP44/49/84 optional.\r\n* `importdescriptors` should no longer require a range argument\r\n* `importdescriptor` could be a singular RPC (less tedious when used manually). It could drop the `timestamp` argument in favor of just calling `rescanblockchain` after import.\r\n\r\nI think we should split `scriptpubkeyman.{h,cpp}` into `scriptpubkeyman.{h,cpp}` , `legacy_scriptpubkeyman.{h,cpp}`  and `descriptor_scriptpubkeyman.{h,cpp}` (although meh because it creates large diff, but maybe better to get it over with).",
      "created_at" : "2020-01-30T12:38:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-580233543",
      "id" : 580233543,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDIzMzU0Mw==",
      "updated_at" : "2020-01-30T14:26:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580233543",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r372959221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372959221"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Whether it's P2SH depends on `address_type`, so maybe just say \"The descriptor for this multisig address\\\"",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-30T13:53:17Z",
      "diff_hunk" : "@@ -83,6 +83,7 @@ static UniValue createmultisig(const JSONRPCRequest& request)\n             \"{\\n\"\n             \"  \\\"address\\\":\\\"multisigaddress\\\",  (string) The value of the new multisig address.\\n\"\n             \"  \\\"redeemScript\\\":\\\"script\\\"       (string) The string value of the hex-encoded redemption script.\\n\"\n+            \"  \\\"descriptor\\\":\\\"descriptor\\\"     (string) The descriptor for the P2SH address for this multisig\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r372959221",
      "id" : 372959221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1OTIyMQ==",
      "original_commit_id" : "dd92677895de134c77b318cf7e27e2471a10842c",
      "original_line" : 86,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/misc.cpp",
      "position" : null,
      "pull_request_review_id" : 350837022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372959221",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r372983424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372983424"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In  e40a833c3bffb0cf723357238eb809398e3e5237 `Create LegacyScriptPubKeyMan when not a descriptor wallet`: accidentally dropping `Upgrade()`?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-30T14:34:32Z",
      "diff_hunk" : "@@ -1486,11 +1486,6 @@ bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal)\n     return false;\n }\n \n-bool DescriptorScriptPubKeyMan::Upgrade(int prev_version, std::string& error)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r372983424",
      "id" : 372983424,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk4MzQyNA==",
      "original_commit_id" : "e40a833c3bffb0cf723357238eb809398e3e5237",
      "original_line" : 1489,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 350837022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372983424",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r372985994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372985994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The new dummy class in 3f6cbc5bb16f8a021bbe88d998b12698205aaeac introduces several compiler problems (rebase slippage?), e.g:\r\n```\r\n./wallet/scriptpubkeyman.h:483:41: error: non-virtual member function marked 'override' hides virtual member function\r\n    void KeepDestination(int64_t index) override;\r\n```",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-30T14:38:58Z",
      "diff_hunk" : "@@ -467,4 +468,52 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;\n+\n+    bool GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error) override;\n+    isminetype IsMine(const CScript& script) const override;\n+\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys = false) override;\n+    bool Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch) override;\n+\n+    bool GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool) override;\n+    void KeepDestination(int64_t index) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r372985994",
      "id" : 372985994,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk4NTk5NA==",
      "original_commit_id" : "3f6cbc5bb16f8a021bbe88d998b12698205aaeac",
      "original_line" : 483,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 350837022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372985994",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373229817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373229817"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Dropped the commit, but fixed in the separate PR for descriptors in `createmultisig`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-30T22:32:23Z",
      "diff_hunk" : "@@ -83,6 +83,7 @@ static UniValue createmultisig(const JSONRPCRequest& request)\n             \"{\\n\"\n             \"  \\\"address\\\":\\\"multisigaddress\\\",  (string) The value of the new multisig address.\\n\"\n             \"  \\\"redeemScript\\\":\\\"script\\\"       (string) The string value of the hex-encoded redemption script.\\n\"\n+            \"  \\\"descriptor\\\":\\\"descriptor\\\"     (string) The descriptor for the P2SH address for this multisig\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373229817",
      "id" : 373229817,
      "in_reply_to_id" : 372959221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIyOTgxNw==",
      "original_commit_id" : "dd92677895de134c77b318cf7e27e2471a10842c",
      "original_line" : 86,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/misc.cpp",
      "position" : null,
      "pull_request_review_id" : 351188746,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373229817",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373229896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373229896"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It should be dropped, but not in that commit. Moved it to the dummy class definition.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-30T22:32:38Z",
      "diff_hunk" : "@@ -1486,11 +1486,6 @@ bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal)\n     return false;\n }\n \n-bool DescriptorScriptPubKeyMan::Upgrade(int prev_version, std::string& error)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373229896",
      "id" : 373229896,
      "in_reply_to_id" : 372983424,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIyOTg5Ng==",
      "original_commit_id" : "e40a833c3bffb0cf723357238eb809398e3e5237",
      "original_line" : 1489,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 351188848,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373229896",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373230082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373230082"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since this gets dropped later, dropped this at the dummy class definition.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-30T22:33:04Z",
      "diff_hunk" : "@@ -467,4 +468,52 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;\n+\n+    bool GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error) override;\n+    isminetype IsMine(const CScript& script) const override;\n+\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys = false) override;\n+    bool Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch) override;\n+\n+    bool GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool) override;\n+    void KeepDestination(int64_t index) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373230082",
      "id" : 373230082,
      "in_reply_to_id" : 372985994,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIzMDA4Mg==",
      "original_commit_id" : "3f6cbc5bb16f8a021bbe88d998b12698205aaeac",
      "original_line" : 483,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 351189052,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373230082",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Moved `Output a descriptor in createmultisig` to it's own PR and dropped it from here since it isn't actually used in descriptor wallets.\r\n\r\nI will investigate breaking out the other commits.\r\n\r\n>     * I'm ambivalent about using BIP44/49/84 for new descriptor wallets. Downside is that individual addresses are no longer hardened. Upside is that this many other wallets use this standard and we could even consider BIP39 backup at some point (#17748). Perhaps `createwallet` (and the GUI) could make the use of BIP44/49/84 optional.\r\n\r\nAFAICT, the reasoning for using exclusively hardened derivation is because we could export private keys with `dumpprivkey` and that has issues. But since that is disabled for descriptor wallets, I think it's fine.\r\n\r\n>     * `importdescriptors` should no longer require a range argument\r\n\r\nWhy?\r\n\r\n>     * `importdescriptor` could be a singular RPC (less tedious when used manually). It could drop the `timestamp` argument in favor of just calling `rescanblockchain` after import.\r\n\r\nI suppose, but I don't really want there to be multiple commands that do fundamentally the same thing.\r\n\r\n> I think we should split `scriptpubkeyman.{h,cpp}` into `scriptpubkeyman.{h,cpp}` , `legacy_scriptpubkeyman.{h,cpp}` and `descriptor_scriptpubkeyman.{h,cpp}` (although meh because it creates large diff, but maybe better to get it over with).\r\n\r\nMeh.",
      "created_at" : "2020-01-30T22:34:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-580494041",
      "id" : 580494041,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDQ5NDA0MQ==",
      "updated_at" : "2020-01-30T22:40:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580494041",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Descriptors can be expanded indefinitely, so why specify a (mandatory) range on import? It might make sense as an optional field to set a boundary, e.g. if you know the external signing device has a range limit.\r\n\r\n> AFAICT, the reasoning for using exclusively hardened derivation is because we could export private keys with dumpprivkey and that has issues. But since that is disabled for descriptor wallets, I think it's fine.\r\n\r\nI'm not familiar with the history. Another reason could be that if one private key is compromised in a side-channel attack, the other keys are still safe. But that assumes such a side-channel attack, couldn't also compromise the master key. Or perhaps a (horrible) bug in the signing code causes a private key to leak on chain. Or someone wants to reenable `dumpprivkey` again to redeem some fork coin. Using `m/{0,1,2}'/{0,1}'/k` by default and making BIP44/49/84 opt-in (in a followup) seems less of change from status quo.\r\n\r\n> I don't really want there to be multiple commands that do fundamentally the same thing.\r\n\r\nDo you mean having similar commands (`importmulti` and `importdescriptors`) with different options? I like consistency, as do developers who want a simple path to switch their integration over to descriptor wallets. But I also like the rare opportunity to clean up the RPC. And when people have to copy-paste some magic to import keys from a hardware wallet, this new syntax looks less intimidating. Though ideally that shouldn't be needed at all.  \r\n\r\n\r\nThe [AppVeyor failure](https://ci.appveyor.com/project/DrahtBot/bitcoin/builds/30473125#L4131) might be legit `wallet_importdescriptors.py` encounters `JSONRPCException: bad-txns-inputs-missingorspent (-25)`, albeit odd.\r\n\r\nIn f83fde4e8e13a254083e9433dfa770a8b52b1053 `Create LegacyScriptPubKeyMan when not a descriptor wallet` you're also introducing `class WalletDescriptor`; that was supposed to be a separate commit?\r\n\r\nYou're serialising the descriptor as a string (in `WalletDescriptor`). That's fine with me, I'd rather not delay this work, and we can change the serialisation later. However there's been some [mailinglist discussion](https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2019-December/017529.html) about serialising descriptors into something that's easier to copy/paste and put in a QR code. Maybe that's worth working out in a separate PR and then to use that for the wallet as well. Added a an issue for it #18043.",
      "created_at" : "2020-01-31T10:35:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-580679648",
      "id" : 580679648,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDY3OTY0OA==",
      "updated_at" : "2020-01-31T16:25:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580679648",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373572192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373572192"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In ee6980be437c09df6044a5ced7caa91410453027 `Introduce DescriptorScriptPubKeyMan as a dummy class`: this line (`using ScriptPubKeyMan::ScriptPubKeyMan;`) is dropped in 7af1a569567a595dc26c33075632f406c4ff0904.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-31T16:36:24Z",
      "diff_hunk" : "@@ -467,4 +468,49 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373572192",
      "id" : 373572192,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU3MjE5Mg==",
      "original_commit_id" : "ee6980be437c09df6044a5ced7caa91410453027",
      "original_line" : 474,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 351628547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373572192",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373574359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373574359"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: these are added, but not used, in 7af1a569567a595dc26c33075632f406c4ff0904 `Store WalletDescriptor in DescriptorScriptPubKeyMan` which seems out of the blue. b784a150b23e10ee794d1d2616a0df5c0f317fef seems a better place.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-31T16:40:55Z",
      "diff_hunk" : "@@ -60,8 +60,10 @@ extern const std::string CRYPTED_KEY;\n extern const std::string CSCRIPT;\n extern const std::string DEFAULTKEY;\n extern const std::string DESTDATA;\n+extern const std::string EXTERNALSPK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373574359",
      "id" : 373574359,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU3NDM1OQ==",
      "original_commit_id" : "7af1a569567a595dc26c33075632f406c4ff0904",
      "original_line" : 64,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 351628547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373574359",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373579192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373579192"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 7af1a569567a595dc26c33075632f406c4ff0904: `ScriptPubKeyMap`'s `uint32_t` changes to `int32_t` in e7e62209a176a00a03657e6fe8fd221bf2821bf5",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-31T16:50:47Z",
      "diff_hunk" : "@@ -470,8 +470,17 @@ class LegacySigningProvider : public SigningProvider\n \n class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n {\n+private:\n+    WalletDescriptor descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, uint32_t>; // Map of scripts to descriptor range index",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373579192",
      "id" : 373579192,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU3OTE5Mg==",
      "original_commit_id" : "7af1a569567a595dc26c33075632f406c4ff0904",
      "original_line" : 476,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 351628547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373579192",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373612485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373612485"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ee6980be437c09df6044a5ced7caa91410453027:  `void RewriteDB() override;` is dropped in fd995af379b73b63b78b276b5b8f31d39b2d2b67",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-01-31T18:09:19Z",
      "diff_hunk" : "@@ -467,4 +468,49 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;\n+\n+    bool GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error) override;\n+    isminetype IsMine(const CScript& script) const override;\n+\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys = false) override;\n+    bool Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch) override;\n+\n+    bool GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool) override;\n+    void ReturnDestination(int64_t index, bool internal, const CTxDestination& addr) override;\n+\n+    bool TopUp(unsigned int size = 0) override;\n+\n+    void MarkUnusedAddresses(const CScript& script) override;\n+\n+    bool IsHDEnabled() const override;\n+\n+    bool SetupGeneration(bool force = false) override;\n+\n+    bool HavePrivateKeys() const override;\n+\n+    void RewriteDB() override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r373612485",
      "id" : 373612485,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMjQ4NQ==",
      "original_commit_id" : "ee6980be437c09df6044a5ced7caa91410453027",
      "original_line" : 495,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 351628547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373612485",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Related 31 January wallet meeting discussion:\r\nhttp://www.erisian.com.au/meetbot/bitcoin-core-dev/2020/bitcoin-core-dev.2020-01-31-19.00.log.html",
      "created_at" : "2020-01-31T19:59:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-580888293",
      "id" : 580888293,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDg4ODI5Mw==",
      "updated_at" : "2020-01-31T19:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580888293",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-02-04T21:08:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-582115685",
      "id" : 582115685,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MjExNTY4NQ==",
      "updated_at" : "2020-02-04T21:08:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582115685",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r377827327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377827327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's intentional. The `using ScriptPubKeyMan::ScriptPubKeyMan;` is needed to use the default `ScriptPubKeyMan` constructor until we add a custom one for `DescriptorScriptPubKeyMan`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-11T18:47:09Z",
      "diff_hunk" : "@@ -467,4 +468,49 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r377827327",
      "id" : 377827327,
      "in_reply_to_id" : 373572192,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgyNzMyNw==",
      "original_commit_id" : "ee6980be437c09df6044a5ced7caa91410453027",
      "original_line" : 474,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 356903809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377827327",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r377853944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377853944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Moved",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-11T19:35:49Z",
      "diff_hunk" : "@@ -60,8 +60,10 @@ extern const std::string CRYPTED_KEY;\n extern const std::string CSCRIPT;\n extern const std::string DEFAULTKEY;\n extern const std::string DESTDATA;\n+extern const std::string EXTERNALSPK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r377853944",
      "id" : 377853944,
      "in_reply_to_id" : 373574359,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg1Mzk0NA==",
      "original_commit_id" : "7af1a569567a595dc26c33075632f406c4ff0904",
      "original_line" : 64,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 356937290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377853944",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r377854006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377854006"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Changed",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-11T19:35:55Z",
      "diff_hunk" : "@@ -470,8 +470,17 @@ class LegacySigningProvider : public SigningProvider\n \n class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n {\n+private:\n+    WalletDescriptor descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, uint32_t>; // Map of scripts to descriptor range index",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r377854006",
      "id" : 377854006,
      "in_reply_to_id" : 373579192,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg1NDAwNg==",
      "original_commit_id" : "7af1a569567a595dc26c33075632f406c4ff0904",
      "original_line" : 476,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 356937361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377854006",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r377854045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377854045"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Dropped",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-11T19:36:00Z",
      "diff_hunk" : "@@ -467,4 +468,49 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;\n+\n+    bool GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error) override;\n+    isminetype IsMine(const CScript& script) const override;\n+\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys = false) override;\n+    bool Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch) override;\n+\n+    bool GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool) override;\n+    void ReturnDestination(int64_t index, bool internal, const CTxDestination& addr) override;\n+\n+    bool TopUp(unsigned int size = 0) override;\n+\n+    void MarkUnusedAddresses(const CScript& script) override;\n+\n+    bool IsHDEnabled() const override;\n+\n+    bool SetupGeneration(bool force = false) override;\n+\n+    bool HavePrivateKeys() const override;\n+\n+    void RewriteDB() override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r377854045",
      "id" : 377854045,
      "in_reply_to_id" : 373612485,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg1NDA0NQ==",
      "original_commit_id" : "ee6980be437c09df6044a5ced7caa91410453027",
      "original_line" : 495,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 356937407,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377854045",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've rebased this on top of #18115 and #18034. I'll start addressing other issues tomorrow.\r\n\r\nI believe I've fixed the random failure of `wallet_importdescriptors.py` as well.",
      "created_at" : "2020-02-12T00:37:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-584946241",
      "id" : 584946241,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDk0NjI0MQ==",
      "updated_at" : "2020-02-12T00:37:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584946241",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r378112191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378112191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This trips up AppVeyor:\r\n```\r\nC:\\projects\\bitcoin\\src\\rpc\\rawtransaction_util.h(27,132): error C2039: 'string': is not a member of 'std' [C:\\projects\\bitcoin\\build_msvc\\libbitcoin_common\\libbitcoin_common.vcxproj]\r\n63C:\\projects\\bitcoin\\src\\rpc\\rawtransaction_util.h(27,138): error C2065: 'string': undeclared identifier [C:\\projects\\bitcoin\\build_msvc\\libbitcoin_common\\libbitcoin_common.vcxproj]\r\n64C:\\projects\\bitcoin\\src\\rpc\\rawtransaction_util.h(27,118): error C2923: 'std::map': 'string' is not a valid template type argument for parameter '_Ty' \r\n```",
      "commit_id" : "20d6303cf744bb8bd0c0a9cb75904cd323ba9a02",
      "created_at" : "2020-02-12T08:54:37Z",
      "diff_hunk" : "@@ -24,6 +24,7 @@ class SigningProvider;\n  * @param result         JSON object where signed transaction results accumulate\n  */\n void SignTransaction(CMutableTransaction& mtx, const SigningProvider* keystore, const std::map<COutPoint, Coin>& coins, const UniValue& hashType, UniValue& result);\n+void MakeSignTransactionResult(CMutableTransaction& mtx, bool complete, const std::map<COutPoint, Coin>& coins, std::map<int, std::string>& input_errors, UniValue& result);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r378112191",
      "id" : 378112191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODExMjE5MQ==",
      "original_commit_id" : "20d6303cf744bb8bd0c0a9cb75904cd323ba9a02",
      "original_position" : 4,
      "path" : "src/rpc/rawtransaction_util.h",
      "position" : 4,
      "pull_request_review_id" : 357277072,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "updated_at" : "2020-02-12T08:54:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378112191",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've removed the requirement for `range` in `importdescriptors`. It will give a warning and use the default keypool range.",
      "created_at" : "2020-02-14T20:16:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-586456127",
      "id" : 586456127,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NjQ1NjEyNw==",
      "updated_at" : "2020-02-14T20:16:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/586456127",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r381325869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381325869"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should this be `GetSolvingProvider` for watch-only wallets? I'm having difficulty getting bip32 keys added to the PSBT while trying to rebase #16546 , see https://github.com/Sjors/bitcoin/commit/8660421cba60de3dd5ab76c8f285bce1f0b4327b\r\n(maybe I should try less of a hack and actually make that subclass...)",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-19T14:30:00Z",
      "diff_hunk" : "@@ -1426,3 +1488,623 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.cache.size() <= (unsigned int)(descriptor.next_index - descriptor.range_start) && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        descriptor.descriptor->ExpandFromCache(descriptor.next_index, descriptor.cache[descriptor.next_index - descriptor.range_start], scripts_temp, out_keys);\n+\n+        if (descriptor.descriptor->IsSingleType()) {\n+            Optional<OutputType> out_script_type = descriptor.descriptor->GetOutputType();\n+            if (out_script_type && out_script_type == type) {\n+                ExtractDestination(scripts_temp[0], dest);\n+            } else {\n+                throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+            }\n+        } else {\n+            // This is a combo descriptor which should not be an active descriptor\n+            assert(false);\n+        }\n+        descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (descriptor.next_index - 1 == index) {\n+        descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // Make sure we have everything between range_start and range_end\n+    int32_t range_size = descriptor.range_end - descriptor.range_start;\n+    int32_t highest_cached_index = descriptor.range_start + descriptor.cache.size();\n+    int32_t to_fill = std::max(range_size - (int)descriptor.cache.size(), 0);\n+\n+    // Fill up the rest of the pool\n+    int missing_pool = std::max(std::max((int)target_size, 1) - (descriptor.range_end - descriptor.next_index), 0);\n+    to_fill += missing_pool;\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        to_fill = descriptor.cache.size() == 0 ? 1 : 0;\n+        missing_pool = 0;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = highest_cached_index; i < highest_cached_index + to_fill; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        std::vector<unsigned char> cache;\n+        if (!descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &cache)) return false;\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        if (!batch.WriteDescriptorCache(id, i, cache)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+        }\n+        descriptor.cache.push_back(std::move(cache));\n+    }\n+    descriptor.range_end += missing_pool;\n+    batch.WriteDescriptor(GetID(), descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert((uint32_t)descriptor.range_end - (uint32_t)descriptor.range_start == descriptor.cache.size());\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::ClearDescriptorCache() {\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    int32_t highest_cached_index = descriptor.range_start + descriptor.cache.size();\n+    for (uint32_t i = highest_cached_index; i < (uint32_t)highest_cached_index + descriptor.cache.size(); ++i) {\n+        if (!batch.EraseDescriptorCache(id, i)) {\n+            throw std::runtime_error(std::string(__func__) + \": removing cache item failed\");\n+        }\n+    }\n+    descriptor.cache.clear();\n+\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item, mark all keypool items up to this item as used\\n\", __func__);\n+            descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    CPubKey master_pubkey = master_key.key.GetPubKey();\n+    assert(master_key.key.VerifyPubKey(master_pubkey));\n+\n+    // Get the fingerprint\n+    CKeyID master_id = master_key.key.GetPubKey().GetID();\n+    std::string fingerprint = HexStr(master_id.begin(), master_id.begin() + 4);\n+\n+    // Add the seed to the wallet\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    CExtKey d1;\n+    switch (address_type) {\n+    case OutputType::LEGACY: {\n+        master_key.Derive(d1, BIP32_HARDENED_KEY_LIMIT + 44);\n+        desc_prefix = \"pkh([\" + fingerprint + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        master_key.Derive(d1, BIP32_HARDENED_KEY_LIMIT + 49);\n+        desc_prefix = \"sh(wpkh([\" + fingerprint + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        master_key.Derive(d1, BIP32_HARDENED_KEY_LIMIT + 84);\n+        desc_prefix = \"wpkh([\" + fingerprint + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0',testnet and regtest derive at 1'\n+    CExtKey d2;\n+    if (Params().IsTestChain()) {\n+        d1.Derive(d2, BIP32_HARDENED_KEY_LIMIT + 1);\n+        desc_prefix += \"/1'\";\n+    } else {\n+        d1.Derive(d2, BIP32_HARDENED_KEY_LIMIT + 0);\n+        desc_prefix += \"/0'\";\n+    }\n+    // 3rd level is always 0'\n+    CExtKey d3;\n+    d2.Derive(d3, BIP32_HARDENED_KEY_LIMIT + 0);\n+    std::string xpub = EncodeExtPubKey(d3.Neuter());\n+\n+    // Build descriptor string\n+    std::string internal_path = internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0']\" + xpub + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    descriptor = w_desc;\n+\n+    // Store the master private key, derived intermediate key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");\n+    }\n+    if (!AddDescriptorKeyWithDB(batch, d3.key, d3.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor intermediate private key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal)\n+{\n+    LOCK(cs_desc_man);\n+    return HavePrivateKeys() || descriptor.next_index < descriptor.range_end;\n+}\n+\n+bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_map_keys.size() > 0 || m_map_crypted_keys.size() > 0;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime()\n+{\n+    return 0;\n+}\n+\n+size_t DescriptorScriptPubKeyMan::KeypoolCountExternalKeys()\n+{\n+    if (internal) {\n+        return 0;\n+    }\n+    return GetKeyPoolSize();\n+}\n+\n+unsigned int DescriptorScriptPubKeyMan::GetKeyPoolSize() const\n+{\n+    LOCK(cs_desc_man);\n+    return descriptor.range_end - descriptor.next_index;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n+{\n+    LOCK(cs_desc_man);\n+    return descriptor.creation_time;\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!descriptor.descriptor->ExpandFromCache(index, descriptor.cache[index - descriptor.range_start], scripts_temp, *out_keys)) return nullptr;\n+\n+    if (include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys);\n+    }\n+\n+    return std::move(out_keys);\n+}\n+\n+std::unique_ptr<SigningProvider> DescriptorScriptPubKeyMan::GetSolvingProvider(const CScript& script) const\n+{\n+    return GetSigningProvider(script, false);\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanProvide(const CScript& script, SignatureData& sigdata)\n+{\n+    return IsMine(script);\n+}\n+\n+bool DescriptorScriptPubKeyMan::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+    for (const auto& coin_pair : coins) {\n+        std::unique_ptr<FlatSigningProvider> coin_keys = std::move(GetSigningProvider(coin_pair.second.out.scriptPubKey, true));\n+        if (!coin_keys) {\n+            continue;\n+        }\n+        *keys = Merge(*keys, *coin_keys);\n+    }\n+\n+    return ::SignTransaction(tx, keys.get(), coins, sighash, input_errors);\n+}\n+\n+SigningResult DescriptorScriptPubKeyMan::SignMessage(const std::string& message, const PKHash& pkhash, std::string& str_sig) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = std::move(GetSigningProvider(GetScriptForDestination(pkhash), true));\n+    if (!keys) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    CKeyID key_id(pkhash);\n+    CKey key;\n+    if (!keys->GetKey(key_id, key)) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    if (!MessageSign(key, message, str_sig)) {\n+        return SigningResult::SIGNING_FAILED;\n+    }\n+    return SigningResult::OK;\n+}\n+\n+TransactionError DescriptorScriptPubKeyMan::FillPSBT(PartiallySignedTransaction& psbtx, int sighash_type, bool sign, bool bip32derivs) const\n+{\n+    for (unsigned int i = 0; i < psbtx.tx->vin.size(); ++i) {\n+        const CTxIn& txin = psbtx.tx->vin[i];\n+        PSBTInput& input = psbtx.inputs.at(i);\n+\n+        if (PSBTInputSigned(input)) {\n+            continue;\n+        }\n+\n+        // Verify input looks sane. This will check that we have at most one uxto, witness or non-witness.\n+        if (!input.IsSane()) {\n+            return TransactionError::INVALID_PSBT;\n+        }\n+\n+        // Get the Sighash type\n+        if (sign && input.sighash_type > 0 && input.sighash_type != sighash_type) {\n+            return TransactionError::SIGHASH_MISMATCH;\n+        }\n+\n+        // Get the scriptPubKey to know which SigningProvider to use\n+        CScript script;\n+        if (!input.witness_utxo.IsNull()) {\n+            script = input.witness_utxo.scriptPubKey;\n+        } else if (input.non_witness_utxo) {\n+            if (txin.prevout.n >= input.non_witness_utxo->vout.size()) {\n+                return TransactionError::MISSING_INPUTS;\n+            }\n+            script = input.non_witness_utxo->vout[txin.prevout.n].scriptPubKey;\n+        } else {\n+            // There's no UTXO so we can just skip this now\n+            continue;\n+        }\n+        SignatureData sigdata;\n+        input.FillSignatureData(sigdata);\n+\n+        std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(script, true);\n+        if (!keys) {\n+            continue;\n+        }\n+\n+        SignPSBTInput(HidingSigningProvider(keys.get(), !sign, !bip32derivs), psbtx, i, sighash_type);\n+    }\n+\n+    // Fill in the bip32 keypaths and redeemscripts for the outputs so that hardware wallets can identify change\n+    for (unsigned int i = 0; i < psbtx.tx->vout.size(); ++i) {\n+        std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(psbtx.tx->vout.at(i).scriptPubKey, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r381325869",
      "id" : 381325869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNTg2OQ==",
      "original_commit_id" : "91d4efc84283743ef26e58526269731909286777",
      "original_line" : 2004,
      "original_position" : 621,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 361155493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381325869",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r381372422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381372422"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Once #18180 is implemented that reduce at least some of my confusion :-) ",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-19T16:04:54Z",
      "diff_hunk" : "@@ -1426,3 +1488,623 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.cache.size() <= (unsigned int)(descriptor.next_index - descriptor.range_start) && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        descriptor.descriptor->ExpandFromCache(descriptor.next_index, descriptor.cache[descriptor.next_index - descriptor.range_start], scripts_temp, out_keys);\n+\n+        if (descriptor.descriptor->IsSingleType()) {\n+            Optional<OutputType> out_script_type = descriptor.descriptor->GetOutputType();\n+            if (out_script_type && out_script_type == type) {\n+                ExtractDestination(scripts_temp[0], dest);\n+            } else {\n+                throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+            }\n+        } else {\n+            // This is a combo descriptor which should not be an active descriptor\n+            assert(false);\n+        }\n+        descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (descriptor.next_index - 1 == index) {\n+        descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // Make sure we have everything between range_start and range_end\n+    int32_t range_size = descriptor.range_end - descriptor.range_start;\n+    int32_t highest_cached_index = descriptor.range_start + descriptor.cache.size();\n+    int32_t to_fill = std::max(range_size - (int)descriptor.cache.size(), 0);\n+\n+    // Fill up the rest of the pool\n+    int missing_pool = std::max(std::max((int)target_size, 1) - (descriptor.range_end - descriptor.next_index), 0);\n+    to_fill += missing_pool;\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        to_fill = descriptor.cache.size() == 0 ? 1 : 0;\n+        missing_pool = 0;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = highest_cached_index; i < highest_cached_index + to_fill; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        std::vector<unsigned char> cache;\n+        if (!descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &cache)) return false;\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        if (!batch.WriteDescriptorCache(id, i, cache)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+        }\n+        descriptor.cache.push_back(std::move(cache));\n+    }\n+    descriptor.range_end += missing_pool;\n+    batch.WriteDescriptor(GetID(), descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert((uint32_t)descriptor.range_end - (uint32_t)descriptor.range_start == descriptor.cache.size());\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::ClearDescriptorCache() {\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    int32_t highest_cached_index = descriptor.range_start + descriptor.cache.size();\n+    for (uint32_t i = highest_cached_index; i < (uint32_t)highest_cached_index + descriptor.cache.size(); ++i) {\n+        if (!batch.EraseDescriptorCache(id, i)) {\n+            throw std::runtime_error(std::string(__func__) + \": removing cache item failed\");\n+        }\n+    }\n+    descriptor.cache.clear();\n+\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item, mark all keypool items up to this item as used\\n\", __func__);\n+            descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    CPubKey master_pubkey = master_key.key.GetPubKey();\n+    assert(master_key.key.VerifyPubKey(master_pubkey));\n+\n+    // Get the fingerprint\n+    CKeyID master_id = master_key.key.GetPubKey().GetID();\n+    std::string fingerprint = HexStr(master_id.begin(), master_id.begin() + 4);\n+\n+    // Add the seed to the wallet\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    CExtKey d1;\n+    switch (address_type) {\n+    case OutputType::LEGACY: {\n+        master_key.Derive(d1, BIP32_HARDENED_KEY_LIMIT + 44);\n+        desc_prefix = \"pkh([\" + fingerprint + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        master_key.Derive(d1, BIP32_HARDENED_KEY_LIMIT + 49);\n+        desc_prefix = \"sh(wpkh([\" + fingerprint + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        master_key.Derive(d1, BIP32_HARDENED_KEY_LIMIT + 84);\n+        desc_prefix = \"wpkh([\" + fingerprint + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0',testnet and regtest derive at 1'\n+    CExtKey d2;\n+    if (Params().IsTestChain()) {\n+        d1.Derive(d2, BIP32_HARDENED_KEY_LIMIT + 1);\n+        desc_prefix += \"/1'\";\n+    } else {\n+        d1.Derive(d2, BIP32_HARDENED_KEY_LIMIT + 0);\n+        desc_prefix += \"/0'\";\n+    }\n+    // 3rd level is always 0'\n+    CExtKey d3;\n+    d2.Derive(d3, BIP32_HARDENED_KEY_LIMIT + 0);\n+    std::string xpub = EncodeExtPubKey(d3.Neuter());\n+\n+    // Build descriptor string\n+    std::string internal_path = internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0']\" + xpub + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    descriptor = w_desc;\n+\n+    // Store the master private key, derived intermediate key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");\n+    }\n+    if (!AddDescriptorKeyWithDB(batch, d3.key, d3.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor intermediate private key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal)\n+{\n+    LOCK(cs_desc_man);\n+    return HavePrivateKeys() || descriptor.next_index < descriptor.range_end;\n+}\n+\n+bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_map_keys.size() > 0 || m_map_crypted_keys.size() > 0;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime()\n+{\n+    return 0;\n+}\n+\n+size_t DescriptorScriptPubKeyMan::KeypoolCountExternalKeys()\n+{\n+    if (internal) {\n+        return 0;\n+    }\n+    return GetKeyPoolSize();\n+}\n+\n+unsigned int DescriptorScriptPubKeyMan::GetKeyPoolSize() const\n+{\n+    LOCK(cs_desc_man);\n+    return descriptor.range_end - descriptor.next_index;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n+{\n+    LOCK(cs_desc_man);\n+    return descriptor.creation_time;\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!descriptor.descriptor->ExpandFromCache(index, descriptor.cache[index - descriptor.range_start], scripts_temp, *out_keys)) return nullptr;\n+\n+    if (include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys);\n+    }\n+\n+    return std::move(out_keys);\n+}\n+\n+std::unique_ptr<SigningProvider> DescriptorScriptPubKeyMan::GetSolvingProvider(const CScript& script) const\n+{\n+    return GetSigningProvider(script, false);\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanProvide(const CScript& script, SignatureData& sigdata)\n+{\n+    return IsMine(script);\n+}\n+\n+bool DescriptorScriptPubKeyMan::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+    for (const auto& coin_pair : coins) {\n+        std::unique_ptr<FlatSigningProvider> coin_keys = std::move(GetSigningProvider(coin_pair.second.out.scriptPubKey, true));\n+        if (!coin_keys) {\n+            continue;\n+        }\n+        *keys = Merge(*keys, *coin_keys);\n+    }\n+\n+    return ::SignTransaction(tx, keys.get(), coins, sighash, input_errors);\n+}\n+\n+SigningResult DescriptorScriptPubKeyMan::SignMessage(const std::string& message, const PKHash& pkhash, std::string& str_sig) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = std::move(GetSigningProvider(GetScriptForDestination(pkhash), true));\n+    if (!keys) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    CKeyID key_id(pkhash);\n+    CKey key;\n+    if (!keys->GetKey(key_id, key)) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    if (!MessageSign(key, message, str_sig)) {\n+        return SigningResult::SIGNING_FAILED;\n+    }\n+    return SigningResult::OK;\n+}\n+\n+TransactionError DescriptorScriptPubKeyMan::FillPSBT(PartiallySignedTransaction& psbtx, int sighash_type, bool sign, bool bip32derivs) const\n+{\n+    for (unsigned int i = 0; i < psbtx.tx->vin.size(); ++i) {\n+        const CTxIn& txin = psbtx.tx->vin[i];\n+        PSBTInput& input = psbtx.inputs.at(i);\n+\n+        if (PSBTInputSigned(input)) {\n+            continue;\n+        }\n+\n+        // Verify input looks sane. This will check that we have at most one uxto, witness or non-witness.\n+        if (!input.IsSane()) {\n+            return TransactionError::INVALID_PSBT;\n+        }\n+\n+        // Get the Sighash type\n+        if (sign && input.sighash_type > 0 && input.sighash_type != sighash_type) {\n+            return TransactionError::SIGHASH_MISMATCH;\n+        }\n+\n+        // Get the scriptPubKey to know which SigningProvider to use\n+        CScript script;\n+        if (!input.witness_utxo.IsNull()) {\n+            script = input.witness_utxo.scriptPubKey;\n+        } else if (input.non_witness_utxo) {\n+            if (txin.prevout.n >= input.non_witness_utxo->vout.size()) {\n+                return TransactionError::MISSING_INPUTS;\n+            }\n+            script = input.non_witness_utxo->vout[txin.prevout.n].scriptPubKey;\n+        } else {\n+            // There's no UTXO so we can just skip this now\n+            continue;\n+        }\n+        SignatureData sigdata;\n+        input.FillSignatureData(sigdata);\n+\n+        std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(script, true);\n+        if (!keys) {\n+            continue;\n+        }\n+\n+        SignPSBTInput(HidingSigningProvider(keys.get(), !sign, !bip32derivs), psbtx, i, sighash_type);\n+    }\n+\n+    // Fill in the bip32 keypaths and redeemscripts for the outputs so that hardware wallets can identify change\n+    for (unsigned int i = 0; i < psbtx.tx->vout.size(); ++i) {\n+        std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(psbtx.tx->vout.at(i).scriptPubKey, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r381372422",
      "id" : 381372422,
      "in_reply_to_id" : 381325869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM3MjQyMg==",
      "original_commit_id" : "91d4efc84283743ef26e58526269731909286777",
      "original_line" : 2004,
      "original_position" : 621,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 361216880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381372422",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r382704392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382704392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I figured out what confused me. I was trying to call the Descriptor SKPMan version of `FillPSBT()` but that doesn't include the UTXOs, which are normally added in `CWallet`. I overhauled my design to avoid that problem. ",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-21T17:16:39Z",
      "diff_hunk" : "@@ -1426,3 +1488,623 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.cache.size() <= (unsigned int)(descriptor.next_index - descriptor.range_start) && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        descriptor.descriptor->ExpandFromCache(descriptor.next_index, descriptor.cache[descriptor.next_index - descriptor.range_start], scripts_temp, out_keys);\n+\n+        if (descriptor.descriptor->IsSingleType()) {\n+            Optional<OutputType> out_script_type = descriptor.descriptor->GetOutputType();\n+            if (out_script_type && out_script_type == type) {\n+                ExtractDestination(scripts_temp[0], dest);\n+            } else {\n+                throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+            }\n+        } else {\n+            // This is a combo descriptor which should not be an active descriptor\n+            assert(false);\n+        }\n+        descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (descriptor.next_index - 1 == index) {\n+        descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // Make sure we have everything between range_start and range_end\n+    int32_t range_size = descriptor.range_end - descriptor.range_start;\n+    int32_t highest_cached_index = descriptor.range_start + descriptor.cache.size();\n+    int32_t to_fill = std::max(range_size - (int)descriptor.cache.size(), 0);\n+\n+    // Fill up the rest of the pool\n+    int missing_pool = std::max(std::max((int)target_size, 1) - (descriptor.range_end - descriptor.next_index), 0);\n+    to_fill += missing_pool;\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        to_fill = descriptor.cache.size() == 0 ? 1 : 0;\n+        missing_pool = 0;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = highest_cached_index; i < highest_cached_index + to_fill; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        std::vector<unsigned char> cache;\n+        if (!descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &cache)) return false;\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        if (!batch.WriteDescriptorCache(id, i, cache)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+        }\n+        descriptor.cache.push_back(std::move(cache));\n+    }\n+    descriptor.range_end += missing_pool;\n+    batch.WriteDescriptor(GetID(), descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert((uint32_t)descriptor.range_end - (uint32_t)descriptor.range_start == descriptor.cache.size());\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::ClearDescriptorCache() {\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    int32_t highest_cached_index = descriptor.range_start + descriptor.cache.size();\n+    for (uint32_t i = highest_cached_index; i < (uint32_t)highest_cached_index + descriptor.cache.size(); ++i) {\n+        if (!batch.EraseDescriptorCache(id, i)) {\n+            throw std::runtime_error(std::string(__func__) + \": removing cache item failed\");\n+        }\n+    }\n+    descriptor.cache.clear();\n+\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item, mark all keypool items up to this item as used\\n\", __func__);\n+            descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    CPubKey master_pubkey = master_key.key.GetPubKey();\n+    assert(master_key.key.VerifyPubKey(master_pubkey));\n+\n+    // Get the fingerprint\n+    CKeyID master_id = master_key.key.GetPubKey().GetID();\n+    std::string fingerprint = HexStr(master_id.begin(), master_id.begin() + 4);\n+\n+    // Add the seed to the wallet\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    CExtKey d1;\n+    switch (address_type) {\n+    case OutputType::LEGACY: {\n+        master_key.Derive(d1, BIP32_HARDENED_KEY_LIMIT + 44);\n+        desc_prefix = \"pkh([\" + fingerprint + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        master_key.Derive(d1, BIP32_HARDENED_KEY_LIMIT + 49);\n+        desc_prefix = \"sh(wpkh([\" + fingerprint + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        master_key.Derive(d1, BIP32_HARDENED_KEY_LIMIT + 84);\n+        desc_prefix = \"wpkh([\" + fingerprint + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0',testnet and regtest derive at 1'\n+    CExtKey d2;\n+    if (Params().IsTestChain()) {\n+        d1.Derive(d2, BIP32_HARDENED_KEY_LIMIT + 1);\n+        desc_prefix += \"/1'\";\n+    } else {\n+        d1.Derive(d2, BIP32_HARDENED_KEY_LIMIT + 0);\n+        desc_prefix += \"/0'\";\n+    }\n+    // 3rd level is always 0'\n+    CExtKey d3;\n+    d2.Derive(d3, BIP32_HARDENED_KEY_LIMIT + 0);\n+    std::string xpub = EncodeExtPubKey(d3.Neuter());\n+\n+    // Build descriptor string\n+    std::string internal_path = internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0']\" + xpub + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    descriptor = w_desc;\n+\n+    // Store the master private key, derived intermediate key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");\n+    }\n+    if (!AddDescriptorKeyWithDB(batch, d3.key, d3.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor intermediate private key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal)\n+{\n+    LOCK(cs_desc_man);\n+    return HavePrivateKeys() || descriptor.next_index < descriptor.range_end;\n+}\n+\n+bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_map_keys.size() > 0 || m_map_crypted_keys.size() > 0;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime()\n+{\n+    return 0;\n+}\n+\n+size_t DescriptorScriptPubKeyMan::KeypoolCountExternalKeys()\n+{\n+    if (internal) {\n+        return 0;\n+    }\n+    return GetKeyPoolSize();\n+}\n+\n+unsigned int DescriptorScriptPubKeyMan::GetKeyPoolSize() const\n+{\n+    LOCK(cs_desc_man);\n+    return descriptor.range_end - descriptor.next_index;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n+{\n+    LOCK(cs_desc_man);\n+    return descriptor.creation_time;\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!descriptor.descriptor->ExpandFromCache(index, descriptor.cache[index - descriptor.range_start], scripts_temp, *out_keys)) return nullptr;\n+\n+    if (include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys);\n+    }\n+\n+    return std::move(out_keys);\n+}\n+\n+std::unique_ptr<SigningProvider> DescriptorScriptPubKeyMan::GetSolvingProvider(const CScript& script) const\n+{\n+    return GetSigningProvider(script, false);\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanProvide(const CScript& script, SignatureData& sigdata)\n+{\n+    return IsMine(script);\n+}\n+\n+bool DescriptorScriptPubKeyMan::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+    for (const auto& coin_pair : coins) {\n+        std::unique_ptr<FlatSigningProvider> coin_keys = std::move(GetSigningProvider(coin_pair.second.out.scriptPubKey, true));\n+        if (!coin_keys) {\n+            continue;\n+        }\n+        *keys = Merge(*keys, *coin_keys);\n+    }\n+\n+    return ::SignTransaction(tx, keys.get(), coins, sighash, input_errors);\n+}\n+\n+SigningResult DescriptorScriptPubKeyMan::SignMessage(const std::string& message, const PKHash& pkhash, std::string& str_sig) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = std::move(GetSigningProvider(GetScriptForDestination(pkhash), true));\n+    if (!keys) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    CKeyID key_id(pkhash);\n+    CKey key;\n+    if (!keys->GetKey(key_id, key)) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    if (!MessageSign(key, message, str_sig)) {\n+        return SigningResult::SIGNING_FAILED;\n+    }\n+    return SigningResult::OK;\n+}\n+\n+TransactionError DescriptorScriptPubKeyMan::FillPSBT(PartiallySignedTransaction& psbtx, int sighash_type, bool sign, bool bip32derivs) const\n+{\n+    for (unsigned int i = 0; i < psbtx.tx->vin.size(); ++i) {\n+        const CTxIn& txin = psbtx.tx->vin[i];\n+        PSBTInput& input = psbtx.inputs.at(i);\n+\n+        if (PSBTInputSigned(input)) {\n+            continue;\n+        }\n+\n+        // Verify input looks sane. This will check that we have at most one uxto, witness or non-witness.\n+        if (!input.IsSane()) {\n+            return TransactionError::INVALID_PSBT;\n+        }\n+\n+        // Get the Sighash type\n+        if (sign && input.sighash_type > 0 && input.sighash_type != sighash_type) {\n+            return TransactionError::SIGHASH_MISMATCH;\n+        }\n+\n+        // Get the scriptPubKey to know which SigningProvider to use\n+        CScript script;\n+        if (!input.witness_utxo.IsNull()) {\n+            script = input.witness_utxo.scriptPubKey;\n+        } else if (input.non_witness_utxo) {\n+            if (txin.prevout.n >= input.non_witness_utxo->vout.size()) {\n+                return TransactionError::MISSING_INPUTS;\n+            }\n+            script = input.non_witness_utxo->vout[txin.prevout.n].scriptPubKey;\n+        } else {\n+            // There's no UTXO so we can just skip this now\n+            continue;\n+        }\n+        SignatureData sigdata;\n+        input.FillSignatureData(sigdata);\n+\n+        std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(script, true);\n+        if (!keys) {\n+            continue;\n+        }\n+\n+        SignPSBTInput(HidingSigningProvider(keys.get(), !sign, !bip32derivs), psbtx, i, sighash_type);\n+    }\n+\n+    // Fill in the bip32 keypaths and redeemscripts for the outputs so that hardware wallets can identify change\n+    for (unsigned int i = 0; i < psbtx.tx->vout.size(); ++i) {\n+        std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(psbtx.tx->vout.at(i).scriptPubKey, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r382704392",
      "id" : 382704392,
      "in_reply_to_id" : 381325869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNDM5Mg==",
      "original_commit_id" : "91d4efc84283743ef26e58526269731909286777",
      "original_line" : 2004,
      "original_position" : 621,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 362787031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382704392",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We should make `IsChange` check for derivation path for descriptor wallets and not the ad-hoc \"is this address in my address book\", which we have to support for legacy wallets forever.\r\n\r\nedit: nevermind, not derivation path, just whether or not it's in `m_internal_spk_mans` or not",
      "created_at" : "2020-02-24T14:57:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-590362243",
      "id" : 590362243,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDM2MjI0Mw==",
      "updated_at" : "2020-02-24T17:41:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590362243",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-02-25T11:19:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-590817709",
      "id" : 590817709,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDgxNzcwOQ==",
      "updated_at" : "2020-02-25T11:19:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590817709",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've added #18204 into this now",
      "created_at" : "2020-02-27T01:46:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-591735331",
      "id" : 591735331,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTczNTMzMQ==",
      "updated_at" : "2020-02-27T01:46:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591735331",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Not exactly related but I got a crash due to an assert() failing when I create a native descriptor wallet with `avoid_reuse=true` (5th parameter)\r\n\r\n`./bitcoin-cli -testnet createwallet test_wallet true true \"\" true true`\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/652ffb49f1fdd9be804990e9e350fd8f647ceb81/src/wallet/wallet.cpp#L754",
      "created_at" : "2020-02-27T10:46:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-591904329",
      "id" : 591904329,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTkwNDMyOQ==",
      "updated_at" : "2020-02-27T10:48:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591904329",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4769925?v=4",
         "events_url" : "https://api.github.com/users/hugohn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hugohn/followers",
         "following_url" : "https://api.github.com/users/hugohn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hugohn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hugohn",
         "id" : 4769925,
         "login" : "hugohn",
         "node_id" : "MDQ6VXNlcjQ3Njk5MjU=",
         "organizations_url" : "https://api.github.com/users/hugohn/orgs",
         "received_events_url" : "https://api.github.com/users/hugohn/received_events",
         "repos_url" : "https://api.github.com/users/hugohn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hugohn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hugohn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hugohn"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Not exactly related but I got a crash due to an assert() failing when I create a native descriptor wallet with `avoid_reuse=true` (5th parameter)\r\n> \r\n> `./bitcoin-cli -testnet createwallet test_wallet true true \"\" true true`\r\n\r\nI can't replicate this.",
      "created_at" : "2020-02-27T19:40:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-592141441",
      "id" : 592141441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MjE0MTQ0MQ==",
      "updated_at" : "2020-02-27T19:40:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/592141441",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "hmm I synced to tip and now couldn't reproduce either...\r\n\r\nFWIW, it crashed after restarting `bitcoind` with `-testnet -wallet=test_wallet`, not when I created the wallet. Will report if reproducible.",
      "created_at" : "2020-02-28T04:14:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-592304787",
      "id" : 592304787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MjMwNDc4Nw==",
      "updated_at" : "2020-02-28T04:14:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/592304787",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4769925?v=4",
         "events_url" : "https://api.github.com/users/hugohn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hugohn/followers",
         "following_url" : "https://api.github.com/users/hugohn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hugohn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hugohn",
         "id" : 4769925,
         "login" : "hugohn",
         "node_id" : "MDQ6VXNlcjQ3Njk5MjU=",
         "organizations_url" : "https://api.github.com/users/hugohn/orgs",
         "received_events_url" : "https://api.github.com/users/hugohn/received_events",
         "repos_url" : "https://api.github.com/users/hugohn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hugohn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hugohn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hugohn"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385666508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385666508"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is still necessary now that you're no longer caching individual keys? If not, then it looks like you can drop `ClearDescriptorCache()`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T12:22:39Z",
      "diff_hunk" : "@@ -4237,3 +4392,169 @@ void CWallet::ConnectScriptPubKeyManNotifiers()\n         spk_man->NotifyCanGetAddressesChanged.connect(NotifyCanGetAddressesChanged);\n     }\n }\n+\n+void CWallet::LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor& desc)\n+{\n+    auto spk_manager = std::unique_ptr<ScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+    m_spk_managers[id] = std::move(spk_manager);\n+}\n+\n+void CWallet::SetupDescriptorScriptPubKeyMans()\n+{\n+    AssertLockHeld(cs_wallet);\n+\n+    // Make a seed\n+    CKey seed_key;\n+    seed_key.MakeNewKey(true);\n+    CPubKey seed = seed_key.GetPubKey();\n+    assert(seed_key.VerifyPubKey(seed));\n+\n+    // Get the extended key\n+    CExtKey master_key;\n+    master_key.SetSeed(seed_key.begin(), seed_key.size());\n+\n+    for (bool internal : {false, true}) {\n+        for (OutputType t : OUTPUT_TYPES) {\n+            auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, t, internal));\n+            if (IsCrypted()) {\n+                if (IsLocked()) {\n+                    throw std::runtime_error(std::string(__func__) + \": Wallet is locked, cannot setup new descriptors\");\n+                }\n+                if (!spk_manager->CheckDecryptionKey(vMasterKey) && !spk_manager->Encrypt(vMasterKey, nullptr)) {\n+                    throw std::runtime_error(std::string(__func__) + \": Could not encrypt new descriptors\");\n+                }\n+            }\n+            spk_manager->SetupDescriptorGeneration(master_key);\n+            uint256 id = spk_manager->GetID();\n+            m_spk_managers[id] = std::move(spk_manager);\n+            SetActiveScriptPubKeyMan(id, t, internal);\n+        }\n+    }\n+}\n+\n+void CWallet::SetActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal, bool memonly)\n+{\n+    WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto spk_man = m_spk_managers.at(id).get();\n+    spk_man->SetType(type, internal);\n+    spk_mans[type] = spk_man;\n+\n+    if (!memonly) {\n+        WalletBatch batch(*database);\n+        if (!batch.WriteActiveScriptPubKeyMan(static_cast<uint8_t>(type), id, internal)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing active ScriptPubKeyMan id failed\");\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+bool CWallet::IsLegacy() const\n+{\n+    if (m_internal_spk_managers.count(OutputType::LEGACY) == 0) {\n+        return false;\n+    }\n+    auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n+    return spk_man != nullptr;\n+}\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        return nullptr;\n+    }\n+\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+bool CWallet::MaybeClearWalletDescriptorCache(const WalletDescriptor& desc)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot update WalletDescriptor in a non-descriptor wallet\\n\");\n+        return false;\n+    }\n+\n+    auto spk_manager = HasWalletDescriptor(desc);\n+    if (!spk_manager) {\n+        WalletLogPrintf(\"Cannot find spkMan for descriptor\\n\");\n+        return false;\n+    }\n+\n+    WalletLogPrintf(\"Update existing descriptor: %s\\n\", desc.descriptor->ToString());\n+    LOCK2(cs_wallet, spk_manager->cs_desc_man);\n+\n+    // Clear the cache if necessary\n+    if (desc.range_start < spk_manager->GetWalletDescriptor().range_start) {\n+        spk_manager->ClearDescriptorCache();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385666508",
      "id" : 385666508,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY2NjUwOA==",
      "original_commit_id" : "1b4fd1424f6160195d6d28072d8793b666db007d",
      "original_line" : 4496,
      "original_position" : 466,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 366359661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385666508",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385668788"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385668788"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Now that you're no longer caching individual keys, can there still be a situation where you have a non-empty cache that's incomplete? If not, then you might be able to drop `GetNotCached`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T12:28:25Z",
      "diff_hunk" : "@@ -1434,3 +1496,609 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.range_end <= m_max_desc_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!descriptor.descriptor->ExpandFromCache(descriptor.next_index, descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        if (descriptor.descriptor->IsSingleType()) {\n+            Optional<OutputType> out_script_type = descriptor.descriptor->GetOutputType();\n+            if (out_script_type && out_script_type == type) {\n+                ExtractDestination(scripts_temp[0], dest);\n+            } else {\n+                throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+            }\n+        } else {\n+            // This is a combo descriptor which should not be an active descriptor\n+            assert(false);\n+        }\n+        descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (descriptor.next_index - 1 == index) {\n+        descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_desc_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache cache;\n+        if (!descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &cache)) {\n+            // Maybe we have a cached xpub and we can expand from cache\n+            if (!descriptor.descriptor->ExpandFromCache(i, descriptor.cache, scripts_temp, out_keys)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        std::map<KeyOriginInfo, CExtPubKey> newly_cached = descriptor.cache.GetNotCached(cache.GetCachedExtPubKeys());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385668788",
      "id" : 385668788,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY2ODc4OA==",
      "original_commit_id" : "1b4fd1424f6160195d6d28072d8793b666db007d",
      "original_line" : 1691,
      "original_position" : 299,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366362548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385668788",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385674205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385674205"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nvm, we still cache individual keys for `/*h` descriptors. ",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T12:41:11Z",
      "diff_hunk" : "@@ -1434,3 +1496,609 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.range_end <= m_max_desc_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!descriptor.descriptor->ExpandFromCache(descriptor.next_index, descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        if (descriptor.descriptor->IsSingleType()) {\n+            Optional<OutputType> out_script_type = descriptor.descriptor->GetOutputType();\n+            if (out_script_type && out_script_type == type) {\n+                ExtractDestination(scripts_temp[0], dest);\n+            } else {\n+                throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+            }\n+        } else {\n+            // This is a combo descriptor which should not be an active descriptor\n+            assert(false);\n+        }\n+        descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (descriptor.next_index - 1 == index) {\n+        descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_desc_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache cache;\n+        if (!descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &cache)) {\n+            // Maybe we have a cached xpub and we can expand from cache\n+            if (!descriptor.descriptor->ExpandFromCache(i, descriptor.cache, scripts_temp, out_keys)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        std::map<KeyOriginInfo, CExtPubKey> newly_cached = descriptor.cache.GetNotCached(cache.GetCachedExtPubKeys());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385674205",
      "id" : 385674205,
      "in_reply_to_id" : 385668788,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NDIwNQ==",
      "original_commit_id" : "1b4fd1424f6160195d6d28072d8793b666db007d",
      "original_line" : 1691,
      "original_position" : 299,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366369212,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385674205",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385674605"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385674605"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We still cache individual keys for `/*h` descriptors, but they're indexed rather than sequential, so the question remains here.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T12:42:09Z",
      "diff_hunk" : "@@ -4237,3 +4392,169 @@ void CWallet::ConnectScriptPubKeyManNotifiers()\n         spk_man->NotifyCanGetAddressesChanged.connect(NotifyCanGetAddressesChanged);\n     }\n }\n+\n+void CWallet::LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor& desc)\n+{\n+    auto spk_manager = std::unique_ptr<ScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+    m_spk_managers[id] = std::move(spk_manager);\n+}\n+\n+void CWallet::SetupDescriptorScriptPubKeyMans()\n+{\n+    AssertLockHeld(cs_wallet);\n+\n+    // Make a seed\n+    CKey seed_key;\n+    seed_key.MakeNewKey(true);\n+    CPubKey seed = seed_key.GetPubKey();\n+    assert(seed_key.VerifyPubKey(seed));\n+\n+    // Get the extended key\n+    CExtKey master_key;\n+    master_key.SetSeed(seed_key.begin(), seed_key.size());\n+\n+    for (bool internal : {false, true}) {\n+        for (OutputType t : OUTPUT_TYPES) {\n+            auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, t, internal));\n+            if (IsCrypted()) {\n+                if (IsLocked()) {\n+                    throw std::runtime_error(std::string(__func__) + \": Wallet is locked, cannot setup new descriptors\");\n+                }\n+                if (!spk_manager->CheckDecryptionKey(vMasterKey) && !spk_manager->Encrypt(vMasterKey, nullptr)) {\n+                    throw std::runtime_error(std::string(__func__) + \": Could not encrypt new descriptors\");\n+                }\n+            }\n+            spk_manager->SetupDescriptorGeneration(master_key);\n+            uint256 id = spk_manager->GetID();\n+            m_spk_managers[id] = std::move(spk_manager);\n+            SetActiveScriptPubKeyMan(id, t, internal);\n+        }\n+    }\n+}\n+\n+void CWallet::SetActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal, bool memonly)\n+{\n+    WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto spk_man = m_spk_managers.at(id).get();\n+    spk_man->SetType(type, internal);\n+    spk_mans[type] = spk_man;\n+\n+    if (!memonly) {\n+        WalletBatch batch(*database);\n+        if (!batch.WriteActiveScriptPubKeyMan(static_cast<uint8_t>(type), id, internal)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing active ScriptPubKeyMan id failed\");\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+bool CWallet::IsLegacy() const\n+{\n+    if (m_internal_spk_managers.count(OutputType::LEGACY) == 0) {\n+        return false;\n+    }\n+    auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n+    return spk_man != nullptr;\n+}\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        return nullptr;\n+    }\n+\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+bool CWallet::MaybeClearWalletDescriptorCache(const WalletDescriptor& desc)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot update WalletDescriptor in a non-descriptor wallet\\n\");\n+        return false;\n+    }\n+\n+    auto spk_manager = HasWalletDescriptor(desc);\n+    if (!spk_manager) {\n+        WalletLogPrintf(\"Cannot find spkMan for descriptor\\n\");\n+        return false;\n+    }\n+\n+    WalletLogPrintf(\"Update existing descriptor: %s\\n\", desc.descriptor->ToString());\n+    LOCK2(cs_wallet, spk_manager->cs_desc_man);\n+\n+    // Clear the cache if necessary\n+    if (desc.range_start < spk_manager->GetWalletDescriptor().range_start) {\n+        spk_manager->ClearDescriptorCache();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385674605",
      "id" : 385674605,
      "in_reply_to_id" : 385666508,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NDYwNQ==",
      "original_commit_id" : "1b4fd1424f6160195d6d28072d8793b666db007d",
      "original_line" : 4496,
      "original_position" : 466,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 366369739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385674605",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385838987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385838987"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Every `Expand` will also return the parent xpub. We don't want to be constantly rewriting that.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T17:57:46Z",
      "diff_hunk" : "@@ -1434,3 +1496,609 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.range_end <= m_max_desc_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!descriptor.descriptor->ExpandFromCache(descriptor.next_index, descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        if (descriptor.descriptor->IsSingleType()) {\n+            Optional<OutputType> out_script_type = descriptor.descriptor->GetOutputType();\n+            if (out_script_type && out_script_type == type) {\n+                ExtractDestination(scripts_temp[0], dest);\n+            } else {\n+                throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+            }\n+        } else {\n+            // This is a combo descriptor which should not be an active descriptor\n+            assert(false);\n+        }\n+        descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (descriptor.next_index - 1 == index) {\n+        descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_desc_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache cache;\n+        if (!descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &cache)) {\n+            // Maybe we have a cached xpub and we can expand from cache\n+            if (!descriptor.descriptor->ExpandFromCache(i, descriptor.cache, scripts_temp, out_keys)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        std::map<KeyOriginInfo, CExtPubKey> newly_cached = descriptor.cache.GetNotCached(cache.GetCachedExtPubKeys());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385838987",
      "id" : 385838987,
      "in_reply_to_id" : 385668788,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgzODk4Nw==",
      "original_commit_id" : "1b4fd1424f6160195d6d28072d8793b666db007d",
      "original_line" : 1691,
      "original_position" : 299,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366580173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385838987",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385849291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385849291"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think these changes are related to the commit message?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T18:20:59Z",
      "diff_hunk" : "@@ -6,6 +6,7 @@\n #define BITCOIN_WALLET_WALLETUTIL_H\n \n #include <fs.h>\n+#include <script/descriptor.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385849291",
      "id" : 385849291,
      "line" : 9,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg0OTI5MQ==",
      "original_commit_id" : "4d7998695f6aca2d19e3b78834b7079b50e1f8a1",
      "original_line" : 9,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : 4,
      "pull_request_review_id" : 366593454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385849291",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385850369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385850369"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just a thought you can nack: You can check for the wallet flags since you just set them above. Easier pattern matching for reviewers who are expecting `IsWalletFlagSet`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T18:23:19Z",
      "diff_hunk" : "@@ -3868,8 +3868,10 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         walletInstance->SetWalletFlags(wallet_creation_flags, false);\n \n-        // Always create LegacyScriptPubKeyMan for now\n-        walletInstance->SetupLegacyScriptPubKeyMan();\n+        // Only create LegacyScriptPubKeyMan when not descriptor wallet\n+        if (!(wallet_creation_flags & WALLET_FLAG_DESCRIPTORS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385850369",
      "id" : 385850369,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg1MDM2OQ==",
      "original_commit_id" : "4d7998695f6aca2d19e3b78834b7079b50e1f8a1",
      "original_line" : 3872,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 366593454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385850369",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385864196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385864196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "please annotate bool args",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T18:53:01Z",
      "diff_hunk" : "@@ -495,6 +524,14 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Set the active ScriptPubKeyMans\n+    for (auto spk_man_pair : wss.m_external_spk_managers) {\n+        pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, false, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385864196",
      "id" : 385864196,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg2NDE5Ng==",
      "original_commit_id" : "e6af0ba62b5c36fdf61cfd5c77d17feb920b68e8",
      "original_line" : 529,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 366593454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385864196",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385864230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385864230"
         }
      },
      "author_association" : "MEMBER",
      "body" : "please annotate bool args",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T18:53:06Z",
      "diff_hunk" : "@@ -495,6 +524,14 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Set the active ScriptPubKeyMans\n+    for (auto spk_man_pair : wss.m_external_spk_managers) {\n+        pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, false, true);\n+    }\n+    for (auto spk_man_pair : wss.m_internal_spk_managers) {\n+        pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, true, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385864230",
      "id" : 385864230,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg2NDIzMA==",
      "original_commit_id" : "e6af0ba62b5c36fdf61cfd5c77d17feb920b68e8",
      "original_line" : 532,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 366593454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385864230",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385907997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385907997"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`0',testnet` missing space",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T20:30:08Z",
      "diff_hunk" : "@@ -1577,6 +1577,74 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Add the seed to the wallet\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0',testnet and regtest derive at 1'",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385907997",
      "id" : 385907997,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwNzk5Nw==",
      "original_commit_id" : "630a5308c8385b4577f973f4cc834d774f9988f8",
      "original_line" : 1614,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366593454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385907997",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385908598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385908598"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems like `Build descriptor string` goes here?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T20:31:38Z",
      "diff_hunk" : "@@ -1577,6 +1577,74 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Add the seed to the wallet",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385908598",
      "id" : 385908598,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwODU5OA==",
      "original_commit_id" : "630a5308c8385b4577f973f4cc834d774f9988f8",
      "original_line" : 1594,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366593454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385908598",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385909756"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385909756"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't see `intermediate key` being written?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T20:34:40Z",
      "diff_hunk" : "@@ -1577,6 +1577,74 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Add the seed to the wallet\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0',testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    // Build descriptor string\n+    std::string internal_path = internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    descriptor = w_desc;\n+\n+    // Store the master private key, derived intermediate key, and descriptor",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385909756",
      "id" : 385909756,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwOTc1Ng==",
      "original_commit_id" : "630a5308c8385b4577f973f4cc834d774f9988f8",
      "original_line" : 1632,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366593454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385909756",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385909909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385909909"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, it is no longer needed. I've removed it.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-28T20:35:02Z",
      "diff_hunk" : "@@ -4237,3 +4392,169 @@ void CWallet::ConnectScriptPubKeyManNotifiers()\n         spk_man->NotifyCanGetAddressesChanged.connect(NotifyCanGetAddressesChanged);\n     }\n }\n+\n+void CWallet::LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor& desc)\n+{\n+    auto spk_manager = std::unique_ptr<ScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+    m_spk_managers[id] = std::move(spk_manager);\n+}\n+\n+void CWallet::SetupDescriptorScriptPubKeyMans()\n+{\n+    AssertLockHeld(cs_wallet);\n+\n+    // Make a seed\n+    CKey seed_key;\n+    seed_key.MakeNewKey(true);\n+    CPubKey seed = seed_key.GetPubKey();\n+    assert(seed_key.VerifyPubKey(seed));\n+\n+    // Get the extended key\n+    CExtKey master_key;\n+    master_key.SetSeed(seed_key.begin(), seed_key.size());\n+\n+    for (bool internal : {false, true}) {\n+        for (OutputType t : OUTPUT_TYPES) {\n+            auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, t, internal));\n+            if (IsCrypted()) {\n+                if (IsLocked()) {\n+                    throw std::runtime_error(std::string(__func__) + \": Wallet is locked, cannot setup new descriptors\");\n+                }\n+                if (!spk_manager->CheckDecryptionKey(vMasterKey) && !spk_manager->Encrypt(vMasterKey, nullptr)) {\n+                    throw std::runtime_error(std::string(__func__) + \": Could not encrypt new descriptors\");\n+                }\n+            }\n+            spk_manager->SetupDescriptorGeneration(master_key);\n+            uint256 id = spk_manager->GetID();\n+            m_spk_managers[id] = std::move(spk_manager);\n+            SetActiveScriptPubKeyMan(id, t, internal);\n+        }\n+    }\n+}\n+\n+void CWallet::SetActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal, bool memonly)\n+{\n+    WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto spk_man = m_spk_managers.at(id).get();\n+    spk_man->SetType(type, internal);\n+    spk_mans[type] = spk_man;\n+\n+    if (!memonly) {\n+        WalletBatch batch(*database);\n+        if (!batch.WriteActiveScriptPubKeyMan(static_cast<uint8_t>(type), id, internal)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing active ScriptPubKeyMan id failed\");\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+bool CWallet::IsLegacy() const\n+{\n+    if (m_internal_spk_managers.count(OutputType::LEGACY) == 0) {\n+        return false;\n+    }\n+    auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n+    return spk_man != nullptr;\n+}\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        return nullptr;\n+    }\n+\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+bool CWallet::MaybeClearWalletDescriptorCache(const WalletDescriptor& desc)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot update WalletDescriptor in a non-descriptor wallet\\n\");\n+        return false;\n+    }\n+\n+    auto spk_manager = HasWalletDescriptor(desc);\n+    if (!spk_manager) {\n+        WalletLogPrintf(\"Cannot find spkMan for descriptor\\n\");\n+        return false;\n+    }\n+\n+    WalletLogPrintf(\"Update existing descriptor: %s\\n\", desc.descriptor->ToString());\n+    LOCK2(cs_wallet, spk_manager->cs_desc_man);\n+\n+    // Clear the cache if necessary\n+    if (desc.range_start < spk_manager->GetWalletDescriptor().range_start) {\n+        spk_manager->ClearDescriptorCache();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385909909",
      "id" : 385909909,
      "in_reply_to_id" : 385666508,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwOTkwOQ==",
      "original_commit_id" : "1b4fd1424f6160195d6d28072d8793b666db007d",
      "original_line" : 4496,
      "original_position" : 466,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 366669295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385909909",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978728"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm. I think the commit they were part of was accidentally squashed. Moved back into their own commit.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T00:20:47Z",
      "diff_hunk" : "@@ -6,6 +6,7 @@\n #define BITCOIN_WALLET_WALLETUTIL_H\n \n #include <fs.h>\n+#include <script/descriptor.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978728",
      "id" : 385978728,
      "in_reply_to_id" : 385849291,
      "line" : 9,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3ODcyOA==",
      "original_commit_id" : "4d7998695f6aca2d19e3b78834b7079b50e1f8a1",
      "original_line" : 9,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : 4,
      "pull_request_review_id" : 366754744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978728",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978750"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T00:20:54Z",
      "diff_hunk" : "@@ -3868,8 +3868,10 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         walletInstance->SetWalletFlags(wallet_creation_flags, false);\n \n-        // Always create LegacyScriptPubKeyMan for now\n-        walletInstance->SetupLegacyScriptPubKeyMan();\n+        // Only create LegacyScriptPubKeyMan when not descriptor wallet\n+        if (!(wallet_creation_flags & WALLET_FLAG_DESCRIPTORS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978750",
      "id" : 385978750,
      "in_reply_to_id" : 385850369,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3ODc1MA==",
      "original_commit_id" : "4d7998695f6aca2d19e3b78834b7079b50e1f8a1",
      "original_line" : 3872,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 366754770,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978750",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978773"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T00:21:04Z",
      "diff_hunk" : "@@ -495,6 +524,14 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Set the active ScriptPubKeyMans\n+    for (auto spk_man_pair : wss.m_external_spk_managers) {\n+        pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, false, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978773",
      "id" : 385978773,
      "in_reply_to_id" : 385864196,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3ODc3Mw==",
      "original_commit_id" : "e6af0ba62b5c36fdf61cfd5c77d17feb920b68e8",
      "original_line" : 529,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 366754805,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978773",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978785"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T00:21:08Z",
      "diff_hunk" : "@@ -495,6 +524,14 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Set the active ScriptPubKeyMans\n+    for (auto spk_man_pair : wss.m_external_spk_managers) {\n+        pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, false, true);\n+    }\n+    for (auto spk_man_pair : wss.m_internal_spk_managers) {\n+        pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, true, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978785",
      "id" : 385978785,
      "in_reply_to_id" : 385864230,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3ODc4NQ==",
      "original_commit_id" : "e6af0ba62b5c36fdf61cfd5c77d17feb920b68e8",
      "original_line" : 532,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 366754814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978785",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T00:21:12Z",
      "diff_hunk" : "@@ -1577,6 +1577,74 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Add the seed to the wallet\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0',testnet and regtest derive at 1'",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978801",
      "id" : 385978801,
      "in_reply_to_id" : 385907997,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3ODgwMQ==",
      "original_commit_id" : "630a5308c8385b4577f973f4cc834d774f9988f8",
      "original_line" : 1614,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366754831,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978801",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978865"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Moved",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T00:21:36Z",
      "diff_hunk" : "@@ -1577,6 +1577,74 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Add the seed to the wallet",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978865",
      "id" : 385978865,
      "in_reply_to_id" : 385908598,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3ODg2NQ==",
      "original_commit_id" : "630a5308c8385b4577f973f4cc834d774f9988f8",
      "original_line" : 1594,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366754896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978865",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978925"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed. The change that did that was reverted given that we now use the descriptor xpub cache.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T00:21:55Z",
      "diff_hunk" : "@@ -1577,6 +1577,74 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Add the seed to the wallet\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0',testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    // Build descriptor string\n+    std::string internal_path = internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    descriptor = w_desc;\n+\n+    // Store the master private key, derived intermediate key, and descriptor",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r385978925",
      "id" : 385978925,
      "in_reply_to_id" : 385909756,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3ODkyNQ==",
      "original_commit_id" : "630a5308c8385b4577f973f4cc834d774f9988f8",
      "original_line" : 1632,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366754965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385978925",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386015063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386015063"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Try `ExpandFromCache(` before `Expand(`? ",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T09:22:31Z",
      "diff_hunk" : "@@ -1434,3 +1496,594 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.range_end <= m_max_desc_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!descriptor.descriptor->ExpandFromCache(descriptor.next_index, descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        if (descriptor.descriptor->IsSingleType()) {\n+            Optional<OutputType> out_script_type = descriptor.descriptor->GetOutputType();\n+            if (out_script_type && out_script_type == type) {\n+                ExtractDestination(scripts_temp[0], dest);\n+            } else {\n+                throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+            }\n+        } else {\n+            // This is a combo descriptor which should not be an active descriptor\n+            assert(false);\n+        }\n+        descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (descriptor.next_index - 1 == index) {\n+        descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_desc_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache cache;\n+        if (!descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &cache)) {\n+            // Maybe we have a cached xpub and we can expand from cache\n+            if (!descriptor.descriptor->ExpandFromCache(i, descriptor.cache, scripts_temp, out_keys)) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386015063",
      "id" : 386015063,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNTA2Mw==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 1683,
      "original_position" : 292,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366787922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386015063",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386015338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386015338"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"No addresses available\"\r\n\r\nIt may also be worth clarifying that although `CanGetAddresses()` considers `descriptor.next_index < descriptor.range_end`, each topup bumps `range_end`, except for wallets with hardened derivation, with encrypted or without private keys. Those wallets need to call `keypoolrefill`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T09:27:42Z",
      "diff_hunk" : "@@ -1434,3 +1496,594 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386015338",
      "id" : 386015338,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNTMzOA==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 1505,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366787922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386015338",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386016600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386016600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_max_cached_index`?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T09:51:15Z",
      "diff_hunk" : "@@ -458,9 +477,104 @@ class LegacySigningProvider : public SigningProvider\n     bool GetCScript(const CScriptID &scriptid, CScript& script) const override { return m_spk_man.GetCScript(scriptid, script); }\n     bool HaveCScript(const CScriptID &scriptid) const override { return m_spk_man.HaveCScript(scriptid); }\n     bool GetPubKey(const CKeyID &address, CPubKey& pubkey) const override { return m_spk_man.GetPubKey(address, pubkey); }\n-    bool GetKey(const CKeyID &address, CKey& key) const override { return m_spk_man.GetKey(address, key); }\n-    bool HaveKey(const CKeyID &address) const override { return m_spk_man.HaveKey(address); }\n+    bool GetKey(const CKeyID &address, CKey& key) const override { return false; }\n+    bool HaveKey(const CKeyID &address) const override { return false; }\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_desc_index = -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386016600",
      "id" : 386016600,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNjYwMA==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 495,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 366787922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386016600",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386016947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386016947"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do this before (or instead of) `CanGetAddresses()` for readability?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T09:58:38Z",
      "diff_hunk" : "@@ -1434,3 +1496,594 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.range_end <= m_max_desc_index && !TopUp(1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386016947",
      "id" : 386016947,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNjk0Nw==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 1520,
      "original_position" : 128,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 366787922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386016947",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386017234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386017234"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Worth documenting that:\r\n```\r\nThis tops up the descriptor cache (and `m_map_script_pub_keys`).\r\nThe cache is stored in the wallet payload\r\nand used to expand the descriptor upon wallet load. A descriptor\r\nScriptPubKeyMan may rely more on ephemeral data than its legacy keypool\r\ncounterpart. For wallets without private keys and with unhardened derivation, the\r\nkeypool is aved as a single xpub, and therefore Topup() does not increase storage\r\nsize.\r\n```",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-02-29T10:03:37Z",
      "diff_hunk" : "@@ -458,9 +477,104 @@ class LegacySigningProvider : public SigningProvider\n     bool GetCScript(const CScriptID &scriptid, CScript& script) const override { return m_spk_man.GetCScript(scriptid, script); }\n     bool HaveCScript(const CScriptID &scriptid) const override { return m_spk_man.HaveCScript(scriptid); }\n     bool GetPubKey(const CKeyID &address, CPubKey& pubkey) const override { return m_spk_man.GetPubKey(address, pubkey); }\n-    bool GetKey(const CKeyID &address, CKey& key) const override { return m_spk_man.GetKey(address, key); }\n-    bool HaveKey(const CKeyID &address) const override { return m_spk_man.HaveKey(address); }\n+    bool GetKey(const CKeyID &address, CKey& key) const override { return false; }\n+    bool HaveKey(const CKeyID &address) const override { return false; }\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_desc_index = -1;\n+\n+    OutputType address_type;\n+    bool internal;\n+\n+    KeyMap m_map_keys GUARDED_BY(cs_desc_man);\n+    CryptedKeyMap m_map_crypted_keys GUARDED_BY(cs_desc_man);\n+\n+    bool SetCrypted();\n+\n+    //! keeps track of whether Unlock has run a thorough check before\n+    bool m_decryption_thoroughly_checked = false;\n+\n+    bool AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey);\n+\n+    KeyMap GetKeys() const EXCLUSIVE_LOCKS_REQUIRED(cs_desc_man);\n+\n+    std::unique_ptr<FlatSigningProvider> GetSigningProvider(const CScript& script, bool include_private = false) const;\n+public:\n+    DescriptorScriptPubKeyMan(WalletStorage& storage, WalletDescriptor& descriptor)\n+        :   ScriptPubKeyMan(storage),\n+            descriptor(descriptor)\n+        {}\n+    DescriptorScriptPubKeyMan(WalletStorage& storage, OutputType address_type, bool internal)\n+        :   ScriptPubKeyMan(storage),\n+            address_type(address_type), internal(internal)\n+        {}\n+\n+    mutable RecursiveMutex cs_desc_man;\n+\n+    bool GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error) override;\n+    isminetype IsMine(const CScript& script) const override;\n+\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys = false) override;\n+    bool Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch) override;\n+\n+    bool GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool) override;\n+    void ReturnDestination(int64_t index, bool internal, const CTxDestination& addr) override;\n+\n+    bool TopUp(unsigned int size = 0) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386017234",
      "id" : 386017234,
      "line" : 546,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNzIzNA==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 546,
      "original_position" : 138,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 109,
      "pull_request_review_id" : 366787922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386017234",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386603451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386603451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-02T19:31:04Z",
      "diff_hunk" : "@@ -1434,3 +1496,594 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.range_end <= m_max_desc_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!descriptor.descriptor->ExpandFromCache(descriptor.next_index, descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        if (descriptor.descriptor->IsSingleType()) {\n+            Optional<OutputType> out_script_type = descriptor.descriptor->GetOutputType();\n+            if (out_script_type && out_script_type == type) {\n+                ExtractDestination(scripts_temp[0], dest);\n+            } else {\n+                throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+            }\n+        } else {\n+            // This is a combo descriptor which should not be an active descriptor\n+            assert(false);\n+        }\n+        descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (descriptor.next_index - 1 == index) {\n+        descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_desc_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache cache;\n+        if (!descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &cache)) {\n+            // Maybe we have a cached xpub and we can expand from cache\n+            if (!descriptor.descriptor->ExpandFromCache(i, descriptor.cache, scripts_temp, out_keys)) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386603451",
      "id" : 386603451,
      "in_reply_to_id" : 386015063,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwMzQ1MQ==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 1683,
      "original_position" : 292,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 367467531,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386603451",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386603522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386603522"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done. Added a comment.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-02T19:31:11Z",
      "diff_hunk" : "@@ -1434,3 +1496,594 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386603522",
      "id" : 386603522,
      "in_reply_to_id" : 386015338,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwMzUyMg==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 1505,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 367467629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386603522",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386603601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386603601"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-02T19:31:21Z",
      "diff_hunk" : "@@ -458,9 +477,104 @@ class LegacySigningProvider : public SigningProvider\n     bool GetCScript(const CScriptID &scriptid, CScript& script) const override { return m_spk_man.GetCScript(scriptid, script); }\n     bool HaveCScript(const CScriptID &scriptid) const override { return m_spk_man.HaveCScript(scriptid); }\n     bool GetPubKey(const CKeyID &address, CPubKey& pubkey) const override { return m_spk_man.GetPubKey(address, pubkey); }\n-    bool GetKey(const CKeyID &address, CKey& key) const override { return m_spk_man.GetKey(address, key); }\n-    bool HaveKey(const CKeyID &address) const override { return m_spk_man.HaveKey(address); }\n+    bool GetKey(const CKeyID &address, CKey& key) const override { return false; }\n+    bool HaveKey(const CKeyID &address) const override { return false; }\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_desc_index = -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386603601",
      "id" : 386603601,
      "in_reply_to_id" : 386016600,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwMzYwMQ==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 495,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 367467721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386603601",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386603947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386603947"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I added a comment earlier so that should help. I would prefer to keep the current pattern of always doing `CanGetAddresses` first.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-02T19:31:59Z",
      "diff_hunk" : "@@ -1434,3 +1496,594 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.range_end <= m_max_desc_index && !TopUp(1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386603947",
      "id" : 386603947,
      "in_reply_to_id" : 386016947,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwMzk0Nw==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 1520,
      "original_position" : 128,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 367468157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386603947",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386604011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386604011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a similar comment.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-02T19:32:07Z",
      "diff_hunk" : "@@ -458,9 +477,104 @@ class LegacySigningProvider : public SigningProvider\n     bool GetCScript(const CScriptID &scriptid, CScript& script) const override { return m_spk_man.GetCScript(scriptid, script); }\n     bool HaveCScript(const CScriptID &scriptid) const override { return m_spk_man.HaveCScript(scriptid); }\n     bool GetPubKey(const CKeyID &address, CPubKey& pubkey) const override { return m_spk_man.GetPubKey(address, pubkey); }\n-    bool GetKey(const CKeyID &address, CKey& key) const override { return m_spk_man.GetKey(address, key); }\n-    bool HaveKey(const CKeyID &address) const override { return m_spk_man.HaveKey(address); }\n+    bool GetKey(const CKeyID &address, CKey& key) const override { return false; }\n+    bool HaveKey(const CKeyID &address) const override { return false; }\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_desc_index = -1;\n+\n+    OutputType address_type;\n+    bool internal;\n+\n+    KeyMap m_map_keys GUARDED_BY(cs_desc_man);\n+    CryptedKeyMap m_map_crypted_keys GUARDED_BY(cs_desc_man);\n+\n+    bool SetCrypted();\n+\n+    //! keeps track of whether Unlock has run a thorough check before\n+    bool m_decryption_thoroughly_checked = false;\n+\n+    bool AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey);\n+\n+    KeyMap GetKeys() const EXCLUSIVE_LOCKS_REQUIRED(cs_desc_man);\n+\n+    std::unique_ptr<FlatSigningProvider> GetSigningProvider(const CScript& script, bool include_private = false) const;\n+public:\n+    DescriptorScriptPubKeyMan(WalletStorage& storage, WalletDescriptor& descriptor)\n+        :   ScriptPubKeyMan(storage),\n+            descriptor(descriptor)\n+        {}\n+    DescriptorScriptPubKeyMan(WalletStorage& storage, OutputType address_type, bool internal)\n+        :   ScriptPubKeyMan(storage),\n+            address_type(address_type), internal(internal)\n+        {}\n+\n+    mutable RecursiveMutex cs_desc_man;\n+\n+    bool GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error) override;\n+    isminetype IsMine(const CScript& script) const override;\n+\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys = false) override;\n+    bool Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch) override;\n+\n+    bool GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool) override;\n+    void ReturnDestination(int64_t index, bool internal, const CTxDestination& addr) override;\n+\n+    bool TopUp(unsigned int size = 0) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r386604011",
      "id" : 386604011,
      "in_reply_to_id" : 386017234,
      "line" : 546,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwNDAxMQ==",
      "original_commit_id" : "8f282ebaf0ddd120f5fa0f9d0a1b2b46f7ac5b40",
      "original_line" : 546,
      "original_position" : 138,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 109,
      "pull_request_review_id" : 367468243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386604011",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r387791934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387791934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Even if it was \"unnecessary\" I think it makes the code less brittle to future changes anyways.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-04T16:41:32Z",
      "diff_hunk" : "@@ -1434,3 +1496,609 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No private keys available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (descriptor.range_end <= m_max_desc_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!descriptor.descriptor->ExpandFromCache(descriptor.next_index, descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        if (descriptor.descriptor->IsSingleType()) {\n+            Optional<OutputType> out_script_type = descriptor.descriptor->GetOutputType();\n+            if (out_script_type && out_script_type == type) {\n+                ExtractDestination(scripts_temp[0], dest);\n+            } else {\n+                throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+            }\n+        } else {\n+            // This is a combo descriptor which should not be an active descriptor\n+            assert(false);\n+        }\n+        descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (descriptor.next_index - 1 == index) {\n+        descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_desc_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache cache;\n+        if (!descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &cache)) {\n+            // Maybe we have a cached xpub and we can expand from cache\n+            if (!descriptor.descriptor->ExpandFromCache(i, descriptor.cache, scripts_temp, out_keys)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        std::map<KeyOriginInfo, CExtPubKey> newly_cached = descriptor.cache.GetNotCached(cache.GetCachedExtPubKeys());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r387791934",
      "id" : 387791934,
      "in_reply_to_id" : 385668788,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5MTkzNA==",
      "original_commit_id" : "1b4fd1424f6160195d6d28072d8793b666db007d",
      "original_line" : 1691,
      "original_position" : 299,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 368940711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387791934",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/fa733bbd78add587e19f0175ab9c127a8c27e024/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-09T21:20:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-596785815",
      "id" : 596785815,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5Njc4NTgxNQ==",
      "updated_at" : "2020-03-09T21:20:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596785815",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased following #18204 merge, so this is ready for review.",
      "created_at" : "2020-03-16T19:37:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-599723688",
      "id" : 599723688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTcyMzY4OA==",
      "updated_at" : "2020-03-16T19:37:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599723688",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395854864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395854864"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggestion: `s/descriptor/m_wallet_descriptor/`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-20T19:42:50Z",
      "diff_hunk" : "@@ -484,8 +484,17 @@ class LegacySigningProvider : public SigningProvider\n \n class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n {\n+private:\n+    WalletDescriptor descriptor GUARDED_BY(cs_desc_man);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395854864",
      "id" : 395854864,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1NDg2NA==",
      "original_commit_id" : "10d744735666fb6e9e1dbe44a2112434daebfee9",
      "original_line" : 488,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395854864",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395865796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395865796"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Placeholder for this thought: As I mentioned elsewhere, I'd really like something smarter for detecting `IsChange`. We could instead store the internall-ness via record with the spkm themselves, then the `active` record needs one less thing as well, and know what is change even on wallet restore.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-20T20:07:20Z",
      "diff_hunk" : "@@ -179,6 +182,15 @@ bool WalletBatch::WriteMinVersion(int nVersion)\n     return WriteIC(DBKeys::MINVERSION, nVersion);\n }\n \n+bool WalletBatch::WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395865796",
      "id" : 395865796,
      "line" : 188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2NTc5Ng==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 188,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 24,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395865796",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395867154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395867154"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggestion: `s/m_internal_spk_managers/m_active_internal_spkm/`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-20T20:10:49Z",
      "diff_hunk" : "@@ -189,6 +201,8 @@ class CWalletScanState {\n     bool fIsEncrypted{false};\n     bool fAnyUnordered{false};\n     std::vector<uint256> vWalletUpgrade;\n+    std::map<OutputType, uint256> m_external_spk_managers;\n+    std::map<OutputType, uint256> m_internal_spk_managers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395867154",
      "id" : 395867154,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2NzE1NA==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 247,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395867154",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395867365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395867365"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggestion: `s/m_external_spk_managers/m_active_external_spkm/`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-20T20:11:18Z",
      "diff_hunk" : "@@ -189,6 +201,8 @@ class CWalletScanState {\n     bool fIsEncrypted{false};\n     bool fAnyUnordered{false};\n     std::vector<uint256> vWalletUpgrade;\n+    std::map<OutputType, uint256> m_external_spk_managers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395867365",
      "id" : 395867365,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2NzM2NQ==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 246,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395867365",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395867702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395867702"
         }
      },
      "author_association" : "MEMBER",
      "body" : "should this get upset or log if there's already one in the map?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-20T20:12:04Z",
      "diff_hunk" : "@@ -402,6 +416,21 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n         } else if (strType == DBKeys::OLD_KEY) {\n             strErr = \"Found unsupported 'wkey' record, try loading with version 0.18\";\n             return false;\n+        } else if (strType == DBKeys::EXTERNALSPK || strType == DBKeys::INTERNALSPK) {\n+            uint8_t type;\n+            ssKey >> type;\n+            uint256 id;\n+            ssValue >> id;\n+\n+            bool internal = strType == DBKeys::INTERNALSPK;\n+            auto& spk_mans = internal ? wss.m_internal_spk_managers : wss.m_external_spk_managers;\n+            spk_mans[static_cast<OutputType>(type)] = id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395867702",
      "id" : 395867702,
      "line" : 475,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2NzcwMg==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 475,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 100,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395867702",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395869627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395869627"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggestion: `ACTIVEEXTERNALSPK` or something",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-20T20:16:41Z",
      "diff_hunk" : "@@ -60,8 +60,10 @@ extern const std::string CRYPTED_KEY;\n extern const std::string CSCRIPT;\n extern const std::string DEFAULTKEY;\n extern const std::string DESTDATA;\n+extern const std::string EXTERNALSPK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395869627",
      "id" : 395869627,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2OTYyNw==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 64,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395869627",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395869783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395869783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggestion: `ACTIVEINTERNALSPK` or something",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-20T20:17:02Z",
      "diff_hunk" : "@@ -60,8 +60,10 @@ extern const std::string CRYPTED_KEY;\n extern const std::string CSCRIPT;\n extern const std::string DEFAULTKEY;\n extern const std::string DESTDATA;\n+extern const std::string EXTERNALSPK;\n extern const std::string FLAGS;\n extern const std::string HDCHAIN;\n+extern const std::string INTERNALSPK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395869783",
      "id" : 395869783,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2OTc4Mw==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 67,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395869783",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395871641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395871641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "*sheds single tear for simplicity*",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-20T20:21:28Z",
      "diff_hunk" : "@@ -1506,6 +1506,10 @@ bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDest\n \n isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n {\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395871641",
      "id" : 395871641,
      "line" : 1548,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3MTY0MQ==",
      "original_commit_id" : "7eaee4bd840b29a5fcd4810f9b87ff3e95c36e1c",
      "original_line" : 1548,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 78,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395871641",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395872979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395872979"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just noting that this is strictly a \"softfork\" over LegacySPKM: previously any detected pubkey in involved in a script would boot an entry.\r\n\r\nThe new behavior is much simpler and easier to reason about. Just noting it's different in case somebody does some sort of idiotic key-sharing wallet between chains.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-20T20:24:44Z",
      "diff_hunk" : "@@ -1539,6 +1539,17 @@ bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n \n void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r395872979",
      "id" : 395872979,
      "line" : 1736,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3Mjk3OQ==",
      "original_commit_id" : "71f9ce5e93b2a66fcd76d9d7467a83470e030c93",
      "original_line" : 1736,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 266,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395872979",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-23T22:03:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-602880641",
      "id" : 602880641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMjg4MDY0MQ==",
      "updated_at" : "2020-03-23T22:03:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/602880641",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397840687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397840687"
         }
      },
      "author_association" : "MEMBER",
      "body" : "under what circumstances would multiple scriptpubkeys be generated for a descriptor wallet? Isn't this just for `combo` which is inapplicable?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T13:11:51Z",
      "diff_hunk" : "@@ -1632,3 +1632,18 @@ void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)\n     this->address_type = type;\n     this->internal = internal;\n }\n+\n+void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n+{\n+    LOCK(cs_desc_man);\n+    descriptor.cache = cache;\n+    for (int32_t i = descriptor.range_start; i < descriptor.range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        descriptor.descriptor->ExpandFromCache(i, descriptor.cache, scripts_temp, out_keys);\n+        // Add all of the scriptPubKeys to the scriptPubKey set",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397840687",
      "id" : 397840687,
      "line" : 2096,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg0MDY4Nw==",
      "original_commit_id" : "4a0b2986f4716a177ea4e221c846a4bdb47f9317",
      "original_line" : 2096,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 626,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397840687",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397846119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397846119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "should be asserting or aborting the next line when spkm cannot be found(`nullptr`) for whatever reason",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T13:19:50Z",
      "diff_hunk" : "@@ -532,6 +560,12 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, /* internal */ true, /* memonly */ true);\n     }\n \n+    // Set the descriptor caches\n+    for (auto desc_cache_pair : wss.m_descriptor_caches) {\n+        auto spk_man = pwallet->GetScriptPubKeyMan(desc_cache_pair.first);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397846119",
      "id" : 397846119,
      "line" : 668,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg0NjExOQ==",
      "original_commit_id" : "4a0b2986f4716a177ea4e221c846a4bdb47f9317",
      "original_line" : 668,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 207,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397846119",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397847371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397847371"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this means the `DBKeys::WALLETDESCRIPTOR`  must be an earlier record in all cases? Probably deserves a note.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T13:21:46Z",
      "diff_hunk" : "@@ -430,7 +432,33 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssKey >> id;\n             WalletDescriptor desc;\n             ssValue >> desc;\n+            wss.m_descriptor_caches[id] = DescriptorCache();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397847371",
      "id" : 397847371,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg0NzM3MQ==",
      "original_commit_id" : "4a0b2986f4716a177ea4e221c846a4bdb47f9317",
      "original_line" : 435,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397847371",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397859895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397859895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why is `HavePrivateKeys()` sufficient here for non-HD?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T13:39:22Z",
      "diff_hunk" : "@@ -1560,12 +1560,14 @@ bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n \n bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return HavePrivateKeys() || descriptor.next_index < descriptor.range_end;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397859895",
      "id" : 397859895,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg1OTg5NQ==",
      "original_commit_id" : "d117cb1078f8a3c10a717ed642af00ab62643853",
      "original_line" : 1564,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397859895",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397903046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397903046"
         }
      },
      "author_association" : "MEMBER",
      "body" : "brackets for this conditional block please",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T14:34:59Z",
      "diff_hunk" : "@@ -1532,9 +1532,99 @@ void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal,\n {\n }\n \n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397903046",
      "id" : 397903046,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwMzA0Ng==",
      "original_commit_id" : "915da4fababc4237e99823cf32399fe02646c061",
      "original_line" : 1556,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397903046",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397904496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397904496"
         }
      },
      "author_association" : "MEMBER",
      "body" : "just make the second argument `1`, then delete the line below?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T14:36:48Z",
      "diff_hunk" : "@@ -1532,9 +1532,99 @@ void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal,\n {\n }\n \n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397904496",
      "id" : 397904496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwNDQ5Ng==",
      "original_commit_id" : "915da4fababc4237e99823cf32399fe02646c061",
      "original_line" : 1559,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397904496",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397906438"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397906438"
         }
      },
      "author_association" : "MEMBER",
      "body" : "is it important to not set `descriptor.range_end` here?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T14:39:13Z",
      "diff_hunk" : "@@ -1532,9 +1532,99 @@ void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal,\n {\n }\n \n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397906438",
      "id" : 397906438,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwNjQzOA==",
      "original_commit_id" : "915da4fababc4237e99823cf32399fe02646c061",
      "original_line" : 1563,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397906438",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397917366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397917366"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggested rename to `temp_cache` or something to make it visually easier to track what's what",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T14:52:45Z",
      "diff_hunk" : "@@ -1532,9 +1532,99 @@ void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal,\n {\n }\n \n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache cache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r397917366",
      "id" : 397917366,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxNzM2Ng==",
      "original_commit_id" : "915da4fababc4237e99823cf32399fe02646c061",
      "original_line" : 1580,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 378766395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/397917366",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398001581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398001581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just `combo` which can be imported. `TopUp` is called for all imports to generate the scriptPubKeys, scripts, etc.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T16:39:01Z",
      "diff_hunk" : "@@ -1632,3 +1632,18 @@ void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)\n     this->address_type = type;\n     this->internal = internal;\n }\n+\n+void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n+{\n+    LOCK(cs_desc_man);\n+    descriptor.cache = cache;\n+    for (int32_t i = descriptor.range_start; i < descriptor.range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        descriptor.descriptor->ExpandFromCache(i, descriptor.cache, scripts_temp, out_keys);\n+        // Add all of the scriptPubKeys to the scriptPubKey set",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398001581",
      "id" : 398001581,
      "in_reply_to_id" : 397840687,
      "line" : 2096,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAwMTU4MQ==",
      "original_commit_id" : "4a0b2986f4716a177ea4e221c846a4bdb47f9317",
      "original_line" : 2096,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 626,
      "pull_request_review_id" : 381331258,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398001581",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398099420"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398099420"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It isn't. `CanGetAddresses` should return false for non-ranged descriptors because you cannot get new addresses from such a descriptor. `HavePrivateKeys` here is for when the cache runs on hardened derivation. If we have private keys, then we can continue to derive those hardened keys.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T19:02:13Z",
      "diff_hunk" : "@@ -1560,12 +1560,14 @@ bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n \n bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return HavePrivateKeys() || descriptor.next_index < descriptor.range_end;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398099420",
      "id" : 398099420,
      "in_reply_to_id" : 397859895,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA5OTQyMA==",
      "original_commit_id" : "d117cb1078f8a3c10a717ed642af00ab62643853",
      "original_line" : 1564,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 381450923,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398099420",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398101876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398101876"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In case we exit early, we don't want to update the descriptor.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T19:06:30Z",
      "diff_hunk" : "@@ -1532,9 +1532,99 @@ void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal,\n {\n }\n \n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398101876",
      "id" : 398101876,
      "in_reply_to_id" : 397906438,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEwMTg3Ng==",
      "original_commit_id" : "915da4fababc4237e99823cf32399fe02646c061",
      "original_line" : 1563,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 381453951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398101876",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149580"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:31:25Z",
      "diff_hunk" : "@@ -484,8 +484,17 @@ class LegacySigningProvider : public SigningProvider\n \n class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n {\n+private:\n+    WalletDescriptor descriptor GUARDED_BY(cs_desc_man);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149580",
      "id" : 398149580,
      "in_reply_to_id" : 395854864,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0OTU4MA==",
      "original_commit_id" : "10d744735666fb6e9e1dbe44a2112434daebfee9",
      "original_line" : 488,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 381512515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149580",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149628"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:31:31Z",
      "diff_hunk" : "@@ -189,6 +201,8 @@ class CWalletScanState {\n     bool fIsEncrypted{false};\n     bool fAnyUnordered{false};\n     std::vector<uint256> vWalletUpgrade;\n+    std::map<OutputType, uint256> m_external_spk_managers;\n+    std::map<OutputType, uint256> m_internal_spk_managers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149628",
      "id" : 398149628,
      "in_reply_to_id" : 395867154,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0OTYyOA==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 247,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 381512576,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149628",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149693"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149693"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:31:36Z",
      "diff_hunk" : "@@ -189,6 +201,8 @@ class CWalletScanState {\n     bool fIsEncrypted{false};\n     bool fAnyUnordered{false};\n     std::vector<uint256> vWalletUpgrade;\n+    std::map<OutputType, uint256> m_external_spk_managers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149693",
      "id" : 398149693,
      "in_reply_to_id" : 395867365,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0OTY5Mw==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 246,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 381512635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149693",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149738"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:31:41Z",
      "diff_hunk" : "@@ -60,8 +60,10 @@ extern const std::string CRYPTED_KEY;\n extern const std::string CSCRIPT;\n extern const std::string DEFAULTKEY;\n extern const std::string DESTDATA;\n+extern const std::string EXTERNALSPK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149738",
      "id" : 398149738,
      "in_reply_to_id" : 395869627,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0OTczOA==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 64,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 381512692,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149738",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149790"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:31:47Z",
      "diff_hunk" : "@@ -60,8 +60,10 @@ extern const std::string CRYPTED_KEY;\n extern const std::string CSCRIPT;\n extern const std::string DEFAULTKEY;\n extern const std::string DESTDATA;\n+extern const std::string EXTERNALSPK;\n extern const std::string FLAGS;\n extern const std::string HDCHAIN;\n+extern const std::string INTERNALSPK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149790",
      "id" : 398149790,
      "in_reply_to_id" : 395869783,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0OTc5MA==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 67,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 381512763,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149790",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:31:58Z",
      "diff_hunk" : "@@ -430,7 +432,33 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssKey >> id;\n             WalletDescriptor desc;\n             ssValue >> desc;\n+            wss.m_descriptor_caches[id] = DescriptorCache();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149895",
      "id" : 398149895,
      "in_reply_to_id" : 397847371,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0OTg5NQ==",
      "original_commit_id" : "4a0b2986f4716a177ea4e221c846a4bdb47f9317",
      "original_line" : 435,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 381512881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149895",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149942"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:32:03Z",
      "diff_hunk" : "@@ -1532,9 +1532,99 @@ void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal,\n {\n }\n \n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149942",
      "id" : 398149942,
      "in_reply_to_id" : 397903046,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0OTk0Mg==",
      "original_commit_id" : "915da4fababc4237e99823cf32399fe02646c061",
      "original_line" : 1556,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 381512946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149942",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:32:07Z",
      "diff_hunk" : "@@ -1532,9 +1532,99 @@ void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal,\n {\n }\n \n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398149976",
      "id" : 398149976,
      "in_reply_to_id" : 397904496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE0OTk3Ng==",
      "original_commit_id" : "915da4fababc4237e99823cf32399fe02646c061",
      "original_line" : 1559,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 381512990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398149976",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398150104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398150104"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:32:20Z",
      "diff_hunk" : "@@ -1532,9 +1532,99 @@ void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal,\n {\n }\n \n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0)\n+        target_size = size;\n+    else\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    target_size = std::max((int32_t)target_size, 1);\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(descriptor.next_index + (int32_t)target_size, descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        descriptor.range_end = 1;\n+        descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache cache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398150104",
      "id" : 398150104,
      "in_reply_to_id" : 397917366,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE1MDEwNA==",
      "original_commit_id" : "915da4fababc4237e99823cf32399fe02646c061",
      "original_line" : 1580,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 381513140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398150104",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398158910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398158910"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:47:51Z",
      "diff_hunk" : "@@ -532,6 +560,12 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, /* internal */ true, /* memonly */ true);\n     }\n \n+    // Set the descriptor caches\n+    for (auto desc_cache_pair : wss.m_descriptor_caches) {\n+        auto spk_man = pwallet->GetScriptPubKeyMan(desc_cache_pair.first);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398158910",
      "id" : 398158910,
      "in_reply_to_id" : 397846119,
      "line" : 668,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE1ODkxMA==",
      "original_commit_id" : "4a0b2986f4716a177ea4e221c846a4bdb47f9317",
      "original_line" : 668,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 207,
      "pull_request_review_id" : 381523879,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398158910",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398159024"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398159024"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a check that will give an error.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-25T20:48:04Z",
      "diff_hunk" : "@@ -402,6 +416,21 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n         } else if (strType == DBKeys::OLD_KEY) {\n             strErr = \"Found unsupported 'wkey' record, try loading with version 0.18\";\n             return false;\n+        } else if (strType == DBKeys::EXTERNALSPK || strType == DBKeys::INTERNALSPK) {\n+            uint8_t type;\n+            ssKey >> type;\n+            uint256 id;\n+            ssValue >> id;\n+\n+            bool internal = strType == DBKeys::INTERNALSPK;\n+            auto& spk_mans = internal ? wss.m_internal_spk_managers : wss.m_external_spk_managers;\n+            spk_mans[static_cast<OutputType>(type)] = id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398159024",
      "id" : 398159024,
      "in_reply_to_id" : 395867702,
      "line" : 475,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE1OTAyNA==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 475,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 100,
      "pull_request_review_id" : 381524033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398159024",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398626518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398626518"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> CanGetAddresses should return false for non-ranged descriptors because you cannot get new addresses from such a descriptor\r\n\r\nHm? If you import a non-ranged descriptor that includes a private key, `CanGetAddress` will return true here.\r\n\r\nWhatever the result of this discussion is, I think this code section requires a comment.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T14:41:45Z",
      "diff_hunk" : "@@ -1560,12 +1560,14 @@ bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n \n bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return HavePrivateKeys() || descriptor.next_index < descriptor.range_end;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398626518",
      "id" : 398626518,
      "in_reply_to_id" : 397859895,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYyNjUxOA==",
      "original_commit_id" : "d117cb1078f8a3c10a717ed642af00ab62643853",
      "original_line" : 1564,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 382077357,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398626518",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398628815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398628815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah right I got confused about `active` arg. In that case the `importdescriptors` help should be noting that `combo` cannot be active. The error is helpful enough but I think it warrants note.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T14:44:45Z",
      "diff_hunk" : "@@ -1632,3 +1632,18 @@ void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)\n     this->address_type = type;\n     this->internal = internal;\n }\n+\n+void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n+{\n+    LOCK(cs_desc_man);\n+    descriptor.cache = cache;\n+    for (int32_t i = descriptor.range_start; i < descriptor.range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        descriptor.descriptor->ExpandFromCache(i, descriptor.cache, scripts_temp, out_keys);\n+        // Add all of the scriptPubKeys to the scriptPubKey set",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398628815",
      "id" : 398628815,
      "in_reply_to_id" : 397840687,
      "line" : 2096,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYyODgxNQ==",
      "original_commit_id" : "4a0b2986f4716a177ea4e221c846a4bdb47f9317",
      "original_line" : 2096,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 626,
      "pull_request_review_id" : 382080368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398628815",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "all changes until `\"Implement GetNewDestination for DescriptorScriptPubKeyMan\"` 0b4b742dd57b6413617368b013350b5397711f9f look correct.",
      "created_at" : "2020-03-26T14:52:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-604475820",
      "id" : 604475820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNDQ3NTgyMA==",
      "updated_at" : "2020-03-26T14:52:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604475820",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398683481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398683481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> But we may still be unable to get addresses, these conditions are caught later.\r\n\r\nfrom `GetNewDestination`. Might want to move that comment to where I'm asking and explain exactly what additional checks are required?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T15:52:41Z",
      "diff_hunk" : "@@ -1560,12 +1560,14 @@ bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n \n bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return HavePrivateKeys() || descriptor.next_index < descriptor.range_end;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398683481",
      "id" : 398683481,
      "in_reply_to_id" : 397859895,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4MzQ4MQ==",
      "original_commit_id" : "d117cb1078f8a3c10a717ed642af00ab62643853",
      "original_line" : 1564,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 382149833,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398683481",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398685369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398685369"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_address_type`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T15:55:00Z",
      "diff_hunk" : "@@ -477,4 +482,103 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor m_wallet_descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_cached_index = -1;\n+\n+    OutputType address_type;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398685369",
      "id" : 398685369,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4NTM2OQ==",
      "original_commit_id" : "8da5fdc34ae68fe3ae81b9fc889f4f2a8718fc6e",
      "original_line" : 497,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 382152176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398685369",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398685506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398685506"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_internal`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T15:55:09Z",
      "diff_hunk" : "@@ -477,4 +482,103 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor m_wallet_descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_cached_index = -1;\n+\n+    OutputType address_type;\n+    bool internal;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398685506",
      "id" : 398685506,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4NTUwNg==",
      "original_commit_id" : "8da5fdc34ae68fe3ae81b9fc889f4f2a8718fc6e",
      "original_line" : 498,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 382152176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398685506",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398687507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398687507"
         }
      },
      "author_association" : "MEMBER",
      "body" : "just assert this at the top of the function?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T15:57:38Z",
      "diff_hunk" : "@@ -1501,7 +1501,48 @@ void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n \n bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n {\n-    return false;\n+    // Returns true if we have private keys (encrypted or not) or we have cached keys. But we may still be unable to get addresses, these conditions are caught later.\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (m_wallet_descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        if (m_wallet_descriptor.descriptor->IsSingleType()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398687507",
      "id" : 398687507,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4NzUwNw==",
      "original_commit_id" : "0b4b742dd57b6413617368b013350b5397711f9f",
      "original_line" : 1531,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 382152176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398687507",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398688635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398688635"
         }
      },
      "author_association" : "MEMBER",
      "body" : "we should only be `SingleType`, right? Assert earlier and then just do simple type check?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T15:58:56Z",
      "diff_hunk" : "@@ -1501,7 +1501,48 @@ void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n \n bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n {\n-    return false;\n+    // Returns true if we have private keys (encrypted or not) or we have cached keys. But we may still be unable to get addresses, these conditions are caught later.\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (m_wallet_descriptor.descriptor->IsSingleType() && type != address_type) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398688635",
      "id" : 398688635,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4ODYzNQ==",
      "original_commit_id" : "0b4b742dd57b6413617368b013350b5397711f9f",
      "original_line" : 1511,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 382152176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398688635",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398697109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398697109"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note if and when this value can change",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T16:10:01Z",
      "diff_hunk" : "@@ -83,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398697109",
      "id" : 398697109,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5NzEwOQ==",
      "original_commit_id" : "8da5fdc34ae68fe3ae81b9fc889f4f2a8718fc6e",
      "original_line" : 96,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : null,
      "pull_request_review_id" : 382152176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398697109",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398697256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398697256"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note if and when this value is set and can change e.g., `TopUp`?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T16:10:13Z",
      "diff_hunk" : "@@ -83,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end)\n+    int32_t range_end; // Item after the last; end of range, exclusive, i.e. [range_start, range_end)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398697256",
      "id" : 398697256,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5NzI1Ng==",
      "original_commit_id" : "8da5fdc34ae68fe3ae81b9fc889f4f2a8718fc6e",
      "original_line" : 97,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : null,
      "pull_request_review_id" : 382152176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398697256",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398709651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398709651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you explain why we do a `TopUp(1)` here then a few lines later do the `ExpandFromCache`?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T16:25:34Z",
      "diff_hunk" : "@@ -1501,7 +1501,48 @@ void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n \n bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n {\n-    return false;\n+    // Returns true if we have private keys (encrypted or not) or we have cached keys. But we may still be unable to get addresses, these conditions are caught later.\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (m_wallet_descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398709651",
      "id" : 398709651,
      "line" : 1522,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcwOTY1MQ==",
      "original_commit_id" : "0b4b742dd57b6413617368b013350b5397711f9f",
      "original_line" : 1522,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 52,
      "pull_request_review_id" : 382152176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398709651",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398735707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398735707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "future work: looks like a lot of duplicated code with a couple differences from legacy.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T16:59:18Z",
      "diff_hunk" : "@@ -1946,9 +1946,60 @@ SigningResult DescriptorScriptPubKeyMan::SignMessage(const std::string& message,\n     return SigningResult::OK;\n }\n \n-TransactionError DescriptorScriptPubKeyMan::FillPSBT(PartiallySignedTransaction& psbt, int sighash_type, bool sign, bool bip32derivs) const\n+TransactionError DescriptorScriptPubKeyMan::FillPSBT(PartiallySignedTransaction& psbtx, int sighash_type, bool sign, bool bip32derivs) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398735707",
      "id" : 398735707,
      "line" : 1986,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODczNTcwNw==",
      "original_commit_id" : "40960f93162b84507095529a522afb7350752344",
      "original_line" : 1986,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 516,
      "pull_request_review_id" : 382152176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398735707",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398739746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398739746"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Descriptor*",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T17:04:53Z",
      "diff_hunk" : "@@ -1220,6 +1220,9 @@ class CWallet final : public WalletStorage, private interfaces::Chain::Notificat\n \n     //! Sets the active ScriptPubKeyMan for the specified type and internal\n     void SetActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal, bool memonly = false);\n+\n+    //! Create new DescriptoScriptPubKeyMans and add them to the wallet",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398739746",
      "id" : 398739746,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODczOTc0Ng==",
      "original_commit_id" : "339cc0e6b78b0d8601c8bd64d9ea470ae9d0fa22",
      "original_line" : 1227,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 382152176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398739746",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398781243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398781243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've tightened up the checks that `CanGetAddresses` does. It will do a `IsSingleType` and `IsRange` check now to disallow non-ranged descriptor and combo descriptors.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T18:02:46Z",
      "diff_hunk" : "@@ -1560,12 +1560,14 @@ bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n \n bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return HavePrivateKeys() || descriptor.next_index < descriptor.range_end;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398781243",
      "id" : 398781243,
      "in_reply_to_id" : 397859895,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4MTI0Mw==",
      "original_commit_id" : "d117cb1078f8a3c10a717ed642af00ab62643853",
      "original_line" : 1564,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 382272209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398781243",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398781422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398781422"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T18:03:01Z",
      "diff_hunk" : "@@ -477,4 +482,103 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor m_wallet_descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_cached_index = -1;\n+\n+    OutputType address_type;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398781422",
      "id" : 398781422,
      "in_reply_to_id" : 398685369,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4MTQyMg==",
      "original_commit_id" : "8da5fdc34ae68fe3ae81b9fc889f4f2a8718fc6e",
      "original_line" : 497,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 382272397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398781422",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398781493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398781493"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T18:03:07Z",
      "diff_hunk" : "@@ -477,4 +482,103 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor m_wallet_descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_cached_index = -1;\n+\n+    OutputType address_type;\n+    bool internal;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398781493",
      "id" : 398781493,
      "in_reply_to_id" : 398685506,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4MTQ5Mw==",
      "original_commit_id" : "8da5fdc34ae68fe3ae81b9fc889f4f2a8718fc6e",
      "original_line" : 498,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 382272484,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398781493",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398781557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398781557"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T18:03:12Z",
      "diff_hunk" : "@@ -1501,7 +1501,48 @@ void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n \n bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n {\n-    return false;\n+    // Returns true if we have private keys (encrypted or not) or we have cached keys. But we may still be unable to get addresses, these conditions are caught later.\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (m_wallet_descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        if (m_wallet_descriptor.descriptor->IsSingleType()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398781557",
      "id" : 398781557,
      "in_reply_to_id" : 398687507,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4MTU1Nw==",
      "original_commit_id" : "0b4b742dd57b6413617368b013350b5397711f9f",
      "original_line" : 1531,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 382272560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398781557",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398782728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398782728"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T18:05:02Z",
      "diff_hunk" : "@@ -1501,7 +1501,48 @@ void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n \n bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n {\n-    return false;\n+    // Returns true if we have private keys (encrypted or not) or we have cached keys. But we may still be unable to get addresses, these conditions are caught later.\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (m_wallet_descriptor.descriptor->IsSingleType() && type != address_type) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398782728",
      "id" : 398782728,
      "in_reply_to_id" : 398688635,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4MjcyOA==",
      "original_commit_id" : "0b4b742dd57b6413617368b013350b5397711f9f",
      "original_line" : 1511,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 382274801,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398782728",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398782796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398782796"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T18:05:08Z",
      "diff_hunk" : "@@ -83,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398782796",
      "id" : 398782796,
      "in_reply_to_id" : 398697109,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4Mjc5Ng==",
      "original_commit_id" : "8da5fdc34ae68fe3ae81b9fc889f4f2a8718fc6e",
      "original_line" : 96,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : null,
      "pull_request_review_id" : 382275011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398782796",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398782851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398782851"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T18:05:13Z",
      "diff_hunk" : "@@ -83,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end)\n+    int32_t range_end; // Item after the last; end of range, exclusive, i.e. [range_start, range_end)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398782851",
      "id" : 398782851,
      "in_reply_to_id" : 398697256,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4Mjg1MQ==",
      "original_commit_id" : "8da5fdc34ae68fe3ae81b9fc889f4f2a8718fc6e",
      "original_line" : 97,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : null,
      "pull_request_review_id" : 382275189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398782851",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398785993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398785993"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`TopUp(1)` generates the next cache item if we have run out of cached things. `ExpandFromCache` can then use that cached thing. Otherwise `TopUp(1)` is a no-op.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T18:08:27Z",
      "diff_hunk" : "@@ -1501,7 +1501,48 @@ void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n \n bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n {\n-    return false;\n+    // Returns true if we have private keys (encrypted or not) or we have cached keys. But we may still be unable to get addresses, these conditions are caught later.\n+    if (!CanGetAddresses(internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        if (m_wallet_descriptor.descriptor->IsSingleType() && type != address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398785993",
      "id" : 398785993,
      "in_reply_to_id" : 398709651,
      "line" : 1522,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4NTk5Mw==",
      "original_commit_id" : "0b4b742dd57b6413617368b013350b5397711f9f",
      "original_line" : 1522,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 52,
      "pull_request_review_id" : 382279330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398785993",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398786114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398786114"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-26T18:08:36Z",
      "diff_hunk" : "@@ -1220,6 +1220,9 @@ class CWallet final : public WalletStorage, private interfaces::Chain::Notificat\n \n     //! Sets the active ScriptPubKeyMan for the specified type and internal\n     void SetActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal, bool memonly = false);\n+\n+    //! Create new DescriptoScriptPubKeyMans and add them to the wallet",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r398786114",
      "id" : 398786114,
      "in_reply_to_id" : 398739746,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4NjExNA==",
      "original_commit_id" : "339cc0e6b78b0d8601c8bd64d9ea470ae9d0fa22",
      "original_line" : 1227,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 382279449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/398786114",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "changes through `Add IsLegacy to CWallet so that the GUI knows whether to show watchonly` https://github.com/bitcoin/bitcoin/pull/16528/commits/1687d1a1681fc1f6cfaa23a48ea99aa0b07acb4a look correct",
      "created_at" : "2020-03-26T19:00:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-604624259",
      "id" : 604624259,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNDYyNDI1OQ==",
      "updated_at" : "2020-03-26T19:00:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604624259",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399276875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399276875"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggested rename: `GetWalletDescriptor`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T13:48:49Z",
      "diff_hunk" : "@@ -1226,6 +1226,12 @@ class CWallet final : public WalletStorage, private interfaces::Chain::Notificat\n \n     //! Create new DescriptorScriptPubKeyMans and add them to the wallet\n     void SetupDescriptorScriptPubKeyMans();\n+\n+    //! Check if the wallet already has a descriptor\n+    DescriptorScriptPubKeyMan* HasWalletDescriptor(const WalletDescriptor& desc) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399276875",
      "id" : 399276875,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3Njg3NQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1231,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399276875",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399280484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399280484"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in `add importdescriptors RPC and tests for native descriptor wallets`:\r\n\r\nnit: This little code block isn't really necessary. It'll fail to get non-null `spk_manager` for the single legacy spkm.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T13:54:16Z",
      "diff_hunk" : "@@ -4447,3 +4448,91 @@ bool CWallet::IsLegacy() const\n     auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n     return spk_man != nullptr;\n }\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399280484",
      "id" : 399280484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4MDQ4NA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 4454,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399280484",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399281845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399281845"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in `add importdescriptors RPC and tests for native descriptor wallets`:\r\n\r\n\r\n`s/spk_manager/new_spk_man` to line up name with `old_spk_man`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T13:56:15Z",
      "diff_hunk" : "@@ -4447,3 +4448,91 @@ bool CWallet::IsLegacy() const\n     auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n     return spk_man != nullptr;\n }\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        return nullptr;\n+    }\n+\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const FlatSigningProvider& signing_provider, const std::string& label)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot add WalletDescriptor to a non-descriptor wallet\\n\");\n+        return nullptr;\n+    }\n+\n+    LOCK(cs_wallet);\n+    auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399281845",
      "id" : 399281845,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4MTg0NQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 4477,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399281845",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399288954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399288954"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not this PR's fault, but this should really be named `GetActiveScriptPubKeyMan` even though the args make it implicit.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:06:39Z",
      "diff_hunk" : "@@ -4447,3 +4448,91 @@ bool CWallet::IsLegacy() const\n     auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n     return spk_man != nullptr;\n }\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        return nullptr;\n+    }\n+\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const FlatSigningProvider& signing_provider, const std::string& label)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot add WalletDescriptor to a non-descriptor wallet\\n\");\n+        return nullptr;\n+    }\n+\n+    LOCK(cs_wallet);\n+    auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+\n+    // If we already have this descriptor, remove it from the maps but add the existing cache to desc\n+    auto old_spk_man = HasWalletDescriptor(desc);\n+    if (old_spk_man) {\n+        WalletLogPrintf(\"Update existing descriptor: %s\\n\", desc.descriptor->ToString());\n+\n+        {\n+            LOCK(old_spk_man->cs_desc_man);\n+            spk_manager->SetCache(old_spk_man->GetWalletDescriptor().cache);\n+        }\n+\n+        // Remove from maps of spkMans\n+        for (bool internal : {false, true}) {\n+            for (OutputType t : OUTPUT_TYPES) {\n+                auto active_spk_man = GetScriptPubKeyMan(t, internal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399288954",
      "id" : 399288954,
      "line" : 4472,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4ODk1NA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 4472,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 372,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399288954",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399290324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399290324"
         }
      },
      "author_association" : "MEMBER",
      "body" : "another not-PR comment: `m_internal_spk_managers` and `m_external_spk_managers` should also be marked as active, at least in comments.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:08:37Z",
      "diff_hunk" : "@@ -4447,3 +4448,91 @@ bool CWallet::IsLegacy() const\n     auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n     return spk_man != nullptr;\n }\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        return nullptr;\n+    }\n+\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const FlatSigningProvider& signing_provider, const std::string& label)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot add WalletDescriptor to a non-descriptor wallet\\n\");\n+        return nullptr;\n+    }\n+\n+    LOCK(cs_wallet);\n+    auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+\n+    // If we already have this descriptor, remove it from the maps but add the existing cache to desc\n+    auto old_spk_man = HasWalletDescriptor(desc);\n+    if (old_spk_man) {\n+        WalletLogPrintf(\"Update existing descriptor: %s\\n\", desc.descriptor->ToString());\n+\n+        {\n+            LOCK(old_spk_man->cs_desc_man);\n+            spk_manager->SetCache(old_spk_man->GetWalletDescriptor().cache);\n+        }\n+\n+        // Remove from maps of spkMans\n+        for (bool internal : {false, true}) {\n+            for (OutputType t : OUTPUT_TYPES) {\n+                auto active_spk_man = GetScriptPubKeyMan(t, internal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399290324",
      "id" : 399290324,
      "in_reply_to_id" : 399288954,
      "line" : 4472,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5MDMyNA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 4472,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 372,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399290324",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399292755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399292755"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`of active spkMans`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:12:08Z",
      "diff_hunk" : "@@ -4366,3 +4385,156 @@ void CWallet::ConnectScriptPubKeyManNotifiers()\n         spk_man->NotifyCanGetAddressesChanged.connect(NotifyCanGetAddressesChanged);\n     }\n }\n+\n+void CWallet::LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor& desc)\n+{\n+    auto spk_manager = std::unique_ptr<ScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+    m_spk_managers[id] = std::move(spk_manager);\n+}\n+\n+void CWallet::SetupDescriptorScriptPubKeyMans()\n+{\n+    AssertLockHeld(cs_wallet);\n+\n+    // Make a seed\n+    CKey seed_key;\n+    seed_key.MakeNewKey(true);\n+    CPubKey seed = seed_key.GetPubKey();\n+    assert(seed_key.VerifyPubKey(seed));\n+\n+    // Get the extended key\n+    CExtKey master_key;\n+    master_key.SetSeed(seed_key.begin(), seed_key.size());\n+\n+    for (bool internal : {false, true}) {\n+        for (OutputType t : OUTPUT_TYPES) {\n+            auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, t, internal));\n+            if (IsCrypted()) {\n+                if (IsLocked()) {\n+                    throw std::runtime_error(std::string(__func__) + \": Wallet is locked, cannot setup new descriptors\");\n+                }\n+                if (!spk_manager->CheckDecryptionKey(vMasterKey) && !spk_manager->Encrypt(vMasterKey, nullptr)) {\n+                    throw std::runtime_error(std::string(__func__) + \": Could not encrypt new descriptors\");\n+                }\n+            }\n+            spk_manager->SetupDescriptorGeneration(master_key);\n+            uint256 id = spk_manager->GetID();\n+            m_spk_managers[id] = std::move(spk_manager);\n+            SetActiveScriptPubKeyMan(id, t, internal);\n+        }\n+    }\n+}\n+\n+void CWallet::SetActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal, bool memonly)\n+{\n+    WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto spk_man = m_spk_managers.at(id).get();\n+    spk_man->SetType(type, internal);\n+    spk_mans[type] = spk_man;\n+\n+    if (!memonly) {\n+        WalletBatch batch(*database);\n+        if (!batch.WriteActiveScriptPubKeyMan(static_cast<uint8_t>(type), id, internal)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing active ScriptPubKeyMan id failed\");\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+bool CWallet::IsLegacy() const\n+{\n+    if (m_internal_spk_managers.count(OutputType::LEGACY) == 0) {\n+        return false;\n+    }\n+    auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n+    return spk_man != nullptr;\n+}\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        return nullptr;\n+    }\n+\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const FlatSigningProvider& signing_provider, const std::string& label)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot add WalletDescriptor to a non-descriptor wallet\\n\");\n+        return nullptr;\n+    }\n+\n+    LOCK(cs_wallet);\n+    auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+\n+    // If we already have this descriptor, remove it from the maps but add the existing cache to desc\n+    auto old_spk_man = HasWalletDescriptor(desc);\n+    if (old_spk_man) {\n+        WalletLogPrintf(\"Update existing descriptor: %s\\n\", desc.descriptor->ToString());\n+\n+        {\n+            LOCK(old_spk_man->cs_desc_man);\n+            spk_manager->SetCache(old_spk_man->GetWalletDescriptor().cache);\n+        }\n+\n+        // Remove from maps of spkMans",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399292755",
      "id" : 399292755,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5Mjc1NQ==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 4491,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399292755",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399304091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399304091"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`:\r\n\r\ns/Active descriptor/Active descriptors/",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:28:04Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399304091",
      "id" : 399304091,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwNDA5MQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1511,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399304091",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399321705"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399321705"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`:\r\n\r\nneeds test",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:51:55Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399321705",
      "id" : 399321705,
      "line" : 1517,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMTcwNQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1517,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 60,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399321705",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399322132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399322132"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\nneeds test",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:52:31Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399322132",
      "id" : 399322132,
      "line" : 1522,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMjEzMg==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1522,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 65,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399322132",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399322281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399322281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\nneeds test",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:52:42Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399322281",
      "id" : 399322281,
      "line" : 1527,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMjI4MQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1527,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 70,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399322281",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399322814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399322814"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\nneeds test",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:53:28Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Check if all private keys are provided\n+        bool have_privkeys = true;\n+        for (const auto& entry : keys.pubkeys) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!keys.GetKey(key_id, key)) {\n+                have_privkeys = false;\n+            }\n+        }\n+\n+        // If private keys are enabled, abort if private keys are not provided\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !have_privkeys) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399322814",
      "id" : 399322814,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMjgxNA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1538,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399322814",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399324799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399324799"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\ncan you calculate `4` in code instead of magic?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:56:03Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor\n+        key1 = get_key(w0)\n+        key2 = get_key(w0)\n+        self.log.info(\"Should import a 1-of-2 bare multisig from descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"multi(1,\" + key1.pubkey + \",\" + key2.pubkey + \")\"),\n+                              \"timestamp\": \"now\"},\n+                             success=True)\n+        self.log.info(\"Should not treat individual keys from the imported bare multisig as watchonly\")\n+        test_address(w1,\n+                     key1.p2pkh_addr,\n+                     ismine=False)\n+\n+        # # Test ranged descriptors\n+        xpriv = \"tprv8ZgxMBicQKsPeuVhWwi6wuMQGfPKi9Li5GtX35jVNknACgqe3CY4g5xgkfDDJcmtF7o1QnxWDRYw4H5P26PXq7sbcUkEqeR4fg3Kxp2tigg\"\n+        xpub = \"tpubD6NzVbkrYhZ4YNXVQbNhMK1WqguFsUXceaVJKbmno2aZ3B6QfbMeraaYvnBSGpV3vxLyTTK9DYT1yoEck4XUScMzXoQ2U2oSmE2JyMedq3H\"\n+        addresses = [\"2N7yv4p8G8yEaPddJxY41kPihnWvs39qCMf\", \"2MsHxyb2JS3pAySeNUsJ7mNnurtpeenDzLA\"] # hdkeypath=m/0'/0'/0' and 1'\n+        addresses += [\"bcrt1qrd3n235cj2czsfmsuvqqpr3lu6lg0ju7scl8gn\", \"bcrt1qfqeppuvj0ww98r6qghmdkj70tv8qpchehegrg8\"] # wpkh subscripts corresponding to the above addresses\n+        desc = \"sh(wpkh(\" + xpub + \"/0'/0'/*'\" + \"))\"\n+        self.log.info(\"Ranged descriptor import should warn without a specified range\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              warnings=['Range not given, using default keypool range'])\n+\n+        # # Test importing of a ranged descriptor with xpriv\n+        self.log.info(\"Should not import a ranged descriptor that includes xpriv into a watch-only wallet\")\n+        desc = \"sh(wpkh(\" + xpriv + \"/0'/0'/*'\" + \"))\"\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                              \"timestamp\": \"now\",\n+                              \"range\": 1},\n+                             success=False,\n+                             error_code=-4,\n+                             error_message='Cannot import private keys to a wallet with private keys disabled')\n+        for address in addresses:\n+            test_address(w1,\n+                         address,\n+                         ismine=False,\n+                         solvable=False)\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": -1},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [-1, 10]},\n+                              success=False, error_code=-8, error_message='Range should be greater or equal than 0')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [(2 << 31 + 1) - 1000000, (2 << 31 + 1)]},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [2, 1]},\n+                              success=False, error_code=-8, error_message='Range specified as [begin,end] must not have begin after end')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n+                              success=False, error_code=-8, error_message='Range is too large')\n+\n+        # Make sure ranged imports import keys in order\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        self.log.info('Key ranges should be imported in order')\n+        xpub = \"tpubDAXcJ7s7ZwicqjprRaEWdPoHKrCS215qxGYxpusRLLmJuT69ZSicuGdSfyvyKpvUNYBW1s2U3NSrT6vrCYB9e6nZUEvrqnwXPF8ArTCRXMY\"\n+        addresses = [\n+            'bcrt1qtmp74ayg7p24uslctssvjm06q5phz4yrxucgnv', # m/0'/0'/0\n+            'bcrt1q8vprchan07gzagd5e6v9wd7azyucksq2xc76k8', # m/0'/0'/1\n+            'bcrt1qtuqdtha7zmqgcrr26n2rqxztv5y8rafjp9lulu', # m/0'/0'/2\n+            'bcrt1qau64272ymawq26t90md6an0ps99qkrse58m640', # m/0'/0'/3\n+            'bcrt1qsg97266hrh6cpmutqen8s4s962aryy77jp0fg0', # m/0'/0'/4\n+        ]\n+\n+        self.test_importdesc({'desc': descsum_create('wpkh([80002067/0h/0h]' + xpub + '/*)'),\n+                              'active': True,\n+                              'range' : [0, 2],\n+                              'timestamp': 'now'\n+                             },\n+                             success=True)\n+\n+        for i in range(0, 4):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399324799",
      "id" : 399324799,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyNDc5OQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 209,
      "original_position" : 209,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : null,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399324799",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399325819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399325819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\nwe should also check import didn't somehow add an internal spkm with change addresses",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:57:28Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor\n+        key1 = get_key(w0)\n+        key2 = get_key(w0)\n+        self.log.info(\"Should import a 1-of-2 bare multisig from descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"multi(1,\" + key1.pubkey + \",\" + key2.pubkey + \")\"),\n+                              \"timestamp\": \"now\"},\n+                             success=True)\n+        self.log.info(\"Should not treat individual keys from the imported bare multisig as watchonly\")\n+        test_address(w1,\n+                     key1.p2pkh_addr,\n+                     ismine=False)\n+\n+        # # Test ranged descriptors\n+        xpriv = \"tprv8ZgxMBicQKsPeuVhWwi6wuMQGfPKi9Li5GtX35jVNknACgqe3CY4g5xgkfDDJcmtF7o1QnxWDRYw4H5P26PXq7sbcUkEqeR4fg3Kxp2tigg\"\n+        xpub = \"tpubD6NzVbkrYhZ4YNXVQbNhMK1WqguFsUXceaVJKbmno2aZ3B6QfbMeraaYvnBSGpV3vxLyTTK9DYT1yoEck4XUScMzXoQ2U2oSmE2JyMedq3H\"\n+        addresses = [\"2N7yv4p8G8yEaPddJxY41kPihnWvs39qCMf\", \"2MsHxyb2JS3pAySeNUsJ7mNnurtpeenDzLA\"] # hdkeypath=m/0'/0'/0' and 1'\n+        addresses += [\"bcrt1qrd3n235cj2czsfmsuvqqpr3lu6lg0ju7scl8gn\", \"bcrt1qfqeppuvj0ww98r6qghmdkj70tv8qpchehegrg8\"] # wpkh subscripts corresponding to the above addresses\n+        desc = \"sh(wpkh(\" + xpub + \"/0'/0'/*'\" + \"))\"\n+        self.log.info(\"Ranged descriptor import should warn without a specified range\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              warnings=['Range not given, using default keypool range'])\n+\n+        # # Test importing of a ranged descriptor with xpriv\n+        self.log.info(\"Should not import a ranged descriptor that includes xpriv into a watch-only wallet\")\n+        desc = \"sh(wpkh(\" + xpriv + \"/0'/0'/*'\" + \"))\"\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                              \"timestamp\": \"now\",\n+                              \"range\": 1},\n+                             success=False,\n+                             error_code=-4,\n+                             error_message='Cannot import private keys to a wallet with private keys disabled')\n+        for address in addresses:\n+            test_address(w1,\n+                         address,\n+                         ismine=False,\n+                         solvable=False)\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": -1},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [-1, 10]},\n+                              success=False, error_code=-8, error_message='Range should be greater or equal than 0')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [(2 << 31 + 1) - 1000000, (2 << 31 + 1)]},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [2, 1]},\n+                              success=False, error_code=-8, error_message='Range specified as [begin,end] must not have begin after end')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n+                              success=False, error_code=-8, error_message='Range is too large')\n+\n+        # Make sure ranged imports import keys in order\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        self.log.info('Key ranges should be imported in order')\n+        xpub = \"tpubDAXcJ7s7ZwicqjprRaEWdPoHKrCS215qxGYxpusRLLmJuT69ZSicuGdSfyvyKpvUNYBW1s2U3NSrT6vrCYB9e6nZUEvrqnwXPF8ArTCRXMY\"\n+        addresses = [\n+            'bcrt1qtmp74ayg7p24uslctssvjm06q5phz4yrxucgnv', # m/0'/0'/0\n+            'bcrt1q8vprchan07gzagd5e6v9wd7azyucksq2xc76k8', # m/0'/0'/1\n+            'bcrt1qtuqdtha7zmqgcrr26n2rqxztv5y8rafjp9lulu', # m/0'/0'/2\n+            'bcrt1qau64272ymawq26t90md6an0ps99qkrse58m640', # m/0'/0'/3\n+            'bcrt1qsg97266hrh6cpmutqen8s4s962aryy77jp0fg0', # m/0'/0'/4\n+        ]\n+\n+        self.test_importdesc({'desc': descsum_create('wpkh([80002067/0h/0h]' + xpub + '/*)'),\n+                              'active': True,\n+                              'range' : [0, 2],\n+                              'timestamp': 'now'\n+                             },\n+                             success=True)\n+\n+        for i in range(0, 4):\n+            addr = w1.getnewaddress('', 'bech32')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399325819",
      "id" : 399325819,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyNTgxOQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 210,
      "original_position" : 210,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : null,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399325819",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399327270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399327270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\nshould test the fact that correct change addresses can be drawn now",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:59:28Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor\n+        key1 = get_key(w0)\n+        key2 = get_key(w0)\n+        self.log.info(\"Should import a 1-of-2 bare multisig from descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"multi(1,\" + key1.pubkey + \",\" + key2.pubkey + \")\"),\n+                              \"timestamp\": \"now\"},\n+                             success=True)\n+        self.log.info(\"Should not treat individual keys from the imported bare multisig as watchonly\")\n+        test_address(w1,\n+                     key1.p2pkh_addr,\n+                     ismine=False)\n+\n+        # # Test ranged descriptors\n+        xpriv = \"tprv8ZgxMBicQKsPeuVhWwi6wuMQGfPKi9Li5GtX35jVNknACgqe3CY4g5xgkfDDJcmtF7o1QnxWDRYw4H5P26PXq7sbcUkEqeR4fg3Kxp2tigg\"\n+        xpub = \"tpubD6NzVbkrYhZ4YNXVQbNhMK1WqguFsUXceaVJKbmno2aZ3B6QfbMeraaYvnBSGpV3vxLyTTK9DYT1yoEck4XUScMzXoQ2U2oSmE2JyMedq3H\"\n+        addresses = [\"2N7yv4p8G8yEaPddJxY41kPihnWvs39qCMf\", \"2MsHxyb2JS3pAySeNUsJ7mNnurtpeenDzLA\"] # hdkeypath=m/0'/0'/0' and 1'\n+        addresses += [\"bcrt1qrd3n235cj2czsfmsuvqqpr3lu6lg0ju7scl8gn\", \"bcrt1qfqeppuvj0ww98r6qghmdkj70tv8qpchehegrg8\"] # wpkh subscripts corresponding to the above addresses\n+        desc = \"sh(wpkh(\" + xpub + \"/0'/0'/*'\" + \"))\"\n+        self.log.info(\"Ranged descriptor import should warn without a specified range\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              warnings=['Range not given, using default keypool range'])\n+\n+        # # Test importing of a ranged descriptor with xpriv\n+        self.log.info(\"Should not import a ranged descriptor that includes xpriv into a watch-only wallet\")\n+        desc = \"sh(wpkh(\" + xpriv + \"/0'/0'/*'\" + \"))\"\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                              \"timestamp\": \"now\",\n+                              \"range\": 1},\n+                             success=False,\n+                             error_code=-4,\n+                             error_message='Cannot import private keys to a wallet with private keys disabled')\n+        for address in addresses:\n+            test_address(w1,\n+                         address,\n+                         ismine=False,\n+                         solvable=False)\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": -1},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [-1, 10]},\n+                              success=False, error_code=-8, error_message='Range should be greater or equal than 0')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [(2 << 31 + 1) - 1000000, (2 << 31 + 1)]},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [2, 1]},\n+                              success=False, error_code=-8, error_message='Range specified as [begin,end] must not have begin after end')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n+                              success=False, error_code=-8, error_message='Range is too large')\n+\n+        # Make sure ranged imports import keys in order\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        self.log.info('Key ranges should be imported in order')\n+        xpub = \"tpubDAXcJ7s7ZwicqjprRaEWdPoHKrCS215qxGYxpusRLLmJuT69ZSicuGdSfyvyKpvUNYBW1s2U3NSrT6vrCYB9e6nZUEvrqnwXPF8ArTCRXMY\"\n+        addresses = [\n+            'bcrt1qtmp74ayg7p24uslctssvjm06q5phz4yrxucgnv', # m/0'/0'/0\n+            'bcrt1q8vprchan07gzagd5e6v9wd7azyucksq2xc76k8', # m/0'/0'/1\n+            'bcrt1qtuqdtha7zmqgcrr26n2rqxztv5y8rafjp9lulu', # m/0'/0'/2\n+            'bcrt1qau64272ymawq26t90md6an0ps99qkrse58m640', # m/0'/0'/3\n+            'bcrt1qsg97266hrh6cpmutqen8s4s962aryy77jp0fg0', # m/0'/0'/4\n+        ]\n+\n+        self.test_importdesc({'desc': descsum_create('wpkh([80002067/0h/0h]' + xpub + '/*)'),\n+                              'active': True,\n+                              'range' : [0, 2],\n+                              'timestamp': 'now'\n+                             },\n+                             success=True)\n+\n+        for i in range(0, 4):\n+            addr = w1.getnewaddress('', 'bech32')\n+            assert_equal(addr, addresses[i])\n+\n+        # # Test importing a descriptor containing a WIF private key\n+        wif_priv = \"cTe1f5rdT8A8DFgVWTjyPwACsDPJM9ff4QngFxUixCSvvbg1x6sh\"\n+        address = \"2MuhcG52uHPknxDgmGPsV18jSHFBnnRgjPg\"\n+        desc = \"sh(wpkh(\" + wif_priv + \"))\"\n+        self.log.info(\"Should import a descriptor with a WIF private key as spendable\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              wallet=wpriv)\n+        test_address(wpriv,\n+                     address,\n+                     solvable=True,\n+                     ismine=True)\n+        txid = w0.sendtoaddress(address, 49.99995540)\n+        w0.generatetoaddress(6, w0.getnewaddress())\n+        self.sync_blocks()\n+        tx = wpriv.createrawtransaction([{\"txid\": txid, \"vout\": 0}], {w0.getnewaddress(): 49.999})\n+        signed_tx = wpriv.signrawtransactionwithwallet(tx)\n+        w1.sendrawtransaction(signed_tx['hex'])\n+\n+        # Make sure that we can use import and use multisig as addresses\n+        self.log.info('Test that multisigs can be imported, signed for, and getnewaddress\\'d')\n+        self.nodes[1].createwallet(wallet_name=\"wmulti_priv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wmulti_priv = self.nodes[1].get_wallet_rpc(\"wmulti_priv\")\n+        assert_equal(wmulti_priv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,tprv8ZgxMBicQKsPevADjDCWsa6DfhkVXicu8NQUzfibwX2MexVwW4tCec5mXdCW8kJwkzBRRmAay1KZya4WsehVvjTGVW6JLqiqd8DdZ4xSg52/84h/0h/0h/*,tprv8ZgxMBicQKsPdSNWUhDiwTScDr6JfkZuLshTRwzvZGnMSnGikV6jxpmdDkC3YRc4T3GD6Nvg9uv6hQg73RVv1EiTXDZwxVbsLugVHU8B1aq/84h/0h/0h/*,tprv8ZgxMBicQKsPeonDt8Ka2mrQmHa61hQ5FQCsvWBTpSNzBFgM58cV2EuXNAHF14VawVpznnme3SuTbA62sGriwWyKifJmXntfNeK7zeqMCj1/84h/0h/0h/*))#m2sr93jn\",\n+                            \"active\": True,\n+                            \"range\": 1000,\n+                            \"next_index\": 0,\n+                            \"timestamp\": \"now\"},\n+                            success=True,\n+                            wallet=wmulti_priv)\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,tprv8ZgxMBicQKsPevADjDCWsa6DfhkVXicu8NQUzfibwX2MexVwW4tCec5mXdCW8kJwkzBRRmAay1KZya4WsehVvjTGVW6JLqiqd8DdZ4xSg52/84h/1h/0h/*,tprv8ZgxMBicQKsPdSNWUhDiwTScDr6JfkZuLshTRwzvZGnMSnGikV6jxpmdDkC3YRc4T3GD6Nvg9uv6hQg73RVv1EiTXDZwxVbsLugVHU8B1aq/84h/1h/0h/*,tprv8ZgxMBicQKsPeonDt8Ka2mrQmHa61hQ5FQCsvWBTpSNzBFgM58cV2EuXNAHF14VawVpznnme3SuTbA62sGriwWyKifJmXntfNeK7zeqMCj1/84h/1h/0h/*))#q3sztvx5\",\n+                            \"active\": True,\n+                            \"internal\" : True,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399327270",
      "id" : 399327270,
      "line" : 319,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyNzI3MA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 319,
      "original_position" : 248,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 319,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399327270",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399327486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399327486"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\nshould test the fact that correct change addresses can be drawn now",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T14:59:45Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor\n+        key1 = get_key(w0)\n+        key2 = get_key(w0)\n+        self.log.info(\"Should import a 1-of-2 bare multisig from descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"multi(1,\" + key1.pubkey + \",\" + key2.pubkey + \")\"),\n+                              \"timestamp\": \"now\"},\n+                             success=True)\n+        self.log.info(\"Should not treat individual keys from the imported bare multisig as watchonly\")\n+        test_address(w1,\n+                     key1.p2pkh_addr,\n+                     ismine=False)\n+\n+        # # Test ranged descriptors\n+        xpriv = \"tprv8ZgxMBicQKsPeuVhWwi6wuMQGfPKi9Li5GtX35jVNknACgqe3CY4g5xgkfDDJcmtF7o1QnxWDRYw4H5P26PXq7sbcUkEqeR4fg3Kxp2tigg\"\n+        xpub = \"tpubD6NzVbkrYhZ4YNXVQbNhMK1WqguFsUXceaVJKbmno2aZ3B6QfbMeraaYvnBSGpV3vxLyTTK9DYT1yoEck4XUScMzXoQ2U2oSmE2JyMedq3H\"\n+        addresses = [\"2N7yv4p8G8yEaPddJxY41kPihnWvs39qCMf\", \"2MsHxyb2JS3pAySeNUsJ7mNnurtpeenDzLA\"] # hdkeypath=m/0'/0'/0' and 1'\n+        addresses += [\"bcrt1qrd3n235cj2czsfmsuvqqpr3lu6lg0ju7scl8gn\", \"bcrt1qfqeppuvj0ww98r6qghmdkj70tv8qpchehegrg8\"] # wpkh subscripts corresponding to the above addresses\n+        desc = \"sh(wpkh(\" + xpub + \"/0'/0'/*'\" + \"))\"\n+        self.log.info(\"Ranged descriptor import should warn without a specified range\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              warnings=['Range not given, using default keypool range'])\n+\n+        # # Test importing of a ranged descriptor with xpriv\n+        self.log.info(\"Should not import a ranged descriptor that includes xpriv into a watch-only wallet\")\n+        desc = \"sh(wpkh(\" + xpriv + \"/0'/0'/*'\" + \"))\"\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                              \"timestamp\": \"now\",\n+                              \"range\": 1},\n+                             success=False,\n+                             error_code=-4,\n+                             error_message='Cannot import private keys to a wallet with private keys disabled')\n+        for address in addresses:\n+            test_address(w1,\n+                         address,\n+                         ismine=False,\n+                         solvable=False)\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": -1},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [-1, 10]},\n+                              success=False, error_code=-8, error_message='Range should be greater or equal than 0')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [(2 << 31 + 1) - 1000000, (2 << 31 + 1)]},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [2, 1]},\n+                              success=False, error_code=-8, error_message='Range specified as [begin,end] must not have begin after end')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n+                              success=False, error_code=-8, error_message='Range is too large')\n+\n+        # Make sure ranged imports import keys in order\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        self.log.info('Key ranges should be imported in order')\n+        xpub = \"tpubDAXcJ7s7ZwicqjprRaEWdPoHKrCS215qxGYxpusRLLmJuT69ZSicuGdSfyvyKpvUNYBW1s2U3NSrT6vrCYB9e6nZUEvrqnwXPF8ArTCRXMY\"\n+        addresses = [\n+            'bcrt1qtmp74ayg7p24uslctssvjm06q5phz4yrxucgnv', # m/0'/0'/0\n+            'bcrt1q8vprchan07gzagd5e6v9wd7azyucksq2xc76k8', # m/0'/0'/1\n+            'bcrt1qtuqdtha7zmqgcrr26n2rqxztv5y8rafjp9lulu', # m/0'/0'/2\n+            'bcrt1qau64272ymawq26t90md6an0ps99qkrse58m640', # m/0'/0'/3\n+            'bcrt1qsg97266hrh6cpmutqen8s4s962aryy77jp0fg0', # m/0'/0'/4\n+        ]\n+\n+        self.test_importdesc({'desc': descsum_create('wpkh([80002067/0h/0h]' + xpub + '/*)'),\n+                              'active': True,\n+                              'range' : [0, 2],\n+                              'timestamp': 'now'\n+                             },\n+                             success=True)\n+\n+        for i in range(0, 4):\n+            addr = w1.getnewaddress('', 'bech32')\n+            assert_equal(addr, addresses[i])\n+\n+        # # Test importing a descriptor containing a WIF private key\n+        wif_priv = \"cTe1f5rdT8A8DFgVWTjyPwACsDPJM9ff4QngFxUixCSvvbg1x6sh\"\n+        address = \"2MuhcG52uHPknxDgmGPsV18jSHFBnnRgjPg\"\n+        desc = \"sh(wpkh(\" + wif_priv + \"))\"\n+        self.log.info(\"Should import a descriptor with a WIF private key as spendable\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              wallet=wpriv)\n+        test_address(wpriv,\n+                     address,\n+                     solvable=True,\n+                     ismine=True)\n+        txid = w0.sendtoaddress(address, 49.99995540)\n+        w0.generatetoaddress(6, w0.getnewaddress())\n+        self.sync_blocks()\n+        tx = wpriv.createrawtransaction([{\"txid\": txid, \"vout\": 0}], {w0.getnewaddress(): 49.999})\n+        signed_tx = wpriv.signrawtransactionwithwallet(tx)\n+        w1.sendrawtransaction(signed_tx['hex'])\n+\n+        # Make sure that we can use import and use multisig as addresses\n+        self.log.info('Test that multisigs can be imported, signed for, and getnewaddress\\'d')\n+        self.nodes[1].createwallet(wallet_name=\"wmulti_priv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wmulti_priv = self.nodes[1].get_wallet_rpc(\"wmulti_priv\")\n+        assert_equal(wmulti_priv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,tprv8ZgxMBicQKsPevADjDCWsa6DfhkVXicu8NQUzfibwX2MexVwW4tCec5mXdCW8kJwkzBRRmAay1KZya4WsehVvjTGVW6JLqiqd8DdZ4xSg52/84h/0h/0h/*,tprv8ZgxMBicQKsPdSNWUhDiwTScDr6JfkZuLshTRwzvZGnMSnGikV6jxpmdDkC3YRc4T3GD6Nvg9uv6hQg73RVv1EiTXDZwxVbsLugVHU8B1aq/84h/0h/0h/*,tprv8ZgxMBicQKsPeonDt8Ka2mrQmHa61hQ5FQCsvWBTpSNzBFgM58cV2EuXNAHF14VawVpznnme3SuTbA62sGriwWyKifJmXntfNeK7zeqMCj1/84h/0h/0h/*))#m2sr93jn\",\n+                            \"active\": True,\n+                            \"range\": 1000,\n+                            \"next_index\": 0,\n+                            \"timestamp\": \"now\"},\n+                            success=True,\n+                            wallet=wmulti_priv)\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,tprv8ZgxMBicQKsPevADjDCWsa6DfhkVXicu8NQUzfibwX2MexVwW4tCec5mXdCW8kJwkzBRRmAay1KZya4WsehVvjTGVW6JLqiqd8DdZ4xSg52/84h/1h/0h/*,tprv8ZgxMBicQKsPdSNWUhDiwTScDr6JfkZuLshTRwzvZGnMSnGikV6jxpmdDkC3YRc4T3GD6Nvg9uv6hQg73RVv1EiTXDZwxVbsLugVHU8B1aq/84h/1h/0h/*,tprv8ZgxMBicQKsPeonDt8Ka2mrQmHa61hQ5FQCsvWBTpSNzBFgM58cV2EuXNAHF14VawVpznnme3SuTbA62sGriwWyKifJmXntfNeK7zeqMCj1/84h/1h/0h/*))#q3sztvx5\",\n+                            \"active\": True,\n+                            \"internal\" : True,\n+                            \"range\": 1000,\n+                            \"next_index\": 0,\n+                            \"timestamp\": \"now\"},\n+                            success=True,\n+                            wallet=wmulti_priv)\n+\n+        addr = wmulti_priv.getnewaddress('', 'bech32')\n+        assert_equal(addr, 'bcrt1qdt0qy5p7dzhxzmegnn4ulzhard33s2809arjqgjndx87rv5vd0fq2czhy8') # Derived at m/84'/0'/0'/0\n+        txid = w0.sendtoaddress(addr, 10)\n+        self.nodes[0].generate(6)\n+        send_txid = wmulti_priv.sendtoaddress(w0.getnewaddress(), 8)\n+        decoded = wmulti_priv.decoderawtransaction(wmulti_priv.gettransaction(send_txid)['hex'])\n+        assert_equal(len(decoded['vin'][0]['txinwitness']), 4)\n+        self.nodes[0].generate(6)\n+        self.sync_all()\n+\n+        self.nodes[1].createwallet(wallet_name=\"wmulti_pub\", disable_private_keys=True, blank=True, descriptors=True)\n+        wmulti_pub = self.nodes[1].get_wallet_rpc(\"wmulti_pub\")\n+        assert_equal(wmulti_pub.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,[7b2d0242/84h/0h/0h]tpubDCJtdt5dgJpdhW4MtaVYDhG4T4tF6jcLR1PxL43q9pq1mxvXgMS9Mzw1HnXG15vxUGQJMMSqCQHMTy3F1eW5VkgVroWzchsPD5BUojrcWs8/*,[59b09cd6/84h/0h/0h]tpubDDBF2BTR6s8drwrfDei8WxtckGuSm1cyoKxYY1QaKSBFbHBYQArWhHPA6eJrzZej6nfHGLSURYSLHr7GuYch8aY5n61tGqgn8b4cXrMuoPH/*,[e81a0532/84h/0h/0h]tpubDCsWoW1kuQB9kG5MXewHqkbjPtqPueRnXju7uM2NK7y3JYb2ajAZ9EiuZXNNuE4661RAfriBWhL8UsnAPpk8zrKKnZw1Ug7X4oHgMdZiU4E/*))#tsry0s5e\",\n+                            \"active\": True,\n+                            \"range\": 1000,\n+                            \"next_index\": 0,\n+                            \"timestamp\": \"now\"},\n+                            success=True,\n+                            wallet=wmulti_pub)\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,[7b2d0242/84h/1h/0h]tpubDCXqdwWZcszwqYJSnZp8eARkxGJfHAk23KDxbztV4BbschfaTfYLTcSkSJ3TN64dRqwa1rnFUScsYormKkGqNbbPwkorQimVevXjxzUV9Gf/*,[59b09cd6/84h/1h/0h]tpubDCYfZY2ceyHzYzMMVPt9MNeiqtQ2T7Uyp9QSFwYXh8Vi9iJFYXcuphJaGXfF3jUQJi5Y3GMNXvM11gaL4txzZgNGK22BFAwMXynnzv4z2Jh/*,[e81a0532/84h/1h/0h]tpubDC6UGqnsQStngYuGD4MKsMy7eD1Yg9NTJfPdvjdG2JE5oZ7EsSL3WHg4Gsw2pR5K39ZwJ46M1wZayhedVdQtMGaUhq5S23PH6fnENK3V1sb/*))#c08a2rzv\",\n+                            \"active\": True,\n+                            \"internal\" : True,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399327486",
      "id" : 399327486,
      "line" : 353,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyNzQ4Ng==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 353,
      "original_position" : 278,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 353,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399327486",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399328411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399328411"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\nWe should be testing that `keypoolsize` ends up the expected size post-active-imports, and not before",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T15:00:58Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399328411",
      "id" : 399328411,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyODQxMQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 70,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 70,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399328411",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399330460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399330460"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\nshould test both ranged and non-ranged descriptors (non-active) don't replace \"keypool\"\r\n",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T15:03:35Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399330460",
      "id" : 399330460,
      "line" : 139,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzMDQ2MA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 139,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 139,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399330460",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399333787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399333787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "need to check they're actually returning the right type as well for all 3 cases (maybe this is caught in a `--descriptor` variant of tests)",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T15:08:15Z",
      "diff_hunk" : "@@ -0,0 +1,137 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descriptor wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error\n+)\n+\n+\n+class WalletDescriptorTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-keypool=100']]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        # Make a descriptor wallet\n+        self.log.info(\"Making a descriptor wallet\")\n+        self.nodes[0].createwallet(wallet_name=\"desc1\", descriptors=True)\n+        self.nodes[0].unloadwallet(\"\")\n+\n+        # A descriptor wallet should have 100 addresses * 3 types = 300 keys\n+        self.log.info(\"Checking wallet info\")\n+        wallet_info = self.nodes[0].getwalletinfo()\n+        assert_equal(wallet_info['keypoolsize'], 300)\n+        assert_equal(wallet_info['keypoolsize_hd_internal'], 300)\n+\n+        # Check that getnewaddress works",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399333787",
      "id" : 399333787,
      "line" : 36,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzMzc4Nw==",
      "original_commit_id" : "15b044fd16c2b26cb28497cf150820b25fafae93",
      "original_line" : 36,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/wallet_descriptor.py",
      "position" : 36,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399333787",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399336346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399336346"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`add importdescriptors RPC and tests for native descriptor wallets`\r\n\r\nWe should also test `sh(wsh())` and make sure that the various imports aren't \"displacing\" the other types. (I didn't see it might have missed it)",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T15:11:55Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399336346",
      "id" : 399336346,
      "line" : 149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzNjM0Ng==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 149,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 149,
      "pull_request_review_id" : 382872546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399336346",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399350834"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399350834"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note: not sure how this can be hit. Has to be a ranged descriptor that is \"null\"",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T15:32:18Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Check if all private keys are provided\n+        bool have_privkeys = true;\n+        for (const auto& entry : keys.pubkeys) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!keys.GetKey(key_id, key)) {\n+                have_privkeys = false;\n+            }\n+        }\n+\n+        // If private keys are enabled, abort if private keys are not provided\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !have_privkeys) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->HasWalletDescriptor(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399350834",
      "id" : 399350834,
      "line" : 1582,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1MDgzNA==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 1582,
      "original_position" : 113,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 125,
      "pull_request_review_id" : 382966268,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399350834",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399361504"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399361504"
         }
      },
      "author_association" : "MEMBER",
      "body" : "default is actually false in the code",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T15:47:38Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Check if all private keys are provided\n+        bool have_privkeys = true;\n+        for (const auto& entry : keys.pubkeys) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!keys.GetKey(key_id, key)) {\n+                have_privkeys = false;\n+            }\n+        }\n+\n+        // If private keys are enabled, abort if private keys are not provided\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !have_privkeys) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->HasWalletDescriptor(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp, during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exists but related transactions are still missing.\\n\",\n+                {\n+                    {\"requests\", RPCArg::Type::ARR, RPCArg::Optional::NO, \"Data to be imported\",\n+                        {\n+                            {\"\", RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, \"\",\n+                                {\n+                                    {\"desc\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Descriptor to import.\"},\n+                                    {\"active\", RPCArg::Type::BOOL, /* default */ \"true\", \"Set this descriptor to be the active descriptor for the corresponding output type/externality\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399361504",
      "id" : 399361504,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MTUwNA==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 1608,
      "original_position" : 150,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 382979745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399361504",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399363853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399363853"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this test needs to check default arguments like `active`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T15:50:48Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399363853",
      "id" : 399363853,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2Mzg1Mw==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 6,
      "pull_request_review_id" : 382982687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399363853",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399405664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399405664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`pk(xpub...)` should hit this. I'll try adding a test.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T16:53:19Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Check if all private keys are provided\n+        bool have_privkeys = true;\n+        for (const auto& entry : keys.pubkeys) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!keys.GetKey(key_id, key)) {\n+                have_privkeys = false;\n+            }\n+        }\n+\n+        // If private keys are enabled, abort if private keys are not provided\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !have_privkeys) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->HasWalletDescriptor(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399405664",
      "id" : 399405664,
      "in_reply_to_id" : 399350834,
      "line" : 1582,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQwNTY2NA==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 1582,
      "original_position" : 113,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 125,
      "pull_request_review_id" : 383035261,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399405664",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399434828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399434828"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What happens if this fails? Would be good to have a test for a malformed descriptor.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T17:40:47Z",
      "diff_hunk" : "@@ -86,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end). This never changes.\n+    int32_t range_end; // Item after the last; end of range, exclusive, i.e. [range_start, range_end). This will increment with each TopUp()\n+    int32_t next_index; // Position of the next item to generate\n+    DescriptorCache cache;\n+\n+    ADD_SERIALIZE_METHODS;\n+\n+    template <typename Stream, typename Operation>\n+    inline void SerializationOp(Stream& s, Operation ser_action) {\n+        if (ser_action.ForRead()) {\n+            std::string desc;\n+            std::string error;\n+            READWRITE(desc);\n+            FlatSigningProvider keys;\n+            descriptor = Parse(desc, keys, error, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399434828",
      "id" : 399434828,
      "line" : 110,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQzNDgyOA==",
      "original_commit_id" : "f0a15b8aa1f2cc5c91162b747170faa452944d9b",
      "original_line" : 110,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : 42,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399434828",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399436260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399436260"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm still not very excited about string serialisation, because it sets descriptors in stone. On the other hand, we can also write a straight-forward upgrade script, since descriptors are not encrypted.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T17:43:11Z",
      "diff_hunk" : "@@ -86,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end). This never changes.\n+    int32_t range_end; // Item after the last; end of range, exclusive, i.e. [range_start, range_end). This will increment with each TopUp()\n+    int32_t next_index; // Position of the next item to generate\n+    DescriptorCache cache;\n+\n+    ADD_SERIALIZE_METHODS;\n+\n+    template <typename Stream, typename Operation>\n+    inline void SerializationOp(Stream& s, Operation ser_action) {\n+        if (ser_action.ForRead()) {\n+            std::string desc;\n+            std::string error;\n+            READWRITE(desc);\n+            FlatSigningProvider keys;\n+            descriptor = Parse(desc, keys, error, true);\n+        } else {\n+            READWRITE(descriptor->ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399436260",
      "id" : 399436260,
      "line" : 115,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQzNjI2MA==",
      "original_commit_id" : "f0a15b8aa1f2cc5c91162b747170faa452944d9b",
      "original_line" : 115,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : 47,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399436260",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399447890"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399447890"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It would be nice to avoid this `ACTIVE[INTERNAL/EXTERNAL]SPK` record altogether and just add two fields to  `WALLETDESCRIPTOR`. I vaguely recall there was a problem with loading order, as the reason we have separate records?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:02:45Z",
      "diff_hunk" : "@@ -179,6 +182,15 @@ bool WalletBatch::WriteMinVersion(int nVersion)\n     return WriteIC(DBKeys::MINVERSION, nVersion);\n }\n \n+bool WalletBatch::WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399447890",
      "id" : 399447890,
      "in_reply_to_id" : 395865796,
      "line" : 188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0Nzg5MA==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 188,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 24,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399447890",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399449698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399449698"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`memonly` could use some documentation (IIUC it depends on if you're loading an existing wallet, or inserting a new descriptor; it's not some test suite hack)",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:06:10Z",
      "diff_hunk" : "@@ -1214,6 +1214,12 @@ class CWallet final : public WalletStorage, private interfaces::Chain::Notificat\n \n     //! Connect the signals from ScriptPubKeyMans to the signals in CWallet\n     void ConnectScriptPubKeyManNotifiers();\n+\n+    //! Instantiate a descriptor ScriptPubKeyMan from the WalletDescriptor and load it\n+    void LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor& desc);\n+\n+    //! Sets the active ScriptPubKeyMan for the specified type and internal",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399449698",
      "id" : 399449698,
      "line" : 1244,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0OTY5OA==",
      "original_commit_id" : "ed75ce9649ce7a26146b45bb85584f5522945a3d",
      "original_line" : 1244,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 36,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399449698",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399459055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399459055"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: can you add `index` to the log message?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:22:49Z",
      "diff_hunk" : "@@ -1539,6 +1539,17 @@ bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n \n void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item, mark all keypool items up to this item as used\\n\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399459055",
      "id" : 399459055,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1OTA1NQ==",
      "original_commit_id" : "68cef400b94fbe2ad592ccdf54fb6dcf9e78389e",
      "original_line" : 1546,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399459055",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399459919"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399459919"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: you do an early return here\r\n\r\n@instagibbs IIUC earlier behaviour can still be mimicked with a `combo()` descriptor.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:24:18Z",
      "diff_hunk" : "@@ -1539,6 +1539,17 @@ bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n \n void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399459919",
      "id" : 399459919,
      "in_reply_to_id" : 395872979,
      "line" : 1736,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1OTkxOQ==",
      "original_commit_id" : "71f9ce5e93b2a66fcd76d9d7467a83470e030c93",
      "original_line" : 1736,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 266,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399459919",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399462420"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399462420"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You may have to change the wallet to use `|=` instead of `&=`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:28:58Z",
      "diff_hunk" : "@@ -1554,7 +1554,8 @@ void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n \n bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399462420",
      "id" : 399462420,
      "line" : 1851,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2MjQyMA==",
      "original_commit_id" : "fbd356690fab88c7fc10b300b71ef13d5ab14032",
      "original_line" : 1851,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 381,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399462420",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399464603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399464603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're already using this function in ed75ce9649ce7a26146b45bb85584f5522945a3d, so may want to move this commit up (though it does compile).",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:33:01Z",
      "diff_hunk" : "@@ -1627,4 +1627,8 @@ uint256 DescriptorScriptPubKeyMan::GetID() const\n     return id;\n }\n \n-void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399464603",
      "id" : 399464603,
      "line" : 2080,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2NDYwMw==",
      "original_commit_id" : "0708467ad1243fdca15f7498fb94a2eadcf3f4d8",
      "original_line" : 2080,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 610,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399464603",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399466760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399466760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should check if this fails.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:37:10Z",
      "diff_hunk" : "@@ -1632,3 +1632,18 @@ void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)\n     this->m_address_type = type;\n     this->m_internal = internal;\n }\n+\n+void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n+{\n+    LOCK(cs_desc_man);\n+    m_wallet_descriptor.cache = cache;\n+    for (int32_t i = m_wallet_descriptor.range_start; i < m_wallet_descriptor.range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399466760",
      "id" : 399466760,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2Njc2MA==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 1643,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399466760",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399468023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399468023"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do we want to panic if `m_map_script_pub_keys[script]` exists and `!= i`?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:39:35Z",
      "diff_hunk" : "@@ -1632,3 +1632,18 @@ void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)\n     this->m_address_type = type;\n     this->m_internal = internal;\n }\n+\n+void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n+{\n+    LOCK(cs_desc_man);\n+    m_wallet_descriptor.cache = cache;\n+    for (int32_t i = m_wallet_descriptor.range_start; i < m_wallet_descriptor.range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys);\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399468023",
      "id" : 399468023,
      "line" : 2101,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2ODAyMw==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 2101,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 631,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399468023",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399472037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399472037"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not a fan. Let's just have `WALLETDESCRIPTORCACHEPARENTXPUB` and `WALLETDESCRIPTORCACHEDERIVEDXPUB`, and maybe some underscores :-)",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:47:07Z",
      "diff_hunk" : "@@ -434,7 +436,38 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssKey >> id;\n             WalletDescriptor desc;\n             ssValue >> desc;\n+            if (wss.m_descriptor_caches.count(id) == 0) {\n+                wss.m_descriptor_caches[id] = DescriptorCache();\n+            }\n             pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\n+        } else if (strType == DBKeys::WALLETDESCRIPTORCACHE) {\n+            bool parent = true;\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            uint32_t der_index;\n+            ssKey >> desc_id;\n+            ssKey >> key_exp_index;\n+\n+            // if the der_index exists, it's a derived xpub\n+            try",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399472037",
      "id" : 399472037,
      "line" : 494,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ3MjAzNw==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 494,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 119,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399472037",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399473488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399473488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do we want to check the cache for gaps and emit a warning?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T18:49:36Z",
      "diff_hunk" : "@@ -536,6 +569,13 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, /* internal */ true, /* memonly */ true);\n     }\n \n+    // Set the descriptor caches\n+    for (auto desc_cache_pair : wss.m_descriptor_caches) {\n+        auto spk_man = pwallet->GetScriptPubKeyMan(desc_cache_pair.first);\n+        assert(spk_man);\n+        ((DescriptorScriptPubKeyMan*)spk_man)->SetCache(desc_cache_pair.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399473488",
      "id" : 399473488,
      "line" : 670,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ3MzQ4OA==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 670,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 209,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399473488",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399480181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399480181"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't we allow `CanGetAddresses` from an unranged descriptor once?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T19:02:38Z",
      "diff_hunk" : "@@ -1496,3 +1496,616 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item, mark all keypool items up to this item as used\\n\", __func__);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399480181",
      "id" : 399480181,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4MDE4MQ==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 1858,
      "original_position" : 383,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399480181",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399487630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399487630"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`for (const auto& mi : m_map_crypted_keys) {` and then below `mi.second.first;` compiles too, though maybe I missed something.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T19:17:07Z",
      "diff_hunk" : "@@ -1552,12 +1552,61 @@ isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n \n bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n {\n-    return false;\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399487630",
      "id" : 399487630,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4NzYzMA==",
      "original_commit_id" : "8ae9bf12395b558bf53cc0b8d2f4056424908585",
      "original_line" : 1558,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399487630",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399489479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399489479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: maybe swap eb9c41e9240fe01f6404cf23abe1fc35ca146586 and ee03d46178a3e8d511c33f734892820b36ed7a1a.\r\n\r\nA test would be nice.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T19:20:26Z",
      "diff_hunk" : "@@ -1616,6 +1616,13 @@ bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bo\n \n void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n {\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399489479",
      "id" : 399489479,
      "line" : 1621,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4OTQ3OQ==",
      "original_commit_id" : "ee03d46178a3e8d511c33f734892820b36ed7a1a",
      "original_line" : 1621,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 151,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399489479",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399490475"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399490475"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This commit message in 50c3b4eee31e095a5080fcb4109cb5d8f7bfbbe7 speaks of `GetSolvingProvider`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T19:22:27Z",
      "diff_hunk" : "@@ -1878,9 +1878,34 @@ int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n     return m_wallet_descriptor.creation_time;\n }\n \n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399490475",
      "id" : 399490475,
      "line" : 1897,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MDQ3NQ==",
      "original_commit_id" : "50c3b4eee31e095a5080fcb4109cb5d8f7bfbbe7",
      "original_line" : 1897,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 427,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399490475",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399492040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399492040"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`ExpandPrivate()` is a `void`, but it uses `GetPrivKey` internally and just ignores failure. Might be worth making  `ExpandPrivate()` a `bool` and adding an `assert` here.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T19:25:33Z",
      "diff_hunk" : "@@ -1878,9 +1878,34 @@ int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n     return m_wallet_descriptor.creation_time;\n }\n \n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!m_wallet_descriptor.descriptor->ExpandFromCache(index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) return nullptr;\n+\n+    if (include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        m_wallet_descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399492040",
      "id" : 399492040,
      "line" : 1937,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MjA0MA==",
      "original_commit_id" : "50c3b4eee31e095a5080fcb4109cb5d8f7bfbbe7",
      "original_line" : 1937,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 467,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399492040",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399493975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399493975"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f5204ed3fe1b2a059e35e54248d38eac88c629e0 could be split between GUI and RPC.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T19:29:08Z",
      "diff_hunk" : "@@ -60,3 +60,8 @@ bool CreateWalletDialog::isMakeBlankWalletChecked() const\n {\n     return ui->blank_wallet_checkbox->isChecked();\n }\n+\n+bool CreateWalletDialog::isDescriptorWalletChecked() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399493975",
      "id" : 399493975,
      "line" : 64,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5Mzk3NQ==",
      "original_commit_id" : "f5204ed3fe1b2a059e35e54248d38eac88c629e0",
      "original_line" : 64,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/qt/createwalletdialog.cpp",
      "position" : 5,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399493975",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399494992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399494992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f5204ed3fe1b2a059e35e54248d38eac88c629e0 moves `WriteActiveScriptPubKeyMan` a few lines up for some reason.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T19:31:13Z",
      "diff_hunk" : "@@ -252,13 +252,13 @@ class WalletBatch\n     bool WriteDescriptorDerivedCache(const uint256& desc_id, uint32_t key_exp_index, uint32_t der_index, const CExtPubKey& xpub);\n     bool WriteDescriptorParentCache(const uint256& desc_id, uint32_t key_exp_index, const CExtPubKey& xpub);\n \n+    bool WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bool internal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399494992",
      "id" : 399494992,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5NDk5Mg==",
      "original_commit_id" : "f5204ed3fe1b2a059e35e54248d38eac88c629e0",
      "original_line" : 255,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399494992",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399496245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399496245"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Descriptors don't contain private keys, so maybe make it more clear that we're generating a new seed, and thus need new descriptors for that.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T19:33:46Z",
      "diff_hunk" : "@@ -585,8 +585,11 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         Lock();\n         Unlock(strWalletPassphrase);\n \n-        // if we are using HD, replace the HD seed with a new one\n-        if (auto spk_man = GetLegacyScriptPubKeyMan()) {\n+        // If we are using descriptors, make new descriptors",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399496245",
      "id" : 399496245,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5NjI0NQ==",
      "original_commit_id" : "2de265c2b60c4348899aa09783a4cd3be958fb81",
      "original_line" : 588,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399496245",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399499505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399499505"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`test_address` or another function could also test `getnewaddress` (in particular for an unranged descriptor, which imo should work exactly once)",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T19:40:28Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399499505",
      "id" : 399499505,
      "line" : 15,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5OTUwNQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 15,
      "pull_request_review_id" : 383071782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399499505",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399539375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399539375"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How so?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:10:04Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399539375",
      "id" : 399539375,
      "in_reply_to_id" : 399363853,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzOTM3NQ==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 6,
      "pull_request_review_id" : 383201525,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399539375",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399539940"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399539940"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:11:37Z",
      "diff_hunk" : "@@ -1226,6 +1226,12 @@ class CWallet final : public WalletStorage, private interfaces::Chain::Notificat\n \n     //! Create new DescriptorScriptPubKeyMans and add them to the wallet\n     void SetupDescriptorScriptPubKeyMans();\n+\n+    //! Check if the wallet already has a descriptor\n+    DescriptorScriptPubKeyMan* HasWalletDescriptor(const WalletDescriptor& desc) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399539940",
      "id" : 399539940,
      "in_reply_to_id" : 399276875,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzOTk0MA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1231,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 383202260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399539940",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399539974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399539974"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:11:43Z",
      "diff_hunk" : "@@ -4447,3 +4448,91 @@ bool CWallet::IsLegacy() const\n     auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n     return spk_man != nullptr;\n }\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399539974",
      "id" : 399539974,
      "in_reply_to_id" : 399280484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzOTk3NA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 4454,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 383202314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399539974",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540013"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:11:48Z",
      "diff_hunk" : "@@ -4447,3 +4448,91 @@ bool CWallet::IsLegacy() const\n     auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n     return spk_man != nullptr;\n }\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        return nullptr;\n+    }\n+\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const FlatSigningProvider& signing_provider, const std::string& label)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot add WalletDescriptor to a non-descriptor wallet\\n\");\n+        return nullptr;\n+    }\n+\n+    LOCK(cs_wallet);\n+    auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540013",
      "id" : 399540013,
      "in_reply_to_id" : 399281845,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDAxMw==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 4477,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 383202369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540013",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540059"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:11:54Z",
      "diff_hunk" : "@@ -4366,3 +4385,156 @@ void CWallet::ConnectScriptPubKeyManNotifiers()\n         spk_man->NotifyCanGetAddressesChanged.connect(NotifyCanGetAddressesChanged);\n     }\n }\n+\n+void CWallet::LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor& desc)\n+{\n+    auto spk_manager = std::unique_ptr<ScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+    m_spk_managers[id] = std::move(spk_manager);\n+}\n+\n+void CWallet::SetupDescriptorScriptPubKeyMans()\n+{\n+    AssertLockHeld(cs_wallet);\n+\n+    // Make a seed\n+    CKey seed_key;\n+    seed_key.MakeNewKey(true);\n+    CPubKey seed = seed_key.GetPubKey();\n+    assert(seed_key.VerifyPubKey(seed));\n+\n+    // Get the extended key\n+    CExtKey master_key;\n+    master_key.SetSeed(seed_key.begin(), seed_key.size());\n+\n+    for (bool internal : {false, true}) {\n+        for (OutputType t : OUTPUT_TYPES) {\n+            auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, t, internal));\n+            if (IsCrypted()) {\n+                if (IsLocked()) {\n+                    throw std::runtime_error(std::string(__func__) + \": Wallet is locked, cannot setup new descriptors\");\n+                }\n+                if (!spk_manager->CheckDecryptionKey(vMasterKey) && !spk_manager->Encrypt(vMasterKey, nullptr)) {\n+                    throw std::runtime_error(std::string(__func__) + \": Could not encrypt new descriptors\");\n+                }\n+            }\n+            spk_manager->SetupDescriptorGeneration(master_key);\n+            uint256 id = spk_manager->GetID();\n+            m_spk_managers[id] = std::move(spk_manager);\n+            SetActiveScriptPubKeyMan(id, t, internal);\n+        }\n+    }\n+}\n+\n+void CWallet::SetActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal, bool memonly)\n+{\n+    WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto spk_man = m_spk_managers.at(id).get();\n+    spk_man->SetType(type, internal);\n+    spk_mans[type] = spk_man;\n+\n+    if (!memonly) {\n+        WalletBatch batch(*database);\n+        if (!batch.WriteActiveScriptPubKeyMan(static_cast<uint8_t>(type), id, internal)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing active ScriptPubKeyMan id failed\");\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+bool CWallet::IsLegacy() const\n+{\n+    if (m_internal_spk_managers.count(OutputType::LEGACY) == 0) {\n+        return false;\n+    }\n+    auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n+    return spk_man != nullptr;\n+}\n+\n+DescriptorScriptPubKeyMan* CWallet::HasWalletDescriptor(const WalletDescriptor& desc) const\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        return nullptr;\n+    }\n+\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const FlatSigningProvider& signing_provider, const std::string& label)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot add WalletDescriptor to a non-descriptor wallet\\n\");\n+        return nullptr;\n+    }\n+\n+    LOCK(cs_wallet);\n+    auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+\n+    // If we already have this descriptor, remove it from the maps but add the existing cache to desc\n+    auto old_spk_man = HasWalletDescriptor(desc);\n+    if (old_spk_man) {\n+        WalletLogPrintf(\"Update existing descriptor: %s\\n\", desc.descriptor->ToString());\n+\n+        {\n+            LOCK(old_spk_man->cs_desc_man);\n+            spk_manager->SetCache(old_spk_man->GetWalletDescriptor().cache);\n+        }\n+\n+        // Remove from maps of spkMans",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540059",
      "id" : 399540059,
      "in_reply_to_id" : 399292755,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDA1OQ==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 4491,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 383202432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540059",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:12:17Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540211",
      "id" : 399540211,
      "in_reply_to_id" : 399304091,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDIxMQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1511,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 383202649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540211",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540374"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:12:40Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540374",
      "id" : 399540374,
      "in_reply_to_id" : 399321705,
      "line" : 1517,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDM3NA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1517,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 60,
      "pull_request_review_id" : 383202841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540374",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540401"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:12:45Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540401",
      "id" : 399540401,
      "in_reply_to_id" : 399322132,
      "line" : 1522,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDQwMQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1522,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 65,
      "pull_request_review_id" : 383202882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540401",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540439"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:12:49Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540439",
      "id" : 399540439,
      "in_reply_to_id" : 399322281,
      "line" : 1527,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDQzOQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1527,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 70,
      "pull_request_review_id" : 383202915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540439",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:12:54Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Check if all private keys are provided\n+        bool have_privkeys = true;\n+        for (const auto& entry : keys.pubkeys) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!keys.GetKey(key_id, key)) {\n+                have_privkeys = false;\n+            }\n+        }\n+\n+        // If private keys are enabled, abort if private keys are not provided\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !have_privkeys) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540468",
      "id" : 399540468,
      "in_reply_to_id" : 399322814,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDQ2OA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 1538,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 383202950,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540468",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Iterated over `addresses` instead.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:13:10Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor\n+        key1 = get_key(w0)\n+        key2 = get_key(w0)\n+        self.log.info(\"Should import a 1-of-2 bare multisig from descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"multi(1,\" + key1.pubkey + \",\" + key2.pubkey + \")\"),\n+                              \"timestamp\": \"now\"},\n+                             success=True)\n+        self.log.info(\"Should not treat individual keys from the imported bare multisig as watchonly\")\n+        test_address(w1,\n+                     key1.p2pkh_addr,\n+                     ismine=False)\n+\n+        # # Test ranged descriptors\n+        xpriv = \"tprv8ZgxMBicQKsPeuVhWwi6wuMQGfPKi9Li5GtX35jVNknACgqe3CY4g5xgkfDDJcmtF7o1QnxWDRYw4H5P26PXq7sbcUkEqeR4fg3Kxp2tigg\"\n+        xpub = \"tpubD6NzVbkrYhZ4YNXVQbNhMK1WqguFsUXceaVJKbmno2aZ3B6QfbMeraaYvnBSGpV3vxLyTTK9DYT1yoEck4XUScMzXoQ2U2oSmE2JyMedq3H\"\n+        addresses = [\"2N7yv4p8G8yEaPddJxY41kPihnWvs39qCMf\", \"2MsHxyb2JS3pAySeNUsJ7mNnurtpeenDzLA\"] # hdkeypath=m/0'/0'/0' and 1'\n+        addresses += [\"bcrt1qrd3n235cj2czsfmsuvqqpr3lu6lg0ju7scl8gn\", \"bcrt1qfqeppuvj0ww98r6qghmdkj70tv8qpchehegrg8\"] # wpkh subscripts corresponding to the above addresses\n+        desc = \"sh(wpkh(\" + xpub + \"/0'/0'/*'\" + \"))\"\n+        self.log.info(\"Ranged descriptor import should warn without a specified range\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              warnings=['Range not given, using default keypool range'])\n+\n+        # # Test importing of a ranged descriptor with xpriv\n+        self.log.info(\"Should not import a ranged descriptor that includes xpriv into a watch-only wallet\")\n+        desc = \"sh(wpkh(\" + xpriv + \"/0'/0'/*'\" + \"))\"\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                              \"timestamp\": \"now\",\n+                              \"range\": 1},\n+                             success=False,\n+                             error_code=-4,\n+                             error_message='Cannot import private keys to a wallet with private keys disabled')\n+        for address in addresses:\n+            test_address(w1,\n+                         address,\n+                         ismine=False,\n+                         solvable=False)\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": -1},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [-1, 10]},\n+                              success=False, error_code=-8, error_message='Range should be greater or equal than 0')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [(2 << 31 + 1) - 1000000, (2 << 31 + 1)]},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [2, 1]},\n+                              success=False, error_code=-8, error_message='Range specified as [begin,end] must not have begin after end')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n+                              success=False, error_code=-8, error_message='Range is too large')\n+\n+        # Make sure ranged imports import keys in order\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        self.log.info('Key ranges should be imported in order')\n+        xpub = \"tpubDAXcJ7s7ZwicqjprRaEWdPoHKrCS215qxGYxpusRLLmJuT69ZSicuGdSfyvyKpvUNYBW1s2U3NSrT6vrCYB9e6nZUEvrqnwXPF8ArTCRXMY\"\n+        addresses = [\n+            'bcrt1qtmp74ayg7p24uslctssvjm06q5phz4yrxucgnv', # m/0'/0'/0\n+            'bcrt1q8vprchan07gzagd5e6v9wd7azyucksq2xc76k8', # m/0'/0'/1\n+            'bcrt1qtuqdtha7zmqgcrr26n2rqxztv5y8rafjp9lulu', # m/0'/0'/2\n+            'bcrt1qau64272ymawq26t90md6an0ps99qkrse58m640', # m/0'/0'/3\n+            'bcrt1qsg97266hrh6cpmutqen8s4s962aryy77jp0fg0', # m/0'/0'/4\n+        ]\n+\n+        self.test_importdesc({'desc': descsum_create('wpkh([80002067/0h/0h]' + xpub + '/*)'),\n+                              'active': True,\n+                              'range' : [0, 2],\n+                              'timestamp': 'now'\n+                             },\n+                             success=True)\n+\n+        for i in range(0, 4):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540593",
      "id" : 399540593,
      "in_reply_to_id" : 399324799,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDU5Mw==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 209,
      "original_position" : 209,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : null,
      "pull_request_review_id" : 383203099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540593",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:13:18Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor\n+        key1 = get_key(w0)\n+        key2 = get_key(w0)\n+        self.log.info(\"Should import a 1-of-2 bare multisig from descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"multi(1,\" + key1.pubkey + \",\" + key2.pubkey + \")\"),\n+                              \"timestamp\": \"now\"},\n+                             success=True)\n+        self.log.info(\"Should not treat individual keys from the imported bare multisig as watchonly\")\n+        test_address(w1,\n+                     key1.p2pkh_addr,\n+                     ismine=False)\n+\n+        # # Test ranged descriptors\n+        xpriv = \"tprv8ZgxMBicQKsPeuVhWwi6wuMQGfPKi9Li5GtX35jVNknACgqe3CY4g5xgkfDDJcmtF7o1QnxWDRYw4H5P26PXq7sbcUkEqeR4fg3Kxp2tigg\"\n+        xpub = \"tpubD6NzVbkrYhZ4YNXVQbNhMK1WqguFsUXceaVJKbmno2aZ3B6QfbMeraaYvnBSGpV3vxLyTTK9DYT1yoEck4XUScMzXoQ2U2oSmE2JyMedq3H\"\n+        addresses = [\"2N7yv4p8G8yEaPddJxY41kPihnWvs39qCMf\", \"2MsHxyb2JS3pAySeNUsJ7mNnurtpeenDzLA\"] # hdkeypath=m/0'/0'/0' and 1'\n+        addresses += [\"bcrt1qrd3n235cj2czsfmsuvqqpr3lu6lg0ju7scl8gn\", \"bcrt1qfqeppuvj0ww98r6qghmdkj70tv8qpchehegrg8\"] # wpkh subscripts corresponding to the above addresses\n+        desc = \"sh(wpkh(\" + xpub + \"/0'/0'/*'\" + \"))\"\n+        self.log.info(\"Ranged descriptor import should warn without a specified range\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              warnings=['Range not given, using default keypool range'])\n+\n+        # # Test importing of a ranged descriptor with xpriv\n+        self.log.info(\"Should not import a ranged descriptor that includes xpriv into a watch-only wallet\")\n+        desc = \"sh(wpkh(\" + xpriv + \"/0'/0'/*'\" + \"))\"\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                              \"timestamp\": \"now\",\n+                              \"range\": 1},\n+                             success=False,\n+                             error_code=-4,\n+                             error_message='Cannot import private keys to a wallet with private keys disabled')\n+        for address in addresses:\n+            test_address(w1,\n+                         address,\n+                         ismine=False,\n+                         solvable=False)\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": -1},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [-1, 10]},\n+                              success=False, error_code=-8, error_message='Range should be greater or equal than 0')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [(2 << 31 + 1) - 1000000, (2 << 31 + 1)]},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [2, 1]},\n+                              success=False, error_code=-8, error_message='Range specified as [begin,end] must not have begin after end')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n+                              success=False, error_code=-8, error_message='Range is too large')\n+\n+        # Make sure ranged imports import keys in order\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        self.log.info('Key ranges should be imported in order')\n+        xpub = \"tpubDAXcJ7s7ZwicqjprRaEWdPoHKrCS215qxGYxpusRLLmJuT69ZSicuGdSfyvyKpvUNYBW1s2U3NSrT6vrCYB9e6nZUEvrqnwXPF8ArTCRXMY\"\n+        addresses = [\n+            'bcrt1qtmp74ayg7p24uslctssvjm06q5phz4yrxucgnv', # m/0'/0'/0\n+            'bcrt1q8vprchan07gzagd5e6v9wd7azyucksq2xc76k8', # m/0'/0'/1\n+            'bcrt1qtuqdtha7zmqgcrr26n2rqxztv5y8rafjp9lulu', # m/0'/0'/2\n+            'bcrt1qau64272ymawq26t90md6an0ps99qkrse58m640', # m/0'/0'/3\n+            'bcrt1qsg97266hrh6cpmutqen8s4s962aryy77jp0fg0', # m/0'/0'/4\n+        ]\n+\n+        self.test_importdesc({'desc': descsum_create('wpkh([80002067/0h/0h]' + xpub + '/*)'),\n+                              'active': True,\n+                              'range' : [0, 2],\n+                              'timestamp': 'now'\n+                             },\n+                             success=True)\n+\n+        for i in range(0, 4):\n+            addr = w1.getnewaddress('', 'bech32')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540638",
      "id" : 399540638,
      "in_reply_to_id" : 399325819,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDYzOA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 210,
      "original_position" : 210,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : null,
      "pull_request_review_id" : 383203160,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540638",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540670"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:13:24Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor\n+        key1 = get_key(w0)\n+        key2 = get_key(w0)\n+        self.log.info(\"Should import a 1-of-2 bare multisig from descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"multi(1,\" + key1.pubkey + \",\" + key2.pubkey + \")\"),\n+                              \"timestamp\": \"now\"},\n+                             success=True)\n+        self.log.info(\"Should not treat individual keys from the imported bare multisig as watchonly\")\n+        test_address(w1,\n+                     key1.p2pkh_addr,\n+                     ismine=False)\n+\n+        # # Test ranged descriptors\n+        xpriv = \"tprv8ZgxMBicQKsPeuVhWwi6wuMQGfPKi9Li5GtX35jVNknACgqe3CY4g5xgkfDDJcmtF7o1QnxWDRYw4H5P26PXq7sbcUkEqeR4fg3Kxp2tigg\"\n+        xpub = \"tpubD6NzVbkrYhZ4YNXVQbNhMK1WqguFsUXceaVJKbmno2aZ3B6QfbMeraaYvnBSGpV3vxLyTTK9DYT1yoEck4XUScMzXoQ2U2oSmE2JyMedq3H\"\n+        addresses = [\"2N7yv4p8G8yEaPddJxY41kPihnWvs39qCMf\", \"2MsHxyb2JS3pAySeNUsJ7mNnurtpeenDzLA\"] # hdkeypath=m/0'/0'/0' and 1'\n+        addresses += [\"bcrt1qrd3n235cj2czsfmsuvqqpr3lu6lg0ju7scl8gn\", \"bcrt1qfqeppuvj0ww98r6qghmdkj70tv8qpchehegrg8\"] # wpkh subscripts corresponding to the above addresses\n+        desc = \"sh(wpkh(\" + xpub + \"/0'/0'/*'\" + \"))\"\n+        self.log.info(\"Ranged descriptor import should warn without a specified range\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              warnings=['Range not given, using default keypool range'])\n+\n+        # # Test importing of a ranged descriptor with xpriv\n+        self.log.info(\"Should not import a ranged descriptor that includes xpriv into a watch-only wallet\")\n+        desc = \"sh(wpkh(\" + xpriv + \"/0'/0'/*'\" + \"))\"\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                              \"timestamp\": \"now\",\n+                              \"range\": 1},\n+                             success=False,\n+                             error_code=-4,\n+                             error_message='Cannot import private keys to a wallet with private keys disabled')\n+        for address in addresses:\n+            test_address(w1,\n+                         address,\n+                         ismine=False,\n+                         solvable=False)\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": -1},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [-1, 10]},\n+                              success=False, error_code=-8, error_message='Range should be greater or equal than 0')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [(2 << 31 + 1) - 1000000, (2 << 31 + 1)]},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [2, 1]},\n+                              success=False, error_code=-8, error_message='Range specified as [begin,end] must not have begin after end')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n+                              success=False, error_code=-8, error_message='Range is too large')\n+\n+        # Make sure ranged imports import keys in order\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        self.log.info('Key ranges should be imported in order')\n+        xpub = \"tpubDAXcJ7s7ZwicqjprRaEWdPoHKrCS215qxGYxpusRLLmJuT69ZSicuGdSfyvyKpvUNYBW1s2U3NSrT6vrCYB9e6nZUEvrqnwXPF8ArTCRXMY\"\n+        addresses = [\n+            'bcrt1qtmp74ayg7p24uslctssvjm06q5phz4yrxucgnv', # m/0'/0'/0\n+            'bcrt1q8vprchan07gzagd5e6v9wd7azyucksq2xc76k8', # m/0'/0'/1\n+            'bcrt1qtuqdtha7zmqgcrr26n2rqxztv5y8rafjp9lulu', # m/0'/0'/2\n+            'bcrt1qau64272ymawq26t90md6an0ps99qkrse58m640', # m/0'/0'/3\n+            'bcrt1qsg97266hrh6cpmutqen8s4s962aryy77jp0fg0', # m/0'/0'/4\n+        ]\n+\n+        self.test_importdesc({'desc': descsum_create('wpkh([80002067/0h/0h]' + xpub + '/*)'),\n+                              'active': True,\n+                              'range' : [0, 2],\n+                              'timestamp': 'now'\n+                             },\n+                             success=True)\n+\n+        for i in range(0, 4):\n+            addr = w1.getnewaddress('', 'bech32')\n+            assert_equal(addr, addresses[i])\n+\n+        # # Test importing a descriptor containing a WIF private key\n+        wif_priv = \"cTe1f5rdT8A8DFgVWTjyPwACsDPJM9ff4QngFxUixCSvvbg1x6sh\"\n+        address = \"2MuhcG52uHPknxDgmGPsV18jSHFBnnRgjPg\"\n+        desc = \"sh(wpkh(\" + wif_priv + \"))\"\n+        self.log.info(\"Should import a descriptor with a WIF private key as spendable\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              wallet=wpriv)\n+        test_address(wpriv,\n+                     address,\n+                     solvable=True,\n+                     ismine=True)\n+        txid = w0.sendtoaddress(address, 49.99995540)\n+        w0.generatetoaddress(6, w0.getnewaddress())\n+        self.sync_blocks()\n+        tx = wpriv.createrawtransaction([{\"txid\": txid, \"vout\": 0}], {w0.getnewaddress(): 49.999})\n+        signed_tx = wpriv.signrawtransactionwithwallet(tx)\n+        w1.sendrawtransaction(signed_tx['hex'])\n+\n+        # Make sure that we can use import and use multisig as addresses\n+        self.log.info('Test that multisigs can be imported, signed for, and getnewaddress\\'d')\n+        self.nodes[1].createwallet(wallet_name=\"wmulti_priv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wmulti_priv = self.nodes[1].get_wallet_rpc(\"wmulti_priv\")\n+        assert_equal(wmulti_priv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,tprv8ZgxMBicQKsPevADjDCWsa6DfhkVXicu8NQUzfibwX2MexVwW4tCec5mXdCW8kJwkzBRRmAay1KZya4WsehVvjTGVW6JLqiqd8DdZ4xSg52/84h/0h/0h/*,tprv8ZgxMBicQKsPdSNWUhDiwTScDr6JfkZuLshTRwzvZGnMSnGikV6jxpmdDkC3YRc4T3GD6Nvg9uv6hQg73RVv1EiTXDZwxVbsLugVHU8B1aq/84h/0h/0h/*,tprv8ZgxMBicQKsPeonDt8Ka2mrQmHa61hQ5FQCsvWBTpSNzBFgM58cV2EuXNAHF14VawVpznnme3SuTbA62sGriwWyKifJmXntfNeK7zeqMCj1/84h/0h/0h/*))#m2sr93jn\",\n+                            \"active\": True,\n+                            \"range\": 1000,\n+                            \"next_index\": 0,\n+                            \"timestamp\": \"now\"},\n+                            success=True,\n+                            wallet=wmulti_priv)\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,tprv8ZgxMBicQKsPevADjDCWsa6DfhkVXicu8NQUzfibwX2MexVwW4tCec5mXdCW8kJwkzBRRmAay1KZya4WsehVvjTGVW6JLqiqd8DdZ4xSg52/84h/1h/0h/*,tprv8ZgxMBicQKsPdSNWUhDiwTScDr6JfkZuLshTRwzvZGnMSnGikV6jxpmdDkC3YRc4T3GD6Nvg9uv6hQg73RVv1EiTXDZwxVbsLugVHU8B1aq/84h/1h/0h/*,tprv8ZgxMBicQKsPeonDt8Ka2mrQmHa61hQ5FQCsvWBTpSNzBFgM58cV2EuXNAHF14VawVpznnme3SuTbA62sGriwWyKifJmXntfNeK7zeqMCj1/84h/1h/0h/*))#q3sztvx5\",\n+                            \"active\": True,\n+                            \"internal\" : True,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540670",
      "id" : 399540670,
      "in_reply_to_id" : 399327270,
      "line" : 319,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDY3MA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 319,
      "original_position" : 248,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 319,
      "pull_request_review_id" : 383203202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540670",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540684"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:13:28Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor\n+        key1 = get_key(w0)\n+        key2 = get_key(w0)\n+        self.log.info(\"Should import a 1-of-2 bare multisig from descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"multi(1,\" + key1.pubkey + \",\" + key2.pubkey + \")\"),\n+                              \"timestamp\": \"now\"},\n+                             success=True)\n+        self.log.info(\"Should not treat individual keys from the imported bare multisig as watchonly\")\n+        test_address(w1,\n+                     key1.p2pkh_addr,\n+                     ismine=False)\n+\n+        # # Test ranged descriptors\n+        xpriv = \"tprv8ZgxMBicQKsPeuVhWwi6wuMQGfPKi9Li5GtX35jVNknACgqe3CY4g5xgkfDDJcmtF7o1QnxWDRYw4H5P26PXq7sbcUkEqeR4fg3Kxp2tigg\"\n+        xpub = \"tpubD6NzVbkrYhZ4YNXVQbNhMK1WqguFsUXceaVJKbmno2aZ3B6QfbMeraaYvnBSGpV3vxLyTTK9DYT1yoEck4XUScMzXoQ2U2oSmE2JyMedq3H\"\n+        addresses = [\"2N7yv4p8G8yEaPddJxY41kPihnWvs39qCMf\", \"2MsHxyb2JS3pAySeNUsJ7mNnurtpeenDzLA\"] # hdkeypath=m/0'/0'/0' and 1'\n+        addresses += [\"bcrt1qrd3n235cj2czsfmsuvqqpr3lu6lg0ju7scl8gn\", \"bcrt1qfqeppuvj0ww98r6qghmdkj70tv8qpchehegrg8\"] # wpkh subscripts corresponding to the above addresses\n+        desc = \"sh(wpkh(\" + xpub + \"/0'/0'/*'\" + \"))\"\n+        self.log.info(\"Ranged descriptor import should warn without a specified range\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              warnings=['Range not given, using default keypool range'])\n+\n+        # # Test importing of a ranged descriptor with xpriv\n+        self.log.info(\"Should not import a ranged descriptor that includes xpriv into a watch-only wallet\")\n+        desc = \"sh(wpkh(\" + xpriv + \"/0'/0'/*'\" + \"))\"\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                              \"timestamp\": \"now\",\n+                              \"range\": 1},\n+                             success=False,\n+                             error_code=-4,\n+                             error_message='Cannot import private keys to a wallet with private keys disabled')\n+        for address in addresses:\n+            test_address(w1,\n+                         address,\n+                         ismine=False,\n+                         solvable=False)\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": -1},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [-1, 10]},\n+                              success=False, error_code=-8, error_message='Range should be greater or equal than 0')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [(2 << 31 + 1) - 1000000, (2 << 31 + 1)]},\n+                              success=False, error_code=-8, error_message='End of range is too high')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [2, 1]},\n+                              success=False, error_code=-8, error_message='Range specified as [begin,end] must not have begin after end')\n+\n+        self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n+                              success=False, error_code=-8, error_message='Range is too large')\n+\n+        # Make sure ranged imports import keys in order\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        self.log.info('Key ranges should be imported in order')\n+        xpub = \"tpubDAXcJ7s7ZwicqjprRaEWdPoHKrCS215qxGYxpusRLLmJuT69ZSicuGdSfyvyKpvUNYBW1s2U3NSrT6vrCYB9e6nZUEvrqnwXPF8ArTCRXMY\"\n+        addresses = [\n+            'bcrt1qtmp74ayg7p24uslctssvjm06q5phz4yrxucgnv', # m/0'/0'/0\n+            'bcrt1q8vprchan07gzagd5e6v9wd7azyucksq2xc76k8', # m/0'/0'/1\n+            'bcrt1qtuqdtha7zmqgcrr26n2rqxztv5y8rafjp9lulu', # m/0'/0'/2\n+            'bcrt1qau64272ymawq26t90md6an0ps99qkrse58m640', # m/0'/0'/3\n+            'bcrt1qsg97266hrh6cpmutqen8s4s962aryy77jp0fg0', # m/0'/0'/4\n+        ]\n+\n+        self.test_importdesc({'desc': descsum_create('wpkh([80002067/0h/0h]' + xpub + '/*)'),\n+                              'active': True,\n+                              'range' : [0, 2],\n+                              'timestamp': 'now'\n+                             },\n+                             success=True)\n+\n+        for i in range(0, 4):\n+            addr = w1.getnewaddress('', 'bech32')\n+            assert_equal(addr, addresses[i])\n+\n+        # # Test importing a descriptor containing a WIF private key\n+        wif_priv = \"cTe1f5rdT8A8DFgVWTjyPwACsDPJM9ff4QngFxUixCSvvbg1x6sh\"\n+        address = \"2MuhcG52uHPknxDgmGPsV18jSHFBnnRgjPg\"\n+        desc = \"sh(wpkh(\" + wif_priv + \"))\"\n+        self.log.info(\"Should import a descriptor with a WIF private key as spendable\")\n+        self.test_importdesc({\"desc\": descsum_create(desc),\n+                               \"timestamp\": \"now\"},\n+                              success=True,\n+                              wallet=wpriv)\n+        test_address(wpriv,\n+                     address,\n+                     solvable=True,\n+                     ismine=True)\n+        txid = w0.sendtoaddress(address, 49.99995540)\n+        w0.generatetoaddress(6, w0.getnewaddress())\n+        self.sync_blocks()\n+        tx = wpriv.createrawtransaction([{\"txid\": txid, \"vout\": 0}], {w0.getnewaddress(): 49.999})\n+        signed_tx = wpriv.signrawtransactionwithwallet(tx)\n+        w1.sendrawtransaction(signed_tx['hex'])\n+\n+        # Make sure that we can use import and use multisig as addresses\n+        self.log.info('Test that multisigs can be imported, signed for, and getnewaddress\\'d')\n+        self.nodes[1].createwallet(wallet_name=\"wmulti_priv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wmulti_priv = self.nodes[1].get_wallet_rpc(\"wmulti_priv\")\n+        assert_equal(wmulti_priv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,tprv8ZgxMBicQKsPevADjDCWsa6DfhkVXicu8NQUzfibwX2MexVwW4tCec5mXdCW8kJwkzBRRmAay1KZya4WsehVvjTGVW6JLqiqd8DdZ4xSg52/84h/0h/0h/*,tprv8ZgxMBicQKsPdSNWUhDiwTScDr6JfkZuLshTRwzvZGnMSnGikV6jxpmdDkC3YRc4T3GD6Nvg9uv6hQg73RVv1EiTXDZwxVbsLugVHU8B1aq/84h/0h/0h/*,tprv8ZgxMBicQKsPeonDt8Ka2mrQmHa61hQ5FQCsvWBTpSNzBFgM58cV2EuXNAHF14VawVpznnme3SuTbA62sGriwWyKifJmXntfNeK7zeqMCj1/84h/0h/0h/*))#m2sr93jn\",\n+                            \"active\": True,\n+                            \"range\": 1000,\n+                            \"next_index\": 0,\n+                            \"timestamp\": \"now\"},\n+                            success=True,\n+                            wallet=wmulti_priv)\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,tprv8ZgxMBicQKsPevADjDCWsa6DfhkVXicu8NQUzfibwX2MexVwW4tCec5mXdCW8kJwkzBRRmAay1KZya4WsehVvjTGVW6JLqiqd8DdZ4xSg52/84h/1h/0h/*,tprv8ZgxMBicQKsPdSNWUhDiwTScDr6JfkZuLshTRwzvZGnMSnGikV6jxpmdDkC3YRc4T3GD6Nvg9uv6hQg73RVv1EiTXDZwxVbsLugVHU8B1aq/84h/1h/0h/*,tprv8ZgxMBicQKsPeonDt8Ka2mrQmHa61hQ5FQCsvWBTpSNzBFgM58cV2EuXNAHF14VawVpznnme3SuTbA62sGriwWyKifJmXntfNeK7zeqMCj1/84h/1h/0h/*))#q3sztvx5\",\n+                            \"active\": True,\n+                            \"internal\" : True,\n+                            \"range\": 1000,\n+                            \"next_index\": 0,\n+                            \"timestamp\": \"now\"},\n+                            success=True,\n+                            wallet=wmulti_priv)\n+\n+        addr = wmulti_priv.getnewaddress('', 'bech32')\n+        assert_equal(addr, 'bcrt1qdt0qy5p7dzhxzmegnn4ulzhard33s2809arjqgjndx87rv5vd0fq2czhy8') # Derived at m/84'/0'/0'/0\n+        txid = w0.sendtoaddress(addr, 10)\n+        self.nodes[0].generate(6)\n+        send_txid = wmulti_priv.sendtoaddress(w0.getnewaddress(), 8)\n+        decoded = wmulti_priv.decoderawtransaction(wmulti_priv.gettransaction(send_txid)['hex'])\n+        assert_equal(len(decoded['vin'][0]['txinwitness']), 4)\n+        self.nodes[0].generate(6)\n+        self.sync_all()\n+\n+        self.nodes[1].createwallet(wallet_name=\"wmulti_pub\", disable_private_keys=True, blank=True, descriptors=True)\n+        wmulti_pub = self.nodes[1].get_wallet_rpc(\"wmulti_pub\")\n+        assert_equal(wmulti_pub.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,[7b2d0242/84h/0h/0h]tpubDCJtdt5dgJpdhW4MtaVYDhG4T4tF6jcLR1PxL43q9pq1mxvXgMS9Mzw1HnXG15vxUGQJMMSqCQHMTy3F1eW5VkgVroWzchsPD5BUojrcWs8/*,[59b09cd6/84h/0h/0h]tpubDDBF2BTR6s8drwrfDei8WxtckGuSm1cyoKxYY1QaKSBFbHBYQArWhHPA6eJrzZej6nfHGLSURYSLHr7GuYch8aY5n61tGqgn8b4cXrMuoPH/*,[e81a0532/84h/0h/0h]tpubDCsWoW1kuQB9kG5MXewHqkbjPtqPueRnXju7uM2NK7y3JYb2ajAZ9EiuZXNNuE4661RAfriBWhL8UsnAPpk8zrKKnZw1Ug7X4oHgMdZiU4E/*))#tsry0s5e\",\n+                            \"active\": True,\n+                            \"range\": 1000,\n+                            \"next_index\": 0,\n+                            \"timestamp\": \"now\"},\n+                            success=True,\n+                            wallet=wmulti_pub)\n+        self.test_importdesc({\"desc\":\"wsh(multi(2,[7b2d0242/84h/1h/0h]tpubDCXqdwWZcszwqYJSnZp8eARkxGJfHAk23KDxbztV4BbschfaTfYLTcSkSJ3TN64dRqwa1rnFUScsYormKkGqNbbPwkorQimVevXjxzUV9Gf/*,[59b09cd6/84h/1h/0h]tpubDCYfZY2ceyHzYzMMVPt9MNeiqtQ2T7Uyp9QSFwYXh8Vi9iJFYXcuphJaGXfF3jUQJi5Y3GMNXvM11gaL4txzZgNGK22BFAwMXynnzv4z2Jh/*,[e81a0532/84h/1h/0h]tpubDC6UGqnsQStngYuGD4MKsMy7eD1Yg9NTJfPdvjdG2JE5oZ7EsSL3WHg4Gsw2pR5K39ZwJ46M1wZayhedVdQtMGaUhq5S23PH6fnENK3V1sb/*))#c08a2rzv\",\n+                            \"active\": True,\n+                            \"internal\" : True,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540684",
      "id" : 399540684,
      "in_reply_to_id" : 399327486,
      "line" : 353,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDY4NA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 353,
      "original_position" : 278,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 353,
      "pull_request_review_id" : 383203225,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540684",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540725"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:13:32Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540725",
      "id" : 399540725,
      "in_reply_to_id" : 399328411,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDcyNQ==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 70,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 70,
      "pull_request_review_id" : 383203265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540725",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540804"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:13:42Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540804",
      "id" : 399540804,
      "in_reply_to_id" : 399330460,
      "line" : 139,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDgwNA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 139,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 139,
      "pull_request_review_id" : 383203355,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540804",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540853"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:13:49Z",
      "diff_hunk" : "@@ -0,0 +1,137 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descriptor wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error\n+)\n+\n+\n+class WalletDescriptorTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-keypool=100']]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        # Make a descriptor wallet\n+        self.log.info(\"Making a descriptor wallet\")\n+        self.nodes[0].createwallet(wallet_name=\"desc1\", descriptors=True)\n+        self.nodes[0].unloadwallet(\"\")\n+\n+        # A descriptor wallet should have 100 addresses * 3 types = 300 keys\n+        self.log.info(\"Checking wallet info\")\n+        wallet_info = self.nodes[0].getwalletinfo()\n+        assert_equal(wallet_info['keypoolsize'], 300)\n+        assert_equal(wallet_info['keypoolsize_hd_internal'], 300)\n+\n+        # Check that getnewaddress works",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399540853",
      "id" : 399540853,
      "in_reply_to_id" : 399333787,
      "line" : 36,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDg1Mw==",
      "original_commit_id" : "15b044fd16c2b26cb28497cf150820b25fafae93",
      "original_line" : 36,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/wallet_descriptor.py",
      "position" : 36,
      "pull_request_review_id" : 383203416,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399540853",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399541007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399541007"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure what you mean by \"displacing\"",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:14:10Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399541007",
      "id" : 399541007,
      "in_reply_to_id" : 399336346,
      "line" : 149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MTAwNw==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 149,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 149,
      "pull_request_review_id" : 383203597,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399541007",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399541048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399541048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a test.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:14:17Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Check if all private keys are provided\n+        bool have_privkeys = true;\n+        for (const auto& entry : keys.pubkeys) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!keys.GetKey(key_id, key)) {\n+                have_privkeys = false;\n+            }\n+        }\n+\n+        // If private keys are enabled, abort if private keys are not provided\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !have_privkeys) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->HasWalletDescriptor(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399541048",
      "id" : 399541048,
      "in_reply_to_id" : 399350834,
      "line" : 1582,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MTA0OA==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 1582,
      "original_position" : 113,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 125,
      "pull_request_review_id" : 383203643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399541048",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399541096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399541096"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:14:24Z",
      "diff_hunk" : "@@ -1459,3 +1459,290 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptor must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Check if all private keys are provided\n+        bool have_privkeys = true;\n+        for (const auto& entry : keys.pubkeys) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!keys.GetKey(key_id, key)) {\n+                have_privkeys = false;\n+            }\n+        }\n+\n+        // If private keys are enabled, abort if private keys are not provided\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !have_privkeys) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->HasWalletDescriptor(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp, during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exists but related transactions are still missing.\\n\",\n+                {\n+                    {\"requests\", RPCArg::Type::ARR, RPCArg::Optional::NO, \"Data to be imported\",\n+                        {\n+                            {\"\", RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, \"\",\n+                                {\n+                                    {\"desc\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Descriptor to import.\"},\n+                                    {\"active\", RPCArg::Type::BOOL, /* default */ \"true\", \"Set this descriptor to be the active descriptor for the corresponding output type/externality\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399541096",
      "id" : 399541096,
      "in_reply_to_id" : 399361504,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MTA5Ng==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 1608,
      "original_position" : 150,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 383203704,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399541096",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399542742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399542742"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No. `CanGetAddresses` implies that more addresses can be fetched. You can't do that for an unranged descriptor, we consider their address already fetched and used.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T21:18:35Z",
      "diff_hunk" : "@@ -1496,3 +1496,616 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item, mark all keypool items up to this item as used\\n\", __func__);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399542742",
      "id" : 399542742,
      "in_reply_to_id" : 399480181,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0Mjc0Mg==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 1858,
      "original_position" : 383,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383205803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399542742",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399560621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399560621"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Descriptors are inherently strings. There is no alternative serialization that doesn't eventually result in a descriptor string as we know now.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T22:09:00Z",
      "diff_hunk" : "@@ -86,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end). This never changes.\n+    int32_t range_end; // Item after the last; end of range, exclusive, i.e. [range_start, range_end). This will increment with each TopUp()\n+    int32_t next_index; // Position of the next item to generate\n+    DescriptorCache cache;\n+\n+    ADD_SERIALIZE_METHODS;\n+\n+    template <typename Stream, typename Operation>\n+    inline void SerializationOp(Stream& s, Operation ser_action) {\n+        if (ser_action.ForRead()) {\n+            std::string desc;\n+            std::string error;\n+            READWRITE(desc);\n+            FlatSigningProvider keys;\n+            descriptor = Parse(desc, keys, error, true);\n+        } else {\n+            READWRITE(descriptor->ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399560621",
      "id" : 399560621,
      "in_reply_to_id" : 399436260,
      "line" : 115,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MDYyMQ==",
      "original_commit_id" : "f0a15b8aa1f2cc5c91162b747170faa452944d9b",
      "original_line" : 115,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : 47,
      "pull_request_review_id" : 383227388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399560621",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399561307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399561307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These records are generic spkman records, not descriptor wallet specific records. It does not make sense to make these part of `WALLETDESCRIPTOR` when not all spkmans are descriptors.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T22:11:13Z",
      "diff_hunk" : "@@ -179,6 +182,15 @@ bool WalletBatch::WriteMinVersion(int nVersion)\n     return WriteIC(DBKeys::MINVERSION, nVersion);\n }\n \n+bool WalletBatch::WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399561307",
      "id" : 399561307,
      "in_reply_to_id" : 395865796,
      "line" : 188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTMwNw==",
      "original_commit_id" : "6fa9c482c51576c97b7e02a767d0b328dbbb52fc",
      "original_line" : 188,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 24,
      "pull_request_review_id" : 383228241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399561307",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399563823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399563823"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T22:19:30Z",
      "diff_hunk" : "@@ -1554,7 +1554,8 @@ void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n \n bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399563823",
      "id" : 399563823,
      "in_reply_to_id" : 399462420,
      "line" : 1851,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MzgyMw==",
      "original_commit_id" : "fbd356690fab88c7fc10b300b71ef13d5ab14032",
      "original_line" : 1851,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 381,
      "pull_request_review_id" : 383231242,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399563823",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399566855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399566855"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wanted to leave this open to different caching structures in the future and not have a ton of cache structure specific records like that.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T22:29:49Z",
      "diff_hunk" : "@@ -434,7 +436,38 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssKey >> id;\n             WalletDescriptor desc;\n             ssValue >> desc;\n+            if (wss.m_descriptor_caches.count(id) == 0) {\n+                wss.m_descriptor_caches[id] = DescriptorCache();\n+            }\n             pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\n+        } else if (strType == DBKeys::WALLETDESCRIPTORCACHE) {\n+            bool parent = true;\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            uint32_t der_index;\n+            ssKey >> desc_id;\n+            ssKey >> key_exp_index;\n+\n+            // if the der_index exists, it's a derived xpub\n+            try",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399566855",
      "id" : 399566855,
      "in_reply_to_id" : 399472037,
      "line" : 494,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2Njg1NQ==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 494,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 119,
      "pull_request_review_id" : 383234715,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399566855",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399567485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399567485"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's inherently done by not being able to expand from cache during `SetCache`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T22:32:03Z",
      "diff_hunk" : "@@ -536,6 +569,13 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         pwallet->SetActiveScriptPubKeyMan(spk_man_pair.second, spk_man_pair.first, /* internal */ true, /* memonly */ true);\n     }\n \n+    // Set the descriptor caches\n+    for (auto desc_cache_pair : wss.m_descriptor_caches) {\n+        auto spk_man = pwallet->GetScriptPubKeyMan(desc_cache_pair.first);\n+        assert(spk_man);\n+        ((DescriptorScriptPubKeyMan*)spk_man)->SetCache(desc_cache_pair.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399567485",
      "id" : 399567485,
      "in_reply_to_id" : 399473488,
      "line" : 670,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NzQ4NQ==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 670,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 209,
      "pull_request_review_id" : 383235456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399567485",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399568614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399568614"
         }
      },
      "author_association" : "MEMBER",
      "body" : "And? We modify `GetSolvingProvider` below. This is an internal function.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T22:36:06Z",
      "diff_hunk" : "@@ -1878,9 +1878,34 @@ int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n     return m_wallet_descriptor.creation_time;\n }\n \n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399568614",
      "id" : 399568614,
      "in_reply_to_id" : 399490475,
      "line" : 1897,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2ODYxNA==",
      "original_commit_id" : "50c3b4eee31e095a5080fcb4109cb5d8f7bfbbe7",
      "original_line" : 1897,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 427,
      "pull_request_review_id" : 383236754,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399568614",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399570970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399570970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Meh, it's not really a big difference.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T22:44:44Z",
      "diff_hunk" : "@@ -60,3 +60,8 @@ bool CreateWalletDialog::isMakeBlankWalletChecked() const\n {\n     return ui->blank_wallet_checkbox->isChecked();\n }\n+\n+bool CreateWalletDialog::isDescriptorWalletChecked() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399570970",
      "id" : 399570970,
      "in_reply_to_id" : 399493975,
      "line" : 64,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3MDk3MA==",
      "original_commit_id" : "f5204ed3fe1b2a059e35e54248d38eac88c629e0",
      "original_line" : 64,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/qt/createwalletdialog.cpp",
      "position" : 5,
      "pull_request_review_id" : 383239397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399570970",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399571664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399571664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Disagree, on both counts.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T22:47:31Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399571664",
      "id" : 399571664,
      "in_reply_to_id" : 399499505,
      "line" : 15,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3MTY2NA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 15,
      "pull_request_review_id" : 383240174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399571664",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399577798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399577798"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Changed this to check the result and throw an exception. Added a unit test for that.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:11:43Z",
      "diff_hunk" : "@@ -86,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end). This never changes.\n+    int32_t range_end; // Item after the last; end of range, exclusive, i.e. [range_start, range_end). This will increment with each TopUp()\n+    int32_t next_index; // Position of the next item to generate\n+    DescriptorCache cache;\n+\n+    ADD_SERIALIZE_METHODS;\n+\n+    template <typename Stream, typename Operation>\n+    inline void SerializationOp(Stream& s, Operation ser_action) {\n+        if (ser_action.ForRead()) {\n+            std::string desc;\n+            std::string error;\n+            READWRITE(desc);\n+            FlatSigningProvider keys;\n+            descriptor = Parse(desc, keys, error, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399577798",
      "id" : 399577798,
      "in_reply_to_id" : 399434828,
      "line" : 110,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3Nzc5OA==",
      "original_commit_id" : "f0a15b8aa1f2cc5c91162b747170faa452944d9b",
      "original_line" : 110,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : 42,
      "pull_request_review_id" : 383246760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399577798",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399577860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399577860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added more comments.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:12:00Z",
      "diff_hunk" : "@@ -1214,6 +1214,12 @@ class CWallet final : public WalletStorage, private interfaces::Chain::Notificat\n \n     //! Connect the signals from ScriptPubKeyMans to the signals in CWallet\n     void ConnectScriptPubKeyManNotifiers();\n+\n+    //! Instantiate a descriptor ScriptPubKeyMan from the WalletDescriptor and load it\n+    void LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor& desc);\n+\n+    //! Sets the active ScriptPubKeyMan for the specified type and internal",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399577860",
      "id" : 399577860,
      "in_reply_to_id" : 399449698,
      "line" : 1244,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3Nzg2MA==",
      "original_commit_id" : "ed75ce9649ce7a26146b45bb85584f5522945a3d",
      "original_line" : 1244,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 36,
      "pull_request_review_id" : 383246827,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399577860",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399577884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399577884"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:12:08Z",
      "diff_hunk" : "@@ -1539,6 +1539,17 @@ bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n \n void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item, mark all keypool items up to this item as used\\n\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399577884",
      "id" : 399577884,
      "in_reply_to_id" : 399459055,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3Nzg4NA==",
      "original_commit_id" : "68cef400b94fbe2ad592ccdf54fb6dcf9e78389e",
      "original_line" : 1546,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383246863,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399577884",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399577989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399577989"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`|=` would be incorrect. I've instead changed `IsHDEnabled` to iterate over `GetActiveScriptPubKeyMans()`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:12:39Z",
      "diff_hunk" : "@@ -1554,7 +1554,8 @@ void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n \n bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399577989",
      "id" : 399577989,
      "in_reply_to_id" : 399462420,
      "line" : 1851,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3Nzk4OQ==",
      "original_commit_id" : "fbd356690fab88c7fc10b300b71ef13d5ab14032",
      "original_line" : 1851,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 381,
      "pull_request_review_id" : 383246990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399577989",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:12:48Z",
      "diff_hunk" : "@@ -1627,4 +1627,8 @@ uint256 DescriptorScriptPubKeyMan::GetID() const\n     return id;\n }\n \n-void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578030",
      "id" : 399578030,
      "in_reply_to_id" : 399464603,
      "line" : 2080,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODAzMA==",
      "original_commit_id" : "0708467ad1243fdca15f7498fb94a2eadcf3f4d8",
      "original_line" : 2080,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 610,
      "pull_request_review_id" : 383247028,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578030",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578305"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:13:53Z",
      "diff_hunk" : "@@ -1632,3 +1632,18 @@ void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)\n     this->m_address_type = type;\n     this->m_internal = internal;\n }\n+\n+void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n+{\n+    LOCK(cs_desc_man);\n+    m_wallet_descriptor.cache = cache;\n+    for (int32_t i = m_wallet_descriptor.range_start; i < m_wallet_descriptor.range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578305",
      "id" : 399578305,
      "in_reply_to_id" : 399466760,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODMwNQ==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 1643,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383247305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578305",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:14:10Z",
      "diff_hunk" : "@@ -1632,3 +1632,18 @@ void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)\n     this->m_address_type = type;\n     this->m_internal = internal;\n }\n+\n+void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n+{\n+    LOCK(cs_desc_man);\n+    m_wallet_descriptor.cache = cache;\n+    for (int32_t i = m_wallet_descriptor.range_start; i < m_wallet_descriptor.range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys);\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578383",
      "id" : 399578383,
      "in_reply_to_id" : 399468023,
      "line" : 2101,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODM4Mw==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 2101,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 631,
      "pull_request_review_id" : 383247372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578383",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578411"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:14:18Z",
      "diff_hunk" : "@@ -1552,12 +1552,61 @@ isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n \n bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n {\n-    return false;\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578411",
      "id" : 399578411,
      "in_reply_to_id" : 399487630,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODQxMQ==",
      "original_commit_id" : "8ae9bf12395b558bf53cc0b8d2f4056424908585",
      "original_line" : 1558,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383247414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578411",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Swapped the commits.\r\n\r\nA general test for `GetReserveDestination` and `ReturnDestination` in the wallet feels out of scope for this PR. IMO should be a separate PR.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:15:27Z",
      "diff_hunk" : "@@ -1616,6 +1616,13 @@ bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bo\n \n void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n {\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578641",
      "id" : 399578641,
      "in_reply_to_id" : 399489479,
      "line" : 1621,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODY0MQ==",
      "original_commit_id" : "ee03d46178a3e8d511c33f734892820b36ed7a1a",
      "original_line" : 1621,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 151,
      "pull_request_review_id" : 383247706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578641",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578688"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:15:36Z",
      "diff_hunk" : "@@ -1878,9 +1878,34 @@ int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n     return m_wallet_descriptor.creation_time;\n }\n \n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!m_wallet_descriptor.descriptor->ExpandFromCache(index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) return nullptr;\n+\n+    if (include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        m_wallet_descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578688",
      "id" : 399578688,
      "in_reply_to_id" : 399492040,
      "line" : 1937,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODY4OA==",
      "original_commit_id" : "50c3b4eee31e095a5080fcb4109cb5d8f7bfbbe7",
      "original_line" : 1937,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 467,
      "pull_request_review_id" : 383247748,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578688",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578721"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed it.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:15:46Z",
      "diff_hunk" : "@@ -252,13 +252,13 @@ class WalletBatch\n     bool WriteDescriptorDerivedCache(const uint256& desc_id, uint32_t key_exp_index, uint32_t der_index, const CExtPubKey& xpub);\n     bool WriteDescriptorParentCache(const uint256& desc_id, uint32_t key_exp_index, const CExtPubKey& xpub);\n \n+    bool WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bool internal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578721",
      "id" : 399578721,
      "in_reply_to_id" : 399494992,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODcyMQ==",
      "original_commit_id" : "f5204ed3fe1b2a059e35e54248d38eac88c629e0",
      "original_line" : 255,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 383247790,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578721",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-27T23:15:53Z",
      "diff_hunk" : "@@ -585,8 +585,11 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         Lock();\n         Unlock(strWalletPassphrase);\n \n-        // if we are using HD, replace the HD seed with a new one\n-        if (auto spk_man = GetLegacyScriptPubKeyMan()) {\n+        // If we are using descriptors, make new descriptors",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399578748",
      "id" : 399578748,
      "in_reply_to_id" : 399496245,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODc0OA==",
      "original_commit_id" : "2de265c2b60c4348899aa09783a4cd3be958fb81",
      "original_line" : 588,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 383247814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399578748",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399645681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399645681"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It doesn't have to be that way. We describe \"wrapped segwit script\" with \"sh(wsh(script))\", but it might just as well have been \"p2sh[wsh[script]]\". There's already talk of tweaking descriptors to make them more compatible with miniscript. We use base58 encoded xpubs, but we might as well switch to something bech32 encoded in the future. It makes sense to have a more computer-friendly representation, that's mapped 1 to 1 with these strings. See also #18043.\r\n\r\nIt's just that I'd rather not delay this PR for that.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T10:19:54Z",
      "diff_hunk" : "@@ -86,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end). This never changes.\n+    int32_t range_end; // Item after the last; end of range, exclusive, i.e. [range_start, range_end). This will increment with each TopUp()\n+    int32_t next_index; // Position of the next item to generate\n+    DescriptorCache cache;\n+\n+    ADD_SERIALIZE_METHODS;\n+\n+    template <typename Stream, typename Operation>\n+    inline void SerializationOp(Stream& s, Operation ser_action) {\n+        if (ser_action.ForRead()) {\n+            std::string desc;\n+            std::string error;\n+            READWRITE(desc);\n+            FlatSigningProvider keys;\n+            descriptor = Parse(desc, keys, error, true);\n+        } else {\n+            READWRITE(descriptor->ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399645681",
      "id" : 399645681,
      "in_reply_to_id" : 399436260,
      "line" : 115,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY0NTY4MQ==",
      "original_commit_id" : "f0a15b8aa1f2cc5c91162b747170faa452944d9b",
      "original_line" : 115,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : 47,
      "pull_request_review_id" : 383300970,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399645681",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399645781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399645781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If unranged descriptors can't be active, then that's fine.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T10:21:25Z",
      "diff_hunk" : "@@ -1554,7 +1554,8 @@ void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n \n bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399645781",
      "id" : 399645781,
      "in_reply_to_id" : 399462420,
      "line" : 1851,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY0NTc4MQ==",
      "original_commit_id" : "fbd356690fab88c7fc10b300b71ef13d5ab14032",
      "original_line" : 1851,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 381,
      "pull_request_review_id" : 383301059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399645781",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399645877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399645877"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was thinking the other way around: have different record for different things, so it's easy to add new things and wipe / ignore stuff we don't need anymore.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T10:22:46Z",
      "diff_hunk" : "@@ -434,7 +436,38 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssKey >> id;\n             WalletDescriptor desc;\n             ssValue >> desc;\n+            if (wss.m_descriptor_caches.count(id) == 0) {\n+                wss.m_descriptor_caches[id] = DescriptorCache();\n+            }\n             pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\n+        } else if (strType == DBKeys::WALLETDESCRIPTORCACHE) {\n+            bool parent = true;\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            uint32_t der_index;\n+            ssKey >> desc_id;\n+            ssKey >> key_exp_index;\n+\n+            // if the der_index exists, it's a derived xpub\n+            try",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399645877",
      "id" : 399645877,
      "in_reply_to_id" : 399472037,
      "line" : 494,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY0NTg3Nw==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 494,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 119,
      "pull_request_review_id" : 383301135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399645877",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399646044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399646044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Doesn't `walletcreatefundedpsbt` call those two methods? So the test just has to check the keypool doesn't shrink.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T10:24:35Z",
      "diff_hunk" : "@@ -1616,6 +1616,13 @@ bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bo\n \n void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n {\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399646044",
      "id" : 399646044,
      "in_reply_to_id" : 399489479,
      "line" : 1621,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY0NjA0NA==",
      "original_commit_id" : "ee03d46178a3e8d511c33f734892820b36ed7a1a",
      "original_line" : 1621,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 151,
      "pull_request_review_id" : 383301239,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399646044",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399646259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399646259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, just keep in in mind if something else needs to be changed there, or if - god forbid - we get bike shedding over the new check box.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T10:27:49Z",
      "diff_hunk" : "@@ -60,3 +60,8 @@ bool CreateWalletDialog::isMakeBlankWalletChecked() const\n {\n     return ui->blank_wallet_checkbox->isChecked();\n }\n+\n+bool CreateWalletDialog::isDescriptorWalletChecked() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399646259",
      "id" : 399646259,
      "in_reply_to_id" : 399493975,
      "line" : 64,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY0NjI1OQ==",
      "original_commit_id" : "f5204ed3fe1b2a059e35e54248d38eac88c629e0",
      "original_line" : 64,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/qt/createwalletdialog.cpp",
      "position" : 5,
      "pull_request_review_id" : 383301405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399646259",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399646470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399646470"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See [above](https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399542742). It makes sense to disallow `getnewaddress` on unranged descriptors. And they can't be active (I assume that restriction is tested in the `importdescriptor` tests). So in that case there's nothing to test here.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T10:29:50Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399646470",
      "id" : 399646470,
      "in_reply_to_id" : 399499505,
      "line" : 15,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY0NjQ3MA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 15,
      "pull_request_review_id" : 383301547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399646470",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399686037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399686037"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Make a test to ensure that `active` is actually default true(or not)",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T17:13:54Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399686037",
      "id" : 399686037,
      "in_reply_to_id" : 399363853,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4NjAzNw==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 6,
      "pull_request_review_id" : 383331152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399686037",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399686130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399686130"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In other words, make sure that importing legacy doesn't accidentally replace p2sh somehow, and p2sh doesn't accidentally also replace bech32, and so on. Just thinking about what could have gone wrong under the hood.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T17:14:48Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399686130",
      "id" : 399686130,
      "in_reply_to_id" : 399336346,
      "line" : 149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4NjEzMA==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 149,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 149,
      "pull_request_review_id" : 383331224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399686130",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399686381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399686381"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We're not going to get this right on the first shot likely no matter what we decide. As long as it's not a supreme burden to upgrade I think current is fine.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T17:17:33Z",
      "diff_hunk" : "@@ -86,4 +87,38 @@ class WalletLocation final\n     bool Exists() const;\n };\n \n+/** Descriptor with some wallet metadata */\n+class WalletDescriptor\n+{\n+public:\n+    std::shared_ptr<Descriptor> descriptor;\n+    uint64_t creation_time;\n+    int32_t range_start; // First item in range; start of range, inclusive, i.e. [range_start, range_end). This never changes.\n+    int32_t range_end; // Item after the last; end of range, exclusive, i.e. [range_start, range_end). This will increment with each TopUp()\n+    int32_t next_index; // Position of the next item to generate\n+    DescriptorCache cache;\n+\n+    ADD_SERIALIZE_METHODS;\n+\n+    template <typename Stream, typename Operation>\n+    inline void SerializationOp(Stream& s, Operation ser_action) {\n+        if (ser_action.ForRead()) {\n+            std::string desc;\n+            std::string error;\n+            READWRITE(desc);\n+            FlatSigningProvider keys;\n+            descriptor = Parse(desc, keys, error, true);\n+        } else {\n+            READWRITE(descriptor->ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399686381",
      "id" : 399686381,
      "in_reply_to_id" : 399436260,
      "line" : 115,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4NjM4MQ==",
      "original_commit_id" : "f0a15b8aa1f2cc5c91162b747170faa452944d9b",
      "original_line" : 115,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.h",
      "position" : 47,
      "pull_request_review_id" : 383331436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399686381",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399686525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399686525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "unranged active descriptors would result in a single new address grab per import, kind of pointless",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T17:18:41Z",
      "diff_hunk" : "@@ -1554,7 +1554,8 @@ void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n \n bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n {\n-    return false;\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399686525",
      "id" : 399686525,
      "in_reply_to_id" : 399462420,
      "line" : 1851,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4NjUyNQ==",
      "original_commit_id" : "fbd356690fab88c7fc10b300b71ef13d5ab14032",
      "original_line" : 1851,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 381,
      "pull_request_review_id" : 383331552,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399686525",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399687251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399687251"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think we're supposed to be asserting on a line with state changes, cache the result and then assert below",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T17:25:38Z",
      "diff_hunk" : "@@ -1496,3 +1492,621 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsSingleType() &&\n+           m_wallet_descriptor.descriptor->IsRange() &&\n+           (HavePrivateKeys() || m_wallet_descriptor.next_index < m_wallet_descriptor.range_end);\n+}\n+\n+bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_map_keys.size() > 0 || m_map_crypted_keys.size() > 0;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime() const\n+{\n+    return 0;\n+}\n+\n+size_t DescriptorScriptPubKeyMan::KeypoolCountExternalKeys() const\n+{\n+    if (m_internal) {\n+        return 0;\n+    }\n+    return GetKeyPoolSize();\n+}\n+\n+unsigned int DescriptorScriptPubKeyMan::GetKeyPoolSize() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.range_end - m_wallet_descriptor.next_index;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.creation_time;\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!m_wallet_descriptor.descriptor->ExpandFromCache(index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) return nullptr;\n+\n+    if (include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        assert(m_wallet_descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399687251",
      "id" : 399687251,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4NzI1MQ==",
      "original_commit_id" : "d034592cf87d5ac8cea02c0edd4d50134be88c87",
      "original_line" : 1905,
      "original_position" : 469,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383332087,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399687251",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "looks like unit test is failing sometimes:\r\n```\r\nwallet/test/wallet_tests.cpp(651): error: in \"wallet_tests/wallet_descriptor_test\": exception \"std::ios_base::failure\" raised as expected: validation on the raised exception through predicate \"malformed_descriptor\"\r\n```",
      "created_at" : "2020-03-28T17:29:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-605492768",
      "id" : 605492768,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNTQ5Mjc2OA==",
      "updated_at" : "2020-03-28T17:29:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/605492768",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399708441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399708441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "More specifically, I've been thinking about a way to unify the descriptor cache structure so that we don't have to have separate records like that. In particular, I've considered setting a bogus derivation index for the parent xpubs so that a single record can be used, as well as a single map within `DescriptorCache` too.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T20:54:43Z",
      "diff_hunk" : "@@ -434,7 +436,38 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssKey >> id;\n             WalletDescriptor desc;\n             ssValue >> desc;\n+            if (wss.m_descriptor_caches.count(id) == 0) {\n+                wss.m_descriptor_caches[id] = DescriptorCache();\n+            }\n             pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\n+        } else if (strType == DBKeys::WALLETDESCRIPTORCACHE) {\n+            bool parent = true;\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            uint32_t der_index;\n+            ssKey >> desc_id;\n+            ssKey >> key_exp_index;\n+\n+            // if the der_index exists, it's a derived xpub\n+            try",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399708441",
      "id" : 399708441,
      "in_reply_to_id" : 399472037,
      "line" : 494,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcwODQ0MQ==",
      "original_commit_id" : "0abf7b960c82e9d5b6973ea3c2baee7d696c5145",
      "original_line" : 494,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 119,
      "pull_request_review_id" : 383348776,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399708441",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399709303"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399709303"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Again, seems out of scope and a general wallet test rather than specific to descriptor wallets.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T21:03:44Z",
      "diff_hunk" : "@@ -1616,6 +1616,13 @@ bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bo\n \n void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n {\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399709303",
      "id" : 399709303,
      "in_reply_to_id" : 399489479,
      "line" : 1621,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcwOTMwMw==",
      "original_commit_id" : "ee03d46178a3e8d511c33f734892820b36ed7a1a",
      "original_line" : 1621,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 151,
      "pull_request_review_id" : 383349469,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399709303",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399709427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399709427"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a test for that case.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T21:04:49Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+\n+Test importdescriptors by generating keys on node0, importing the corresponding\n+descriptors on node1 and then testing the address info for the different address\n+variants.\n+\n+- `get_key()` is called to generate keys on node0 and return the privkeys,\n+  pubkeys and all variants of scriptPubKey and address.\n+- `test_importdesc()` is called to send an importdescriptors call to node1, test\n+  success, and (if unsuccessful) test the error code and error message returned.\n+- `test_address()` is called to call getaddressinfo for an address on node1\n+  and test the values returned.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.descriptors import descsum_create\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+    test_address,\n+)\n+\n+class ImportDescriptorsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-addresstype=legacy\"],\n+                           [\"-addresstype=bech32\", \"-keypool=5\"]\n+                          ]\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def test_importdesc(self, req, success, error_code=None, error_message=None, warnings=None, wallet=None):\n+        \"\"\"Run importdescriptors and assert success\"\"\"\n+        if warnings is None:\n+            warnings = []\n+        wrpc = self.nodes[1].get_wallet_rpc('w1')\n+        if wallet is not None:\n+            wrpc = wallet\n+\n+        result = wrpc.importdescriptors([req])\n+        observed_warnings = []\n+        if 'warnings' in result[0]:\n+           observed_warnings = result[0]['warnings']\n+        assert_equal(\"\\n\".join(sorted(warnings)), \"\\n\".join(sorted(observed_warnings)))\n+        assert_equal(result[0]['success'], success)\n+        if error_code is not None:\n+            assert_equal(result[0]['error']['code'], error_code)\n+            assert_equal(result[0]['error']['message'], error_message)\n+\n+    def run_test(self):\n+        self.log.info('Setting up wallets')\n+        self.nodes[0].createwallet(wallet_name='w0', disable_private_keys=False)\n+        w0 = self.nodes[0].get_wallet_rpc('w0')\n+\n+        self.nodes[1].createwallet(wallet_name='w1', disable_private_keys=True, blank=True, descriptors=True)\n+        w1 = self.nodes[1].get_wallet_rpc('w1')\n+        assert_equal(w1.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.nodes[1].createwallet(wallet_name=\"wpriv\", disable_private_keys=False, blank=True, descriptors=True)\n+        wpriv = self.nodes[1].get_wallet_rpc(\"wpriv\")\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 0)\n+\n+        self.log.info('Mining coins')\n+        w0.generatetoaddress(101, w0.getnewaddress())\n+\n+        # RPC importdescriptors -----------------------------------------------\n+\n+        # # Test import fails if no descriptor present\n+        key = get_key(w0)\n+        self.log.info(\"Import should fail if a descriptor is not provided\")\n+        self.test_importdesc({\"timestamp\": \"now\"},\n+                             success=False,\n+                             error_code=-8,\n+                             error_message='Descriptor not found.')\n+\n+        # # Test importing of a P2PKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should import a p2pkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                              \"timestamp\": \"now\",\n+                              \"label\": \"Descriptor import test\"},\n+                             success=True)\n+        test_address(w1,\n+                     key.p2pkh_addr,\n+                     solvable=True,\n+                     ismine=True,\n+                     labels=[\"Descriptor import test\"])\n+\n+        # # Test importing of a P2SH-P2WPKH descriptor\n+        key = get_key(w0)\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor without checksum\")\n+        self.test_importdesc({\"desc\": \"sh(wpkh(\" + key.pubkey + \"))\",\n+                              \"timestamp\": \"now\"\n+                              },\n+                             success=False,\n+                             error_code=-5,\n+                             error_message=\"Missing checksum\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor that has range specified\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"range\": 1,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Range should not be specified for an un-ranged descriptor\")\n+\n+        self.log.info(\"Should not import a p2sh-p2wpkh descriptor and have it set to active\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": True,\n+                              },\n+                              success=False,\n+                              error_code=-8,\n+                              error_message=\"Active descriptor must be ranged\")\n+\n+        self.log.info(\"Should import a (non-active) p2sh-p2wpkh descriptor\")\n+        self.test_importdesc({\"desc\": descsum_create(\"sh(wpkh(\" + key.pubkey + \"))\"),\n+                               \"timestamp\": \"now\",\n+                               \"active\": False,\n+                              },\n+                              success=True)\n+\n+        test_address(w1,\n+                     key.p2sh_p2wpkh_addr,\n+                     ismine=True,\n+                     solvable=True)\n+\n+        # # Test importing of a multisig descriptor",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399709427",
      "id" : 399709427,
      "in_reply_to_id" : 399336346,
      "line" : 149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcwOTQyNw==",
      "original_commit_id" : "7d1c6bbeb057c18da62201267efc2b675f142da3",
      "original_line" : 149,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 149,
      "pull_request_review_id" : 383349546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399709427",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399709544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399709544"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T21:06:13Z",
      "diff_hunk" : "@@ -0,0 +1,293 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the importdescriptors RPC.\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399709544",
      "id" : 399709544,
      "in_reply_to_id" : 399363853,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcwOTU0NA==",
      "original_commit_id" : "a03a8cbd1f42636834263135e904900cc808d346",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 6,
      "pull_request_review_id" : 383349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399709544",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399709671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399709671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-28T21:07:40Z",
      "diff_hunk" : "@@ -1496,3 +1492,621 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsSingleType() &&\n+           m_wallet_descriptor.descriptor->IsRange() &&\n+           (HavePrivateKeys() || m_wallet_descriptor.next_index < m_wallet_descriptor.range_end);\n+}\n+\n+bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_map_keys.size() > 0 || m_map_crypted_keys.size() > 0;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime() const\n+{\n+    return 0;\n+}\n+\n+size_t DescriptorScriptPubKeyMan::KeypoolCountExternalKeys() const\n+{\n+    if (m_internal) {\n+        return 0;\n+    }\n+    return GetKeyPoolSize();\n+}\n+\n+unsigned int DescriptorScriptPubKeyMan::GetKeyPoolSize() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.range_end - m_wallet_descriptor.next_index;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.creation_time;\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!m_wallet_descriptor.descriptor->ExpandFromCache(index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) return nullptr;\n+\n+    if (include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        assert(m_wallet_descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r399709671",
      "id" : 399709671,
      "in_reply_to_id" : 399687251,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcwOTY3MQ==",
      "original_commit_id" : "d034592cf87d5ac8cea02c0edd4d50134be88c87",
      "original_line" : 1905,
      "original_position" : 469,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 383349764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399709671",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> looks like unit test is failing sometimes:\r\n> \r\n> ```\r\n> wallet/test/wallet_tests.cpp(651): error: in \"wallet_tests/wallet_descriptor_test\": exception \"std::ios_base::failure\" raised as expected: validation on the raised exception through predicate \"malformed_descriptor\"\r\n> ```\r\n\r\nNot seeing this fail at anytime.",
      "created_at" : "2020-03-28T21:12:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-605520140",
      "id" : 605520140,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNTUyMDE0MA==",
      "updated_at" : "2020-03-28T21:12:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/605520140",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It was from Travis run at the time of my review.\n\nOn Sat, Mar 28, 2020, 5:12 PM Andrew Chow <notifications@github.com> wrote:\n\n> looks like unit test is failing sometimes:\n>\n> wallet/test/wallet_tests.cpp(651): error: in \"wallet_tests/wallet_descriptor_test\": exception \"std::ios_base::failure\" raised as expected: validation on the raised exception through predicate \"malformed_descriptor\"\n>\n> Not seeing this fail at anytime.\n>\n> â\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-605520140>,\n> or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/ABMAFUZF5UVTJSWLGQKWUKLRJZR3ZANCNFSM4IIZW2TA>\n> .\n>\n",
      "created_at" : "2020-03-29T00:09:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-605536631",
      "id" : 605536631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNTUzNjYzMQ==",
      "updated_at" : "2020-03-29T00:09:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/605536631",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK https://github.com/bitcoin/bitcoin/pull/16528/commits/54be087eebdfefb70c018f67476f2160ae8ca29b\r\n\r\nonly assert cleanup and additional suggested tests",
      "created_at" : "2020-03-30T13:31:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-606000696",
      "id" : 606000696,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjAwMDY5Ng==",
      "updated_at" : "2020-03-30T13:31:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606000696",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "~~direct link to unit test failure: https://travis-ci.org/github/bitcoin/bitcoin/jobs/668186151#L4252~~\r\n\r\nhmm, that's an expected error, I'm not sure why Travis is complaining actually",
      "created_at" : "2020-03-30T13:33:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-606001866",
      "id" : 606001866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjAwMTg2Ng==",
      "updated_at" : "2020-03-30T13:39:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606001866",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I restarted job 4 and 13 as well as AppVeyor; they all fail again.\r\n\r\nI get the same error on macOS:\r\n```\r\nwallet/test/wallet_tests.cpp:651: error: in \"wallet_tests/wallet_descriptor_test\": exception \"std::ios_base::failure\" raised as expected: validation on the raised exception through predicate \"malformed_descriptor\"\r\n```",
      "created_at" : "2020-03-30T14:15:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-606025615",
      "id" : 606025615,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjAyNTYxNQ==",
      "updated_at" : "2020-03-30T15:41:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606025615",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased this on master to see if that fixes the travis failures. Also added a change to that test to make it less restrictive so hopefully it passes now.",
      "created_at" : "2020-03-30T16:53:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-606116845",
      "id" : 606116845,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjExNjg0NQ==",
      "updated_at" : "2020-03-30T16:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606116845",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r400833941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400833941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 3f5e0bfc5dc2ea37223c1e5820c66a5ce11d6b81: clang on macOS complains about this `std::move`, and afaik there's no need for it, because the result of `GetSigningProvider()` is an `rvalue`. Ditto for SignMessage (70345ca67f42ce49b764024f5c62bf8a9a7bd188).\r\n\r\n```\r\nwallet/scriptpubkeyman.cpp:1927:58: warning: moving a temporary object prevents copy elision [-Wpessimizing-move]\r\n        std::unique_ptr<FlatSigningProvider> coin_keys = std::move(GetSigningProvider(coin_pair.second.out.scriptPubKey, true));\r\n                                                         ^\r\nwallet/scriptpubkeyman.cpp:1927:58: note: remove std::move call here\r\n        std::unique_ptr<FlatSigningProvider> coin_keys = std::move(GetSigningProvider(coin_pair.second.out.scriptPubKey, true));\r\n                                                         ^~~~~~~~~~                                                           ~\r\n```",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-31T11:20:17Z",
      "diff_hunk" : "@@ -1913,7 +1913,16 @@ bool DescriptorScriptPubKeyMan::CanProvide(const CScript& script, SignatureData&\n \n bool DescriptorScriptPubKeyMan::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n {\n-    return false;\n+    std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+    for (const auto& coin_pair : coins) {\n+        std::unique_ptr<FlatSigningProvider> coin_keys = std::move(GetSigningProvider(coin_pair.second.out.scriptPubKey, true));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r400833941",
      "id" : 400833941,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgzMzk0MQ==",
      "original_commit_id" : "3f5e0bfc5dc2ea37223c1e5820c66a5ce11d6b81",
      "original_line" : 1918,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 384635173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400833941",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> IsSpentKey()\r\n\r\nRight, there is even a TODO for descriptor wallets in the function. It's a good time to get rid of that TODO.",
      "created_at" : "2020-03-31T13:21:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-606623230",
      "id" : 606623230,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjYyMzIzMA==",
      "updated_at" : "2020-03-31T13:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606623230",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r400919253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400919253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the boolean arg should be `sign` to avoid the assertion failure mentioned by @Sjors ",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-31T13:37:11Z",
      "diff_hunk" : "@@ -1497,3 +1493,622 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsSingleType() &&\n+           m_wallet_descriptor.descriptor->IsRange() &&\n+           (HavePrivateKeys() || m_wallet_descriptor.next_index < m_wallet_descriptor.range_end);\n+}\n+\n+bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_map_keys.size() > 0 || m_map_crypted_keys.size() > 0;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime() const\n+{\n+    return 0;\n+}\n+\n+size_t DescriptorScriptPubKeyMan::KeypoolCountExternalKeys() const\n+{\n+    if (m_internal) {\n+        return 0;\n+    }\n+    return GetKeyPoolSize();\n+}\n+\n+unsigned int DescriptorScriptPubKeyMan::GetKeyPoolSize() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.range_end - m_wallet_descriptor.next_index;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.creation_time;\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!m_wallet_descriptor.descriptor->ExpandFromCache(index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) return nullptr;\n+\n+    if (include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        bool expanded = m_wallet_descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys);\n+        assert(expanded);\n+    }\n+\n+    return out_keys;\n+}\n+\n+std::unique_ptr<SigningProvider> DescriptorScriptPubKeyMan::GetSolvingProvider(const CScript& script) const\n+{\n+    return GetSigningProvider(script, false);\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanProvide(const CScript& script, SignatureData& sigdata)\n+{\n+    return IsMine(script);\n+}\n+\n+bool DescriptorScriptPubKeyMan::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+    for (const auto& coin_pair : coins) {\n+        std::unique_ptr<FlatSigningProvider> coin_keys = std::move(GetSigningProvider(coin_pair.second.out.scriptPubKey, true));\n+        if (!coin_keys) {\n+            continue;\n+        }\n+        *keys = Merge(*keys, *coin_keys);\n+    }\n+\n+    return ::SignTransaction(tx, keys.get(), coins, sighash, input_errors);\n+}\n+\n+SigningResult DescriptorScriptPubKeyMan::SignMessage(const std::string& message, const PKHash& pkhash, std::string& str_sig) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = std::move(GetSigningProvider(GetScriptForDestination(pkhash), true));\n+    if (!keys) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    CKeyID key_id(pkhash);\n+    CKey key;\n+    if (!keys->GetKey(key_id, key)) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    if (!MessageSign(key, message, str_sig)) {\n+        return SigningResult::SIGNING_FAILED;\n+    }\n+    return SigningResult::OK;\n+}\n+\n+TransactionError DescriptorScriptPubKeyMan::FillPSBT(PartiallySignedTransaction& psbtx, int sighash_type, bool sign, bool bip32derivs) const\n+{\n+    for (unsigned int i = 0; i < psbtx.tx->vin.size(); ++i) {\n+        const CTxIn& txin = psbtx.tx->vin[i];\n+        PSBTInput& input = psbtx.inputs.at(i);\n+\n+        if (PSBTInputSigned(input)) {\n+            continue;\n+        }\n+\n+        // Verify input looks sane. This will check that we have at most one uxto, witness or non-witness.\n+        if (!input.IsSane()) {\n+            return TransactionError::INVALID_PSBT;\n+        }\n+\n+        // Get the Sighash type\n+        if (sign && input.sighash_type > 0 && input.sighash_type != sighash_type) {\n+            return TransactionError::SIGHASH_MISMATCH;\n+        }\n+\n+        // Get the scriptPubKey to know which SigningProvider to use\n+        CScript script;\n+        if (!input.witness_utxo.IsNull()) {\n+            script = input.witness_utxo.scriptPubKey;\n+        } else if (input.non_witness_utxo) {\n+            if (txin.prevout.n >= input.non_witness_utxo->vout.size()) {\n+                return TransactionError::MISSING_INPUTS;\n+            }\n+            script = input.non_witness_utxo->vout[txin.prevout.n].scriptPubKey;\n+        } else {\n+            // There's no UTXO so we can just skip this now\n+            continue;\n+        }\n+        SignatureData sigdata;\n+        input.FillSignatureData(sigdata);\n+\n+        std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(script, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r400919253",
      "id" : 400919253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkxOTI1Mw==",
      "original_commit_id" : "f2c3e36479d6265b60d7d1682c704f9302a7457c",
      "original_line" : 1992,
      "original_position" : 555,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 384739739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400919253",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401170132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401170132"
         }
      },
      "author_association" : "MEMBER",
      "body" : "out of date comment",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-31T19:45:28Z",
      "diff_hunk" : "@@ -740,22 +747,31 @@ bool CWallet::IsSpentKey(const uint256& hash, unsigned int n) const\n     const CWalletTx* srctx = GetWalletTx(hash);\n     if (srctx) {\n         assert(srctx->tx->vout.size() > n);\n-        LegacyScriptPubKeyMan* spk_man = GetLegacyScriptPubKeyMan();\n-        // When descriptor wallets arrive, these additional checks are\n-        // likely superfluous and can be optimized out\n-        assert(spk_man != nullptr);\n-        for (const auto& keyid : GetAffectedKeys(srctx->tx->vout[n].scriptPubKey, *spk_man)) {\n-            WitnessV0KeyHash wpkh_dest(keyid);\n-            if (GetDestData(wpkh_dest, \"used\", nullptr)) {\n-                return true;\n-            }\n-            ScriptHash sh_wpkh_dest(GetScriptForDestination(wpkh_dest));\n-            if (GetDestData(sh_wpkh_dest, \"used\", nullptr)) {\n-                return true;\n-            }\n-            PKHash pkh_dest(keyid);\n-            if (GetDestData(pkh_dest, \"used\", nullptr)) {\n-                return true;\n+        CTxDestination dest;\n+        if (!ExtractDestination(srctx->tx->vout[n].scriptPubKey, dest)) {\n+            return false;\n+        }\n+        if (GetDestData(dest, \"used\", nullptr)) {\n+            return true;\n+        }\n+        if (IsLegacy()) {\n+            LegacyScriptPubKeyMan* spk_man = GetLegacyScriptPubKeyMan();\n+            // When descriptor wallets arrive, these additional checks are",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401170132",
      "id" : 401170132,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3MDEzMg==",
      "original_commit_id" : "3da39d72a8b8919ad57693cad71c993d1e115463",
      "original_line" : 759,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 385050375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401170132",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401170437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401170437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIRC gcc used to complain about this. But it seems not anymore, so I've removed these too.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-31T19:46:03Z",
      "diff_hunk" : "@@ -1913,7 +1913,16 @@ bool DescriptorScriptPubKeyMan::CanProvide(const CScript& script, SignatureData&\n \n bool DescriptorScriptPubKeyMan::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n {\n-    return false;\n+    std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+    for (const auto& coin_pair : coins) {\n+        std::unique_ptr<FlatSigningProvider> coin_keys = std::move(GetSigningProvider(coin_pair.second.out.scriptPubKey, true));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401170437",
      "id" : 401170437,
      "in_reply_to_id" : 400833941,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3MDQzNw==",
      "original_commit_id" : "3f5e0bfc5dc2ea37223c1e5820c66a5ce11d6b81",
      "original_line" : 1918,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 385050765,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401170437",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401170491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401170491"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-31T19:46:09Z",
      "diff_hunk" : "@@ -1497,3 +1493,622 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsSingleType() &&\n+           m_wallet_descriptor.descriptor->IsRange() &&\n+           (HavePrivateKeys() || m_wallet_descriptor.next_index < m_wallet_descriptor.range_end);\n+}\n+\n+bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_map_keys.size() > 0 || m_map_crypted_keys.size() > 0;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime() const\n+{\n+    return 0;\n+}\n+\n+size_t DescriptorScriptPubKeyMan::KeypoolCountExternalKeys() const\n+{\n+    if (m_internal) {\n+        return 0;\n+    }\n+    return GetKeyPoolSize();\n+}\n+\n+unsigned int DescriptorScriptPubKeyMan::GetKeyPoolSize() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.range_end - m_wallet_descriptor.next_index;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.creation_time;\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!m_wallet_descriptor.descriptor->ExpandFromCache(index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) return nullptr;\n+\n+    if (include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        bool expanded = m_wallet_descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys);\n+        assert(expanded);\n+    }\n+\n+    return out_keys;\n+}\n+\n+std::unique_ptr<SigningProvider> DescriptorScriptPubKeyMan::GetSolvingProvider(const CScript& script) const\n+{\n+    return GetSigningProvider(script, false);\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanProvide(const CScript& script, SignatureData& sigdata)\n+{\n+    return IsMine(script);\n+}\n+\n+bool DescriptorScriptPubKeyMan::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+    for (const auto& coin_pair : coins) {\n+        std::unique_ptr<FlatSigningProvider> coin_keys = std::move(GetSigningProvider(coin_pair.second.out.scriptPubKey, true));\n+        if (!coin_keys) {\n+            continue;\n+        }\n+        *keys = Merge(*keys, *coin_keys);\n+    }\n+\n+    return ::SignTransaction(tx, keys.get(), coins, sighash, input_errors);\n+}\n+\n+SigningResult DescriptorScriptPubKeyMan::SignMessage(const std::string& message, const PKHash& pkhash, std::string& str_sig) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = std::move(GetSigningProvider(GetScriptForDestination(pkhash), true));\n+    if (!keys) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    CKeyID key_id(pkhash);\n+    CKey key;\n+    if (!keys->GetKey(key_id, key)) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    if (!MessageSign(key, message, str_sig)) {\n+        return SigningResult::SIGNING_FAILED;\n+    }\n+    return SigningResult::OK;\n+}\n+\n+TransactionError DescriptorScriptPubKeyMan::FillPSBT(PartiallySignedTransaction& psbtx, int sighash_type, bool sign, bool bip32derivs) const\n+{\n+    for (unsigned int i = 0; i < psbtx.tx->vin.size(); ++i) {\n+        const CTxIn& txin = psbtx.tx->vin[i];\n+        PSBTInput& input = psbtx.inputs.at(i);\n+\n+        if (PSBTInputSigned(input)) {\n+            continue;\n+        }\n+\n+        // Verify input looks sane. This will check that we have at most one uxto, witness or non-witness.\n+        if (!input.IsSane()) {\n+            return TransactionError::INVALID_PSBT;\n+        }\n+\n+        // Get the Sighash type\n+        if (sign && input.sighash_type > 0 && input.sighash_type != sighash_type) {\n+            return TransactionError::SIGHASH_MISMATCH;\n+        }\n+\n+        // Get the scriptPubKey to know which SigningProvider to use\n+        CScript script;\n+        if (!input.witness_utxo.IsNull()) {\n+            script = input.witness_utxo.scriptPubKey;\n+        } else if (input.non_witness_utxo) {\n+            if (txin.prevout.n >= input.non_witness_utxo->vout.size()) {\n+                return TransactionError::MISSING_INPUTS;\n+            }\n+            script = input.non_witness_utxo->vout[txin.prevout.n].scriptPubKey;\n+        } else {\n+            // There's no UTXO so we can just skip this now\n+            continue;\n+        }\n+        SignatureData sigdata;\n+        input.FillSignatureData(sigdata);\n+\n+        std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(script, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401170491",
      "id" : 401170491,
      "in_reply_to_id" : 400919253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3MDQ5MQ==",
      "original_commit_id" : "f2c3e36479d6265b60d7d1682c704f9302a7457c",
      "original_line" : 1992,
      "original_position" : 555,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 385050818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401170491",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fixed the `IsSpentKey()` issue.",
      "created_at" : "2020-03-31T19:46:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-606836269",
      "id" : 606836269,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjgzNjI2OQ==",
      "updated_at" : "2020-03-31T19:46:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606836269",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401187582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401187582"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-03-31T20:16:40Z",
      "diff_hunk" : "@@ -740,22 +747,31 @@ bool CWallet::IsSpentKey(const uint256& hash, unsigned int n) const\n     const CWalletTx* srctx = GetWalletTx(hash);\n     if (srctx) {\n         assert(srctx->tx->vout.size() > n);\n-        LegacyScriptPubKeyMan* spk_man = GetLegacyScriptPubKeyMan();\n-        // When descriptor wallets arrive, these additional checks are\n-        // likely superfluous and can be optimized out\n-        assert(spk_man != nullptr);\n-        for (const auto& keyid : GetAffectedKeys(srctx->tx->vout[n].scriptPubKey, *spk_man)) {\n-            WitnessV0KeyHash wpkh_dest(keyid);\n-            if (GetDestData(wpkh_dest, \"used\", nullptr)) {\n-                return true;\n-            }\n-            ScriptHash sh_wpkh_dest(GetScriptForDestination(wpkh_dest));\n-            if (GetDestData(sh_wpkh_dest, \"used\", nullptr)) {\n-                return true;\n-            }\n-            PKHash pkh_dest(keyid);\n-            if (GetDestData(pkh_dest, \"used\", nullptr)) {\n-                return true;\n+        CTxDestination dest;\n+        if (!ExtractDestination(srctx->tx->vout[n].scriptPubKey, dest)) {\n+            return false;\n+        }\n+        if (GetDestData(dest, \"used\", nullptr)) {\n+            return true;\n+        }\n+        if (IsLegacy()) {\n+            LegacyScriptPubKeyMan* spk_man = GetLegacyScriptPubKeyMan();\n+            // When descriptor wallets arrive, these additional checks are",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401187582",
      "id" : 401187582,
      "in_reply_to_id" : 401170132,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4NzU4Mg==",
      "original_commit_id" : "3da39d72a8b8919ad57693cad71c993d1e115463",
      "original_line" : 759,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 385071488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401187582",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK https://github.com/bitcoin/bitcoin/pull/16528/commits/7ea9f0fb848e3ccc69e05b4c1bad465e73bc1963",
      "created_at" : "2020-03-31T21:12:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-606878414",
      "id" : 606878414,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjg3ODQxNA==",
      "updated_at" : "2020-03-31T21:12:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606878414",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401742484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401742484"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit 1dd95d7e91fb31ee97cff2aa0f1ccfd820e78e1e: missing p in \"master rivate key\"",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-01T16:20:58Z",
      "diff_hunk" : "@@ -1578,6 +1578,73 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401742484",
      "id" : 401742484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc0MjQ4NA==",
      "original_commit_id" : "1dd95d7e91fb31ee97cff2aa0f1ccfd820e78e1e",
      "original_line" : 1635,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 385745845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401742484",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401744548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401744548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 1dd95d7e91fb31ee97cff2aa0f1ccfd820e78e1e IIUC the descriptor is stored as `wpkh(xpub/84'/0'/0'/0/*)` which means it can only be expanded with the aid of the master private key. Why not expand the account level xpub(s), so you can store it as `wpkh([84'/0'/0']xpub/0/*)`?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-01T16:23:53Z",
      "diff_hunk" : "@@ -1578,6 +1578,73 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401744548",
      "id" : 401744548,
      "line" : 1828,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc0NDU0OA==",
      "original_commit_id" : "1dd95d7e91fb31ee97cff2aa0f1ccfd820e78e1e",
      "original_line" : 1828,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 358,
      "pull_request_review_id" : 385745845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401744548",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401761133"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401761133"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We would then have to store the private key at the account level too. With the xpub cache, this isn't a problem as it can always be expanded using the cached xpub.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-01T16:49:15Z",
      "diff_hunk" : "@@ -1578,6 +1578,73 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401761133",
      "id" : 401761133,
      "in_reply_to_id" : 401744548,
      "line" : 1828,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc2MTEzMw==",
      "original_commit_id" : "1dd95d7e91fb31ee97cff2aa0f1ccfd820e78e1e",
      "original_line" : 1828,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 358,
      "pull_request_review_id" : 385768546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401761133",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401900296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401900296"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-01T20:49:05Z",
      "diff_hunk" : "@@ -1578,6 +1578,73 @@ bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const\n     }\n }\n \n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master rivate key failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r401900296",
      "id" : 401900296,
      "in_reply_to_id" : 401742484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkwMDI5Ng==",
      "original_commit_id" : "1dd95d7e91fb31ee97cff2aa0f1ccfd820e78e1e",
      "original_line" : 1635,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 385938249,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401900296",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Turns out `IsSpentKey` was not fully fixed. I've added an additional check for `HavePrivateKeys` before trying to do `ExpandPrivate`.",
      "created_at" : "2020-04-01T20:49:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-607482620",
      "id" : 607482620,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNzQ4MjYyMA==",
      "updated_at" : "2020-04-01T20:49:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/607482620",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "So I've just realized that existing multisig workflows are completely non-functional under descriptor wallets. If you make a multisig that includes a key that a descriptor wallet has, it won't be able to sign that multisig. This is because the multisig script does not match any of the scripts produced by the descriptors so none of the `DescriptorScriptPubKeyMan`s return true for `CanProvide` and therefore do not attempt to sign. Furthermore, private keys cannot currently be exported, and we currently require all private keys to be present to import a descriptor with private keys. So you couldn't even create a descriptor containing your private key(s) and import that.\r\n\r\nOne possible solution is to simply have every `ScriptPubKeyMan` sign always, regardless of `CanProvide`. But this runs into the whole key mutation thing we are trying to avoid. It would then be possible to have a key for one address type be able to sign for a different address type for the same key. At least the wallet would not be watching for such a mutation. But I suppose the whole multisig thing is effectively abusing mutating keys like that.\r\n\r\nAny other suggestions?",
      "created_at" : "2020-04-01T22:26:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-607520569",
      "id" : 607520569,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNzUyMDU2OQ==",
      "updated_at" : "2020-04-01T22:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/607520569",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "from IRC:\r\n\r\n```\r\n<instagibbs> It seems like a very reasonable use-case to support.\r\n<instagibbs> Core-generated key being in a multisig :)\r\n<achow101> my original thoughts about the multisig stuff would be you have 2 wallets, one generated normally, and another watch only one for the multisig. so you then use psbt and multiwallet\r\n<instagibbs> what's the hold-up on export? feature creep?\r\n<achow101> security questions about unhardened derivation\r\n<instagibbs> oh im overthinking, use-case is supported, *if* you can get the account-level xpub\r\n<instagibbs> i can't recall what your PR supports\r\n<achow101> currently no exports at all whatoever\r\n<instagibbs> ok so I think public descriptor export is a thing we'd want to support\r\nachow101> yeah\r\n<achow101> that'll be next\r\n```",
      "created_at" : "2020-04-02T00:38:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-607557463",
      "id" : 607557463,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNzU1NzQ2Mw==",
      "updated_at" : "2020-04-02T00:38:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/607557463",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've changed it to try signing with all `ScriptPubKeyMan`s.",
      "created_at" : "2020-04-02T01:11:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-607565518",
      "id" : 607565518,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNzU2NTUxOA==",
      "updated_at" : "2020-04-02T01:11:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/607565518",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> One possible solution is to simply have every ScriptPubKeyMan sign always, regardless of CanProvide. But this runs into the whole key mutation thing we are trying to avoid. It would then be possible to have a key for one address type be able to sign for a different address type for the same key. At least the wallet would not be watching for such a mutation. But I suppose the whole multisig thing is effectively abusing mutating keys like that.\r\n\r\nI'm not a fan of this. I think a wallet should only sign for scripts that derive from its descriptors. Let's just support exporting account level xpubs for the multisig use case. We can later add a convenience RPC that, given external xpub(s), produces a multisig with itself and imports those descriptors.",
      "created_at" : "2020-04-02T08:40:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-607706100",
      "id" : 607706100,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNzcwNjEwMA==",
      "updated_at" : "2020-04-02T08:40:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/607706100",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors I think signing eagerly is fine provided it doesn't somehow expand \"is mine\" definition in any way or otherwise include ways to trick the user.",
      "created_at" : "2020-04-02T12:57:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-607830177",
      "id" : 607830177,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNzgzMDE3Nw==",
      "updated_at" : "2020-04-02T12:57:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/607830177",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK https://github.com/bitcoin/bitcoin/pull/16528/commits/4fac5c2b382135a86e4c66c05a2abdd912174a50\r\n\r\nthe \"attempt signing with all\" changes actually make the code easier to read as well",
      "created_at" : "2020-04-02T13:16:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-607840538",
      "id" : 607840538,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNzg0MDUzOA==",
      "updated_at" : "2020-04-02T13:16:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/607840538",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've made hopefully that last major change to this. I had to fix `FillPSBT` because the earlier change wasn't actually signing multisig PSBTs either. The change for that is that we are also going to hold in memory all of the pubkeys that were produced during descriptor expansion. This is done during `SetCache` and `TopUp` when the descriptor is expanded. `GetSigningProvider` is modified and overloaded to also accept a pubkey. This is so that the descriptor can be expanded at the correct index for a given pubkey, regardless of the scripts that pubkey was attached too.\r\n\r\nThis now allows `FillPSBT` to use the pubkeys given in the the `hd_keypaths` to get a `SigningProvider` with private keys in order to sign the PSBT.\r\n\r\nThe other big change that I made was to the tests. I've changed how the tests are being setup so that the whole thing can be more generic and be slightly easier and cleaner to update additional tests to work with descriptor wallets. I've also enabled `--descriptors` for `wallet_avoidreuse.py`, `rpc_createmultisig.py`, `wallet_hd.py`, and `rpc_psbt.py`. These additional tests should cover the bugs that we have found so far (guess how I've found a couple of them). Additionally, to make these tests work, I've `RPCOverloadWrapper` which wraps the RPC and overloads the `importprivkey`, `importaddress`, `importpubkey`, and `addmultisigaddress` RPCs. This works for both cli and `AuthServiceProxy`. For non-descriptor wallets, we use the actual RPC commands. For descriptor wallets, it turns the RPC arguments into something that works with `importdescriptors`. It's similar to what we did to the `generate` RPC in `test_node.py`.\r\n\r\nI've replaced a few instances of `dumpprivkey` with `ECKey` from `test_framework/key.py` which can generate a private key. So we use this along with a few new functions to convert that into WIF to do some of the things that `dumpprivkey` was being used for.\r\n\r\nTo avoid code churn in test cases themselves, I've modified `setup_nodes` in `test_framework.py` to create the wallets using `createwallet`. So nodes will always start initially with `-nowallet` and have any specific wallets added via `createwallet`. This gives us the ability to create a default wallet that is a descriptor wallet so we don't need to put things to choose/create the correct descriptor wallet throughout the tests. This particular change also fixes a bug(?) in our wallet creation code that wasn't allowing the creation of a default wallet (wallet with the empty string as the name) when a default wallet didn't already exist.\r\n\r\n***\r\n\r\nI'll continue to investigate the remaining tests and trying to get them to work with descriptor wallets. The goal is to get all of them to pass so that descriptor wallets can become the default wallet type. This will help this PR as it will uncover bugs as already done. But I think most of those issues have already been identified.",
      "created_at" : "2020-04-03T03:19:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-608207218",
      "id" : 608207218,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwODIwNzIxOA==",
      "updated_at" : "2020-04-03T04:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/608207218",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Another issue I have with \"blindly\" signing something for which you don't have an exact descriptor, is that change detection doesn't work.",
      "created_at" : "2020-04-03T12:40:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-608411217",
      "id" : 608411217,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwODQxMTIxNw==",
      "updated_at" : "2020-04-03T12:40:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/608411217",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I'm not a fan of this. I think a wallet should only sign for scripts that derive from its descriptors. Let's just support exporting account level xpubs for the multisig use case. We can later add a convenience RPC that, given external xpub(s), produces a multisig with itself and imports those descriptors.\r\n\r\nExporting xpubs doesn't help with signing. The crux of this issue is that we only use the private keys of the `ScriptPubKeyMan` for the particular `scriptPubKey` that is being signed. So even if you imported a multisig descriptor into a wallet that has some private keys for it, we still wouldn't be able to sign because that particular descriptor doesn't have the private keys for signing.\r\n\r\n> Another issue I have with \"blindly\" signing something for which you don't have an exact descriptor, is that change detection doesn't work.\r\n\r\nI don't think change detection matters here. We already don't do change detection when doing signing with the RPCs. Changing how this signing works does not affect IsMine at all. And I don't think this has an effect on hardware wallets either.\r\n\r\n***\r\n\r\nAn alternative solution would be to have a `SigningProvider` at the wallet level which is shared by all `ScriptPubKeyMan`s. But this is a much larger change and becomes way more complicated with deriving keys on the fly from descriptors as we want to do now.",
      "created_at" : "2020-04-03T16:29:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-608537544",
      "id" : 608537544,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwODUzNzU0NA==",
      "updated_at" : "2020-04-03T16:31:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/608537544",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I guess it doesn't matter too much.\r\n\r\n>  even if you imported a multisig descriptor into a wallet that has some private keys for it, we still wouldn't be able to sign because that particular descriptor doesn't have the private keys for signing\r\n\r\nThat's a good point. What about signing everything that's `IsMine`? Alternatively, a boolean that opts into this more broad signing behaviour.\r\n\r\n> We already don't do change detection when doing signing with the RPCs.\r\n\r\nTrue, and we don't really know what a user intended when there's multiple outputs. We could add a  `walletanalyzepsbt` feature for that later.\r\n\r\nFor the GUI, I suppose we can add a change address safety feature on top of #18027, when loading a PSBT.",
      "created_at" : "2020-04-03T17:58:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-608580172",
      "id" : 608580172,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwODU4MDE3Mg==",
      "updated_at" : "2020-04-03T17:58:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/608580172",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r404076184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/404076184"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The index matters, I think you mean:\r\n\r\n\"It doesn't matter which of many valid indexes the pubkey has, we just need an index where we can derive it and it's private key\"",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-06T13:08:33Z",
      "diff_hunk" : "@@ -1497,3 +1493,672 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter what index the pubkey has, we just need an index where we can derive it and it's private key",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r404076184",
      "id" : 404076184,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA3NjE4NA==",
      "original_commit_id" : "e75d67d237241c094f425a999a38e00b5fbba635",
      "original_line" : 1687,
      "original_position" : 250,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 388230497,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/404076184",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r404076311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/404076311"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The index matters, I think you mean:\r\n\r\n\"It doesn't matter which of many valid indexes the pubkey has, we just need an index where we can derive it and it's private key\"",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-06T13:08:43Z",
      "diff_hunk" : "@@ -1497,3 +1493,672 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter what index the pubkey has, we just need an index where we can derive it and it's private key\n+                continue;\n+            }\n+            m_map_pubkeys[pubkey] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master private key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsSingleType() &&\n+           m_wallet_descriptor.descriptor->IsRange() &&\n+           (HavePrivateKeys() || m_wallet_descriptor.next_index < m_wallet_descriptor.range_end);\n+}\n+\n+bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_map_keys.size() > 0 || m_map_crypted_keys.size() > 0;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime() const\n+{\n+    return 0;\n+}\n+\n+size_t DescriptorScriptPubKeyMan::KeypoolCountExternalKeys() const\n+{\n+    if (m_internal) {\n+        return 0;\n+    }\n+    return GetKeyPoolSize();\n+}\n+\n+unsigned int DescriptorScriptPubKeyMan::GetKeyPoolSize() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.range_end - m_wallet_descriptor.next_index;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.creation_time;\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    return GetSigningProvider(index, include_private);\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CPubKey& pubkey) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find index of the pubkey\n+    auto it = m_map_pubkeys.find(pubkey);\n+    if (it == m_map_pubkeys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Always try to get the signing provider with private keys. This function should only be called during signing anyways\n+    return GetSigningProvider(index, true);\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(int32_t index, bool include_private) const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!m_wallet_descriptor.descriptor->ExpandFromCache(index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) return nullptr;\n+\n+    if (HavePrivateKeys() && include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        bool expanded = m_wallet_descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys);\n+        assert(expanded);\n+    }\n+\n+    return out_keys;\n+}\n+\n+std::unique_ptr<SigningProvider> DescriptorScriptPubKeyMan::GetSolvingProvider(const CScript& script) const\n+{\n+    return GetSigningProvider(script, false);\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanProvide(const CScript& script, SignatureData& sigdata)\n+{\n+    return IsMine(script);\n+}\n+\n+bool DescriptorScriptPubKeyMan::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+    for (const auto& coin_pair : coins) {\n+        std::unique_ptr<FlatSigningProvider> coin_keys = GetSigningProvider(coin_pair.second.out.scriptPubKey, true);\n+        if (!coin_keys) {\n+            continue;\n+        }\n+        *keys = Merge(*keys, *coin_keys);\n+    }\n+\n+    return ::SignTransaction(tx, keys.get(), coins, sighash, input_errors);\n+}\n+\n+SigningResult DescriptorScriptPubKeyMan::SignMessage(const std::string& message, const PKHash& pkhash, std::string& str_sig) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(GetScriptForDestination(pkhash), true);\n+    if (!keys) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    CKeyID key_id(pkhash);\n+    CKey key;\n+    if (!keys->GetKey(key_id, key)) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    if (!MessageSign(key, message, str_sig)) {\n+        return SigningResult::SIGNING_FAILED;\n+    }\n+    return SigningResult::OK;\n+}\n+\n+TransactionError DescriptorScriptPubKeyMan::FillPSBT(PartiallySignedTransaction& psbtx, int sighash_type, bool sign, bool bip32derivs) const\n+{\n+    for (unsigned int i = 0; i < psbtx.tx->vin.size(); ++i) {\n+        const CTxIn& txin = psbtx.tx->vin[i];\n+        PSBTInput& input = psbtx.inputs.at(i);\n+\n+        if (PSBTInputSigned(input)) {\n+            continue;\n+        }\n+\n+        // Verify input looks sane. This will check that we have at most one uxto, witness or non-witness.\n+        if (!input.IsSane()) {\n+            return TransactionError::INVALID_PSBT;\n+        }\n+\n+        // Get the Sighash type\n+        if (sign && input.sighash_type > 0 && input.sighash_type != sighash_type) {\n+            return TransactionError::SIGHASH_MISMATCH;\n+        }\n+\n+        // Get the scriptPubKey to know which SigningProvider to use\n+        CScript script;\n+        if (!input.witness_utxo.IsNull()) {\n+            script = input.witness_utxo.scriptPubKey;\n+        } else if (input.non_witness_utxo) {\n+            if (txin.prevout.n >= input.non_witness_utxo->vout.size()) {\n+                return TransactionError::MISSING_INPUTS;\n+            }\n+            script = input.non_witness_utxo->vout[txin.prevout.n].scriptPubKey;\n+        } else {\n+            // There's no UTXO so we can just skip this now\n+            continue;\n+        }\n+        SignatureData sigdata;\n+        input.FillSignatureData(sigdata);\n+\n+        std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+        std::unique_ptr<FlatSigningProvider> script_keys = GetSigningProvider(script, sign);\n+        if (script_keys) {\n+            *keys = Merge(*keys, *script_keys);\n+        } else {\n+            // Maybe there are pubkeys listed that we can sign for\n+            script_keys = MakeUnique<FlatSigningProvider>();\n+            for (const auto& pk_pair : input.hd_keypaths) {\n+                const CPubKey& pubkey = pk_pair.first;\n+                std::unique_ptr<FlatSigningProvider> pk_keys = GetSigningProvider(pubkey);\n+                if (pk_keys) {\n+                    *keys = Merge(*keys, *pk_keys);\n+                }\n+            }\n+        }\n+\n+        SignPSBTInput(HidingSigningProvider(keys.get(), !sign, !bip32derivs), psbtx, i, sighash_type);\n+    }\n+\n+    // Fill in the bip32 keypaths and redeemscripts for the outputs so that hardware wallets can identify change\n+    for (unsigned int i = 0; i < psbtx.tx->vout.size(); ++i) {\n+        std::unique_ptr<SigningProvider> keys = GetSolvingProvider(psbtx.tx->vout.at(i).scriptPubKey);\n+        if (!keys) {\n+            continue;\n+        }\n+        UpdatePSBTOutput(HidingSigningProvider(keys.get(), true, !bip32derivs), psbtx, i);\n+    }\n+\n+    return TransactionError::OK;\n+}\n+\n+std::unique_ptr<CKeyMetadata> DescriptorScriptPubKeyMan::GetMetadata(const CTxDestination& dest) const\n+{\n+    std::unique_ptr<SigningProvider> provider = GetSigningProvider(GetScriptForDestination(dest));\n+    if (provider) {\n+        KeyOriginInfo orig;\n+        CKeyID key_id = GetKeyForDestination(*provider, dest);\n+        if (provider->GetKeyOrigin(key_id, orig)) {\n+            LOCK(cs_desc_man);\n+            std::unique_ptr<CKeyMetadata> meta = MakeUnique<CKeyMetadata>();\n+            meta->key_origin = orig;\n+            meta->has_key_origin = true;\n+            meta->nCreateTime = m_wallet_descriptor.creation_time;\n+            return meta;\n+        }\n+    }\n+    return nullptr;\n+}\n+\n+uint256 DescriptorScriptPubKeyMan::GetID() const\n+{\n+    LOCK(cs_desc_man);\n+    std::string desc_str = m_wallet_descriptor.descriptor->ToString();\n+    uint256 id;\n+    CSHA256().Write((unsigned char*)desc_str.data(), desc_str.size()).Finalize(id.begin());\n+    return id;\n+}\n+\n+void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)\n+{\n+    this->m_address_type = type;\n+    this->m_internal = internal;\n+}\n+\n+void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n+{\n+    LOCK(cs_desc_man);\n+    m_wallet_descriptor.cache = cache;\n+    for (int32_t i = m_wallet_descriptor.range_start; i < m_wallet_descriptor.range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            if (m_map_script_pub_keys.count(script) != 0) {\n+                throw std::runtime_error(strprintf(\"Error: Already loaded script at index %d as being at index %d\", i, m_map_script_pub_keys[script]));\n+            }\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter what index the pubkey has, we just need an index where we can derive it and it's private key",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r404076311",
      "id" : 404076311,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA3NjMxMQ==",
      "original_commit_id" : "e75d67d237241c094f425a999a38e00b5fbba635",
      "original_line" : 2107,
      "original_position" : 670,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 388230497,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/404076311",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r404226781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/404226781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-06T16:29:52Z",
      "diff_hunk" : "@@ -1497,3 +1493,672 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter what index the pubkey has, we just need an index where we can derive it and it's private key",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r404226781",
      "id" : 404226781,
      "in_reply_to_id" : 404076184,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIyNjc4MQ==",
      "original_commit_id" : "e75d67d237241c094f425a999a38e00b5fbba635",
      "original_line" : 1687,
      "original_position" : 250,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 388419538,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/404226781",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r404226835"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/404226835"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-06T16:29:57Z",
      "diff_hunk" : "@@ -1497,3 +1493,672 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)\n+        {\n+            const CPubKey &pubkey = (*mi).second.first;\n+            const std::vector<unsigned char> &crypted_secret = (*mi).second.second;\n+            CKey key;\n+            if (!DecryptKey(master_key, crypted_secret, pubkey, key))\n+            {\n+                keyFail = true;\n+                break;\n+            }\n+            keyPass = true;\n+            if (m_decryption_thoroughly_checked)\n+                break;\n+        }\n+        if (keyPass && keyFail)\n+        {\n+            LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+            throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+        }\n+        if (keyFail || (!keyPass && !accept_no_keys))\n+            return false;\n+        m_decryption_thoroughly_checked = true;\n+    }\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter what index the pubkey has, we just need an index where we can derive it and it's private key\n+                continue;\n+            }\n+            m_map_pubkeys[pubkey] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master private key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsSingleType() &&\n+           m_wallet_descriptor.descriptor->IsRange() &&\n+           (HavePrivateKeys() || m_wallet_descriptor.next_index < m_wallet_descriptor.range_end);\n+}\n+\n+bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_map_keys.size() > 0 || m_map_crypted_keys.size() > 0;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime() const\n+{\n+    return 0;\n+}\n+\n+size_t DescriptorScriptPubKeyMan::KeypoolCountExternalKeys() const\n+{\n+    if (m_internal) {\n+        return 0;\n+    }\n+    return GetKeyPoolSize();\n+}\n+\n+unsigned int DescriptorScriptPubKeyMan::GetKeyPoolSize() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.range_end - m_wallet_descriptor.next_index;\n+}\n+\n+int64_t DescriptorScriptPubKeyMan::GetTimeFirstKey() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.creation_time;\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CScript& script, bool include_private) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find the index of the script\n+    auto it = m_map_script_pub_keys.find(script);\n+    if (it == m_map_script_pub_keys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    return GetSigningProvider(index, include_private);\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(const CPubKey& pubkey) const\n+{\n+    LOCK(cs_desc_man);\n+\n+    // Find index of the pubkey\n+    auto it = m_map_pubkeys.find(pubkey);\n+    if (it == m_map_pubkeys.end()) {\n+        return nullptr;\n+    }\n+    int32_t index = it->second;\n+\n+    // Always try to get the signing provider with private keys. This function should only be called during signing anyways\n+    return GetSigningProvider(index, true);\n+}\n+\n+std::unique_ptr<FlatSigningProvider> DescriptorScriptPubKeyMan::GetSigningProvider(int32_t index, bool include_private) const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    // Get the scripts, keys, and key origins for this script\n+    std::unique_ptr<FlatSigningProvider> out_keys = MakeUnique<FlatSigningProvider>();\n+    std::vector<CScript> scripts_temp;\n+    if (!m_wallet_descriptor.descriptor->ExpandFromCache(index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) return nullptr;\n+\n+    if (HavePrivateKeys() && include_private) {\n+        FlatSigningProvider master_provider;\n+        master_provider.keys = GetKeys();\n+        bool expanded = m_wallet_descriptor.descriptor->ExpandPrivate(index, master_provider, *out_keys);\n+        assert(expanded);\n+    }\n+\n+    return out_keys;\n+}\n+\n+std::unique_ptr<SigningProvider> DescriptorScriptPubKeyMan::GetSolvingProvider(const CScript& script) const\n+{\n+    return GetSigningProvider(script, false);\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanProvide(const CScript& script, SignatureData& sigdata)\n+{\n+    return IsMine(script);\n+}\n+\n+bool DescriptorScriptPubKeyMan::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+    for (const auto& coin_pair : coins) {\n+        std::unique_ptr<FlatSigningProvider> coin_keys = GetSigningProvider(coin_pair.second.out.scriptPubKey, true);\n+        if (!coin_keys) {\n+            continue;\n+        }\n+        *keys = Merge(*keys, *coin_keys);\n+    }\n+\n+    return ::SignTransaction(tx, keys.get(), coins, sighash, input_errors);\n+}\n+\n+SigningResult DescriptorScriptPubKeyMan::SignMessage(const std::string& message, const PKHash& pkhash, std::string& str_sig) const\n+{\n+    std::unique_ptr<FlatSigningProvider> keys = GetSigningProvider(GetScriptForDestination(pkhash), true);\n+    if (!keys) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    CKeyID key_id(pkhash);\n+    CKey key;\n+    if (!keys->GetKey(key_id, key)) {\n+        return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;\n+    }\n+\n+    if (!MessageSign(key, message, str_sig)) {\n+        return SigningResult::SIGNING_FAILED;\n+    }\n+    return SigningResult::OK;\n+}\n+\n+TransactionError DescriptorScriptPubKeyMan::FillPSBT(PartiallySignedTransaction& psbtx, int sighash_type, bool sign, bool bip32derivs) const\n+{\n+    for (unsigned int i = 0; i < psbtx.tx->vin.size(); ++i) {\n+        const CTxIn& txin = psbtx.tx->vin[i];\n+        PSBTInput& input = psbtx.inputs.at(i);\n+\n+        if (PSBTInputSigned(input)) {\n+            continue;\n+        }\n+\n+        // Verify input looks sane. This will check that we have at most one uxto, witness or non-witness.\n+        if (!input.IsSane()) {\n+            return TransactionError::INVALID_PSBT;\n+        }\n+\n+        // Get the Sighash type\n+        if (sign && input.sighash_type > 0 && input.sighash_type != sighash_type) {\n+            return TransactionError::SIGHASH_MISMATCH;\n+        }\n+\n+        // Get the scriptPubKey to know which SigningProvider to use\n+        CScript script;\n+        if (!input.witness_utxo.IsNull()) {\n+            script = input.witness_utxo.scriptPubKey;\n+        } else if (input.non_witness_utxo) {\n+            if (txin.prevout.n >= input.non_witness_utxo->vout.size()) {\n+                return TransactionError::MISSING_INPUTS;\n+            }\n+            script = input.non_witness_utxo->vout[txin.prevout.n].scriptPubKey;\n+        } else {\n+            // There's no UTXO so we can just skip this now\n+            continue;\n+        }\n+        SignatureData sigdata;\n+        input.FillSignatureData(sigdata);\n+\n+        std::unique_ptr<FlatSigningProvider> keys = MakeUnique<FlatSigningProvider>();\n+        std::unique_ptr<FlatSigningProvider> script_keys = GetSigningProvider(script, sign);\n+        if (script_keys) {\n+            *keys = Merge(*keys, *script_keys);\n+        } else {\n+            // Maybe there are pubkeys listed that we can sign for\n+            script_keys = MakeUnique<FlatSigningProvider>();\n+            for (const auto& pk_pair : input.hd_keypaths) {\n+                const CPubKey& pubkey = pk_pair.first;\n+                std::unique_ptr<FlatSigningProvider> pk_keys = GetSigningProvider(pubkey);\n+                if (pk_keys) {\n+                    *keys = Merge(*keys, *pk_keys);\n+                }\n+            }\n+        }\n+\n+        SignPSBTInput(HidingSigningProvider(keys.get(), !sign, !bip32derivs), psbtx, i, sighash_type);\n+    }\n+\n+    // Fill in the bip32 keypaths and redeemscripts for the outputs so that hardware wallets can identify change\n+    for (unsigned int i = 0; i < psbtx.tx->vout.size(); ++i) {\n+        std::unique_ptr<SigningProvider> keys = GetSolvingProvider(psbtx.tx->vout.at(i).scriptPubKey);\n+        if (!keys) {\n+            continue;\n+        }\n+        UpdatePSBTOutput(HidingSigningProvider(keys.get(), true, !bip32derivs), psbtx, i);\n+    }\n+\n+    return TransactionError::OK;\n+}\n+\n+std::unique_ptr<CKeyMetadata> DescriptorScriptPubKeyMan::GetMetadata(const CTxDestination& dest) const\n+{\n+    std::unique_ptr<SigningProvider> provider = GetSigningProvider(GetScriptForDestination(dest));\n+    if (provider) {\n+        KeyOriginInfo orig;\n+        CKeyID key_id = GetKeyForDestination(*provider, dest);\n+        if (provider->GetKeyOrigin(key_id, orig)) {\n+            LOCK(cs_desc_man);\n+            std::unique_ptr<CKeyMetadata> meta = MakeUnique<CKeyMetadata>();\n+            meta->key_origin = orig;\n+            meta->has_key_origin = true;\n+            meta->nCreateTime = m_wallet_descriptor.creation_time;\n+            return meta;\n+        }\n+    }\n+    return nullptr;\n+}\n+\n+uint256 DescriptorScriptPubKeyMan::GetID() const\n+{\n+    LOCK(cs_desc_man);\n+    std::string desc_str = m_wallet_descriptor.descriptor->ToString();\n+    uint256 id;\n+    CSHA256().Write((unsigned char*)desc_str.data(), desc_str.size()).Finalize(id.begin());\n+    return id;\n+}\n+\n+void DescriptorScriptPubKeyMan::SetType(OutputType type, bool internal)\n+{\n+    this->m_address_type = type;\n+    this->m_internal = internal;\n+}\n+\n+void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n+{\n+    LOCK(cs_desc_man);\n+    m_wallet_descriptor.cache = cache;\n+    for (int32_t i = m_wallet_descriptor.range_start; i < m_wallet_descriptor.range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            if (m_map_script_pub_keys.count(script) != 0) {\n+                throw std::runtime_error(strprintf(\"Error: Already loaded script at index %d as being at index %d\", i, m_map_script_pub_keys[script]));\n+            }\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter what index the pubkey has, we just need an index where we can derive it and it's private key",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r404226835",
      "id" : 404226835,
      "in_reply_to_id" : 404076311,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIyNjgzNQ==",
      "original_commit_id" : "e75d67d237241c094f425a999a38e00b5fbba635",
      "original_line" : 2107,
      "original_position" : 670,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 388419608,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/404226835",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The travis failures should be fixed. I'm not sure what's wrong with appveyor, but it seems to be unrelated.",
      "created_at" : "2020-04-06T16:30:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-609899991",
      "id" : 609899991,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwOTg5OTk5MQ==",
      "updated_at" : "2020-04-06T16:30:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/609899991",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK https://github.com/bitcoin/bitcoin/pull/16528/commits/7fee7cd034b9c38244a6e284bd3c719482b01a46 with comment changes requested. Still need to review tests top to bottom once things settle.",
      "created_at" : "2020-04-06T16:32:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-609901316",
      "id" : 609901316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwOTkwMTMxNg==",
      "updated_at" : "2020-04-06T16:32:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/609901316",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Made a few more test framework changes, particularly to have `createwallet` make wallets based on the startup options unless overridden. This avoids having to put `descriptors=self.options.descriptors` in every `createwallet` call. Also changed `wallet_importdescriptors.py` to not rely on `dumpprivkey`.",
      "created_at" : "2020-04-07T18:41:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-610555013",
      "id" : 610555013,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMDU1NTAxMw==",
      "updated_at" : "2020-04-07T18:41:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/610555013",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've changed `importdescriptors` to allow importing descriptors that have some but not all private keys. A test has also been added for this. Since this change requires `ExpandPrivate` to expand all the way, The commit that changed `ExpandPrivate` to return a bool has been dropped.",
      "created_at" : "2020-04-10T00:05:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-611810309",
      "id" : 611810309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMTgxMDMwOQ==",
      "updated_at" : "2020-04-10T00:05:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/611810309",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Writeup at https://gist.github.com/achow101/94d889715afd49181f8efdca1f9faa25 is fantastic. Really helpful to me, and probably others who want to catch up with this. Better than anything else I've read because it focuses more on _why_ than _what_ of the design.\r\n\r\nWould be good to link to from project https://github.com/bitcoin/bitcoin/projects/12 and maybe move to the dev wiki",
      "created_at" : "2020-04-10T08:33:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-611938384",
      "id" : 611938384,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMTkzODM4NA==",
      "updated_at" : "2020-04-10T08:33:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/611938384",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I've changed importdescriptors to allow importing descriptors that have some but not all private keys.\r\n\r\nSo this is going to make certain actions strange, due to the various places we use `IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)` to trigger PSBT vs \"sign and send\" type behavior:\r\n\r\n1) bumpfee: Instead of returning a PSBT, it will attempt to sign and send the transaction, and fail\r\n2) QT: Flow I think will let you click \"send\" and whatnot, and it will simply fail to sign the transaction. User won't be able to craft a PSBT from the GUI.\r\n\r\nI think in the ideal case any wallet where the user cannot fully sign would take the current `IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)` style behavior which hands the user a (partially signed)PSBT to sign elsewhere.\r\n\r\n@ryanofsky notes in your document a similar strategy I suggested of allowing the \"I expect to be able to fully sign for this descriptor\"-ness in the descriptor record itself.",
      "created_at" : "2020-04-10T13:28:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-612028267",
      "id" : 612028267,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjAyODI2Nw==",
      "updated_at" : "2020-04-10T13:28:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612028267",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> So this is going to make certain actions strange, due to the various places we use `IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)` to trigger PSBT vs \"sign and send\" type behavior:\r\n\r\nThis is just an uninformed opinion, but it would seem less surprising to me for the \"Disable Private Keys\" option you see creating a wallet to just be a safeguard against unintentionally generating and importing private keys, and not something signing/psbt code would look at directly.\r\n",
      "created_at" : "2020-04-10T15:35:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-612083154",
      "id" : 612083154,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjA4MzE1NA==",
      "updated_at" : "2020-04-10T15:35:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612083154",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > I've changed importdescriptors to allow importing descriptors that have some but not all private keys.\r\n> \r\n> So this is going to make certain actions strange, due to the various places we use `IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)` to trigger PSBT vs \"sign and send\" type behavior:\r\n> \r\n>     1. bumpfee: Instead of returning a PSBT, it will attempt to sign and send the transaction, and fail\r\n> \r\n>     2. QT: Flow I think will let you click \"send\" and whatnot, and it will simply fail to sign the transaction. User won't be able to craft a PSBT from the GUI.\r\n> \r\n> \r\n> I think in the ideal case any wallet where the user cannot fully sign would take the current `IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)` style behavior which hands the user a (partially signed)PSBT to sign elsewhere.\r\n\r\nInstead of branching on `IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)`, wouldn't it be better to just always make a PSBT, try to sign it, and if it does fully sign, then return the txid, otherwise return the PSBT? I think that would be more robust.\r\n\r\nDon't existing multisigs have the same problem anyways? If you do `addmultisigaddress` and one of the keys is yours, it wouldn't be able to sign either.\r\n\r\n> @ryanofsky notes in your document a similar strategy I suggested of allowing the \"I expect to be able to fully sign for this descriptor\"-ness in the descriptor record itself.\r\n\r\nThis strategy still results in a mixed wallet which, as mentioned before, has issues and is what I'm trying to avoid. But I'm also not sure how that would help with the issues you mentioned above or if it's actually useful to do that.\r\n\r\n",
      "created_at" : "2020-04-10T17:21:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-612130632",
      "id" : 612130632,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjEzMDYzMg==",
      "updated_at" : "2020-04-10T17:23:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612130632",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Since descriptor wallets is still experimental and not the default, I'm find with some of the weird, less supported, use/edge cases not entirely working. These will need to be fixed in the future, but I would like to at least get the basic functionality in. Especially when those cases require more significant concentrated thought, e.g. at a CoreDev event where we can all sit around a whiteboard and talk for a few hours.\r\n\r\nI've pushed a change that will add a warning if not all private keys are provided. It will let users know that there could be unexpected errors by doing such an import. Also, hopefully I fixed travis.",
      "created_at" : "2020-04-10T18:35:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-612160983",
      "id" : 612160983,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjE2MDk4Mw==",
      "updated_at" : "2020-04-10T18:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612160983",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "On IRC, @sipa points out that we can just use separate RPCs and buttons for bumpfee, PSBT GUI, and whatever else is switching on `WALLET_FLAG_DISABLE_PRIVATE_KEYS` instead of having functions that change their behavior based on that flag.",
      "created_at" : "2020-04-10T19:39:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-612186478",
      "id" : 612186478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjE4NjQ3OA==",
      "updated_at" : "2020-04-10T19:39:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612186478",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406967004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406967004"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this function should be renamed. It is confusing that there is a function by the same name in `DescriptorScriptPubKeyMan` that actually returns a `WalletDescriptor` while this one returns `DescriptorScriptPubKeyMan`. It becomes especially apparent in `ProcessDescriptorImport` where those functions are called within a few lines of code.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-10T22:21:54Z",
      "diff_hunk" : "@@ -1231,6 +1231,12 @@ class CWallet final : public WalletStorage, private interfaces::Chain::Notificat\n \n     //! Create new DescriptorScriptPubKeyMans and add them to the wallet\n     void SetupDescriptorScriptPubKeyMans();\n+\n+    //! Return the DescriptorScriptPubKeyMan for a WalletDescriptor if it is already in the wallet\n+    DescriptorScriptPubKeyMan* GetWalletDescriptor(const WalletDescriptor& desc) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406967004",
      "id" : 406967004,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NzAwNA==",
      "original_commit_id" : "a7a814fb59e05423611ff96f9494eaed85cc289c",
      "original_line" : 1236,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 391689544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406967004",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406969347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406969347"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think these brackets can be removed since they only exclude the return",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-10T22:31:17Z",
      "diff_hunk" : "@@ -1553,12 +1549,61 @@ isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n \n bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n {\n-    return false;\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406969347",
      "id" : 406969347,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2OTM0Nw==",
      "original_commit_id" : "6edf8249ee458d440dc136cb10c5498d32aab96f",
      "original_line" : 1550,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 391689544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406969347",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406970255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406970255"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this would deserve a comment on why this is always 0. I also thought maybe the `ScriptPubKeyMan` class could do this instead of `GetTime()` so that it would not need to be overridden but I think that would not help clarity of the code.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-10T22:35:03Z",
      "diff_hunk" : "@@ -1852,7 +1852,7 @@ bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n \n int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime() const\n {\n-    return GetTime();\n+    return 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406970255",
      "id" : 406970255,
      "line" : 1874,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk3MDI1NQ==",
      "original_commit_id" : "7cd657406174743281aac05da60dad3f0803f8b8",
      "original_line" : 1874,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 404,
      "pull_request_review_id" : 391689544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406970255",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406973362"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406973362"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I found this comment more confusing than helpful here because it explains something about the descriptor code in a non-descriptor code branch. I think it could just be removed.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-10T22:48:26Z",
      "diff_hunk" : "@@ -3809,10 +3813,15 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         if (!(wallet_creation_flags & (WALLET_FLAG_DISABLE_PRIVATE_KEYS | WALLET_FLAG_BLANK_WALLET))) {\n             LOCK(walletInstance->cs_wallet);\n-            for (auto spk_man : walletInstance->GetActiveScriptPubKeyMans()) {\n-                if (!spk_man->SetupGeneration()) {\n-                    error = _(\"Unable to generate initial keys\").translated;\n-                    return nullptr;\n+            if (walletInstance->IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+                walletInstance->SetupDescriptorScriptPubKeyMans();\n+            } else {\n+                // SetupDescriptorScriptPubKeyMans already calls SetupGeneration for us",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406973362",
      "id" : 406973362,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk3MzM2Mg==",
      "original_commit_id" : "4049fe4c83689ac47567d497f629e92e855a7235",
      "original_line" : 3819,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 391689544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406973362",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406973806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406973806"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Typo: `ExpandPrvate`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-10T22:50:24Z",
      "diff_hunk" : "@@ -1459,3 +1459,302 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrvate to check if private keys are available for all pubkeys",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r406973806",
      "id" : 406973806,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk3MzgwNg==",
      "original_commit_id" : "a7a814fb59e05423611ff96f9494eaed85cc289c",
      "original_line" : 1536,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 391689544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/406973806",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tACK d42a6edd89a313ee25683226a9aa573087de1223\r\n\r\nI have manually created a normal descriptor wallet with a private key and a watch-only wallet for multisig descriptor and tested basic functionalities like sending, receiving and info calls. Also ran all automated tests locally.\r\n\r\nRegarding the latest discussion about the current limitations: I think this can be merged as is but I would suggest adding a warning to `createwallet` which mentions current limitations around exports and differences to legacy wallets like unhardened derivation. That is probably not the right way to use the warnings, I think, but it makes it much harder to miss this information.\r\n\r\n",
      "created_at" : "2020-04-17T21:05:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-615463409",
      "id" : 615463409,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNTQ2MzQwOQ==",
      "updated_at" : "2020-04-17T21:05:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/615463409",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023740"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Renamed it to `GetDescriptorScriptPubKeyMan`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-20T00:09:25Z",
      "diff_hunk" : "@@ -1231,6 +1231,12 @@ class CWallet final : public WalletStorage, private interfaces::Chain::Notificat\n \n     //! Create new DescriptorScriptPubKeyMans and add them to the wallet\n     void SetupDescriptorScriptPubKeyMans();\n+\n+    //! Return the DescriptorScriptPubKeyMan for a WalletDescriptor if it is already in the wallet\n+    DescriptorScriptPubKeyMan* GetWalletDescriptor(const WalletDescriptor& desc) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023740",
      "id" : 411023740,
      "in_reply_to_id" : 406967004,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAyMzc0MA==",
      "original_commit_id" : "a7a814fb59e05423611ff96f9494eaed85cc289c",
      "original_line" : 1236,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 396079792,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023740",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-20T00:09:31Z",
      "diff_hunk" : "@@ -1553,12 +1549,61 @@ isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n \n bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n {\n-    return false;\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023748",
      "id" : 411023748,
      "in_reply_to_id" : 406969347,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAyMzc0OA==",
      "original_commit_id" : "6edf8249ee458d440dc136cb10c5498d32aab96f",
      "original_line" : 1550,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 396079803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023748",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023778"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-20T00:09:41Z",
      "diff_hunk" : "@@ -1852,7 +1852,7 @@ bool DescriptorScriptPubKeyMan::HavePrivateKeys() const\n \n int64_t DescriptorScriptPubKeyMan::GetOldestKeyPoolTime() const\n {\n-    return GetTime();\n+    return 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023778",
      "id" : 411023778,
      "in_reply_to_id" : 406970255,
      "line" : 1874,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAyMzc3OA==",
      "original_commit_id" : "7cd657406174743281aac05da60dad3f0803f8b8",
      "original_line" : 1874,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 404,
      "pull_request_review_id" : 396079823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023778",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023823"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Moved it and added a better one here.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-20T00:09:52Z",
      "diff_hunk" : "@@ -3809,10 +3813,15 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         if (!(wallet_creation_flags & (WALLET_FLAG_DISABLE_PRIVATE_KEYS | WALLET_FLAG_BLANK_WALLET))) {\n             LOCK(walletInstance->cs_wallet);\n-            for (auto spk_man : walletInstance->GetActiveScriptPubKeyMans()) {\n-                if (!spk_man->SetupGeneration()) {\n-                    error = _(\"Unable to generate initial keys\").translated;\n-                    return nullptr;\n+            if (walletInstance->IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+                walletInstance->SetupDescriptorScriptPubKeyMans();\n+            } else {\n+                // SetupDescriptorScriptPubKeyMans already calls SetupGeneration for us",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023823",
      "id" : 411023823,
      "in_reply_to_id" : 406973362,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAyMzgyMw==",
      "original_commit_id" : "4049fe4c83689ac47567d497f629e92e855a7235",
      "original_line" : 3819,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 396079851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023823",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-20T00:09:59Z",
      "diff_hunk" : "@@ -1459,3 +1459,302 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrvate to check if private keys are available for all pubkeys",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r411023852",
      "id" : 411023852,
      "in_reply_to_id" : 406973806,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAyMzg1Mg==",
      "original_commit_id" : "a7a814fb59e05423611ff96f9494eaed85cc289c",
      "original_line" : 1536,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 396079864,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/411023852",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Re-ACK 837aba9a3680922acbf383df37485d53790b19ae\r\n\r\nOnly changes were addressing my nit comments. Not sure why the build is failing, I don't see the error locally.",
      "created_at" : "2020-04-21T19:59:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-617382554",
      "id" : 617382554,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzM4MjU1NA==",
      "updated_at" : "2020-04-21T19:59:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617382554",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Only changes were addressing my nit comments. Not sure why the build is failing, I don't see the error locally.\r\n\r\nLooks like there's a hidden conflict with master. I've rebased this and fixed the issues.",
      "created_at" : "2020-04-21T21:10:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-617416081",
      "id" : 617416081,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzQxNjA4MQ==",
      "updated_at" : "2020-04-21T21:10:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617416081",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re-ACK 4c841356c2296cc011bcd678ba71ccba28129a67\r\n\r\nOnly code-changes since last review were small fixups in `wallet/rpcdump.cpp` and `test/functional/wallet_keypool.py`.",
      "created_at" : "2020-04-22T15:14:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-617841418",
      "id" : 617841418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzg0MTQxOA==",
      "updated_at" : "2020-04-22T15:14:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617841418",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413240431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413240431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In b4c6a40ac46459a679dabbb84b168101e6cd6c5f I suggested `for (const auto& mi : m_map_crypted_keys) {`, which you did, but not it's gone again in `DescriptorScriptPubKeyMan` (it's there in `LegacyScriptPubKeyMan `). Probably not worth touching the code for, but you may to check if you didn't lose anything else.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T18:58:17Z",
      "diff_hunk" : "@@ -1552,12 +1552,61 @@ isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n \n bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n {\n-    return false;\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413240431",
      "id" : 413240431,
      "in_reply_to_id" : 399487630,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI0MDQzMQ==",
      "original_commit_id" : "8ae9bf12395b558bf53cc0b8d2f4056424908585",
      "original_line" : 1558,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 398487187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413240431",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413240854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413240854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In  b4c6a40, in case you have to touch this, please use brackets or move `return false` directly after `if`.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T18:58:58Z",
      "diff_hunk" : "@@ -1553,12 +1547,61 @@ isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n \n bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n {\n-    return false;\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413240854",
      "id" : 413240854,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI0MDg1NA==",
      "original_commit_id" : "b4c6a40ac46459a679dabbb84b168101e6cd6c5f",
      "original_line" : 1553,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 398487187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413240854",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413308224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413308224"
         }
      },
      "author_association" : "MEMBER",
      "body" : "- Use the `UNIX_EPOCH_TIME` constant when describing UNIX epoch time or timestamps\r\n- s/Time to start/Time from which to start/\r\n\r\ne.g.\r\n```diff\r\n- \"Time to start rescanning the blockchain for this descriptor, in seconds since epoch (Jan 1 1970 GMT).\\n\"\r\n+ \"Time from which to start rescanning the blockchain for this descriptor, in \" + UNIX_EPOCH_TIME + \"\\n\"\r\n```",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T20:31:14Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp, during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exists but related transactions are still missing.\\n\",\n+                {\n+                    {\"requests\", RPCArg::Type::ARR, RPCArg::Optional::NO, \"Data to be imported\",\n+                        {\n+                            {\"\", RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, \"\",\n+                                {\n+                                    {\"desc\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Descriptor to import.\"},\n+                                    {\"active\", RPCArg::Type::BOOL, /* default */ \"false\", \"Set this descriptor to be the active descriptor for the corresponding output type/externality\"},\n+                                    {\"range\", RPCArg::Type::RANGE, RPCArg::Optional::OMITTED, \"If a ranged descriptor is used, this specifies the end or the range (in the form [begin,end]) to import\"},\n+                                    {\"next_index\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"If a ranged descriptor is set to active, this specifies the next index to generate addresses from\"},\n+                                    {\"timestamp\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"Time to start rescanning the blockchain for this descriptor, in seconds since epoch (Jan 1 1970 GMT).\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413308224",
      "id" : 413308224,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwODIyNA==",
      "original_commit_id" : "4c841356c2296cc011bcd678ba71ccba28129a67",
      "original_line" : 1618,
      "original_position" : 165,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 398562629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413308224",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413315022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413315022"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: s/timestamp,/timestamp;/",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T20:42:22Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp, during that time, other rpc calls\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413315022",
      "id" : 413315022,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMxNTAyMg==",
      "original_commit_id" : "4c841356c2296cc011bcd678ba71ccba28129a67",
      "original_line" : 1607,
      "original_position" : 154,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 398562629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413315022",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413315262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413315262"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/exists/exist/",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T20:42:47Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp, during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exists but related transactions are still missing.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413315262",
      "id" : 413315262,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMxNTI2Mg==",
      "original_commit_id" : "4c841356c2296cc011bcd678ba71ccba28129a67",
      "original_line" : 1608,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 398562629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413315262",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365313"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, it seems like I've accidentally applied that change to `LegacyScriptPubKeyMan`. Applied these changes to the right place.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T22:06:26Z",
      "diff_hunk" : "@@ -1552,12 +1552,61 @@ isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n \n bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n {\n-    return false;\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;\n+\n+        bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+        bool keyFail = false;\n+        CryptedKeyMap::const_iterator mi = m_map_crypted_keys.begin();\n+        for (; mi != m_map_crypted_keys.end(); ++mi)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365313",
      "id" : 413365313,
      "in_reply_to_id" : 399487630,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2NTMxMw==",
      "original_commit_id" : "8ae9bf12395b558bf53cc0b8d2f4056424908585",
      "original_line" : 1558,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 398623854,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365313",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365384"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365384"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T22:06:36Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp, during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exists but related transactions are still missing.\\n\",\n+                {\n+                    {\"requests\", RPCArg::Type::ARR, RPCArg::Optional::NO, \"Data to be imported\",\n+                        {\n+                            {\"\", RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, \"\",\n+                                {\n+                                    {\"desc\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Descriptor to import.\"},\n+                                    {\"active\", RPCArg::Type::BOOL, /* default */ \"false\", \"Set this descriptor to be the active descriptor for the corresponding output type/externality\"},\n+                                    {\"range\", RPCArg::Type::RANGE, RPCArg::Optional::OMITTED, \"If a ranged descriptor is used, this specifies the end or the range (in the form [begin,end]) to import\"},\n+                                    {\"next_index\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"If a ranged descriptor is set to active, this specifies the next index to generate addresses from\"},\n+                                    {\"timestamp\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"Time to start rescanning the blockchain for this descriptor, in seconds since epoch (Jan 1 1970 GMT).\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365384",
      "id" : 413365384,
      "in_reply_to_id" : 413308224,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2NTM4NA==",
      "original_commit_id" : "4c841356c2296cc011bcd678ba71ccba28129a67",
      "original_line" : 1618,
      "original_position" : 165,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 398623931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365384",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365432"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T22:06:40Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp, during that time, other rpc calls\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365432",
      "id" : 413365432,
      "in_reply_to_id" : 413315022,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2NTQzMg==",
      "original_commit_id" : "4c841356c2296cc011bcd678ba71ccba28129a67",
      "original_line" : 1607,
      "original_position" : 154,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 398623981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365432",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365483"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T22:06:47Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp, during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exists but related transactions are still missing.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365483",
      "id" : 413365483,
      "in_reply_to_id" : 413315262,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2NTQ4Mw==",
      "original_commit_id" : "4c841356c2296cc011bcd678ba71ccba28129a67",
      "original_line" : 1608,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 398624038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365483",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365541"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-22T22:06:54Z",
      "diff_hunk" : "@@ -1553,12 +1547,61 @@ isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n \n bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n {\n-    return false;\n+    {\n+        LOCK(cs_desc_man);\n+        if (!m_map_keys.empty())\n+            return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413365541",
      "id" : 413365541,
      "in_reply_to_id" : 413240854,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2NTU0MQ==",
      "original_commit_id" : "b4c6a40ac46459a679dabbb84b168101e6cd6c5f",
      "original_line" : 1553,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 398624111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413365541",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "In ed01138 locally the following test fails on macOS:\r\n\r\n```\r\n test/functional/wallet_balance.py --descriptors\r\n2020-04-23T07:36:07.090000Z TestFramework (INFO): Initializing test directory /var/folders/h6/qrb4j9vn6530kp7j4ymj934h0000gn/T/bitcoin_func_test_5klxvr5f\r\n2020-04-23T07:36:09.863000Z TestFramework (ERROR): JSONRPC error\r\nTraceback (most recent call last):\r\n  File \"/Users/sjors/dev/bitcoin-desc/test/functional/test_framework/test_framework.py\", line 112, in main\r\n    self.run_test()\r\n  File \"test/functional/wallet_balance.py\", line 62, in run_test\r\n    self.nodes[0].importaddress(ADDRESS_WATCHONLY)\r\n  File \"/Users/sjors/dev/bitcoin-desc/test/functional/test_framework/test_node.py\", line 714, in importaddress\r\n    raise JSONRPCException(res['error'])\r\ntest_framework.authproxy.JSONRPCException: Cannot import descriptor without private keys to a wallet with private keys enabled (-4)\r\n```\r\n\r\nIn case you need to change anything, it would be great if you can rebase, so I resolve a conflict between #17509 and #16549.",
      "created_at" : "2020-04-23T07:37:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-618234765",
      "id" : 618234765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxODIzNDc2NQ==",
      "updated_at" : "2020-04-23T15:29:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/618234765",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413622392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413622392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: here and in `walletdb.h` I'm curious why `ACTIVEEXTERNALSPK` AND `ACTIVEINTERNALSPK` are placed here rather than sorted like the others... maybe sort, or comment why",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T08:34:58Z",
      "diff_hunk" : "@@ -27,8 +27,10 @@ const std::string CRYPTED_KEY{\"ckey\"};\n const std::string CSCRIPT{\"cscript\"};\n const std::string DEFAULTKEY{\"defaultkey\"};\n const std::string DESTDATA{\"destdata\"};\n+const std::string ACTIVEEXTERNALSPK{\"activeexternalspk\"};\n const std::string FLAGS{\"flags\"};\n const std::string HDCHAIN{\"hdchain\"};\n+const std::string ACTIVEINTERNALSPK{\"activeinternalspk\"};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413622392",
      "id" : 413622392,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYyMjM5Mg==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 33,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 398879068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413622392",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413629727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413629727"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit suggestion\r\n```diff\r\n-    std::string key = DBKeys::ACTIVEEXTERNALSPK;\r\n-    if (internal) {\r\n-        key = DBKeys::ACTIVEINTERNALSPK;\r\n-    }\r\n+    std::string key;\r\n+    key = internal ? DBKeys::ACTIVEINTERNALSPK : DBKeys::ACTIVEEXTERNALSPK;\r\n```\r\nlike what you do below line 473",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T08:45:16Z",
      "diff_hunk" : "@@ -179,6 +185,54 @@ bool WalletBatch::WriteMinVersion(int nVersion)\n     return WriteIC(DBKeys::MINVERSION, nVersion);\n }\n \n+bool WalletBatch::WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bool internal)\n+{\n+    std::string key = DBKeys::ACTIVEEXTERNALSPK;\n+    if (internal) {\n+        key = DBKeys::ACTIVEINTERNALSPK;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413629727",
      "id" : 413629727,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYyOTcyNw==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 193,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 398879068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413629727",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413661739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413661739"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe comment here that all must be true for the result to be true.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T09:30:32Z",
      "diff_hunk" : "@@ -1332,8 +1346,8 @@ CAmount CWallet::GetChange(const CTransaction& tx) const\n bool CWallet::IsHDEnabled() const\n {\n     bool result = true;\n-    for (const auto& spk_man_pair : m_spk_managers) {\n-        result &= spk_man_pair.second->IsHDEnabled();\n+    for (const auto& spk_man : GetActiveScriptPubKeyMans()) {\n+        result &= spk_man->IsHDEnabled();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413661739",
      "id" : 413661739,
      "line" : 1351,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY2MTczOQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1351,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 88,
      "pull_request_review_id" : 398879068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413661739",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413722005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413722005"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: s/has/have/",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T11:03:54Z",
      "diff_hunk" : "@@ -1497,3 +1497,669 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_keys.empty()) {\n+        return false;\n+    }\n+\n+    bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+    bool keyFail = false;\n+    for (const auto& mi : m_map_crypted_keys) {\n+        const CPubKey &pubkey = mi.second.first;\n+        const std::vector<unsigned char> &crypted_secret = mi.second.second;\n+        CKey key;\n+        if (!DecryptKey(master_key, crypted_secret, pubkey, key)) {\n+            keyFail = true;\n+            break;\n+        }\n+        keyPass = true;\n+        if (m_decryption_thoroughly_checked)\n+            break;\n+    }\n+    if (keyPass && keyFail) {\n+        LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+        throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+    }\n+    if (keyFail || (!keyPass && !accept_no_keys)) {\n+        return false;\n+    }\n+    m_decryption_thoroughly_checked = true;\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter which of many valid indexes the pubkey has, we just need an index where we can derive it and it's private key\n+                continue;\n+            }\n+            m_map_pubkeys[pubkey] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master private key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413722005",
      "id" : 413722005,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMjAwNQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1858,
      "original_position" : 388,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 398879068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413722005",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413732148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413732148"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe just me, but I find the \"With\" part of the name `AddDescriptorKeyWithDB` confusing.\r\n\r\nSome of these additions could use Doxygen comments, e.g. here and SetCrypted, etc.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T11:21:21Z",
      "diff_hunk" : "@@ -477,4 +482,111 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor m_wallet_descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using PubKeyMap = std::map<CPubKey, int32_t>; // Map of pubkeys involved in scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    PubKeyMap m_map_pubkeys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_cached_index = -1;\n+\n+    OutputType m_address_type;\n+    bool m_internal;\n+\n+    KeyMap m_map_keys GUARDED_BY(cs_desc_man);\n+    CryptedKeyMap m_map_crypted_keys GUARDED_BY(cs_desc_man);\n+\n+    bool SetCrypted();\n+\n+    //! keeps track of whether Unlock has run a thorough check before\n+    bool m_decryption_thoroughly_checked = false;\n+\n+    bool AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413732148",
      "id" : 413732148,
      "line" : 510,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczMjE0OA==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 510,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 73,
      "pull_request_review_id" : 398879068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413732148",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413736798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413736798"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why do we not return the result of `batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);` here?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T11:29:19Z",
      "diff_hunk" : "@@ -1497,3 +1497,669 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_keys.empty()) {\n+        return false;\n+    }\n+\n+    bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+    bool keyFail = false;\n+    for (const auto& mi : m_map_crypted_keys) {\n+        const CPubKey &pubkey = mi.second.first;\n+        const std::vector<unsigned char> &crypted_secret = mi.second.second;\n+        CKey key;\n+        if (!DecryptKey(master_key, crypted_secret, pubkey, key)) {\n+            keyFail = true;\n+            break;\n+        }\n+        keyPass = true;\n+        if (m_decryption_thoroughly_checked)\n+            break;\n+    }\n+    if (keyPass && keyFail) {\n+        LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+        throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+    }\n+    if (keyFail || (!keyPass && !accept_no_keys)) {\n+        return false;\n+    }\n+    m_decryption_thoroughly_checked = true;\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter which of many valid indexes the pubkey has, we just need an index where we can derive it and it's private key\n+                continue;\n+            }\n+            m_map_pubkeys[pubkey] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413736798",
      "id" : 413736798,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczNjc5OA==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1775,
      "original_position" : 305,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 398879068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413736798",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413760834"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413760834"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What does \"exp\" stand for in `key_exp_index`, expiry/expired?",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T12:09:51Z",
      "diff_hunk" : "@@ -240,11 +246,19 @@ class WalletBatch\n \n     bool WriteMinVersion(int nVersion);\n \n+    bool WriteDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const CPrivKey& privkey);\n+    bool WriteCryptedDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const std::vector<unsigned char>& secret);\n+    bool WriteDescriptor(const uint256& desc_id, const WalletDescriptor& descriptor);\n+    bool WriteDescriptorDerivedCache(const uint256& desc_id, uint32_t key_exp_index, uint32_t der_index, const CExtPubKey& xpub);\n+    bool WriteDescriptorParentCache(const uint256& desc_id, uint32_t key_exp_index, const CExtPubKey& xpub);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413760834",
      "id" : 413760834,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc2MDgzNA==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 253,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 398879068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413760834",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413762307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413762307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps put `uint32_t der_index` last, so the first two parameters are the same as in `WriteDescriptorParentCache()` on the following line",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T12:12:06Z",
      "diff_hunk" : "@@ -240,11 +246,19 @@ class WalletBatch\n \n     bool WriteMinVersion(int nVersion);\n \n+    bool WriteDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const CPrivKey& privkey);\n+    bool WriteCryptedDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const std::vector<unsigned char>& secret);\n+    bool WriteDescriptor(const uint256& desc_id, const WalletDescriptor& descriptor);\n+    bool WriteDescriptorDerivedCache(const uint256& desc_id, uint32_t key_exp_index, uint32_t der_index, const CExtPubKey& xpub);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413762307",
      "id" : 413762307,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc2MjMwNw==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 252,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 398879068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413762307",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413789802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413789802"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe update getwalletinfo RPCHelpMan that `keypoololdest` is now only displayed for non-descriptor/legacy wallets.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T12:52:56Z",
      "diff_hunk" : "@@ -2471,13 +2472,16 @@ static UniValue getwalletinfo(const JSONRPCRequest& request)\n \n     size_t kpExternalSize = pwallet->KeypoolCountExternalKeys();\n     const auto bal = pwallet->GetBalance();\n+    int64_t kp_oldest = pwallet->GetOldestKeyPoolTime();\n     obj.pushKV(\"walletname\", pwallet->GetName());\n     obj.pushKV(\"walletversion\", pwallet->GetVersion());\n     obj.pushKV(\"balance\", ValueFromAmount(bal.m_mine_trusted));\n     obj.pushKV(\"unconfirmed_balance\", ValueFromAmount(bal.m_mine_untrusted_pending));\n     obj.pushKV(\"immature_balance\", ValueFromAmount(bal.m_mine_immature));\n     obj.pushKV(\"txcount\",       (int)pwallet->mapWallet.size());\n-    obj.pushKV(\"keypoololdest\", pwallet->GetOldestKeyPoolTime());\n+    if (kp_oldest > 0) {\n+        obj.pushKV(\"keypoololdest\", kp_oldest);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413789802",
      "id" : 413789802,
      "line" : 2483,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc4OTgwMg==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 2483,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 39,
      "pull_request_review_id" : 398879068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413789802",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413805809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413805809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/descriptor/descriptors/ (plural like the other error messages, if you change this be sure to update the functional test as well)",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T13:42:34Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413805809",
      "id" : 413805809,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgwNTgwOQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1508,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 399106189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413805809",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413811801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413811801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/Stating whether/Whether/\r\ns/also known as/e.g./",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T13:51:00Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp; during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exist but related transactions are still missing.\\n\",\n+                {\n+                    {\"requests\", RPCArg::Type::ARR, RPCArg::Optional::NO, \"Data to be imported\",\n+                        {\n+                            {\"\", RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, \"\",\n+                                {\n+                                    {\"desc\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Descriptor to import.\"},\n+                                    {\"active\", RPCArg::Type::BOOL, /* default */ \"false\", \"Set this descriptor to be the active descriptor for the corresponding output type/externality\"},\n+                                    {\"range\", RPCArg::Type::RANGE, RPCArg::Optional::OMITTED, \"If a ranged descriptor is used, this specifies the end or the range (in the form [begin,end]) to import\"},\n+                                    {\"next_index\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"If a ranged descriptor is set to active, this specifies the next index to generate addresses from\"},\n+                                    {\"timestamp\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"Time from which to start rescanning the blockchain for this descriptor, in \" + UNIX_EPOCH_TIME + \"\\n\"\n+        \"                                                              Use the string \\\"now\\\" to substitute the current synced blockchain time.\\n\"\n+        \"                                                              \\\"now\\\" can be specified to bypass scanning, for outputs which are known to never have been used, and\\n\"\n+        \"                                                              0 can be specified to scan the entire blockchain. Blocks up to 2 hours before the earliest timestamp\\n\"\n+        \"                                                              of all descriptors being imported will be scanned.\",\n+                                        /* oneline_description */ \"\", {\"timestamp | \\\"now\\\"\", \"integer / string\"}\n+                                    },\n+                                    {\"internal\", RPCArg::Type::BOOL, /* default */ \"false\", \"Stating whether matching outputs should be treated as not incoming payments (also known as change)\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413811801",
      "id" : 413811801,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgxMTgwMQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1625,
      "original_position" : 172,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 399115594,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413811801",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413846027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413846027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could avoid calling `GetImportTimestamp()` twice:\r\n```diff\r\n-                if (scanned_time <= GetImportTimestamp(request, now) || results.at(i).exists(\"error\")) {\r\n+                int64_t import_time = GetImportTimestamp(request, now);\r\n+                if (scanned_time <= import_time || results.at(i).exists(\"error\")) {\r\n                     response.push_back(results.at(i));\r\n                 } else {\r\n                     UniValue result = UniValue(UniValue::VOBJ);\r\n@@ -1739,7 +1740,7 @@ UniValue importdescriptors(const JSONRPCRequest& main_request) {\r\n                                       \"caused by pruning or data corruption (see bitcoind log for details) and could \"\r\n                                       \"be dealt with by downloading and rescanning the relevant blocks (see -reindex \"\r\n                                       \"and -rescan options).\",\r\n-                                GetImportTimestamp(request, now), scanned_time - TIMESTAMP_WINDOW - 1, TIMESTAMP_WINDOW)));\r\n+                                import_time, scanned_time - TIMESTAMP_WINDOW - 1, TIMESTAMP_WINDOW)));\r\n```",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T14:30:34Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp; during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exist but related transactions are still missing.\\n\",\n+                {\n+                    {\"requests\", RPCArg::Type::ARR, RPCArg::Optional::NO, \"Data to be imported\",\n+                        {\n+                            {\"\", RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, \"\",\n+                                {\n+                                    {\"desc\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Descriptor to import.\"},\n+                                    {\"active\", RPCArg::Type::BOOL, /* default */ \"false\", \"Set this descriptor to be the active descriptor for the corresponding output type/externality\"},\n+                                    {\"range\", RPCArg::Type::RANGE, RPCArg::Optional::OMITTED, \"If a ranged descriptor is used, this specifies the end or the range (in the form [begin,end]) to import\"},\n+                                    {\"next_index\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"If a ranged descriptor is set to active, this specifies the next index to generate addresses from\"},\n+                                    {\"timestamp\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"Time from which to start rescanning the blockchain for this descriptor, in \" + UNIX_EPOCH_TIME + \"\\n\"\n+        \"                                                              Use the string \\\"now\\\" to substitute the current synced blockchain time.\\n\"\n+        \"                                                              \\\"now\\\" can be specified to bypass scanning, for outputs which are known to never have been used, and\\n\"\n+        \"                                                              0 can be specified to scan the entire blockchain. Blocks up to 2 hours before the earliest timestamp\\n\"\n+        \"                                                              of all descriptors being imported will be scanned.\",\n+                                        /* oneline_description */ \"\", {\"timestamp | \\\"now\\\"\", \"integer / string\"}\n+                                    },\n+                                    {\"internal\", RPCArg::Type::BOOL, /* default */ \"false\", \"Stating whether matching outputs should be treated as not incoming payments (also known as change)\"},\n+                                    {\"label\", RPCArg::Type::STR, /* default */ \"''\", \"Label to assign to the address, only allowed with internal=false\"},\n+                                },\n+                            },\n+                        },\n+                        \"\\\"requests\\\"\"},\n+                },\n+                RPCResult{\n+                    RPCResult::Type::ARR, \"\", \"Response is an array with the same size as the input that has the execution result\",\n+                    {\n+                        {RPCResult::Type::OBJ, \"\", \"\",\n+                        {\n+                            {RPCResult::Type::BOOL, \"success\", \"\"},\n+                            {RPCResult::Type::ARR, \"warnings\", /* optional */ true, \"\",\n+                            {\n+                                {RPCResult::Type::STR, \"\", \"\"},\n+                            }},\n+                            {RPCResult::Type::OBJ, \"error\", /* optional */ true, \"\",\n+                            {\n+                                {RPCResult::Type::ELISION, \"\", \"JSONRPC error\"},\n+                            }},\n+                        }},\n+                    }\n+                },\n+                RPCExamples{\n+                    HelpExampleCli(\"importdescriptors\", \"'[{ \\\"desc\\\": \\\"<my descriptor>\\\", \\\"timestamp\\\":1455191478, \\\"internal\\\": true }, \"\n+                                          \"{ \\\"desc\\\": \\\"<my desccriptor 2>\\\", \\\"label\\\": \\\"example 2\\\", \\\"timestamp\\\": 1455191480 }]'\") +\n+                    HelpExampleCli(\"importdescriptors\", \"'[{ \\\"desc\\\": \\\"<my descriptor>\\\", \\\"timestamp\\\":1455191478, \\\"active\\\": true, \\\"range\\\": [0,100], \\\"label\\\": \\\"<my bech32 wallet>\\\" }]'\")\n+                },\n+            }.Check(main_request);\n+\n+    //  Make sure wallet is a descriptor wallet\n+    if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"importdescriptors is not available for non-descriptor wallets\");\n+    }\n+\n+    RPCTypeCheck(main_request.params, {UniValue::VARR, UniValue::VOBJ});\n+\n+    WalletRescanReserver reserver(*pwallet);\n+    if (!reserver.reserve()) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"Wallet is currently rescanning. Abort existing rescan or wait.\");\n+    }\n+\n+    const UniValue& requests = main_request.params[0];\n+    const int64_t minimum_timestamp = 1;\n+    int64_t now = 0;\n+    int64_t lowest_timestamp = 0;\n+    bool rescan = false;\n+    UniValue response(UniValue::VARR);\n+    {\n+        auto locked_chain = pwallet->chain().lock();\n+        LOCK(pwallet->cs_wallet);\n+        EnsureWalletIsUnlocked(pwallet);\n+\n+        CHECK_NONFATAL(pwallet->chain().findBlock(pwallet->GetLastBlockHash(), FoundBlock().time(lowest_timestamp).mtpTime(now)));\n+\n+        // Get all timestamps and extract the lowest timestamp\n+        for (const UniValue& request : requests.getValues()) {\n+            // This throws an error if \"timestamp\" doesn't exist\n+            const int64_t timestamp = std::max(GetImportTimestamp(request, now), minimum_timestamp);\n+            const UniValue result = ProcessDescriptorImport(pwallet, request, timestamp);\n+            response.push_back(result);\n+\n+            if (lowest_timestamp > timestamp ) {\n+                lowest_timestamp = timestamp;\n+            }\n+\n+            // If we know the chain tip, and at least one request was successful then allow rescan\n+            if (!rescan && result[\"success\"].get_bool()) {\n+                rescan = true;\n+            }\n+        }\n+        pwallet->ConnectScriptPubKeyManNotifiers();\n+    }\n+\n+    // Rescan the blockchain using the lowest timestamp\n+    if (rescan) {\n+        int64_t scanned_time = pwallet->RescanFromTime(lowest_timestamp, reserver, true /* update */);\n+        {\n+            auto locked_chain = pwallet->chain().lock();\n+            LOCK(pwallet->cs_wallet);\n+            pwallet->ReacceptWalletTransactions();\n+        }\n+\n+        if (pwallet->IsAbortingRescan()) {\n+            throw JSONRPCError(RPC_MISC_ERROR, \"Rescan aborted by user.\");\n+        }\n+\n+        if (scanned_time > lowest_timestamp) {\n+            std::vector<UniValue> results = response.getValues();\n+            response.clear();\n+            response.setArray();\n+\n+            // Compose the response\n+            for (unsigned int i = 0; i < requests.size(); ++i) {\n+                const UniValue& request = requests.getValues().at(i);\n+\n+                // If the descriptor timestamp is within the successfully scanned\n+                // range, or if the import result already has an error set, let\n+                // the result stand unmodified. Otherwise replace the result\n+                // with an error message.\n+                if (scanned_time <= GetImportTimestamp(request, now) || results.at(i).exists(\"error\")) {\n+                    response.push_back(results.at(i));\n+                } else {\n+                    UniValue result = UniValue(UniValue::VOBJ);\n+                    result.pushKV(\"success\", UniValue(false));\n+                    result.pushKV(\n+                        \"error\",\n+                        JSONRPCError(\n+                            RPC_MISC_ERROR,\n+                            strprintf(\"Rescan failed for descriptor with timestamp %d. There was an error reading a \"\n+                                      \"block from time %d, which is after or within %d seconds of key creation, and \"\n+                                      \"could contain transactions pertaining to the desc. As a result, transactions \"\n+                                      \"and coins using this desc may not appear in the wallet. This error could be \"\n+                                      \"caused by pruning or data corruption (see bitcoind log for details) and could \"\n+                                      \"be dealt with by downloading and rescanning the relevant blocks (see -reindex \"\n+                                      \"and -rescan options).\",\n+                                GetImportTimestamp(request, now), scanned_time - TIMESTAMP_WINDOW - 1, TIMESTAMP_WINDOW)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413846027",
      "id" : 413846027,
      "line" : 1746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg0NjAyNw==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1746,
      "original_position" : 289,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 289,
      "pull_request_review_id" : 399157105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413846027",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413849949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413849949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually nvm, the 40 lines of this section are essentially a duplicate of code in `importmulti`. It's outside the scope of this long PR, but they could be de-duped.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T14:35:09Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp; during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exist but related transactions are still missing.\\n\",\n+                {\n+                    {\"requests\", RPCArg::Type::ARR, RPCArg::Optional::NO, \"Data to be imported\",\n+                        {\n+                            {\"\", RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, \"\",\n+                                {\n+                                    {\"desc\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Descriptor to import.\"},\n+                                    {\"active\", RPCArg::Type::BOOL, /* default */ \"false\", \"Set this descriptor to be the active descriptor for the corresponding output type/externality\"},\n+                                    {\"range\", RPCArg::Type::RANGE, RPCArg::Optional::OMITTED, \"If a ranged descriptor is used, this specifies the end or the range (in the form [begin,end]) to import\"},\n+                                    {\"next_index\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"If a ranged descriptor is set to active, this specifies the next index to generate addresses from\"},\n+                                    {\"timestamp\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"Time from which to start rescanning the blockchain for this descriptor, in \" + UNIX_EPOCH_TIME + \"\\n\"\n+        \"                                                              Use the string \\\"now\\\" to substitute the current synced blockchain time.\\n\"\n+        \"                                                              \\\"now\\\" can be specified to bypass scanning, for outputs which are known to never have been used, and\\n\"\n+        \"                                                              0 can be specified to scan the entire blockchain. Blocks up to 2 hours before the earliest timestamp\\n\"\n+        \"                                                              of all descriptors being imported will be scanned.\",\n+                                        /* oneline_description */ \"\", {\"timestamp | \\\"now\\\"\", \"integer / string\"}\n+                                    },\n+                                    {\"internal\", RPCArg::Type::BOOL, /* default */ \"false\", \"Stating whether matching outputs should be treated as not incoming payments (also known as change)\"},\n+                                    {\"label\", RPCArg::Type::STR, /* default */ \"''\", \"Label to assign to the address, only allowed with internal=false\"},\n+                                },\n+                            },\n+                        },\n+                        \"\\\"requests\\\"\"},\n+                },\n+                RPCResult{\n+                    RPCResult::Type::ARR, \"\", \"Response is an array with the same size as the input that has the execution result\",\n+                    {\n+                        {RPCResult::Type::OBJ, \"\", \"\",\n+                        {\n+                            {RPCResult::Type::BOOL, \"success\", \"\"},\n+                            {RPCResult::Type::ARR, \"warnings\", /* optional */ true, \"\",\n+                            {\n+                                {RPCResult::Type::STR, \"\", \"\"},\n+                            }},\n+                            {RPCResult::Type::OBJ, \"error\", /* optional */ true, \"\",\n+                            {\n+                                {RPCResult::Type::ELISION, \"\", \"JSONRPC error\"},\n+                            }},\n+                        }},\n+                    }\n+                },\n+                RPCExamples{\n+                    HelpExampleCli(\"importdescriptors\", \"'[{ \\\"desc\\\": \\\"<my descriptor>\\\", \\\"timestamp\\\":1455191478, \\\"internal\\\": true }, \"\n+                                          \"{ \\\"desc\\\": \\\"<my desccriptor 2>\\\", \\\"label\\\": \\\"example 2\\\", \\\"timestamp\\\": 1455191480 }]'\") +\n+                    HelpExampleCli(\"importdescriptors\", \"'[{ \\\"desc\\\": \\\"<my descriptor>\\\", \\\"timestamp\\\":1455191478, \\\"active\\\": true, \\\"range\\\": [0,100], \\\"label\\\": \\\"<my bech32 wallet>\\\" }]'\")\n+                },\n+            }.Check(main_request);\n+\n+    //  Make sure wallet is a descriptor wallet\n+    if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"importdescriptors is not available for non-descriptor wallets\");\n+    }\n+\n+    RPCTypeCheck(main_request.params, {UniValue::VARR, UniValue::VOBJ});\n+\n+    WalletRescanReserver reserver(*pwallet);\n+    if (!reserver.reserve()) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"Wallet is currently rescanning. Abort existing rescan or wait.\");\n+    }\n+\n+    const UniValue& requests = main_request.params[0];\n+    const int64_t minimum_timestamp = 1;\n+    int64_t now = 0;\n+    int64_t lowest_timestamp = 0;\n+    bool rescan = false;\n+    UniValue response(UniValue::VARR);\n+    {\n+        auto locked_chain = pwallet->chain().lock();\n+        LOCK(pwallet->cs_wallet);\n+        EnsureWalletIsUnlocked(pwallet);\n+\n+        CHECK_NONFATAL(pwallet->chain().findBlock(pwallet->GetLastBlockHash(), FoundBlock().time(lowest_timestamp).mtpTime(now)));\n+\n+        // Get all timestamps and extract the lowest timestamp\n+        for (const UniValue& request : requests.getValues()) {\n+            // This throws an error if \"timestamp\" doesn't exist\n+            const int64_t timestamp = std::max(GetImportTimestamp(request, now), minimum_timestamp);\n+            const UniValue result = ProcessDescriptorImport(pwallet, request, timestamp);\n+            response.push_back(result);\n+\n+            if (lowest_timestamp > timestamp ) {\n+                lowest_timestamp = timestamp;\n+            }\n+\n+            // If we know the chain tip, and at least one request was successful then allow rescan\n+            if (!rescan && result[\"success\"].get_bool()) {\n+                rescan = true;\n+            }\n+        }\n+        pwallet->ConnectScriptPubKeyManNotifiers();\n+    }\n+\n+    // Rescan the blockchain using the lowest timestamp\n+    if (rescan) {\n+        int64_t scanned_time = pwallet->RescanFromTime(lowest_timestamp, reserver, true /* update */);\n+        {\n+            auto locked_chain = pwallet->chain().lock();\n+            LOCK(pwallet->cs_wallet);\n+            pwallet->ReacceptWalletTransactions();\n+        }\n+\n+        if (pwallet->IsAbortingRescan()) {\n+            throw JSONRPCError(RPC_MISC_ERROR, \"Rescan aborted by user.\");\n+        }\n+\n+        if (scanned_time > lowest_timestamp) {\n+            std::vector<UniValue> results = response.getValues();\n+            response.clear();\n+            response.setArray();\n+\n+            // Compose the response\n+            for (unsigned int i = 0; i < requests.size(); ++i) {\n+                const UniValue& request = requests.getValues().at(i);\n+\n+                // If the descriptor timestamp is within the successfully scanned\n+                // range, or if the import result already has an error set, let\n+                // the result stand unmodified. Otherwise replace the result\n+                // with an error message.\n+                if (scanned_time <= GetImportTimestamp(request, now) || results.at(i).exists(\"error\")) {\n+                    response.push_back(results.at(i));\n+                } else {\n+                    UniValue result = UniValue(UniValue::VOBJ);\n+                    result.pushKV(\"success\", UniValue(false));\n+                    result.pushKV(\n+                        \"error\",\n+                        JSONRPCError(\n+                            RPC_MISC_ERROR,\n+                            strprintf(\"Rescan failed for descriptor with timestamp %d. There was an error reading a \"\n+                                      \"block from time %d, which is after or within %d seconds of key creation, and \"\n+                                      \"could contain transactions pertaining to the desc. As a result, transactions \"\n+                                      \"and coins using this desc may not appear in the wallet. This error could be \"\n+                                      \"caused by pruning or data corruption (see bitcoind log for details) and could \"\n+                                      \"be dealt with by downloading and rescanning the relevant blocks (see -reindex \"\n+                                      \"and -rescan options).\",\n+                                GetImportTimestamp(request, now), scanned_time - TIMESTAMP_WINDOW - 1, TIMESTAMP_WINDOW)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413849949",
      "id" : 413849949,
      "in_reply_to_id" : 413846027,
      "line" : 1746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg0OTk0OQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1746,
      "original_position" : 289,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 289,
      "pull_request_review_id" : 399161804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413849949",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413851526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413851526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: sort",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T14:36:53Z",
      "diff_hunk" : "@@ -4314,6 +4324,7 @@ static const CRPCCommand commands[] =\n     { \"wallet\",             \"importprunedfunds\",                &importprunedfunds,             {\"rawtransaction\",\"txoutproof\"} },\n     { \"wallet\",             \"importpubkey\",                     &importpubkey,                  {\"pubkey\",\"label\",\"rescan\"} },\n     { \"wallet\",             \"importwallet\",                     &importwallet,                  {\"filename\"} },\n+    { \"wallet\",             \"importdescriptors\",                &importdescriptors,             {\"requests\"} },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413851526",
      "id" : 413851526,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg1MTUyNg==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 4327,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 399163577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413851526",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413870149"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413870149"
         }
      },
      "author_association" : "MEMBER",
      "body" : "unsure but maybe worth pulling this out of the loop\r\n```diff\r\n+        auto old_spk_man_id {old_spk_man->GetID()};\r\n         for (bool internal : {false, true}) {\r\n             for (OutputType t : OUTPUT_TYPES) {\r\n                 auto active_spk_man = GetScriptPubKeyMan(t, internal);\r\n-                if (active_spk_man && active_spk_man->GetID() == old_spk_man->GetID()) {\r\n+                if (active_spk_man && active_spk_man->GetID() == old_spk_man_id) {\r\n                     if (internal) {\r\n                         m_internal_spk_managers.erase(t);\r\n                     } else {\r\n@@ -4478,7 +4479,7 @@ ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const Flat\r\n                 }\r\n             }\r\n         }\r\n-        m_spk_managers.erase(old_spk_man->GetID());\r\n+        m_spk_managers.erase(old_spk_man_id);\r\n```",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T14:57:50Z",
      "diff_hunk" : "@@ -4397,3 +4365,152 @@ void CWallet::ConnectScriptPubKeyManNotifiers()\n         spk_man->NotifyCanGetAddressesChanged.connect(NotifyCanGetAddressesChanged);\n     }\n }\n+\n+void CWallet::LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor& desc)\n+{\n+    auto spk_manager = std::unique_ptr<ScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+    m_spk_managers[id] = std::move(spk_manager);\n+}\n+\n+void CWallet::SetupDescriptorScriptPubKeyMans()\n+{\n+    AssertLockHeld(cs_wallet);\n+\n+    // Make a seed\n+    CKey seed_key;\n+    seed_key.MakeNewKey(true);\n+    CPubKey seed = seed_key.GetPubKey();\n+    assert(seed_key.VerifyPubKey(seed));\n+\n+    // Get the extended key\n+    CExtKey master_key;\n+    master_key.SetSeed(seed_key.begin(), seed_key.size());\n+\n+    for (bool internal : {false, true}) {\n+        for (OutputType t : OUTPUT_TYPES) {\n+            auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, t, internal));\n+            if (IsCrypted()) {\n+                if (IsLocked()) {\n+                    throw std::runtime_error(std::string(__func__) + \": Wallet is locked, cannot setup new descriptors\");\n+                }\n+                if (!spk_manager->CheckDecryptionKey(vMasterKey) && !spk_manager->Encrypt(vMasterKey, nullptr)) {\n+                    throw std::runtime_error(std::string(__func__) + \": Could not encrypt new descriptors\");\n+                }\n+            }\n+            spk_manager->SetupDescriptorGeneration(master_key);\n+            uint256 id = spk_manager->GetID();\n+            m_spk_managers[id] = std::move(spk_manager);\n+            SetActiveScriptPubKeyMan(id, t, internal);\n+        }\n+    }\n+}\n+\n+void CWallet::SetActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal, bool memonly)\n+{\n+    WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto spk_man = m_spk_managers.at(id).get();\n+    spk_man->SetType(type, internal);\n+    spk_mans[type] = spk_man;\n+\n+    if (!memonly) {\n+        WalletBatch batch(*database);\n+        if (!batch.WriteActiveScriptPubKeyMan(static_cast<uint8_t>(type), id, internal)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing active ScriptPubKeyMan id failed\");\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+bool CWallet::IsLegacy() const\n+{\n+    if (m_internal_spk_managers.count(OutputType::LEGACY) == 0) {\n+        return false;\n+    }\n+    auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n+    return spk_man != nullptr;\n+}\n+\n+DescriptorScriptPubKeyMan* CWallet::GetDescriptorScriptPubKeyMan(const WalletDescriptor& desc) const\n+{\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const FlatSigningProvider& signing_provider, const std::string& label)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot add WalletDescriptor to a non-descriptor wallet\\n\");\n+        return nullptr;\n+    }\n+\n+    LOCK(cs_wallet);\n+    auto new_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+\n+    // If we already have this descriptor, remove it from the maps but add the existing cache to desc\n+    auto old_spk_man = GetDescriptorScriptPubKeyMan(desc);\n+    if (old_spk_man) {\n+        WalletLogPrintf(\"Update existing descriptor: %s\\n\", desc.descriptor->ToString());\n+\n+        {\n+            LOCK(old_spk_man->cs_desc_man);\n+            new_spk_man->SetCache(old_spk_man->GetWalletDescriptor().cache);\n+        }\n+\n+        // Remove from maps of active spkMans\n+        for (bool internal : {false, true}) {\n+            for (OutputType t : OUTPUT_TYPES) {\n+                auto active_spk_man = GetScriptPubKeyMan(t, internal);\n+                if (active_spk_man && active_spk_man->GetID() == old_spk_man->GetID()) {\n+                    if (internal) {\n+                        m_internal_spk_managers.erase(t);\n+                    } else {\n+                        m_external_spk_managers.erase(t);\n+                    }\n+                    break;\n+                }\n+            }\n+        }\n+        m_spk_managers.erase(old_spk_man->GetID());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413870149",
      "id" : 413870149,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg3MDE0OQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 4481,
      "original_position" : 380,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 399185480,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413870149",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413893900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413893900"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Key expression index, see `descriptor.h`",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T15:25:25Z",
      "diff_hunk" : "@@ -240,11 +246,19 @@ class WalletBatch\n \n     bool WriteMinVersion(int nVersion);\n \n+    bool WriteDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const CPrivKey& privkey);\n+    bool WriteCryptedDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const std::vector<unsigned char>& secret);\n+    bool WriteDescriptor(const uint256& desc_id, const WalletDescriptor& descriptor);\n+    bool WriteDescriptorDerivedCache(const uint256& desc_id, uint32_t key_exp_index, uint32_t der_index, const CExtPubKey& xpub);\n+    bool WriteDescriptorParentCache(const uint256& desc_id, uint32_t key_exp_index, const CExtPubKey& xpub);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413893900",
      "id" : 413893900,
      "in_reply_to_id" : 413760834,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg5MzkwMA==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 253,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 399213518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413893900",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413900271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413900271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggest adding:\r\n```diff\r\n         assert_equal(wallet_info['keypoolsize_hd_internal'], 300)\r\n+        # Expect getwalletinfo to not return \"keypoololdest\" for descriptor wallets, only legacy ones\r\n+        assert 'keypoololdest' not in wallet_info.keys()\r\n```",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T15:33:09Z",
      "diff_hunk" : "@@ -0,0 +1,143 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descriptor wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error\n+)\n+\n+\n+class WalletDescriptorTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-keypool=100']]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        # Make a descriptor wallet\n+        self.log.info(\"Making a descriptor wallet\")\n+        self.nodes[0].createwallet(wallet_name=\"desc1\", descriptors=True)\n+        self.nodes[0].unloadwallet(\"\")\n+\n+        # A descriptor wallet should have 100 addresses * 3 types = 300 keys\n+        self.log.info(\"Checking wallet info\")\n+        wallet_info = self.nodes[0].getwalletinfo()\n+        assert_equal(wallet_info['keypoolsize'], 300)\n+        assert_equal(wallet_info['keypoolsize_hd_internal'], 300)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413900271",
      "id" : 413900271,
      "line" : 33,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkwMDI3MQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 33,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "test/functional/wallet_descriptor.py",
      "position" : 33,
      "pull_request_review_id" : 399221172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413900271",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413936172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413936172"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @Sjors ",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T16:18:15Z",
      "diff_hunk" : "@@ -240,11 +246,19 @@ class WalletBatch\n \n     bool WriteMinVersion(int nVersion);\n \n+    bool WriteDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const CPrivKey& privkey);\n+    bool WriteCryptedDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const std::vector<unsigned char>& secret);\n+    bool WriteDescriptor(const uint256& desc_id, const WalletDescriptor& descriptor);\n+    bool WriteDescriptorDerivedCache(const uint256& desc_id, uint32_t key_exp_index, uint32_t der_index, const CExtPubKey& xpub);\n+    bool WriteDescriptorParentCache(const uint256& desc_id, uint32_t key_exp_index, const CExtPubKey& xpub);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413936172",
      "id" : 413936172,
      "in_reply_to_id" : 413760834,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkzNjE3Mg==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 253,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 399263191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413936172",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK ed0113820b498f1e904ca9a0b1205708a6f68dca\r\n\r\nNo blockers from what I could see. Good work on the tests. Feel free to ignore the nit comments; I don't mind re-reviewing the diff if you retouch. Built/ran tests several times on Debian with no warnings or failures.",
      "created_at" : "2020-04-23T16:22:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-618497348",
      "id" : 618497348,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxODQ5NzM0OA==",
      "updated_at" : "2020-04-23T16:25:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/618497348",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In ed01138 locally the following test fails on macOS:\r\n\r\nThat's intended. Not all tests have been reworked to work with descriptor wallets. `wallet_balance.py` is one of those tests that need some modifications.",
      "created_at" : "2020-04-23T17:24:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-618532813",
      "id" : 618532813,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxODUzMjgxMw==",
      "updated_at" : "2020-04-23T17:24:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/618532813",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413990312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413990312"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It follows the naming convention used elsewhere.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T17:33:34Z",
      "diff_hunk" : "@@ -477,4 +482,111 @@ class LegacySigningProvider : public SigningProvider\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override { return m_spk_man.GetKeyOrigin(keyid, info); }\n };\n \n+class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n+{\n+private:\n+    WalletDescriptor m_wallet_descriptor GUARDED_BY(cs_desc_man);\n+\n+    using ScriptPubKeyMap = std::map<CScript, int32_t>; // Map of scripts to descriptor range index\n+    using PubKeyMap = std::map<CPubKey, int32_t>; // Map of pubkeys involved in scripts to descriptor range index\n+    using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n+    using KeyMap = std::map<CKeyID, CKey>;\n+\n+    ScriptPubKeyMap m_map_script_pub_keys GUARDED_BY(cs_desc_man);\n+    PubKeyMap m_map_pubkeys GUARDED_BY(cs_desc_man);\n+    int32_t m_max_cached_index = -1;\n+\n+    OutputType m_address_type;\n+    bool m_internal;\n+\n+    KeyMap m_map_keys GUARDED_BY(cs_desc_man);\n+    CryptedKeyMap m_map_crypted_keys GUARDED_BY(cs_desc_man);\n+\n+    bool SetCrypted();\n+\n+    //! keeps track of whether Unlock has run a thorough check before\n+    bool m_decryption_thoroughly_checked = false;\n+\n+    bool AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r413990312",
      "id" : 413990312,
      "in_reply_to_id" : 413732148,
      "line" : 510,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5MDMxMg==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 510,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 73,
      "pull_request_review_id" : 399325062,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413990312",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414007475"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414007475"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Moved. They used to be named differently.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T17:58:57Z",
      "diff_hunk" : "@@ -27,8 +27,10 @@ const std::string CRYPTED_KEY{\"ckey\"};\n const std::string CSCRIPT{\"cscript\"};\n const std::string DEFAULTKEY{\"defaultkey\"};\n const std::string DESTDATA{\"destdata\"};\n+const std::string ACTIVEEXTERNALSPK{\"activeexternalspk\"};\n const std::string FLAGS{\"flags\"};\n const std::string HDCHAIN{\"hdchain\"};\n+const std::string ACTIVEINTERNALSPK{\"activeinternalspk\"};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414007475",
      "id" : 414007475,
      "in_reply_to_id" : 413622392,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNzQ3NQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 33,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 399344731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414007475",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008333"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:00:09Z",
      "diff_hunk" : "@@ -179,6 +185,54 @@ bool WalletBatch::WriteMinVersion(int nVersion)\n     return WriteIC(DBKeys::MINVERSION, nVersion);\n }\n \n+bool WalletBatch::WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bool internal)\n+{\n+    std::string key = DBKeys::ACTIVEEXTERNALSPK;\n+    if (internal) {\n+        key = DBKeys::ACTIVEINTERNALSPK;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008333",
      "id" : 414008333,
      "in_reply_to_id" : 413629727,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwODMzMw==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 193,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 399345718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008333",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008405"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:00:16Z",
      "diff_hunk" : "@@ -1332,8 +1346,8 @@ CAmount CWallet::GetChange(const CTransaction& tx) const\n bool CWallet::IsHDEnabled() const\n {\n     bool result = true;\n-    for (const auto& spk_man_pair : m_spk_managers) {\n-        result &= spk_man_pair.second->IsHDEnabled();\n+    for (const auto& spk_man : GetActiveScriptPubKeyMans()) {\n+        result &= spk_man->IsHDEnabled();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008405",
      "id" : 414008405,
      "in_reply_to_id" : 413661739,
      "line" : 1351,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwODQwNQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1351,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 88,
      "pull_request_review_id" : 399345790,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008405",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008469"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:00:20Z",
      "diff_hunk" : "@@ -1497,3 +1497,669 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_keys.empty()) {\n+        return false;\n+    }\n+\n+    bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+    bool keyFail = false;\n+    for (const auto& mi : m_map_crypted_keys) {\n+        const CPubKey &pubkey = mi.second.first;\n+        const std::vector<unsigned char> &crypted_secret = mi.second.second;\n+        CKey key;\n+        if (!DecryptKey(master_key, crypted_secret, pubkey, key)) {\n+            keyFail = true;\n+            break;\n+        }\n+        keyPass = true;\n+        if (m_decryption_thoroughly_checked)\n+            break;\n+    }\n+    if (keyPass && keyFail) {\n+        LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+        throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+    }\n+    if (keyFail || (!keyPass && !accept_no_keys)) {\n+        return false;\n+    }\n+    m_decryption_thoroughly_checked = true;\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter which of many valid indexes the pubkey has, we just need an index where we can derive it and it's private key\n+                continue;\n+            }\n+            m_map_pubkeys[pubkey] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;\n+    } else {\n+        m_map_keys[pubkey.GetID()] = key;\n+        return batch.WriteDescriptorKey(GetID(), pubkey, key.GetPrivKey());\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_key)\n+{\n+    LOCK(cs_desc_man);\n+    assert(m_storage.IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));\n+\n+    // Ignore when there is already a descriptor\n+    if (m_wallet_descriptor.descriptor) {\n+        return false;\n+    }\n+\n+    int64_t creation_time = GetTime();\n+\n+    std::string xpub = EncodeExtPubKey(master_key.Neuter());\n+\n+    // Build descriptor string\n+    std::string desc_prefix;\n+    std::string desc_suffix = \"/*)\";\n+    switch (m_address_type) {\n+    case OutputType::LEGACY: {\n+        desc_prefix = \"pkh(\" + xpub + \"/44'\";\n+        break;\n+    }\n+    case OutputType::P2SH_SEGWIT: {\n+        desc_prefix = \"sh(wpkh(\" + xpub + \"/49'\";\n+        desc_suffix += \")\";\n+        break;\n+    }\n+    case OutputType::BECH32: {\n+        desc_prefix = \"wpkh(\" + xpub + \"/84'\";\n+        break;\n+    }\n+    default: assert(false);\n+    }\n+\n+    // Mainnet derives at 0', testnet and regtest derive at 1'\n+    if (Params().IsTestChain()) {\n+        desc_prefix += \"/1'\";\n+    } else {\n+        desc_prefix += \"/0'\";\n+    }\n+\n+    std::string internal_path = m_internal ? \"/1\" : \"/0\";\n+    std::string desc_str = desc_prefix + \"/0'\" + internal_path + desc_suffix;\n+\n+    // Make the descriptor\n+    FlatSigningProvider keys;\n+    std::string error;\n+    std::unique_ptr<Descriptor> desc = Parse(desc_str, keys, error, false);\n+    WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n+    m_wallet_descriptor = w_desc;\n+\n+    // Store the master private key, and descriptor\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor master private key failed\");\n+    }\n+    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    }\n+\n+    // TopUp\n+    TopUp();\n+\n+    m_storage.UnsetBlankWalletFlag(batch);\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::IsHDEnabled() const\n+{\n+    LOCK(cs_desc_man);\n+    return m_wallet_descriptor.descriptor->IsRange();\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanGetAddresses(bool internal) const\n+{\n+    // We can only give out addresses from descriptors that are single type (not combo), ranged,\n+    // and either has cached keys or can generate more keys (ignoring encryption)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008469",
      "id" : 414008469,
      "in_reply_to_id" : 413722005,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwODQ2OQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1858,
      "original_position" : 388,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 399345860,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008469",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008547"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:00:27Z",
      "diff_hunk" : "@@ -1497,3 +1497,669 @@ std::set<CKeyID> LegacyScriptPubKeyMan::GetKeys() const\n     }\n     return set_address;\n }\n+\n+void LegacyScriptPubKeyMan::SetType(OutputType type, bool internal) {}\n+\n+bool DescriptorScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n+{\n+    // Returns true if this descriptor supports getting new addresses. Conditions where we may be unable to fetch them (e.g. locked) are caught later\n+    if (!CanGetAddresses(m_internal)) {\n+        error = \"No addresses available\";\n+        return false;\n+    }\n+    {\n+        LOCK(cs_desc_man);\n+        assert(m_wallet_descriptor.descriptor->IsSingleType()); // This is a combo descriptor which should not be an active descriptor\n+        if (type != m_address_type) {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent\");\n+        }\n+\n+        TopUp();\n+\n+        // Get the scriptPubKey from the descriptor\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        if (m_wallet_descriptor.range_end <= m_max_cached_index && !TopUp(1)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            // We can't generate anymore keys\n+            error = \"Error: Keypool ran out, please call keypoolrefill first\";\n+            return false;\n+        }\n+\n+        Optional<OutputType> out_script_type = m_wallet_descriptor.descriptor->GetOutputType();\n+        if (out_script_type && out_script_type == type) {\n+            ExtractDestination(scripts_temp[0], dest);\n+        } else {\n+            throw std::runtime_error(std::string(__func__) + \": Types are inconsistent. Stored type does not match type of newly generated address\");\n+        }\n+        m_wallet_descriptor.next_index++;\n+        WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+        return true;\n+    }\n+}\n+\n+isminetype DescriptorScriptPubKeyMan::IsMine(const CScript& script) const\n+{\n+    LOCK(cs_desc_man);\n+    if (m_map_script_pub_keys.count(script) > 0) {\n+        return ISMINE_SPENDABLE;\n+    }\n+    return ISMINE_NO;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_keys.empty()) {\n+        return false;\n+    }\n+\n+    bool keyPass = m_map_crypted_keys.empty(); // Always pass when there are no encrypted keys\n+    bool keyFail = false;\n+    for (const auto& mi : m_map_crypted_keys) {\n+        const CPubKey &pubkey = mi.second.first;\n+        const std::vector<unsigned char> &crypted_secret = mi.second.second;\n+        CKey key;\n+        if (!DecryptKey(master_key, crypted_secret, pubkey, key)) {\n+            keyFail = true;\n+            break;\n+        }\n+        keyPass = true;\n+        if (m_decryption_thoroughly_checked)\n+            break;\n+    }\n+    if (keyPass && keyFail) {\n+        LogPrintf(\"The wallet is probably corrupted: Some keys decrypt but not all.\\n\");\n+        throw std::runtime_error(\"Error unlocking wallet: some keys decrypt but not all. Your wallet file may be corrupt.\");\n+    }\n+    if (keyFail || (!keyPass && !accept_no_keys)) {\n+        return false;\n+    }\n+    m_decryption_thoroughly_checked = true;\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch)\n+{\n+    LOCK(cs_desc_man);\n+    if (!m_map_crypted_keys.empty()) {\n+        return false;\n+    }\n+\n+    for (const KeyMap::value_type& key_in : m_map_keys)\n+    {\n+        const CKey &key = key_in.second;\n+        CPubKey pubkey = key.GetPubKey();\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        std::vector<unsigned char> crypted_secret;\n+        if (!EncryptSecret(master_key, secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch->WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+    }\n+    m_map_keys.clear();\n+    return true;\n+}\n+\n+bool DescriptorScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    bool result = GetNewDestination(type, address, error);\n+    index = m_wallet_descriptor.next_index - 1;\n+    return result;\n+}\n+\n+void DescriptorScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CTxDestination& addr)\n+{\n+    LOCK(cs_desc_man);\n+    // Only return when the index was the most recent\n+    if (m_wallet_descriptor.next_index - 1 == index) {\n+        m_wallet_descriptor.next_index--;\n+    }\n+    WalletBatch(m_storage.GetDatabase()).WriteDescriptor(GetID(), m_wallet_descriptor);\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+std::map<CKeyID, CKey> DescriptorScriptPubKeyMan::GetKeys() const\n+{\n+    AssertLockHeld(cs_desc_man);\n+    if (m_storage.HasEncryptionKeys() && !m_storage.IsLocked()) {\n+        KeyMap keys;\n+        for (auto key_pair : m_map_crypted_keys) {\n+            const CPubKey& pubkey = key_pair.second.first;\n+            const std::vector<unsigned char>& crypted_secret = key_pair.second.second;\n+            CKey key;\n+            DecryptKey(m_storage.GetEncryptionKey(), crypted_secret, pubkey, key);\n+            keys[pubkey.GetID()] = key;\n+        }\n+        return keys;\n+    }\n+    return m_map_keys;\n+}\n+\n+bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n+{\n+    LOCK(cs_desc_man);\n+    unsigned int target_size;\n+    if (size > 0) {\n+        target_size = size;\n+    } else {\n+        target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+    }\n+\n+    // Calculate the new range_end\n+    int32_t new_range_end = std::max(m_wallet_descriptor.next_index + (int32_t)target_size, m_wallet_descriptor.range_end);\n+\n+    // If the descriptor is not ranged, we actually just want to fill the first cache item\n+    if (!m_wallet_descriptor.descriptor->IsRange()) {\n+        new_range_end = 1;\n+        m_wallet_descriptor.range_end = 1;\n+        m_wallet_descriptor.range_start = 0;\n+    }\n+\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (int32_t i = m_max_cached_index + 1; i < new_range_end; ++i) {\n+        FlatSigningProvider out_keys;\n+        std::vector<CScript> scripts_temp;\n+        DescriptorCache temp_cache;\n+        // Maybe we have a cached xpub and we can expand from the cache first\n+        if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n+            if (!m_wallet_descriptor.descriptor->Expand(i, provider, scripts_temp, out_keys, &temp_cache)) return false;\n+        }\n+        // Add all of the scriptPubKeys to the scriptPubKey set\n+        for (const CScript& script : scripts_temp) {\n+            m_map_script_pub_keys[script] = i;\n+        }\n+        for (const auto& pk_pair : out_keys.pubkeys) {\n+            const CPubKey& pubkey = pk_pair.second;\n+            if (m_map_pubkeys.count(pubkey) != 0) {\n+                // We don't need to give an error here.\n+                // It doesn't matter which of many valid indexes the pubkey has, we just need an index where we can derive it and it's private key\n+                continue;\n+            }\n+            m_map_pubkeys[pubkey] = i;\n+        }\n+        // Write the cache\n+        for (const auto& parent_xpub_pair : temp_cache.GetCachedParentExtPubKeys()) {\n+            CExtPubKey xpub;\n+            if (m_wallet_descriptor.cache.GetCachedParentExtPubKey(parent_xpub_pair.first, xpub)) {\n+                if (xpub != parent_xpub_pair.second) {\n+                    throw std::runtime_error(std::string(__func__) + \": New cached parent xpub does not match already cached parent xpub\");\n+                }\n+                continue;\n+            }\n+            if (!batch.WriteDescriptorParentCache(id, parent_xpub_pair.first, parent_xpub_pair.second)) {\n+                throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+            }\n+            m_wallet_descriptor.cache.CacheParentExtPubKey(parent_xpub_pair.first, parent_xpub_pair.second);\n+        }\n+        for (const auto& derived_xpub_map_pair : temp_cache.GetCachedDerivedExtPubKeys()) {\n+            for (const auto& derived_xpub_pair : derived_xpub_map_pair.second) {\n+                CExtPubKey xpub;\n+                if (m_wallet_descriptor.cache.GetCachedDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, xpub)) {\n+                    if (xpub != derived_xpub_pair.second) {\n+                        throw std::runtime_error(std::string(__func__) + \": New cached derived xpub does not match already cached derived xpub\");\n+                    }\n+                    continue;\n+                }\n+                if (!batch.WriteDescriptorDerivedCache(id, derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second)) {\n+                    throw std::runtime_error(std::string(__func__) + \": writing cache item failed\");\n+                }\n+                m_wallet_descriptor.cache.CacheDerivedExtPubKey(derived_xpub_map_pair.first, derived_xpub_pair.first, derived_xpub_pair.second);\n+            }\n+        }\n+        m_max_cached_index++;\n+    }\n+    m_wallet_descriptor.range_end = new_range_end;\n+    batch.WriteDescriptor(GetID(), m_wallet_descriptor);\n+\n+    // By this point, the cache size should be the size of the entire range\n+    assert(m_wallet_descriptor.range_end - 1 == m_max_cached_index);\n+\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    LOCK(cs_desc_man);\n+    if (IsMine(script)) {\n+        int32_t index = m_map_script_pub_keys[script];\n+        if (index >= m_wallet_descriptor.next_index) {\n+            WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n+            m_wallet_descriptor.next_index = index + 1;\n+        }\n+        if (!TopUp()) {\n+            WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n+        }\n+    }\n+}\n+\n+void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n+{\n+    LOCK(cs_desc_man);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    if (!AddDescriptorKeyWithDB(batch, key, pubkey)) {\n+        throw std::runtime_error(std::string(__func__) + \": writing descriptor private key failed\");\n+    }\n+}\n+\n+bool DescriptorScriptPubKeyMan::AddDescriptorKeyWithDB(WalletBatch& batch, const CKey& key, const CPubKey &pubkey)\n+{\n+    AssertLockHeld(cs_desc_man);\n+    assert(!m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));\n+\n+    if (m_storage.HasEncryptionKeys()) {\n+        if (m_storage.IsLocked()) {\n+            return false;\n+        }\n+\n+        std::vector<unsigned char> crypted_secret;\n+        CKeyingMaterial secret(key.begin(), key.end());\n+        if (!EncryptSecret(m_storage.GetEncryptionKey(), secret, pubkey.GetHash(), crypted_secret)) {\n+            return false;\n+        }\n+\n+        m_map_crypted_keys[pubkey.GetID()] = make_pair(pubkey, crypted_secret);\n+        batch.WriteCryptedDescriptorKey(GetID(), pubkey, crypted_secret);\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008547",
      "id" : 414008547,
      "in_reply_to_id" : 413736798,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwODU0Nw==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1775,
      "original_position" : 305,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 399345944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008547",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008610"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:00:32Z",
      "diff_hunk" : "@@ -2471,13 +2472,16 @@ static UniValue getwalletinfo(const JSONRPCRequest& request)\n \n     size_t kpExternalSize = pwallet->KeypoolCountExternalKeys();\n     const auto bal = pwallet->GetBalance();\n+    int64_t kp_oldest = pwallet->GetOldestKeyPoolTime();\n     obj.pushKV(\"walletname\", pwallet->GetName());\n     obj.pushKV(\"walletversion\", pwallet->GetVersion());\n     obj.pushKV(\"balance\", ValueFromAmount(bal.m_mine_trusted));\n     obj.pushKV(\"unconfirmed_balance\", ValueFromAmount(bal.m_mine_untrusted_pending));\n     obj.pushKV(\"immature_balance\", ValueFromAmount(bal.m_mine_immature));\n     obj.pushKV(\"txcount\",       (int)pwallet->mapWallet.size());\n-    obj.pushKV(\"keypoololdest\", pwallet->GetOldestKeyPoolTime());\n+    if (kp_oldest > 0) {\n+        obj.pushKV(\"keypoololdest\", kp_oldest);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008610",
      "id" : 414008610,
      "in_reply_to_id" : 413789802,
      "line" : 2483,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwODYxMA==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 2483,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 39,
      "pull_request_review_id" : 399346013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:00:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008610",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008955"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I moved `xpub` to the front so that the only difference is that `WriteDescriptorDerivedCache` has `der_index` at the end.",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:01:02Z",
      "diff_hunk" : "@@ -240,11 +246,19 @@ class WalletBatch\n \n     bool WriteMinVersion(int nVersion);\n \n+    bool WriteDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const CPrivKey& privkey);\n+    bool WriteCryptedDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const std::vector<unsigned char>& secret);\n+    bool WriteDescriptor(const uint256& desc_id, const WalletDescriptor& descriptor);\n+    bool WriteDescriptorDerivedCache(const uint256& desc_id, uint32_t key_exp_index, uint32_t der_index, const CExtPubKey& xpub);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414008955",
      "id" : 414008955,
      "in_reply_to_id" : 413762307,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwODk1NQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 252,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 399346434,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:01:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414008955",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:01:07Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");\n+        }\n+\n+        // Ranged descriptors should not have a label\n+        if (data.exists(\"range\") && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Ranged descriptors should not have a label\");\n+        }\n+\n+        // Internal addresses should not have a label either\n+        if (internal && data.exists(\"label\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Internal addresses should not have a label\");\n+        }\n+\n+        // Combo descriptor check\n+        if (active && !parsed_desc->IsSingleType()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Combo descriptors cannot be set to active\");\n+        }\n+\n+        // If the wallet disabled private keys, abort if private keys exist\n+        if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && !keys.keys.empty()) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n+        }\n+\n+        // Need to ExpandPrivate to check if private keys are available for all pubkeys\n+        FlatSigningProvider expand_keys;\n+        std::vector<CScript> scripts;\n+        parsed_desc->Expand(0, keys, scripts, expand_keys);\n+        parsed_desc->ExpandPrivate(0, keys, expand_keys);\n+\n+        // Check if all private keys are provided\n+        bool have_all_privkeys = !expand_keys.keys.empty();\n+        for (const auto& entry : expand_keys.origins) {\n+            const CKeyID& key_id = entry.first;\n+            CKey key;\n+            if (!expand_keys.GetKey(key_id, key)) {\n+                have_all_privkeys = false;\n+                break;\n+            }\n+        }\n+\n+        // If private keys are enabled, check some things.\n+        if (!pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {\n+           if (keys.keys.empty()) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import descriptor without private keys to a wallet with private keys enabled\");\n+           }\n+           if (!have_all_privkeys) {\n+               warnings.push_back(\"Not all private keys provided. Some wallet functionality may return unexpected errors\");\n+           }\n+        }\n+\n+        WalletDescriptor w_desc(std::move(parsed_desc), timestamp, range_start, range_end, next_index);\n+\n+        // Check if the wallet already contains the descriptor\n+        auto existing_spk_manager = pwallet->GetDescriptorScriptPubKeyMan(w_desc);\n+        if (existing_spk_manager) {\n+            LOCK(existing_spk_manager->cs_desc_man);\n+            if (range_start > existing_spk_manager->GetWalletDescriptor().range_start) {\n+                throw JSONRPCError(RPC_INVALID_PARAMS, strprintf(\"range_start can only decrease; current range = [%d,%d]\", existing_spk_manager->GetWalletDescriptor().range_start, existing_spk_manager->GetWalletDescriptor().range_end));\n+            }\n+        }\n+\n+        // Add descriptor to the wallet\n+        auto spk_manager = pwallet->AddWalletDescriptor(w_desc, keys, label);\n+        if (spk_manager == nullptr) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, strprintf(\"Could not add descriptor '%s'\", descriptor));\n+        }\n+\n+        // Set descriptor as active if necessary\n+        if (active) {\n+            if (!w_desc.descriptor->GetOutputType()) {\n+                warnings.push_back(\"Unknown output type, cannot set descriptor to active.\");\n+            } else {\n+                pwallet->SetActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n+        }\n+\n+        result.pushKV(\"success\", UniValue(true));\n+    } catch (const UniValue& e) {\n+        result.pushKV(\"success\", UniValue(false));\n+        result.pushKV(\"error\", e);\n+    } catch (...) {\n+        result.pushKV(\"success\", UniValue(false));\n+\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+    }\n+    if (warnings.size()) result.pushKV(\"warnings\", warnings);\n+    return result;\n+}\n+\n+UniValue importdescriptors(const JSONRPCRequest& main_request) {\n+    // Acquire the wallet\n+    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(main_request);\n+    CWallet* const pwallet = wallet.get();\n+    if (!EnsureWalletIsAvailable(pwallet, main_request.fHelp)) {\n+        return NullUniValue;\n+    }\n+\n+            RPCHelpMan{\"importdescriptors\",\n+                \"\\nImport descriptors. This will trigger a rescan of the blockchain based on the earliest timestamp of all descriptors being imported. Requires a new wallet backup.\\n\"\n+            \"\\nNote: This call can take over an hour to complete if using an early timestamp; during that time, other rpc calls\\n\"\n+            \"may report that the imported keys, addresses or scripts exist but related transactions are still missing.\\n\",\n+                {\n+                    {\"requests\", RPCArg::Type::ARR, RPCArg::Optional::NO, \"Data to be imported\",\n+                        {\n+                            {\"\", RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, \"\",\n+                                {\n+                                    {\"desc\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Descriptor to import.\"},\n+                                    {\"active\", RPCArg::Type::BOOL, /* default */ \"false\", \"Set this descriptor to be the active descriptor for the corresponding output type/externality\"},\n+                                    {\"range\", RPCArg::Type::RANGE, RPCArg::Optional::OMITTED, \"If a ranged descriptor is used, this specifies the end or the range (in the form [begin,end]) to import\"},\n+                                    {\"next_index\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, \"If a ranged descriptor is set to active, this specifies the next index to generate addresses from\"},\n+                                    {\"timestamp\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"Time from which to start rescanning the blockchain for this descriptor, in \" + UNIX_EPOCH_TIME + \"\\n\"\n+        \"                                                              Use the string \\\"now\\\" to substitute the current synced blockchain time.\\n\"\n+        \"                                                              \\\"now\\\" can be specified to bypass scanning, for outputs which are known to never have been used, and\\n\"\n+        \"                                                              0 can be specified to scan the entire blockchain. Blocks up to 2 hours before the earliest timestamp\\n\"\n+        \"                                                              of all descriptors being imported will be scanned.\",\n+                                        /* oneline_description */ \"\", {\"timestamp | \\\"now\\\"\", \"integer / string\"}\n+                                    },\n+                                    {\"internal\", RPCArg::Type::BOOL, /* default */ \"false\", \"Stating whether matching outputs should be treated as not incoming payments (also known as change)\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009029",
      "id" : 414009029,
      "in_reply_to_id" : 413811801,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwOTAyOQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1625,
      "original_position" : 172,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 399346503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:01:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009029",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009061"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:01:10Z",
      "diff_hunk" : "@@ -1454,3 +1454,297 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     return response;\n }\n+\n+static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue& data, const int64_t timestamp) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    UniValue warnings(UniValue::VARR);\n+    UniValue result(UniValue::VOBJ);\n+\n+    try {\n+        if (!data.exists(\"desc\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Descriptor not found.\");\n+        }\n+\n+        const std::string& descriptor = data[\"desc\"].get_str();\n+        const bool active = data.exists(\"active\") ? data[\"active\"].get_bool() : false;\n+        const bool internal = data.exists(\"internal\") ? data[\"internal\"].get_bool() : false;\n+        const std::string& label = data.exists(\"label\") ? data[\"label\"].get_str() : \"\";\n+\n+        // Parse descriptor string\n+        FlatSigningProvider keys;\n+        std::string error;\n+        auto parsed_desc = Parse(descriptor, keys, error, /* require_checksum = */ true);\n+        if (!parsed_desc) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, error);\n+        }\n+\n+        // Range check\n+        int64_t range_start = 0, range_end = 1, next_index = 0;\n+        if (!parsed_desc->IsRange() && data.exists(\"range\")) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Range should not be specified for an un-ranged descriptor\");\n+        } else if (parsed_desc->IsRange()) {\n+            if (data.exists(\"range\")) {\n+                auto range = ParseDescriptorRange(data[\"range\"]);\n+                range_start = range.first;\n+                range_end = range.second + 1; // Specified range end is inclusive, but we need range end as exclusive\n+            } else {\n+                warnings.push_back(\"Range not given, using default keypool range\");\n+                range_start = 0;\n+                range_end = gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE);\n+            }\n+            next_index = range_start;\n+\n+            if (data.exists(\"next_index\")) {\n+                next_index = data[\"next_index\"].get_int64();\n+                // bound checks\n+                if (next_index < range_start || next_index >= range_end) {\n+                    throw JSONRPCError(RPC_INVALID_PARAMETER, \"next_index is out of range\");\n+                }\n+            }\n+        }\n+\n+        // Active descriptors must be ranged\n+        if (active && !parsed_desc->IsRange()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Active descriptor must be ranged\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009061",
      "id" : 414009061,
      "in_reply_to_id" : 413805809,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwOTA2MQ==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 1508,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 399346532,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:01:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009061",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:01:17Z",
      "diff_hunk" : "@@ -4314,6 +4324,7 @@ static const CRPCCommand commands[] =\n     { \"wallet\",             \"importprunedfunds\",                &importprunedfunds,             {\"rawtransaction\",\"txoutproof\"} },\n     { \"wallet\",             \"importpubkey\",                     &importpubkey,                  {\"pubkey\",\"label\",\"rescan\"} },\n     { \"wallet\",             \"importwallet\",                     &importwallet,                  {\"filename\"} },\n+    { \"wallet\",             \"importdescriptors\",                &importdescriptors,             {\"requests\"} },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009143",
      "id" : 414009143,
      "in_reply_to_id" : 413851526,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwOTE0Mw==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 4327,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 399346639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009143",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:01:22Z",
      "diff_hunk" : "@@ -4397,3 +4365,152 @@ void CWallet::ConnectScriptPubKeyManNotifiers()\n         spk_man->NotifyCanGetAddressesChanged.connect(NotifyCanGetAddressesChanged);\n     }\n }\n+\n+void CWallet::LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor& desc)\n+{\n+    auto spk_manager = std::unique_ptr<ScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+    m_spk_managers[id] = std::move(spk_manager);\n+}\n+\n+void CWallet::SetupDescriptorScriptPubKeyMans()\n+{\n+    AssertLockHeld(cs_wallet);\n+\n+    // Make a seed\n+    CKey seed_key;\n+    seed_key.MakeNewKey(true);\n+    CPubKey seed = seed_key.GetPubKey();\n+    assert(seed_key.VerifyPubKey(seed));\n+\n+    // Get the extended key\n+    CExtKey master_key;\n+    master_key.SetSeed(seed_key.begin(), seed_key.size());\n+\n+    for (bool internal : {false, true}) {\n+        for (OutputType t : OUTPUT_TYPES) {\n+            auto spk_manager = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, t, internal));\n+            if (IsCrypted()) {\n+                if (IsLocked()) {\n+                    throw std::runtime_error(std::string(__func__) + \": Wallet is locked, cannot setup new descriptors\");\n+                }\n+                if (!spk_manager->CheckDecryptionKey(vMasterKey) && !spk_manager->Encrypt(vMasterKey, nullptr)) {\n+                    throw std::runtime_error(std::string(__func__) + \": Could not encrypt new descriptors\");\n+                }\n+            }\n+            spk_manager->SetupDescriptorGeneration(master_key);\n+            uint256 id = spk_manager->GetID();\n+            m_spk_managers[id] = std::move(spk_manager);\n+            SetActiveScriptPubKeyMan(id, t, internal);\n+        }\n+    }\n+}\n+\n+void CWallet::SetActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal, bool memonly)\n+{\n+    WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto spk_man = m_spk_managers.at(id).get();\n+    spk_man->SetType(type, internal);\n+    spk_mans[type] = spk_man;\n+\n+    if (!memonly) {\n+        WalletBatch batch(*database);\n+        if (!batch.WriteActiveScriptPubKeyMan(static_cast<uint8_t>(type), id, internal)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing active ScriptPubKeyMan id failed\");\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+bool CWallet::IsLegacy() const\n+{\n+    if (m_internal_spk_managers.count(OutputType::LEGACY) == 0) {\n+        return false;\n+    }\n+    auto spk_man = dynamic_cast<LegacyScriptPubKeyMan*>(m_internal_spk_managers.at(OutputType::LEGACY));\n+    return spk_man != nullptr;\n+}\n+\n+DescriptorScriptPubKeyMan* CWallet::GetDescriptorScriptPubKeyMan(const WalletDescriptor& desc) const\n+{\n+    for (auto& spk_man_pair : m_spk_managers) {\n+        // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match\n+        DescriptorScriptPubKeyMan* spk_manager = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man_pair.second.get());\n+        if (spk_manager != nullptr && spk_manager->HasWalletDescriptor(desc)) {\n+            return spk_manager;\n+        }\n+    }\n+\n+    return nullptr;\n+}\n+\n+ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const FlatSigningProvider& signing_provider, const std::string& label)\n+{\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        WalletLogPrintf(\"Cannot add WalletDescriptor to a non-descriptor wallet\\n\");\n+        return nullptr;\n+    }\n+\n+    LOCK(cs_wallet);\n+    auto new_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(*this, desc));\n+\n+    // If we already have this descriptor, remove it from the maps but add the existing cache to desc\n+    auto old_spk_man = GetDescriptorScriptPubKeyMan(desc);\n+    if (old_spk_man) {\n+        WalletLogPrintf(\"Update existing descriptor: %s\\n\", desc.descriptor->ToString());\n+\n+        {\n+            LOCK(old_spk_man->cs_desc_man);\n+            new_spk_man->SetCache(old_spk_man->GetWalletDescriptor().cache);\n+        }\n+\n+        // Remove from maps of active spkMans\n+        for (bool internal : {false, true}) {\n+            for (OutputType t : OUTPUT_TYPES) {\n+                auto active_spk_man = GetScriptPubKeyMan(t, internal);\n+                if (active_spk_man && active_spk_man->GetID() == old_spk_man->GetID()) {\n+                    if (internal) {\n+                        m_internal_spk_managers.erase(t);\n+                    } else {\n+                        m_external_spk_managers.erase(t);\n+                    }\n+                    break;\n+                }\n+            }\n+        }\n+        m_spk_managers.erase(old_spk_man->GetID());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009214",
      "id" : 414009214,
      "in_reply_to_id" : 413870149,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwOTIxNA==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 4481,
      "original_position" : 380,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 399346691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:01:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009214",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "223588b1bbc63dc57098bbd0baa48635e0cc0b82",
      "created_at" : "2020-04-23T18:01:26Z",
      "diff_hunk" : "@@ -0,0 +1,143 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test descriptor wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error\n+)\n+\n+\n+class WalletDescriptorTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-keypool=100']]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        # Make a descriptor wallet\n+        self.log.info(\"Making a descriptor wallet\")\n+        self.nodes[0].createwallet(wallet_name=\"desc1\", descriptors=True)\n+        self.nodes[0].unloadwallet(\"\")\n+\n+        # A descriptor wallet should have 100 addresses * 3 types = 300 keys\n+        self.log.info(\"Checking wallet info\")\n+        wallet_info = self.nodes[0].getwalletinfo()\n+        assert_equal(wallet_info['keypoolsize'], 300)\n+        assert_equal(wallet_info['keypoolsize_hd_internal'], 300)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#discussion_r414009257",
      "id" : 414009257,
      "in_reply_to_id" : 413900271,
      "line" : 33,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwOTI1Nw==",
      "original_commit_id" : "ed0113820b498f1e904ca9a0b1205708a6f68dca",
      "original_line" : 33,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "test/functional/wallet_descriptor.py",
      "position" : 33,
      "pull_request_review_id" : 399346748,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-23T18:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414009257",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed @jonatack's comments and rebased as requested by @Sjors ",
      "created_at" : "2020-04-23T18:01:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-618555157",
      "id" : 618555157,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxODU1NTE1Nw==",
      "updated_at" : "2020-04-23T18:01:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/618555157",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 223588b1bbc63dc57098bbd0baa48635e0cc0b82 (rebased, nits addressed)\r\n\r\n> That's intended. Not all tests have been reworked to work with descriptor wallets. `wallet_balance.py` is one of those tests that need some modifications.\r\n\r\nI might be seeing two different issues. When I run the full test suite that particular test sometimes fails with `[node 0] bitcoind exited with status 1 during initialization`, but not every time, and it also happens with other tests, including non-wallet ones. And given that Travis macOS passes, I think it's unrelated to this PR and maybe a (new) dev setup problem.",
      "created_at" : "2020-04-23T18:48:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-618586971",
      "id" : 618586971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxODU4Njk3MQ==",
      "updated_at" : "2020-04-23T18:48:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/618586971",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review re-ACK 223588b1bbc63dc57098bbd0baa48635e0cc0b82.\r\n\r\nRebuilt, re-ran all tests, bitcoind and a few `importdescriptors` rpc commands as a sanity check. I did not test the GUI changes yet.",
      "created_at" : "2020-04-23T21:38:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-618685814",
      "id" : 618685814,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxODY4NTgxNA==",
      "updated_at" : "2020-04-23T21:38:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/618685814",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re-ACK 223588b1bbc63dc57098bbd0baa48635e0cc0b82\r\n\r\nChanges were only rebase and addressing nits. FWIW, I did not see any failures from `wallet_balance.py`.",
      "created_at" : "2020-04-24T15:32:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-619082907",
      "id" : 619082907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxOTA4MjkwNw==",
      "updated_at" : "2020-04-24T15:32:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/619082907",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "light re-ACK 223588b\r\n\r\nRead carefully through the descriptor-specific tests one more time, as well as the discussion since my last review. Admittedly a light re-review. Some more advanced use-cases may require additional tooling later and that's ok.",
      "created_at" : "2020-04-24T19:32:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-619202090",
      "id" : 619202090,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxOTIwMjA5MA==",
      "updated_at" : "2020-04-24T19:33:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/619202090",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "People interested in this recently merged PR might be interested in reviewing the small follow-up PR #18782 (\"wallet: Make sure no DescriptorScriptPubKeyMan or WalletDescriptor members are left uninitialized after construction\") :)",
      "created_at" : "2020-04-27T14:31:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16528#issuecomment-620024560",
      "id" : 620024560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMDAyNDU2MA==",
      "updated_at" : "2020-04-27T14:31:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/620024560",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
