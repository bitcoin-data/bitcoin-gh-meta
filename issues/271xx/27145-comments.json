[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/27145#issuecomment-1450530407), [glozow](https://github.com/bitcoin/bitcoin/pull/27145#pullrequestreview-1374815913) |\n| Stale ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/27145#pullrequestreview-1413069965) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27307](https://github.com/bitcoin/bitcoin/pull/27307) (wallet: track mempool conflicts with wallet transactions by ishaanam)\n* [#27286](https://github.com/bitcoin/bitcoin/pull/27286) (wallet: Keep track of the wallet's own transaction outputs in memory by achow101)\n* [#25297](https://github.com/bitcoin/bitcoin/pull/25297) (wallet: group independent db writes on single batched db transaction by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-02-22T19:00:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#issuecomment-1440638145",
      "id" : 1440638145,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27145",
      "node_id" : "IC_kwDOABII585V3mTB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1440638145/reactions"
      },
      "updated_at" : "2023-05-14T14:45:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1440638145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK on refreshing state of conflicted transactions in the wallet when a block is disconnected. I think there is a potential problem with the implementation though because it isn't recursively marking conflicted transactions as unconfirmed, only marking the top level transactions without recursing.\r\n\r\nI think a good approach could be to steal from the previous implementation of this idea in commits b8b4592d985fa36dd0dddfd0e2bc6daf8df6e79c and 3c8bd6814ca88715d3d56994b10dc2c5f3e38e2d from #17543, which did recurse. That approach was also nice because it reused the existing MarkConflicted function in order to avoid code duplication. Commit ec5a89a26fa17e68b3e5928730e7d7c3e0370729 from that PR also added some more test coverage which could be used here.",
      "created_at" : "2023-03-01T17:19:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#issuecomment-1450530407",
      "id" : 1450530407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27145",
      "node_id" : "IC_kwDOABII585WdVZn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1450530407/reactions"
      },
      "updated_at" : "2023-03-01T17:19:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1450530407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ryanofsky \r\n> I think there is a potential problem with the implementation though because it isn't recursively marking conflicted transactions as unconfirmed, only marking the top level transactions without recursing.\r\n\r\nYes, I had forgotten about this, thanks for pointing it out! \r\n> I think a good approach could be to steal from the previous implementation of this idea in commits https://github.com/bitcoin/bitcoin/commit/b8b4592d985fa36dd0dddfd0e2bc6daf8df6e79c and https://github.com/bitcoin/bitcoin/commit/3c8bd6814ca88715d3d56994b10dc2c5f3e38e2d from https://github.com/bitcoin/bitcoin/pull/17543, which did recurse.\r\n\r\nI have used ideas from that PR so that the transaction state updating will recurse.\r\n> Commit https://github.com/bitcoin/bitcoin/commit/ec5a89a26fa17e68b3e5928730e7d7c3e0370729 from that PR also added some more test coverage which could be used here.\r\n\r\nI have cherry-picked that commit to this branch with a few adjustments.",
      "created_at" : "2023-03-05T06:17:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#issuecomment-1455001809",
      "id" : 1455001809,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27145",
      "node_id" : "IC_kwDOABII585WuZDR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1455001809/reactions"
      },
      "updated_at" : "2023-03-05T06:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1455001809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159765529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159765529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in 77a2e522d845eda270b2c03fd7e0a16bc4c00fbb:\r\n\r\nI think this comment is a little bit hard to follow. Something more descriptive might be\r\n```suggestion\r\n\"\"\"\r\nTest that wallet correctly tracks transactions that have been conflicted by blocks, particularly during reorgs.\r\n\"\"\"\r\n```",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-06T12:58:54Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159765529",
      "id" : 1159765529,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FIJ4Z",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1374815913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159765529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T13:55:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159765529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159784792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159784792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We should also test who \"wins\" in this conflict contest and what the values are, i.e. conflicting A has 8 confirmations and conflicting B has 4 confirmations.",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-06T13:17:13Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+        assert_equal,\n+)\n+\n+class TxConflicts(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        self.add_wallet_options(parser)\n+\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.log.info(\"Send tx from which to conflict outputs later\")\n+        txid_conflict_from_1 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        txid_conflict_from_2 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        self.generate(self.nodes[0], 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Disconnect nodes to broadcast conflicts on their respective chains\")\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 1)\n+\n+        self.log.info(\"Create a transaction with conflicted transactions spending outpoints A & B\")\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_1)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        nB = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_2)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_conflicted_tx = []\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+        inputs_conflicting_tx_A = []\n+        inputs_conflicting_tx_A.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicting_tx_B = []\n+        inputs_conflicting_tx_B.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+\n+        outputs_conflicted_tx = {}\n+        outputs_conflicted_tx[self.nodes[0].getnewaddress()] = Decimal(\"19.99998\")\n+        outputs_conflicting_tx_A = {}\n+        outputs_conflicting_tx_A[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+        outputs_conflicting_tx_B = {}\n+        outputs_conflicting_tx_B[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicted_tx, outputs_conflicted_tx))\n+        conflicting_tx_A = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_A, outputs_conflicting_tx_A))\n+        conflicting_tx_B = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_B, outputs_conflicting_tx_B))\n+\n+        self.log.info(\"Broadcast conflicted transaction\")\n+        conflicted_txid = self.nodes[0].sendrawtransaction(conflicted[\"hex\"])\n+        self.generate(self.nodes[0], 1, sync_fun=self.no_op)\n+\n+        # Build child conflicted tx\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(conflicted_txid)[\"details\"] if tx_out[\"amount\"] == Decimal(\"19.99998\"))\n+        inputs_child_conflicted = []\n+        inputs_child_conflicted.append({\"txid\": conflicted_txid, \"vout\": nA})\n+        outputs_child_conflicted = {}\n+        outputs_child_conflicted[self.nodes[0].getnewaddress()] = Decimal(\"19.99996\")\n+        child_conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_child_conflicted, outputs_child_conflicted))\n+        child_conflicted_txid = self.nodes[0].sendrawtransaction(child_conflicted[\"hex\"])\n+        self.generate(self.nodes[0], 1, sync_fun=self.no_op)\n+\n+        self.log.info(\"Broadcast conflicting tx to node 1\")\n+        conflicting_txid_A = self.nodes[1].sendrawtransaction(conflicting_tx_A[\"hex\"])\n+        self.generate(self.nodes[1], 4, sync_fun=self.no_op)\n+        self.nodes[1].sendrawtransaction(conflicting_tx_B[\"hex\"])\n+        self.generate(self.nodes[1], 4, sync_fun=self.no_op)\n+\n+        # Reconnect node0 and node1 and check that conflicted_txid is effectively conflicted\n+        self.log.info(\"Connect nodes 0 and 1, and ensure that the tx is effectively conflicted\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+        conflicted = self.nodes[0].gettransaction(conflicted_txid)\n+        child_conflicted = self.nodes[0].gettransaction(child_conflicted_txid)\n+        conflicting = self.nodes[0].gettransaction(conflicting_txid_A)\n+        # Conflicted tx should have confirmations set to the confirmations of the most conflicting tx\n+        assert_equal(conflicted[\"confirmations\"], -conflicting[\"confirmations\"])\n+        # Child should inherit conflicted state from parent\n+        assert_equal(child_conflicted[\"confirmations\"], -conflicting[\"confirmations\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159784792",
      "id" : 1159784792,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FIOlY",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 88,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1374815913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159784792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T13:55:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159784792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159787578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159787578"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit in 77a2e522d845eda270b2c03fd7e0a16bc4c00fbb, I think this is clearer (same with the other arrays of inputs and outputs)\r\n\r\n```suggestion\r\n        inputs_conflicted_tx = [{\"txid\": txid_conflict_from_1, \"vout\": nA}, {\"txid\": txid_conflict_from_2, \"vout\": nB}]\r\n```",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-06T13:19:38Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+        assert_equal,\n+)\n+\n+class TxConflicts(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        self.add_wallet_options(parser)\n+\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.log.info(\"Send tx from which to conflict outputs later\")\n+        txid_conflict_from_1 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        txid_conflict_from_2 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        self.generate(self.nodes[0], 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Disconnect nodes to broadcast conflicts on their respective chains\")\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 1)\n+\n+        self.log.info(\"Create a transaction with conflicted transactions spending outpoints A & B\")\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_1)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        nB = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_2)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_conflicted_tx = []\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_2, \"vout\": nB})",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159787578",
      "id" : 1159787578,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FIPQ6",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 41,
      "original_position" : 41,
      "original_start_line" : 39,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1374815913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159787578/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-06T13:55:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159787578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159806134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159806134"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry to bikeshed, but I think the naming is a bit hard to follow (\"conflicted\" vs \"conflicting\" don't immediately make sense to me, especially since both sets of transactions get conflicted at some point during the test). Might I suggest names that indicate which input(s) they spend, which node broadcasts them, and what \"generation\" they are? For example\r\n\r\n`tx_AB_0_parent` instead of `conflicted`\r\n`tx_A_1` instead of `conflicting_tx_A`\r\n`tx_B_1` instead of `conflicting_tx_B`\r\n\r\n`C` instead of `nA` for the 19.99998BTC output, because `nA` is already the name of the 10BTC output from one of the funding transactions.\r\n`tx_C_0_child` instead of `child_conflicted`",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-06T13:33:00Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+        assert_equal,\n+)\n+\n+class TxConflicts(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        self.add_wallet_options(parser)\n+\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.log.info(\"Send tx from which to conflict outputs later\")\n+        txid_conflict_from_1 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        txid_conflict_from_2 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        self.generate(self.nodes[0], 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Disconnect nodes to broadcast conflicts on their respective chains\")\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 1)\n+\n+        self.log.info(\"Create a transaction with conflicted transactions spending outpoints A & B\")\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_1)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        nB = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_2)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_conflicted_tx = []\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+        inputs_conflicting_tx_A = []\n+        inputs_conflicting_tx_A.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicting_tx_B = []\n+        inputs_conflicting_tx_B.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+\n+        outputs_conflicted_tx = {}\n+        outputs_conflicted_tx[self.nodes[0].getnewaddress()] = Decimal(\"19.99998\")\n+        outputs_conflicting_tx_A = {}\n+        outputs_conflicting_tx_A[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+        outputs_conflicting_tx_B = {}\n+        outputs_conflicting_tx_B[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicted_tx, outputs_conflicted_tx))\n+        conflicting_tx_A = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_A, outputs_conflicting_tx_A))\n+        conflicting_tx_B = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_B, outputs_conflicting_tx_B))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159806134",
      "id" : 1159806134,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FITy2",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : 54,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1374815913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159806134/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-06T13:55:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159806134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159807735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159807735"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        self.sync_blocks()\r\n```",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-06T13:34:01Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+        assert_equal,\n+)\n+\n+class TxConflicts(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        self.add_wallet_options(parser)\n+\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.log.info(\"Send tx from which to conflict outputs later\")\n+        txid_conflict_from_1 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        txid_conflict_from_2 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        self.generate(self.nodes[0], 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Disconnect nodes to broadcast conflicts on their respective chains\")\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 1)\n+\n+        self.log.info(\"Create a transaction with conflicted transactions spending outpoints A & B\")\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_1)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        nB = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_2)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_conflicted_tx = []\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+        inputs_conflicting_tx_A = []\n+        inputs_conflicting_tx_A.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicting_tx_B = []\n+        inputs_conflicting_tx_B.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+\n+        outputs_conflicted_tx = {}\n+        outputs_conflicted_tx[self.nodes[0].getnewaddress()] = Decimal(\"19.99998\")\n+        outputs_conflicting_tx_A = {}\n+        outputs_conflicting_tx_A[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+        outputs_conflicting_tx_B = {}\n+        outputs_conflicting_tx_B[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicted_tx, outputs_conflicted_tx))\n+        conflicting_tx_A = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_A, outputs_conflicting_tx_A))\n+        conflicting_tx_B = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_B, outputs_conflicting_tx_B))\n+\n+        self.log.info(\"Broadcast conflicted transaction\")\n+        conflicted_txid = self.nodes[0].sendrawtransaction(conflicted[\"hex\"])\n+        self.generate(self.nodes[0], 1, sync_fun=self.no_op)\n+\n+        # Build child conflicted tx\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(conflicted_txid)[\"details\"] if tx_out[\"amount\"] == Decimal(\"19.99998\"))\n+        inputs_child_conflicted = []\n+        inputs_child_conflicted.append({\"txid\": conflicted_txid, \"vout\": nA})\n+        outputs_child_conflicted = {}\n+        outputs_child_conflicted[self.nodes[0].getnewaddress()] = Decimal(\"19.99996\")\n+        child_conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_child_conflicted, outputs_child_conflicted))\n+        child_conflicted_txid = self.nodes[0].sendrawtransaction(child_conflicted[\"hex\"])\n+        self.generate(self.nodes[0], 1, sync_fun=self.no_op)\n+\n+        self.log.info(\"Broadcast conflicting tx to node 1\")\n+        conflicting_txid_A = self.nodes[1].sendrawtransaction(conflicting_tx_A[\"hex\"])\n+        self.generate(self.nodes[1], 4, sync_fun=self.no_op)\n+        self.nodes[1].sendrawtransaction(conflicting_tx_B[\"hex\"])\n+        self.generate(self.nodes[1], 4, sync_fun=self.no_op)\n+\n+        # Reconnect node0 and node1 and check that conflicted_txid is effectively conflicted\n+        self.log.info(\"Connect nodes 0 and 1, and ensure that the tx is effectively conflicted\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+        conflicted = self.nodes[0].gettransaction(conflicted_txid)\n+        child_conflicted = self.nodes[0].gettransaction(child_conflicted_txid)\n+        conflicting = self.nodes[0].gettransaction(conflicting_txid_A)\n+        # Conflicted tx should have confirmations set to the confirmations of the most conflicting tx\n+        assert_equal(conflicted[\"confirmations\"], -conflicting[\"confirmations\"])\n+        # Child should inherit conflicted state from parent\n+        assert_equal(child_conflicted[\"confirmations\"], -conflicting[\"confirmations\"])\n+\n+        # Node2 chain without conflicts\n+        self.generate(self.nodes[2], 15, sync_fun=self.no_op)\n+\n+        # Connect node0 and node2 and wait reorg\n+        self.connect_nodes(0, 2)\n+        self.sync_blocks([self.nodes[0], self.nodes[2]])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159807735",
      "id" : 1159807735,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FIUL3",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 95,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1374815913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159807735/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T13:55:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159807735",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159814534"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159814534"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 49f8af533f2e6370f4ae5220f5c706e30b90d06c\r\n\r\nno need for const reference to integer\r\n",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-06T13:39:49Z",
      "diff_hunk" : "@@ -1465,8 +1465,32 @@ void CWallet::blockDisconnected(const interfaces::BlockInfo& block)\n     // future with a stickier abandoned state or even removing abandontransaction call.\n     m_last_block_processed_height = block.height - 1;\n     m_last_block_processed = *Assert(block.prev_hash);\n+\n+    const int& disconnect_height = block.height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1159814534",
      "id" : 1159814534,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FIV2G",
      "original_commit_id" : "49f8af533f2e6370f4ae5220f5c706e30b90d06c",
      "original_line" : 1469,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1374815913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159814534/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T13:55:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159814534",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've updated it to this, this is much more clear.",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-08T04:54:34Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062770",
      "id" : 1161062770,
      "in_reply_to_id" : 1159765529,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FNGly",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1376712428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062770/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-08T04:54:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062811"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've added a check for this.",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-08T04:54:48Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+        assert_equal,\n+)\n+\n+class TxConflicts(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        self.add_wallet_options(parser)\n+\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.log.info(\"Send tx from which to conflict outputs later\")\n+        txid_conflict_from_1 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        txid_conflict_from_2 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        self.generate(self.nodes[0], 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Disconnect nodes to broadcast conflicts on their respective chains\")\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 1)\n+\n+        self.log.info(\"Create a transaction with conflicted transactions spending outpoints A & B\")\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_1)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        nB = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_2)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_conflicted_tx = []\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+        inputs_conflicting_tx_A = []\n+        inputs_conflicting_tx_A.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicting_tx_B = []\n+        inputs_conflicting_tx_B.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+\n+        outputs_conflicted_tx = {}\n+        outputs_conflicted_tx[self.nodes[0].getnewaddress()] = Decimal(\"19.99998\")\n+        outputs_conflicting_tx_A = {}\n+        outputs_conflicting_tx_A[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+        outputs_conflicting_tx_B = {}\n+        outputs_conflicting_tx_B[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicted_tx, outputs_conflicted_tx))\n+        conflicting_tx_A = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_A, outputs_conflicting_tx_A))\n+        conflicting_tx_B = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_B, outputs_conflicting_tx_B))\n+\n+        self.log.info(\"Broadcast conflicted transaction\")\n+        conflicted_txid = self.nodes[0].sendrawtransaction(conflicted[\"hex\"])\n+        self.generate(self.nodes[0], 1, sync_fun=self.no_op)\n+\n+        # Build child conflicted tx\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(conflicted_txid)[\"details\"] if tx_out[\"amount\"] == Decimal(\"19.99998\"))\n+        inputs_child_conflicted = []\n+        inputs_child_conflicted.append({\"txid\": conflicted_txid, \"vout\": nA})\n+        outputs_child_conflicted = {}\n+        outputs_child_conflicted[self.nodes[0].getnewaddress()] = Decimal(\"19.99996\")\n+        child_conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_child_conflicted, outputs_child_conflicted))\n+        child_conflicted_txid = self.nodes[0].sendrawtransaction(child_conflicted[\"hex\"])\n+        self.generate(self.nodes[0], 1, sync_fun=self.no_op)\n+\n+        self.log.info(\"Broadcast conflicting tx to node 1\")\n+        conflicting_txid_A = self.nodes[1].sendrawtransaction(conflicting_tx_A[\"hex\"])\n+        self.generate(self.nodes[1], 4, sync_fun=self.no_op)\n+        self.nodes[1].sendrawtransaction(conflicting_tx_B[\"hex\"])\n+        self.generate(self.nodes[1], 4, sync_fun=self.no_op)\n+\n+        # Reconnect node0 and node1 and check that conflicted_txid is effectively conflicted\n+        self.log.info(\"Connect nodes 0 and 1, and ensure that the tx is effectively conflicted\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+        conflicted = self.nodes[0].gettransaction(conflicted_txid)\n+        child_conflicted = self.nodes[0].gettransaction(child_conflicted_txid)\n+        conflicting = self.nodes[0].gettransaction(conflicting_txid_A)\n+        # Conflicted tx should have confirmations set to the confirmations of the most conflicting tx\n+        assert_equal(conflicted[\"confirmations\"], -conflicting[\"confirmations\"])\n+        # Child should inherit conflicted state from parent\n+        assert_equal(child_conflicted[\"confirmations\"], -conflicting[\"confirmations\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062811",
      "id" : 1161062811,
      "in_reply_to_id" : 1159784792,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FNGmb",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 88,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1376712439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062811/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-08T04:54:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062833"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-08T04:55:00Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+        assert_equal,\n+)\n+\n+class TxConflicts(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        self.add_wallet_options(parser)\n+\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.log.info(\"Send tx from which to conflict outputs later\")\n+        txid_conflict_from_1 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        txid_conflict_from_2 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        self.generate(self.nodes[0], 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Disconnect nodes to broadcast conflicts on their respective chains\")\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 1)\n+\n+        self.log.info(\"Create a transaction with conflicted transactions spending outpoints A & B\")\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_1)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        nB = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_2)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_conflicted_tx = []\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_2, \"vout\": nB})",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062833",
      "id" : 1161062833,
      "in_reply_to_id" : 1159787578,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FNGmx",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 41,
      "original_position" : 41,
      "original_start_line" : 39,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1376712446,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062833/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-08T04:55:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree, the naming here was a bit confusing. It should be fixed now.",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-08T04:55:58Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+        assert_equal,\n+)\n+\n+class TxConflicts(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        self.add_wallet_options(parser)\n+\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.log.info(\"Send tx from which to conflict outputs later\")\n+        txid_conflict_from_1 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        txid_conflict_from_2 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        self.generate(self.nodes[0], 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Disconnect nodes to broadcast conflicts on their respective chains\")\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 1)\n+\n+        self.log.info(\"Create a transaction with conflicted transactions spending outpoints A & B\")\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_1)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        nB = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_2)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_conflicted_tx = []\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+        inputs_conflicting_tx_A = []\n+        inputs_conflicting_tx_A.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicting_tx_B = []\n+        inputs_conflicting_tx_B.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+\n+        outputs_conflicted_tx = {}\n+        outputs_conflicted_tx[self.nodes[0].getnewaddress()] = Decimal(\"19.99998\")\n+        outputs_conflicting_tx_A = {}\n+        outputs_conflicting_tx_A[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+        outputs_conflicting_tx_B = {}\n+        outputs_conflicting_tx_B[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicted_tx, outputs_conflicted_tx))\n+        conflicting_tx_A = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_A, outputs_conflicting_tx_A))\n+        conflicting_tx_B = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_B, outputs_conflicting_tx_B))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062927",
      "id" : 1161062927,
      "in_reply_to_id" : 1159806134,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FNGoP",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : 54,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1376712520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062927/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-08T04:55:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062954"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done both here and one other place.",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-08T04:56:21Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2023 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test conflicts tracking with multilple txn conflicting a conflicted tx.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+        assert_equal,\n+)\n+\n+class TxConflicts(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        self.add_wallet_options(parser)\n+\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.log.info(\"Send tx from which to conflict outputs later\")\n+        txid_conflict_from_1 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        txid_conflict_from_2 = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), Decimal(\"10\"))\n+        self.generate(self.nodes[0], 1)\n+        self.sync_blocks()\n+\n+        self.log.info(\"Disconnect nodes to broadcast conflicts on their respective chains\")\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 1)\n+\n+        self.log.info(\"Create a transaction with conflicted transactions spending outpoints A & B\")\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_1)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        nB = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(txid_conflict_from_2)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_conflicted_tx = []\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicted_tx.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+        inputs_conflicting_tx_A = []\n+        inputs_conflicting_tx_A.append({\"txid\": txid_conflict_from_1, \"vout\": nA})\n+        inputs_conflicting_tx_B = []\n+        inputs_conflicting_tx_B.append({\"txid\": txid_conflict_from_2, \"vout\": nB})\n+\n+        outputs_conflicted_tx = {}\n+        outputs_conflicted_tx[self.nodes[0].getnewaddress()] = Decimal(\"19.99998\")\n+        outputs_conflicting_tx_A = {}\n+        outputs_conflicting_tx_A[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+        outputs_conflicting_tx_B = {}\n+        outputs_conflicting_tx_B[self.nodes[0].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicted_tx, outputs_conflicted_tx))\n+        conflicting_tx_A = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_A, outputs_conflicting_tx_A))\n+        conflicting_tx_B = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_conflicting_tx_B, outputs_conflicting_tx_B))\n+\n+        self.log.info(\"Broadcast conflicted transaction\")\n+        conflicted_txid = self.nodes[0].sendrawtransaction(conflicted[\"hex\"])\n+        self.generate(self.nodes[0], 1, sync_fun=self.no_op)\n+\n+        # Build child conflicted tx\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[0].gettransaction(conflicted_txid)[\"details\"] if tx_out[\"amount\"] == Decimal(\"19.99998\"))\n+        inputs_child_conflicted = []\n+        inputs_child_conflicted.append({\"txid\": conflicted_txid, \"vout\": nA})\n+        outputs_child_conflicted = {}\n+        outputs_child_conflicted[self.nodes[0].getnewaddress()] = Decimal(\"19.99996\")\n+        child_conflicted = self.nodes[0].signrawtransactionwithwallet(self.nodes[0].createrawtransaction(inputs_child_conflicted, outputs_child_conflicted))\n+        child_conflicted_txid = self.nodes[0].sendrawtransaction(child_conflicted[\"hex\"])\n+        self.generate(self.nodes[0], 1, sync_fun=self.no_op)\n+\n+        self.log.info(\"Broadcast conflicting tx to node 1\")\n+        conflicting_txid_A = self.nodes[1].sendrawtransaction(conflicting_tx_A[\"hex\"])\n+        self.generate(self.nodes[1], 4, sync_fun=self.no_op)\n+        self.nodes[1].sendrawtransaction(conflicting_tx_B[\"hex\"])\n+        self.generate(self.nodes[1], 4, sync_fun=self.no_op)\n+\n+        # Reconnect node0 and node1 and check that conflicted_txid is effectively conflicted\n+        self.log.info(\"Connect nodes 0 and 1, and ensure that the tx is effectively conflicted\")\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+        conflicted = self.nodes[0].gettransaction(conflicted_txid)\n+        child_conflicted = self.nodes[0].gettransaction(child_conflicted_txid)\n+        conflicting = self.nodes[0].gettransaction(conflicting_txid_A)\n+        # Conflicted tx should have confirmations set to the confirmations of the most conflicting tx\n+        assert_equal(conflicted[\"confirmations\"], -conflicting[\"confirmations\"])\n+        # Child should inherit conflicted state from parent\n+        assert_equal(child_conflicted[\"confirmations\"], -conflicting[\"confirmations\"])\n+\n+        # Node2 chain without conflicts\n+        self.generate(self.nodes[2], 15, sync_fun=self.no_op)\n+\n+        # Connect node0 and node2 and wait reorg\n+        self.connect_nodes(0, 2)\n+        self.sync_blocks([self.nodes[0], self.nodes[2]])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062954",
      "id" : 1161062954,
      "in_reply_to_id" : 1159807735,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FNGoq",
      "original_commit_id" : "77a2e522d845eda270b2c03fd7e0a16bc4c00fbb",
      "original_line" : 95,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : null,
      "pull_request_review_id" : 1376712542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062954/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-08T04:56:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062971"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "9895be8d792b9cf5c6ed9779e631b4d81d7d894a",
      "created_at" : "2023-04-08T04:56:33Z",
      "diff_hunk" : "@@ -1465,8 +1465,32 @@ void CWallet::blockDisconnected(const interfaces::BlockInfo& block)\n     // future with a stickier abandoned state or even removing abandontransaction call.\n     m_last_block_processed_height = block.height - 1;\n     m_last_block_processed = *Assert(block.prev_hash);\n+\n+    const int& disconnect_height = block.height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1161062971",
      "id" : 1161062971,
      "in_reply_to_id" : 1159814534,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FNGo7",
      "original_commit_id" : "49f8af533f2e6370f4ae5220f5c706e30b90d06c",
      "original_line" : 1469,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1376712557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062971/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-08T04:56:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1161062971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review @glozow, I have addressed your comments and also made a modification to `RecursiveUpdateTxState` which will allow it to be more extensible.",
      "created_at" : "2023-04-08T04:59:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#issuecomment-1500792114",
      "id" : 1500792114,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27145",
      "node_id" : "IC_kwDOABII585ZdEUy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1500792114/reactions"
      },
      "updated_at" : "2023-04-08T04:59:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1500792114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163045689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163045689"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In c3fe92175b6ac709e4fdfd4766253c75d7ffd184 \"wallet: introduce generic recursive tx state updating function\"\r\n\r\nThis could also be used by `AbandonTransaction`.",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-11T16:09:10Z",
      "diff_hunk" : "@@ -1336,13 +1336,29 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto get_updated_state = [&](CWalletTx& wtx) {\n+        LOCK(cs_wallet);\n+\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+            return true;\n+        }\n+        return false;\n+    };\n+\n+    RecursiveUpdateTxState(hashTx, get_updated_state);\n+\n+}\n+\n+void CWallet::RecursiveUpdateTxState(const uint256& tx_hash, const GetUpdatedStateFn& get_updated_state) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163045689",
      "id" : 1163045689,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FUqs5",
      "original_commit_id" : "c3fe92175b6ac709e4fdfd4766253c75d7ffd184",
      "original_line" : 1330,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1379642409,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163045689/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-11T16:11:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163045689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163046096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163046096"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In c3fe92175b6ac709e4fdfd4766253c75d7ffd184 \"wallet: introduce generic recursive tx state updating function\"\r\n\r\nThe comments should be updated to avoid mentioning specific transaction states.",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-11T16:09:32Z",
      "diff_hunk" : "@@ -1351,11 +1367,7 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n         auto it = mapWallet.find(now);\n         assert(it != mapWallet.end());\n         CWalletTx& wtx = it->second;\n-        int currentconfirm = GetTxDepthInMainChain(wtx);\n-        if (conflictconfirms < currentconfirm) {\n-            // Block is 'more conflicted' than current confirm; update.\n-            // Mark transaction as conflicted with this block.\n-            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+        if (get_updated_state(wtx)) {\n             wtx.MarkDirty();\n             batch.WriteTx(wtx);\n             // Iterate over all its outputs, and mark transactions in the wallet that spend them conflicted too",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163046096",
      "id" : 1163046096,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FUqzQ",
      "original_commit_id" : "c3fe92175b6ac709e4fdfd4766253c75d7ffd184",
      "original_line" : 1373,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1379642409,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163046096/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-11T16:11:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163046096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163192581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163192581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `GetUpdatedStateFn` function isn't really a getter, what about calling it `TryUpdateState`?.",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-11T18:37:09Z",
      "diff_hunk" : "@@ -1336,13 +1313,29 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto get_updated_state = [&](CWalletTx& wtx) {\n+        LOCK(cs_wallet);\n+\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+            return true;\n+        }\n+        return false;\n+    };\n+\n+    RecursiveUpdateTxState(hashTx, get_updated_state);\n+\n+}\n+\n+void CWallet::RecursiveUpdateTxState(const uint256& tx_hash, const GetUpdatedStateFn& get_updated_state) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163192581",
      "id" : 1163192581,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FVOkF",
      "original_commit_id" : "06d7eb71575254e2b8c19625f6880433ed1409e4",
      "original_line" : 1330,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1379867013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163192581/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-11T19:06:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163192581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163192633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163192633"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-11T18:37:13Z",
      "diff_hunk" : "@@ -1336,13 +1336,29 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto get_updated_state = [&](CWalletTx& wtx) {\n+        LOCK(cs_wallet);\n+\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+            return true;\n+        }\n+        return false;\n+    };\n+\n+    RecursiveUpdateTxState(hashTx, get_updated_state);\n+\n+}\n+\n+void CWallet::RecursiveUpdateTxState(const uint256& tx_hash, const GetUpdatedStateFn& get_updated_state) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163192633",
      "id" : 1163192633,
      "in_reply_to_id" : 1163045689,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FVOk5",
      "original_commit_id" : "c3fe92175b6ac709e4fdfd4766253c75d7ffd184",
      "original_line" : 1330,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1379867739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163192633/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-11T18:37:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163192633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163193445"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163193445"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, I've made them more generic now.",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-11T18:38:06Z",
      "diff_hunk" : "@@ -1351,11 +1367,7 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n         auto it = mapWallet.find(now);\n         assert(it != mapWallet.end());\n         CWalletTx& wtx = it->second;\n-        int currentconfirm = GetTxDepthInMainChain(wtx);\n-        if (conflictconfirms < currentconfirm) {\n-            // Block is 'more conflicted' than current confirm; update.\n-            // Mark transaction as conflicted with this block.\n-            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+        if (get_updated_state(wtx)) {\n             wtx.MarkDirty();\n             batch.WriteTx(wtx);\n             // Iterate over all its outputs, and mark transactions in the wallet that spend them conflicted too",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163193445",
      "id" : 1163193445,
      "in_reply_to_id" : 1163046096,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FVOxl",
      "original_commit_id" : "c3fe92175b6ac709e4fdfd4766253c75d7ffd184",
      "original_line" : 1373,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1379868892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163193445/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-11T18:38:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163193445",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163196400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163196400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to re-acquire `cs_wallet` here (`RecursiveUpdateTxState` already locks `cs_wallet`) . Can add the exclusive lock annotation instead, e.g:\r\n\r\n```c++\r\nconst auto& try_update_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\r\n    if (conflictconfirms >= GetTxDepthInMainChain(wtx)) return false;\r\n    \r\n    wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\r\n    return true;\r\n};\r\n```\r\n\r\n(same for the others)",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-11T18:41:40Z",
      "diff_hunk" : "@@ -1336,13 +1313,29 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto get_updated_state = [&](CWalletTx& wtx) {\n+        LOCK(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163196400",
      "id" : 1163196400,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FVPfw",
      "original_commit_id" : "06d7eb71575254e2b8c19625f6880433ed1409e4",
      "original_line" : 1317,
      "original_position" : 76,
      "original_start_line" : 1316,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1379867013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163196400/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-11T19:08:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163196400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163430354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163430354"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I've changed `GetUpdatedStateFn` to `TryUpdatingStateFn`, and `get_updated_state` to `try_updating_state`.",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-11T23:47:04Z",
      "diff_hunk" : "@@ -1336,13 +1313,29 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto get_updated_state = [&](CWalletTx& wtx) {\n+        LOCK(cs_wallet);\n+\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+            return true;\n+        }\n+        return false;\n+    };\n+\n+    RecursiveUpdateTxState(hashTx, get_updated_state);\n+\n+}\n+\n+void CWallet::RecursiveUpdateTxState(const uint256& tx_hash, const GetUpdatedStateFn& get_updated_state) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163430354",
      "id" : 1163430354,
      "in_reply_to_id" : 1163192581,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FWInS",
      "original_commit_id" : "06d7eb71575254e2b8c19625f6880433ed1409e4",
      "original_line" : 1330,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1380228035,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163430354/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-11T23:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163430354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163430929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163430929"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've implemented this, it also fixes the CI error.",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-11T23:48:16Z",
      "diff_hunk" : "@@ -1336,13 +1313,29 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto get_updated_state = [&](CWalletTx& wtx) {\n+        LOCK(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163430929",
      "id" : 1163430929,
      "in_reply_to_id" : 1163196400,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FWIwR",
      "original_commit_id" : "06d7eb71575254e2b8c19625f6880433ed1409e4",
      "original_line" : 1317,
      "original_position" : 76,
      "original_start_line" : 1316,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1380228712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163430929/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-11T23:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163430929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163469554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163469554"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would try to not provide the context by reference to the function. The lambda function's `wtx` shadows the function's `wtx`. Could just provide `disconnect_height`.",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-12T01:22:21Z",
      "diff_hunk" : "@@ -1443,8 +1443,36 @@ void CWallet::blockDisconnected(const interfaces::BlockInfo& block)\n     // future with a stickier abandoned state or even removing abandontransaction call.\n     m_last_block_processed_height = block.height - 1;\n     m_last_block_processed = *Assert(block.prev_hash);\n+\n+    int disconnect_height = block.height;\n+\n     for (const CTransactionRef& ptx : Assert(block.data)->vtx) {\n         SyncTransaction(ptx, TxStateInactive{});\n+\n+        for (const CTxIn& tx_in : ptx->vin) {\n+            // No other wallet transactions conflicted with this transaction\n+            if (mapTxSpends.count(tx_in.prevout) <= 1) continue;\n+\n+            std::pair<TxSpends::const_iterator, TxSpends::const_iterator> range = mapTxSpends.equal_range(tx_in.prevout);\n+\n+            // For all of the spends that conflict with this transaction\n+            for (TxSpends::const_iterator _it = range.first; _it != range.second; ++_it) {\n+                CWalletTx& wtx = mapWallet.find(_it->second)->second;\n+\n+                if (!wtx.isConflicted()) continue;\n+\n+                auto try_updating_state = [&](CWalletTx& wtx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1163469554",
      "id" : 1163469554,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FWSLy",
      "original_commit_id" : "fadc353c6765ba0c81e9d4f26f204a1d4452030d",
      "original_line" : 1464,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1380282608,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163469554/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-12T21:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1163469554",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1165954948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1165954948"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In f998cdbc:\r\nThis lock isn't needed. All callers have `cs_wallet` acquired. Could add the lock required annotation instead.",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-13T19:39:20Z",
      "diff_hunk" : "@@ -1336,13 +1313,27 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+            return true;\n+        }\n+        return false;\n+    };\n+\n+    RecursiveUpdateTxState(hashTx, try_updating_state);\n+\n+}\n+\n+void CWallet::RecursiveUpdateTxState(const uint256& tx_hash, const TryUpdatingStateFn& try_updating_state) {\n+    LOCK(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1165954948",
      "id" : 1165954948,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ffw-E",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1329,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1384097968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1165954948/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-13T19:49:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1165954948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1165959935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1165959935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In f998cdbc:\r\n\r\nWould be good to move this `NotifyTransactionChanged` to `RecursiveUpdateTxState` too. So `MarkConflicted` and the `BlockDisconnected` txes state changes are notified to the upper layers.",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-13T19:45:39Z",
      "diff_hunk" : "@@ -1282,44 +1277,26 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n         int currentconfirm = GetTxDepthInMainChain(wtx);\n-        // If the orig tx was not in block, none of its spends can be\n         assert(currentconfirm <= 0);\n-        // if (currentconfirm < 0) {Tx and spends are already conflicted, no need to abandon}\n+\n         if (currentconfirm == 0 && !wtx.isAbandoned()) {\n-            // If the orig tx was not in block/mempool, none of its spends can be in mempool\n             assert(!wtx.InMempool());\n             wtx.m_state = TxStateInactive{/*abandoned=*/true};\n-            wtx.MarkDirty();\n-            batch.WriteTx(wtx);\n             NotifyTransactionChanged(wtx.GetHash(), CT_UPDATED);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1165959935",
      "id" : 1165959935,
      "line" : 1287,
      "node_id" : "PRRC_kwDOABII585FfyL_",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1287,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 37,
      "pull_request_review_id" : 1384097968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1165959935/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-13T19:49:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1165959935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1166323704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1166323704"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that this is a good idea, but would be out of the scope of this PR and would warrant more discussion, since then it would be notifying for tx state updates that it previously did not.",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-14T06:14:18Z",
      "diff_hunk" : "@@ -1282,44 +1277,26 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n         int currentconfirm = GetTxDepthInMainChain(wtx);\n-        // If the orig tx was not in block, none of its spends can be\n         assert(currentconfirm <= 0);\n-        // if (currentconfirm < 0) {Tx and spends are already conflicted, no need to abandon}\n+\n         if (currentconfirm == 0 && !wtx.isAbandoned()) {\n-            // If the orig tx was not in block/mempool, none of its spends can be in mempool\n             assert(!wtx.InMempool());\n             wtx.m_state = TxStateInactive{/*abandoned=*/true};\n-            wtx.MarkDirty();\n-            batch.WriteTx(wtx);\n             NotifyTransactionChanged(wtx.GetHash(), CT_UPDATED);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1166323704",
      "id" : 1166323704,
      "in_reply_to_id" : 1165959935,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FhK_4",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1287,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1384666668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1166323704/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-17T18:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1166323704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1166323841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1166323841"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-14T06:14:27Z",
      "diff_hunk" : "@@ -1336,13 +1313,27 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+            return true;\n+        }\n+        return false;\n+    };\n+\n+    RecursiveUpdateTxState(hashTx, try_updating_state);\n+\n+}\n+\n+void CWallet::RecursiveUpdateTxState(const uint256& tx_hash, const TryUpdatingStateFn& try_updating_state) {\n+    LOCK(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1166323841",
      "id" : 1166323841,
      "in_reply_to_id" : 1165954948,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FhLCB",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1329,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1384666812,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1166323841/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-14T06:14:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1166323841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1166333715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1166333715"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> The lambda function's wtx shadows the function's wtx.\r\n\r\nI have renamed the lambda function's `wtx`.\r\n> Could just provide disconnect_height.\r\n\r\nBy this do you mean providing the `disconnect_height` of the block to `RecursiveUpdateTxState` or providing the wallet tx's `conflicting_block_height` to `try_updating_state` instead of the whole wallet tx by reference?",
      "commit_id" : "5a31a453fd945826a8178a9aabff4c18d53268b6",
      "created_at" : "2023-04-14T06:22:46Z",
      "diff_hunk" : "@@ -1443,8 +1443,36 @@ void CWallet::blockDisconnected(const interfaces::BlockInfo& block)\n     // future with a stickier abandoned state or even removing abandontransaction call.\n     m_last_block_processed_height = block.height - 1;\n     m_last_block_processed = *Assert(block.prev_hash);\n+\n+    int disconnect_height = block.height;\n+\n     for (const CTransactionRef& ptx : Assert(block.data)->vtx) {\n         SyncTransaction(ptx, TxStateInactive{});\n+\n+        for (const CTxIn& tx_in : ptx->vin) {\n+            // No other wallet transactions conflicted with this transaction\n+            if (mapTxSpends.count(tx_in.prevout) <= 1) continue;\n+\n+            std::pair<TxSpends::const_iterator, TxSpends::const_iterator> range = mapTxSpends.equal_range(tx_in.prevout);\n+\n+            // For all of the spends that conflict with this transaction\n+            for (TxSpends::const_iterator _it = range.first; _it != range.second; ++_it) {\n+                CWalletTx& wtx = mapWallet.find(_it->second)->second;\n+\n+                if (!wtx.isConflicted()) continue;\n+\n+                auto try_updating_state = [&](CWalletTx& wtx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1166333715",
      "id" : 1166333715,
      "in_reply_to_id" : 1163469554,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FhNcT",
      "original_commit_id" : "fadc353c6765ba0c81e9d4f26f204a1d4452030d",
      "original_line" : 1464,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1384680323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1166333715/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-14T06:22:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1166333715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review @achow101 and @furszy!\r\n> Haven't finished checking the latest changes but, if you like it, https://github.com/furszy/bitcoin-core/commit/8bb14c1eaf09b0bca9efa78e1a7a7a00c61c0a29 is all yours. During the review, the functional test wasn't clear enough for me so I spent a bit of time making it more friendly.\r\n\r\nThanks, I'll use these improvements here once I review them.\r\nEdit: I've added the suggested changes to the functional tests.",
      "created_at" : "2023-04-14T06:25:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#issuecomment-1507990460",
      "id" : 1507990460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27145",
      "node_id" : "IC_kwDOABII585Z4hu8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1507990460/reactions"
      },
      "updated_at" : "2023-04-14T21:08:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1507990460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1168973760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1168973760"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: introduce generic recursive tx state updating function\" (f998cdbc689cc65ff0aca98ce63758c59786c1db)\r\n\r\n> I think that this is a good idea, but would out of the scope of this PR and would warrant more discussion, since then it would be notifying for tx state updates that it previously did not.\r\n\r\nAgree we should avoid changing behavior, but I think the current commit might also be changing behavior by notifying before calling MarkDirty and WriteTx instead of after.\r\n\r\nI think the best thing to do would be to change TryUpdatingStateFn to return an enum instead of a bool like:\r\n\r\n```c++\r\nenum class TxUpdate { UNCHANGED, CHANGED, NOTIFY_CHANGED };\r\nusing TryUpdatingStateFn = std::function<TxUpdate(CWalletTx& wtx)>;\r\n```\r\n\r\nReturning CHANGED/UNCHANGED should make the code clearer anyway because it's less obvious what true and false mean.",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-17T16:13:12Z",
      "diff_hunk" : "@@ -1282,44 +1277,26 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n         int currentconfirm = GetTxDepthInMainChain(wtx);\n-        // If the orig tx was not in block, none of its spends can be\n         assert(currentconfirm <= 0);\n-        // if (currentconfirm < 0) {Tx and spends are already conflicted, no need to abandon}\n+\n         if (currentconfirm == 0 && !wtx.isAbandoned()) {\n-            // If the orig tx was not in block/mempool, none of its spends can be in mempool\n             assert(!wtx.InMempool());\n             wtx.m_state = TxStateInactive{/*abandoned=*/true};\n-            wtx.MarkDirty();\n-            batch.WriteTx(wtx);\n             NotifyTransactionChanged(wtx.GetHash(), CT_UPDATED);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1168973760",
      "id" : 1168973760,
      "in_reply_to_id" : 1165959935,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FrR_A",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1287,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1388499202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1168973760/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-17T16:13:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1168973760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169145950"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169145950"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: introduce generic recursive tx state updating function\" (f998cdbc689cc65ff0aca98ce63758c59786c1db)\r\n\r\nI think as long as this code is still calling GetTxDepthInMainChain, it would be better to keep the 3 comments that were here instead of deleting them, because they explain why the asserts are valid and why conflicted transactions are ignored",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-17T18:47:36Z",
      "diff_hunk" : "@@ -1282,44 +1277,26 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n         int currentconfirm = GetTxDepthInMainChain(wtx);\n-        // If the orig tx was not in block, none of its spends can be\n         assert(currentconfirm <= 0);\n-        // if (currentconfirm < 0) {Tx and spends are already conflicted, no need to abandon}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169145950",
      "id" : 1169145950,
      "line" : 1297,
      "node_id" : "PRRC_kwDOABII585Fr8Be",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1297,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 28,
      "pull_request_review_id" : 1388756669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169145950/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-17T19:17:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169145950",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169161201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169161201"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: introduce generic recursive tx state updating function\" (f998cdbc689cc65ff0aca98ce63758c59786c1db)\r\n\r\nIt seems like the code in this lambda would be simpler it avoided calling GetTxDepthInMainChain. The following should be equivalent:\r\n\r\n```c++\r\n// If the orig tx was not in block/mempool, none of its spends can be.\r\nassert(!wtx.isConfirmed());\r\nassert(!wtx.InMempool());\r\n// If already conflicted or abandoned, no need to set abandoned.\r\nif (!wtx.isConflicted() && !wtx.isAbandoned()) {\r\n    wtx.m_state = TxStateInactive{/*abandoned=*/true};\r\n    ...\r\n}\r\n```\r\n\r\nFree to ignore this suggestion if you think it would complicate things, though. The cleanup is orthogonal and could be done separately.",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-17T18:58:33Z",
      "diff_hunk" : "@@ -1282,44 +1277,26 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n         int currentconfirm = GetTxDepthInMainChain(wtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169161201",
      "id" : 1169161201,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Fr_vx",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1281,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1388756669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169161201/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-17T19:17:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169161201",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169166456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169166456"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: introduce generic recursive tx state updating function\" (f998cdbc689cc65ff0aca98ce63758c59786c1db)\r\n\r\nThis also seems like a useful comment. Would keep instead of deleting",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-17T19:04:26Z",
      "diff_hunk" : "@@ -1336,13 +1313,27 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169166456",
      "id" : 1169166456,
      "line" : 1339,
      "node_id" : "PRRC_kwDOABII585FsBB4",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1339,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 96,
      "pull_request_review_id" : 1388756669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169166456/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-17T19:17:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169166456",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169172208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169172208"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: introduce generic recursive tx state updating function\" (f998cdbc689cc65ff0aca98ce63758c59786c1db)\r\n\r\nThis code pretty opaque, would suggest copying the previous comment here \"Iterate over all its outputs, and mark transactions in the wallet that spend them conflicted too\" or something equivalent.",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-17T19:11:13Z",
      "diff_hunk" : "@@ -1336,13 +1313,27 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+            return true;\n+        }\n+        return false;\n+    };\n+\n+    RecursiveUpdateTxState(hashTx, try_updating_state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169172208",
      "id" : 1169172208,
      "line" : 1326,
      "node_id" : "PRRC_kwDOABII585FsCbw",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1326,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 89,
      "pull_request_review_id" : 1388756669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169172208/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-17T19:17:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169172208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169173396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169173396"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: introduce generic recursive tx state updating function\" (f998cdbc689cc65ff0aca98ce63758c59786c1db)\r\n\r\nWould suggest keeping the previous comment here instead of deleting it. It's not obvious what the check means or what's happening in the block:\r\n\r\n```c++\r\n// Block is 'more conflicted' than current confirm; update.\r\n// Mark transaction as conflicted with this block.\r\n```",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-17T19:12:34Z",
      "diff_hunk" : "@@ -1336,13 +1313,27 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1169173396",
      "id" : 1169173396,
      "line" : 1319,
      "node_id" : "PRRC_kwDOABII585FsCuU",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1319,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 82,
      "pull_request_review_id" : 1388756669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169173396/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-17T19:17:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1169173396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170596878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170596878"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I have implemented this suggestion, I agree that it is much clearer now.",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-18T21:42:14Z",
      "diff_hunk" : "@@ -1282,44 +1277,26 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n         int currentconfirm = GetTxDepthInMainChain(wtx);\n-        // If the orig tx was not in block, none of its spends can be\n         assert(currentconfirm <= 0);\n-        // if (currentconfirm < 0) {Tx and spends are already conflicted, no need to abandon}\n+\n         if (currentconfirm == 0 && !wtx.isAbandoned()) {\n-            // If the orig tx was not in block/mempool, none of its spends can be in mempool\n             assert(!wtx.InMempool());\n             wtx.m_state = TxStateInactive{/*abandoned=*/true};\n-            wtx.MarkDirty();\n-            batch.WriteTx(wtx);\n             NotifyTransactionChanged(wtx.GetHash(), CT_UPDATED);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170596878",
      "id" : 1170596878,
      "in_reply_to_id" : 1165959935,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FxeQO",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1287,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1390975672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170596878/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T21:42:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170596878",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170597818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170597818"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I implemented your next suggestion about simplifying the code in the lambda, so the comments are a bit different now but I did add them back.",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-18T21:43:30Z",
      "diff_hunk" : "@@ -1282,44 +1277,26 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n         int currentconfirm = GetTxDepthInMainChain(wtx);\n-        // If the orig tx was not in block, none of its spends can be\n         assert(currentconfirm <= 0);\n-        // if (currentconfirm < 0) {Tx and spends are already conflicted, no need to abandon}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170597818",
      "id" : 1170597818,
      "in_reply_to_id" : 1169145950,
      "line" : 1297,
      "node_id" : "PRRC_kwDOABII585Fxee6",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1297,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 28,
      "pull_request_review_id" : 1390977262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170597818/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T21:43:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170597818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170598598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170598598"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is simpler and it is a small change so I've implemented it in this commit.",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-18T21:44:43Z",
      "diff_hunk" : "@@ -1282,44 +1277,26 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n         int currentconfirm = GetTxDepthInMainChain(wtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170598598",
      "id" : 1170598598,
      "in_reply_to_id" : 1169161201,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FxerG",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1281,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1390978356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170598598/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T21:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170598598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170599011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170599011"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I have added it back.",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-18T21:45:14Z",
      "diff_hunk" : "@@ -1336,13 +1313,27 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170599011",
      "id" : 1170599011,
      "in_reply_to_id" : 1169166456,
      "line" : 1339,
      "node_id" : "PRRC_kwDOABII585Fxexj",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1339,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 96,
      "pull_request_review_id" : 1390978865,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170599011/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T21:45:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170599011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170599147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170599147"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-18T21:45:24Z",
      "diff_hunk" : "@@ -1336,13 +1313,27 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};\n+            return true;\n+        }\n+        return false;\n+    };\n+\n+    RecursiveUpdateTxState(hashTx, try_updating_state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170599147",
      "id" : 1170599147,
      "in_reply_to_id" : 1169172208,
      "line" : 1326,
      "node_id" : "PRRC_kwDOABII585Fxezr",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1326,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 89,
      "pull_request_review_id" : 1390979053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170599147/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T21:45:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170599147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170599313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170599313"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "e6b0136d4772fb9d49eed53d33342e1765e51fb6",
      "created_at" : "2023-04-18T21:45:41Z",
      "diff_hunk" : "@@ -1336,13 +1313,27 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n     if (conflictconfirms >= 0)\n         return;\n \n-    // Do not flush the wallet here for performance reasons\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\n+        if (conflictconfirms < GetTxDepthInMainChain(wtx)) {\n+            wtx.m_state = TxStateConflicted{hashBlock, conflicting_height};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1170599313",
      "id" : 1170599313,
      "in_reply_to_id" : 1169173396,
      "line" : 1319,
      "node_id" : "PRRC_kwDOABII585Fxe2R",
      "original_commit_id" : "f998cdbc689cc65ff0aca98ce63758c59786c1db",
      "original_line" : 1319,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 82,
      "pull_request_review_id" : 1390979304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170599313/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-18T21:45:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1170599313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1174393895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1174393895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: if you have to retouch. Can remove the context ref.\r\n```suggestion\r\n    auto try_updating_state = [](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {\r\n```",
      "commit_id" : "e320f49c8b2c48b7ea9b16f62784946cfc0446c1",
      "created_at" : "2023-04-22T11:39:23Z",
      "diff_hunk" : "@@ -1282,44 +1277,25 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n-        int currentconfirm = GetTxDepthInMainChain(wtx);\n-        // If the orig tx was not in block, none of its spends can be\n-        assert(currentconfirm <= 0);\n-        // if (currentconfirm < 0) {Tx and spends are already conflicted, no need to abandon}\n-        if (currentconfirm == 0 && !wtx.isAbandoned()) {\n-            // If the orig tx was not in block/mempool, none of its spends can be in mempool\n-            assert(!wtx.InMempool());\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1174393895",
      "id" : 1174393895,
      "line" : 1280,
      "node_id" : "PRRC_kwDOABII585F_9Qn",
      "original_commit_id" : "26aff02b3f950f45cab609fa8d0cef4dfb18eade",
      "original_line" : 1280,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 32,
      "pull_request_review_id" : 1396709607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1174393895/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-22T11:43:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1174393895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1174426912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1174426912"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "6f1d394896fcc7e2687b766418f9cd4e55b613b5",
      "created_at" : "2023-04-22T15:08:06Z",
      "diff_hunk" : "@@ -1282,44 +1277,25 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n         return false;\n     }\n \n-    todo.insert(hashTx);\n-\n-    while (!todo.empty()) {\n-        uint256 now = *todo.begin();\n-        todo.erase(now);\n-        done.insert(now);\n-        auto it = mapWallet.find(now);\n-        assert(it != mapWallet.end());\n-        CWalletTx& wtx = it->second;\n-        int currentconfirm = GetTxDepthInMainChain(wtx);\n-        // If the orig tx was not in block, none of its spends can be\n-        assert(currentconfirm <= 0);\n-        // if (currentconfirm < 0) {Tx and spends are already conflicted, no need to abandon}\n-        if (currentconfirm == 0 && !wtx.isAbandoned()) {\n-            // If the orig tx was not in block/mempool, none of its spends can be in mempool\n-            assert(!wtx.InMempool());\n+    auto try_updating_state = [&](CWalletTx& wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1174426912",
      "id" : 1174426912,
      "in_reply_to_id" : 1174393895,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585GAFUg",
      "original_commit_id" : "26aff02b3f950f45cab609fa8d0cef4dfb18eade",
      "original_line" : 1280,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1396749905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1174426912/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-22T15:08:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1174426912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased to fix failing CI.",
      "created_at" : "2023-04-22T15:08:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#issuecomment-1518682303",
      "id" : 1518682303,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27145",
      "node_id" : "IC_kwDOABII585ahUC_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1518682303/reactions"
      },
      "updated_at" : "2023-04-22T15:08:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1518682303",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1185000020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1185000020"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Let me see if I'm following this:\r\n\r\n`Tx_AB1` spends B, and `Tx_ABC2` (the child of `Tx_AB1`) spends C. So, when the double spend tx gets disconnected, `Tx_AB1` state changes to `inactive`, marking output B and C as spent again.\r\n\r\nWhich ends up with the txes stuck now right?, and the user need to manually re-submit them.",
      "commit_id" : "6f1d394896fcc7e2687b766418f9cd4e55b613b5",
      "created_at" : "2023-05-04T13:15:40Z",
      "diff_hunk" : "@@ -226,20 +226,16 @@ def run_test(self):\n         assert_equal(double_spend[\"walletconflicts\"], [txAB1])\n \n         # Verify that B and C's 10 BTC outputs are available for spending again because AB1 is now conflicted\n+        assert_equal(alice.gettransaction(txAB1)[\"confirmations\"], -1)\n         newbalance = alice.getbalance()\n         assert_equal(newbalance, balance + Decimal(\"20\"))\n         balance = newbalance\n \n-        # There is currently a minor bug around this and so this test doesn't work.  See Issue #7315\n-        # Invalidate the block with the double spend and B's 10 BTC output should no longer be available\n-        # Don't think C's should either\n+        # Invalidate the block with the double spend. B & C's 10 BTC outputs should no longer be available",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1185000020",
      "id" : 1185000020,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII585GoapU",
      "original_commit_id" : "62cdcd02cd3ae5ad766b89abc211a745598bdbaa",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/wallet_abandonconflict.py",
      "position" : 12,
      "pull_request_review_id" : 1413069965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1185000020/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-04T13:25:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1185000020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1186241747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1186241747"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, the user would need to manually re-submit them or wait for the wallet to re-submit them automatically.",
      "commit_id" : "6f1d394896fcc7e2687b766418f9cd4e55b613b5",
      "created_at" : "2023-05-05T15:39:27Z",
      "diff_hunk" : "@@ -226,20 +226,16 @@ def run_test(self):\n         assert_equal(double_spend[\"walletconflicts\"], [txAB1])\n \n         # Verify that B and C's 10 BTC outputs are available for spending again because AB1 is now conflicted\n+        assert_equal(alice.gettransaction(txAB1)[\"confirmations\"], -1)\n         newbalance = alice.getbalance()\n         assert_equal(newbalance, balance + Decimal(\"20\"))\n         balance = newbalance\n \n-        # There is currently a minor bug around this and so this test doesn't work.  See Issue #7315\n-        # Invalidate the block with the double spend and B's 10 BTC output should no longer be available\n-        # Don't think C's should either\n+        # Invalidate the block with the double spend. B & C's 10 BTC outputs should no longer be available",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1186241747",
      "id" : 1186241747,
      "in_reply_to_id" : 1185000020,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII585GtJzT",
      "original_commit_id" : "62cdcd02cd3ae5ad766b89abc211a745598bdbaa",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/wallet_abandonconflict.py",
      "position" : 12,
      "pull_request_review_id" : 1415028425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1186241747/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-05T15:39:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1186241747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1192328933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192328933"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good. Not sure if there is any but would be nice to have coverage for the automatic re-submission. Would just need to mock the node time 24hs in the future and see if they get re-submitted.",
      "commit_id" : "6f1d394896fcc7e2687b766418f9cd4e55b613b5",
      "created_at" : "2023-05-12T12:52:36Z",
      "diff_hunk" : "@@ -226,20 +226,16 @@ def run_test(self):\n         assert_equal(double_spend[\"walletconflicts\"], [txAB1])\n \n         # Verify that B and C's 10 BTC outputs are available for spending again because AB1 is now conflicted\n+        assert_equal(alice.gettransaction(txAB1)[\"confirmations\"], -1)\n         newbalance = alice.getbalance()\n         assert_equal(newbalance, balance + Decimal(\"20\"))\n         balance = newbalance\n \n-        # There is currently a minor bug around this and so this test doesn't work.  See Issue #7315\n-        # Invalidate the block with the double spend and B's 10 BTC output should no longer be available\n-        # Don't think C's should either\n+        # Invalidate the block with the double spend. B & C's 10 BTC outputs should no longer be available",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1192328933",
      "id" : 1192328933,
      "in_reply_to_id" : 1185000020,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII585HEX7l",
      "original_commit_id" : "62cdcd02cd3ae5ad766b89abc211a745598bdbaa",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/wallet_abandonconflict.py",
      "position" : 12,
      "pull_request_review_id" : 1424453210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192328933/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-12T12:52:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192328933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've fixed a bug which resulted in the conflicted tx not being marked as inactive if the conflicting tx was not in `mapTxSpends`.",
      "created_at" : "2023-05-14T14:52:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#issuecomment-1546917869",
      "id" : 1546917869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27145",
      "node_id" : "IC_kwDOABII585cNBft",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546917869/reactions"
      },
      "updated_at" : "2023-05-14T14:52:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546917869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1193162426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1193162426"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There are some tests for that here: https://github.com/bitcoin/bitcoin/blob/master/test/functional/wallet_resendwallettransactions.py. Or did you mean that a test for that should be added for this PR specifically?",
      "commit_id" : "89df7987c2f1eea42454c2b0efc31a924fbfd3a8",
      "created_at" : "2023-05-14T14:59:52Z",
      "diff_hunk" : "@@ -226,20 +226,16 @@ def run_test(self):\n         assert_equal(double_spend[\"walletconflicts\"], [txAB1])\n \n         # Verify that B and C's 10 BTC outputs are available for spending again because AB1 is now conflicted\n+        assert_equal(alice.gettransaction(txAB1)[\"confirmations\"], -1)\n         newbalance = alice.getbalance()\n         assert_equal(newbalance, balance + Decimal(\"20\"))\n         balance = newbalance\n \n-        # There is currently a minor bug around this and so this test doesn't work.  See Issue #7315\n-        # Invalidate the block with the double spend and B's 10 BTC output should no longer be available\n-        # Don't think C's should either\n+        # Invalidate the block with the double spend. B & C's 10 BTC outputs should no longer be available",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27145#discussion_r1193162426",
      "id" : 1193162426,
      "in_reply_to_id" : 1185000020,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII585HHja6",
      "original_commit_id" : "62cdcd02cd3ae5ad766b89abc211a745598bdbaa",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/wallet_abandonconflict.py",
      "position" : 12,
      "pull_request_review_id" : 1425564449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27145",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1193162426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-14T14:59:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1193162426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   }
]
