[
   {
      "body" : "Nice.. I've wanted something like 'generate'  Passes quick-glance review.  Will test.\r\n",
      "created_at" : "2015-04-01T03:56:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-88342337",
      "id" : 88342337,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-01T03:56:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/88342337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Travis failure\r\n```\r\nRunning testscript wallet.py...\r\nInitializing test directory /tmp/testFqH6I5\r\nMining blocks...\r\nJSONRPC error: value is type \r\n  File \"/home/travis/build/bitcoin/bitcoin/bitcoin-i686-pc-linux-gnu/qa/rpc-tests/test_framework.py\", line 117, in main\r\n    self.run_test()\r\n  File \"/home/travis/build/bitcoin/bitcoin/bitcoin-i686-pc-linux-gnu/qa/rpc-tests/wallet.py\", line 43, in run_test\r\n    self.nodes[0].generate(1)\r\n  File \"/home/travis/build/bitcoin/bitcoin/bitcoin-i686-pc-linux-gnu/qa/rpc-tests/python-bitcoinrpc/bitcoinrpc/authproxy.py\", line 126, in __call__\r\n    raise JSONRPCException(response['error'])\r\nCleaning up\r\nFailed\r\n```",
      "created_at" : "2015-04-01T07:32:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-88378557",
      "id" : 88378557,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-01T07:32:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/88378557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=3",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "body" : "@fanquake Fixed.",
      "created_at" : "2015-04-01T20:03:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-88615107",
      "id" : 88615107,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-01T20:03:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/88615107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27958516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27958516"
         }
      },
      "body" : "We should probably change this at some point too to not update the mapArgs. Throughout the program we assume that mapArgs is read-only after initialization. This kind of r/w access would need proper locking around everything. No change needed for this pull but I'm just reminded of it.\r\n",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T10:33:04Z",
      "diff_hunk" : "@@ -154,52 +190,9 @@ Value setgenerate(const Array& params, bool fHelp)\n             fGenerate = false;\n     }\n \n-    // -regtest mode: don't return until nGenProcLimit blocks are generated\n-    if (fGenerate && Params().MineBlocksOnDemand())\n-    {\n-        int nHeightStart = 0;\n-        int nHeightEnd = 0;\n-        int nHeight = 0;\n-        int nGenerate = (nGenProcLimit > 0 ? nGenProcLimit : 1);\n-        CReserveKey reservekey(pwalletMain);\n-\n-        {   // Don't keep cs_main locked\n-            LOCK(cs_main);\n-            nHeightStart = chainActive.Height();\n-            nHeight = nHeightStart;\n-            nHeightEnd = nHeightStart+nGenerate;\n-        }\n-        unsigned int nExtraNonce = 0;\n-        Array blockHashes;\n-        while (nHeight < nHeightEnd)\n-        {\n-            auto_ptr<CBlockTemplate> pblocktemplate(CreateNewBlockWithKey(reservekey));\n-            if (!pblocktemplate.get())\n-                throw JSONRPCError(RPC_INTERNAL_ERROR, \"Wallet keypool empty\");\n-            CBlock *pblock = &pblocktemplate->block;\n-            {\n-                LOCK(cs_main);\n-                IncrementExtraNonce(pblock, chainActive.Tip(), nExtraNonce);\n-            }\n-            while (!CheckProofOfWork(pblock->GetHash(), pblock->nBits, Params().GetConsensus())) {\n-                // Yes, there is a chance every nonce could fail to satisfy the -regtest\n-                // target -- 1 in 2^(2^32). That ain't gonna happen.\n-                ++pblock->nNonce;\n-            }\n-            CValidationState state;\n-            if (!ProcessNewBlock(state, NULL, pblock))\n-                throw JSONRPCError(RPC_INTERNAL_ERROR, \"ProcessNewBlock, block not accepted\");\n-            ++nHeight;\n-            blockHashes.push_back(pblock->GetHash().GetHex());\n-        }\n-        return blockHashes;\n-    }\n-    else // Not -regtest: start generate thread, return immediately\n-    {\n-        mapArgs[\"-gen\"] = (fGenerate ? \"1\" : \"0\");\n-        mapArgs [\"-genproclimit\"] = itostr(nGenProcLimit);\n-        GenerateBitcoins(fGenerate, pwalletMain, nGenProcLimit);\n-    }\n+    mapArgs[\"-gen\"] = (fGenerate ? \"1\" : \"0\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27958516",
      "id" : 27958516,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 106,
      "path" : "src/rpcmining.cpp",
      "position" : 106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T10:33:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27958516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "This is obviously the right way to go, utACK\r\n\r\nEdit: tested ACK",
      "created_at" : "2015-04-08T10:34:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-90875097",
      "id" : 90875097,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-08T11:48:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/90875097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27985935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27985935"
         }
      },
      "body" : "Can't we directly return CheckProofOfWork() here instead of true and remove the later ```UintToArith256(hash) <= hashTarget``` check in ScanLoop() [which means you can also remove the uint256 *phash param in ScanHash()] ?\r\n",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T16:19:29Z",
      "diff_hunk" : "@@ -365,45 +365,34 @@ void IncrementExtraNonce(CBlock* pblock, CBlockIndex* pindexPrev, unsigned int&\n \n //\n // ScanHash scans nonces looking for a hash with at least some zero bits.\n-// The nonce is usually preserved between calls, but periodically or if the\n-// nonce is 0xffff0000 or above, the block is rebuilt and nNonce starts over at\n-// zero.\n+// The nonce is usually preserved between calls, but periodically the block is\n+// rebuilt and nNonce starts over at zero.\n //\n-bool static ScanHash(const CBlockHeader *pblock, uint32_t& nNonce, uint256 *phash)\n+bool static ScanHash(CBlockHeader *pblock, uint256 *phash)\n {\n-    // Write the first 76 bytes of the block header to a double-SHA256 state.\n-    CHash256 hasher;\n-    CDataStream ss(SER_NETWORK, PROTOCOL_VERSION);\n-    ss << *pblock;\n-    assert(ss.size() == 80);\n-    hasher.Write((unsigned char*)&ss[0], 76);\n-\n     while (true) {\n-        nNonce++;\n-\n-        // Write the last 4 bytes of the block header (the nonce) to a copy of\n-        // the double-SHA256 state, and compute the result.\n-        CHash256(hasher).Write((unsigned char*)&nNonce, 4).Finalize((unsigned char*)phash);\n+        pblock->nNonce++;\n+        *phash = pblock->GetHash();\n \n         // Return the nonce if the hash has at least some zero bits,\n         // caller will check if it has enough to reach the target\n         if (((uint16_t*)phash)[15] == 0)\n             return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27985935",
      "id" : 27985935,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 50,
      "path" : "src/miner.cpp",
      "position" : 50,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T16:19:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27985935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27986007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27986007"
         }
      },
      "body" : "Isn't this included here https://github.com/bitcoin/bitcoin/pull/5957/files#diff-4a59b408ad3778278c3aeffa7da33c3cR383   ?",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T16:20:33Z",
      "diff_hunk" : "@@ -435,6 +424,56 @@ static bool ProcessBlockFound(CBlock* pblock, CWallet& wallet, CReserveKey& rese\n     return true;\n }\n \n+bool static ScanLoop(CBlock *pblock, CBlockIndex *pindexPrev, CWallet *pwallet, CReserveKey& reservekey)\n+{\n+    UpdateTime(pblock, pindexPrev);\n+    arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n+\n+    uint256 hash;\n+    if (ScanHash(pblock, &hash)) {\n+        if (UintToArith256(hash) <= hashTarget) {\n+            // Found a solution\n+            SetThreadPriority(THREAD_PRIORITY_NORMAL);\n+            LogPrintf(\"BitcoinMiner:\\n\");\n+            LogPrintf(\"proof-of-work found  \\n  hash: %s  \\ntarget: %s\\n\", hash.GetHex(), hashTarget.GetHex());\n+            ProcessBlockFound(pblock, *pwallet, reservekey);\n+            SetThreadPriority(THREAD_PRIORITY_LOWEST);\n+\n+            return true;\n+        }\n+    }\n+\n+    return false;\n+}\n+\n+bool MineBlock(CWallet *pwallet, uint256& hash)\n+{\n+    CReserveKey reservekey(pwallet);\n+    unsigned int nExtraNonce = 0;\n+\n+    while (true) {\n+        CBlockIndex *pindexPrev;\n+\n+        auto_ptr<CBlockTemplate> pblocktemplate(CreateNewBlockWithKey(reservekey, pindexPrev));\n+        if (!pblocktemplate.get()) {\n+            return false;\n+        }\n+\n+        CBlock *pblock = &pblocktemplate->block;\n+        IncrementExtraNonce(pblock, pindexPrev, nExtraNonce);\n+\n+        while (true) {\n+            if (ScanLoop(pblock, pindexPrev, pwallet, reservekey)) {\n+                hash = pblock->GetHash();\n+                return true;\n+            }\n+            boost::this_thread::interruption_point();\n+            if (pblock->nNonce >= 0xffff0000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27986007",
      "id" : 27986007,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 121,
      "path" : "src/miner.cpp",
      "position" : 121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T16:20:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27986007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27986025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27986025"
         }
      },
      "body" : "Isn't this included here https://github.com/bitcoin/bitcoin/pull/5957/files#diff-4a59b408ad3778278c3aeffa7da33c3cR383   ?",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T16:20:44Z",
      "diff_hunk" : "@@ -476,52 +515,23 @@ void static BitcoinMiner(CWallet *pwallet)\n             // Search\n             //\n             int64_t nStart = GetTime();\n-            arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n-            uint256 hash;\n-            uint32_t nNonce = 0;\n             while (true) {\n                 // Check if something found\n-                if (ScanHash(pblock, nNonce, &hash))\n-                {\n-                    if (UintToArith256(hash) <= hashTarget)\n-                    {\n-                        // Found a solution\n-                        pblock->nNonce = nNonce;\n-                        assert(hash == pblock->GetHash());\n-\n-                        SetThreadPriority(THREAD_PRIORITY_NORMAL);\n-                        LogPrintf(\"BitcoinMiner:\\n\");\n-                        LogPrintf(\"proof-of-work found  \\n  hash: %s  \\ntarget: %s\\n\", hash.GetHex(), hashTarget.GetHex());\n-                        ProcessBlockFound(pblock, *pwallet, reservekey);\n-                        SetThreadPriority(THREAD_PRIORITY_LOWEST);\n-\n-                        // In regression test mode, stop mining after a block is found.\n-                        if (Params().MineBlocksOnDemand())\n-                            throw boost::thread_interrupted();\n-\n-                        break;\n-                    }\n-                }\n+                if (ScanLoop(pblock, pindexPrev, pwallet, reservekey))\n+                    break;\n \n                 // Check for stop or if block needs to be rebuilt\n                 boost::this_thread::interruption_point();\n                 // Regtest mode doesn't require peers\n                 if (vNodes.empty() && Params().MiningRequiresPeers())\n                     break;\n-                if (nNonce >= 0xffff0000)\n+                if (pblock->nNonce >= 0xffff0000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27986025",
      "id" : 27986025,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 181,
      "path" : "src/miner.cpp",
      "position" : 181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T16:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27986025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27987670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27987670"
         }
      },
      "body" : "Even without CheckProofOfWork, that check belongs inside ScanHash so you can save the hash parameter and the hash parameter and you can reuse the ```arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);``` instead of repeating the conversion every time ```((uint16_t*)phash)[15] == 0```. At that point, I'm not sure it's worth it to remove the optimization but I'm still not opposed to removing it.\r\nAnd of course it can be && in the condition rather than returning.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T16:36:37Z",
      "diff_hunk" : "@@ -365,45 +365,34 @@ void IncrementExtraNonce(CBlock* pblock, CBlockIndex* pindexPrev, unsigned int&\n \n //\n // ScanHash scans nonces looking for a hash with at least some zero bits.\n-// The nonce is usually preserved between calls, but periodically or if the\n-// nonce is 0xffff0000 or above, the block is rebuilt and nNonce starts over at\n-// zero.\n+// The nonce is usually preserved between calls, but periodically the block is\n+// rebuilt and nNonce starts over at zero.\n //\n-bool static ScanHash(const CBlockHeader *pblock, uint32_t& nNonce, uint256 *phash)\n+bool static ScanHash(CBlockHeader *pblock, uint256 *phash)\n {\n-    // Write the first 76 bytes of the block header to a double-SHA256 state.\n-    CHash256 hasher;\n-    CDataStream ss(SER_NETWORK, PROTOCOL_VERSION);\n-    ss << *pblock;\n-    assert(ss.size() == 80);\n-    hasher.Write((unsigned char*)&ss[0], 76);\n-\n     while (true) {\n-        nNonce++;\n-\n-        // Write the last 4 bytes of the block header (the nonce) to a copy of\n-        // the double-SHA256 state, and compute the result.\n-        CHash256(hasher).Write((unsigned char*)&nNonce, 4).Finalize((unsigned char*)phash);\n+        pblock->nNonce++;\n+        *phash = pblock->GetHash();\n \n         // Return the nonce if the hash has at least some zero bits,\n         // caller will check if it has enough to reach the target\n         if (((uint16_t*)phash)[15] == 0)\n             return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27987670",
      "id" : 27987670,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 50,
      "path" : "src/miner.cpp",
      "position" : 50,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T16:36:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27987670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27996629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27996629"
         }
      },
      "body" : "This is about resetting the nonce if it's about to overflow. The other check is about occasionally interrupting the mining loop.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T18:09:36Z",
      "diff_hunk" : "@@ -435,6 +424,56 @@ static bool ProcessBlockFound(CBlock* pblock, CWallet& wallet, CReserveKey& rese\n     return true;\n }\n \n+bool static ScanLoop(CBlock *pblock, CBlockIndex *pindexPrev, CWallet *pwallet, CReserveKey& reservekey)\n+{\n+    UpdateTime(pblock, pindexPrev);\n+    arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n+\n+    uint256 hash;\n+    if (ScanHash(pblock, &hash)) {\n+        if (UintToArith256(hash) <= hashTarget) {\n+            // Found a solution\n+            SetThreadPriority(THREAD_PRIORITY_NORMAL);\n+            LogPrintf(\"BitcoinMiner:\\n\");\n+            LogPrintf(\"proof-of-work found  \\n  hash: %s  \\ntarget: %s\\n\", hash.GetHex(), hashTarget.GetHex());\n+            ProcessBlockFound(pblock, *pwallet, reservekey);\n+            SetThreadPriority(THREAD_PRIORITY_LOWEST);\n+\n+            return true;\n+        }\n+    }\n+\n+    return false;\n+}\n+\n+bool MineBlock(CWallet *pwallet, uint256& hash)\n+{\n+    CReserveKey reservekey(pwallet);\n+    unsigned int nExtraNonce = 0;\n+\n+    while (true) {\n+        CBlockIndex *pindexPrev;\n+\n+        auto_ptr<CBlockTemplate> pblocktemplate(CreateNewBlockWithKey(reservekey, pindexPrev));\n+        if (!pblocktemplate.get()) {\n+            return false;\n+        }\n+\n+        CBlock *pblock = &pblocktemplate->block;\n+        IncrementExtraNonce(pblock, pindexPrev, nExtraNonce);\n+\n+        while (true) {\n+            if (ScanLoop(pblock, pindexPrev, pwallet, reservekey)) {\n+                hash = pblock->GetHash();\n+                return true;\n+            }\n+            boost::this_thread::interruption_point();\n+            if (pblock->nNonce >= 0xffff0000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27996629",
      "id" : 27996629,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 121,
      "path" : "src/miner.cpp",
      "position" : 121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T18:09:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27996629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27996954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27996954"
         }
      },
      "body" : "Yeah, just CheckProofOfWork would be fine, if we removed its error reporting (which imho we should in any case...), as now regtest mining beyond the first 2016 blocks prints 1000s of error messages to the log for each miner block as a result.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T18:12:42Z",
      "diff_hunk" : "@@ -365,45 +365,34 @@ void IncrementExtraNonce(CBlock* pblock, CBlockIndex* pindexPrev, unsigned int&\n \n //\n // ScanHash scans nonces looking for a hash with at least some zero bits.\n-// The nonce is usually preserved between calls, but periodically or if the\n-// nonce is 0xffff0000 or above, the block is rebuilt and nNonce starts over at\n-// zero.\n+// The nonce is usually preserved between calls, but periodically the block is\n+// rebuilt and nNonce starts over at zero.\n //\n-bool static ScanHash(const CBlockHeader *pblock, uint32_t& nNonce, uint256 *phash)\n+bool static ScanHash(CBlockHeader *pblock, uint256 *phash)\n {\n-    // Write the first 76 bytes of the block header to a double-SHA256 state.\n-    CHash256 hasher;\n-    CDataStream ss(SER_NETWORK, PROTOCOL_VERSION);\n-    ss << *pblock;\n-    assert(ss.size() == 80);\n-    hasher.Write((unsigned char*)&ss[0], 76);\n-\n     while (true) {\n-        nNonce++;\n-\n-        // Write the last 4 bytes of the block header (the nonce) to a copy of\n-        // the double-SHA256 state, and compute the result.\n-        CHash256(hasher).Write((unsigned char*)&nNonce, 4).Finalize((unsigned char*)phash);\n+        pblock->nNonce++;\n+        *phash = pblock->GetHash();\n \n         // Return the nonce if the hash has at least some zero bits,\n         // caller will check if it has enough to reach the target\n         if (((uint16_t*)phash)[15] == 0)\n             return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27996954",
      "id" : 27996954,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 50,
      "path" : "src/miner.cpp",
      "position" : 50,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T18:12:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27996954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27998129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27998129"
         }
      },
      "body" : "Agree.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T18:23:34Z",
      "diff_hunk" : "@@ -154,52 +190,9 @@ Value setgenerate(const Array& params, bool fHelp)\n             fGenerate = false;\n     }\n \n-    // -regtest mode: don't return until nGenProcLimit blocks are generated\n-    if (fGenerate && Params().MineBlocksOnDemand())\n-    {\n-        int nHeightStart = 0;\n-        int nHeightEnd = 0;\n-        int nHeight = 0;\n-        int nGenerate = (nGenProcLimit > 0 ? nGenProcLimit : 1);\n-        CReserveKey reservekey(pwalletMain);\n-\n-        {   // Don't keep cs_main locked\n-            LOCK(cs_main);\n-            nHeightStart = chainActive.Height();\n-            nHeight = nHeightStart;\n-            nHeightEnd = nHeightStart+nGenerate;\n-        }\n-        unsigned int nExtraNonce = 0;\n-        Array blockHashes;\n-        while (nHeight < nHeightEnd)\n-        {\n-            auto_ptr<CBlockTemplate> pblocktemplate(CreateNewBlockWithKey(reservekey));\n-            if (!pblocktemplate.get())\n-                throw JSONRPCError(RPC_INTERNAL_ERROR, \"Wallet keypool empty\");\n-            CBlock *pblock = &pblocktemplate->block;\n-            {\n-                LOCK(cs_main);\n-                IncrementExtraNonce(pblock, chainActive.Tip(), nExtraNonce);\n-            }\n-            while (!CheckProofOfWork(pblock->GetHash(), pblock->nBits, Params().GetConsensus())) {\n-                // Yes, there is a chance every nonce could fail to satisfy the -regtest\n-                // target -- 1 in 2^(2^32). That ain't gonna happen.\n-                ++pblock->nNonce;\n-            }\n-            CValidationState state;\n-            if (!ProcessNewBlock(state, NULL, pblock))\n-                throw JSONRPCError(RPC_INTERNAL_ERROR, \"ProcessNewBlock, block not accepted\");\n-            ++nHeight;\n-            blockHashes.push_back(pblock->GetHash().GetHex());\n-        }\n-        return blockHashes;\n-    }\n-    else // Not -regtest: start generate thread, return immediately\n-    {\n-        mapArgs[\"-gen\"] = (fGenerate ? \"1\" : \"0\");\n-        mapArgs [\"-genproclimit\"] = itostr(nGenProcLimit);\n-        GenerateBitcoins(fGenerate, pwalletMain, nGenProcLimit);\n-    }\n+    mapArgs[\"-gen\"] = (fGenerate ? \"1\" : \"0\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r27998129",
      "id" : 27998129,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 106,
      "path" : "src/rpcmining.cpp",
      "position" : 106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T18:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27998129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28013125"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28013125"
         }
      },
      "body" : "Can you at least move the check in ScanLoop inside ScanHash for now?",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T21:05:27Z",
      "diff_hunk" : "@@ -365,45 +365,34 @@ void IncrementExtraNonce(CBlock* pblock, CBlockIndex* pindexPrev, unsigned int&\n \n //\n // ScanHash scans nonces looking for a hash with at least some zero bits.\n-// The nonce is usually preserved between calls, but periodically or if the\n-// nonce is 0xffff0000 or above, the block is rebuilt and nNonce starts over at\n-// zero.\n+// The nonce is usually preserved between calls, but periodically the block is\n+// rebuilt and nNonce starts over at zero.\n //\n-bool static ScanHash(const CBlockHeader *pblock, uint32_t& nNonce, uint256 *phash)\n+bool static ScanHash(CBlockHeader *pblock, uint256 *phash)\n {\n-    // Write the first 76 bytes of the block header to a double-SHA256 state.\n-    CHash256 hasher;\n-    CDataStream ss(SER_NETWORK, PROTOCOL_VERSION);\n-    ss << *pblock;\n-    assert(ss.size() == 80);\n-    hasher.Write((unsigned char*)&ss[0], 76);\n-\n     while (true) {\n-        nNonce++;\n-\n-        // Write the last 4 bytes of the block header (the nonce) to a copy of\n-        // the double-SHA256 state, and compute the result.\n-        CHash256(hasher).Write((unsigned char*)&nNonce, 4).Finalize((unsigned char*)phash);\n+        pblock->nNonce++;\n+        *phash = pblock->GetHash();\n \n         // Return the nonce if the hash has at least some zero bits,\n         // caller will check if it has enough to reach the target\n         if (((uint16_t*)phash)[15] == 0)\n             return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28013125",
      "id" : 28013125,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 50,
      "path" : "src/miner.cpp",
      "position" : 50,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T21:05:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28013125",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28017344"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28017344"
         }
      },
      "body" : "Sorry, you can prevent the overflow by replacing the middle while(true) loop [the one that first checks if ScanLoop()] with a for loop. Then you can remove this check (from the two places it appears in) and this access to CBlockHeader::nNonce is not required.\r\nBy the way, you're incrementing CBlockHeader::nNonce in ScanHash, but where are you resetting it to 0? ",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T21:50:13Z",
      "diff_hunk" : "@@ -435,6 +424,56 @@ static bool ProcessBlockFound(CBlock* pblock, CWallet& wallet, CReserveKey& rese\n     return true;\n }\n \n+bool static ScanLoop(CBlock *pblock, CBlockIndex *pindexPrev, CWallet *pwallet, CReserveKey& reservekey)\n+{\n+    UpdateTime(pblock, pindexPrev);\n+    arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n+\n+    uint256 hash;\n+    if (ScanHash(pblock, &hash)) {\n+        if (UintToArith256(hash) <= hashTarget) {\n+            // Found a solution\n+            SetThreadPriority(THREAD_PRIORITY_NORMAL);\n+            LogPrintf(\"BitcoinMiner:\\n\");\n+            LogPrintf(\"proof-of-work found  \\n  hash: %s  \\ntarget: %s\\n\", hash.GetHex(), hashTarget.GetHex());\n+            ProcessBlockFound(pblock, *pwallet, reservekey);\n+            SetThreadPriority(THREAD_PRIORITY_LOWEST);\n+\n+            return true;\n+        }\n+    }\n+\n+    return false;\n+}\n+\n+bool MineBlock(CWallet *pwallet, uint256& hash)\n+{\n+    CReserveKey reservekey(pwallet);\n+    unsigned int nExtraNonce = 0;\n+\n+    while (true) {\n+        CBlockIndex *pindexPrev;\n+\n+        auto_ptr<CBlockTemplate> pblocktemplate(CreateNewBlockWithKey(reservekey, pindexPrev));\n+        if (!pblocktemplate.get()) {\n+            return false;\n+        }\n+\n+        CBlock *pblock = &pblocktemplate->block;\n+        IncrementExtraNonce(pblock, pindexPrev, nExtraNonce);\n+\n+        while (true) {\n+            if (ScanLoop(pblock, pindexPrev, pwallet, reservekey)) {\n+                hash = pblock->GetHash();\n+                return true;\n+            }\n+            boost::this_thread::interruption_point();\n+            if (pblock->nNonce >= 0xffff0000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28017344",
      "id" : 28017344,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 121,
      "path" : "src/miner.cpp",
      "position" : 121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T21:50:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28017344",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28017873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28017873"
         }
      },
      "body" : "This can be moved inside ScanLoop to avoid code duplication.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T21:56:13Z",
      "diff_hunk" : "@@ -476,52 +515,23 @@ void static BitcoinMiner(CWallet *pwallet)\n             // Search\n             //\n             int64_t nStart = GetTime();\n-            arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n-            uint256 hash;\n-            uint32_t nNonce = 0;\n             while (true) {\n                 // Check if something found\n-                if (ScanHash(pblock, nNonce, &hash))\n-                {\n-                    if (UintToArith256(hash) <= hashTarget)\n-                    {\n-                        // Found a solution\n-                        pblock->nNonce = nNonce;\n-                        assert(hash == pblock->GetHash());\n-\n-                        SetThreadPriority(THREAD_PRIORITY_NORMAL);\n-                        LogPrintf(\"BitcoinMiner:\\n\");\n-                        LogPrintf(\"proof-of-work found  \\n  hash: %s  \\ntarget: %s\\n\", hash.GetHex(), hashTarget.GetHex());\n-                        ProcessBlockFound(pblock, *pwallet, reservekey);\n-                        SetThreadPriority(THREAD_PRIORITY_LOWEST);\n-\n-                        // In regression test mode, stop mining after a block is found.\n-                        if (Params().MineBlocksOnDemand())\n-                            throw boost::thread_interrupted();\n-\n-                        break;\n-                    }\n-                }\n+                if (ScanLoop(pblock, pindexPrev, pwallet, reservekey))\n+                    break;\n \n                 // Check for stop or if block needs to be rebuilt\n                 boost::this_thread::interruption_point();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28017873",
      "id" : 28017873,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 176,
      "path" : "src/miner.cpp",
      "position" : 176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T21:56:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28017873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28019878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28019878"
         }
      },
      "body" : "I'm not doing that as long as it produces this much debug output - that makes it effectively unusable for mining a >2016 long block chain. That error output should probably be discussed elsewhere.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T22:20:57Z",
      "diff_hunk" : "@@ -365,45 +365,34 @@ void IncrementExtraNonce(CBlock* pblock, CBlockIndex* pindexPrev, unsigned int&\n \n //\n // ScanHash scans nonces looking for a hash with at least some zero bits.\n-// The nonce is usually preserved between calls, but periodically or if the\n-// nonce is 0xffff0000 or above, the block is rebuilt and nNonce starts over at\n-// zero.\n+// The nonce is usually preserved between calls, but periodically the block is\n+// rebuilt and nNonce starts over at zero.\n //\n-bool static ScanHash(const CBlockHeader *pblock, uint32_t& nNonce, uint256 *phash)\n+bool static ScanHash(CBlockHeader *pblock, uint256 *phash)\n {\n-    // Write the first 76 bytes of the block header to a double-SHA256 state.\n-    CHash256 hasher;\n-    CDataStream ss(SER_NETWORK, PROTOCOL_VERSION);\n-    ss << *pblock;\n-    assert(ss.size() == 80);\n-    hasher.Write((unsigned char*)&ss[0], 76);\n-\n     while (true) {\n-        nNonce++;\n-\n-        // Write the last 4 bytes of the block header (the nonce) to a copy of\n-        // the double-SHA256 state, and compute the result.\n-        CHash256(hasher).Write((unsigned char*)&nNonce, 4).Finalize((unsigned char*)phash);\n+        pblock->nNonce++;\n+        *phash = pblock->GetHash();\n \n         // Return the nonce if the hash has at least some zero bits,\n         // caller will check if it has enough to reach the target\n         if (((uint16_t*)phash)[15] == 0)\n             return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28019878",
      "id" : 28019878,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 50,
      "path" : "src/miner.cpp",
      "position" : 50,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T22:20:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28019878",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28020798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28020798"
         }
      },
      "body" : "ack",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T22:33:52Z",
      "diff_hunk" : "@@ -476,52 +515,23 @@ void static BitcoinMiner(CWallet *pwallet)\n             // Search\n             //\n             int64_t nStart = GetTime();\n-            arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n-            uint256 hash;\n-            uint32_t nNonce = 0;\n             while (true) {\n                 // Check if something found\n-                if (ScanHash(pblock, nNonce, &hash))\n-                {\n-                    if (UintToArith256(hash) <= hashTarget)\n-                    {\n-                        // Found a solution\n-                        pblock->nNonce = nNonce;\n-                        assert(hash == pblock->GetHash());\n-\n-                        SetThreadPriority(THREAD_PRIORITY_NORMAL);\n-                        LogPrintf(\"BitcoinMiner:\\n\");\n-                        LogPrintf(\"proof-of-work found  \\n  hash: %s  \\ntarget: %s\\n\", hash.GetHex(), hashTarget.GetHex());\n-                        ProcessBlockFound(pblock, *pwallet, reservekey);\n-                        SetThreadPriority(THREAD_PRIORITY_LOWEST);\n-\n-                        // In regression test mode, stop mining after a block is found.\n-                        if (Params().MineBlocksOnDemand())\n-                            throw boost::thread_interrupted();\n-\n-                        break;\n-                    }\n-                }\n+                if (ScanLoop(pblock, pindexPrev, pwallet, reservekey))\n+                    break;\n \n                 // Check for stop or if block needs to be rebuilt\n                 boost::this_thread::interruption_point();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28020798",
      "id" : 28020798,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 176,
      "path" : "src/miner.cpp",
      "position" : 176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T22:33:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28020798",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28020880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28020880"
         }
      },
      "body" : "The nonce is reset when a new block attempt is created by calling CreateNewBlockWithKey.\r\n\r\nI don't understand the rest of the comment, but I'll try to rework it a bit.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T22:35:12Z",
      "diff_hunk" : "@@ -435,6 +424,56 @@ static bool ProcessBlockFound(CBlock* pblock, CWallet& wallet, CReserveKey& rese\n     return true;\n }\n \n+bool static ScanLoop(CBlock *pblock, CBlockIndex *pindexPrev, CWallet *pwallet, CReserveKey& reservekey)\n+{\n+    UpdateTime(pblock, pindexPrev);\n+    arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n+\n+    uint256 hash;\n+    if (ScanHash(pblock, &hash)) {\n+        if (UintToArith256(hash) <= hashTarget) {\n+            // Found a solution\n+            SetThreadPriority(THREAD_PRIORITY_NORMAL);\n+            LogPrintf(\"BitcoinMiner:\\n\");\n+            LogPrintf(\"proof-of-work found  \\n  hash: %s  \\ntarget: %s\\n\", hash.GetHex(), hashTarget.GetHex());\n+            ProcessBlockFound(pblock, *pwallet, reservekey);\n+            SetThreadPriority(THREAD_PRIORITY_LOWEST);\n+\n+            return true;\n+        }\n+    }\n+\n+    return false;\n+}\n+\n+bool MineBlock(CWallet *pwallet, uint256& hash)\n+{\n+    CReserveKey reservekey(pwallet);\n+    unsigned int nExtraNonce = 0;\n+\n+    while (true) {\n+        CBlockIndex *pindexPrev;\n+\n+        auto_ptr<CBlockTemplate> pblocktemplate(CreateNewBlockWithKey(reservekey, pindexPrev));\n+        if (!pblocktemplate.get()) {\n+            return false;\n+        }\n+\n+        CBlock *pblock = &pblocktemplate->block;\n+        IncrementExtraNonce(pblock, pindexPrev, nExtraNonce);\n+\n+        while (true) {\n+            if (ScanLoop(pblock, pindexPrev, pwallet, reservekey)) {\n+                hash = pblock->GetHash();\n+                return true;\n+            }\n+            boost::this_thread::interruption_point();\n+            if (pblock->nNonce >= 0xffff0000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28020880",
      "id" : 28020880,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 121,
      "path" : "src/miner.cpp",
      "position" : 121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T22:35:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28020880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28020978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28020978"
         }
      },
      "body" : "Wait, I misunderstood. Yes, that seems fine.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T22:36:40Z",
      "diff_hunk" : "@@ -365,45 +365,34 @@ void IncrementExtraNonce(CBlock* pblock, CBlockIndex* pindexPrev, unsigned int&\n \n //\n // ScanHash scans nonces looking for a hash with at least some zero bits.\n-// The nonce is usually preserved between calls, but periodically or if the\n-// nonce is 0xffff0000 or above, the block is rebuilt and nNonce starts over at\n-// zero.\n+// The nonce is usually preserved between calls, but periodically the block is\n+// rebuilt and nNonce starts over at zero.\n //\n-bool static ScanHash(const CBlockHeader *pblock, uint32_t& nNonce, uint256 *phash)\n+bool static ScanHash(CBlockHeader *pblock, uint256 *phash)\n {\n-    // Write the first 76 bytes of the block header to a double-SHA256 state.\n-    CHash256 hasher;\n-    CDataStream ss(SER_NETWORK, PROTOCOL_VERSION);\n-    ss << *pblock;\n-    assert(ss.size() == 80);\n-    hasher.Write((unsigned char*)&ss[0], 76);\n-\n     while (true) {\n-        nNonce++;\n-\n-        // Write the last 4 bytes of the block header (the nonce) to a copy of\n-        // the double-SHA256 state, and compute the result.\n-        CHash256(hasher).Write((unsigned char*)&nNonce, 4).Finalize((unsigned char*)phash);\n+        pblock->nNonce++;\n+        *phash = pblock->GetHash();\n \n         // Return the nonce if the hash has at least some zero bits,\n         // caller will check if it has enough to reach the target\n         if (((uint16_t*)phash)[15] == 0)\n             return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28020978",
      "id" : 28020978,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 50,
      "path" : "src/miner.cpp",
      "position" : 50,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T22:36:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28020978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28021545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28021545"
         }
      },
      "body" : "Yes, as said in the other PR I plan to solve the warning problem soon as part of the consensus work for blockheader.\r\nAt that point that check can be directly replaced by CheckProofOfWork, I'm not proposing to do it now.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T22:45:39Z",
      "diff_hunk" : "@@ -365,45 +365,34 @@ void IncrementExtraNonce(CBlock* pblock, CBlockIndex* pindexPrev, unsigned int&\n \n //\n // ScanHash scans nonces looking for a hash with at least some zero bits.\n-// The nonce is usually preserved between calls, but periodically or if the\n-// nonce is 0xffff0000 or above, the block is rebuilt and nNonce starts over at\n-// zero.\n+// The nonce is usually preserved between calls, but periodically the block is\n+// rebuilt and nNonce starts over at zero.\n //\n-bool static ScanHash(const CBlockHeader *pblock, uint32_t& nNonce, uint256 *phash)\n+bool static ScanHash(CBlockHeader *pblock, uint256 *phash)\n {\n-    // Write the first 76 bytes of the block header to a double-SHA256 state.\n-    CHash256 hasher;\n-    CDataStream ss(SER_NETWORK, PROTOCOL_VERSION);\n-    ss << *pblock;\n-    assert(ss.size() == 80);\n-    hasher.Write((unsigned char*)&ss[0], 76);\n-\n     while (true) {\n-        nNonce++;\n-\n-        // Write the last 4 bytes of the block header (the nonce) to a copy of\n-        // the double-SHA256 state, and compute the result.\n-        CHash256(hasher).Write((unsigned char*)&nNonce, 4).Finalize((unsigned char*)phash);\n+        pblock->nNonce++;\n+        *phash = pblock->GetHash();\n \n         // Return the nonce if the hash has at least some zero bits,\n         // caller will check if it has enough to reach the target\n         if (((uint16_t*)phash)[15] == 0)\n             return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28021545",
      "id" : 28021545,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 50,
      "path" : "src/miner.cpp",
      "position" : 50,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T22:46:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28021545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28021894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28021894"
         }
      },
      "body" : "I mean, it's just a nit and probably the more irrational one of the 3, I would just like to minimize the accesses to nBits and nNonce in the code so that the strictly-pow stuff doesn't take much to read.\r\nIf you don't make anything about this, thank you for the try.",
      "commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "created_at" : "2015-04-08T22:51:18Z",
      "diff_hunk" : "@@ -435,6 +424,56 @@ static bool ProcessBlockFound(CBlock* pblock, CWallet& wallet, CReserveKey& rese\n     return true;\n }\n \n+bool static ScanLoop(CBlock *pblock, CBlockIndex *pindexPrev, CWallet *pwallet, CReserveKey& reservekey)\n+{\n+    UpdateTime(pblock, pindexPrev);\n+    arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n+\n+    uint256 hash;\n+    if (ScanHash(pblock, &hash)) {\n+        if (UintToArith256(hash) <= hashTarget) {\n+            // Found a solution\n+            SetThreadPriority(THREAD_PRIORITY_NORMAL);\n+            LogPrintf(\"BitcoinMiner:\\n\");\n+            LogPrintf(\"proof-of-work found  \\n  hash: %s  \\ntarget: %s\\n\", hash.GetHex(), hashTarget.GetHex());\n+            ProcessBlockFound(pblock, *pwallet, reservekey);\n+            SetThreadPriority(THREAD_PRIORITY_LOWEST);\n+\n+            return true;\n+        }\n+    }\n+\n+    return false;\n+}\n+\n+bool MineBlock(CWallet *pwallet, uint256& hash)\n+{\n+    CReserveKey reservekey(pwallet);\n+    unsigned int nExtraNonce = 0;\n+\n+    while (true) {\n+        CBlockIndex *pindexPrev;\n+\n+        auto_ptr<CBlockTemplate> pblocktemplate(CreateNewBlockWithKey(reservekey, pindexPrev));\n+        if (!pblocktemplate.get()) {\n+            return false;\n+        }\n+\n+        CBlock *pblock = &pblocktemplate->block;\n+        IncrementExtraNonce(pblock, pindexPrev, nExtraNonce);\n+\n+        while (true) {\n+            if (ScanLoop(pblock, pindexPrev, pwallet, reservekey)) {\n+                hash = pblock->GetHash();\n+                return true;\n+            }\n+            boost::this_thread::interruption_point();\n+            if (pblock->nNonce >= 0xffff0000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#discussion_r28021894",
      "id" : 28021894,
      "original_commit_id" : "e2edf95cd3f43331843676e49a82830128a95050",
      "original_position" : 121,
      "path" : "src/miner.cpp",
      "position" : 121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5957",
      "updated_at" : "2015-04-08T22:51:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28021894",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "This makes -regtest block generation MUCH slower.\r\n\r\nBefore:\r\n```cd qa/rpc-tests; rm -rf cache; time mempool_resurrect_test.py```  --> 26 seconds.\r\n\r\nAfter: --> 2 minutes 10 seconds.\r\n",
      "created_at" : "2015-04-09T15:07:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-91257981",
      "id" : 91257981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-09T15:07:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/91257981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Apparently I merged this too soon, sorry.\r\n\r\n@sdaftuar noticed that this was giving problems with travis due to the slowdown @gavinandresen remarks on. I've thus reverted the changes to the mining code for now (but not the `generate` RPC call) in 48265f3.\r\n",
      "created_at" : "2015-04-10T06:32:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-91450447",
      "id" : 91450447,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-10T06:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/91450447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Reopened #4793, which also does some code simplifications in miner.cpp.\r\nI haven't measured regtest performance but it shouldn't make it slower, in fact I expect to make it slightly faster apart from saving some logs produced by CheckProofOfWork (though not all of them yet).\r\n@gavinandresen  can you test it?",
      "created_at" : "2015-04-10T09:33:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-91493504",
      "id" : 91493504,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-10T09:36:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/91493504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "While it's sort of easy to mitigate, changing the API of Bitcoin Core (`setgenerate true n`) introduces the risk of breaking system that currently use that API. Imho, similar to the depreciation of accounting system, it would be more gentle, to provide some backwards compability and clearly tag `setgenerate (regtest)` as depreciated, for one version.",
      "created_at" : "2015-04-11T11:36:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-91830913",
      "id" : 91830913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-11T11:36:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/91830913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5836089?v=3",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "body" : "@dexX7 I agree for any production usage of the RPC system, but this is\nregtest specific. Do you have any evidence of the regtest-specific\nsetgenerate being used elsewhere? If so, we can of course temporarily\nmaintain compatibility.\n",
      "created_at" : "2015-04-11T12:46:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-91837309",
      "id" : 91837309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-11T12:46:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/91837309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I see your point, and I don't have specific use-cases, but there are a few references to `setgenerate`, e.g. in the [Bitcoin developer guide](https://bitcoin.org/en/developer-examples#regtest-mode), the [Bitcoin wiki](https://en.bitcoin.it/wiki/Original_Bitcoin_client/API_calls_list) or BitcoinJ's [\"how to test applications\"](https://bitcoinj.github.io/testing), which may serve as indicator.\r\n\r\nThis change may be announced on the mailing list, to enquire additional feedback from actual users, which may, or may not be out there.",
      "created_at" : "2015-04-11T13:11:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-91843681",
      "id" : 91843681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-11T13:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/91843681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5836089?v=3",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "body" : "Thanks for pointing that out. I was not  aware that the dev guide mentioned\nthis.\n",
      "created_at" : "2015-04-11T13:24:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-91844270",
      "id" : 91844270,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-11T13:24:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/91844270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Here's the line in `BitcoinClient.java` in the OmniJ / bitcoin-spock project and something we are planning on contributing to bitcoinj to allow people to easily test their apps in RegTest mode:\r\n\r\nhttps://github.com/OmniLayer/OmniJ/blob/master/bitcoin-rpc/src/main/java/com/msgilligan/bitcoin/rpc/BitcoinClient.java#L195\r\n\r\nIf we are the only external use-case we can handle this change when it happens, but we may not be the only case.\r\n\r\n\r\n",
      "created_at" : "2015-04-14T17:13:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5957#issuecomment-92984718",
      "id" : 92984718,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5957",
      "updated_at" : "2015-04-14T17:13:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/92984718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/61612?v=3",
         "events_url" : "https://api.github.com/users/msgilligan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/msgilligan/followers",
         "following_url" : "https://api.github.com/users/msgilligan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/msgilligan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/msgilligan",
         "id" : 61612,
         "login" : "msgilligan",
         "organizations_url" : "https://api.github.com/users/msgilligan/orgs",
         "received_events_url" : "https://api.github.com/users/msgilligan/received_events",
         "repos_url" : "https://api.github.com/users/msgilligan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/msgilligan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/msgilligan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/msgilligan"
      }
   }
]
