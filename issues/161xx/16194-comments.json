[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\n> that was difficult because of git's inability to split hunks past a certain point\r\n\r\nFirst commit seems reasonable to me, and I wouldn't see a need to split it up further. But just for reference I'd recommend trying git add --patch's split and edit commands if you haven't used them before. The split command is good enough for splitting up changes most of the time, and when it isn't, the edit command is fallback that works really well.\r\n\r\n```\r\ns - split the current hunk into smaller hunks\r\ne - manually edit the current hunk\r\n```",
      "created_at" : "2019-06-12T15:10:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#issuecomment-501318333",
      "id" : 501318333,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16194",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTMxODMzMw==",
      "updated_at" : "2019-06-12T15:10:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501318333",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16362](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16362.html) (gui: Bilingual translation by hebasto)\n* [#16324](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16324.html) (Get cs_main out of the critical path in ProcessMessages by TheBlueMatt)\n* [#16323](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16323.html) (Call ProcessNewBlock() asynchronously by TheBlueMatt)\n* [#16224](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16224.html) (gui: Bilingual GUI error messages by hebasto)\n* [#15191](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15191.html) (validation: Add missing cs_{LastBlockFile,nBlockSequenceId} locks in PruneAndFlush() and UnloadBlockIndex(). Add missing locking annotations. by practicalswift)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-06-12T15:19:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#issuecomment-501322057",
      "id" : 501322057,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16194",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTMyMjA1Nw==",
      "updated_at" : "2019-07-10T16:20:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501322057",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r292988952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292988952"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7064f3045f41731dd8044cb6ef4277daedb06a2c\r\n\r\nstatic or in a anonymous namespace?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-12T15:48:27Z",
      "diff_hunk" : "@@ -77,7 +77,9 @@ bool CBlockIndexWorkComparator::operator()(const CBlockIndex *pa, const CBlockIn\n     return false;\n }\n \n-CChainState g_chainstate;\n+BlockManager g_blockman;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r292988952",
      "id" : 292988952,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5Mjk4ODk1Mg==",
      "original_commit_id" : "4368dea38456b05b4b6472ca6d5a286328851cbf",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 248855445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292988952",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r292996309"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292996309"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can be const?\r\n```cpp\r\nBlockMap& BlockIndex() const;\r\n```",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-12T16:03:36Z",
      "diff_hunk" : "@@ -571,23 +610,23 @@ class CChainState {\n \n     void UnloadBlockIndex();\n \n-    /** Check whether we are doing an initial block download (synchronizing from disk or network) */\n-    bool IsInitialBlockDownload() const;\n-\n-private:\n-    bool ActivateBestChainStep(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexMostWork, const std::shared_ptr<const CBlock>& pblock, bool& fInvalidFound, ConnectTrace& connectTrace) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    bool ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const std::shared_ptr<const CBlock>& pblock, ConnectTrace& connectTrace, DisconnectedBlockTransactions &disconnectpool) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-\n-    CBlockIndex* AddToBlockIndex(const CBlockHeader& block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    /** Create a new block index entry for a given block hash */\n-    CBlockIndex* InsertBlockIndex(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     /**\n      * Make various assertions about the state of the block index.\n      *\n      * By default this only executes fully when using the Regtest chain; see: fCheckBlockIndex.\n      */\n     void CheckBlockIndex(const Consensus::Params& consensusParams);\n \n+    /** Check whether we are doing an initial block download (synchronizing from disk or network) */\n+    bool IsInitialBlockDownload() const;\n+\n+    //! @returns the map of blocks that this chainstate is aware of.\n+    BlockMap& BlockIndex();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r292996309",
      "id" : 292996309,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5Mjk5NjMwOQ==",
      "original_commit_id" : "4368dea38456b05b4b6472ca6d5a286328851cbf",
      "original_position" : 215,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 248864785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292996309",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the look, guys. I've made @promag's suggested changes and squashed the second commit into the first.",
      "created_at" : "2019-06-14T17:44:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#issuecomment-502202121",
      "id" : 502202121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16194",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMjIwMjEyMQ==",
      "updated_at" : "2019-06-14T17:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/502202121",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294530483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294530483"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be static",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-17T21:42:31Z",
      "diff_hunk" : "@@ -77,7 +77,11 @@ bool CBlockIndexWorkComparator::operator()(const CBlockIndex *pa, const CBlockIn\n     return false;\n }\n \n-CChainState g_chainstate;\n+namespace {\n+    BlockManager g_blockman;\n+} // anon namespace\n+\n+CChainState g_chainstate(g_blockman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294530483",
      "id" : 294530483,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NDUzMDQ4Mw==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 9,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 250762241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294530483",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294531631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294531631"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is this changed?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-17T21:46:08Z",
      "diff_hunk" : "@@ -126,12 +130,7 @@ CScript COINBASE_FLAGS;\n \n // Internal stuff\n namespace {\n-    CBlockIndex *&pindexBestInvalid = ::ChainstateActive().pindexBestInvalid;\n-\n-    /** All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n-     * Pruned nodes may have entries where B is missing data.\n-     */\n-    std::multimap<CBlockIndex*, CBlockIndex*>& mapBlocksUnlinked = ::ChainstateActive().mapBlocksUnlinked;\n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294531631",
      "id" : 294531631,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NDUzMTYzMQ==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 32,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 250762241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294531631",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294532762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294532762"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use `const auto` instead of splitting this into three lines.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-17T21:49:36Z",
      "diff_hunk" : "@@ -3521,16 +3521,18 @@ void PruneOneBlockFile(const int fileNumber)\n             pindex->nUndoPos = 0;\n             setDirtyBlockIndex.insert(pindex);\n \n-            // Prune from mapBlocksUnlinked -- any block we prune would have\n+            // Prune from m_blocks_unlinked -- any block we prune would have\n             // to be downloaded again in order to consider its chain, at which\n             // point it would be considered as a candidate for\n-            // mapBlocksUnlinked or setBlockIndexCandidates.\n-            std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator, std::multimap<CBlockIndex*, CBlockIndex*>::iterator> range = mapBlocksUnlinked.equal_range(pindex->pprev);\n+            // m_blocks_unlinked or setBlockIndexCandidates.\n+            std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator,\n+                std::multimap<CBlockIndex*, CBlockIndex*>::iterator> range =\n+                    g_blockman.m_blocks_unlinked.equal_range(pindex->pprev);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294532762",
      "id" : 294532762,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NDUzMjc2Mg==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 247,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 250762241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294532762",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294532959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294532959"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-17T21:50:14Z",
      "diff_hunk" : "@@ -4049,10 +4051,12 @@ void CChainState::EraseBlockData(CBlockIndex* index)\n     setDirtyBlockIndex.insert(index);\n     // Update indexes\n     setBlockIndexCandidates.erase(index);\n-    std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator, std::multimap<CBlockIndex*, CBlockIndex*>::iterator> ret = mapBlocksUnlinked.equal_range(index->pprev);\n+    std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator,\n+        std::multimap<CBlockIndex*, CBlockIndex*>::iterator> ret =\n+            m_blockman.m_blocks_unlinked.equal_range(index->pprev);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294532959",
      "id" : 294532959,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NDUzMjk1OQ==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 324,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 250762241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294532959",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294533313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294533313"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Implementation should probably stay in the cpp file, no?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-17T21:51:18Z",
      "diff_hunk" : "@@ -441,27 +441,88 @@ struct CBlockIndexWorkComparator\n };\n \n /**\n- * CChainState stores and provides an API to update our local knowledge of the\n- * current best chain and header tree.\n+ * Maintains a tree of blocks (stored in `m_block_index`) which is consulted\n+ * to determine where the most-work tip is.\n  *\n- * It generally provides access to the current block tree, as well as functions\n- * to provide new data, which it will appropriately validate and incorporate in\n- * its state as necessary.\n+ * This data is used mostly in `CChainState` - information about, e.g.,\n+ * candidate tips is not maintained here.\n+ */\n+class BlockManager {\n+public:\n+    BlockMap m_block_index GUARDED_BY(cs_main);\n+\n+    /** In order to efficiently track invalidity of headers, we keep the set of\n+      * blocks which we tried to connect and found to be invalid here (ie which\n+      * were set to BLOCK_FAILED_VALID since the last restart). We can then\n+      * walk this set and check if a new header is a descendant of something in\n+      * this set, preventing us from having to walk m_block_index when we try\n+      * to connect a bad block and fail.\n+      *\n+      * While this is more complicated than marking everything which descends\n+      * from an invalid block as invalid at the time we discover it to be\n+      * invalid, doing so would require walking all of m_block_index to find all\n+      * descendants. Since this case should be very rare, keeping track of all\n+      * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as\n+      * well.\n+      *\n+      * Because we already walk m_block_index in height-order at startup, we go\n+      * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,\n+      * instead of putting things in this set.\n+      */\n+    std::set<CBlockIndex*> m_failed_blocks;\n+\n+    /**\n+     * All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n+     * Pruned nodes may have entries where B is missing data.\n+     */\n+    std::multimap<CBlockIndex*, CBlockIndex*> m_blocks_unlinked;\n+\n+    bool LoadBlockIndex(\n+        const Consensus::Params& consensus_params,\n+        CBlockTreeDB& blocktree) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    void Unload() EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n+        m_failed_blocks.clear();\n+        m_blocks_unlinked.clear();\n+\n+        for (const BlockMap::value_type& entry : m_block_index) {\n+            delete entry.second;\n+        }\n+\n+        m_block_index.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294533313",
      "id" : 294533313,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NDUzMzMxMw==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 57,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 250762241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294533313",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294533731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294533731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could explain why this is useful to use instead of the g_blockman.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-17T21:52:32Z",
      "diff_hunk" : "@@ -509,15 +550,24 @@ class CChainState {\n      */\n     mutable std::atomic<bool> m_cached_finished_ibd{false};\n \n+    //! Reference to a BlockManager instance which itself is shared across all\n+    //! CChainState instances.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294533731",
      "id" : 294533731,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NDUzMzczMQ==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 132,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 250762241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294533731",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294534332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294534332"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is this moved? Looks like this is `public` before and after.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-17T21:54:40Z",
      "diff_hunk" : "@@ -571,23 +616,20 @@ class CChainState {\n \n     void UnloadBlockIndex();\n \n-    /** Check whether we are doing an initial block download (synchronizing from disk or network) */\n-    bool IsInitialBlockDownload() const;\n-\n-private:\n-    bool ActivateBestChainStep(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexMostWork, const std::shared_ptr<const CBlock>& pblock, bool& fInvalidFound, ConnectTrace& connectTrace) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    bool ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const std::shared_ptr<const CBlock>& pblock, ConnectTrace& connectTrace, DisconnectedBlockTransactions &disconnectpool) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-\n-    CBlockIndex* AddToBlockIndex(const CBlockHeader& block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    /** Create a new block index entry for a given block hash */\n-    CBlockIndex* InsertBlockIndex(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     /**\n      * Make various assertions about the state of the block index.\n      *\n      * By default this only executes fully when using the Regtest chain; see: fCheckBlockIndex.\n      */\n     void CheckBlockIndex(const Consensus::Params& consensusParams);\n \n+    /** Check whether we are doing an initial block download (synchronizing from disk or network) */\n+    bool IsInitialBlockDownload() const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294534332",
      "id" : 294534332,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NDUzNDMzMg==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 190,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 250762241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294534332",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294913716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294913716"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Happy to do that, but thought that the explicit type declaration might be helpful since the value is so complicated. If you think `const auto` is better I'll change it.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-18T16:25:57Z",
      "diff_hunk" : "@@ -3521,16 +3521,18 @@ void PruneOneBlockFile(const int fileNumber)\n             pindex->nUndoPos = 0;\n             setDirtyBlockIndex.insert(pindex);\n \n-            // Prune from mapBlocksUnlinked -- any block we prune would have\n+            // Prune from m_blocks_unlinked -- any block we prune would have\n             // to be downloaded again in order to consider its chain, at which\n             // point it would be considered as a candidate for\n-            // mapBlocksUnlinked or setBlockIndexCandidates.\n-            std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator, std::multimap<CBlockIndex*, CBlockIndex*>::iterator> range = mapBlocksUnlinked.equal_range(pindex->pprev);\n+            // m_blocks_unlinked or setBlockIndexCandidates.\n+            std::pair<std::multimap<CBlockIndex*, CBlockIndex*>::iterator,\n+                std::multimap<CBlockIndex*, CBlockIndex*>::iterator> range =\n+                    g_blockman.m_blocks_unlinked.equal_range(pindex->pprev);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r294913716",
      "id" : 294913716,
      "in_reply_to_id" : 294532762,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NDkxMzcxNg==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 247,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 251215181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/294913716",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295026012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295026012"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: move block metadata structures into BlockManager\" (04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a)\r\n\r\nShouldn't indent within a namespace (could use clang-format-diff) https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-18T21:00:08Z",
      "diff_hunk" : "@@ -77,7 +77,11 @@ bool CBlockIndexWorkComparator::operator()(const CBlockIndex *pa, const CBlockIn\n     return false;\n }\n \n-CChainState g_chainstate;\n+namespace {\n+    BlockManager g_blockman;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295026012",
      "id" : 295026012,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTAyNjAxMg==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 6,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 251358976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295026012",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295026717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295026717"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: move block metadata structures into BlockManager\" (04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a)\r\n\r\n> Should be static\r\n\r\nOr equivalently, just move it into the anonymous namespace above.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-18T21:01:47Z",
      "diff_hunk" : "@@ -77,7 +77,11 @@ bool CBlockIndexWorkComparator::operator()(const CBlockIndex *pa, const CBlockIn\n     return false;\n }\n \n-CChainState g_chainstate;\n+namespace {\n+    BlockManager g_blockman;\n+} // anon namespace\n+\n+CChainState g_chainstate(g_blockman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295026717",
      "id" : 295026717,
      "in_reply_to_id" : 294530483,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTAyNjcxNw==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 9,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 251358976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295026717",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295027268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295027268"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: move block metadata structures into BlockManager\" (04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a)\r\n\r\nNote to help review: this is temporary, removed in the next commit",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-18T21:03:16Z",
      "diff_hunk" : "@@ -95,7 +99,7 @@ CChain& ChainActive() { return g_chainstate.m_chain; }\n  */\n RecursiveMutex cs_main;\n \n-BlockMap& mapBlockIndex = ::ChainstateActive().mapBlockIndex;\n+BlockMap& mapBlockIndex = g_blockman.m_block_index;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295027268",
      "id" : 295027268,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTAyNzI2OA==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 18,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 251358976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295027268",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295033684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295033684"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: move block metadata structures into BlockManager\" (3a8f92e51f60287492d1a1bce5e5e58ae029bb67)\r\n\r\nI think ideally BlockManager wouldn't depend on CChainState, and especially not on a particular hardcoded instance of it. Since nothing except this one line seems to do this, and this is at the end of a function, I think it'd be good to delete this line and just call CheckBlockIndex directly from the two callers.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-18T21:20:13Z",
      "diff_hunk" : "@@ -3304,7 +3304,7 @@ bool CChainState::AcceptBlockHeader(const CBlockHeader& block, CValidationState&\n     if (ppindex)\n         *ppindex = pindex;\n \n-    CheckBlockIndex(chainparams.GetConsensus());\n+    ::ChainstateActive().CheckBlockIndex(chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295033684",
      "id" : 295033684,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTAzMzY4NA==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 203,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 251358976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295033684",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295354811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295354811"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, not sure how that got moved.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-19T15:14:04Z",
      "diff_hunk" : "@@ -571,23 +616,20 @@ class CChainState {\n \n     void UnloadBlockIndex();\n \n-    /** Check whether we are doing an initial block download (synchronizing from disk or network) */\n-    bool IsInitialBlockDownload() const;\n-\n-private:\n-    bool ActivateBestChainStep(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexMostWork, const std::shared_ptr<const CBlock>& pblock, bool& fInvalidFound, ConnectTrace& connectTrace) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    bool ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const std::shared_ptr<const CBlock>& pblock, ConnectTrace& connectTrace, DisconnectedBlockTransactions &disconnectpool) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-\n-    CBlockIndex* AddToBlockIndex(const CBlockHeader& block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    /** Create a new block index entry for a given block hash */\n-    CBlockIndex* InsertBlockIndex(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     /**\n      * Make various assertions about the state of the block index.\n      *\n      * By default this only executes fully when using the Regtest chain; see: fCheckBlockIndex.\n      */\n     void CheckBlockIndex(const Consensus::Params& consensusParams);\n \n+    /** Check whether we are doing an initial block download (synchronizing from disk or network) */\n+    bool IsInitialBlockDownload() const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295354811",
      "id" : 295354811,
      "in_reply_to_id" : 294534332,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTM1NDgxMQ==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 190,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 251773720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295354811",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295361806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295361806"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah sorry, this was a little confusing. Because `pindexBestInvalid` is only used in validation.cpp, I removed it as a member of `CChainState` (though in this revision I forgot to actually remove the declaration - willfix) since it doesn't need to be a part of that interface. There is a change in name only, because `::ChainstateActive().pindexBestInvalid` is nullptr at the time of this declaration.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-19T15:27:24Z",
      "diff_hunk" : "@@ -126,12 +130,7 @@ CScript COINBASE_FLAGS;\n \n // Internal stuff\n namespace {\n-    CBlockIndex *&pindexBestInvalid = ::ChainstateActive().pindexBestInvalid;\n-\n-    /** All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n-     * Pruned nodes may have entries where B is missing data.\n-     */\n-    std::multimap<CBlockIndex*, CBlockIndex*>& mapBlocksUnlinked = ::ChainstateActive().mapBlocksUnlinked;\n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295361806",
      "id" : 295361806,
      "in_reply_to_id" : 294531631,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTM2MTgwNg==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 32,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 251782842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295361806",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295362188"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295362188"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also worth pointing out that we need to touch this piece of data because it is used by both `CChainState` methods *and* `BlockManager` methods.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-19T15:28:08Z",
      "diff_hunk" : "@@ -126,12 +130,7 @@ CScript COINBASE_FLAGS;\n \n // Internal stuff\n namespace {\n-    CBlockIndex *&pindexBestInvalid = ::ChainstateActive().pindexBestInvalid;\n-\n-    /** All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n-     * Pruned nodes may have entries where B is missing data.\n-     */\n-    std::multimap<CBlockIndex*, CBlockIndex*>& mapBlocksUnlinked = ::ChainstateActive().mapBlocksUnlinked;\n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295362188",
      "id" : 295362188,
      "in_reply_to_id" : 294531631,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTM2MjE4OA==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 32,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 251783371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295362188",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and incorporated @MarcoFalke's feedback",
      "created_at" : "2019-06-19T15:56:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#issuecomment-503621615",
      "id" : 503621615,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16194",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMzYyMTYxNQ==",
      "updated_at" : "2019-06-19T15:56:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/503621615",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295421546"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295421546"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, I see that you now removed the CChainstate::pindexBestInvalid, but it could make sense to split this change into a separate commit the next time you have to touch this pull?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-19T17:37:25Z",
      "diff_hunk" : "@@ -126,12 +130,7 @@ CScript COINBASE_FLAGS;\n \n // Internal stuff\n namespace {\n-    CBlockIndex *&pindexBestInvalid = ::ChainstateActive().pindexBestInvalid;\n-\n-    /** All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n-     * Pruned nodes may have entries where B is missing data.\n-     */\n-    std::multimap<CBlockIndex*, CBlockIndex*>& mapBlocksUnlinked = ::ChainstateActive().mapBlocksUnlinked;\n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295421546",
      "id" : 295421546,
      "in_reply_to_id" : 294531631,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQyMTU0Ng==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 32,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 251858856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295421546",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295427450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295427450"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Call it \"block tree index map\" or something to not leak implementation details?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-19T17:51:38Z",
      "diff_hunk" : "@@ -488,7 +488,7 @@ void SetupServerArgs()\n         \"and level 4 tries to reconnect the blocks, \"\n         \"each level includes the checks of the previous levels \"\n         \"(0-4, default: %u)\", DEFAULT_CHECKLEVEL), true, OptionsCategory::DEBUG_TEST);\n-    gArgs.AddArg(\"-checkblockindex\", strprintf(\"Do a full consistency check for mapBlockIndex, setBlockIndexCandidates, ::ChainActive() and mapBlocksUnlinked occasionally. (default: %u, regtest: %u)\", defaultChainParams->DefaultConsistencyChecks(), regtestChainParams->DefaultConsistencyChecks()), true, OptionsCategory::DEBUG_TEST);\n+    gArgs.AddArg(\"-checkblockindex\", strprintf(\"Do a full consistency check for BlockManager.m_block_index, setBlockIndexCandidates, ::ChainActive() and mapBlocksUnlinked occasionally. (default: %u, regtest: %u)\", defaultChainParams->DefaultConsistencyChecks(), regtestChainParams->DefaultConsistencyChecks()), true, OptionsCategory::DEBUG_TEST);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295427450",
      "id" : 295427450,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQyNzQ1MA==",
      "original_commit_id" : "1e33f16dd47c42a9f6099f6172ebd5f8fbb32ec8",
      "original_position" : 5,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 251858856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295427450",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295428103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295428103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-19T17:53:05Z",
      "diff_hunk" : "@@ -1741,7 +1742,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     //// debug print\n     {\n         LOCK(cs_main);\n-        LogPrintf(\"mapBlockIndex.size() = %u\\n\", mapBlockIndex.size());\n+        LogPrintf(\"m_block_index.size() = %u\\n\", ::ChainstateActive().BlockIndex().size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295428103",
      "id" : 295428103,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQyODEwMw==",
      "original_commit_id" : "1e33f16dd47c42a9f6099f6172ebd5f8fbb32ec8",
      "original_position" : 42,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 251858856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295428103",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295536946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295536946"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: move block metadata structures into BlockManager\" (3a8f92e51f60287492d1a1bce5e5e58ae029bb67)\r\n\r\npindexBestInvalid just seems like it should be a BlockManager member. Or am I missing something?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-19T21:44:04Z",
      "diff_hunk" : "@@ -126,12 +130,7 @@ CScript COINBASE_FLAGS;\n \n // Internal stuff\n namespace {\n-    CBlockIndex *&pindexBestInvalid = ::ChainstateActive().pindexBestInvalid;\n-\n-    /** All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n-     * Pruned nodes may have entries where B is missing data.\n-     */\n-    std::multimap<CBlockIndex*, CBlockIndex*>& mapBlocksUnlinked = ::ChainstateActive().mapBlocksUnlinked;\n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295536946",
      "id" : 295536946,
      "in_reply_to_id" : 294531631,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTUzNjk0Ng==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 32,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 251358976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295536946",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295543272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295543272"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: move block metadata structures into BlockManager\" (3a8f92e51f60287492d1a1bce5e5e58ae029bb67)\r\n\r\nThis BlockManager -> ChainstateActive() dependency seems like it will make BlockManager harder to test independently and have confusing side effects. Would suggest reverting this line and adding an explicit `std::set<CBlockIndex*, CBlockIndexWorkComparator>& setBlockIndexCandidates` output parameter to this function. It's only called one place, and I think it'd make the call site clearer, because otherwise you might not know calling this has any effect on the active chain.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-19T22:04:39Z",
      "diff_hunk" : "@@ -3734,7 +3734,7 @@ bool CChainState::LoadBlockIndex(const Consensus::Params& consensus_params, CBlo\n             setDirtyBlockIndex.insert(pindex);\n         }\n         if (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) && (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))\n-            setBlockIndexCandidates.insert(pindex);\n+            ::ChainstateActive().setBlockIndexCandidates.insert(pindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295543272",
      "id" : 295543272,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTU0MzI3Mg==",
      "original_commit_id" : "3a8f92e51f60287492d1a1bce5e5e58ae029bb67",
      "original_position" : 302,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 251358976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295543272",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295546719"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295546719"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: remove mapBlockIndex global\" (1e33f16dd47c42a9f6099f6172ebd5f8fbb32ec8)\r\n\r\nI'm probably just bikeshedding, but I think having this method is counterproductive and only obfuscates what's going on. In places where this is called in `CChainState` methods it seems clearer to replace `BlockIndex()` calls with direct `m_blockman.m_block_index` references. In places where this is called globally, it would seem clearer to able to just write `::BlockIndex()` instead of `::ChainstateActive().BlockIndex()` since the block index doesn't depend on the active chain, and because it would be more consistent with the existing `::LookupBlockIndex` calls.\r\n\r\n\r\n\r\n",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-19T22:17:04Z",
      "diff_hunk" : "@@ -1045,6 +1051,11 @@ bool CChainState::IsInitialBlockDownload() const\n \n static CBlockIndex *pindexBestForkTip = nullptr, *pindexBestForkBase = nullptr;\n \n+BlockMap& CChainState::BlockIndex() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r295546719",
      "id" : 295546719,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTU0NjcxOQ==",
      "original_commit_id" : "1e33f16dd47c42a9f6099f6172ebd5f8fbb32ec8",
      "original_position" : 26,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 251358976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295546719",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r296771388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/296771388"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, agree. Willfix.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-24T15:07:12Z",
      "diff_hunk" : "@@ -3304,7 +3304,7 @@ bool CChainState::AcceptBlockHeader(const CBlockHeader& block, CValidationState&\n     if (ppindex)\n         *ppindex = pindex;\n \n-    CheckBlockIndex(chainparams.GetConsensus());\n+    ::ChainstateActive().CheckBlockIndex(chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r296771388",
      "id" : 296771388,
      "in_reply_to_id" : 295033684,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5Njc3MTM4OA==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 203,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 253475420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/296771388",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r296771643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/296771643"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, I agree with this. Willfix.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-24T15:07:43Z",
      "diff_hunk" : "@@ -1045,6 +1051,11 @@ bool CChainState::IsInitialBlockDownload() const\n \n static CBlockIndex *pindexBestForkTip = nullptr, *pindexBestForkBase = nullptr;\n \n+BlockMap& CChainState::BlockIndex() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r296771643",
      "id" : 296771643,
      "in_reply_to_id" : 295546719,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5Njc3MTY0Mw==",
      "original_commit_id" : "1e33f16dd47c42a9f6099f6172ebd5f8fbb32ec8",
      "original_position" : 26,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 253475750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/296771643",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r296840549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/296840549"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> pindexBestInvalid just seems like it should be a BlockManager member. Or am I missing something?\r\n\r\nIn theory we could, the only problem here is that (i) [`g_blockman` is retired in later commits](https://github.com/bitcoin/bitcoin/pull/15606/commits/df81dc462e72047ed6857d927946cb18e0e9492b#diff-24efdb00bfbe56b140fb006b562cc70bL81) and (ii) pindexBestInvalid is used in non-method functions like `CheckForkWarningConditions`, so essentially there'd be no way to reference `m_blockman.pindexBestInvalid` in functions like that without moving them onto CChainState. So instead of creating extra diff, I just figured keeping pindexBestInvalid private to validation.cpp made sense. Let me know if you think it'd be better as a member of BlockManager.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-24T17:49:24Z",
      "diff_hunk" : "@@ -126,12 +130,7 @@ CScript COINBASE_FLAGS;\n \n // Internal stuff\n namespace {\n-    CBlockIndex *&pindexBestInvalid = ::ChainstateActive().pindexBestInvalid;\n-\n-    /** All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n-     * Pruned nodes may have entries where B is missing data.\n-     */\n-    std::multimap<CBlockIndex*, CBlockIndex*>& mapBlocksUnlinked = ::ChainstateActive().mapBlocksUnlinked;\n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r296840549",
      "id" : 296840549,
      "in_reply_to_id" : 294531631,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5Njg0MDU0OQ==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 32,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 253563408,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/296840549",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the good feedback, @MarcoFalke @ryanofsky. I've incorporated your changes.",
      "created_at" : "2019-06-25T14:58:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#issuecomment-505483772",
      "id" : 505483772,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16194",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwNTQ4Mzc3Mg==",
      "updated_at" : "2019-06-25T14:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/505483772",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r297236706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/297236706"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note to reviewers: this is moved to the two callsites below to avoid making reference to a specific CChainState in BlockManager.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-25T15:02:06Z",
      "diff_hunk" : "@@ -3300,8 +3311,6 @@ bool CChainState::AcceptBlockHeader(const CBlockHeader& block, CValidationState&\n     if (ppindex)\n         *ppindex = pindex;\n \n-    CheckBlockIndex(chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r297236706",
      "id" : 297236706,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NzIzNjcwNg==",
      "original_commit_id" : "e89e4f62b8cf4d19becb66f0c325d40851040a35",
      "original_position" : 236,
      "path" : "src/validation.cpp",
      "position" : 236,
      "pull_request_review_id" : 254069231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/297236706",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r297847918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/297847918"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/16194#discussion_r296840549\r\n\r\nThanks for explaining. It would be nice to clean up and document these free floating global variables (pindexBestInvalid, pindexBestForkTip, pindexBestForkBase), giving them `g_` prefixes or moving them to appropriate classes so they don't look like local variables. It's beyond the scope of this PR, though.\r\n\r\nFWIW, I don't see later commits interfering here. It looks like there still is a single blockman instance, just called g_chainman.m_blockman instead of g_blockman.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-06-26T20:16:23Z",
      "diff_hunk" : "@@ -126,12 +130,7 @@ CScript COINBASE_FLAGS;\n \n // Internal stuff\n namespace {\n-    CBlockIndex *&pindexBestInvalid = ::ChainstateActive().pindexBestInvalid;\n-\n-    /** All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n-     * Pruned nodes may have entries where B is missing data.\n-     */\n-    std::multimap<CBlockIndex*, CBlockIndex*>& mapBlocksUnlinked = ::ChainstateActive().mapBlocksUnlinked;\n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r297847918",
      "id" : 297847918,
      "in_reply_to_id" : 294531631,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5Nzg0NzkxOA==",
      "original_commit_id" : "04fa434aabcc9d02bf1f0ceaa3ee4f099642a27a",
      "original_position" : 32,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 254848826,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-08T15:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/297847918",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303029375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303029375"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit in commit 613c46fe9e refactoring: move block metadata structures into BlockManager:\r\n\r\nFor consistency should make both static or put both into a namespace.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-12T15:17:38Z",
      "diff_hunk" : "@@ -77,7 +77,11 @@ bool CBlockIndexWorkComparator::operator()(const CBlockIndex *pa, const CBlockIn\n     return false;\n }\n \n-static CChainState g_chainstate;\n+namespace {\n+BlockManager g_blockman;\n+} // anon namespace\n+\n+static CChainState g_chainstate(g_blockman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303029375",
      "id" : 303029375,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzAyOTM3NQ==",
      "original_commit_id" : "613c46fe9e39f55b0f0daa18fee20b4120db2539",
      "original_position" : 9,
      "path" : "src/validation.cpp",
      "position" : 9,
      "pull_request_review_id" : 261320866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-16T16:56:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303029375",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303030610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303030610"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit: in commit 613c46fe9e refactoring: move block metadata structures into BlockManager:\r\n\r\n`const auto& entry` does the same, less verbose",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-12T15:20:30Z",
      "diff_hunk" : "@@ -3752,9 +3756,20 @@ bool CChainState::LoadBlockIndex(const Consensus::Params& consensus_params, CBlo\n     return true;\n }\n \n+void BlockManager::Unload() {\n+    m_failed_blocks.clear();\n+    m_blocks_unlinked.clear();\n+\n+    for (const BlockMap::value_type& entry : m_block_index) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303030610",
      "id" : 303030610,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzAzMDYxMA==",
      "original_commit_id" : "613c46fe9e39f55b0f0daa18fee20b4120db2539",
      "original_position" : 318,
      "path" : "src/validation.cpp",
      "position" : 370,
      "pull_request_review_id" : 261320866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-16T16:56:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303030610",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 682a1d0f2004d808b87b3106d0dfae547005e638\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nACK 682a1d0f2004d808b87b3106d0dfae547005e638\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUhwngwAq5VhfgfOv6FJFWvZc8NpFrYVMPW/S6u8qLBlZs3q2KZMT7j12l0MQRmX\r\nqwGyP+CRJKsuJvYIwShRGHV5el/0t5hkTD8HUMlGgXSSkQvuEJCCweD2t1Y1y8Pm\r\nAyi3QErIRcS1ErtnP7dxgBSjm8DOeZJdv+hKehG8kfwjAYePc+rEQhL84nT6wTgU\r\nqNkk7k3ri8eSce6ZEy/3aOHONmHoTw7iqdyqQaUpuqvBSzig5HZ09wx9BR7lic8Z\r\nyAyGmyaYBsfnyl6sl7d+u7EC8UjMQe13Tj9dW+rLYX9vCJz5HSLc/D4SioErNFe1\r\ngcHhk0E7bkLxjGvxO8vMOjRwDR/CCX0ubWYhXliAqNV8cExmr6/Z9aPHVa2oj7KL\r\nj7JBf1sH8qczMDlZqh+/qbN4i9/Ss7oiFVhALAUST07bMs3m9RdbyQ4Fuw6IqoI0\r\ndaL3BadGheJmLdAeI1lKXFiaqQp8HNiMi02210gkhmVkHYI8zFSEXGSLt+xuySnw\r\nO0MY7j8+\r\n=6aAq\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `5b30b7a598d04185a0efdbef0b0f6e39648bf992b0c23151e41ad9445e741517  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e8929401085b30b7a598d04185a0efdbef0b0f6e39648bf992b0c23151e41ad9445e741517f0101143d65c7c0e5e4ee14a3bb212045ebc08fff01071973946bb09d0d50331ab4c81aa29fc08f120008c6ab34a032d2620d27c1dc8a61f5a6897c4187a2c04fb6ff52c69acae364108f1045d28aaeaf00840dce6964d3f28ec0083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6dfff010d274d8d47e451d97ee51146b17d0b26208f0207b1b9c869ed8e9025bb8e8ce6d779075e4f6e4805ff279a01e19a7e0c7e9d34808f1045d28aaeaf008ff3a553406e1a56f0083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff010dbfd683ecbb21646a0e4f2badd857fff08f0205408c61f4651fc8e8dd386d826d5ebf9032a77c614d39ad7e9a8de856e12ee9908f1045d28aaeaf008dbde88c3326eaff40083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267f010e9427864b2d8126eebe65f71a45f5ac208f0203ad63966517fc0f8493ba13fc444d6d7186f14565c84b31321f3c1f6d59965a908f1045d28aaeaf008ca9d9a89449f45830083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6d)\r\n\r\n</details>\r\n",
      "created_at" : "2019-07-12T15:45:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#issuecomment-510935423",
      "id" : 510935423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16194",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMDkzNTQyMw==",
      "updated_at" : "2019-07-12T15:45:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/510935423",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303054162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303054162"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `mapBlocksUnlinked` does no longer exist",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-12T16:19:16Z",
      "diff_hunk" : "@@ -492,7 +492,7 @@ void SetupServerArgs()\n         \"and level 4 tries to reconnect the blocks, \"\n         \"each level includes the checks of the previous levels \"\n         \"(0-4, default: %u)\", DEFAULT_CHECKLEVEL), true, OptionsCategory::DEBUG_TEST);\n-    gArgs.AddArg(\"-checkblockindex\", strprintf(\"Do a full consistency check for mapBlockIndex, setBlockIndexCandidates, ::ChainActive() and mapBlocksUnlinked occasionally. (default: %u, regtest: %u)\", defaultChainParams->DefaultConsistencyChecks(), regtestChainParams->DefaultConsistencyChecks()), true, OptionsCategory::DEBUG_TEST);\n+    gArgs.AddArg(\"-checkblockindex\", strprintf(\"Do a full consistency check for the block tree, setBlockIndexCandidates, ::ChainActive() and mapBlocksUnlinked occasionally. (default: %u, regtest: %u)\", defaultChainParams->DefaultConsistencyChecks(), regtestChainParams->DefaultConsistencyChecks()), true, OptionsCategory::DEBUG_TEST);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303054162",
      "id" : 303054162,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzA1NDE2Mg==",
      "original_commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "original_position" : 5,
      "path" : "src/init.cpp",
      "position" : 5,
      "pull_request_review_id" : 261320866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-16T16:56:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303054162",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303557195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303557195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: comment has just been moved but maybe you could take opportunity to explain better what m_blocks_unlinked is useful for, something like \"a child block B may receive its transactions before ancestor A which means B nChainTx is going to be inaccurate until we received txn for every one of its ancestors. When we accept A, update B nChainTx to accurate number of transactions\"",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-15T17:47:21Z",
      "diff_hunk" : "@@ -439,27 +439,80 @@ struct CBlockIndexWorkComparator\n };\n \n /**\n- * CChainState stores and provides an API to update our local knowledge of the\n- * current best chain and header tree.\n+ * Maintains a tree of blocks (stored in `m_block_index`) which is consulted\n+ * to determine where the most-work tip is.\n  *\n- * It generally provides access to the current block tree, as well as functions\n- * to provide new data, which it will appropriately validate and incorporate in\n- * its state as necessary.\n+ * This data is used mostly in `CChainState` - information about, e.g.,\n+ * candidate tips is not maintained here.\n+ */\n+class BlockManager {\n+public:\n+    BlockMap m_block_index GUARDED_BY(cs_main);\n+\n+    /** In order to efficiently track invalidity of headers, we keep the set of\n+      * blocks which we tried to connect and found to be invalid here (ie which\n+      * were set to BLOCK_FAILED_VALID since the last restart). We can then\n+      * walk this set and check if a new header is a descendant of something in\n+      * this set, preventing us from having to walk m_block_index when we try\n+      * to connect a bad block and fail.\n+      *\n+      * While this is more complicated than marking everything which descends\n+      * from an invalid block as invalid at the time we discover it to be\n+      * invalid, doing so would require walking all of m_block_index to find all\n+      * descendants. Since this case should be very rare, keeping track of all\n+      * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as\n+      * well.\n+      *\n+      * Because we already walk m_block_index in height-order at startup, we go\n+      * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,\n+      * instead of putting things in this set.\n+      */\n+    std::set<CBlockIndex*> m_failed_blocks;\n+\n+    /**\n+     * All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303557195",
      "id" : 303557195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzU1NzE5NQ==",
      "original_commit_id" : "613c46fe9e39f55b0f0daa18fee20b4120db2539",
      "original_position" : 40,
      "path" : "src/validation.h",
      "position" : 62,
      "pull_request_review_id" : 261976051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-15T19:52:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303557195",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303582007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303582007"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You may use `auto` there, compiler can do type inference?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-15T18:47:02Z",
      "diff_hunk" : "@@ -4482,13 +4491,13 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n                 }\n                 // If some parent is missing, then it could be that this block was in\n                 // setBlockIndexCandidates but had to be removed because of the missing data.\n-                // In this case it must be in mapBlocksUnlinked -- see test below.\n+                // In this case it must be in m_blocks_unlinked -- see test below.\n             }\n         } else { // If this block sorts worse than the current tip or some ancestor's block has never been seen, it cannot be in setBlockIndexCandidates.\n             assert(setBlockIndexCandidates.count(pindex) == 0);\n         }\n-        // Check whether this block is in mapBlocksUnlinked.\n-        std::pair<std::multimap<CBlockIndex*,CBlockIndex*>::iterator,std::multimap<CBlockIndex*,CBlockIndex*>::iterator> rangeUnlinked = mapBlocksUnlinked.equal_range(pindex->pprev);\n+        // Check whether this block is in m_blocks_unlinked.\n+        std::pair<std::multimap<CBlockIndex*,CBlockIndex*>::iterator,std::multimap<CBlockIndex*,CBlockIndex*>::iterator> rangeUnlinked = m_blockman.m_blocks_unlinked.equal_range(pindex->pprev);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303582007",
      "id" : 303582007,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzU4MjAwNw==",
      "original_commit_id" : "613c46fe9e39f55b0f0daa18fee20b4120db2539",
      "original_position" : 399,
      "path" : "src/validation.cpp",
      "position" : 548,
      "pull_request_review_id" : 261976051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-15T19:52:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303582007",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303587180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303587180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: now than `AddToBlockIndex` is a public method, it could be commented like \"Create an index entry for given header with minimal metadatas. If header shows most-work it becomes best-tracked-header\"",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-15T18:59:57Z",
      "diff_hunk" : "@@ -439,27 +439,80 @@ struct CBlockIndexWorkComparator\n };\n \n /**\n- * CChainState stores and provides an API to update our local knowledge of the\n- * current best chain and header tree.\n+ * Maintains a tree of blocks (stored in `m_block_index`) which is consulted\n+ * to determine where the most-work tip is.\n  *\n- * It generally provides access to the current block tree, as well as functions\n- * to provide new data, which it will appropriately validate and incorporate in\n- * its state as necessary.\n+ * This data is used mostly in `CChainState` - information about, e.g.,\n+ * candidate tips is not maintained here.\n+ */\n+class BlockManager {\n+public:\n+    BlockMap m_block_index GUARDED_BY(cs_main);\n+\n+    /** In order to efficiently track invalidity of headers, we keep the set of\n+      * blocks which we tried to connect and found to be invalid here (ie which\n+      * were set to BLOCK_FAILED_VALID since the last restart). We can then\n+      * walk this set and check if a new header is a descendant of something in\n+      * this set, preventing us from having to walk m_block_index when we try\n+      * to connect a bad block and fail.\n+      *\n+      * While this is more complicated than marking everything which descends\n+      * from an invalid block as invalid at the time we discover it to be\n+      * invalid, doing so would require walking all of m_block_index to find all\n+      * descendants. Since this case should be very rare, keeping track of all\n+      * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as\n+      * well.\n+      *\n+      * Because we already walk m_block_index in height-order at startup, we go\n+      * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,\n+      * instead of putting things in this set.\n+      */\n+    std::set<CBlockIndex*> m_failed_blocks;\n+\n+    /**\n+     * All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n+     * Pruned nodes may have entries where B is missing data.\n+     */\n+    std::multimap<CBlockIndex*, CBlockIndex*> m_blocks_unlinked;\n+\n+    bool LoadBlockIndex(\n+        const Consensus::Params& consensus_params,\n+        CBlockTreeDB& blocktree) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    /** Clear all data members. */\n+    void Unload() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    CBlockIndex* AddToBlockIndex(const CBlockHeader& block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303587180",
      "id" : 303587180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzU4NzE4MA==",
      "original_commit_id" : "613c46fe9e39f55b0f0daa18fee20b4120db2539",
      "original_position" : 52,
      "path" : "src/validation.h",
      "position" : 84,
      "pull_request_review_id" : 261976051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-15T19:52:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303587180",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303592392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303592392"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "hmmm maybe setDirtyBlockIndex could be part of BlockManager in future commits given this set of block index  is also shared between chainstates? And would let implement batching managed by BlockManager",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-15T19:13:26Z",
      "diff_hunk" : "@@ -475,9 +475,19 @@ class BlockManager {\n      */\n     std::multimap<CBlockIndex*, CBlockIndex*> m_blocks_unlinked;\n \n+    /**\n+     * Load the blocktree off disk and into memory. Populate certain metadata\n+     * per index entry (nStatus, nChainWork, nTimeMax, etc.) as well as peripheral\n+     * collections like setDirtyBlockIndex.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303592392",
      "id" : 303592392,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzU5MjM5Mg==",
      "original_commit_id" : "4ed55dfcd7894fd5ba6395f244a17ab1f8e786d4",
      "original_position" : 7,
      "path" : "src/validation.h",
      "position" : 70,
      "pull_request_review_id" : 261976051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-15T19:52:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303592392",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303602629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303602629"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's unclear reading commits messages what's the long term destination of `g_blockman` is. Do other parts of the code calling `LookupBlockIndex` will always rely on a global `BlockManager` or should they access to it through their instance of `CChainstate`  after future refactoring ?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-15T19:41:16Z",
      "diff_hunk" : "@@ -147,6 +146,13 @@ namespace {\n     std::set<int> setDirtyFileInfo;\n } // anon namespace\n \n+CBlockIndex* LookupBlockIndex(const uint256& hash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303602629",
      "id" : 303602629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzYwMjYyOQ==",
      "original_commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "original_position" : 12,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 261976051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-15T19:52:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303602629",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303612389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303612389"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree, but don't want to invalidate the move-only nature for this change. Would be a great follow-up if you're on the hunt for PR ideas :).",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-15T20:06:33Z",
      "diff_hunk" : "@@ -439,27 +439,80 @@ struct CBlockIndexWorkComparator\n };\n \n /**\n- * CChainState stores and provides an API to update our local knowledge of the\n- * current best chain and header tree.\n+ * Maintains a tree of blocks (stored in `m_block_index`) which is consulted\n+ * to determine where the most-work tip is.\n  *\n- * It generally provides access to the current block tree, as well as functions\n- * to provide new data, which it will appropriately validate and incorporate in\n- * its state as necessary.\n+ * This data is used mostly in `CChainState` - information about, e.g.,\n+ * candidate tips is not maintained here.\n+ */\n+class BlockManager {\n+public:\n+    BlockMap m_block_index GUARDED_BY(cs_main);\n+\n+    /** In order to efficiently track invalidity of headers, we keep the set of\n+      * blocks which we tried to connect and found to be invalid here (ie which\n+      * were set to BLOCK_FAILED_VALID since the last restart). We can then\n+      * walk this set and check if a new header is a descendant of something in\n+      * this set, preventing us from having to walk m_block_index when we try\n+      * to connect a bad block and fail.\n+      *\n+      * While this is more complicated than marking everything which descends\n+      * from an invalid block as invalid at the time we discover it to be\n+      * invalid, doing so would require walking all of m_block_index to find all\n+      * descendants. Since this case should be very rare, keeping track of all\n+      * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as\n+      * well.\n+      *\n+      * Because we already walk m_block_index in height-order at startup, we go\n+      * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,\n+      * instead of putting things in this set.\n+      */\n+    std::set<CBlockIndex*> m_failed_blocks;\n+\n+    /**\n+     * All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303612389",
      "id" : 303612389,
      "in_reply_to_id" : 303557195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzYxMjM4OQ==",
      "original_commit_id" : "613c46fe9e39f55b0f0daa18fee20b4120db2539",
      "original_position" : 40,
      "path" : "src/validation.h",
      "position" : 62,
      "pull_request_review_id" : 262045342,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-15T20:06:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303612389",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303617999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303617999"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea - if I have to rebase this PR for some other reason I'll add it.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-15T20:20:49Z",
      "diff_hunk" : "@@ -439,27 +439,80 @@ struct CBlockIndexWorkComparator\n };\n \n /**\n- * CChainState stores and provides an API to update our local knowledge of the\n- * current best chain and header tree.\n+ * Maintains a tree of blocks (stored in `m_block_index`) which is consulted\n+ * to determine where the most-work tip is.\n  *\n- * It generally provides access to the current block tree, as well as functions\n- * to provide new data, which it will appropriately validate and incorporate in\n- * its state as necessary.\n+ * This data is used mostly in `CChainState` - information about, e.g.,\n+ * candidate tips is not maintained here.\n+ */\n+class BlockManager {\n+public:\n+    BlockMap m_block_index GUARDED_BY(cs_main);\n+\n+    /** In order to efficiently track invalidity of headers, we keep the set of\n+      * blocks which we tried to connect and found to be invalid here (ie which\n+      * were set to BLOCK_FAILED_VALID since the last restart). We can then\n+      * walk this set and check if a new header is a descendant of something in\n+      * this set, preventing us from having to walk m_block_index when we try\n+      * to connect a bad block and fail.\n+      *\n+      * While this is more complicated than marking everything which descends\n+      * from an invalid block as invalid at the time we discover it to be\n+      * invalid, doing so would require walking all of m_block_index to find all\n+      * descendants. Since this case should be very rare, keeping track of all\n+      * BLOCK_FAILED_VALID blocks in a set should be just fine and work just as\n+      * well.\n+      *\n+      * Because we already walk m_block_index in height-order at startup, we go\n+      * ahead and mark descendants of invalid blocks as FAILED_CHILD at that time,\n+      * instead of putting things in this set.\n+      */\n+    std::set<CBlockIndex*> m_failed_blocks;\n+\n+    /**\n+     * All pairs A->B, where A (or one of its ancestors) misses transactions, but B has transactions.\n+     * Pruned nodes may have entries where B is missing data.\n+     */\n+    std::multimap<CBlockIndex*, CBlockIndex*> m_blocks_unlinked;\n+\n+    bool LoadBlockIndex(\n+        const Consensus::Params& consensus_params,\n+        CBlockTreeDB& blocktree) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    /** Clear all data members. */\n+    void Unload() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    CBlockIndex* AddToBlockIndex(const CBlockHeader& block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303617999",
      "id" : 303617999,
      "in_reply_to_id" : 303587180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzYxNzk5OQ==",
      "original_commit_id" : "613c46fe9e39f55b0f0daa18fee20b4120db2539",
      "original_position" : 52,
      "path" : "src/validation.h",
      "position" : 84,
      "pull_request_review_id" : 262052404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-15T20:20:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303617999",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303619666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303619666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Eventually, a single `BlockManager` object will be managed and shared to all created `CChainState` objects by something called `ChainstateManager`, to be introduced later (https://github.com/bitcoin/bitcoin/pull/15606/commits/df81dc462e72047ed6857d927946cb18e0e9492b). The single global block index will be accessed through the chainstate manager.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-07-15T20:24:54Z",
      "diff_hunk" : "@@ -147,6 +146,13 @@ namespace {\n     std::set<int> setDirtyFileInfo;\n } // anon namespace\n \n+CBlockIndex* LookupBlockIndex(const uint256& hash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r303619666",
      "id" : 303619666,
      "in_reply_to_id" : 303602629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzYxOTY2Ng==",
      "original_commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "original_position" : 12,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 262054479,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-07-15T20:24:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303619666",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r329560209"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329560209"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As @sdaftuar pointed out in https://github.com/bitcoin/bitcoin/issues/16444#issuecomment-514801708 `AcceptBlockHeader` can return early, so we're now calling `CheckBlockIndex(()` more often than before.",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2019-09-30T12:55:03Z",
      "diff_hunk" : "@@ -3300,8 +3311,6 @@ bool CChainState::AcceptBlockHeader(const CBlockHeader& block, CValidationState&\n     if (ppindex)\n         *ppindex = pindex;\n \n-    CheckBlockIndex(chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r329560209",
      "id" : 329560209,
      "in_reply_to_id" : 297236706,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyOTU2MDIwOQ==",
      "original_commit_id" : "e89e4f62b8cf4d19becb66f0c325d40851040a35",
      "original_position" : 236,
      "path" : "src/validation.cpp",
      "position" : 236,
      "pull_request_review_id" : 294951572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "updated_at" : "2019-09-30T12:55:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329560209",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r621248222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621248222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "is this necessary when accepted is false?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2021-04-27T14:11:21Z",
      "diff_hunk" : "@@ -3319,7 +3328,10 @@ bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidatio\n         LOCK(cs_main);\n         for (const CBlockHeader& header : headers) {\n             CBlockIndex *pindex = nullptr; // Use a temp pindex instead of ppindex to avoid a const_cast\n-            if (!::ChainstateActive().AcceptBlockHeader(header, state, chainparams, &pindex)) {\n+            bool accepted = g_blockman.AcceptBlockHeader(header, state, chainparams, &pindex);\n+            ::ChainstateActive().CheckBlockIndex(chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r621248222",
      "id" : 621248222,
      "line" : 3332,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTI0ODIyMg==",
      "original_commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "original_line" : 3332,
      "original_position" : 247,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 247,
      "pull_request_review_id" : 645906901,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T14:11:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621248222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=4",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "node_id" : "MDQ6VXNlcjE1MzAyODM=",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r621248578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621248578"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "is this necessary when accepted_header is false?",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2021-04-27T14:11:44Z",
      "diff_hunk" : "@@ -3362,7 +3374,10 @@ bool CChainState::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, CVali\n     CBlockIndex *pindexDummy = nullptr;\n     CBlockIndex *&pindex = ppindex ? *ppindex : pindexDummy;\n \n-    if (!AcceptBlockHeader(block, state, chainparams, &pindex))\n+    bool accepted_header = m_blockman.AcceptBlockHeader(block, state, chainparams, &pindex);\n+    CheckBlockIndex(chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r621248578",
      "id" : 621248578,
      "line" : 3378,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTI0ODU3OA==",
      "original_commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "original_line" : 3378,
      "original_position" : 259,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 259,
      "pull_request_review_id" : 645907377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T14:11:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621248578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=4",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "node_id" : "MDQ6VXNlcjE1MzAyODM=",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r621413302"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621413302"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#16453",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2021-04-27T16:56:20Z",
      "diff_hunk" : "@@ -3362,7 +3374,10 @@ bool CChainState::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, CVali\n     CBlockIndex *pindexDummy = nullptr;\n     CBlockIndex *&pindex = ppindex ? *ppindex : pindexDummy;\n \n-    if (!AcceptBlockHeader(block, state, chainparams, &pindex))\n+    bool accepted_header = m_blockman.AcceptBlockHeader(block, state, chainparams, &pindex);\n+    CheckBlockIndex(chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r621413302",
      "id" : 621413302,
      "in_reply_to_id" : 621248578,
      "line" : 3378,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTQxMzMwMg==",
      "original_commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "original_line" : 3378,
      "original_position" : 259,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 259,
      "pull_request_review_id" : 646130178,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T16:56:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621413302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r621413363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621413363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#16453",
      "commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "created_at" : "2021-04-27T16:56:25Z",
      "diff_hunk" : "@@ -3319,7 +3328,10 @@ bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidatio\n         LOCK(cs_main);\n         for (const CBlockHeader& header : headers) {\n             CBlockIndex *pindex = nullptr; // Use a temp pindex instead of ppindex to avoid a const_cast\n-            if (!::ChainstateActive().AcceptBlockHeader(header, state, chainparams, &pindex)) {\n+            bool accepted = g_blockman.AcceptBlockHeader(header, state, chainparams, &pindex);\n+            ::ChainstateActive().CheckBlockIndex(chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16194#discussion_r621413363",
      "id" : 621413363,
      "in_reply_to_id" : 621248222,
      "line" : 3332,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTQxMzM2Mw==",
      "original_commit_id" : "682a1d0f2004d808b87b3106d0dfae547005e638",
      "original_line" : 3332,
      "original_position" : 247,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 247,
      "pull_request_review_id" : 646130270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16194",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T16:56:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621413363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
