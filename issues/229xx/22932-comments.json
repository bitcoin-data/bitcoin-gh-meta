[
   {
      "author_association" : "MEMBER",
      "body" : "Tests green. Added a commit to require `CBlockIndex::GetUndoPos()` to hold cs_main as well, if reviewers think it's a good idea.\r\n ",
      "created_at" : "2021-09-09T18:01:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-916318581",
      "id" : 916318581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5842nel1",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-09T18:01:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916318581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23927](https://github.com/bitcoin/bitcoin/pull/23927) (rpc: Pruning nodes can not fetch blocks before syncing past their height by fjahr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-09-12T16:00:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-917662835",
      "id" : 917662835,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5842smxz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917662835/reactions"
      },
      "updated_at" : "2022-01-26T10:03:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917662835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased following the merge of #22895 that this was based on.",
      "created_at" : "2021-09-16T20:04:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-921206538",
      "id" : 921206538,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII58426H8K",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T20:04:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921206538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710934432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710934432"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is annotating the function, but not the underlying data member that needs the annotation.\r\n\r\nNot sure how involved it will be to annotate everything properly here. Also, given that cs_main is the validation lock, we should (eventually/ideally) have a separate node_storage lock. Though, this again requires a major validation/node_storage rewrite.\r\n\r\nHowever an argument against adding the lock annotation to the data member could be that `chain` is supposed to be a data-structure-only primitive, like `transaction` or `block`. In that case only annotating the getter and setter functions (and making them standalone) would seem appropriate.",
      "commit_id" : "285ecb2feeca7811292a103d1fedf70c7414ce33",
      "created_at" : "2021-09-17T10:17:17Z",
      "diff_hunk" : "@@ -212,7 +215,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710934432",
      "id" : 710934432,
      "line" : 218,
      "node_id" : "PRRC_kwDOABII584qX_-g",
      "original_commit_id" : "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
      "original_line" : 218,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 31,
      "pull_request_review_id" : 757300647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-17T10:17:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710934432",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710942005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942005"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: unit tests are single-threaded, so you can just take the lock for the whole function. It is likely that there are other lock violations anyway: See https://github.com/bitcoin/bitcoin/issues/17161#issuecomment-543151879",
      "commit_id" : "285ecb2feeca7811292a103d1fedf70c7414ce33",
      "created_at" : "2021-09-17T10:29:40Z",
      "diff_hunk" : "@@ -12,7 +12,7 @@\n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\n {\n     CBlock block;\n-    if (!ReadBlockFromDisk(block, block_index->GetBlockPos(), Params().GetConsensus())) {\n+    if (!ReadBlockFromDisk(block, WITH_LOCK(cs_main, return block_index->GetBlockPos()), Params().GetConsensus())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710942005",
      "id" : 710942005,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qYB01",
      "original_commit_id" : "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
      "original_line" : 15,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/util/blockfilter.cpp",
      "position" : null,
      "pull_request_review_id" : 757310339,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-17T10:29:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710942658"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942658"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same: Can include this in the cs_main scope as well, I think.",
      "commit_id" : "285ecb2feeca7811292a103d1fedf70c7414ce33",
      "created_at" : "2021-09-17T10:30:50Z",
      "diff_hunk" : "@@ -86,7 +86,8 @@ BOOST_FIXTURE_TEST_CASE(scan_for_wallet_transactions, TestChain100Setup)\n {\n     // Cap last block file size, and mine new block in a new block file.\n     CBlockIndex* oldTip = m_node.chainman->ActiveChain().Tip();\n-    GetBlockFileInfo(oldTip->GetBlockPos().nFile)->nSize = MAX_BLOCKFILE_SIZE;\n+    const auto pos{WITH_LOCK(cs_main, return oldTip->GetBlockPos())};\n+    GetBlockFileInfo(pos.nFile)->nSize = MAX_BLOCKFILE_SIZE;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710942658",
      "id" : 710942658,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qYB_C",
      "original_commit_id" : "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
      "original_line" : 90,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 757311214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-17T10:30:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942658",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711181854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711181854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "285ecb2feeca7811292a103d1fedf70c7414ce33",
      "created_at" : "2021-09-17T16:07:38Z",
      "diff_hunk" : "@@ -12,7 +12,7 @@\n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\n {\n     CBlock block;\n-    if (!ReadBlockFromDisk(block, block_index->GetBlockPos(), Params().GetConsensus())) {\n+    if (!ReadBlockFromDisk(block, WITH_LOCK(cs_main, return block_index->GetBlockPos()), Params().GetConsensus())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711181854",
      "id" : 711181854,
      "in_reply_to_id" : 710942005,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qY8Ye",
      "original_commit_id" : "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
      "original_line" : 15,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/util/blockfilter.cpp",
      "position" : null,
      "pull_request_review_id" : 757634219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-17T16:07:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711181854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711187206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711187206"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done, thank you",
      "commit_id" : "285ecb2feeca7811292a103d1fedf70c7414ce33",
      "created_at" : "2021-09-17T16:15:45Z",
      "diff_hunk" : "@@ -86,7 +86,8 @@ BOOST_FIXTURE_TEST_CASE(scan_for_wallet_transactions, TestChain100Setup)\n {\n     // Cap last block file size, and mine new block in a new block file.\n     CBlockIndex* oldTip = m_node.chainman->ActiveChain().Tip();\n-    GetBlockFileInfo(oldTip->GetBlockPos().nFile)->nSize = MAX_BLOCKFILE_SIZE;\n+    const auto pos{WITH_LOCK(cs_main, return oldTip->GetBlockPos())};\n+    GetBlockFileInfo(pos.nFile)->nSize = MAX_BLOCKFILE_SIZE;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711187206",
      "id" : 711187206,
      "in_reply_to_id" : 710942658,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qY9sG",
      "original_commit_id" : "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
      "original_line" : 90,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 757641366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-17T16:15:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711187206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @MarcoFalke, updated with your suggestions per `git diff f6c2fdb e950f0e`\r\n\r\n<details><summary>diff</summary><p>\r\n\r\n```diff \r\ndiff --git a/src/test/util/blockfilter.cpp b/src/test/util/blockfilter.cpp\r\nindex 311913b5db..1a663bd0b3 100644\r\n--- a/src/test/util/blockfilter.cpp\r\n+++ b/src/test/util/blockfilter.cpp\r\n@@ -11,8 +11,10 @@\r\n \r\n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\r\n {\r\n+    LOCK(cs_main);\r\n+\r\n     CBlock block;\r\n-    if (!ReadBlockFromDisk(block, WITH_LOCK(cs_main, return block_index->GetBlockPos()), Params().GetConsensus())) {\r\n+    if (!ReadBlockFromDisk(block, block_index->GetBlockPos(), Params().GetConsensus())) {\r\n         return false;\r\n     }\r\n \r\ndiff --git a/src/wallet/test/wallet_tests.cpp b/src/wallet/test/wallet_tests.cpp\r\nindex 37fd52a5e7..4ac8936ee7 100644\r\n--- a/src/wallet/test/wallet_tests.cpp\r\n+++ b/src/wallet/test/wallet_tests.cpp\r\n@@ -86,8 +86,10 @@ BOOST_FIXTURE_TEST_CASE(scan_for_wallet_transactions, TestChain100Setup)\r\n {\r\n     // Cap last block file size, and mine new block in a new block file.\r\n     CBlockIndex* oldTip = m_node.chainman->ActiveChain().Tip();\r\n-    const auto pos{WITH_LOCK(cs_main, return oldTip->GetBlockPos())};\r\n-    GetBlockFileInfo(pos.nFile)->nSize = MAX_BLOCKFILE_SIZE;\r\n+    {\r\n+        LOCK(cs_main);\r\n+        GetBlockFileInfo(oldTip->GetBlockPos().nFile)->nSize = MAX_BLOCKFILE_SIZE;\r\n+    }\r\n     CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\r\n     CBlockIndex* newTip = m_node.chainman->ActiveChain().Tip();\r\n```\r\n</p></details>\r\n",
      "created_at" : "2021-09-17T16:22:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-921923502",
      "id" : 921923502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII584282-u",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-17T16:22:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921923502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711201778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711201778"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Having a quick look at annotating `nStatus` to assess.",
      "commit_id" : "285ecb2feeca7811292a103d1fedf70c7414ce33",
      "created_at" : "2021-09-17T16:38:02Z",
      "diff_hunk" : "@@ -212,7 +215,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711201778",
      "id" : 711201778,
      "in_reply_to_id" : 710934432,
      "line" : 218,
      "node_id" : "PRRC_kwDOABII584qZBPy",
      "original_commit_id" : "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
      "original_line" : 218,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 31,
      "pull_request_review_id" : 757661010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-17T16:38:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711201778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711225765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711225765"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Appended a small commit to guard `CBlockIndex::nStatus` by `cs_main` as a starting point.",
      "commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "created_at" : "2021-09-17T17:17:27Z",
      "diff_hunk" : "@@ -212,7 +215,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711225765",
      "id" : 711225765,
      "in_reply_to_id" : 710934432,
      "line" : 229,
      "node_id" : "PRRC_kwDOABII584qZHGl",
      "original_commit_id" : "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
      "original_line" : 229,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 31,
      "pull_request_review_id" : 757693855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711225765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-16T19:24:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711225765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-23T21:10:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-926163532",
      "id" : 926163532,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5843NCJM",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-23T21:10:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926163532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after the merge of #21526.",
      "created_at" : "2021-09-23T21:29:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-926175891",
      "id" : 926175891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5843NFKT",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-23T21:29:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926175891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241371"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e8cc6987f34d19f88de8c461af1efcdd8c3825ec\r\n\r\nMissing\r\n```\r\nAssertLockHeld(cs_main);\r\n```",
      "commit_id" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
      "created_at" : "2021-10-16T09:59:01Z",
      "diff_hunk" : "@@ -220,7 +223,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241371",
      "id" : 730241371,
      "line" : 227,
      "node_id" : "PRRC_kwDOABII584rhplb",
      "original_commit_id" : "e8cc6987f34d19f88de8c461af1efcdd8c3825ec",
      "original_line" : 227,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 32,
      "pull_request_review_id" : 781346727,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241371/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-16T10:10:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9bec673716e68b1854562e4e48a6cb26d8949a59\r\n\r\nMissing\r\n```\r\nAssertLockHeld(cs_main);\r\n```",
      "commit_id" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
      "created_at" : "2021-10-16T09:59:43Z",
      "diff_hunk" : "@@ -233,7 +233,8 @@ class CBlockIndex\n         return ret;\n     }\n \n-    FlatFilePos GetUndoPos() const {\n+    FlatFilePos GetUndoPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241402",
      "id" : 730241402,
      "line" : 237,
      "node_id" : "PRRC_kwDOABII584rhpl6",
      "original_commit_id" : "9bec673716e68b1854562e4e48a6cb26d8949a59",
      "original_line" : 237,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 42,
      "pull_request_review_id" : 781346727,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241402/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-16T10:10:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241821"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9bec673716e68b1854562e4e48a6cb26d8949a59\r\n\r\nWhy is this needed? `WriteUndoDataForBlock` is only called  from `CChainState::ConnectBlock` which already locks `cs_main`.",
      "commit_id" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
      "created_at" : "2021-10-16T10:03:11Z",
      "diff_hunk" : "@@ -336,7 +337,7 @@ static bool WriteBlockToDisk(const CBlock& block, FlatFilePos& pos, const CMessa\n bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams)\n {\n     // Write undo information to disk\n-    if (pindex->GetUndoPos().IsNull()) {\n+    if (WITH_LOCK(cs_main, return pindex->GetUndoPos()).IsNull()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241821",
      "id" : 730241821,
      "line" : 341,
      "node_id" : "PRRC_kwDOABII584rhpsd",
      "original_commit_id" : "9bec673716e68b1854562e4e48a6cb26d8949a59",
      "original_line" : 340,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 23,
      "pull_request_review_id" : 781346727,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241821/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-16T10:10:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730242048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0\r\n\r\nAgain, `cs_main` is already held here right?",
      "commit_id" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
      "created_at" : "2021-10-16T10:05:56Z",
      "diff_hunk" : "@@ -355,9 +356,12 @@ bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& st\n         }\n \n         // update nUndoPos in block index\n-        pindex->nUndoPos = _pos.nPos;\n-        pindex->nStatus |= BLOCK_HAVE_UNDO;\n-        setDirtyBlockIndex.insert(pindex);\n+        {\n+            LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730242048",
      "id" : 730242048,
      "line" : 360,
      "node_id" : "PRRC_kwDOABII584rhpwA",
      "original_commit_id" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
      "original_line" : 360,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 35,
      "pull_request_review_id" : 781346727,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242048/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-16T10:10:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730242273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242273"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0\r\n\r\nnit,\r\n```cpp\r\nconst bool block_have_data{WITH_LOCK(cs_main, return blockindex->nStatus & BLOCK_HAVE_DATA)};\r\n```",
      "commit_id" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
      "created_at" : "2021-10-16T10:08:03Z",
      "diff_hunk" : "@@ -196,7 +196,8 @@ static RPCHelpMan getrawtransaction()\n     if (!tx) {\n         std::string errmsg;\n         if (blockindex) {\n-            if (!(blockindex->nStatus & BLOCK_HAVE_DATA)) {\n+            const auto status{WITH_LOCK(cs_main, return blockindex->nStatus)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730242273",
      "id" : 730242273,
      "line" : 199,
      "node_id" : "PRRC_kwDOABII584rhpzh",
      "original_commit_id" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
      "original_line" : 199,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 5,
      "pull_request_review_id" : 781346727,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242273/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-16T10:10:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753830643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830643"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @promag, done.",
      "commit_id" : "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
      "created_at" : "2021-11-21T17:26:46Z",
      "diff_hunk" : "@@ -220,7 +223,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753830643",
      "id" : 753830643,
      "in_reply_to_id" : 730241371,
      "line" : 227,
      "node_id" : "PRRC_kwDOABII584s7orz",
      "original_commit_id" : "e8cc6987f34d19f88de8c461af1efcdd8c3825ec",
      "original_line" : 227,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 32,
      "pull_request_review_id" : 811946046,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830643/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-21T17:26:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753830745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
      "created_at" : "2021-11-21T17:27:09Z",
      "diff_hunk" : "@@ -233,7 +233,8 @@ class CBlockIndex\n         return ret;\n     }\n \n-    FlatFilePos GetUndoPos() const {\n+    FlatFilePos GetUndoPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753830745",
      "id" : 753830745,
      "in_reply_to_id" : 730241402,
      "line" : 238,
      "node_id" : "PRRC_kwDOABII584s7otZ",
      "original_commit_id" : "9bec673716e68b1854562e4e48a6cb26d8949a59",
      "original_line" : 238,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 43,
      "pull_request_review_id" : 811946079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830745/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-21T17:27:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753831056"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753831056"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
      "created_at" : "2021-11-21T17:30:36Z",
      "diff_hunk" : "@@ -196,7 +196,8 @@ static RPCHelpMan getrawtransaction()\n     if (!tx) {\n         std::string errmsg;\n         if (blockindex) {\n-            if (!(blockindex->nStatus & BLOCK_HAVE_DATA)) {\n+            const auto status{WITH_LOCK(cs_main, return blockindex->nStatus)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753831056",
      "id" : 753831056,
      "in_reply_to_id" : 730242273,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584s7oyQ",
      "original_commit_id" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
      "original_line" : 199,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 811946377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753831056/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-21T17:30:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753831056",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832096"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@promag You're right; Clang 13 seems unable to detect this on its own, but the unneeded lock can be avoided by requiring `WriteUndoDataForBlock()` to hold cs_main instead. Done in  686ae2d97.",
      "commit_id" : "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
      "created_at" : "2021-11-21T17:39:51Z",
      "diff_hunk" : "@@ -336,7 +337,7 @@ static bool WriteBlockToDisk(const CBlock& block, FlatFilePos& pos, const CMessa\n bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams)\n {\n     // Write undo information to disk\n-    if (pindex->GetUndoPos().IsNull()) {\n+    if (WITH_LOCK(cs_main, return pindex->GetUndoPos()).IsNull()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832096",
      "id" : 753832096,
      "in_reply_to_id" : 730241821,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584s7pCg",
      "original_commit_id" : "9bec673716e68b1854562e4e48a6cb26d8949a59",
      "original_line" : 340,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 811947207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832096/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-21T17:39:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! Removed in both places in this function as described in https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832096.",
      "commit_id" : "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
      "created_at" : "2021-11-21T17:41:29Z",
      "diff_hunk" : "@@ -355,9 +356,12 @@ bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& st\n         }\n \n         // update nUndoPos in block index\n-        pindex->nUndoPos = _pos.nPos;\n-        pindex->nStatus |= BLOCK_HAVE_UNDO;\n-        setDirtyBlockIndex.insert(pindex);\n+        {\n+            LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832294",
      "id" : 753832294,
      "in_reply_to_id" : 730242048,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584s7pFm",
      "original_commit_id" : "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
      "original_line" : 360,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 811947338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-21T17:41:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thank you for reviewing, @promag. Updated based on your feedback per `git diff 9cacc50 b1c859a`.",
      "created_at" : "2021-11-22T10:29:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-975378387",
      "id" : 975378387,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5846IxfT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/975378387/reactions"
      },
      "updated_at" : "2021-11-22T10:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/975378387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, the description only says \"Potentially related to issue #17161.\", otherwise I don't really see a description of what problem this PR is actually fixing/improving?",
      "created_at" : "2021-11-28T17:24:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-981121451",
      "id" : 981121451,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5846ermr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981121451/reactions"
      },
      "updated_at" : "2021-11-28T17:24:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981121451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-12-15T17:10:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-994992204",
      "id" : 994992204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5847TmBM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/994992204/reactions"
      },
      "updated_at" : "2021-12-15T17:10:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/994992204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> otherwise I don't really see a description of what problem this PR is actually fixing/improving?\r\n\r\nIs the `nStatus` field potentially accessed by multiple threads at once? #17161 seems to indicate it is. If so, it needs to be either an atomic value or protected by a mutex.",
      "created_at" : "2021-12-15T20:08:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-995175182",
      "id" : 995175182,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5847USsO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995175182/reactions"
      },
      "updated_at" : "2021-12-15T20:08:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995175182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and updated per `git range-diff df6e961 b1c859a d588248`.  @fjahr I improved the OP.  @laanwj: thanks!",
      "created_at" : "2021-12-16T11:31:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-995707755",
      "id" : 995707755,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5847WUtr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995707755/reactions"
      },
      "updated_at" : "2021-12-16T17:24:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995707755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "While you're making changes, can you also update the commits to drop the `consensus:` prefix, as I don't think that's correct for these changes.",
      "created_at" : "2021-12-17T03:37:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-996410883",
      "id" : 996410883,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5847ZAYD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/996410883/reactions"
      },
      "updated_at" : "2021-12-17T03:37:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/996410883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2021-12-18T14:04:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-997207183",
      "id" : 997207183,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5847cCyP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997207183/reactions"
      },
      "updated_at" : "2021-12-18T14:04:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997207183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r771831225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771831225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How about getting rid of this function entirely:\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 2a30afdb5..030a8c736 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -1848,7 +1848,7 @@ void PeerManagerImpl::ProcessGetBlockData(CNode& pfrom, Peer& peer, const CInv&\r\n         // Fast-path: in this case it is possible to serve the block directly from disk,\r\n         // as the network format matches the format on disk\r\n         std::vector<uint8_t> block_data;\r\n-        if (!ReadRawBlockFromDisk(block_data, pindex, m_chainparams.MessageStart())) {\r\n+        if (!ReadRawBlockFromDisk(block_data, pindex->GetBlockPos(), m_chainparams.MessageStart())) {\r\n             assert(!\"cannot load block from disk\");\r\n         }\r\n         m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::BLOCK, Span{block_data}));\r\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\r\nindex 1af24ecf6..bf47ab351 100644\r\n--- a/src/node/blockstorage.cpp\r\n+++ b/src/node/blockstorage.cpp\r\n@@ -446,12 +446,6 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\r\n     return true;\r\n }\r\n \r\n-bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CBlockIndex* pindex, const CMessageHeader::MessageStartChars& message_start)\r\n-{\r\n-    const FlatFilePos block_pos{WITH_LOCK(cs_main, return pindex->GetBlockPos())};\r\n-    return ReadRawBlockFromDisk(block, block_pos, message_start);\r\n-}\r\n-\r\n /** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\r\n FlatFilePos SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\r\n {\r\ndiff --git a/src/node/blockstorage.h b/src/node/blockstorage.h\r\nindex 93e3b1e93..6872848f2 100644\r\n--- a/src/node/blockstorage.h\r\n+++ b/src/node/blockstorage.h\r\n@@ -73,7 +73,6 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\r\n bool ReadBlockFromDisk(CBlock& block, const FlatFilePos& pos, const Consensus::Params& consensusParams);\r\n bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus::Params& consensusParams);\r\n bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, const CMessageHeader::MessageStartChars& message_start);\r\n-bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CBlockIndex* pindex, const CMessageHeader::MessageStartChars& message_start);\r\n \r\n bool UndoReadFromDisk(CBlockUndo& blockundo, const CBlockIndex* pindex);\r\n bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n```\r\n?",
      "commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "created_at" : "2021-12-18T14:31:51Z",
      "diff_hunk" : "@@ -445,12 +448,7 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n \n bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CBlockIndex* pindex, const CMessageHeader::MessageStartChars& message_start)\n {\n-    FlatFilePos block_pos;\n-    {\n-        LOCK(cs_main);\n-        block_pos = pindex->GetBlockPos();\n-    }\n-\n+    const FlatFilePos block_pos{WITH_LOCK(cs_main, return pindex->GetBlockPos())};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r771831225",
      "id" : 771831225,
      "line" : 451,
      "node_id" : "PRRC_kwDOABII584uATW5",
      "original_commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "original_line" : 451,
      "original_position" : 36,
      "original_start_line" : 448,
      "path" : "src/node/blockstorage.cpp",
      "position" : 36,
      "pull_request_review_id" : 835778274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771831225/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 448,
      "start_side" : "LEFT",
      "updated_at" : "2021-12-18T14:36:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771831225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r771831386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771831386"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit, here and after: For new code maybe be explicit about the global namespace:\r\n```suggestion\r\nextern RecursiveMutex ::cs_main;\r\n```\r\n?",
      "commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "created_at" : "2021-12-18T14:33:35Z",
      "diff_hunk" : "@@ -37,6 +38,8 @@ static constexpr int64_t TIMESTAMP_WINDOW = MAX_FUTURE_BLOCK_TIME;\n  */\n static constexpr int64_t MAX_BLOCK_TIME_GAP = 90 * 60;\n \n+extern RecursiveMutex cs_main;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r771831386",
      "id" : 771831386,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII584uATZa",
      "original_commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "original_line" : 41,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 12,
      "pull_request_review_id" : 835778274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771831386/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-18T14:36:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771831386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r771831485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771831485"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit: Is it more readable:\r\n```suggestion\r\nbool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams)\r\n    EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n```\r\n?",
      "commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "created_at" : "2021-12-18T14:35:09Z",
      "diff_hunk" : "@@ -73,7 +76,7 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CBlockIndex* pindex, const CMessageHeader::MessageStartChars& message_start);\n \n bool UndoReadFromDisk(CBlockUndo& blockundo, const CBlockIndex* pindex);\n-bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams);\n+bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r771831485",
      "id" : 771831485,
      "line" : 79,
      "node_id" : "PRRC_kwDOABII584uATa9",
      "original_commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "original_line" : 79,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 20,
      "pull_request_review_id" : 835778274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771831485/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-18T14:36:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771831485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> While you're making changes, can you also update the commits to drop the `consensus:` prefix, as I don't think that's correct for these changes.\r\n\r\nThat prefix was used for the commits that update `chain.h`, but sure, will omit the prefix.",
      "created_at" : "2021-12-21T14:33:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-998827566",
      "id" : 998827566,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5847iOYu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/998827566/reactions"
      },
      "updated_at" : "2021-12-21T14:33:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/998827566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r773290638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/773290638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "created_at" : "2021-12-21T16:44:07Z",
      "diff_hunk" : "@@ -445,12 +448,7 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n \n bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CBlockIndex* pindex, const CMessageHeader::MessageStartChars& message_start)\n {\n-    FlatFilePos block_pos;\n-    {\n-        LOCK(cs_main);\n-        block_pos = pindex->GetBlockPos();\n-    }\n-\n+    const FlatFilePos block_pos{WITH_LOCK(cs_main, return pindex->GetBlockPos())};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r773290638",
      "id" : 773290638,
      "in_reply_to_id" : 771831225,
      "line" : 451,
      "node_id" : "PRRC_kwDOABII584uF3qO",
      "original_commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "original_line" : 451,
      "original_position" : 36,
      "original_start_line" : 448,
      "path" : "src/node/blockstorage.cpp",
      "position" : 36,
      "pull_request_review_id" : 837652247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/773290638/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 448,
      "start_side" : "LEFT",
      "updated_at" : "2021-12-21T16:44:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/773290638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r773290817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/773290817"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "29cf830d155a5063bfabc6837069adeac2f464ee",
      "created_at" : "2021-12-21T16:44:24Z",
      "diff_hunk" : "@@ -37,6 +38,8 @@ static constexpr int64_t TIMESTAMP_WINDOW = MAX_FUTURE_BLOCK_TIME;\n  */\n static constexpr int64_t MAX_BLOCK_TIME_GAP = 90 * 60;\n \n+extern RecursiveMutex cs_main;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r773290817",
      "id" : 773290817,
      "in_reply_to_id" : 771831386,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII584uF3tB",
      "original_commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "original_line" : 41,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 12,
      "pull_request_review_id" : 837652529,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/773290817/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-05T16:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/773290817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r773291517"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/773291517"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not to me ;) but ok, done",
      "commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "created_at" : "2021-12-21T16:45:26Z",
      "diff_hunk" : "@@ -73,7 +76,7 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CBlockIndex* pindex, const CMessageHeader::MessageStartChars& message_start);\n \n bool UndoReadFromDisk(CBlockUndo& blockundo, const CBlockIndex* pindex);\n-bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams);\n+bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r773291517",
      "id" : 773291517,
      "in_reply_to_id" : 771831485,
      "line" : 79,
      "node_id" : "PRRC_kwDOABII584uF339",
      "original_commit_id" : "d588248ecf10cd55f868bc8799416c3c82360698",
      "original_line" : 79,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 20,
      "pull_request_review_id" : 837653522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/773291517/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-21T16:45:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/773291517",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated with feedback by @fanquake and @hebasto (thanks!)",
      "created_at" : "2021-12-21T17:44:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-998973891",
      "id" : 998973891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5847iyHD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/998973891/reactions"
      },
      "updated_at" : "2021-12-21T17:44:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/998973891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r776465444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776465444"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0bfa32b131ed2da8799e1d1239bf390dd612b7bb\r\nstyle nit: [`clang-format-diff.py`](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy) insists on:\r\n```suggestion\r\n        GetSizeOfCompactSize(block.vtx.size())};\r\n```",
      "commit_id" : "29cf830d155a5063bfabc6837069adeac2f464ee",
      "created_at" : "2021-12-29T19:24:04Z",
      "diff_hunk" : "@@ -57,7 +57,10 @@ bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n     // Exclude genesis block transaction because outputs are not spendable.\n     if (pindex->nHeight == 0) return true;\n \n-    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    CDiskTxPos pos{\n+        WITH_LOCK(::cs_main, return pindex->GetBlockPos()),\n+        GetSizeOfCompactSize(block.vtx.size())\n+    };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r776465444",
      "id" : 776465444,
      "line" : 63,
      "node_id" : "PRRC_kwDOABII584uR-wk",
      "original_commit_id" : "29cf830d155a5063bfabc6837069adeac2f464ee",
      "original_line" : 63,
      "original_position" : 8,
      "original_start_line" : 62,
      "path" : "src/index/txindex.cpp",
      "position" : 8,
      "pull_request_review_id" : 841585231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776465444/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 62,
      "start_side" : "RIGHT",
      "updated_at" : "2021-12-29T19:48:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776465444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r776472618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776472618"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0bfa32b131ed2da8799e1d1239bf390dd612b7bb (here and after)\r\n`UnlinkPrunedFiles` includes a logging operation. Could we keep logging out of the `::cs_main` lock?",
      "commit_id" : "29cf830d155a5063bfabc6837069adeac2f464ee",
      "created_at" : "2021-12-29T19:47:54Z",
      "diff_hunk" : "@@ -137,10 +140,10 @@ BOOST_FIXTURE_TEST_CASE(scan_for_wallet_transactions, TestChain100Setup)\n \n     // Prune the older block file.\n     {\n-        LOCK(cs_main);\n+        LOCK(::cs_main);\n         Assert(m_node.chainman)->m_blockman.PruneOneBlockFile(oldTip->GetBlockPos().nFile);\n+        UnlinkPrunedFiles({oldTip->GetBlockPos().nFile});\n     }\n-    UnlinkPrunedFiles({oldTip->GetBlockPos().nFile});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r776472618",
      "id" : 776472618,
      "line" : 143,
      "node_id" : "PRRC_kwDOABII584uSAgq",
      "original_commit_id" : "29cf830d155a5063bfabc6837069adeac2f464ee",
      "original_line" : 143,
      "original_position" : 21,
      "original_start_line" : 145,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 21,
      "pull_request_review_id" : 841585231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776472618/reactions"
      },
      "side" : "LEFT",
      "start_line" : 145,
      "start_side" : "RIGHT",
      "updated_at" : "2021-12-29T19:48:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776472618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-04T03:24:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1004501694",
      "id" : 1004501694,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII584733q-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1004501694/reactions"
      },
      "updated_at" : "2022-01-04T03:24:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1004501694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r778978158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778978158"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "29cf830d155a5063bfabc6837069adeac2f464ee",
      "created_at" : "2022-01-05T16:51:24Z",
      "diff_hunk" : "@@ -57,7 +57,10 @@ bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n     // Exclude genesis block transaction because outputs are not spendable.\n     if (pindex->nHeight == 0) return true;\n \n-    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    CDiskTxPos pos{\n+        WITH_LOCK(::cs_main, return pindex->GetBlockPos()),\n+        GetSizeOfCompactSize(block.vtx.size())\n+    };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r778978158",
      "id" : 778978158,
      "in_reply_to_id" : 776465444,
      "line" : 63,
      "node_id" : "PRRC_kwDOABII584ubkNu",
      "original_commit_id" : "29cf830d155a5063bfabc6837069adeac2f464ee",
      "original_line" : 63,
      "original_position" : 8,
      "original_start_line" : 62,
      "path" : "src/index/txindex.cpp",
      "position" : 8,
      "pull_request_review_id" : 844831164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778978158/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 62,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-05T16:51:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778978158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r778978320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778978320"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "29cf830d155a5063bfabc6837069adeac2f464ee",
      "created_at" : "2022-01-05T16:51:37Z",
      "diff_hunk" : "@@ -137,10 +140,10 @@ BOOST_FIXTURE_TEST_CASE(scan_for_wallet_transactions, TestChain100Setup)\n \n     // Prune the older block file.\n     {\n-        LOCK(cs_main);\n+        LOCK(::cs_main);\n         Assert(m_node.chainman)->m_blockman.PruneOneBlockFile(oldTip->GetBlockPos().nFile);\n+        UnlinkPrunedFiles({oldTip->GetBlockPos().nFile});\n     }\n-    UnlinkPrunedFiles({oldTip->GetBlockPos().nFile});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r778978320",
      "id" : 778978320,
      "in_reply_to_id" : 776472618,
      "line" : 143,
      "node_id" : "PRRC_kwDOABII584ubkQQ",
      "original_commit_id" : "29cf830d155a5063bfabc6837069adeac2f464ee",
      "original_line" : 143,
      "original_position" : 21,
      "original_start_line" : 145,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 21,
      "pull_request_review_id" : 844831399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778978320/reactions"
      },
      "side" : "LEFT",
      "start_line" : 145,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-05T16:51:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778978320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for reviewing @hebasto!\r\n\r\n> The `WriteUndoDataForBlock` contains disk operations. It seems suboptimal to hold `::cs_main` for the whole function. \r\n\r\nThe lock is already held by the function's caller (and is also needed further down in the function for `pindex->nStatus`) so it seemed best to verify the lock is already held rather than taking it twice unnecessarily. I updated the commit description of d1200d67830e777fb96737e31ec5d85b3d095348 to make this clearer.\r\n\r\nRebased and updated per `git range-diff e31cdb0 29cf830 3b9ea0b `.",
      "created_at" : "2022-01-05T16:53:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1005898131",
      "id" : 1005898131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII58479MmT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005898131/reactions"
      },
      "updated_at" : "2022-01-05T17:14:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005898131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-07T04:56:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1007140693",
      "id" : 1007140693,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5848B79V",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007140693/reactions"
      },
      "updated_at" : "2022-01-07T04:56:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007140693",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.",
      "created_at" : "2022-01-07T12:58:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1007387217",
      "id" : 1007387217,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5848C4JR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007387217/reactions"
      },
      "updated_at" : "2022-01-10T21:55:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007387217",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r781041061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781041061"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why a scope of this lock is so wide?",
      "commit_id" : "71bfaa1c367ea15d73a027dad1fe4601df0c73d2",
      "created_at" : "2022-01-10T10:03:55Z",
      "diff_hunk" : "@@ -308,6 +308,7 @@ bool CBlockTreeDB::LoadBlockIndexGuts(const Consensus::Params& consensusParams,\n             CDiskBlockIndex diskindex;\n             if (pcursor->GetValue(diskindex)) {\n                 // Construct block index object\n+                LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r781041061",
      "id" : 781041061,
      "line" : 311,
      "node_id" : "PRRC_kwDOABII584ujb2l",
      "original_commit_id" : "71bfaa1c367ea15d73a027dad1fe4601df0c73d2",
      "original_line" : 311,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : 4,
      "pull_request_review_id" : 847592589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781041061/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-10T10:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781041061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 71bfaa1c367ea15d73a027dad1fe4601df0c73d2",
      "created_at" : "2022-01-10T21:42:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1009372269",
      "id" : 1009372269,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5848Kcxt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009372269/reactions"
      },
      "updated_at" : "2022-01-10T21:42:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009372269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r782163163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/782163163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Scope narrowed per `git diff 71bfaa1 e9560c6`\r\n```diff\r\n--- a/src/txdb.cpp\r\n+++ b/src/txdb.cpp\r\n@@ -308,7 +308,6 @@ bool CBlockTreeDB::LoadBlockIndexGuts(const Consensus::Params& consensusParams,\r\n             CDiskBlockIndex diskindex;\r\n             if (pcursor->GetValue(diskindex)) {\r\n                 // Construct block index object\r\n-                LOCK(::cs_main);\r\n                 CBlockIndex* pindexNew = insertBlockIndex(diskindex.GetBlockHash());\r\n                 pindexNew->pprev          = insertBlockIndex(diskindex.hashPrev);\r\n                 pindexNew->nHeight        = diskindex.nHeight;\r\n@@ -320,11 +319,15 @@ bool CBlockTreeDB::LoadBlockIndexGuts(const Consensus::Params& consensusParams,\r\n                 pindexNew->nTime          = diskindex.nTime;\r\n                 pindexNew->nBits          = diskindex.nBits;\r\n                 pindexNew->nNonce         = diskindex.nNonce;\r\n-                pindexNew->nStatus        = diskindex.nStatus;\r\n                 pindexNew->nTx            = diskindex.nTx;\r\n+                {\r\n+                    LOCK(::cs_main);\r\n+                    pindexNew->nStatus = diskindex.nStatus;\r\n+                }\r\n```\r\n",
      "commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "created_at" : "2022-01-11T13:53:56Z",
      "diff_hunk" : "@@ -308,6 +308,7 @@ bool CBlockTreeDB::LoadBlockIndexGuts(const Consensus::Params& consensusParams,\n             CDiskBlockIndex diskindex;\n             if (pcursor->GetValue(diskindex)) {\n                 // Construct block index object\n+                LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r782163163",
      "id" : 782163163,
      "in_reply_to_id" : 781041061,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584untzb",
      "original_commit_id" : "71bfaa1c367ea15d73a027dad1fe4601df0c73d2",
      "original_line" : 311,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 849196045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/782163163/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-11T13:53:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/782163163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thank you @hebasto and @achow101 for the reviews; updated with @hebasto's feedback per `git diff 71bfaa1 e9560c6` ",
      "created_at" : "2022-01-11T13:55:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1009987587",
      "id" : 1009987587,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5848MzAD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009987587/reactions"
      },
      "updated_at" : "2022-01-11T13:55:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009987587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "created_at" : "2022-01-11T19:42:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1010301696",
      "id" : 1010301696,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5848N_sA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1010301696/reactions"
      },
      "updated_at" : "2022-01-11T19:42:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1010301696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786130258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786130258"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "All places that call `IsValid()` already own `cs_main`. Thus I think it is better just to mandate that it is required when calling this function and avoid locking it recursively:\r\n\r\n<details>\r\n<summary>suggested change</summary>\r\n\r\n```diff\r\n     //! Check whether this block index entry is valid up to the passed validity level.\r\n     bool IsValid(enum BlockStatus nUpTo = BLOCK_VALID_TRANSACTIONS) const\r\n+        EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\n     {\r\n+        AssertLockHeld(cs_main);\r\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\r\n-        LOCK(::cs_main);\r\n         if (nStatus & BLOCK_FAILED_MASK) {\r\n```\r\n</details>\r\n",
      "commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "created_at" : "2022-01-17T15:54:41Z",
      "diff_hunk" : "@@ -308,20 +313,27 @@ class CBlockIndex\n     bool IsValid(enum BlockStatus nUpTo = BLOCK_VALID_TRANSACTIONS) const\n     {\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\n-        if (nStatus & BLOCK_FAILED_MASK)\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786130258",
      "id" : 786130258,
      "line" : 316,
      "node_id" : "PRRC_kwDOABII584u22VS",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 316,
      "original_position" : 53,
      "original_start_line" : 313,
      "path" : "src/chain.h",
      "position" : 53,
      "pull_request_review_id" : 854578756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786130258/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 313,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-17T16:55:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786130258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786137351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786137351"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same as `IsValid()` (except some tests):\r\n\r\n<details>\r\n<summary>suggested change</summary>\r\n\r\n```diff\r\ndiff --git i/src/chain.h w/src/chain.h\r\nindex 2a7e420c31..291e684eef 100644\r\n--- i/src/chain.h\r\n+++ w/src/chain.h\r\n\r\n[...]\r\n     //! @returns true if the block is assumed-valid; this means it is queued to be\r\n     //!   validated by a background chainstate.\r\n-    bool IsAssumedValid() const\r\n+    bool IsAssumedValid() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\n     {\r\n-        LOCK(::cs_main);\r\n+        AssertLockHeld(cs_main);\r\n         return nStatus & BLOCK_ASSUMED_VALID;\r\n     }\r\n[...]\r\n\r\ndiff --git i/src/test/validation_chainstatemanager_tests.cpp w/src/test/validation_chainstatemanager_tests.cpp\r\nindex 47d9a77126..e3fd1f203a 100644\r\n--- i/src/test/validation_chainstatemanager_tests.cpp\r\n+++ w/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -230,13 +230,16 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Setup)\r\n     BOOST_CHECK(!chainman.ActiveChainstate().m_from_snapshot_blockhash->IsNull());\r\n     BOOST_CHECK_EQUAL(\r\n         *chainman.ActiveChainstate().m_from_snapshot_blockhash,\r\n         *chainman.SnapshotBlockhash());\r\n \r\n     // Ensure that the genesis block was not marked assumed-valid.\r\n-    BOOST_CHECK(!chainman.ActiveChain().Genesis()->IsAssumedValid());\r\n+    {\r\n+        LOCK(cs_main);\r\n+        BOOST_CHECK(!chainman.ActiveChain().Genesis()->IsAssumedValid());\r\n+    }\r\n \r\n     const AssumeutxoData& au_data = *ExpectedAssumeutxo(snapshot_height, ::Params());\r\n     const CBlockIndex* tip = chainman.ActiveTip();\r\n \r\n     BOOST_CHECK_EQUAL(tip->nChainTx, au_data.nChainTx);\r\n \r\n@@ -351,16 +354,16 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n     // tip candidates.\r\n     reload_all_block_indexes();\r\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\r\n \r\n     // Mark some region of the chain assumed-valid.\r\n     for (int i = 0; i <= cs1.m_chain.Height(); ++i) {\r\n+        LOCK(::cs_main);\r\n         auto index = cs1.m_chain[i];\r\n \r\n         if (i < last_assumed_valid_idx && i >= assumed_valid_start_idx) {\r\n-            LOCK(::cs_main);\r\n             index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\r\n         }\r\n \r\n         ++num_indexes;\r\n         if (index->IsAssumedValid()) ++num_assumed_valid;\r\n```\r\n</details>\r\n",
      "commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "created_at" : "2022-01-17T16:03:48Z",
      "diff_hunk" : "@@ -308,20 +313,27 @@ class CBlockIndex\n     bool IsValid(enum BlockStatus nUpTo = BLOCK_VALID_TRANSACTIONS) const\n     {\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\n-        if (nStatus & BLOCK_FAILED_MASK)\n+        LOCK(::cs_main);\n+        if (nStatus & BLOCK_FAILED_MASK) {\n             return false;\n+        }\n         return ((nStatus & BLOCK_VALID_MASK) >= nUpTo);\n     }\n \n     //! @returns true if the block is assumed-valid; this means it is queued to be\n     //!   validated by a background chainstate.\n-    bool IsAssumedValid() const { return nStatus & BLOCK_ASSUMED_VALID; }\n+    bool IsAssumedValid() const\n+    {\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786137351",
      "id" : 786137351,
      "line" : 327,
      "node_id" : "PRRC_kwDOABII584u24EH",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 327,
      "original_position" : 65,
      "original_start_line" : 325,
      "path" : "src/chain.h",
      "position" : 65,
      "pull_request_review_id" : 854578756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786137351/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 325,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-17T16:55:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786137351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786139348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786139348"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same as `IsValid()` (except some tests):\r\n\r\n\r\n<details>\r\n<summary>suggested change</summary>\r\n\r\n```diff\r\ndiff --git i/src/chain.h w/src/chain.h\r\nindex 2a7e420c31..291e684eef 100644\r\n--- i/src/chain.h\r\n+++ w/src/chain.h\r\n\r\n[...]\r\n     //! Raise the validity level of this block index entry.\r\n     //! Returns true if the validity was changed.\r\n-    bool RaiseValidity(enum BlockStatus nUpTo)\r\n+    bool RaiseValidity(enum BlockStatus nUpTo) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\n     {\r\n+        AssertLockHeld(cs_main);\r\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\r\n-        LOCK(::cs_main);\r\n         if (nStatus & BLOCK_FAILED_MASK) return false;\r\n[...]\r\n\r\ndiff --git i/src/test/fuzz/chain.cpp w/src/test/fuzz/chain.cpp\r\nindex 4f97e1ebb1..e4fd2b32f6 100644\r\n--- i/src/test/fuzz/chain.cpp\r\n+++ w/src/test/fuzz/chain.cpp\r\n@@ -55,13 +55,13 @@ FUZZ_TARGET(chain)\r\n             BlockStatus::BLOCK_FAILED_MASK,\r\n             BlockStatus::BLOCK_OPT_WITNESS,\r\n         });\r\n         if (block_status & ~BLOCK_VALID_MASK) {\r\n             continue;\r\n         }\r\n-        (void)disk_block_index->RaiseValidity(block_status);\r\n+        WITH_LOCK(cs_main, (void)disk_block_index->RaiseValidity(block_status));\r\n     }\r\n \r\n     CBlockIndex block_index{block_header};\r\n     block_index.phashBlock = &zero;\r\n     (void)block_index.GetBlockHash();\r\n     (void)block_index.ToString();\r\ndiff --git i/src/test/validation_chainstatemanager_tests.cpp w/src/test/validation_chainstatemanager_tests.cpp\r\nindex 47d9a77126..e3fd1f203a 100644\r\n--- i/src/test/validation_chainstatemanager_tests.cpp\r\n+++ w/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -230,13 +230,16 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Setup)\r\n     BOOST_CHECK(!chainman.ActiveChainstate().m_from_snapshot_blockhash->IsNull());\r\n     BOOST_CHECK_EQUAL(\r\n         *chainman.ActiveChainstate().m_from_snapshot_blockhash,\r\n         *chainman.SnapshotBlockhash());\r\n \r\n     // Ensure that the genesis block was not marked assumed-valid.\r\n-    BOOST_CHECK(!chainman.ActiveChain().Genesis()->IsAssumedValid());\r\n+    {\r\n+        LOCK(cs_main);\r\n+        BOOST_CHECK(!chainman.ActiveChain().Genesis()->IsAssumedValid());\r\n+    }\r\n \r\n     const AssumeutxoData& au_data = *ExpectedAssumeutxo(snapshot_height, ::Params());\r\n     const CBlockIndex* tip = chainman.ActiveTip();\r\n \r\n     BOOST_CHECK_EQUAL(tip->nChainTx, au_data.nChainTx);\r\n \r\n@@ -351,16 +354,16 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n     // tip candidates.\r\n     reload_all_block_indexes();\r\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\r\n \r\n     // Mark some region of the chain assumed-valid.\r\n     for (int i = 0; i <= cs1.m_chain.Height(); ++i) {\r\n+        LOCK(::cs_main);\r\n         auto index = cs1.m_chain[i];\r\n \r\n         if (i < last_assumed_valid_idx && i >= assumed_valid_start_idx) {\r\n-            LOCK(::cs_main);\r\n             index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\r\n         }\r\n \r\n         ++num_indexes;\r\n         if (index->IsAssumedValid()) ++num_assumed_valid;\r\n```\r\n</details>\r\n",
      "commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "created_at" : "2022-01-17T16:06:31Z",
      "diff_hunk" : "@@ -308,20 +313,27 @@ class CBlockIndex\n     bool IsValid(enum BlockStatus nUpTo = BLOCK_VALID_TRANSACTIONS) const\n     {\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\n-        if (nStatus & BLOCK_FAILED_MASK)\n+        LOCK(::cs_main);\n+        if (nStatus & BLOCK_FAILED_MASK) {\n             return false;\n+        }\n         return ((nStatus & BLOCK_VALID_MASK) >= nUpTo);\n     }\n \n     //! @returns true if the block is assumed-valid; this means it is queued to be\n     //!   validated by a background chainstate.\n-    bool IsAssumedValid() const { return nStatus & BLOCK_ASSUMED_VALID; }\n+    bool IsAssumedValid() const\n+    {\n+        LOCK(::cs_main);\n+        return nStatus & BLOCK_ASSUMED_VALID;\n+    }\n \n     //! Raise the validity level of this block index entry.\n     //! Returns true if the validity was changed.\n     bool RaiseValidity(enum BlockStatus nUpTo)\n     {\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786139348",
      "id" : 786139348,
      "line" : 336,
      "node_id" : "PRRC_kwDOABII584u24jU",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 336,
      "original_position" : 74,
      "original_start_line" : 331,
      "path" : "src/chain.h",
      "position" : 74,
      "pull_request_review_id" : 854578756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786139348/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 331,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-17T16:55:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786139348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786156317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786156317"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same as `IsValid()`, except 3 of 4 callers of `IsBlockPruned()` already own `cs_main`. The 4th caller, `blockToJSON()` could be changed to acquire the mutex.\r\n\r\n<details>\r\n<summary>suggested change</summary>\r\n\r\n```diff\r\ndiff --git i/src/node/blockstorage.cpp w/src/node/blockstorage.cpp\r\nindex 5074080ed1..2217a4d6c8 100644\r\n--- i/src/node/blockstorage.cpp\r\n+++ w/src/node/blockstorage.cpp\r\n@@ -424,13 +424,13 @@ CBlockIndex* BlockManager::GetLastCheckpoint(const CCheckpointData& data)\r\n     }\r\n     return nullptr;\r\n }\r\n \r\n bool IsBlockPruned(const CBlockIndex* pblockindex)\r\n {\r\n-    LOCK(::cs_main);\r\n+    AssertLockHeld(cs_main);\r\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\r\n }\r\n \r\n // If we're using -prune with -reindex, then delete block files that will be ignored by the\r\n // reindex.  Since reindexing works by starting at block file 0 and looping until a blockfile\r\n // is missing, do the same here to delete any later block files after a gap.  Also delete all\r\ndiff --git i/src/node/blockstorage.h w/src/node/blockstorage.h\r\nindex 7efa7e3b72..0cdab404da 100644\r\n--- i/src/node/blockstorage.h\r\n+++ w/src/node/blockstorage.h\r\n@@ -163,13 +163,13 @@ public:\r\n     {\r\n         Unload();\r\n     }\r\n };\r\n \r\n //! Check whether the block associated with this index entry is pruned or not.\r\n-bool IsBlockPruned(const CBlockIndex* pblockindex);\r\n+bool IsBlockPruned(const CBlockIndex* pblockindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n \r\n void CleanupBlockRevFiles();\r\n \r\n /** Open a block file (blk?????.dat) */\r\n FILE* OpenBlockFile(const FlatFilePos& pos, bool fReadOnly = false);\r\n /** Translation to a filesystem path */\r\ndiff --git i/src/rpc/blockchain.cpp w/src/rpc/blockchain.cpp\r\nindex 455c32c57a..d7c1572099 100644\r\n--- i/src/rpc/blockchain.cpp\r\n+++ w/src/rpc/blockchain.cpp\r\n@@ -172,13 +172,17 @@ UniValue blockToJSON(const CBlock& block, const CBlockIndex* tip, const CBlockIn\r\n             }\r\n             break;\r\n \r\n         case TxVerbosity::SHOW_DETAILS:\r\n         case TxVerbosity::SHOW_DETAILS_AND_PREVOUT:\r\n             CBlockUndo blockUndo;\r\n-            const bool have_undo = !IsBlockPruned(blockindex) && UndoReadFromDisk(blockUndo, blockindex);\r\n+            bool have_undo;\r\n+            {\r\n+                LOCK(cs_main);\r\n+                have_undo = !IsBlockPruned(blockindex) && UndoReadFromDisk(blockUndo, blockindex);\r\n+            }\r\n \r\n             for (size_t i = 0; i < block.vtx.size(); ++i) {\r\n                 const CTransactionRef& tx = block.vtx.at(i);\r\n                 // coinbase transaction (i.e. i == 0) doesn't have undo data\r\n                 const CTxUndo* txundo = (have_undo && i > 0) ? &blockUndo.vtxundo.at(i - 1) : nullptr;\r\n                 UniValue objTx(UniValue::VOBJ);\r\n@@ -925,14 +929,15 @@ static RPCHelpMan getblockheader()\r\n \r\n     return blockheaderToJSON(tip, pblockindex);\r\n },\r\n     };\r\n }\r\n \r\n-static CBlock GetBlockChecked(const CBlockIndex* pblockindex)\r\n+static CBlock GetBlockChecked(const CBlockIndex* pblockindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\n {\r\n+    AssertLockHeld(cs_main);\r\n     CBlock block;\r\n     if (IsBlockPruned(pblockindex)) {\r\n         throw JSONRPCError(RPC_MISC_ERROR, \"Block not available (pruned data)\");\r\n     }\r\n \r\n     if (!ReadBlockFromDisk(block, pblockindex, Params().GetConsensus())) {\r\n@@ -942,14 +947,15 @@ static CBlock GetBlockChecked(const CBlockIndex* pblockindex)\r\n         throw JSONRPCError(RPC_MISC_ERROR, \"Block not found on disk\");\r\n     }\r\n \r\n     return block;\r\n }\r\n \r\n-static CBlockUndo GetUndoChecked(const CBlockIndex* pblockindex)\r\n+static CBlockUndo GetUndoChecked(const CBlockIndex* pblockindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\n {\r\n+    AssertLockHeld(cs_main);\r\n     CBlockUndo blockUndo;\r\n     if (IsBlockPruned(pblockindex)) {\r\n         throw JSONRPCError(RPC_MISC_ERROR, \"Undo data not available (pruned data)\");\r\n     }\r\n \r\n     if (!UndoReadFromDisk(blockUndo, pblockindex)) {\r\n```\r\n</details>\r\n\r\nI think it is better to call `UndoReadFromDisk()` also under the same acquisition of `cs_main` as `IsBlockPruned()` (as in the patch above) because that would ensure `nStatus` remains unchanged until after the disk read has completed (i.e. we don't end up with a status that indicates no file on disk and still trying to read the file, if `nStatus` is changed after we read it and before we read the file from disk).\r\n",
      "commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "created_at" : "2022-01-17T16:30:20Z",
      "diff_hunk" : "@@ -427,6 +427,7 @@ CBlockIndex* BlockManager::GetLastCheckpoint(const CCheckpointData& data)\n \n bool IsBlockPruned(const CBlockIndex* pblockindex)\n {\n+    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786156317",
      "id" : 786156317,
      "line" : 430,
      "node_id" : "PRRC_kwDOABII584u28sd",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 430,
      "original_position" : 4,
      "original_start_line" : 428,
      "path" : "src/node/blockstorage.cpp",
      "position" : 4,
      "pull_request_review_id" : 854578756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786156317/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 428,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-17T16:55:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786156317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786168209"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786168209"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This access pattern requires that `nFile` stays in sync with `nStatus` - we don't want `nStatus` to be changed concurrently by another thread after we have read it and entered this `if` but before we have read `nFile`. That is to say - `nFile`, `nDataPos` and `nUndoPos` should be protected by the same mechanism as `nStatus`. This is easy:\r\n\r\n\r\n<details>\r\n<summary>suggested change</summary>\r\n\r\n```diff\r\ndiff --git i/src/chain.h w/src/chain.h\r\nindex 2a7e420c31..d8f108b466 100644\r\n--- i/src/chain.h\r\n+++ w/src/chain.h\r\n@@ -161,19 +161,19 @@ public:\r\n     CBlockIndex* pskip{nullptr};\r\n \r\n     //! height of the entry in the chain. The genesis block has height 0\r\n     int nHeight{0};\r\n \r\n     //! Which # file this block is stored in (blk?????.dat)\r\n-    int nFile{0};\r\n+    int nFile GUARDED_BY(::cs_main){0};\r\n \r\n     //! Byte offset within blk?????.dat where this block's data is stored\r\n-    unsigned int nDataPos{0};\r\n+    unsigned int nDataPos GUARDED_BY(::cs_main){0};\r\n \r\n     //! Byte offset within rev?????.dat where this block's undo data is stored\r\n-    unsigned int nUndoPos{0};\r\n+    unsigned int nUndoPos GUARDED_BY(::cs_main){0};\r\n \r\n     //! (memory only) Total amount of work (expected number of hashes) in the chain up to and including this block\r\n     arith_uint256 nChainWork{};\r\n \r\n     //! Number of transactions in this block.\r\n     //! Note: in a potential headers-first mode, this number cannot be relied upon\r\ndiff --git i/src/txdb.cpp w/src/txdb.cpp\r\nindex 3fd5ca5b19..e2aed1da7c 100644\r\n--- i/src/txdb.cpp\r\n+++ w/src/txdb.cpp\r\n@@ -308,23 +308,23 @@ bool CBlockTreeDB::LoadBlockIndexGuts(const Consensus::Params& consensusParams,\r\n             CDiskBlockIndex diskindex;\r\n             if (pcursor->GetValue(diskindex)) {\r\n                 // Construct block index object\r\n                 CBlockIndex* pindexNew = insertBlockIndex(diskindex.GetBlockHash());\r\n                 pindexNew->pprev          = insertBlockIndex(diskindex.hashPrev);\r\n                 pindexNew->nHeight        = diskindex.nHeight;\r\n-                pindexNew->nFile          = diskindex.nFile;\r\n-                pindexNew->nDataPos       = diskindex.nDataPos;\r\n-                pindexNew->nUndoPos       = diskindex.nUndoPos;\r\n                 pindexNew->nVersion       = diskindex.nVersion;\r\n                 pindexNew->hashMerkleRoot = diskindex.hashMerkleRoot;\r\n                 pindexNew->nTime          = diskindex.nTime;\r\n                 pindexNew->nBits          = diskindex.nBits;\r\n                 pindexNew->nNonce         = diskindex.nNonce;\r\n                 pindexNew->nTx            = diskindex.nTx;\r\n                 {\r\n                     LOCK(::cs_main);\r\n+                    pindexNew->nFile = diskindex.nFile;\r\n+                    pindexNew->nDataPos = diskindex.nDataPos;\r\n+                    pindexNew->nUndoPos = diskindex.nUndoPos;\r\n                     pindexNew->nStatus = diskindex.nStatus;\r\n                 }\r\n \r\n                 if (!CheckProofOfWork(pindexNew->GetBlockHash(), pindexNew->nBits, consensusParams)) {\r\n                     return error(\"%s: CheckProofOfWork failed: %s\", __func__, pindexNew->ToString());\r\n                 }\r\n```\r\n</details>\r\n",
      "commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "created_at" : "2022-01-17T16:48:08Z",
      "diff_hunk" : "@@ -223,8 +226,9 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n+        AssertLockHeld(::cs_main);\n         FlatFilePos ret;\n         if (nStatus & BLOCK_HAVE_DATA) {\n             ret.nFile = nFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r786168209",
      "id" : 786168209,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII584u2_mR",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 234,
      "original_position" : 36,
      "original_start_line" : 231,
      "path" : "src/chain.h",
      "position" : 36,
      "pull_request_review_id" : 854578756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786168209/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 231,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-17T16:55:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/786168209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787770788"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787770788"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That is indeed better (thanks!). ACK, tested, done.",
      "commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "created_at" : "2022-01-19T13:58:32Z",
      "diff_hunk" : "@@ -308,20 +313,27 @@ class CBlockIndex\n     bool IsValid(enum BlockStatus nUpTo = BLOCK_VALID_TRANSACTIONS) const\n     {\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\n-        if (nStatus & BLOCK_FAILED_MASK)\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787770788",
      "id" : 787770788,
      "in_reply_to_id" : 786130258,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u9G2k",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 316,
      "original_position" : 53,
      "original_start_line" : 313,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_review_id" : 856829335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787770788/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-19T13:58:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787770788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787771204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787771204"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ACK, tested, done.",
      "commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "created_at" : "2022-01-19T13:59:02Z",
      "diff_hunk" : "@@ -308,20 +313,27 @@ class CBlockIndex\n     bool IsValid(enum BlockStatus nUpTo = BLOCK_VALID_TRANSACTIONS) const\n     {\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\n-        if (nStatus & BLOCK_FAILED_MASK)\n+        LOCK(::cs_main);\n+        if (nStatus & BLOCK_FAILED_MASK) {\n             return false;\n+        }\n         return ((nStatus & BLOCK_VALID_MASK) >= nUpTo);\n     }\n \n     //! @returns true if the block is assumed-valid; this means it is queued to be\n     //!   validated by a background chainstate.\n-    bool IsAssumedValid() const { return nStatus & BLOCK_ASSUMED_VALID; }\n+    bool IsAssumedValid() const\n+    {\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787771204",
      "id" : 787771204,
      "in_reply_to_id" : 786137351,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u9G9E",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 327,
      "original_position" : 65,
      "original_start_line" : 325,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_review_id" : 856829962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787771204/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-19T13:59:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787771204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787771471"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787771471"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "created_at" : "2022-01-19T13:59:17Z",
      "diff_hunk" : "@@ -308,20 +313,27 @@ class CBlockIndex\n     bool IsValid(enum BlockStatus nUpTo = BLOCK_VALID_TRANSACTIONS) const\n     {\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\n-        if (nStatus & BLOCK_FAILED_MASK)\n+        LOCK(::cs_main);\n+        if (nStatus & BLOCK_FAILED_MASK) {\n             return false;\n+        }\n         return ((nStatus & BLOCK_VALID_MASK) >= nUpTo);\n     }\n \n     //! @returns true if the block is assumed-valid; this means it is queued to be\n     //!   validated by a background chainstate.\n-    bool IsAssumedValid() const { return nStatus & BLOCK_ASSUMED_VALID; }\n+    bool IsAssumedValid() const\n+    {\n+        LOCK(::cs_main);\n+        return nStatus & BLOCK_ASSUMED_VALID;\n+    }\n \n     //! Raise the validity level of this block index entry.\n     //! Returns true if the validity was changed.\n     bool RaiseValidity(enum BlockStatus nUpTo)\n     {\n         assert(!(nUpTo & ~BLOCK_VALID_MASK)); // Only validity flags allowed.\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787771471",
      "id" : 787771471,
      "in_reply_to_id" : 786139348,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u9HBP",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 336,
      "original_position" : 74,
      "original_start_line" : 331,
      "path" : "src/chain.h",
      "position" : null,
      "pull_request_review_id" : 856830270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787771471/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-19T13:59:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787771471",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787775210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787775210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I had planned to add lock annotations to `IsBlockPruned()` in a follow-up, but I may as well do it here with the other changes. Done. \r\n\r\nIf this pull is now too large to attract re-ACKs, in that case it could be reverted to its original version with the first 3 commits only, and the `nStatus` preparation and change could be proposed separately. We'll see.",
      "commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "created_at" : "2022-01-19T14:03:19Z",
      "diff_hunk" : "@@ -427,6 +427,7 @@ CBlockIndex* BlockManager::GetLastCheckpoint(const CCheckpointData& data)\n \n bool IsBlockPruned(const CBlockIndex* pblockindex)\n {\n+    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787775210",
      "id" : 787775210,
      "in_reply_to_id" : 786156317,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u9H7q",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 430,
      "original_position" : 4,
      "original_start_line" : 428,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 856835571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787775210/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-19T14:03:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787775210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787775785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787775785"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in the `nStatus` commit (thanks!)",
      "commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "created_at" : "2022-01-19T14:03:59Z",
      "diff_hunk" : "@@ -223,8 +226,9 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n+        AssertLockHeld(::cs_main);\n         FlatFilePos ret;\n         if (nStatus & BLOCK_HAVE_DATA) {\n             ret.nFile = nFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r787775785",
      "id" : 787775785,
      "in_reply_to_id" : 786168209,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII584u9IEp",
      "original_commit_id" : "e9560c6a448b4bcf144b0c6fa81ce59ef29863ee",
      "original_line" : 234,
      "original_position" : 36,
      "original_start_line" : 231,
      "path" : "src/chain.h",
      "position" : 53,
      "pull_request_review_id" : 856836459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787775785/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 231,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-19T14:03:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787775785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed review feedback by @vasild and updated the pull title/description. Invalidates previous ACKs by @hebasto, @achow101 and @vasild.",
      "created_at" : "2022-01-19T14:23:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1016514175",
      "id" : 1016514175,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5848lsZ_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016514175/reactions"
      },
      "updated_at" : "2022-01-19T14:23:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016514175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r789525111"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/789525111"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am just curious - why prefix with `::`? There is no conflict with a local symbol under the same name, so the `::` shouldn't be necessary? Right now in the codebase there are 154 occurrences of `::cs_main` and 421 occurrences of `cs_main` (without the prefix).",
      "commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "created_at" : "2022-01-21T10:08:43Z",
      "diff_hunk" : "@@ -11,6 +11,8 @@\n \n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\n {\n+    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r789525111",
      "id" : 789525111,
      "line" : 14,
      "node_id" : "PRRC_kwDOABII584vDzJ3",
      "original_commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/util/blockfilter.cpp",
      "position" : 4,
      "pull_request_review_id" : 859349838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/789525111/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-21T10:09:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/789525111",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r789527572"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/789527572"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I do prefer to specify the global namespace for the sake being explicit.",
      "commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "created_at" : "2022-01-21T10:12:07Z",
      "diff_hunk" : "@@ -11,6 +11,8 @@\n \n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\n {\n+    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r789527572",
      "id" : 789527572,
      "in_reply_to_id" : 789525111,
      "line" : 14,
      "node_id" : "PRRC_kwDOABII584vDzwU",
      "original_commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/util/blockfilter.cpp",
      "position" : 4,
      "pull_request_review_id" : 859353398,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/789527572/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-21T10:12:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/789527572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r791613383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/791613383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, my understanding from review feedback is that it is preferred for new or updated code.",
      "commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "created_at" : "2022-01-25T11:21:29Z",
      "diff_hunk" : "@@ -11,6 +11,8 @@\n \n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\n {\n+    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r791613383",
      "id" : 791613383,
      "in_reply_to_id" : 789525111,
      "line" : 14,
      "node_id" : "PRRC_kwDOABII584vLw_H",
      "original_commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/util/blockfilter.cpp",
      "position" : 4,
      "pull_request_review_id" : 862142162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/791613383/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-25T11:21:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/791613383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-25T19:36:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1021539224",
      "id" : 1021539224,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII584843OY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021539224/reactions"
      },
      "updated_at" : "2022-01-25T19:36:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021539224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.\r\n\r\nThis has concept ACKs by @MarcoFalke and @promag and ACKs by @hebasto, @achow101 and @vasild.\r\n\r\nReview/re-ACKs welcome.",
      "created_at" : "2022-01-25T20:06:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1021562863",
      "id" : 1021562863,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII584848_v",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021562863/reactions"
      },
      "updated_at" : "2022-01-25T20:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021562863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Benched 6ea56827842b9b2bd730edc38f3a7b1f46f6247b; no performance impact :+1:.\r\n\r\n|          bench name           |                                                                                                     command                                                                                                      |\r\n|-------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\r\n| ibd.local.range.500000.540000 | `bitcoind -dbcache=10000 -debug=coindb -debug=bench -listen=0 -connect=0 -addnode=127.0.0.1:8888 -prune=9999999 -printtoconsole=0 -assumevalid=000000000000000000176c192f42ad13ab159fdb20198b87e7ba3c001e47b876` |\r\n\r\n\r\n### #22932 vs. $mergebase (absolute)\r\n|                  bench name                   |  x  |           #22932           |         $mergebase         |\r\n|-----------------------------------------------|----:|----------------------------|----------------------------|\r\n| ibd.local.range.500000.540000.total_secs      |   2 | 3093.6633 (Â± 17.1804)      | 3102.2931 (Â± 0.4422)       |\r\n| ibd.local.range.500000.540000.peak_rss_KiB    |   2 | 6355854.0000 (Â± 1646.0000) | 6355764.0000 (Â± 1492.0000) |\r\n| ibd.local.range.500000.540000.cpu_kernel_secs |   2 | 263.2300 (Â± 3.3200)        | 264.0900 (Â± 0.1700)        |\r\n| ibd.local.range.500000.540000.cpu_user_secs   |   2 | 13020.2400 (Â± 4.7400)      | 13015.7250 (Â± 8.2850)      |\r\n\r\n\r\n### #22932 vs. $mergebase (relative)\r\n|                  bench name                   |  x  | #22932 | $mergebase |\r\n|-----------------------------------------------|----:|-------:|-----------:|\r\n| ibd.local.range.500000.540000.total_secs      |   2 |  1.000 |      1.003 |\r\n| ibd.local.range.500000.540000.peak_rss_KiB    |   2 |  1.000 |      1.000 |\r\n| ibd.local.range.500000.540000.cpu_kernel_secs |   2 |  1.000 |      1.003 |\r\n| ibd.local.range.500000.540000.cpu_user_secs   |   2 |  1.000 |      1.000 |",
      "created_at" : "2022-01-26T01:50:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1021779492",
      "id" : 1021779492,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII58485x4k",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021779492/reactions"
      },
      "updated_at" : "2022-01-26T01:50:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021779492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "created_at" : "2022-01-27T09:53:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-1023031941",
      "id" : 1023031941,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
      "node_id" : "IC_kwDOABII5848-jqF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023031941/reactions"
      },
      "updated_at" : "2022-01-27T09:53:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023031941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r793554519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793554519"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "For all global variables or just for `cs_main`? Global variables are already supposed to start with `g_`, so prefixing them with `::` is kind of redundant if the purpose is to show to the reader that this is a global variable.",
      "commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "created_at" : "2022-01-27T12:25:24Z",
      "diff_hunk" : "@@ -11,6 +11,8 @@\n \n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\n {\n+    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r793554519",
      "id" : 793554519,
      "in_reply_to_id" : 789525111,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII584vTK5X",
      "original_commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "original_line" : 16,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/util/blockfilter.cpp",
      "position" : 4,
      "pull_request_review_id" : 864796335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793554519/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-27T12:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793554519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794470138"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794470138"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`cs_main` doesn't start with `g_`",
      "commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "created_at" : "2022-01-28T12:40:39Z",
      "diff_hunk" : "@@ -11,6 +11,8 @@\n \n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\n {\n+    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794470138",
      "id" : 794470138,
      "in_reply_to_id" : 789525111,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII584vWqb6",
      "original_commit_id" : "cf2145beb26f0cf3016709b2159bcb4053b58eb9",
      "original_line" : 16,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/util/blockfilter.cpp",
      "position" : 4,
      "pull_request_review_id" : 866092567,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794470138/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-28T12:40:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794470138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794493058"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794493058"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can you explain why this is needed?\r\n\r\n`CDiskBlockIndex` creates a copy of the data and it isn't used in validation or blockstorage code. It is only used to serialize a struct and then discarded.",
      "commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "created_at" : "2022-01-28T13:14:58Z",
      "diff_hunk" : "@@ -382,6 +382,7 @@ class CDiskBlockIndex : public CBlockIndex\n \n     SERIALIZE_METHODS(CDiskBlockIndex, obj)\n     {\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794493058",
      "id" : 794493058,
      "line" : 385,
      "node_id" : "PRRC_kwDOABII584vWwCC",
      "original_commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "original_line" : 385,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 30,
      "pull_request_review_id" : 866125359,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794493058/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-28T13:14:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794493058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794495535"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794495535"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you explain why this is needed? The calling function should already hold cs_main?",
      "commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "created_at" : "2022-01-28T13:18:30Z",
      "diff_hunk" : "@@ -311,19 +311,23 @@ bool CBlockTreeDB::LoadBlockIndexGuts(const Consensus::Params& consensusParams,\n                 CBlockIndex* pindexNew = insertBlockIndex(diskindex.GetBlockHash());\n                 pindexNew->pprev          = insertBlockIndex(diskindex.hashPrev);\n                 pindexNew->nHeight        = diskindex.nHeight;\n-                pindexNew->nFile          = diskindex.nFile;\n-                pindexNew->nDataPos       = diskindex.nDataPos;\n-                pindexNew->nUndoPos       = diskindex.nUndoPos;\n                 pindexNew->nVersion       = diskindex.nVersion;\n                 pindexNew->hashMerkleRoot = diskindex.hashMerkleRoot;\n                 pindexNew->nTime          = diskindex.nTime;\n                 pindexNew->nBits          = diskindex.nBits;\n                 pindexNew->nNonce         = diskindex.nNonce;\n-                pindexNew->nStatus        = diskindex.nStatus;\n                 pindexNew->nTx            = diskindex.nTx;\n+                {\n+                    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794495535",
      "id" : 794495535,
      "line" : 321,
      "node_id" : "PRRC_kwDOABII584vWwov",
      "original_commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "original_line" : 321,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : 15,
      "pull_request_review_id" : 866128895,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794495535/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-28T13:18:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794495535",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794854431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794854431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch--we can drop the lock in favor of an annotation; done in #24197.",
      "commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "created_at" : "2022-01-28T20:03:31Z",
      "diff_hunk" : "@@ -311,19 +311,23 @@ bool CBlockTreeDB::LoadBlockIndexGuts(const Consensus::Params& consensusParams,\n                 CBlockIndex* pindexNew = insertBlockIndex(diskindex.GetBlockHash());\n                 pindexNew->pprev          = insertBlockIndex(diskindex.hashPrev);\n                 pindexNew->nHeight        = diskindex.nHeight;\n-                pindexNew->nFile          = diskindex.nFile;\n-                pindexNew->nDataPos       = diskindex.nDataPos;\n-                pindexNew->nUndoPos       = diskindex.nUndoPos;\n                 pindexNew->nVersion       = diskindex.nVersion;\n                 pindexNew->hashMerkleRoot = diskindex.hashMerkleRoot;\n                 pindexNew->nTime          = diskindex.nTime;\n                 pindexNew->nBits          = diskindex.nBits;\n                 pindexNew->nNonce         = diskindex.nNonce;\n-                pindexNew->nStatus        = diskindex.nStatus;\n                 pindexNew->nTx            = diskindex.nTx;\n+                {\n+                    LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794854431",
      "id" : 794854431,
      "in_reply_to_id" : 794495535,
      "line" : 321,
      "node_id" : "PRRC_kwDOABII584vYIQf",
      "original_commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "original_line" : 321,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : 15,
      "pull_request_review_id" : 866659645,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794854431/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-28T20:03:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794854431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794855567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794855567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Having a look.",
      "commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "created_at" : "2022-01-28T20:05:38Z",
      "diff_hunk" : "@@ -382,6 +382,7 @@ class CDiskBlockIndex : public CBlockIndex\n \n     SERIALIZE_METHODS(CDiskBlockIndex, obj)\n     {\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794855567",
      "id" : 794855567,
      "in_reply_to_id" : 794493058,
      "line" : 385,
      "node_id" : "PRRC_kwDOABII584vYIiP",
      "original_commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "original_line" : 385,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 30,
      "pull_request_review_id" : 866661271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794855567/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-28T20:05:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794855567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794964545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794964545"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> can you explain why this is needed?\r\n> \r\n> `CDiskBlockIndex` creates a copy of the data and it isn't used in validation or blockstorage code. It is only used to serialize a struct and then discarded.\r\n\r\nGood point. Opened #24199 as an approach to address this.",
      "commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "created_at" : "2022-01-29T00:13:16Z",
      "diff_hunk" : "@@ -382,6 +382,7 @@ class CDiskBlockIndex : public CBlockIndex\n \n     SERIALIZE_METHODS(CDiskBlockIndex, obj)\n     {\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r794964545",
      "id" : 794964545,
      "in_reply_to_id" : 794493058,
      "line" : 385,
      "node_id" : "PRRC_kwDOABII584vYjJB",
      "original_commit_id" : "6ea56827842b9b2bd730edc38f3a7b1f46f6247b",
      "original_line" : 385,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 30,
      "pull_request_review_id" : 866809372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794964545/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-29T00:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794964545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
