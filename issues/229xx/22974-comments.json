[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "cc @vasild ",
      "created_at" : "2021-09-14T17:55:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919384556",
      "id" : 919384556,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zLHs",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T17:55:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919384556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Nice code reduction.  Did you see a difference in `./src/bench/bench_bitcoin -filter=AddrManGood`?",
      "created_at" : "2021-09-14T18:31:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919411617",
      "id" : 919411617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zRuh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T18:31:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919411617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708530751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708530751"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in general: clang-format, and where useful consider const, and braced initialization for type safety\r\n```suggestion\r\n        const int bucket{(start_bucket + n) % ADDRMAN_NEW_BUCKET_COUNT};\r\n```",
      "commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "created_at" : "2021-09-14T18:33:43Z",
      "diff_hunk" : "@@ -486,11 +486,14 @@ void CAddrMan::MakeTried(CAddrInfo& info, int nId)\n     AssertLockHeld(cs);\n \n     // remove the entry from all new buckets\n-    for (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; bucket++) {\n+    int start_bucket = info.GetNewBucket(nKey, m_asmap);\n+    for (int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {\n+        int bucket = (start_bucket + n ) % ADDRMAN_NEW_BUCKET_COUNT;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708530751",
      "id" : 708530751,
      "line" : 491,
      "node_id" : "PRRC_kwDOABII584qO1I_",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 491,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 7,
      "pull_request_review_id" : 754295332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-14T18:41:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708530751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708532028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708532028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "prefer prefix iterator where postfix isn't needed (per developer-notes.md)\r\n```suggestion\r\n    for (int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; ++n) {\r\n```",
      "commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "created_at" : "2021-09-14T18:35:32Z",
      "diff_hunk" : "@@ -486,11 +486,14 @@ void CAddrMan::MakeTried(CAddrInfo& info, int nId)\n     AssertLockHeld(cs);\n \n     // remove the entry from all new buckets\n-    for (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; bucket++) {\n+    int start_bucket = info.GetNewBucket(nKey, m_asmap);\n+    for (int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708532028",
      "id" : 708532028,
      "line" : 490,
      "node_id" : "PRRC_kwDOABII584qO1c8",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 490,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 6,
      "pull_request_review_id" : 754295332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-14T18:41:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708532028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708533494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708533494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "while touching this conditional, maybe add the missing brackets we require with conditionals of more than one line (CVE-2014-1266: the Apple \"goto fail\" vulnerability, https://dwheeler.com/essays/apple-goto-fail)\r\n",
      "commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "created_at" : "2021-09-14T18:37:47Z",
      "diff_hunk" : "@@ -562,21 +565,8 @@ void CAddrMan::Good_(const CService& addr, bool test_before_evict, int64_t nTime\n     if (info.fInTried)\n         return;\n \n-    // find a bucket it is in now\n-    int nRnd = insecure_rand.randrange(ADDRMAN_NEW_BUCKET_COUNT);\n-    int nUBucket = -1;\n-    for (unsigned int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {\n-        int nB = (n + nRnd) % ADDRMAN_NEW_BUCKET_COUNT;\n-        int nBpos = info.GetBucketPosition(nKey, true, nB);\n-        if (vvNew[nB][nBpos] == nId) {\n-            nUBucket = nB;\n-            break;\n-        }\n-    }\n-\n-    // if no bucket is found, something bad happened;\n-    // TODO: maybe re-add the node, but for now, just bail out\n-    if (nUBucket == -1)\n+    // if it is not in new, something bad happened\n+    if (info.nRefCount == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708533494",
      "id" : 708533494,
      "line" : 569,
      "node_id" : "PRRC_kwDOABII584qO1z2",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 569,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 36,
      "pull_request_review_id" : 754295332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-14T18:41:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708533494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22950](https://github.com/bitcoin/bitcoin/pull/22950) ([p2p] Pimpl AddrMan to abstract implementation details by amitiuttarwar)\n* [#22910](https://github.com/bitcoin/bitcoin/pull/22910) ([RFC] Encapsulate asmap in NetGroupManager by jnewbery)\n* [#22734](https://github.com/bitcoin/bitcoin/pull/22734) (addrman: Avoid crash on corrupt data, Force Check after deserialize by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-09-14T18:40:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919417960",
      "id" : 919417960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zTRo",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-15T22:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919417960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Benches are showing a huge speedup for me locally.\r\n\r\nbefore\r\n```\r\n$ ./src/bench/bench_bitcoin -filter=AddrManGood\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      801,906,990.00 |                1.25 |    5.7% |      4.26 | AddrManGood\r\n|      814,159,543.00 |                1.23 |    6.4% |      4.03 | AddrManGood\r\n|      775,065,136.00 |                1.29 |    3.5% |      3.82 | AddrManGood\r\n|      795,855,140.00 |                1.26 |    6.8% |      3.98 | AddrManGood\r\n|      763,767,446.00 |                1.31 |    1.7% |      3.93 | AddrManGood\r\n|      778,016,971.00 |                1.29 |    2.9% |      4.03 | AddrManGood\r\n|      839,720,704.00 |                1.19 |    8.6% |      4.22 | AddrManGood\r\n|      777,639,920.00 |                1.29 |    1.8% |      3.92 | AddrManGood\r\n|      788,152,208.00 |                1.27 |    3.8% |      3.89 | AddrManGood\r\n|      792,925,660.00 |                1.26 |    3.2% |      3.99 | AddrManGood\r\n```\r\n\r\nafter\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        5,182,474.00 |              192.96 |   13.8% |      0.03 | AddrManGood\r\n|        5,525,509.00 |              180.98 |   14.6% |      0.03 | AddrManGood\r\n|        7,215,235.00 |              138.60 |    3.7% |      0.04 | AddrManGood\r\n|        5,219,675.00 |              191.58 |    7.5% |      0.03 | AddrManGood\r\n|        4,163,823.00 |              240.16 |    2.3% |      0.02 | AddrManGood\r\n|        6,694,095.00 |              149.39 |   23.0% |      0.05 | AddrManGood\r\n|        5,966,011.00 |              167.62 |   11.0% |      0.03 | AddrManGood\r\n|        4,861,261.00 |              205.71 |    3.6% |      0.03 | AddrManGood\r\n|        5,029,188.00 |              198.84 |   16.4% |      0.03 | AddrManGood\r\n|        5,440,878.00 |              183.79 |   13.1% |      0.03 | AddrManGood\r\n```\r\n",
      "created_at" : "2021-09-14T19:04:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919435266",
      "id" : 919435266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zXgC",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T19:04:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919435266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks! I didn't know about this benchmark, will try to confirm locally and add the result to OP!",
      "created_at" : "2021-09-14T19:09:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919438590",
      "id" : 919438590,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zYT-",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T19:09:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919438590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "approach ACK, planning to do a more in-depth review later this week",
      "created_at" : "2021-09-14T22:32:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919558678",
      "id" : 919558678,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842z1oW",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T22:33:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919558678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708908831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708908831"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I presume this shouldn't happen after the sanity checks passed on a deserialized addrman. So, on \"bad things\" that are caused by internal logic flaws, it might be better to crash in debug/test builds. Otherwise this will be harder to notice or only noticed later on.\r\n\r\n\r\n```suggestion\r\n    if (!Assume(info.nRefCount > 0)) {\r\n```",
      "commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "created_at" : "2021-09-15T07:21:13Z",
      "diff_hunk" : "@@ -562,21 +565,8 @@ void CAddrMan::Good_(const CService& addr, bool test_before_evict, int64_t nTime\n     if (info.fInTried)\n         return;\n \n-    // find a bucket it is in now\n-    int nRnd = insecure_rand.randrange(ADDRMAN_NEW_BUCKET_COUNT);\n-    int nUBucket = -1;\n-    for (unsigned int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {\n-        int nB = (n + nRnd) % ADDRMAN_NEW_BUCKET_COUNT;\n-        int nBpos = info.GetBucketPosition(nKey, true, nB);\n-        if (vvNew[nB][nBpos] == nId) {\n-            nUBucket = nB;\n-            break;\n-        }\n-    }\n-\n-    // if no bucket is found, something bad happened;\n-    // TODO: maybe re-add the node, but for now, just bail out\n-    if (nUBucket == -1)\n+    // if it is not in new, something bad happened\n+    if (info.nRefCount == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708908831",
      "id" : 708908831,
      "line" : 569,
      "node_id" : "PRRC_kwDOABII584qQRcf",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 569,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 36,
      "pull_request_review_id" : 754752075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T07:21:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708908831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\nCode also looks good, but I'm gonna ACK once you resolve all the pending suggestions from other reviewers. I agree with those suggestions.",
      "created_at" : "2021-09-15T10:08:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919883958",
      "id" : 919883958,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII58421FC2",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-15T10:08:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919883958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709044009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709044009"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Completely unrelated, but I was wondering if it makes sense to fuzz the time here",
      "commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "created_at" : "2021-09-15T10:13:42Z",
      "diff_hunk" : "@@ -96,31 +96,12 @@ class CAddrManDeterministic : public CAddrMan\n             for (size_t j = 0; j < num_addresses; ++j) {\n                 const auto addr = CAddress{CService{RandAddr(), 8333}, NODE_NETWORK};\n                 const auto time_penalty = insecure_rand.randrange(100000001);\n-#if 1\n-                // 2.83 sec to fill.\n-                if (n > 0 && mapInfo.size() % n == 0 && mapAddr.find(addr) == mapAddr.end()) {\n-                    // Add to the \"tried\" table (if the bucket slot is free).\n-                    const CAddrInfo dummy{addr, source};\n-                    const int bucket = dummy.GetTriedBucket(nKey, m_asmap);\n-                    const int bucket_pos = dummy.GetBucketPosition(nKey, false, bucket);\n-                    if (vvTried[bucket][bucket_pos] == -1) {\n-                        int id;\n-                        CAddrInfo* addr_info = Create(addr, source, &id);\n-                        vvTried[bucket][bucket_pos] = id;\n-                        addr_info->fInTried = true;\n-                        ++nTried;\n-                    }\n-                } else {\n-                    // Add to the \"new\" table.\n-                    Add_(addr, source, time_penalty);\n-                }\n-#else\n-                // 261.91 sec to fill.\n                 Add_(addr, source, time_penalty);\n+\n                 if (n > 0 && mapInfo.size() % n == 0) {\n                     Good_(addr, false, GetTime());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709044009",
      "id" : 709044009,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII584qQycp",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 102,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : 27,
      "pull_request_review_id" : 754928960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T10:13:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709044009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709615117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709615117"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done for all variables in this loop.",
      "commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-15T22:21:26Z",
      "diff_hunk" : "@@ -486,11 +486,14 @@ void CAddrMan::MakeTried(CAddrInfo& info, int nId)\n     AssertLockHeld(cs);\n \n     // remove the entry from all new buckets\n-    for (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; bucket++) {\n+    int start_bucket = info.GetNewBucket(nKey, m_asmap);\n+    for (int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {\n+        int bucket = (start_bucket + n ) % ADDRMAN_NEW_BUCKET_COUNT;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709615117",
      "id" : 709615117,
      "in_reply_to_id" : 708530751,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qS94N",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 491,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : null,
      "pull_request_review_id" : 755671930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T22:21:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709615117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709615407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709615407"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-15T22:22:04Z",
      "diff_hunk" : "@@ -486,11 +486,14 @@ void CAddrMan::MakeTried(CAddrInfo& info, int nId)\n     AssertLockHeld(cs);\n \n     // remove the entry from all new buckets\n-    for (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; bucket++) {\n+    int start_bucket = info.GetNewBucket(nKey, m_asmap);\n+    for (int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709615407",
      "id" : 709615407,
      "in_reply_to_id" : 708532028,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qS98v",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 490,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : null,
      "pull_request_review_id" : 755672262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T22:22:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709615407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709615771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709615771"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "added brackets here, thanks",
      "commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-15T22:22:48Z",
      "diff_hunk" : "@@ -562,21 +565,8 @@ void CAddrMan::Good_(const CService& addr, bool test_before_evict, int64_t nTime\n     if (info.fInTried)\n         return;\n \n-    // find a bucket it is in now\n-    int nRnd = insecure_rand.randrange(ADDRMAN_NEW_BUCKET_COUNT);\n-    int nUBucket = -1;\n-    for (unsigned int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {\n-        int nB = (n + nRnd) % ADDRMAN_NEW_BUCKET_COUNT;\n-        int nBpos = info.GetBucketPosition(nKey, true, nB);\n-        if (vvNew[nB][nBpos] == nId) {\n-            nUBucket = nB;\n-            break;\n-        }\n-    }\n-\n-    // if no bucket is found, something bad happened;\n-    // TODO: maybe re-add the node, but for now, just bail out\n-    if (nUBucket == -1)\n+    // if it is not in new, something bad happened\n+    if (info.nRefCount == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709615771",
      "id" : 709615771,
      "in_reply_to_id" : 708533494,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qS-Cb",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 569,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : null,
      "pull_request_review_id" : 755672625,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T22:22:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709615771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709616011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709616011"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done as suggested",
      "commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-15T22:23:24Z",
      "diff_hunk" : "@@ -562,21 +565,8 @@ void CAddrMan::Good_(const CService& addr, bool test_before_evict, int64_t nTime\n     if (info.fInTried)\n         return;\n \n-    // find a bucket it is in now\n-    int nRnd = insecure_rand.randrange(ADDRMAN_NEW_BUCKET_COUNT);\n-    int nUBucket = -1;\n-    for (unsigned int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {\n-        int nB = (n + nRnd) % ADDRMAN_NEW_BUCKET_COUNT;\n-        int nBpos = info.GetBucketPosition(nKey, true, nB);\n-        if (vvNew[nB][nBpos] == nId) {\n-            nUBucket = nB;\n-            break;\n-        }\n-    }\n-\n-    // if no bucket is found, something bad happened;\n-    // TODO: maybe re-add the node, but for now, just bail out\n-    if (nUBucket == -1)\n+    // if it is not in new, something bad happened\n+    if (info.nRefCount == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709616011",
      "id" : 709616011,
      "in_reply_to_id" : 708908831,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qS-GL",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 569,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : null,
      "pull_request_review_id" : 755672915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T22:23:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709616011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709616562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709616562"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The comment before this block warns against fuzzing in this loop, some problem with running out of random numbers. Could use `insecure_rand` though?",
      "commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-15T22:24:51Z",
      "diff_hunk" : "@@ -96,31 +96,12 @@ class CAddrManDeterministic : public CAddrMan\n             for (size_t j = 0; j < num_addresses; ++j) {\n                 const auto addr = CAddress{CService{RandAddr(), 8333}, NODE_NETWORK};\n                 const auto time_penalty = insecure_rand.randrange(100000001);\n-#if 1\n-                // 2.83 sec to fill.\n-                if (n > 0 && mapInfo.size() % n == 0 && mapAddr.find(addr) == mapAddr.end()) {\n-                    // Add to the \"tried\" table (if the bucket slot is free).\n-                    const CAddrInfo dummy{addr, source};\n-                    const int bucket = dummy.GetTriedBucket(nKey, m_asmap);\n-                    const int bucket_pos = dummy.GetBucketPosition(nKey, false, bucket);\n-                    if (vvTried[bucket][bucket_pos] == -1) {\n-                        int id;\n-                        CAddrInfo* addr_info = Create(addr, source, &id);\n-                        vvTried[bucket][bucket_pos] = id;\n-                        addr_info->fInTried = true;\n-                        ++nTried;\n-                    }\n-                } else {\n-                    // Add to the \"new\" table.\n-                    Add_(addr, source, time_penalty);\n-                }\n-#else\n-                // 261.91 sec to fill.\n                 Add_(addr, source, time_penalty);\n+\n                 if (n > 0 && mapInfo.size() % n == 0) {\n                     Good_(addr, false, GetTime());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r709616562",
      "id" : 709616562,
      "in_reply_to_id" : 709044009,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII584qS-Oy",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 102,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : 36,
      "pull_request_review_id" : 755673624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T22:24:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709616562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the reviews - I addressed all comments.\r\nI added a commit to allow for a lower number of sources in the fuzz test as suggested by @MarcoFalke .\r\n\r\nI also ran the benchmark and got similar results to @jonatack:\r\n\r\n`./src/bench/bench_bitcoin -filter=AddrManGood`\r\nbefore:\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      840,411,590.00 |                1.19 |    3.3% |      4.23 | `AddrManGood`\r\n|      871,339,127.00 |                1.15 |    0.1% |      4.35 | `AddrManGood`\r\n|      880,275,738.00 |                1.14 |    0.8% |      4.45 | `AddrManGood`\r\n|      874,042,056.00 |                1.14 |    1.7% |      4.34 | `AddrManGood`\r\n|      877,817,450.00 |                1.14 |    2.1% |      4.34 | `AddrManGood`\r\n```\r\nafter\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        4,889,438.00 |              204.52 |    0.7% |      0.02 | `AddrManGood`\r\n|        4,831,691.00 |              206.97 |    1.5% |      0.02 | `AddrManGood`\r\n|        4,847,879.00 |              206.28 |    1.0% |      0.02 | `AddrManGood`\r\n|        4,745,268.00 |              210.74 |    0.8% |      0.02 | `AddrManGood`\r\n|        4,932,979.00 |              202.72 |    1.3% |      0.02 | `AddrManGood`\r\n```",
      "created_at" : "2021-09-15T22:54:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-920445700",
      "id" : 920445700,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII58423OME",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-15T22:54:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/920445700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-16T08:33:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-920702275",
      "id" : 920702275,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII58424M1D",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T08:33:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/920702275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 57ce20307e\r\n\r\nUsing the public interface to fuzz addrman is a much better approach. As well as being fewer lines of code, the fuzz test is more correct now. The previous code reached into the internals and made changes to private data which invalidated addrman's invariants. For example, entries were placed into the tried table without setting `nLastSuccess`, which would cause `check()` to fail:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/87780dfee8c82ea09b84e74d331db2ad6f9e75ab/src/addrman.cpp#L774-L775\r\n\r\nI think the next step is to move `RandAddr()` and `Fill()` out of `CAddrManDeterministic` so that they don't have access to `CAddrMan`'s private data and methods.",
      "created_at" : "2021-09-16T10:08:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-920767718",
      "id" : 920767718,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII58424czm",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T10:08:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/920767718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r711119626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711119626"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just above, on line 83 (github does not let me comment on it) is a comment:\r\n```cpp\r\n// Add some of the addresses directly to the \"tried\" table.\r\n```\r\nI think the word \"directly\" does not apply anymore since the hackish direct addition is replaced by `Add_()` (goes to \"new\") + `Good_()` (moved to \"tried\").",
      "commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-17T14:44:25Z",
      "diff_hunk" : "@@ -85,7 +85,7 @@ class CAddrManDeterministic : public CAddrMan\n         // 0, 1, 2, 3 corresponding to 0%, 100%, 50%, 33%",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r711119626",
      "id" : 711119626,
      "line" : 85,
      "node_id" : "PRRC_kwDOABII584qYtMK",
      "original_commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "original_line" : 85,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : 1,
      "pull_request_review_id" : 757549239,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-17T15:01:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711119626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r711133474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711133474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I compared this branch with the `#else` branch, filled addrman with 9k addresses and did not observe any difference in performance. That is - now the high level `Add_()` + `Good_()` perform the same way as the hackish direct add to the tried table :racehorse:.",
      "commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-17T15:01:11Z",
      "diff_hunk" : "@@ -96,31 +96,12 @@ class CAddrManDeterministic : public CAddrMan\n             for (size_t j = 0; j < num_addresses; ++j) {\n                 const auto addr = CAddress{CService{RandAddr(), 8333}, NODE_NETWORK};\n                 const auto time_penalty = insecure_rand.randrange(100000001);\n-#if 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r711133474",
      "id" : 711133474,
      "line" : 99,
      "node_id" : "PRRC_kwDOABII584qYwki",
      "original_commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "original_line" : 99,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : 13,
      "pull_request_review_id" : 757549239,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-17T15:01:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711133474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is fantastic, faster *and* less code.\r\nCode review ACK 57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-20T17:44:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-923140946",
      "id" : 923140946,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5843BgNS",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-20T17:44:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/923140946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Notice that it is adding entries with addr != source, so that lucky `start_bucket` is not playing a role in the benchmark, I guess.\r\n\r\nI think it does: The first `Add()` call creates a `CAddrInfo`  entry in `mapInfo` and set `CAddrInfo.source` to the source, no matter if `addr==source` or not. Then `GetNewBucket(uint256, const std::vector<bool>)` which is now called from `MakeTried` uses just that to determine the starting bucket.\r\n\r\n> In commit [acf656d](https://github.com/bitcoin/bitcoin/commit/acf656d540a82e6fc30421590305cfe295eabbb5) `fuzz: Use public interface to fill addrman tried tables`, `Add_()` and `Good_()` are not public interface, they are private methods.\r\n\r\nThat's true - thinking about doing a (fuzz-only) refactoring follow-up, in which this could be switched to `Add()` and `Good()`.\r\n",
      "created_at" : "2021-09-20T18:26:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-923172221",
      "id" : 923172221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5843Bn19",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-20T18:26:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/923172221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r712412186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712412186"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, will fix this in a follow-up!",
      "commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "created_at" : "2021-09-20T18:26:58Z",
      "diff_hunk" : "@@ -85,7 +85,7 @@ class CAddrManDeterministic : public CAddrMan\n         // 0, 1, 2, 3 corresponding to 0%, 100%, 50%, 33%",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r712412186",
      "id" : 712412186,
      "in_reply_to_id" : 711119626,
      "line" : 85,
      "node_id" : "PRRC_kwDOABII584qdowa",
      "original_commit_id" : "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "original_line" : 85,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : 1,
      "pull_request_review_id" : 758963815,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T18:26:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712412186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
