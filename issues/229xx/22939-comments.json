[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. \r\n\r\nI'd understand if it's beyond the scope of this PR, but I think that a second `ForceCheckAddrman()`  at the end of the  `addrman` fuzz target (which isn't caught but can actually lead to crashes) would be really helpful - probably better than activating  `consistency_check_ratio` during fuzzing which could make the fuzzer slow if called in too many steps.",
      "created_at" : "2021-09-10T19:15:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22939#issuecomment-917149441",
      "id" : 917149441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22939",
      "node_id" : "IC_kwDOABII5842qpcB",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T19:15:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917149441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22872](https://github.com/bitcoin/bitcoin/pull/22872) (log: improve checkaddrman logging with duration in milliseconds by jonatack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-09-11T02:43:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22939#issuecomment-917324206",
      "id" : 917324206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22939",
      "node_id" : "IC_kwDOABII5842rUGu",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-11T02:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917324206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> a second ForceCheckAddrman() at the end of the addrman fuzz target\r\n\r\nGood idea. Wanted to do it in a follow-up, but it is just a one-line fix, so I added the commit here.",
      "created_at" : "2021-09-11T07:07:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22939#issuecomment-917356366",
      "id" : 917356366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22939",
      "node_id" : "IC_kwDOABII5842rb9O",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-11T07:07:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917356366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708162942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708162942"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    //! Consistency check, taking into account m_consistency_check_ratio. Will abort(2) if an inconsistency is detected.\r\n```",
      "commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "created_at" : "2021-09-14T11:12:28Z",
      "diff_hunk" : "@@ -391,20 +391,11 @@ class CAddrMan\n     //! Return a random to-be-evicted tried table address.\n     CAddrInfo SelectTriedCollision_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    //! Consistency check\n-    void Check() const EXCLUSIVE_LOCKS_REQUIRED(cs)\n-    {\n-        AssertLockHeld(cs);\n-\n-        const int err = Check_();\n-        if (err) {\n-            LogPrintf(\"ADDRMAN CONSISTENCY CHECK FAILED!!! err=%i\\n\", err);\n-            assert(false);\n-        }\n-    }\n+    //! Consistency check, taking into account m_consistency_check_ratio.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708162942",
      "id" : 708162942,
      "line" : 394,
      "node_id" : "PRRC_kwDOABII584qNbV-",
      "original_commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "original_line" : 394,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 15,
      "pull_request_review_id" : 753800888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-14T11:19:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708162942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708164692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708164692"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    //! Perform consistency check, regardless of `m_consistency_check_ratio`.\r\n    //! @returns an error code or zero.\r\n```",
      "commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "created_at" : "2021-09-14T11:15:18Z",
      "diff_hunk" : "@@ -391,20 +391,11 @@ class CAddrMan\n     //! Return a random to-be-evicted tried table address.\n     CAddrInfo SelectTriedCollision_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    //! Consistency check\n-    void Check() const EXCLUSIVE_LOCKS_REQUIRED(cs)\n-    {\n-        AssertLockHeld(cs);\n-\n-        const int err = Check_();\n-        if (err) {\n-            LogPrintf(\"ADDRMAN CONSISTENCY CHECK FAILED!!! err=%i\\n\", err);\n-            assert(false);\n-        }\n-    }\n+    //! Consistency check, taking into account m_consistency_check_ratio.\n+    void Check() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    //! Perform consistency check. Returns an error code or zero.\n-    int Check_() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+    //! Perform consistency check, regardless of m_consistency_check_ratio. Returns an error code or zero.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708164692",
      "id" : 708164692,
      "line" : 397,
      "node_id" : "PRRC_kwDOABII584qNbxU",
      "original_commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "original_line" : 397,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 20,
      "pull_request_review_id" : 753800888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-14T11:19:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708164692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708167539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708167539"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What about moving this unconditional check inside, at the end of `CAddrMan::Unserialize()`? We never want to continue if this check fails after unserialize and it is not too expensive to check once per unserialize.\r\n\r\nRight now we have the conditional `Check()` at the end of `Unserialize()`.",
      "commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "created_at" : "2021-09-14T11:19:39Z",
      "diff_hunk" : "@@ -238,6 +241,9 @@ FUZZ_TARGET_INIT(addrman, initialize_addrman)\n         ds.SetVersion(ser_version);\n         try {\n             ds >> *addr_man_ptr;\n+            if (0 != WITH_LOCK(addr_man_ptr->cs, return addr_man_ptr->ForceCheckAddrman())) {\n+                throw std::ios_base::failure{\"Reset addrman after consistency check failed\"};\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708167539",
      "id" : 708167539,
      "line" : 246,
      "node_id" : "PRRC_kwDOABII584qNcdz",
      "original_commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "original_line" : 246,
      "original_position" : 16,
      "original_start_line" : 243,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : 16,
      "pull_request_review_id" : 753800888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939",
      "side" : "RIGHT",
      "start_line" : 243,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-14T11:19:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708167539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708169942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708169942"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is what #22734 is doing. Happy to close this fuzz-only pull and rebase the other.",
      "commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "created_at" : "2021-09-14T11:23:18Z",
      "diff_hunk" : "@@ -238,6 +241,9 @@ FUZZ_TARGET_INIT(addrman, initialize_addrman)\n         ds.SetVersion(ser_version);\n         try {\n             ds >> *addr_man_ptr;\n+            if (0 != WITH_LOCK(addr_man_ptr->cs, return addr_man_ptr->ForceCheckAddrman())) {\n+                throw std::ios_base::failure{\"Reset addrman after consistency check failed\"};\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708169942",
      "id" : 708169942,
      "in_reply_to_id" : 708167539,
      "line" : 246,
      "node_id" : "PRRC_kwDOABII584qNdDW",
      "original_commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "original_line" : 246,
      "original_position" : 16,
      "original_start_line" : 243,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : 16,
      "pull_request_review_id" : 753810524,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939",
      "side" : "RIGHT",
      "start_line" : 243,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-14T11:23:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708169942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708943418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708943418"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Up to you (and other reviewers). I \"voted\" for the other PR :)",
      "commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "created_at" : "2021-09-15T08:08:00Z",
      "diff_hunk" : "@@ -238,6 +241,9 @@ FUZZ_TARGET_INIT(addrman, initialize_addrman)\n         ds.SetVersion(ser_version);\n         try {\n             ds >> *addr_man_ptr;\n+            if (0 != WITH_LOCK(addr_man_ptr->cs, return addr_man_ptr->ForceCheckAddrman())) {\n+                throw std::ios_base::failure{\"Reset addrman after consistency check failed\"};\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22939#discussion_r708943418",
      "id" : 708943418,
      "in_reply_to_id" : 708167539,
      "line" : 246,
      "node_id" : "PRRC_kwDOABII584qQZ46",
      "original_commit_id" : "faf9bd337460ecc9ecd31126bab85fff12616728",
      "original_line" : 246,
      "original_position" : 16,
      "original_start_line" : 243,
      "path" : "src/test/fuzz/addrman.cpp",
      "position" : 16,
      "pull_request_review_id" : 754797539,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22939",
      "side" : "RIGHT",
      "start_line" : 243,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-15T08:08:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708943418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
