[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23647](https://github.com/bitcoin/bitcoin/pull/23647) (Split rpcwallet into multiple smaller parts by meshcollider)\n* [#23019](https://github.com/bitcoin/bitcoin/pull/23019) (rpc, wallet: Add listaddresses RPC by lsilva01)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-09-09T12:48:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-916060454",
      "id" : 916060454,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5842mfkm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916060454/reactions"
      },
      "updated_at" : "2021-12-02T15:50:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916060454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710464748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710464748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In fec5ded232ca37b8a965ce09a3940ccb6ce43249 \"Return used destinations from ScriptPubKeyMan::MarkUnusedAddresses\"\r\n\r\ntypo: makr - > mark\r\n\r\n```suggestion\r\n     * @param keypool_id determines the last key to mark as used\r\n```",
      "commit_id" : "aa7e4381ac838be7422112b41ff38b30b685454f",
      "created_at" : "2021-09-16T20:45:34Z",
      "diff_hunk" : "@@ -481,9 +493,13 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     void LearnAllRelatedScripts(const CPubKey& key);\n \n     /**\n-     * Marks all keys in the keypool up to and including reserve_key as used.\n+     * Marks all keys in the keypool up to and including the provided key as used.\n+     *\n+     * @param keypool_id determines the last key to makr as used",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710464748",
      "id" : 710464748,
      "line" : 498,
      "node_id" : "PRRC_kwDOABII584qWNTs",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 498,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 46,
      "pull_request_review_id" : 756785367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T20:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710464748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710466168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710466168"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In fec5ded232ca37b8a965ce09a3940ccb6ce43249 \"Return used destinations from ScriptPubKeyMan::MarkUnusedAddresses\"\r\n\r\nnit: space before `:`\r\n\r\n```suggestion\r\n                for (const auto& type : LEGACY_OUTPUT_TYPES) {\r\n```",
      "commit_id" : "aa7e4381ac838be7422112b41ff38b30b685454f",
      "created_at" : "2021-09-16T20:47:04Z",
      "diff_hunk" : "@@ -354,15 +354,22 @@ bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t i\n     return true;\n }\n \n-void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_KeyStore);\n+    std::vector<WalletDestination> result;\n     // extract addresses and check if they match with an unused keypool key\n     for (const auto& keyid : GetAffectedKeys(script, *this)) {\n         std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n         if (mi != m_pool_key_to_index.end()) {\n             WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool keys up to this key as used\\n\", __func__);\n-            MarkReserveKeysAsUsed(mi->second);\n+            for (const auto& keypool : MarkReserveKeysAsUsed(mi->second)) {\n+                // derive all possible destinations as any of them could have been used\n+                for (const auto& type: LEGACY_OUTPUT_TYPES) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710466168",
      "id" : 710466168,
      "line" : 368,
      "node_id" : "PRRC_kwDOABII584qWNp4",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 368,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 17,
      "pull_request_review_id" : 756785367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T20:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710466168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710472000"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710472000"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In cbb90fbc00e345100587cd47926c6c7fc5487628 \"Automatically add labels to detected receiving addresses\"\r\n\r\nShouldn't we be marking everything that doesn't have `dest.internal` as a receiving address? i.e.\r\n\r\n```suggestion\r\n                   if (!dest.internal.value_or(false) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {\r\n```",
      "commit_id" : "aa7e4381ac838be7422112b41ff38b30b685454f",
      "created_at" : "2021-09-16T20:53:24Z",
      "diff_hunk" : "@@ -1059,7 +1059,19 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n             for (const CTxOut& txout: tx.vout) {\n                 const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);\n                 if (!spk_man) continue;\n-                spk_man->MarkUnusedAddresses(txout.scriptPubKey);\n+                for (auto& dest : spk_man->MarkUnusedAddresses(txout.scriptPubKey)) {\n+                    // If internal flag is not defined try to infer it from the ScriptPubKeyMan\n+                    if (!dest.internal.has_value()) {\n+                        dest.internal = IsInternalScriptPubKeyMan(spk_man);\n+                    }\n+\n+                    // If this is a receiving address and it's not in the address book yet\n+                    // (e.g. it wasn't generated on this node or we're restoring from backup)\n+                    // add it to the address book for proper transaction accounting\n+                    if (!dest.internal.value_or(true) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710472000",
      "id" : 710472000,
      "line" : 1073,
      "node_id" : "PRRC_kwDOABII584qWPFA",
      "original_commit_id" : "cbb90fbc00e345100587cd47926c6c7fc5487628",
      "original_line" : 1071,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 28,
      "pull_request_review_id" : 756785367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T20:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710472000",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910861"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "c97c2a99bf5aed073cc28967c5d47a33ec618752",
      "created_at" : "2021-09-20T06:48:02Z",
      "diff_hunk" : "@@ -481,9 +493,13 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     void LearnAllRelatedScripts(const CPubKey& key);\n \n     /**\n-     * Marks all keys in the keypool up to and including reserve_key as used.\n+     * Marks all keys in the keypool up to and including the provided key as used.\n+     *\n+     * @param keypool_id determines the last key to makr as used",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910861",
      "id" : 711910861,
      "in_reply_to_id" : 710464748,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qbuXN",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 498,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 758292045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T06:48:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910903"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "c97c2a99bf5aed073cc28967c5d47a33ec618752",
      "created_at" : "2021-09-20T06:48:09Z",
      "diff_hunk" : "@@ -354,15 +354,22 @@ bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t i\n     return true;\n }\n \n-void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_KeyStore);\n+    std::vector<WalletDestination> result;\n     // extract addresses and check if they match with an unused keypool key\n     for (const auto& keyid : GetAffectedKeys(script, *this)) {\n         std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n         if (mi != m_pool_key_to_index.end()) {\n             WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool keys up to this key as used\\n\", __func__);\n-            MarkReserveKeysAsUsed(mi->second);\n+            for (const auto& keypool : MarkReserveKeysAsUsed(mi->second)) {\n+                // derive all possible destinations as any of them could have been used\n+                for (const auto& type: LEGACY_OUTPUT_TYPES) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910903",
      "id" : 711910903,
      "in_reply_to_id" : 710466168,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qbuX3",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 368,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 758292090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T06:48:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711911667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711911667"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I want to be conservative and skip if we can't determine if that's a change or a receiving destination. But the code is not obvious and I restructured it to make it explicit.",
      "commit_id" : "c97c2a99bf5aed073cc28967c5d47a33ec618752",
      "created_at" : "2021-09-20T06:49:46Z",
      "diff_hunk" : "@@ -1059,7 +1059,19 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n             for (const CTxOut& txout: tx.vout) {\n                 const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);\n                 if (!spk_man) continue;\n-                spk_man->MarkUnusedAddresses(txout.scriptPubKey);\n+                for (auto& dest : spk_man->MarkUnusedAddresses(txout.scriptPubKey)) {\n+                    // If internal flag is not defined try to infer it from the ScriptPubKeyMan\n+                    if (!dest.internal.has_value()) {\n+                        dest.internal = IsInternalScriptPubKeyMan(spk_man);\n+                    }\n+\n+                    // If this is a receiving address and it's not in the address book yet\n+                    // (e.g. it wasn't generated on this node or we're restoring from backup)\n+                    // add it to the address book for proper transaction accounting\n+                    if (!dest.internal.value_or(true) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711911667",
      "id" : 711911667,
      "in_reply_to_id" : 710472000,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qbujz",
      "original_commit_id" : "cbb90fbc00e345100587cd47926c6c7fc5487628",
      "original_line" : 1071,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 758292996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T06:49:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711911667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK c97c2a99bf5aed073cc28967c5d47a33ec618752",
      "created_at" : "2021-09-24T20:23:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-926898556",
      "id" : 926898556,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5843P1l8",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-24T20:23:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926898556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719146825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719146825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@achow101 I believe expanding from cache is enough here. But want to confirm.",
      "commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "created_at" : "2021-09-30T07:48:44Z",
      "diff_hunk" : "@@ -1820,19 +1833,32 @@ bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n     return true;\n }\n \n-void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_desc_man);\n+    std::vector<WalletDestination> result;\n     if (IsMine(script)) {\n         int32_t index = m_map_script_pub_keys[script];\n         if (index >= m_wallet_descriptor.next_index) {\n             WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n-            m_wallet_descriptor.next_index = index + 1;\n+            auto out_keys = std::make_unique<FlatSigningProvider>();\n+            std::vector<CScript> scripts_temp;\n+            while (index >= m_wallet_descriptor.next_index) {\n+                if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719146825",
      "id" : 719146825,
      "line" : 1847,
      "node_id" : "PRRC_kwDOABII584q3U9J",
      "original_commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "original_line" : 1847,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 79,
      "pull_request_review_id" : 767510226,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T07:48:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719146825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719149474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719149474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@achow101 I think it's technically possible to have two descriptors producing same scriptPubKey. Wdyt?",
      "commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "created_at" : "2021-09-30T07:51:55Z",
      "diff_hunk" : "@@ -1062,8 +1064,23 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n \n             // loop though all outputs\n             for (const CTxOut& txout: tx.vout) {\n-                for (const auto& spk_man_pair : m_spk_managers) {\n-                    spk_man_pair.second->MarkUnusedAddresses(txout.scriptPubKey);\n+                const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719149474",
      "id" : 719149474,
      "line" : 1067,
      "node_id" : "PRRC_kwDOABII584q3Vmi",
      "original_commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "original_line" : 1067,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 17,
      "pull_request_review_id" : 767513414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T07:51:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719149474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719639229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719639229"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, that is.",
      "commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "created_at" : "2021-09-30T18:00:24Z",
      "diff_hunk" : "@@ -1820,19 +1833,32 @@ bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n     return true;\n }\n \n-void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_desc_man);\n+    std::vector<WalletDestination> result;\n     if (IsMine(script)) {\n         int32_t index = m_map_script_pub_keys[script];\n         if (index >= m_wallet_descriptor.next_index) {\n             WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n-            m_wallet_descriptor.next_index = index + 1;\n+            auto out_keys = std::make_unique<FlatSigningProvider>();\n+            std::vector<CScript> scripts_temp;\n+            while (index >= m_wallet_descriptor.next_index) {\n+                if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719639229",
      "id" : 719639229,
      "in_reply_to_id" : 719146825,
      "line" : 1847,
      "node_id" : "PRRC_kwDOABII584q5NK9",
      "original_commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "original_line" : 1847,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 79,
      "pull_request_review_id" : 768177621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719639229/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T18:00:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719639229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719641795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719641795"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, that is indeed possible. In that case, we should keep this loop.",
      "commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "created_at" : "2021-09-30T18:04:09Z",
      "diff_hunk" : "@@ -1062,8 +1064,23 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n \n             // loop though all outputs\n             for (const CTxOut& txout: tx.vout) {\n-                for (const auto& spk_man_pair : m_spk_managers) {\n-                    spk_man_pair.second->MarkUnusedAddresses(txout.scriptPubKey);\n+                const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719641795",
      "id" : 719641795,
      "in_reply_to_id" : 719149474,
      "line" : 1067,
      "node_id" : "PRRC_kwDOABII584q5NzD",
      "original_commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "original_line" : 1067,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 17,
      "pull_request_review_id" : 768181185,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719641795/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T18:04:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719641795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r720998301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720998301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should check `if (type)` or `has_value()` to ensure it has a value before calling `*type`",
      "commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "created_at" : "2021-10-04T02:32:52Z",
      "diff_hunk" : "@@ -3276,6 +3276,29 @@ DescriptorScriptPubKeyMan* CWallet::GetDescriptorScriptPubKeyMan(const WalletDes\n     return nullptr;\n }\n \n+std::optional<bool> CWallet::IsInternalScriptPubKeyMan(ScriptPubKeyMan* spk_man) const\n+{\n+    // Legacy script pubkey man can't be either external or internal\n+    if (IsLegacy()) {\n+        return std::nullopt;\n+    }\n+\n+    // only active ScriptPubKeyMan can be internal\n+    if (!GetActiveScriptPubKeyMans().count(spk_man)) {\n+        return std::nullopt;\n+    }\n+\n+    const auto desc_spk_man = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man);\n+    if (!desc_spk_man) {\n+        throw std::runtime_error(std::string(__func__) + \": unexpected ScriptPubKeyMan type.\");\n+    }\n+\n+    LOCK(desc_spk_man->cs_desc_man);\n+    const auto& type = desc_spk_man->GetWalletDescriptor().descriptor->GetOutputType();\n+\n+    return GetScriptPubKeyMan(*type, /* internal= */ true) == desc_spk_man;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r720998301",
      "id" : 720998301,
      "line" : 3316,
      "node_id" : "PRRC_kwDOABII584q-Y-d",
      "original_commit_id" : "243473ed82c2c6ce79a40996a04e06fdab74f493",
      "original_line" : 3299,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 769811048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720998301/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-04T02:53:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720998301",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r720999793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720999793"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is better as `std::move(keypool)`?",
      "commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "created_at" : "2021-10-04T02:39:12Z",
      "diff_hunk" : "@@ -1448,7 +1458,10 @@ void LegacyScriptPubKeyMan::MarkReserveKeysAsUsed(int64_t keypool_id)\n         batch.ErasePool(index);\n         WalletLogPrintf(\"keypool index %d removed\\n\", index);\n         it = setKeyPool->erase(it);\n+        result.push_back(keypool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r720999793",
      "id" : 720999793,
      "line" : 1461,
      "node_id" : "PRRC_kwDOABII584q-ZVx",
      "original_commit_id" : "3690de44544f596b6ee249b96149611ab16b883d",
      "original_line" : 1461,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 55,
      "pull_request_review_id" : 769811048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720999793/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-04T02:53:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720999793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r721002066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721002066"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What does `N+2` mean here (and below)?\r\n(I understand based on the code that `N` is meant to be the \"first\" key that node[0] and therefore also node[2] generates but the comment is confusing).",
      "commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "created_at" : "2021-10-04T02:49:33Z",
      "diff_hunk" : "@@ -210,5 +214,63 @@ def get_unconfirmed_utxo_entry(node, txid_to_match):\n         assert_equal(self.nodes[0].gettransaction(txid_3b)[\"bip125-replaceable\"], \"no\")\n         assert_equal(self.nodes[0].gettransaction(txid_4)[\"bip125-replaceable\"], \"unknown\")\n \n+    def run_externally_generated_address_test(self):\n+        \"\"\"Test behavior when receiving address is not in the address book.\"\"\"\n+\n+        self.log.info(\"Setup the same wallet on two nodes\")\n+        # refill keypool otherwise the second node wouldn't recognize addresses generated on the first nodes\n+        self.nodes[0].keypoolrefill(1000)\n+        self.stop_nodes()\n+        wallet0 = os.path.join(self.nodes[0].datadir, self.chain, self.default_wallet_name, \"wallet.dat\")\n+        wallet2 = os.path.join(self.nodes[2].datadir, self.chain, self.default_wallet_name, \"wallet.dat\")\n+        shutil.copyfile(wallet0, wallet2)\n+        self.start_nodes()\n+        # reconnect nodes\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+        self.connect_nodes(2, 0)\n+\n+        addr1 = self.nodes[0].getnewaddress(\"pizza1\", 'legacy')\n+        addr2 = self.nodes[0].getnewaddress(\"pizza2\", 'p2sh-segwit')\n+        addr3 = self.nodes[0].getnewaddress(\"pizza3\", 'bech32')\n+\n+        self.log.info(\"Send to externally generated addresses\")\n+        # send to N+2 address to test the keypool gap",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r721002066",
      "id" : 721002066,
      "line" : 238,
      "node_id" : "PRRC_kwDOABII584q-Z5S",
      "original_commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "original_line" : 238,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/wallet_listtransactions.py",
      "position" : 54,
      "pull_request_review_id" : 769811048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721002066/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-04T02:53:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721002066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921062"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921062"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Returned the cycle and removed `GetScriptPubKeyMan` function to avoid such mistakes in the future",
      "commit_id" : "2912d0444525da019adfcb5dfcca5edd43c63d27",
      "created_at" : "2021-10-06T06:24:53Z",
      "diff_hunk" : "@@ -1062,8 +1064,23 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n \n             // loop though all outputs\n             for (const CTxOut& txout: tx.vout) {\n-                for (const auto& spk_man_pair : m_spk_managers) {\n-                    spk_man_pair.second->MarkUnusedAddresses(txout.scriptPubKey);\n+                const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921062",
      "id" : 722921062,
      "in_reply_to_id" : 719149474,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584rFuZm",
      "original_commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "original_line" : 1067,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 772236741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921062/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T06:24:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Active descriptors always have `type` defined, added assertion",
      "commit_id" : "2912d0444525da019adfcb5dfcca5edd43c63d27",
      "created_at" : "2021-10-06T06:25:28Z",
      "diff_hunk" : "@@ -3276,6 +3276,29 @@ DescriptorScriptPubKeyMan* CWallet::GetDescriptorScriptPubKeyMan(const WalletDes\n     return nullptr;\n }\n \n+std::optional<bool> CWallet::IsInternalScriptPubKeyMan(ScriptPubKeyMan* spk_man) const\n+{\n+    // Legacy script pubkey man can't be either external or internal\n+    if (IsLegacy()) {\n+        return std::nullopt;\n+    }\n+\n+    // only active ScriptPubKeyMan can be internal\n+    if (!GetActiveScriptPubKeyMans().count(spk_man)) {\n+        return std::nullopt;\n+    }\n+\n+    const auto desc_spk_man = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man);\n+    if (!desc_spk_man) {\n+        throw std::runtime_error(std::string(__func__) + \": unexpected ScriptPubKeyMan type.\");\n+    }\n+\n+    LOCK(desc_spk_man->cs_desc_man);\n+    const auto& type = desc_spk_man->GetWalletDescriptor().descriptor->GetOutputType();\n+\n+    return GetScriptPubKeyMan(*type, /* internal= */ true) == desc_spk_man;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921332",
      "id" : 722921332,
      "in_reply_to_id" : 720998301,
      "line" : 3306,
      "node_id" : "PRRC_kwDOABII584rFud0",
      "original_commit_id" : "243473ed82c2c6ce79a40996a04e06fdab74f493",
      "original_line" : 3306,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 117,
      "pull_request_review_id" : 772237122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T06:25:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921402"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "2912d0444525da019adfcb5dfcca5edd43c63d27",
      "created_at" : "2021-10-06T06:25:37Z",
      "diff_hunk" : "@@ -1448,7 +1458,10 @@ void LegacyScriptPubKeyMan::MarkReserveKeysAsUsed(int64_t keypool_id)\n         batch.ErasePool(index);\n         WalletLogPrintf(\"keypool index %d removed\\n\", index);\n         it = setKeyPool->erase(it);\n+        result.push_back(keypool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921402",
      "id" : 722921402,
      "in_reply_to_id" : 720999793,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584rFue6",
      "original_commit_id" : "3690de44544f596b6ee249b96149611ab16b883d",
      "original_line" : 1461,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 772237228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921402/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T06:25:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921591"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes. I updated the comments",
      "commit_id" : "2912d0444525da019adfcb5dfcca5edd43c63d27",
      "created_at" : "2021-10-06T06:26:01Z",
      "diff_hunk" : "@@ -210,5 +214,63 @@ def get_unconfirmed_utxo_entry(node, txid_to_match):\n         assert_equal(self.nodes[0].gettransaction(txid_3b)[\"bip125-replaceable\"], \"no\")\n         assert_equal(self.nodes[0].gettransaction(txid_4)[\"bip125-replaceable\"], \"unknown\")\n \n+    def run_externally_generated_address_test(self):\n+        \"\"\"Test behavior when receiving address is not in the address book.\"\"\"\n+\n+        self.log.info(\"Setup the same wallet on two nodes\")\n+        # refill keypool otherwise the second node wouldn't recognize addresses generated on the first nodes\n+        self.nodes[0].keypoolrefill(1000)\n+        self.stop_nodes()\n+        wallet0 = os.path.join(self.nodes[0].datadir, self.chain, self.default_wallet_name, \"wallet.dat\")\n+        wallet2 = os.path.join(self.nodes[2].datadir, self.chain, self.default_wallet_name, \"wallet.dat\")\n+        shutil.copyfile(wallet0, wallet2)\n+        self.start_nodes()\n+        # reconnect nodes\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+        self.connect_nodes(2, 0)\n+\n+        addr1 = self.nodes[0].getnewaddress(\"pizza1\", 'legacy')\n+        addr2 = self.nodes[0].getnewaddress(\"pizza2\", 'p2sh-segwit')\n+        addr3 = self.nodes[0].getnewaddress(\"pizza3\", 'bech32')\n+\n+        self.log.info(\"Send to externally generated addresses\")\n+        # send to N+2 address to test the keypool gap",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921591",
      "id" : 722921591,
      "in_reply_to_id" : 721002066,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584rFuh3",
      "original_commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "original_line" : 238,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/wallet_listtransactions.py",
      "position" : null,
      "pull_request_review_id" : 772237474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921591/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T06:26:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 3d71d16d1eb4173c70d4c294559fc2365e189856",
      "created_at" : "2021-12-02T18:37:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-984893886",
      "id" : 984893886,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5846tEm-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/984893886/reactions"
      },
      "updated_at" : "2021-12-02T18:37:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/984893886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This breaks \"walletconflicts\"\r\n\r\nNote: My `bugfix_rpc_getbalance_hacky` branch tests this by accident.",
      "created_at" : "2022-01-02T04:20:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-1003661769",
      "id" : 1003661769,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII58470qnJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003661769/reactions"
      },
      "updated_at" : "2022-01-02T04:20:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003661769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr I'm not sure what exactly is the broken scenario, happy to debug or write a test for it. It seems to me that `CWallet::GetLegacyBalance` in `bugfix_rpc_getbalance_hacky` branch makes an incorrect assumption that incoming txs will be in `mapTxSpends`. But `mapTxSpends` contains only spends",
      "created_at" : "2022-01-10T08:43:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-1008651476",
      "id" : 1008651476,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5848HszU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1008651476/reactions"
      },
      "updated_at" : "2022-01-10T08:43:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1008651476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">I'm not sure what exactly is the broken scenario, happy to debug or write a test for it. \r\n\r\n\"walletconflicts\" no longer returns other transactions that conflict with the transaction.\r\n\r\nThis is an issue in master, not just my branch. I only mentioned my branch because it's how I found it.\r\n\r\n>But mapTxSpends contains only spends\r\n\r\nIIRC, it's not supposed to only be spends from this wallet, but also spends *to* this wallet.\r\n\r\nI'm not sure if that's why \"walletconflicts\" is broken now, or not (though the comment for mapTxSpends suggests it may be)",
      "created_at" : "2022-01-13T00:00:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-1011559903",
      "id" : 1011559903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5848Sy3f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1011559903/reactions"
      },
      "updated_at" : "2022-01-13T00:00:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1011559903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@luke-jr Does reverting d04566415e16ae685af066384f346dff522c068f fix your issue?",
      "created_at" : "2022-01-13T17:55:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-1012373532",
      "id" : 1012373532,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5848V5gc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012373532/reactions"
      },
      "updated_at" : "2022-01-13T17:55:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012373532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">@luke-jr Does reverting d045664 fix your issue?\r\n\r\nRight, sorry I wasn't specific on which commit.",
      "created_at" : "2022-01-13T18:08:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-1012383001",
      "id" : 1012383001,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5848V70Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012383001/reactions"
      },
      "updated_at" : "2022-01-13T18:08:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012383001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Created #24083 with a revert",
      "created_at" : "2022-01-17T07:56:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-1014233998",
      "id" : 1014233998,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5848c_uO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1014233998/reactions"
      },
      "updated_at" : "2022-01-17T07:56:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1014233998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
