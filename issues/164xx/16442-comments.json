[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18638 (net: Use mockable time for ping/pong, add tests by MarcoFalke)\n* #18450 (util: Use locale independent ToString(â¦) instead of locale dependent strprintf(â¦) for low-level string formatting by practicalswift)\n* #18242 (Add BIP324 encrypted p2p transport de-/serializer (only used in tests) by jonasschnelli)\n* #18165 (Consolidate service flag bit-to-name conversion to a shared serviceFlagToStr function by luke-jr)\n* #18000 (Index for UTXO Set Statistics by fjahr)\n* #17479 (Return BlockValidationState from ProcessNewBlock if CheckBlock/AcceptBlock fails by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-07-23T18:29:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-514329131",
      "id" : 514329131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDMyOTEzMQ==",
      "updated_at" : "2020-05-04T21:37:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514329131",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Nice! Thanks for working on this.\r\n\r\n> Should there be a separate CLI flag other than -blockfilterindex to enable serving of filters from the index?\r\n\r\nI think so,... because some users may want to use the blockfilters only \"internal\", more specific, to rescan wallets (especially in prune mode), though functionality hasn't been added to Bitcoin Core yet\r\n\r\n> Is the mechanism to only signal the service flag once the index is in sync OK?\r\n\r\nI'd say yes. But unsure since I think we also signal NODE_NETWORK when in IBD.",
      "created_at" : "2019-07-23T18:41:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-514333563",
      "id" : 514333563,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDMzMzU2Mw==",
      "updated_at" : "2019-07-23T18:41:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514333563",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK - will review within the next few days.",
      "created_at" : "2019-07-24T13:58:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-514643609",
      "id" : 514643609,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDY0MzYwOQ==",
      "updated_at" : "2019-07-24T13:58:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514643609",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-07-24T18:15:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-514742116",
      "id" : 514742116,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDc0MjExNg==",
      "updated_at" : "2019-07-24T18:15:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514742116",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308415562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308415562"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Please dont add more node logic in net.cpp - if you want node logic put it in net_processing. But, honestly, this should be handled either by init checking these conditions or by the filtering code itself.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T20:10:24Z",
      "diff_hunk" : "@@ -2597,7 +2599,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308415562",
      "id" : 308415562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQxNTU2Mg==",
      "original_commit_id" : "c6f73db3abe2835fc14b5b4d434008f6613ee450",
      "original_line" : 2651,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308415562",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308426316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308426316"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this defined behavior?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T20:37:36Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+     return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308426316",
      "id" : 308426316,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQyNjMxNg==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2018,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308426316",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308428158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308428158"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is redundant with BlockRequestAllowed.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T20:42:16Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308428158",
      "id" : 308428158,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQyODE1OA==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 1881,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308428158",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308428510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308428510"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: bad indentation here.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T20:43:11Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308428510",
      "id" : 308428510,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQyODUxMA==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 1890,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308428510",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308428727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308428727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: bad indentation here.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T20:43:42Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+     return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308428727",
      "id" : 308428727,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQyODcyNw==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 1910,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308428727",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308429740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308429740"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't actually think this is sufficient. The stop block may be BlockRequestAllowed while the previous block(s) may not. I think it is sufficient to check BlockRequestAllowed both on the stop block and the start block, but you should also update the comment there to make that an invariant in the future.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T20:46:27Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308429740",
      "id" : 308429740,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQyOTc0MA==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 1882,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308429740",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308430487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308430487"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Because you haven't checked filter_type is sane yet, this allows DoS by filling someone's debug.log with garbage by repeatedly requesting undefined filter types.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T20:48:25Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308430487",
      "id" : 308430487,
      "line" : 2066,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQzMDQ4Nw==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2066,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 140,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308430487",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308430811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308430811"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why is max_height_diff a parameter? Why not just use the constant directly?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T20:49:04Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308430811",
      "id" : 308430811,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQzMDgxMQ==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2022,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308430811",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308440314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308440314"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I actually don't think we want to return false here and a few other places. All it does is change logging but no need to print twice when you just printed the error.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T21:13:30Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+     return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308440314",
      "id" : 308440314,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQ0MDMxNA==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 1928,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308440314",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308441053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308441053"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This should use the peer protocol version, not that I think it matters.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-29T21:15:12Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+     return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        return false;\n+    }\n+\n+    std::vector<BlockFilter> filters;\n+\n+    if (!filter_index->LookupFilterRange(start_height, stop_index, filters)) {\n+        return error(\"Failed to find block filter in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    for (const auto& filter : filters) {\n+        CSerializedNetMsg msg = CNetMsgMaker(INIT_PROTO_VERSION)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308441053",
      "id" : 308441053,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQ0MTA1Mw==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 1939,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268012403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308441053",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308699585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308699585"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point!",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T12:47:11Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308699585",
      "id" : 308699585,
      "in_reply_to_id" : 308429740,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODY5OTU4NQ==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 1882,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268364395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308699585",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308699798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308699798"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It'll be obvious in subsequent commits.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T12:47:37Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308699798",
      "id" : 308699798,
      "in_reply_to_id" : 308430811,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODY5OTc5OA==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2022,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268364641,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308699798",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308700863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308700863"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Filter type is checked at the top of this function?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T12:49:53Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308700863",
      "id" : 308700863,
      "in_reply_to_id" : 308430487,
      "line" : 2066,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODcwMDg2Mw==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2066,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 140,
      "pull_request_review_id" : 268365954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308700863",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308702676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308702676"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The point of this code is that the filter index may be building in the background and we don't want to signal NODE_COMPACT_FILTERS to peers until it is in sync. Then as soon as it does finish syncing, turn it on. \r\n\r\nI'm not sure this is the best way to do this so, I'm open to suggestions (this is the subject of two of the questions in the PR description). Another option would be to have a separate CLI flag for signalling NODE_COMPACT_FILTERS, which also blocks the net threads until the filter indices are in sync. That way the user can sync the filter index in the background, then shut down the node and restart with the BIP 157 net stuff enabled. Thoughts?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T12:53:39Z",
      "diff_hunk" : "@@ -2597,7 +2599,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308702676",
      "id" : 308702676,
      "in_reply_to_id" : 308415562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODcwMjY3Ng==",
      "original_commit_id" : "c6f73db3abe2835fc14b5b4d434008f6613ee450",
      "original_line" : 2651,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 268368258,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308702676",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308703023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308703023"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, BlockFilterType is `enum class BlockFilterType : uint8_t`.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T12:54:21Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+     return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308703023",
      "id" : 308703023,
      "in_reply_to_id" : 308426316,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODcwMzAyMw==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2018,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268368690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308703023",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308920904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308920904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Upon further reflection, this seems to not be an issue. Discussed offline with @TheBlueMatt.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T20:12:55Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308920904",
      "id" : 308920904,
      "in_reply_to_id" : 308429740,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODkyMDkwNA==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 1882,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268639745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308920904",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308920968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308920968"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmmm, actually I don't think so? SO quotes:\r\n\r\n    C++ standard 5.2.9 Static cast [expr.static.cast] paragraph 7\r\n\r\n    A value of integral or enumeration type can be explicitly converted to an enumeration type. The value is unchanged if the original value is within the range of the enumeration values (7.2). Otherwise, the resulting enumeration value is unspecified / undefined (since C++17).\r\n",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T20:13:03Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+     return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308920968",
      "id" : 308920968,
      "in_reply_to_id" : 308426316,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODkyMDk2OA==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2018,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268639809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308920968",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308923954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308923954"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Converting a uint8_t to a uint8_t-based enum should always result in something in range?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T20:20:14Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+     return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308923954",
      "id" : 308923954,
      "in_reply_to_id" : 308426316,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODkyMzk1NA==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2018,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268643681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308923954",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308926293"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308926293"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "\"For an enumeration whose underlying type is fixed, the values of the enumeration are the values of the underlying type.\"\r\n\r\nhttps://stackoverflow.com/questions/18195312/what-happens-if-you-static-cast-invalid-value-to-enum-class",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T20:26:05Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+     return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308926293",
      "id" : 308926293,
      "in_reply_to_id" : 308426316,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODkyNjI5Mw==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2018,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268646789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308926293",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308927259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308927259"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Makes sense. Changed to return true.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-07-30T20:28:39Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+     {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index ||\n+            !stop_index->IsValid(BLOCK_VALID_SCRIPTS) ||\n+            !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+     uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+     return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308927259",
      "id" : 308927259,
      "in_reply_to_id" : 308440314,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODkyNzI1OQ==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 1928,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 268648088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308927259",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311262606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311262606"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I spent a few minutes writing an indignant comment about how we should be okay with taking this small hack on as technical debt, but it actually looks like it might be pretty easy to address @TheBlueMatt's concerns by adding a method to `CConman` (eg `AddLocalService(ServiceFlags flag)`) that just modifies `nLocalServices`. The indexing code could call it on sync completion. Any reason not to do that?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-06T20:36:03Z",
      "diff_hunk" : "@@ -2597,7 +2599,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311262606",
      "id" : 311262606,
      "in_reply_to_id" : 308415562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTI2MjYwNg==",
      "original_commit_id" : "c6f73db3abe2835fc14b5b4d434008f6613ee450",
      "original_line" : 2651,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 271599508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311262606",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311263083"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311263083"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(FWIW I hate the idea of blocking net threads while waiting for filter indices to sync, and slightly less hate requiring a restart to serve the filters.)",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-06T20:37:19Z",
      "diff_hunk" : "@@ -2597,7 +2599,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311263083",
      "id" : 311263083,
      "in_reply_to_id" : 308415562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTI2MzA4Mw==",
      "original_commit_id" : "c6f73db3abe2835fc14b5b4d434008f6613ee450",
      "original_line" : 2651,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 271600110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311263083",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311457705"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311457705"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@jamesob Yes, that would work too, but I wouldn't want to index to call CConmann directly. It should do it through some sort of callback to avoid coupling them, which just creates more indirection. I think this approach is a bit easier, but I'd be OK with a callback that updates `nLocalServices` as well.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-07T09:33:03Z",
      "diff_hunk" : "@@ -2597,7 +2599,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311457705",
      "id" : 311457705,
      "in_reply_to_id" : 308415562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTQ1NzcwNQ==",
      "original_commit_id" : "c6f73db3abe2835fc14b5b4d434008f6613ee450",
      "original_line" : 2651,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 271840050,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311457705",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311731513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311731513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/16442/commits/9da9daad6053934009448344bae77f4e18f36869\r\n\r\nWhy isn't this `true` as in `ProcessGetCFilters()`? (Same question for `ProcessGetCFHeaders()`.)",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-07T19:46:18Z",
      "diff_hunk" : "@@ -1989,6 +1991,49 @@ static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainPa\n     return true;\n }\n \n+static bool ProcessGetCFCheckPt(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, /*start_height=*/0, stop_hash,\n+                                   /*max_height_diff=*/std::numeric_limits<uint32_t>::max(),\n+                                   stop_index, filter_index)) {\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311731513",
      "id" : 311731513,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTczMTUxMw==",
      "original_commit_id" : "9da9daad6053934009448344bae77f4e18f36869",
      "original_line" : 2009,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 272189096,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311731513",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311737473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311737473"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/16442/commits/3499e8877b3be1a629647353ddb8bb380c10a513\r\n\r\nMight want to make a note here about why we're adding more boost usage instead of using the utilities in `sync` (ie `std::mutex`). I assume this is because we want to allow multiple threads to be able to read the headers cache simultaneously?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-07T20:01:12Z",
      "diff_hunk" : "@@ -403,6 +405,10 @@ limitedmap<uint256, int64_t> g_already_asked_for GUARDED_BY(cs_main)(MAX_INV_SZ)\n /** Map maintaining per-node state. */\n static std::map<NodeId, CNodeState> mapNodeState GUARDED_BY(cs_main);\n \n+/** In-memory cache of all BIP157 compact filter checkpoints for the active chain. */\n+static std::vector<std::pair<const CBlockIndex*, uint256>> active_chain_cf_headers;\n+static boost::shared_mutex active_chain_cf_headers_mtx;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311737473",
      "id" : 311737473,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTczNzQ3Mw==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 410,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 272196705,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311737473",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311993840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311993840"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, the rationale is that `std` doesn't get `shared_mutex` until C++17. I'll add a comment.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-08T11:52:56Z",
      "diff_hunk" : "@@ -403,6 +405,10 @@ limitedmap<uint256, int64_t> g_already_asked_for GUARDED_BY(cs_main)(MAX_INV_SZ)\n /** Map maintaining per-node state. */\n static std::map<NodeId, CNodeState> mapNodeState GUARDED_BY(cs_main);\n \n+/** In-memory cache of all BIP157 compact filter checkpoints for the active chain. */\n+static std::vector<std::pair<const CBlockIndex*, uint256>> active_chain_cf_headers;\n+static boost::shared_mutex active_chain_cf_headers_mtx;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r311993840",
      "id" : 311993840,
      "in_reply_to_id" : 311737473,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTk5Mzg0MA==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 410,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 272517940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311993840",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312078105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312078105"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These changes *don't* require reindexing because we [manually spell out the serialization format](https://github.com/jamesob/bitcoin/blob/3499e8877b3be1a629647353ddb8bb380c10a513/src/index/blockfilterindex.cpp#L211) when writing to disk (and same with reads) instead of using these serialization ops, right?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-08T14:48:52Z",
      "diff_hunk" : "@@ -143,8 +143,8 @@ class BlockFilter\n \n     template <typename Stream>\n     void Serialize(Stream& s) const {\n-        s << m_block_hash\n-          << static_cast<uint8_t>(m_filter_type)\n+        s << static_cast<uint8_t>(m_filter_type)\n+          << m_block_hash",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312078105",
      "id" : 312078105,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjA3ODEwNQ==",
      "original_commit_id" : "bbb909cf12d11cb546fff2d47c02f93001ed5bdf",
      "original_line" : 148,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/blockfilter.h",
      "position" : 7,
      "pull_request_review_id" : 272626687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312078105",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312182612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312182612"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/16442/commits/3499e8877b3be1a629647353ddb8bb380c10a513\r\n\r\nFWIW could make this `const`.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-08T18:29:50Z",
      "diff_hunk" : "@@ -1201,6 +1207,40 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     });\n }\n \n+static bool UpdateCFHeadersCache(const BlockFilterIndex& filter_index)\n+{\n+    LOCK(cs_main);\n+    boost::unique_lock<boost::shared_mutex> _lock(active_chain_cf_headers_mtx);\n+\n+    CChain& active_chain = ::ChainActive();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312182612",
      "id" : 312182612,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjE4MjYxMg==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 1215,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 272626687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312182612",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312186387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312186387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To be clear: at the moment, the `shared_lock` is more or less moot because this is only ever called into from a single thread (`msghand`). I'm not necessarily opposed to using the shared_lock before necessary, but might be worth falling back to our standard `RecursiveMutex` (which comes with lock diagnostics) until and if we actually hit this from multiple threads.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-08T18:38:21Z",
      "diff_hunk" : "@@ -2043,23 +2087,37 @@ static bool ProcessGetCFCheckPt(CNode* pfrom, CDataStream& vRecv, const CChainPa\n         return false;\n     }\n \n-    bool index_in_sync = false;\n     std::vector<uint256> headers(stop_index->nHeight / CFCHECKPT_INTERVAL);\n+    {\n+        boost::shared_lock<boost::shared_mutex> _lock(active_chain_cf_headers_mtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312186387",
      "id" : 312186387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjE4NjM4Nw==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 2092,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 272626687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312186387",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312467117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312467117"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-09T12:59:25Z",
      "diff_hunk" : "@@ -143,8 +143,8 @@ class BlockFilter\n \n     template <typename Stream>\n     void Serialize(Stream& s) const {\n-        s << m_block_hash\n-          << static_cast<uint8_t>(m_filter_type)\n+        s << static_cast<uint8_t>(m_filter_type)\n+          << m_block_hash",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312467117",
      "id" : 312467117,
      "in_reply_to_id" : 312078105,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjQ2NzExNw==",
      "original_commit_id" : "bbb909cf12d11cb546fff2d47c02f93001ed5bdf",
      "original_line" : 148,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/blockfilter.h",
      "position" : 7,
      "pull_request_review_id" : 273122878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312467117",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312470069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312470069"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, for some reason I thought there were multiple message handler threads. Since there's just one and this doesn't require recursive locking, I think going to a `std::mutex` makes sense. Agree?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-09T13:06:54Z",
      "diff_hunk" : "@@ -2043,23 +2087,37 @@ static bool ProcessGetCFCheckPt(CNode* pfrom, CDataStream& vRecv, const CChainPa\n         return false;\n     }\n \n-    bool index_in_sync = false;\n     std::vector<uint256> headers(stop_index->nHeight / CFCHECKPT_INTERVAL);\n+    {\n+        boost::shared_lock<boost::shared_mutex> _lock(active_chain_cf_headers_mtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312470069",
      "id" : 312470069,
      "in_reply_to_id" : 312186387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjQ3MDA2OQ==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 2092,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 273126581,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312470069",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312485687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312485687"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jimpo yep, that'd be my inclination.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-09T13:45:31Z",
      "diff_hunk" : "@@ -2043,23 +2087,37 @@ static bool ProcessGetCFCheckPt(CNode* pfrom, CDataStream& vRecv, const CChainPa\n         return false;\n     }\n \n-    bool index_in_sync = false;\n     std::vector<uint256> headers(stop_index->nHeight / CFCHECKPT_INTERVAL);\n+    {\n+        boost::shared_lock<boost::shared_mutex> _lock(active_chain_cf_headers_mtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r312485687",
      "id" : 312485687,
      "in_reply_to_id" : 312186387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjQ4NTY4Nw==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 2092,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 273147517,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312485687",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\n> Should there be a separate CLI flag other than -blockfilterindex to enable serving of filters from the index?\r\n\r\nYes, suggest defaulting to `true`. It can wait until #15845.\r\n\r\n> Is the mechanism to only signal the service flag once the index is in sync OK?\r\n\r\nI guess it's already built, but I'd be fine with moving that to a followup (and kick the `src/net.cpp` discussion can down the road). For fresh nodes the index is synced along with IBD. For existing nodes which add the index there's a slight lag between when this setting is enabled and when it's available. These flags take time to get gossiped around. The odds of another node wasting time because of that seems orders of magnitude smaller than the odds of the node just being offline.\r\n\r\nOn macOS 10.14.6 when configured with `--enable-debug` the newly added `p2p_cfilters.py` ignites my fan and failed the first time with `Block sync timed out:` (passed the second time). ",
      "created_at" : "2019-08-13T16:01:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-520897695",
      "id" : 520897695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDg5NzY5NQ==",
      "updated_at" : "2019-08-13T16:09:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520897695",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Should there be a separate CLI flag other than -blockfilterindex to enable serving of filters from the index?\r\n\r\nBIP 157 is controversial, so I think yes.",
      "created_at" : "2019-08-20T00:38:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-522805991",
      "id" : 522805991,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMjgwNTk5MQ==",
      "updated_at" : "2019-08-20T00:38:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/522805991",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r317856404"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317856404"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: \r\n```suggestion\r\n        # Nodes 0 & 1 share the same first 999 blocks in the chain.\r\n```",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-27T01:06:28Z",
      "diff_hunk" : "@@ -0,0 +1,264 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Tests NODE_COMPACT_FILTERS (BIP 157/158).\n+\n+Tests that a node configured with -blockfilterindex signals NODE_COMPACT_FILTERS and responds\n+correctly to GET_CFILTERS, GET_CFHEADERS, GET_CFCHECKPT requests.\n+\"\"\"\n+\n+from test_framework.messages import (\n+    FILTER_TYPE_BASIC,\n+    NODE_NETWORK, NODE_COMPACT_FILTERS, NODE_WITNESS, NODE_NETWORK_LIMITED,\n+    msg_getcfilters, msg_getcfheaders, msg_getcfcheckpt,\n+    ser_uint256, uint256_from_str, hash256,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    connect_nodes, disconnect_nodes, sync_blocks,\n+    wait_until,\n+)\n+\n+FILTER_TYPES = [\"basic\"]\n+\n+class CFiltersClient(P2PInterface):\n+    def __init__(self):\n+        super().__init__()\n+        # Store the cfilters received.\n+        self.cfilters = []\n+\n+    def pop_cfilters(self):\n+        cfilters = self.cfilters\n+        self.cfilters = []\n+        return cfilters\n+\n+    def on_cfilter(self, message):\n+        \"\"\"Store cfilters received in a list.\"\"\"\n+        self.cfilters.append(message)\n+\n+class CompactFiltersTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-blockfilterindex\"], []]\n+\n+    def run_test(self):\n+        # Node 0 supports COMPACT_FILTERS, node 1 does not.\n+        node0 = self.nodes[0].add_p2p_connection(CFiltersClient())\n+        node1 = self.nodes[1].add_p2p_connection(CFiltersClient())\n+\n+        # Nodes 0 & 1 share the same first 999 nodes in the chain.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r317856404",
      "id" : 317856404,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNzg1NjQwNA==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_cfilters.py",
      "position" : null,
      "pull_request_review_id" : 279909596,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317856404",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r317859935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317859935"
         }
      },
      "author_association" : "NONE",
      "body" : "I was a bit confused reviewing ab0ea72734ee0bcf7fdf8201d611941ea86ed15f here before seeing the synchronization code added later. If you decide to remove synchronization between the net thread and the filter-index thread, you can use the `syncwithvalidationinterface` RPC here and after reorging `node0` to keep the tests working consistently.\r\n\r\nOtherwise (without 77653ec568628291f69ea1b5a31bee35a6492a4a) I believe it is possible that the block filter index might not be synced at this point and the request would fail. ",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-27T01:27:55Z",
      "diff_hunk" : "@@ -0,0 +1,264 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Tests NODE_COMPACT_FILTERS (BIP 157/158).\n+\n+Tests that a node configured with -blockfilterindex signals NODE_COMPACT_FILTERS and responds\n+correctly to GET_CFILTERS, GET_CFHEADERS, GET_CFCHECKPT requests.\n+\"\"\"\n+\n+from test_framework.messages import (\n+    FILTER_TYPE_BASIC,\n+    NODE_NETWORK, NODE_COMPACT_FILTERS, NODE_WITNESS, NODE_NETWORK_LIMITED,\n+    msg_getcfilters, msg_getcfheaders, msg_getcfcheckpt,\n+    ser_uint256, uint256_from_str, hash256,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    connect_nodes, disconnect_nodes, sync_blocks,\n+    wait_until,\n+)\n+\n+FILTER_TYPES = [\"basic\"]\n+\n+class CFiltersClient(P2PInterface):\n+    def __init__(self):\n+        super().__init__()\n+        # Store the cfilters received.\n+        self.cfilters = []\n+\n+    def pop_cfilters(self):\n+        cfilters = self.cfilters\n+        self.cfilters = []\n+        return cfilters\n+\n+    def on_cfilter(self, message):\n+        \"\"\"Store cfilters received in a list.\"\"\"\n+        self.cfilters.append(message)\n+\n+class CompactFiltersTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-blockfilterindex\"], []]\n+\n+    def run_test(self):\n+        # Node 0 supports COMPACT_FILTERS, node 1 does not.\n+        node0 = self.nodes[0].add_p2p_connection(CFiltersClient())\n+        node1 = self.nodes[1].add_p2p_connection(CFiltersClient())\n+\n+        # Nodes 0 & 1 share the same first 999 nodes in the chain.\n+        self.nodes[0].generate(999)\n+        sync_blocks(self.nodes)\n+\n+        # Stale blocks by disconnecting nodes 0 & 1, mining, then reconnecting\n+        disconnect_nodes(self.nodes[0], 1)\n+\n+        self.nodes[0].generate(1)\n+        wait_until(lambda: self.nodes[0].getblockcount() == 1000)\n+        stale_block_hash = self.nodes[0].getblockhash(1000)\n+\n+        self.nodes[1].generate(1001)\n+        wait_until(lambda: self.nodes[1].getblockcount() == 2000)\n+\n+        # Fetch cfcheckpt on node 0. Since the implementation caches the checkpoints on the active\n+        # chain in memory, this checks that the cache is updated correctly upon subsequent queries\n+        # after the reorg.\n+        request = msg_getcfcheckpt(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r317859935",
      "id" : 317859935,
      "line" : 75,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNzg1OTkzNQ==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 75,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "test/functional/p2p_cfilters.py",
      "position" : 75,
      "pull_request_review_id" : 279909596,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317859935",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r317861704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317861704"
         }
      },
      "author_association" : "NONE",
      "body" : "Looks like @jimpo may have just forgotten to update the corresponding return statements when updating the PR earlier. See: https://github.com/bitcoin/bitcoin/pull/16442#discussion_r308440314 \"All it does is change logging but no need to print twice when you just printed the error.\"\r\n\r\nIt should be consistent though.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-27T01:38:15Z",
      "diff_hunk" : "@@ -1989,6 +1991,49 @@ static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainPa\n     return true;\n }\n \n+static bool ProcessGetCFCheckPt(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, /*start_height=*/0, stop_hash,\n+                                   /*max_height_diff=*/std::numeric_limits<uint32_t>::max(),\n+                                   stop_index, filter_index)) {\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r317861704",
      "id" : 317861704,
      "in_reply_to_id" : 311731513,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNzg2MTcwNA==",
      "original_commit_id" : "9da9daad6053934009448344bae77f4e18f36869",
      "original_line" : 2009,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 279909596,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317861704",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r317867252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317867252"
         }
      },
      "author_association" : "NONE",
      "body" : "Rather than block the message handler thread until the filter index has synced, is there much downside to ignoring messages when a filter query fails because it is not yet synced? (i.e. not sending anything back to the peer as implemented before 77653ec568628291f69ea1b5a31bee35a6492a4a) \r\n\r\nBy the spec in BIP 157, clients should be downloading from multiple peers so they wouldn't be wasting much bandwidth because of dropped messages caused by this. Blocking the message handler thread just seems to have more downsides IMO.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-08-27T02:11:37Z",
      "diff_hunk" : "@@ -1848,6 +1899,238 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r317867252",
      "id" : 317867252,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNzg2NzI1Mg==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 1995,
      "original_position" : 165,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 279909596,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317867252",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I spun up a temporary testnet node in case anyone wants to test the p2p behavior: `uskjxnd7tud7qkeg.onion:18333`",
      "created_at" : "2019-09-01T11:13:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-526909565",
      "id" : 526909565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjkwOTU2NQ==",
      "updated_at" : "2019-10-25T15:57:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526909565",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r321962707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321962707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be \"that\"? :-)",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-09-07T09:32:13Z",
      "diff_hunk" : "@@ -0,0 +1,264 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Tests NODE_COMPACT_FILTERS (BIP 157/158).\n+\n+Tests that a node configured with -blockfilterindex signals NODE_COMPACT_FILTERS and responds\n+correctly to GET_CFILTERS, GET_CFHEADERS, GET_CFCHECKPT requests.\n+\"\"\"\n+\n+from test_framework.messages import (\n+    FILTER_TYPE_BASIC,\n+    NODE_NETWORK, NODE_COMPACT_FILTERS, NODE_WITNESS, NODE_NETWORK_LIMITED,\n+    msg_getcfilters, msg_getcfheaders, msg_getcfcheckpt,\n+    ser_uint256, uint256_from_str, hash256,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    connect_nodes, disconnect_nodes, sync_blocks,\n+    wait_until,\n+)\n+\n+FILTER_TYPES = [\"basic\"]\n+\n+class CFiltersClient(P2PInterface):\n+    def __init__(self):\n+        super().__init__()\n+        # Store the cfilters received.\n+        self.cfilters = []\n+\n+    def pop_cfilters(self):\n+        cfilters = self.cfilters\n+        self.cfilters = []\n+        return cfilters\n+\n+    def on_cfilter(self, message):\n+        \"\"\"Store cfilters received in a list.\"\"\"\n+        self.cfilters.append(message)\n+\n+class CompactFiltersTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-blockfilterindex\"], []]\n+\n+    def run_test(self):\n+        # Node 0 supports COMPACT_FILTERS, node 1 does not.\n+        node0 = self.nodes[0].add_p2p_connection(CFiltersClient())\n+        node1 = self.nodes[1].add_p2p_connection(CFiltersClient())\n+\n+        # Nodes 0 & 1 share the same first 999 nodes in the chain.\n+        self.nodes[0].generate(999)\n+        sync_blocks(self.nodes)\n+\n+        # Stale blocks by disconnecting nodes 0 & 1, mining, then reconnecting\n+        disconnect_nodes(self.nodes[0], 1)\n+\n+        self.nodes[0].generate(1)\n+        wait_until(lambda: self.nodes[0].getblockcount() == 1000)\n+        stale_block_hash = self.nodes[0].getblockhash(1000)\n+\n+        self.nodes[1].generate(1001)\n+        wait_until(lambda: self.nodes[1].getblockcount() == 2000)\n+\n+        # Fetch cfcheckpt on node 0. Since the implementation caches the checkpoints on the active\n+        # chain in memory, this checks that the cache is updated correctly upon subsequent queries\n+        # after the reorg.\n+        request = msg_getcfcheckpt(\n+            filter_type=FILTER_TYPE_BASIC,\n+            stop_hash=int(stale_block_hash, 16)\n+        )\n+        node0.send_message(request)\n+        node0.sync_with_ping(timeout=5)\n+        response = node0.last_message['cfcheckpt']\n+        assert_equal(response.filter_type, request.filter_type)\n+        assert_equal(response.stop_hash, request.stop_hash)\n+        assert_equal(len(response.headers), 1)\n+\n+        # Reorg node 0 to a new chain\n+        connect_nodes(self.nodes[0], 1)\n+        sync_blocks(self.nodes)\n+\n+        main_block_hash = self.nodes[0].getblockhash(1000)\n+        assert main_block_hash != stale_block_hash, \"node 0 chain did not reorganize\"\n+\n+        default_services = NODE_NETWORK | NODE_WITNESS | NODE_NETWORK_LIMITED\n+\n+        # Check that nodes have signalled expected services.\n+        assert_equal(node0.nServices, default_services | NODE_COMPACT_FILTERS)\n+        assert_equal(node1.nServices, default_services)\n+\n+        # Check that the localservices is as expected.\n+        assert_equal(int(self.nodes[0].getnetworkinfo()['localservices'], 16),\n+                     default_services | NODE_COMPACT_FILTERS)\n+        assert_equal(int(self.nodes[1].getnetworkinfo()['localservices'], 16),\n+                     default_services)\n+\n+        # Check that peers can fetch cfcheckpt on active chain.\n+        tip_hash = self.nodes[0].getbestblockhash()\n+        request = msg_getcfcheckpt(\n+            filter_type=FILTER_TYPE_BASIC,\n+            stop_hash=int(tip_hash, 16)\n+        )\n+        node0.send_message(request)\n+        node0.sync_with_ping()\n+        response = node0.last_message['cfcheckpt']\n+        assert_equal(response.filter_type, request.filter_type)\n+        assert_equal(response.stop_hash, request.stop_hash)\n+\n+        main_cfcheckpt = self.nodes[0].getblockfilter(main_block_hash, 'basic')['header']\n+        tip_cfcheckpt = self.nodes[0].getblockfilter(tip_hash, 'basic')['header']\n+        assert_equal(\n+            response.headers,\n+            [int(header, 16) for header in (main_cfcheckpt, tip_cfcheckpt)]\n+        )\n+\n+        # Check that peers can fetch cfcheckpt on stale chain.\n+        request = msg_getcfcheckpt(\n+            filter_type=FILTER_TYPE_BASIC,\n+            stop_hash=int(stale_block_hash, 16)\n+        )\n+        node0.send_message(request)\n+        node0.sync_with_ping()\n+        response = node0.last_message['cfcheckpt']\n+\n+        stale_cfcheckpt = self.nodes[0].getblockfilter(stale_block_hash, 'basic')['header']\n+        assert_equal(\n+            response.headers,\n+            [int(header, 16) for header in (stale_cfcheckpt,)]\n+        )\n+\n+        # Check that peers can fetch cfheaders on active chain.\n+        request = msg_getcfheaders(\n+            filter_type=FILTER_TYPE_BASIC,\n+            start_height=1,\n+            stop_hash=int(main_block_hash, 16)\n+        )\n+        node0.send_message(request)\n+        node0.sync_with_ping()\n+        response = node0.last_message['cfheaders']\n+        main_cfhashes = response.hashes\n+        assert_equal(\n+            compute_last_header(response.prev_header, response.hashes),\n+            int(main_cfcheckpt, 16)\n+        )\n+\n+        # Check that peers can fetch cfheaders on stale chain.\n+        request = msg_getcfheaders(\n+            filter_type=FILTER_TYPE_BASIC,\n+            start_height=1,\n+            stop_hash=int(stale_block_hash, 16)\n+        )\n+        node0.send_message(request)\n+        node0.sync_with_ping()\n+        response = node0.last_message['cfheaders']\n+        stale_cfhashes = response.hashes\n+        assert_equal(\n+            compute_last_header(response.prev_header, response.hashes),\n+            int(stale_cfcheckpt, 16)\n+        )\n+\n+        # Check that peers can fetch cfilters.\n+        stop_hash = self.nodes[0].getblockhash(10)\n+        request = msg_getcfilters(\n+            filter_type=FILTER_TYPE_BASIC,\n+            start_height=1,\n+            stop_hash=int(stop_hash, 16)\n+        )\n+        node0.send_message(request)\n+        node0.sync_with_ping()\n+        response = node0.pop_cfilters()\n+        assert_equal(len(response), 10)\n+\n+        # Check that cfilter responses are correct.\n+        for cfilter, cfhash, height in zip(response, main_cfhashes, range(1, 11)):\n+            block_hash = self.nodes[0].getblockhash(height)\n+            assert_equal(cfilter.filter_type, FILTER_TYPE_BASIC)\n+            assert_equal(cfilter.block_hash, int(block_hash, 16))\n+            computed_cfhash = uint256_from_str(hash256(cfilter.filter_data))\n+            assert_equal(computed_cfhash, cfhash)\n+\n+        # Check thet peers can fetch cfilters for stale blocks.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r321962707",
      "id" : 321962707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMTk2MjcwNw==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 186,
      "original_position" : 186,
      "original_start_line" : null,
      "path" : "test/functional/p2p_cfilters.py",
      "position" : null,
      "pull_request_review_id" : 285164857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321962707",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r322897395"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322897395"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just had an offline conversation with @sdaftuar here (with regard to #16847) which I think is relevant. Dynamically flipping `nLocalServices` bits doesn't make a ton of sense because we'd need to disconnect and reconnect to all of our peers in order for the flip to have any effect.\r\n\r\nWhen thinking about this, it's instructive to look at how IBD works: we don't flip `NODE_NETWORK` off and on once we've started and finished IBD; instead net_processing just behaves differently during IBD and peers are able to gracefully handle nodes that signal NODE_NETWORK but haven't completed the sync yet and therefore drop getheaders messages.\r\n\r\nI think the way forward in this case is to do something analogous: signal `NODE_COMPACT_FILTERS` from startup when appropriate and ensure that nodes seeking block filters account for the fact that a peer they request filters from may be in the process of building them.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-09-10T18:29:34Z",
      "diff_hunk" : "@@ -2597,7 +2599,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r322897395",
      "id" : 322897395,
      "in_reply_to_id" : 308415562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMjg5NzM5NQ==",
      "original_commit_id" : "c6f73db3abe2835fc14b5b4d434008f6613ee450",
      "original_line" : 2651,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 286350774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322897395",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jimpo any plans to address feedback here? It'd be great to see this PR move towards merge.",
      "created_at" : "2019-09-27T15:33:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-535989758",
      "id" : 535989758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNTk4OTc1OA==",
      "updated_at" : "2019-09-27T15:33:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/535989758",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-10-09T15:42:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-540059882",
      "id" : 540059882,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MDA1OTg4Mg==",
      "updated_at" : "2019-10-09T15:42:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/540059882",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r336731085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/336731085"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Dynamically flipping nLocalServices bits doesn't make a ton of sense because we'd need to disconnect and reconnect to all of our peers in order for the flip to have any effect.\r\n\r\nI disagree with this. New inbound connections will see that the service bit has been flipped. And clients who need the filters wouldn't connect until it is on, so it's not like any inbound connections need to periodically disconnect/reconnect. And if I understand correctly, we re-advertise our local address with service bits to each peer every day on average, so the network should see the change eventually without the node operator having to do anything.\r\n\r\n>  instead net_processing just behaves differently during IBD and peers are able to gracefully handle nodes that signal NODE_NETWORK but haven't completed the sync yet and therefore drop getheaders messages.\r\n\r\nThis feels a bit different because the `version` message includes a start height indicating how far behind the node is. I suppose clients could also just request checkpoints and determine how far behind a node's filter index is at least to within 1,000 blocks though.\r\n",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-10-19T10:11:21Z",
      "diff_hunk" : "@@ -2597,7 +2599,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r336731085",
      "id" : 336731085,
      "in_reply_to_id" : 308415562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzNjczMTA4NQ==",
      "original_commit_id" : "c6f73db3abe2835fc14b5b4d434008f6613ee450",
      "original_line" : 2651,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 304206235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/336731085",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r336731315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/336731315"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It just makes the client logic more complicated as they need to have timeouts and if the index is active (like it has gotten in sync once since the node has been running), it should catch up to the tip pretty fast.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-10-19T10:18:32Z",
      "diff_hunk" : "@@ -1848,6 +1899,238 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r336731315",
      "id" : 336731315,
      "in_reply_to_id" : 317867252,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzNjczMTMxNQ==",
      "original_commit_id" : "3499e8877b3be1a629647353ddb8bb380c10a513",
      "original_line" : 1995,
      "original_position" : 165,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 304206475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/336731315",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jamesob Sorry for the delay, just pushed up changes.",
      "created_at" : "2019-10-19T10:32:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-544125600",
      "id" : 544125600,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NDEyNTYwMA==",
      "updated_at" : "2019-10-19T10:32:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/544125600",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I lightly tested 8d08df4 on macOS 10.15 using `-bind=127.0.0.1 -debug=net -blockfilterindex=1 -peercfilters=1 -blocksonly` against a locally running Lnd node (master @ 8ed75834480e7be3f42d77f5d96e2880c94156fb) with `bitcoin.node=neutrino` and `neutrino.connect=127.0.0.1`. It initially catches up to the tip nicely.\r\n\r\nI then connect to the using Zap desktop, at which point Lnd starts complaining (maybe an Lnd / Zap bug):\r\n```\r\n2019-10-23 11:18:35.411 [INF] BTCN: New valid peer 127.0.0.1:8333 (outbound) (/Satoshi:0.19.99/)\r\n2019-10-23 11:18:35.412 [INF] BTCN: Syncing to block height 600677 from peer 127.0.0.1:8333\r\n2019-10-23 11:18:35.412 [INF] BTCN: Fetching set of headers from tip (height=600677) from peer 127.0.0.1:8333\r\n2019-10-23 11:19:00.399 [ERR] BTCN: Query failed with 0 out of 435 filters received\r\n2019-10-23 11:19:00.399 [ERR] LNWL: Neutrino rescan ended with error: unable to fetch cfilter\r\n```\r\n\r\nIt seems that bitcoind is disconnecting the Lnd node for requesting too many filters:\r\n\r\n```\r\n2019-10-23T09:18:30Z received: getcfilters (37 bytes) peer=13\r\n2019-10-23T09:18:30Z peer 13 requested too many cfilters/cfheaders: 435 / 100\r\n2019-10-23T09:18:30Z disconnecting peer=13\r\n....\r\n2019-10-23T09:18:35Z Added connection peer=14\r\n2019-10-23T09:18:35Z connection from 127.0.0.1:54906 accepted\r\n2019-10-23T09:18:35Z received: version (121 bytes) peer=14\r\n2019-10-23T09:18:35Z sending version (103 bytes) peer=14\r\n2019-10-23T09:18:35Z send version message: version 70015, blocks=600677, us=[::]:0, peer=14\r\n2019-10-23T09:18:35Z sending verack (0 bytes) peer=14\r\n2019-10-23T09:18:35Z receive version message: /btcwire:0.5.0/neutrino:0.0.4-beta/: version 70013, blocks=600677, us=127.0.0.1:8333, peer=14\r\n2019-10-23T09:18:35Z received: verack (0 bytes) peer=14\r\n2019-10-23T09:18:35Z sending sendheaders (0 bytes) peer=14\r\n2019-10-23T09:18:35Z sending ping (8 bytes) peer=14\r\n2019-10-23T09:18:35Z sending addr (31 bytes) peer=14\r\n2019-10-23T09:18:35Z sending feefilter (8 bytes) peer=14\r\n2019-10-23T09:18:35Z received: getaddr (0 bytes) peer=14\r\n2019-10-23T09:18:35Z received: getheaders (997 bytes) peer=14\r\n2019-10-23T09:18:35Z getheaders -1 to end from peer=14\r\n2019-10-23T09:18:35Z sending headers (1 bytes) peer=14\r\n2019-10-23T09:18:35Z received: pong (8 bytes) peer=14\r\n2019-10-23T09:18:46Z sending addr (30003 bytes) peer=14\r\n```\r\n\r\nAs a result it's not detecting the confirmed coins I sent to the Lnd / Zap wallet. It seems unable to perform the required rescan:\r\n\r\n```\r\nlncli newaddress p2wkh\r\n[lncli] rpc error: code = Unknown desc = Rescan is already done and cannot be updated. It returned error: unable to fetch cfilter`\r\n```\r\n\r\nThere's different maxima for `getcfilters` from `getcfheaders`: https://github.com/bitcoin/bips/blob/master/bip-0157.mediawiki#getcfilters\r\n\r\n`getcfilters`:\r\n\r\n> 3. The height of the block with hash StopHash MUST be greater than or equal to StartHeight, and the difference MUST be strictly less than 100.\r\n\r\n`getcfheaders`:\r\n\r\n> 3. The height of the block with hash StopHash MUST be greater than or equal to StartHeight, and the difference MUST be strictly less than 2,000.\r\n\r\nBtcd uses the wrong value for `getcfilters`: https://github.com/btcsuite/btcd/blob/master/wire/msggetcfilters.go#L15\r\n\r\nPR: https://github.com/btcsuite/btcd/pull/1482 (makes the error go away, and now it finds the UTXO)",
      "created_at" : "2019-10-23T09:52:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-545364727",
      "id" : 545364727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NTM2NDcyNw==",
      "updated_at" : "2019-10-23T10:48:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/545364727",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Should there be a limit to how much filter data we give a peer? My Lnd is going berserk (https://github.com/lightningnetwork/lnd/issues/3630), and bitcoind happily sent it 15 GB of filters and counting:\r\n\r\n```\r\n{\r\n    \"id\": 1,\r\n    \"addr\": \"127.0.0.1:56456\",\r\n    ...\r\n    \"servicesnames\": [\r\n      \"WITNESS\"\r\n    ],\r\n    \"relaytxes\": false,\r\n    \"lastsend\": 1571830501,\r\n    \"lastrecv\": 1571830501,\r\n    \"bytessent\": 15615598004,\r\n    \"bytesrecv\": 514550,\r\n    \"conntime\": 1571829847,\r\n    \"version\": 70013,\r\n    \"subver\": \"/btcwire:0.5.0/neutrino:0.0.4-beta/\",\r\n    \"inbound\": true,\r\n    \"startingheight\": 600689,\r\n    \"banscore\": 0,\r\n    \"synced_headers\": -1,\r\n    \"synced_blocks\": -1,\r\n    \"inflight\": [],\r\n    \"whitelisted\": false,\r\n    \"permissions\": [\r\n      \"noban\",\r\n      \"relay\",\r\n      \"mempool\"\r\n    ],\r\n    \"minfeefilter\": 0,\r\n    \"bytessent_per_msg\": {\r\n      \"addr\": 30192,\r\n      \"block\": 140862657,\r\n      \"cfheaders\": 854,\r\n      \"cfilter\": 15474702573,\r\n      \"feefilter\": 32,\r\n      \"getdata\": 61,\r\n      \"headers\": 742,\r\n      \"inv\": 366,\r\n      \"ping\": 192,\r\n      \"pong\": 160,\r\n      \"sendheaders\": 24,\r\n      \"verack\": 24,\r\n      \"version\": 127\r\n    },\r\n    \"bytesrecv_per_msg\": {\r\n      \"*other*\": 496906,\r\n      \"getaddr\": 24,\r\n      \"getdata\": 8723,\r\n      \"getheaders\": 7339,\r\n      \"inv\": 1037,\r\n      \"ping\": 160,\r\n      \"pong\": 192,\r\n      \"verack\": 24,\r\n      \"version\": 145\r\n    }\r\n  }\r\n```",
      "created_at" : "2019-10-23T11:38:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-545402053",
      "id" : 545402053,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NTQwMjA1Mw==",
      "updated_at" : "2019-10-23T11:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/545402053",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-10-30T12:11:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-547871444",
      "id" : 547871444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0Nzg3MTQ0NA==",
      "updated_at" : "2019-10-30T12:11:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547871444",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@Sjors Why would you limit filter data? We don't limit the amount of block data served to a peer...",
      "created_at" : "2019-10-31T13:46:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-548382656",
      "id" : 548382656,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0ODM4MjY1Ng==",
      "updated_at" : "2019-10-31T13:46:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548382656",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jimpo indeed, we discussed this during the IRC meeting. No need to rate limit this specific message.",
      "created_at" : "2019-11-02T17:30:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-549064548",
      "id" : 549064548,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0OTA2NDU0OA==",
      "updated_at" : "2019-11-02T17:30:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549064548",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ping @jimpo for a rebase. Looking to review shortly.",
      "created_at" : "2019-11-04T21:03:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-549545829",
      "id" : 549545829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0OTU0NTgyOQ==",
      "updated_at" : "2019-11-04T21:03:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549545829",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "There's still some ongoing discussion about `getcfilters` limit in the BIP https://github.com/bitcoin/bips/pull/857 (cc @TheBlueMatt, @harding)",
      "created_at" : "2019-11-11T12:55:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-552434757",
      "id" : 552434757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MjQzNDc1Nw==",
      "updated_at" : "2019-11-11T12:55:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/552434757",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r346092157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/346092157"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In any case, can you simply modify `nLocalServices` directly when the index has finished syncing? Or does other code that accesses it directly need to see the bit set even before sync is done?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-14T01:47:08Z",
      "diff_hunk" : "@@ -2597,7 +2599,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r346092157",
      "id" : 346092157,
      "in_reply_to_id" : 308415562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NjA5MjE1Nw==",
      "original_commit_id" : "c6f73db3abe2835fc14b5b4d434008f6613ee450",
      "original_line" : 2651,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 316669244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/346092157",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Note that if you want to use the new max limit, youâll need to do something closer to what we do for getdatas - dumping the full set of requested filters into the send buffer opens us up to a massive dos attack (based purely on Hardingâs estimated size I havenât checked the match myself).\n\n> On Nov 11, 2019, at 07:55, Sjors Provoost <notifications@github.com> wrote:\n> \n> ï»¿\n> There's still some ongoing discussion about getcfilters limit in the BIP bitcoin/bips#857 (cc @TheBlueMatt, @harding)\n> \n> â\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub, or unsubscribe.\n",
      "created_at" : "2019-11-14T02:02:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-553689319",
      "id" : 553689319,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MzY4OTMxOQ==",
      "updated_at" : "2019-11-14T02:02:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/553689319",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Should net_processing maintain a queue of filter messages (20 kb each) we want to send, and then drip them out 10(?) at a time each time `SendMessages` is called? Or not even the messages themselves, but instead construct on the fly?",
      "created_at" : "2019-11-14T10:56:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-553835807",
      "id" : 553835807,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MzgzNTgwNw==",
      "updated_at" : "2019-11-14T10:57:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/553835807",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "See ProcessGetData - we'll want to do that, yea, keep a queue of what was requested and, just like ProcessGetData, hit that every time we get to ProcessMessage for the peer or SendMessages for the peer, and do nothing else until afterwards. In fact, why is there a new message for fetching these things anyway? Is there any reason to not literally just do it via invs? Would be a smaller diff and pretty in-line with the point of getdata anyway.",
      "created_at" : "2019-11-15T21:33:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-554537231",
      "id" : 554537231,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDUzNzIzMQ==",
      "updated_at" : "2019-11-15T21:33:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554537231",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. This looks really good. The commits are nicely laid out and the change set is very easy to follow. I haven't yet done a in-depth review, but I've skimmed through the code and have some high-level feedback:\r\n\r\n- some of the later commits could be squashed into earlier commits to avoid code churn (eg _net: Raise MAX_GETCFILTERS_SIZE following change to BIP 158._ into _net: Message handling for GETCFILTERS._ and _init: Separate CLI flag for block filter index and serving cfilters._ into _net: Define new BIP 157 protocol messages._)\r\n- I don't like the code in net.cpp that accesses the indexer to set the service flags. As well as introducing an unpleasant coupling between net and the indexer, it seems to go against the common understanding of what service flags represent (capabilities rather than current node state)\r\n- Can the compact filter checkpoints be cached in the indexer rather than net_processing? It seems strange to have net_processing burdened with storing index data and its `UpdatedBlockTip()` callback being used to update that cache. The index is already a validationinterface client. Can't it handle updating and serving data from its own cache?",
      "created_at" : "2019-11-18T23:21:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-555256244",
      "id" : 555256244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTI1NjI0NA==",
      "updated_at" : "2019-11-18T23:21:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555256244",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r347724051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347724051"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should be the previous filter header and a vector of filter hashes.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-19T04:13:52Z",
      "diff_hunk" : "@@ -230,6 +230,43 @@ extern const char *GETBLOCKTXN;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+\n+/**\n+ * getcfilters requests compact filters for a range of blocks.\n+ * Only available with service bit NODE_COMPACT_FILTERS as described by\n+ * BIP 157 & 158.\n+ */\n+extern const char *GETCFILTERS;\n+/**\n+ * cfilter is a response to a getcfilters request containing a single compact\n+ * filter.\n+ */\n+extern const char *CFILTER;\n+/**\n+ * getcfheaders requests compact filter headers for a range of blocks.\n+ * Only available with service bit NODE_COMPACT_FILTERS as described by\n+ * BIP 157 & 158.\n+ */\n+extern const char *GETCFHEADERS;\n+/**\n+ * cfheaders is a response to a getcfheaders request containing a vector of\n+ * filter headers for each block in the requested range.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r347724051",
      "id" : 347724051,
      "line" : 257,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzcyNDA1MQ==",
      "original_commit_id" : "06cd88c6bc822f327b74e1f619dc06fd370f8de3",
      "original_line" : 257,
      "original_position" : 24,
      "original_start_line" : 252,
      "path" : "src/protocol.h",
      "position" : 24,
      "pull_request_review_id" : 318775518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : 256,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347724051",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r347726881"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347726881"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would this logic be more suitable encapsulated as a method of `CNode`?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-19T04:31:58Z",
      "diff_hunk" : "@@ -1880,6 +1883,98 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r347726881",
      "id" : 347726881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzcyNjg4MQ==",
      "original_commit_id" : "aaceafd7497afe7f6f6cdf07fbdbf6cbfe7079ef",
      "original_line" : 2029,
      "original_position" : 40,
      "original_start_line" : 1897,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 318775518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347726881",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348203012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348203012"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What do you mean by this comment? Looking at the tests, it seems like we should be able to retrieve filters, headers and checkpoint headers on stale chains.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-19T22:27:35Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    std::vector<BlockFilter> filters;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filters]{ return filter_index->LookupFilterRange(start_height, stop_index, filters); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    for (const auto& filter : filters) {\n+        CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+            .Make(NetMsgType::CFILTER, filter);\n+        connman->PushMessage(pfrom, std::move(msg));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {\n+        const CBlockIndex* prev_block = stop_index->GetAncestor(start_height - 1);\n+        bool lookup_success = QueryFilterIndexWithRetry(\n+            filter_index, index_in_sync,\n+            [=, &prev_header]{ return filter_index->LookupFilterHeader(prev_block, prev_header); }\n+        );\n+        if (!lookup_success) {\n+            return error(\"Failed to find block filter header in index: filter_type=%s, block_hash=%s\",\n+                         BlockFilterTypeName(filter_type), prev_block->GetBlockHash().ToString());\n+        }\n+    }\n+\n+    std::vector<uint256> filter_hashes;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filter_hashes]{ return filter_index->LookupFilterHashRange(start_height, stop_index, filter_hashes); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter hashes in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+        .Make(NetMsgType::CFHEADERS,\n+              filter_type_ser,\n+              stop_index->GetBlockHash(),\n+              prev_header,\n+              filter_hashes);\n+    connman->PushMessage(pfrom, std::move(msg));\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFCheckPt(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, /*start_height=*/0, stop_hash,\n+                                   /*max_height_diff=*/std::numeric_limits<uint32_t>::max(),\n+                                   stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    std::vector<uint256> headers(stop_index->nHeight / CFCHECKPT_INTERVAL);\n+    {\n+        std::lock_guard<std::mutex> _lock(active_chain_cf_headers_mtx);\n+\n+        bool index_in_sync = false;\n+\n+        // Populate headers.\n+        int i = headers.size() - 1;\n+        const CBlockIndex* block_index = stop_index;\n+        for (; i >= 0; i--) {\n+            uint32_t height = (i + 1) * CFCHECKPT_INTERVAL;\n+            block_index = block_index->GetAncestor(height);\n+\n+            if (static_cast<size_t>(i) < active_chain_cf_headers.size() &&\n+                active_chain_cf_headers[i].first == block_index) {\n+                break;\n+            }\n+\n+            // Filter header requested for stale block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348203012",
      "id" : 348203012,
      "line" : 2193,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODIwMzAxMg==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2193,
      "original_position" : 309,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 267,
      "pull_request_review_id" : 319398156,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348203012",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348231611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348231611"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Looks like you are swallowing the return value below. Can this function be void instead? Or is this a common pattern when you want to log and return early?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-19T23:59:56Z",
      "diff_hunk" : "@@ -1221,6 +1226,40 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     });\n }\n \n+static bool UpdateCFHeadersCache(const BlockFilterIndex& filter_index)\n+{\n+    LOCK(cs_main);\n+    std::lock_guard<std::mutex> _lock(active_chain_cf_headers_mtx);\n+\n+    const CChain& active_chain = ::ChainActive();\n+\n+    // Drop any entries in the checkpoint cache that have been reorganized off the active chain.\n+    int new_size = active_chain_cf_headers.size();\n+    for (; new_size > 0; new_size--) {\n+        if (active_chain.Contains(active_chain_cf_headers[new_size - 1].first)) {\n+            break;\n+        }\n+    }\n+    active_chain_cf_headers.resize(new_size);\n+\n+    // Populate the checkpoint cache with headers for blocks on the active chain.\n+    for (uint32_t height = (new_size + 1) * CFCHECKPT_INTERVAL;\n+         height <= static_cast<uint32_t>(active_chain.Height());\n+         height += CFCHECKPT_INTERVAL) {\n+        const CBlockIndex* block_index = active_chain[height];\n+        uint256 filter_header;\n+\n+        if (!filter_index.LookupFilterHeader(block_index, filter_header)) {\n+            return error(\"Failed to find block filter header in index: filter_type=%s, block_hash=%s\",\n+                         BlockFilterTypeName(filter_index.GetFilterType()),\n+                         block_index->GetBlockHash().ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348231611",
      "id" : 348231611,
      "line" : 1333,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODIzMTYxMQ==",
      "original_commit_id" : "878825452632fc053e4e9565338c1f42c14d94f1",
      "original_line" : 1333,
      "original_position" : 49,
      "original_start_line" : 1253,
      "path" : "src/net_processing.cpp",
      "position" : 74,
      "pull_request_review_id" : 318775518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : 1331,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348231611",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348235765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348235765"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The preceding condition is checking if the cfheader (i.e. filter header) is cached and thus for a block on the active chain. It breaks early and populates the remaining results from the cache. The comment here is for stale blocks where an index lookup is required since the filter header won't be in the cache. Once the active chain is reached (on a later iteration) the loop breaks and the cache is used.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-20T00:16:41Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    std::vector<BlockFilter> filters;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filters]{ return filter_index->LookupFilterRange(start_height, stop_index, filters); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    for (const auto& filter : filters) {\n+        CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+            .Make(NetMsgType::CFILTER, filter);\n+        connman->PushMessage(pfrom, std::move(msg));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {\n+        const CBlockIndex* prev_block = stop_index->GetAncestor(start_height - 1);\n+        bool lookup_success = QueryFilterIndexWithRetry(\n+            filter_index, index_in_sync,\n+            [=, &prev_header]{ return filter_index->LookupFilterHeader(prev_block, prev_header); }\n+        );\n+        if (!lookup_success) {\n+            return error(\"Failed to find block filter header in index: filter_type=%s, block_hash=%s\",\n+                         BlockFilterTypeName(filter_type), prev_block->GetBlockHash().ToString());\n+        }\n+    }\n+\n+    std::vector<uint256> filter_hashes;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filter_hashes]{ return filter_index->LookupFilterHashRange(start_height, stop_index, filter_hashes); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter hashes in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+        .Make(NetMsgType::CFHEADERS,\n+              filter_type_ser,\n+              stop_index->GetBlockHash(),\n+              prev_header,\n+              filter_hashes);\n+    connman->PushMessage(pfrom, std::move(msg));\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFCheckPt(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, /*start_height=*/0, stop_hash,\n+                                   /*max_height_diff=*/std::numeric_limits<uint32_t>::max(),\n+                                   stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    std::vector<uint256> headers(stop_index->nHeight / CFCHECKPT_INTERVAL);\n+    {\n+        std::lock_guard<std::mutex> _lock(active_chain_cf_headers_mtx);\n+\n+        bool index_in_sync = false;\n+\n+        // Populate headers.\n+        int i = headers.size() - 1;\n+        const CBlockIndex* block_index = stop_index;\n+        for (; i >= 0; i--) {\n+            uint32_t height = (i + 1) * CFCHECKPT_INTERVAL;\n+            block_index = block_index->GetAncestor(height);\n+\n+            if (static_cast<size_t>(i) < active_chain_cf_headers.size() &&\n+                active_chain_cf_headers[i].first == block_index) {\n+                break;\n+            }\n+\n+            // Filter header requested for stale block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348235765",
      "id" : 348235765,
      "in_reply_to_id" : 348203012,
      "line" : 2193,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODIzNTc2NQ==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2193,
      "original_position" : 309,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 267,
      "pull_request_review_id" : 318775518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348235765",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348246889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348246889"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Both the interface and implementation of `QueryFilterIndexWithRetry` are quite complex and a bit difficult to reason about, especially when the output parameter `in_sync` is not used by the caller.\r\n\r\nWould it be detrimental to first unconditionally call `index->BlockUntilSyncedToCurrentChain()` at each call site instead of only calling it before retrying? It would make the code more readable by eliminating the retry function and all the complexities around it (e.g. output parameter dependency).",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-20T01:02:55Z",
      "diff_hunk" : "@@ -1998,17 +2022,27 @@ static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainPa\n         return true;\n     }\n \n+    bool index_in_sync = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348246889",
      "id" : 348246889,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODI0Njg4OQ==",
      "original_commit_id" : "7a05bb6cb94902ba7ab442134b7c52f5813e4280",
      "original_line" : 2025,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 318775518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348246889",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jnewbery @jkczyz Thanks for the reviews!\r\n\r\nOn point 2, I've heard the feedback that dynamically switching the service flags is a bad idea a few times. I also don't like the idea of leaving the service flag on before the index is in sync as it complicates client logic. Maybe it's OK to just not allow the `-peercfilters` flag until the index is in sync. So the user experience is that a fresh node can turn on all the flags, but a node that is in sync without the index will first need to run with `-blockfilterindex=basic` until in sync, then the node operator restarts with the `-peercfilters` flag.\r\n\r\nOn point 3, my reasoning is that the concept of checkpoints, including the checkpoint interval parameter, is specific to the net layer. But I don't think there's too much harm in moving that to the `BlockFilterIndex` and probably is a bit cleaner, so I'd be happy to make that change.",
      "created_at" : "2019-11-20T13:02:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-555994220",
      "id" : 555994220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTk5NDIyMA==",
      "updated_at" : "2019-11-20T13:02:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555994220",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@TheBlueMatt \r\n\r\n> See ProcessGetData - we'll want to do that, yea, keep a queue of what was requested and, just like ProcessGetData, hit that every time we get to ProcessMessage for the peer or SendMessages for the peer, and do nothing else until afterwards. In fact, why is there a new message for fetching these things anyway? Is there any reason to not literally just do it via invs? Would be a smaller diff and pretty in-line with the point of getdata anyway.\r\n\r\nThe rationale is that filters are much smaller than blocks so it's not worthwhile to send a `getdata` for each individual filter. And unlike transactions, which may be of a similar size if not smaller, block filters can be queried more efficiently than individually by specifying a range of blocks. \r\n\r\nA pretty hacky idea might be to getdata with `MSG_BLOCK_FILTER` where the inv is the first 30 bytes of the block hash and the last 2 bytes (which should be 0 due to min difficulty) are replaced by the number of preceding block filters, allowing one to effectively encode a range of blocks into an inv message.",
      "created_at" : "2019-11-20T13:20:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-556000306",
      "id" : 556000306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NjAwMDMwNg==",
      "updated_at" : "2019-11-20T14:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/556000306",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348631764"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348631764"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: could print a message to logs in this case too IMO.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-20T17:01:45Z",
      "diff_hunk" : "@@ -2645,7 +2647,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {\n+        BlockFilterIndex* basic_filter_index = GetBlockFilterIndex(BlockFilterType::BASIC);\n+        if (!basic_filter_index) {\n+            LogPrintf(\"WARNING: NODE_COMPACT_FILTERS is signaled, but filter index is not available\\n\");\n+        }\n+        if (!basic_filter_index || !basic_filter_index->IsSynced()) {\n+            // If block filter index is still syncing, do not advertise the service bit.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348631764",
      "id" : 348631764,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODYzMTc2NA==",
      "original_commit_id" : "dd577bef3c4e1f227809a71ad43679b4548fbacf",
      "original_line" : 2657,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 320126712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348631764",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348651034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348651034"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, the return value of this function is ignored, but returning a success indicator is a pretty common pattern and I don't see any downside.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-20T17:39:34Z",
      "diff_hunk" : "@@ -1221,6 +1226,40 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     });\n }\n \n+static bool UpdateCFHeadersCache(const BlockFilterIndex& filter_index)\n+{\n+    LOCK(cs_main);\n+    std::lock_guard<std::mutex> _lock(active_chain_cf_headers_mtx);\n+\n+    const CChain& active_chain = ::ChainActive();\n+\n+    // Drop any entries in the checkpoint cache that have been reorganized off the active chain.\n+    int new_size = active_chain_cf_headers.size();\n+    for (; new_size > 0; new_size--) {\n+        if (active_chain.Contains(active_chain_cf_headers[new_size - 1].first)) {\n+            break;\n+        }\n+    }\n+    active_chain_cf_headers.resize(new_size);\n+\n+    // Populate the checkpoint cache with headers for blocks on the active chain.\n+    for (uint32_t height = (new_size + 1) * CFCHECKPT_INTERVAL;\n+         height <= static_cast<uint32_t>(active_chain.Height());\n+         height += CFCHECKPT_INTERVAL) {\n+        const CBlockIndex* block_index = active_chain[height];\n+        uint256 filter_header;\n+\n+        if (!filter_index.LookupFilterHeader(block_index, filter_header)) {\n+            return error(\"Failed to find block filter header in index: filter_type=%s, block_hash=%s\",\n+                         BlockFilterTypeName(filter_index.GetFilterType()),\n+                         block_index->GetBlockHash().ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348651034",
      "id" : 348651034,
      "in_reply_to_id" : 348231611,
      "line" : 1333,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODY1MTAzNA==",
      "original_commit_id" : "878825452632fc053e4e9565338c1f42c14d94f1",
      "original_line" : 1333,
      "original_position" : 49,
      "original_start_line" : 1253,
      "path" : "src/net_processing.cpp",
      "position" : 74,
      "pull_request_review_id" : 320151775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : 1331,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348651034",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348652799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348652799"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't see any places where it's duplicated, so I don't feel the need to move it.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-20T17:43:21Z",
      "diff_hunk" : "@@ -1880,6 +1883,98 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348652799",
      "id" : 348652799,
      "in_reply_to_id" : 347726881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODY1Mjc5OQ==",
      "original_commit_id" : "aaceafd7497afe7f6f6cdf07fbdbf6cbfe7079ef",
      "original_line" : 2029,
      "original_position" : 40,
      "original_start_line" : 1897,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 320154084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348652799",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348654175"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348654175"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I agree that `QueryFilterIndexWithRetry` is quite ugly, but I really don't like the idea of blocking the net thread on background processing unless necessary. In fact, I don't like the idea of doing it at all, but there's not really infrastructure for doing proper async logic here.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-20T17:46:19Z",
      "diff_hunk" : "@@ -1998,17 +2022,27 @@ static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainPa\n         return true;\n     }\n \n+    bool index_in_sync = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r348654175",
      "id" : 348654175,
      "in_reply_to_id" : 348246889,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODY1NDE3NQ==",
      "original_commit_id" : "7a05bb6cb94902ba7ab442134b7c52f5813e4280",
      "original_line" : 2025,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 320155847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348654175",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`NODE_COMPACT_FILTERS` should be added to [GetServicesNames](https://github.com/bitcoin/bitcoin/blob/master/src/rpc/util.cpp#L735)",
      "created_at" : "2019-11-20T21:58:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-556453838",
      "id" : 556453838,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NjQ1MzgzOA==",
      "updated_at" : "2019-11-20T21:58:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/556453838",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/15256660?v=4",
         "events_url" : "https://api.github.com/users/benthecarman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benthecarman/followers",
         "following_url" : "https://api.github.com/users/benthecarman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benthecarman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benthecarman",
         "id" : 15256660,
         "login" : "benthecarman",
         "node_id" : "MDQ6VXNlcjE1MjU2NjYw",
         "organizations_url" : "https://api.github.com/users/benthecarman/orgs",
         "received_events_url" : "https://api.github.com/users/benthecarman/received_events",
         "repos_url" : "https://api.github.com/users/benthecarman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benthecarman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benthecarman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benthecarman"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349259713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349259713"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: trivial, could be `noexcept`",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T18:53:22Z",
      "diff_hunk" : "@@ -85,19 +85,23 @@ class BaseIndex : public CValidationInterface\n \n     virtual DB& GetDB() const = 0;\n \n-    /// Get the name of the index for display in logs.\n-    virtual const char* GetName() const = 0;\n-\n public:\n     /// Destructor interrupts sync thread if running and blocks until it exits.\n     virtual ~BaseIndex();\n \n+    /// Get the name of the index for display in logs.\n+    virtual const char* GetName() const = 0;\n+\n+    /// Returns whether index has completed the initial sync with the active chain.\n+    /// After returning true once, this function will return true on all subsequent calls.\n+    bool IsSynced() const { return m_synced; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349259713",
      "id" : 349259713,
      "line" : 96,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI1OTcxMw==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 96,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 16,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349259713",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349260084"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349260084"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be **const** bool index_enabled",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T18:54:03Z",
      "diff_hunk" : "@@ -946,6 +947,18 @@ bool AppInitParameterInteraction()\n         }\n     }\n \n+    // Signal NODE_COMPACT_FILTERS if peercfilters and required index are both enabled.\n+    if (gArgs.GetBoolArg(\"-peercfilters\", DEFAULT_PEERCFILTERS)) {\n+        bool index_enabled = std::find(g_enabled_filter_types.begin(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349260084",
      "id" : 349260084,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI2MDA4NA==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 952,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349260084",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349263563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349263563"
         }
      },
      "author_association" : "NONE",
      "body" : "Kinda off-topic I guess, bug locking two mutex'es makes you think, maybe bitcoin codebase would need something like `std::lock`, or better `std::scoped_lock` (C++17) to lock multiple locks in deadlock-free way, with same LOCK() debugging features.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:01:09Z",
      "diff_hunk" : "@@ -1214,6 +1226,40 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     });\n }\n \n+static bool UpdateCFHeadersCache(const BlockFilterIndex& filter_index)\n+{\n+    LOCK(cs_main);\n+    std::lock_guard<std::mutex> _lock(active_chain_cf_headers_mtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349263563",
      "id" : 349263563,
      "line" : 1310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI2MzU2Mw==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 1310,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 51,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349263563",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349267940"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349267940"
         }
      },
      "author_association" : "NONE",
      "body" : "Suggestion: consider simplifying this bit to remove these manual \"off-by-one'ness-ness\" like `>`, `-1`, etc, using reverse iterators and `find_if`, with something like this:\r\n```\r\nconst auto it = std::find_if(active_chain_cf_headers.crbegin(), active_chain_cf_headers.crend(), [&](const std::pair<const CBlockIndex*, uint256> &i) {\r\n    return active_chain.Contains(i.first);\r\n});\r\nactive_chain_cf_headers.erase(it.base(), active_chain_cf_headers.cend());\r\n```\r\nlater `(new_size + 1)` obviously can be changed into `active_chain_cf_headers.size()`.\r\n\r\nThis method be toyed-with using this trivial example:\r\n```\r\n#include <algorithm>\r\n#include <iostream>\r\n#include <iterator>\r\n#include <vector>\r\n\r\nint main()\r\n{\r\n    std::vector<int> vals{1, 1, 0, 0, 0};\r\n\r\n    const auto it = std::find_if(vals.crbegin(), vals.crend(), [](int v) -> bool {\r\n        return v > 0;\r\n    });\r\n\r\n    vals.erase(it.base(), vals.cend());\r\n\r\n    std::copy(vals.cbegin(),\r\n              vals.cend(),\r\n              std::ostream_iterator<int>(std::cout, \" \"));\r\n}\r\n```",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:11:09Z",
      "diff_hunk" : "@@ -1214,6 +1226,40 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     });\n }\n \n+static bool UpdateCFHeadersCache(const BlockFilterIndex& filter_index)\n+{\n+    LOCK(cs_main);\n+    std::lock_guard<std::mutex> _lock(active_chain_cf_headers_mtx);\n+\n+    const CChain& active_chain = ::ChainActive();\n+\n+    // Drop any entries in the checkpoint cache that have been reorganized off the active chain.\n+    int new_size = active_chain_cf_headers.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349267940",
      "id" : 349267940,
      "line" : 1315,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI2Nzk0MA==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 1315,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 56,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349267940",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349268350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349268350"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be const CBlockIndex* **const** block_index",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:11:57Z",
      "diff_hunk" : "@@ -1214,6 +1226,40 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     });\n }\n \n+static bool UpdateCFHeadersCache(const BlockFilterIndex& filter_index)\n+{\n+    LOCK(cs_main);\n+    std::lock_guard<std::mutex> _lock(active_chain_cf_headers_mtx);\n+\n+    const CChain& active_chain = ::ChainActive();\n+\n+    // Drop any entries in the checkpoint cache that have been reorganized off the active chain.\n+    int new_size = active_chain_cf_headers.size();\n+    for (; new_size > 0; new_size--) {\n+        if (active_chain.Contains(active_chain_cf_headers[new_size - 1].first)) {\n+            break;\n+        }\n+    }\n+    active_chain_cf_headers.resize(new_size);\n+\n+    // Populate the checkpoint cache with headers for blocks on the active chain.\n+    for (uint32_t height = (new_size + 1) * CFCHECKPT_INTERVAL;\n+         height <= static_cast<uint32_t>(active_chain.Height());\n+         height += CFCHECKPT_INTERVAL) {\n+        const CBlockIndex* block_index = active_chain[height];",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349268350",
      "id" : 349268350,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI2ODM1MA==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 1249,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349268350",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349268778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349268778"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be **const** bool supported_filter_type",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:13:00Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349268778",
      "id" : 349268778,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI2ODc3OA==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 1944,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349268778",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349270345"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349270345"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be **const** BlockFilterType filter_type",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:16:29Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349270345",
      "id" : 349270345,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI3MDM0NQ==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2018,
      "original_position" : 186,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349270345",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349271947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349271947"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be **const** bool lookup_success",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:19:54Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    std::vector<BlockFilter> filters;\n+    bool lookup_success = QueryFilterIndexWithRetry(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349271947",
      "id" : 349271947,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI3MTk0Nw==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2031,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349271947",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349272389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349272389"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be **const** BlockFilterType filter_type",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:20:52Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    std::vector<BlockFilter> filters;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filters]{ return filter_index->LookupFilterRange(start_height, stop_index, filters); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    for (const auto& filter : filters) {\n+        CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+            .Make(NetMsgType::CFILTER, filter);\n+        connman->PushMessage(pfrom, std::move(msg));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349272389",
      "id" : 349272389,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI3MjM4OQ==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2058,
      "original_position" : 226,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349272389",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349274558"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349274558"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be const CBlockIndex* **const** prev_block\r\n\r\nAlso, IDE notes about `start_height - 1` being implicitly converted to `int` (`GetAncestor()` takes int), maybe worth \"documenting\"/\"warning\" by using `static_cast`? Though maybe overkill, idk.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:25:17Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    std::vector<BlockFilter> filters;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filters]{ return filter_index->LookupFilterRange(start_height, stop_index, filters); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    for (const auto& filter : filters) {\n+        CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+            .Make(NetMsgType::CFILTER, filter);\n+        connman->PushMessage(pfrom, std::move(msg));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {\n+        const CBlockIndex* prev_block = stop_index->GetAncestor(start_height - 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349274558",
      "id" : 349274558,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI3NDU1OA==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2072,
      "original_position" : 240,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349274558",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349274727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349274727"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be **const** bool lookup_success",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:25:36Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    std::vector<BlockFilter> filters;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filters]{ return filter_index->LookupFilterRange(start_height, stop_index, filters); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    for (const auto& filter : filters) {\n+        CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+            .Make(NetMsgType::CFILTER, filter);\n+        connman->PushMessage(pfrom, std::move(msg));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {\n+        const CBlockIndex* prev_block = stop_index->GetAncestor(start_height - 1);\n+        bool lookup_success = QueryFilterIndexWithRetry(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349274727",
      "id" : 349274727,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI3NDcyNw==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2073,
      "original_position" : 241,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349274727",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349275064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349275064"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: ditto, could be **const** bool lookup_success",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:26:20Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    std::vector<BlockFilter> filters;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filters]{ return filter_index->LookupFilterRange(start_height, stop_index, filters); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    for (const auto& filter : filters) {\n+        CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+            .Make(NetMsgType::CFILTER, filter);\n+        connman->PushMessage(pfrom, std::move(msg));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {\n+        const CBlockIndex* prev_block = stop_index->GetAncestor(start_height - 1);\n+        bool lookup_success = QueryFilterIndexWithRetry(\n+            filter_index, index_in_sync,\n+            [=, &prev_header]{ return filter_index->LookupFilterHeader(prev_block, prev_header); }\n+        );\n+        if (!lookup_success) {\n+            return error(\"Failed to find block filter header in index: filter_type=%s, block_hash=%s\",\n+                         BlockFilterTypeName(filter_type), prev_block->GetBlockHash().ToString());\n+        }\n+    }\n+\n+    std::vector<uint256> filter_hashes;\n+    bool lookup_success = QueryFilterIndexWithRetry(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349275064",
      "id" : 349275064,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI3NTA2NA==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2084,
      "original_position" : 252,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349275064",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349275707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349275707"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be **const** BlockFilterType filter_type",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:27:37Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    std::vector<BlockFilter> filters;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filters]{ return filter_index->LookupFilterRange(start_height, stop_index, filters); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    for (const auto& filter : filters) {\n+        CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+            .Make(NetMsgType::CFILTER, filter);\n+        connman->PushMessage(pfrom, std::move(msg));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {\n+        const CBlockIndex* prev_block = stop_index->GetAncestor(start_height - 1);\n+        bool lookup_success = QueryFilterIndexWithRetry(\n+            filter_index, index_in_sync,\n+            [=, &prev_header]{ return filter_index->LookupFilterHeader(prev_block, prev_header); }\n+        );\n+        if (!lookup_success) {\n+            return error(\"Failed to find block filter header in index: filter_type=%s, block_hash=%s\",\n+                         BlockFilterTypeName(filter_type), prev_block->GetBlockHash().ToString());\n+        }\n+    }\n+\n+    std::vector<uint256> filter_hashes;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filter_hashes]{ return filter_index->LookupFilterHashRange(start_height, stop_index, filter_hashes); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter hashes in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+        .Make(NetMsgType::CFHEADERS,\n+              filter_type_ser,\n+              stop_index->GetBlockHash(),\n+              prev_header,\n+              filter_hashes);\n+    connman->PushMessage(pfrom, std::move(msg));\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFCheckPt(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349275707",
      "id" : 349275707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI3NTcwNw==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2112,
      "original_position" : 280,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349275707",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349276315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349276315"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: could be **const** bool lookup_success",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T19:28:55Z",
      "diff_hunk" : "@@ -1880,6 +1930,240 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)\n+{\n+    while (!fn()) {\n+        if (in_sync) {\n+            return false;\n+        }\n+        if (!index->BlockUntilSyncedToCurrentChain()) {\n+            return error(\"%s is not ready yet\", index->GetName());\n+        }\n+        in_sync = true;\n+    }\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    std::vector<BlockFilter> filters;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filters]{ return filter_index->LookupFilterRange(start_height, stop_index, filters); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    for (const auto& filter : filters) {\n+        CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+            .Make(NetMsgType::CFILTER, filter);\n+        connman->PushMessage(pfrom, std::move(msg));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    bool index_in_sync = false;\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {\n+        const CBlockIndex* prev_block = stop_index->GetAncestor(start_height - 1);\n+        bool lookup_success = QueryFilterIndexWithRetry(\n+            filter_index, index_in_sync,\n+            [=, &prev_header]{ return filter_index->LookupFilterHeader(prev_block, prev_header); }\n+        );\n+        if (!lookup_success) {\n+            return error(\"Failed to find block filter header in index: filter_type=%s, block_hash=%s\",\n+                         BlockFilterTypeName(filter_type), prev_block->GetBlockHash().ToString());\n+        }\n+    }\n+\n+    std::vector<uint256> filter_hashes;\n+    bool lookup_success = QueryFilterIndexWithRetry(\n+        filter_index, index_in_sync,\n+        [=, &filter_hashes]{ return filter_index->LookupFilterHashRange(start_height, stop_index, filter_hashes); }\n+    );\n+    if (!lookup_success) {\n+        return error(\"Failed to find block filter hashes in index: filter_type=%s, start_height=%d, stop_hash=%s\",\n+                     BlockFilterTypeName(filter_type), start_height, stop_hash.ToString());\n+    }\n+\n+    CSerializedNetMsg msg = CNetMsgMaker(pfrom->GetSendVersion())\n+        .Make(NetMsgType::CFHEADERS,\n+              filter_type_ser,\n+              stop_index->GetBlockHash(),\n+              prev_header,\n+              filter_hashes);\n+    connman->PushMessage(pfrom, std::move(msg));\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFCheckPt(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, /*start_height=*/0, stop_hash,\n+                                   /*max_height_diff=*/std::numeric_limits<uint32_t>::max(),\n+                                   stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    std::vector<uint256> headers(stop_index->nHeight / CFCHECKPT_INTERVAL);\n+    {\n+        std::lock_guard<std::mutex> _lock(active_chain_cf_headers_mtx);\n+\n+        bool index_in_sync = false;\n+\n+        // Populate headers.\n+        int i = headers.size() - 1;\n+        const CBlockIndex* block_index = stop_index;\n+        for (; i >= 0; i--) {\n+            uint32_t height = (i + 1) * CFCHECKPT_INTERVAL;\n+            block_index = block_index->GetAncestor(height);\n+\n+            if (static_cast<size_t>(i) < active_chain_cf_headers.size() &&\n+                active_chain_cf_headers[i].first == block_index) {\n+                break;\n+            }\n+\n+            // Filter header requested for stale block.\n+            bool lookup_success = QueryFilterIndexWithRetry(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349276315",
      "id" : 349276315,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTI3NjMxNQ==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 2142,
      "original_position" : 310,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321110460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349276315",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349366658"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349366658"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Duplication is one reason to refactor code, but there are others such as improving readability by hiding complexity. Compare:\r\n\r\n```c++\r\nif (!pfrom->SupportsBlockFilter(BlockFilterType::BASIC)) {\r\n    // ...\r\n}",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T23:18:55Z",
      "diff_hunk" : "@@ -1880,6 +1883,98 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349366658",
      "id" : 349366658,
      "in_reply_to_id" : 347726881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTM2NjY1OA==",
      "original_commit_id" : "aaceafd7497afe7f6f6cdf07fbdbf6cbfe7079ef",
      "original_line" : 2029,
      "original_position" : 40,
      "original_start_line" : 1897,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321251503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349366658",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349373734"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349373734"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That seems like an orthogonal concern to my point. From what I can tell, `BlockUntilSyncedToCurrentChain` won't block needlessly:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/46d6930f8c7ba7cbcd7d86dd5d0117642fcbc819/src/index/base.h#L95-L100\r\n\r\nThat is, it is short-circuited if the index is current:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/b2a6b0216192b6e8428f1a80b47f5178fccb961a/src/index/base.cpp#L282-L289\r\n\r\nSo in best case you would just verify that the index is caught up before querying it. And in worse case, you would block until caught up just as you're already doing in `QueryFilterIndexWithRetry`.\r\n\r\nWould also obliviate the need to address some of @Talkless's nits. ;)",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2019-11-21T23:43:44Z",
      "diff_hunk" : "@@ -1998,17 +2022,27 @@ static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainPa\n         return true;\n     }\n \n+    bool index_in_sync = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r349373734",
      "id" : 349373734,
      "in_reply_to_id" : 348246889,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTM3MzczNA==",
      "original_commit_id" : "7a05bb6cb94902ba7ab442134b7c52f5813e4280",
      "original_line" : 2025,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321251503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349373734",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "my `getnetworkinfo` shows:\r\n```\r\n\"localservicesnames\": [\r\n    \"NETWORK\",\r\n    \"WITNESS\",\r\n    \"NETWORK_LIMITED\"\r\n  ],\r\n```\r\nWhy I don't see `NODE_COMPACT_FILTERS`? `lnd` is working fine in my regtest setup, using `bitcoin.node=neutrino`, so it seems working (received mined coins into lnd wallet), just curious about that service flag.\r\n\r\nI've launched:\r\n```\r\n ./bitcoin-qt -chain=regtest\r\n```\r\nwhile my `bitcoin.conf` is:\r\n```\r\n[regtest]\r\nblockfilterindex=basic\r\npeercfilters=1\r\nserver=1\r\nlisten=1\r\nbind=0.0.0.0\r\n```",
      "created_at" : "2019-12-04T19:50:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-561811357",
      "id" : 561811357,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MTgxMTM1Nw==",
      "updated_at" : "2019-12-04T19:50:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/561811357",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Why I don't see `NODE_COMPACT_FILTERS`?\r\n\r\n@Talkless I believe that is because `GetServicesNames` hasn't been updated yet. See: https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-556453838\r\n",
      "created_at" : "2019-12-04T22:52:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-561876826",
      "id" : 561876826,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MTg3NjgyNg==",
      "updated_at" : "2019-12-04T22:52:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/561876826",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Uhg, I've missed that part. Thanks @marcinja .",
      "created_at" : "2019-12-05T17:08:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-562222259",
      "id" : 562222259,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MjIyMjI1OQ==",
      "updated_at" : "2019-12-05T17:08:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/562222259",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-01-02T21:14:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-570352074",
      "id" : 570352074,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MDM1MjA3NA==",
      "updated_at" : "2020-01-02T21:14:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/570352074",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363578596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363578596"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "aaceafd\r\n\r\nIs generic BIP 157 support can be checked at beginning of ProcessMessage like it's done for NODE_BLOOM ? It would avoid to busy ThreadMessageHandler for nothing?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-01-07T03:28:46Z",
      "diff_hunk" : "@@ -1880,6 +1883,98 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363578596",
      "id" : 363578596,
      "line" : 2028,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU3ODU5Ng==",
      "original_commit_id" : "aaceafd7497afe7f6f6cdf07fbdbf6cbfe7079ef",
      "original_line" : 2028,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 102,
      "pull_request_review_id" : 339014775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363578596",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363579193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363579193"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "aaceafd\r\n\r\nThis seems to assume than both client and server blockchain views are in sync. In case of diverging tips seen, client may be disconnected for a non-reprehensible request, just for being too fast ? (BlockRequestAllowed is for block which has been validated at least once)",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-01-07T03:33:07Z",
      "diff_hunk" : "@@ -1880,6 +1883,98 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363579193",
      "id" : 363579193,
      "line" : 2041,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU3OTE5Mw==",
      "original_commit_id" : "aaceafd7497afe7f6f6cdf07fbdbf6cbfe7079ef",
      "original_line" : 2041,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 115,
      "pull_request_review_id" : 339014775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363579193",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363579742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363579742"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "aaceafd\r\n\r\nAs you said, filter type support is already checked at first step. What does this check add ? ",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-01-07T03:36:37Z",
      "diff_hunk" : "@@ -1880,6 +1883,98 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363579742",
      "id" : 363579742,
      "line" : 2064,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU3OTc0Mg==",
      "original_commit_id" : "aaceafd7497afe7f6f6cdf07fbdbf6cbfe7079ef",
      "original_line" : 2064,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 339014775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363579742",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363579935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363579935"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "07dd762\r\n\r\nWhat the purpose of checking filters header availability before start of the range ? It seems like zeal on the bip",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-01-07T03:38:00Z",
      "diff_hunk" : "@@ -1975,6 +1977,51 @@ static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainPar\n     return true;\n }\n \n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363579935",
      "id" : 363579935,
      "line" : 2130,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU3OTkzNQ==",
      "original_commit_id" : "07dd76272cf5dc336594c03d32f0ddb107b10568",
      "original_line" : 2130,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 204,
      "pull_request_review_id" : 339014775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363579935",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363580053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363580053"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "07dd762\r\n\r\nnit: filter_headers, also log message",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-01-07T03:38:38Z",
      "diff_hunk" : "@@ -1975,6 +1977,51 @@ static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainPar\n     return true;\n }\n \n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {\n+        const CBlockIndex* prev_block = stop_index->GetAncestor(start_height - 1);\n+        if (!filter_index->LookupFilterHeader(prev_block, prev_header)) {\n+            return error(\"Failed to find block filter header in index: filter_type=%s, block_hash=%s\",\n+                         BlockFilterTypeName(filter_type), prev_block->GetBlockHash().ToString());\n+        }\n+    }\n+\n+    std::vector<uint256> filter_hashes;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363580053",
      "id" : 363580053,
      "line" : 2139,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4MDA1Mw==",
      "original_commit_id" : "07dd76272cf5dc336594c03d32f0ddb107b10568",
      "original_line" : 2139,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 213,
      "pull_request_review_id" : 339014775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363580053",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363580460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363580460"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "8788254\r\n\r\nWhat the perf improvement of caching checkpoints ? If clients are configured with trusted checkpoints, they are only going to use the higher range, or maybe a rolling checkpoints for last X headers/filters would be better as they are likely to be requested by everyone",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-01-07T03:41:23Z",
      "diff_hunk" : "@@ -396,6 +397,10 @@ limitedmap<uint256, std::chrono::microseconds> g_already_asked_for GUARDED_BY(cs\n /** Map maintaining per-node state. */\n static std::map<NodeId, CNodeState> mapNodeState GUARDED_BY(cs_main);\n \n+/** In-memory cache of all BIP157 compact filter checkpoints for the active chain. */\n+static std::vector<std::pair<const CBlockIndex*, uint256>> active_chain_cf_headers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363580460",
      "id" : 363580460,
      "line" : 441,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4MDQ2MA==",
      "original_commit_id" : "878825452632fc053e4e9565338c1f42c14d94f1",
      "original_line" : 441,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 38,
      "pull_request_review_id" : 339014775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363580460",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363580801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363580801"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "But you may have race condition between client and server where block isn't fully processed before request is handled, so client would have to bear this case anyway",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-01-07T03:43:38Z",
      "diff_hunk" : "@@ -1944,6 +1944,25 @@ static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_pa\n     return true;\n }\n \n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363580801",
      "id" : 363580801,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4MDgwMQ==",
      "original_commit_id" : "7a05bb6cb94902ba7ab442134b7c52f5813e4280",
      "original_line" : 1952,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 339014775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363580801",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363580980"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363580980"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "1b7fbb5\r\n\r\nIMO you can set -blockfilterindex by transivity if -peercfilters is already set, just mention it in the helper.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-01-07T03:44:58Z",
      "diff_hunk" : "@@ -946,6 +947,18 @@ bool AppInitParameterInteraction()\n         }\n     }\n \n+    // Signal NODE_COMPACT_FILTERS if peercfilters and required index are both enabled.\n+    if (gArgs.GetBoolArg(\"-peercfilters\", DEFAULT_PEERCFILTERS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r363580980",
      "id" : 363580980,
      "line" : 991,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4MDk4MA==",
      "original_commit_id" : "1b7fbb57a25fdfe27e0d8dc44c3d51f638e06a78",
      "original_line" : 991,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 13,
      "pull_request_review_id" : 339014775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363580980",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r367700676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367700676"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This doesn't seem to be the right place to test default node services... Suggest initialising `default_services` to `node1.nServices`, and checking that it excludes `NODE_COMPACT_FILTERS`.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-01-16T23:23:25Z",
      "diff_hunk" : "@@ -0,0 +1,267 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Tests NODE_COMPACT_FILTERS (BIP 157/158).\n+\n+Tests that a node configured with -blockfilterindex signals NODE_COMPACT_FILTERS and responds\n+correctly to GET_CFILTERS, GET_CFHEADERS, GET_CFCHECKPT requests.\n+\"\"\"\n+\n+from test_framework.messages import (\n+    FILTER_TYPE_BASIC,\n+    NODE_NETWORK, NODE_COMPACT_FILTERS, NODE_WITNESS, NODE_NETWORK_LIMITED,\n+    msg_getcfilters, msg_getcfheaders, msg_getcfcheckpt,\n+    ser_uint256, uint256_from_str, hash256,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    connect_nodes, disconnect_nodes, sync_blocks,\n+    wait_until,\n+)\n+\n+FILTER_TYPES = [\"basic\"]\n+\n+class CFiltersClient(P2PInterface):\n+    def __init__(self):\n+        super().__init__()\n+        # Store the cfilters received.\n+        self.cfilters = []\n+\n+    def pop_cfilters(self):\n+        cfilters = self.cfilters\n+        self.cfilters = []\n+        return cfilters\n+\n+    def on_cfilter(self, message):\n+        \"\"\"Store cfilters received in a list.\"\"\"\n+        self.cfilters.append(message)\n+\n+class CompactFiltersTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [\"-blockfilterindex\", \"-peercfilters\"],\n+            [\"-blockfilterindex\"],\n+        ]\n+\n+    def run_test(self):\n+        # Node 0 supports COMPACT_FILTERS, node 1 does not.\n+        node0 = self.nodes[0].add_p2p_connection(CFiltersClient())\n+        node1 = self.nodes[1].add_p2p_connection(CFiltersClient())\n+\n+        # Nodes 0 & 1 share the same first 999 blocks in the chain.\n+        self.nodes[0].generate(999)\n+        sync_blocks(self.nodes)\n+\n+        # Stale blocks by disconnecting nodes 0 & 1, mining, then reconnecting\n+        disconnect_nodes(self.nodes[0], 1)\n+\n+        self.nodes[0].generate(1)\n+        wait_until(lambda: self.nodes[0].getblockcount() == 1000)\n+        stale_block_hash = self.nodes[0].getblockhash(1000)\n+\n+        self.nodes[1].generate(1001)\n+        wait_until(lambda: self.nodes[1].getblockcount() == 2000)\n+\n+        # Fetch cfcheckpt on node 0. Since the implementation caches the checkpoints on the active\n+        # chain in memory, this checks that the cache is updated correctly upon subsequent queries\n+        # after the reorg.\n+        request = msg_getcfcheckpt(\n+            filter_type=FILTER_TYPE_BASIC,\n+            stop_hash=int(stale_block_hash, 16)\n+        )\n+        node0.send_message(request)\n+        node0.sync_with_ping(timeout=5)\n+        response = node0.last_message['cfcheckpt']\n+        assert_equal(response.filter_type, request.filter_type)\n+        assert_equal(response.stop_hash, request.stop_hash)\n+        assert_equal(len(response.headers), 1)\n+\n+        # Reorg node 0 to a new chain\n+        connect_nodes(self.nodes[0], 1)\n+        sync_blocks(self.nodes)\n+\n+        main_block_hash = self.nodes[0].getblockhash(1000)\n+        assert main_block_hash != stale_block_hash, \"node 0 chain did not reorganize\"\n+\n+        default_services = NODE_NETWORK | NODE_WITNESS | NODE_NETWORK_LIMITED\n+\n+        # Check that nodes have signalled expected services.\n+        assert_equal(node0.nServices, default_services | NODE_COMPACT_FILTERS)\n+        assert_equal(node1.nServices, default_services)\n+\n+        # Check that the localservices is as expected.\n+        assert_equal(int(self.nodes[0].getnetworkinfo()['localservices'], 16),\n+                     default_services | NODE_COMPACT_FILTERS)\n+        assert_equal(int(self.nodes[1].getnetworkinfo()['localservices'], 16),\n+                     default_services)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r367700676",
      "id" : 367700676,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcwMDY3Ng==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 103,
      "original_position" : 103,
      "original_start_line" : 93,
      "path" : "test/functional/p2p_cfilters.py",
      "position" : null,
      "pull_request_review_id" : 344281599,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367700676",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r374317003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374317003"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `const` `stop_hash` would make the role the arg plays more clear - absent that pass by reference could be misleading",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-02-03T20:13:44Z",
      "diff_hunk" : "@@ -1848,6 +1851,99 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r374317003",
      "id" : 374317003,
      "in_reply_to_id" : 308430811,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMxNzAwMw==",
      "original_commit_id" : "ac3a72a8288134c5381b8e0d75b8b09fab79a890",
      "original_line" : 2022,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 352531802,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374317003",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs rebase",
      "created_at" : "2020-02-06T19:04:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-583060208",
      "id" : 583060208,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzA2MDIwOA==",
      "updated_at" : "2020-02-06T19:04:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583060208",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r379919162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379919162"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`NODE_COMPACT_FILTERS` does not show up in the `getnetworkinfo` RPC's `\"localservices\"` key, presumably because there's no entry for it in `GetServicesNames`.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-02-16T17:26:24Z",
      "diff_hunk" : "@@ -253,6 +290,9 @@ enum ServiceFlags : uint64_t {\n     // NODE_WITNESS indicates that a node can be asked for blocks and transactions including\n     // witness data.\n     NODE_WITNESS = (1 << 3),\n+    // NODE_COMPACT_FILTERS means the node will service basic block filter requests.\n+    // See BIP157 and BIP158 for details on how this is implemented.\n+    NODE_COMPACT_FILTERS = (1 << 6),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r379919162",
      "id" : 379919162,
      "line" : 300,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxOTE2Mg==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 300,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 50,
      "pull_request_review_id" : 359417445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379919162",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/2582071?v=4",
         "events_url" : "https://api.github.com/users/jonasnick/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasnick/followers",
         "following_url" : "https://api.github.com/users/jonasnick/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasnick/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasnick",
         "id" : 2582071,
         "login" : "jonasnick",
         "node_id" : "MDQ6VXNlcjI1ODIwNzE=",
         "organizations_url" : "https://api.github.com/users/jonasnick/orgs",
         "received_events_url" : "https://api.github.com/users/jonasnick/received_events",
         "repos_url" : "https://api.github.com/users/jonasnick/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasnick/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasnick/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasnick"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385982696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385982696"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, you are right. I guess I wanted to avoid taking cs_main, but it already does in `PrepareBlockFilterRequest` so maybe that's an unnecessary optimization.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-02-29T00:45:47Z",
      "diff_hunk" : "@@ -1998,17 +2022,27 @@ static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainPa\n         return true;\n     }\n \n+    bool index_in_sync = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385982696",
      "id" : 385982696,
      "in_reply_to_id" : 348246889,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4MjY5Ng==",
      "original_commit_id" : "7a05bb6cb94902ba7ab442134b7c52f5813e4280",
      "original_line" : 2025,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 366759268,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385982696",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385983243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385983243"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This doesn't seem actionable here. Probably best to open an issue or discuss in IRC or something?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-02-29T00:49:46Z",
      "diff_hunk" : "@@ -1214,6 +1226,40 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     });\n }\n \n+static bool UpdateCFHeadersCache(const BlockFilterIndex& filter_index)\n+{\n+    LOCK(cs_main);\n+    std::lock_guard<std::mutex> _lock(active_chain_cf_headers_mtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385983243",
      "id" : 385983243,
      "in_reply_to_id" : 349263563,
      "line" : 1310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4MzI0Mw==",
      "original_commit_id" : "459aead0e664edd3f383aa740123fc38dc41c248",
      "original_line" : 1310,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 51,
      "pull_request_review_id" : 366759892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385983243",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385986232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385986232"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This isn't a check, this is a lookup? I agree that the check below this *should* never fail though. It's just there for defensive purposes to prevent a segfault.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-02-29T01:12:38Z",
      "diff_hunk" : "@@ -1880,6 +1883,98 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385986232",
      "id" : 385986232,
      "in_reply_to_id" : 363579742,
      "line" : 2064,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4NjIzMg==",
      "original_commit_id" : "aaceafd7497afe7f6f6cdf07fbdbf6cbfe7079ef",
      "original_line" : 2064,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 366763329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385986232",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385986457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385986457"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What do you mean? Like fetching the filter at `start_height - 1`? The purpose is that the one filter header before the start of the range is required to compute the filter headers for all filters in the range given their hashes (it's a hash chain).",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-02-29T01:14:39Z",
      "diff_hunk" : "@@ -1975,6 +1977,51 @@ static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainPar\n     return true;\n }\n \n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385986457",
      "id" : 385986457,
      "in_reply_to_id" : 363579935,
      "line" : 2130,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4NjQ1Nw==",
      "original_commit_id" : "07dd76272cf5dc336594c03d32f0ddb107b10568",
      "original_line" : 2130,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 204,
      "pull_request_review_id" : 366763599,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385986457",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385986536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385986536"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, I think `filter_hashes` is right.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-02-29T01:15:30Z",
      "diff_hunk" : "@@ -1975,6 +1977,51 @@ static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainPar\n     return true;\n }\n \n+static bool ProcessGetCFHeaders(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                                CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFHEADERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;\n+    }\n+\n+    uint256 prev_header;\n+    if (start_height > 0) {\n+        const CBlockIndex* prev_block = stop_index->GetAncestor(start_height - 1);\n+        if (!filter_index->LookupFilterHeader(prev_block, prev_header)) {\n+            return error(\"Failed to find block filter header in index: filter_type=%s, block_hash=%s\",\n+                         BlockFilterTypeName(filter_type), prev_block->GetBlockHash().ToString());\n+        }\n+    }\n+\n+    std::vector<uint256> filter_hashes;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385986536",
      "id" : 385986536,
      "in_reply_to_id" : 363580053,
      "line" : 2139,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4NjUzNg==",
      "original_commit_id" : "07dd76272cf5dc336594c03d32f0ddb107b10568",
      "original_line" : 2139,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 213,
      "pull_request_review_id" : 366763718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385986536",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385986689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385986689"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The `GETCFCHECKPT` request returns all filter checkpoints. There's no parameter to request a subset from a different start height because the message is small and only requested once per catchup generally.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-02-29T01:16:42Z",
      "diff_hunk" : "@@ -396,6 +397,10 @@ limitedmap<uint256, std::chrono::microseconds> g_already_asked_for GUARDED_BY(cs\n /** Map maintaining per-node state. */\n static std::map<NodeId, CNodeState> mapNodeState GUARDED_BY(cs_main);\n \n+/** In-memory cache of all BIP157 compact filter checkpoints for the active chain. */\n+static std::vector<std::pair<const CBlockIndex*, uint256>> active_chain_cf_headers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r385986689",
      "id" : 385986689,
      "in_reply_to_id" : 363580460,
      "line" : 441,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4NjY4OQ==",
      "original_commit_id" : "878825452632fc053e4e9565338c1f42c14d94f1",
      "original_line" : 441,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 38,
      "pull_request_review_id" : 366763853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385986689",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r386134269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386134269"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The node is only guaranteed to serve a block filter/filter header if it has already advertised the block through a `headers` or `block` message to the requesting peer.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-03-01T19:37:22Z",
      "diff_hunk" : "@@ -1944,6 +1944,25 @@ static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_pa\n     return true;\n }\n \n+/**\n+ * Do a lookup on the block filter index. The lookup may fail erroneously if the filter index, which\n+ * is updated asynchronously, has not been synchronized with the net processing thread. In that\n+ * case, block for a short time until the filter index is updated, then retry the lookup.\n+ */\n+static bool QueryFilterIndexWithRetry(BaseIndex* index, bool& in_sync, std::function<bool()> fn)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r386134269",
      "id" : 386134269,
      "in_reply_to_id" : 363580801,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzNDI2OQ==",
      "original_commit_id" : "7a05bb6cb94902ba7ab442134b7c52f5813e4280",
      "original_line" : 1952,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 366880973,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/386134269",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r387286843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387286843"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I have removed the dynamic flipping in accordance with reviewers' suggestions.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-03-03T20:53:22Z",
      "diff_hunk" : "@@ -2597,7 +2599,18 @@ uint64_t CConnman::GetTotalBytesSent()\n \n ServiceFlags CConnman::GetLocalServices() const\n {\n-    return nLocalServices;\n+    uint64_t local_services = nLocalServices;\n+    if (local_services & NODE_COMPACT_FILTERS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r387286843",
      "id" : 387286843,
      "in_reply_to_id" : 308415562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4Njg0Mw==",
      "original_commit_id" : "c6f73db3abe2835fc14b5b4d434008f6613ee450",
      "original_line" : 2651,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 368315717,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387286843",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/fa733bbd78add587e19f0175ab9c127a8c27e024/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-11T14:54:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-597681466",
      "id" : 597681466,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NzY4MTQ2Ng==",
      "updated_at" : "2020-03-11T14:54:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597681466",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like there is a data race now (see Travis output https://travis-ci.org/github/bitcoin/bitcoin/jobs/665594933).",
      "created_at" : "2020-03-25T21:04:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-604086819",
      "id" : 604086819,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNDA4NjgxOQ==",
      "updated_at" : "2020-03-25T21:04:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604086819",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r401443707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401443707"
         }
      },
      "author_association" : "NONE",
      "body" : "I ran into this error when I had to restart a still-syncing node. So while I can add the `-peercfilters` flag when starting the node for the first time and syncing from scratch, I have to remove it when restarting a syncing node (otherwise it'd refuse to start with this error). I think it's better to either always allow the `-peercfilters` flag or only allow it once the filter index is ready. Former being preferred, since if combined with https://github.com/bitcoin/bitcoin/pull/16442/files#r363580980, it allows for everything to work with the `-peercfilters` flag only.\r\n\r\nOther than that: amazing work!",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-04-01T08:32:15Z",
      "diff_hunk" : "@@ -1697,6 +1710,19 @@ bool AppInitMain(NodeContext& node)\n         GetBlockFilterIndex(filter_type)->Start();\n     }\n \n+    if (nLocalServices & NODE_COMPACT_FILTERS) {\n+        const BlockFilterIndex* const basic_filter_index =\n+            GetBlockFilterIndex(BlockFilterType::BASIC);\n+        if (!basic_filter_index) {\n+            error(\"NODE_COMPACT_FILTERS is signaled, but filter index is not available\");\n+            return false;\n+        }\n+        if (!basic_filter_index->IsSynced()) {\n+            InitError(strprintf(_(\"Cannot enable -peercfilters until basic block filter index is in sync. Please disable and reenable once filters have been indexed.\").translated));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r401443707",
      "id" : 401443707,
      "line" : 1791,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ0MzcwNw==",
      "original_commit_id" : "7608b32fc27254c84c16090af9a32d6bbdf60ec7",
      "original_line" : 1791,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 39,
      "pull_request_review_id" : 385370724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401443707",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/19181985?v=4",
         "events_url" : "https://api.github.com/users/kilrau/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kilrau/followers",
         "following_url" : "https://api.github.com/users/kilrau/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kilrau/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kilrau",
         "id" : 19181985,
         "login" : "kilrau",
         "node_id" : "MDQ6VXNlcjE5MTgxOTg1",
         "organizations_url" : "https://api.github.com/users/kilrau/orgs",
         "received_events_url" : "https://api.github.com/users/kilrau/received_events",
         "repos_url" : "https://api.github.com/users/kilrau/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kilrau/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kilrau/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kilrau"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It looks like the test times out when run in valgrind. Maybe you could bump the timeout like some of the other tests do?\r\n\r\n```py\r\nself.rpc_timeout = 120",
      "created_at" : "2020-04-08T16:20:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-611054359",
      "id" : 611054359,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMTA1NDM1OQ==",
      "updated_at" : "2020-04-08T16:20:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/611054359",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-08T16:45:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-611067699",
      "id" : 611067699,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMTA2NzY5OQ==",
      "updated_at" : "2020-04-08T16:45:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/611067699",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. \r\n\r\nBuilt, run and tested on macOS Catalina 10.15.4.",
      "created_at" : "2020-04-30T17:10:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-621985134",
      "id" : 621985134,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTk4NTEzNA==",
      "updated_at" : "2020-04-30T17:10:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621985134",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/56779?v=4",
         "events_url" : "https://api.github.com/users/brakmic/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brakmic/followers",
         "following_url" : "https://api.github.com/users/brakmic/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brakmic/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brakmic",
         "id" : 56779,
         "login" : "brakmic",
         "node_id" : "MDQ6VXNlcjU2Nzc5",
         "organizations_url" : "https://api.github.com/users/brakmic/orgs",
         "received_events_url" : "https://api.github.com/users/brakmic/received_events",
         "repos_url" : "https://api.github.com/users/brakmic/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brakmic/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brakmic/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brakmic"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "What is the target release of bitcoin-core to have this included?",
      "created_at" : "2020-04-30T17:21:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-621991277",
      "id" : 621991277,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTk5MTI3Nw==",
      "updated_at" : "2020-04-30T17:21:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621991277",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Removed from high-prio for now because it needs rebase. Can be re-added right after the rebase.",
      "created_at" : "2020-04-30T19:18:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-622052330",
      "id" : 622052330,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjA1MjMzMA==",
      "updated_at" : "2020-04-30T19:18:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622052330",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@prusnak afaik it depends on review; master currently targets v0.21",
      "created_at" : "2020-04-30T19:34:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-622060837",
      "id" : 622060837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjA2MDgzNw==",
      "updated_at" : "2020-04-30T19:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622060837",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jimpo would you like me to maintain this branch/pull request? Happy to rebase it and squash the fixup commits.",
      "created_at" : "2020-04-30T22:05:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-622140888",
      "id" : 622140888,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjE0MDg4OA==",
      "updated_at" : "2020-04-30T22:05:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622140888",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, that would be very appreciated. Thank you @jnewbery!",
      "created_at" : "2020-05-02T03:16:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-622660886",
      "id" : 622660886,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjY2MDg4Ng==",
      "updated_at" : "2020-05-02T03:16:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622660886",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The current changeset seems to be failing the `p2p_cfilters.py` test on some configurations.",
      "created_at" : "2020-05-02T08:47:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-622892081",
      "id" : 622892081,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjg5MjA4MQ==",
      "updated_at" : "2020-05-02T08:47:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622892081",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419023456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419023456"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 14df7f7b17: Seems a bit odd to return true here, but not in the error case (which is also) logged. I suggest making the return type here `void`",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-05-02T23:56:57Z",
      "diff_hunk" : "@@ -1965,6 +1969,98 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419023456",
      "id" : 419023456,
      "line" : 2091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAyMzQ1Ng==",
      "original_commit_id" : "14df7f7b17f1936ae641c619ae95989090f5a063",
      "original_line" : 2091,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 165,
      "pull_request_review_id" : 404567931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419023456",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419029945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419029945"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit in commit 14df7f7b17f1936ae641c619ae95989090f5a063\r\n\r\n```suggestion\r\n                                      const uint256& stop_hash, uint32_t max_height_diff,\r\n```",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-05-03T01:12:29Z",
      "diff_hunk" : "@@ -1965,6 +2012,206 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419029945",
      "id" : 419029945,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAyOTk0NQ==",
      "original_commit_id" : "72784c3dac1e9d482cf5499170f689f483c1da51",
      "original_line" : 2022,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 404567931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419029945",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 72784c3dac ð¶\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nACK 72784c3dac ð¶\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUhRkwv9GYZx75PbE6Q6VqEuDomfW8amF89WneIQOES2IG69dMBT9QVDjwyBiAhW\r\nJUZBEd5+QruLK+F7zaVSA0MWBTrytjbOPJooVW4zqwz6pvmCGDfvK5GgIq+rxpXi\r\nb+RtNaJOozJOtjzKgYnXnjVMTIsXlikvHNRfPV78ut7rQesZFyvfs/KFEHNDZiQn\r\ntAmTpIWkjCSL+AzCPRHl1oM4btBQYo4U05zXz5R4mwgmfFiGIR9/zVyeGj+IZdjg\r\niyzonjZxcgfkQliBxoKIiuMrZJpUREoxdtz7Bz3K6M/EvAE/uXs1UvO4nW6C9NPb\r\n4ZxzHAHW0ZpFar7rokzAdrYKMol57tMzu4+Zy4+ORR7iFLEtM6/eusoaM926LtgR\r\n7lHn6w7BI4e47WZUOv6B2blJ2PDhUbIMaGGJHcp0L0oq82g8G3+ifKrMQnBMx+t0\r\nvY0uiIqXux9qPmEzCBeTdrRcP9ttEx0dUa9J8CX8SB1nAkHn3Tqm4EI3AjwTqBv1\r\n8rak+MEe\r\n=7kNY\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `1689fa73387e19ab3b3f9823a2aeee68cde8d5c8190a7f072880b6df2ab6a10f  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e8929401081689fa73387e19ab3b3f9823a2aeee68cde8d5c8190a7f072880b6df2ab6a10ff010116a6819232e2b7c8da8d79b8657871408fff0100daeb44aefe15238dd72c149d0a61c8908f020e93f7f5de146a5e6b255c59ab9a8928b56e2ef398f8aa482333d1b5b8e9632e008f1045eae1b48f008b42eb6464aa2ddda0083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff010177cb55d63e7507acb02cbd5855f257d08f1045eae1b48f008611edd6694efcdd80083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6dfff0106b124d1f1dc8b10b78954600389a0bc908f1045eae1b48f00848892b16fb9b7ebe0083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267f010bfee21ae66d65b01d2a92143ddfbe93908f1045eae1b48f008d2d2fc958927c8ce0083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6d)\r\n\r\n</details>\r\n\r\n",
      "created_at" : "2020-05-03T01:16:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623037890",
      "id" : 623037890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzAzNzg5MA==",
      "updated_at" : "2020-05-03T01:16:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623037890",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Re-added to the high-prio project, per my previous comment.\r\n\r\nAlso assigned 0.21.0 milestone to get this merged hopefully early in the timeline, so that additional long-term testing can be conducted.",
      "created_at" : "2020-05-03T01:23:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623038565",
      "id" : 623038565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzAzODU2NQ==",
      "updated_at" : "2020-05-03T01:23:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623038565",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419031024"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419031024"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note to reviewers, in commit 14df7f7b17f1936ae641c619ae95989090f5a063 \r\n\r\nThe BIP https://github.com/bitcoin/bips/blob/master/bip-0157.mediawiki#getcfilters says 1000. This is fixed up in a later commit 7f59550cb176ad2ea3ef6e9a75422bc8ffcc5c7e",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-05-03T01:25:03Z",
      "diff_hunk" : "@@ -127,6 +129,8 @@ static constexpr unsigned int INVENTORY_BROADCAST_MAX = 7 * INVENTORY_BROADCAST_\n static constexpr unsigned int AVG_FEEFILTER_BROADCAST_INTERVAL = 10 * 60;\n /** Maximum feefilter broadcast delay after significant change. */\n static constexpr unsigned int MAX_FEEFILTER_CHANGE_DELAY = 5 * 60;\n+/** Maximum number of compact filters that may be requested with one getcfilters. See BIP 157. */\n+static constexpr uint32_t MAX_GETCFILTERS_SIZE = 100;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419031024",
      "id" : 419031024,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAzMTAyNA==",
      "original_commit_id" : "14df7f7b17f1936ae641c619ae95989090f5a063",
      "original_line" : 133,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 404567931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419031024",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419125215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419125215"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit a7b375a4469fcef823a274e3f05db0f9ab7aa035 : \r\n\r\nThe test still times out on valgrind. Please bump the timeout.\r\n\r\n```diff\r\ndiff --git a/test/functional/p2p_cfilters.py b/test/functional/p2p_cfilters.py\r\nindex dca35f4e89..d16946510b 100755\r\n--- a/test/functional/p2p_cfilters.py\r\n+++ b/test/functional/p2p_cfilters.py\r\n@@ -42,6 +42,7 @@ class CFiltersClient(P2PInterface):\r\n \r\n class CompactFiltersTest(BitcoinTestFramework):\r\n     def set_test_params(self):\r\n+        self.rpc_timeout = 480\r\n         self.setup_clean_chain = True\r\n         self.num_nodes = 2\r\n         self.extra_args = [\r\n```\r\n\r\n(generating more than 1000 blocks in valgrind takes time)\r\n\r\n\r\nhttps://travis-ci.org/github/bitcoin/bitcoin/jobs/682347754#L3147\r\n\r\n\r\n```\r\ntest_framework.authproxy.JSONRPCException: 'generatetoaddress' RPC took longer than 120.000000 seconds. Consider using larger timeout for calls that take longer to return. (-344)",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-05-03T16:16:12Z",
      "diff_hunk" : "@@ -0,0 +1,245 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Tests NODE_COMPACT_FILTERS (BIP 157/158).\n+\n+Tests that a node configured with -blockfilterindex signals NODE_COMPACT_FILTERS and responds\n+correctly to GET_CFILTERS, GET_CFHEADERS, GET_CFCHECKPT requests.\n+\"\"\"\n+\n+from test_framework.messages import (\n+    FILTER_TYPE_BASIC, NODE_COMPACT_FILTERS,\n+    msg_getcfilters, msg_getcfheaders, msg_getcfcheckpt,\n+    ser_uint256, uint256_from_str, hash256,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    connect_nodes, disconnect_nodes, sync_blocks,\n+    wait_until,\n+)\n+\n+FILTER_TYPES = [\"basic\"]\n+\n+class CFiltersClient(P2PInterface):\n+    def __init__(self):\n+        super().__init__()\n+        # Store the cfilters received.\n+        self.cfilters = []\n+\n+    def pop_cfilters(self):\n+        cfilters = self.cfilters\n+        self.cfilters = []\n+        return cfilters\n+\n+    def on_cfilter(self, message):\n+        \"\"\"Store cfilters received in a list.\"\"\"\n+        self.cfilters.append(message)\n+\n+class CompactFiltersTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419125215",
      "id" : 419125215,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNTIxNQ==",
      "original_commit_id" : "a7b375a4469fcef823a274e3f05db0f9ab7aa035",
      "original_line" : 45,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "test/functional/p2p_cfilters.py",
      "position" : 45,
      "pull_request_review_id" : 404567931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419125215",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419125307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419125307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit a7b375a4469fcef823a274e3f05db0f9ab7aa035 : \r\n\r\nCould you please squash 72784c3dac1e9d482cf5499170f689f483c1da51 into this commit?",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-05-03T16:16:48Z",
      "diff_hunk" : "@@ -1512,3 +1515,154 @@ class msg_no_witness_blocktxn(msg_blocktxn):\n \n     def serialize(self):\n         return self.block_transactions.serialize(with_witness=False)\n+\n+\n+class msg_getcfilters:\n+    __slots__ = (\"filter_type\", \"start_height\", \"stop_hash\")\n+    command = b\"getcfilters\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419125307",
      "id" : 419125307,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNTMwNw==",
      "original_commit_id" : "a7b375a4469fcef823a274e3f05db0f9ab7aa035",
      "original_line" : 1522,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/messages.py",
      "position" : null,
      "pull_request_review_id" : 404567931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419125307",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419246556"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419246556"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It returns `false` in cases that are unexpected, our-fault errors (more like exceptions) and returns true and logs when it's just an invalid request.",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2020-05-04T07:10:37Z",
      "diff_hunk" : "@@ -1965,6 +1969,98 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n     }\n }\n \n+/**\n+ * Common validation logic for GETCFILTER, GETCFHEADER, GETCFCHECKPT request handling. If the\n+ * request is valid and can be serviced, this returns the stop block index and the filter index\n+ * as out parameters. May disconnect from the peer in the case of a bad request.\n+ */\n+static bool PrepareBlockFilterRequest(CNode* pfrom, const CChainParams& chain_params,\n+                                      BlockFilterType filter_type, uint32_t start_height,\n+                                      uint256& stop_hash, uint32_t max_height_diff,\n+                                      const CBlockIndex*& stop_index,\n+                                      BlockFilterIndex*& filter_index)\n+{\n+    bool supported_filter_type =\n+        (filter_type == BlockFilterType::BASIC &&\n+         (pfrom->GetLocalServices() & NODE_COMPACT_FILTERS));\n+    if (!supported_filter_type) {\n+        LogPrint(BCLog::NET, \"peer %d requested unknown block filter type: %d\\n\",\n+                 pfrom->GetId(), static_cast<uint8_t>(filter_type));\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    {\n+        LOCK(cs_main);\n+        stop_index = LookupBlockIndex(stop_hash);\n+\n+        // Check that the stop block exists and was at some point connected to the active chain.\n+        if (!stop_index || !BlockRequestAllowed(stop_index, chain_params.GetConsensus())) {\n+            LogPrint(BCLog::NET, \"peer %d requested invalid block hash: %s\\n\",\n+                     pfrom->GetId(), stop_hash.ToString());\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+    }\n+\n+    uint32_t stop_height = stop_index->nHeight;\n+    if (start_height > stop_height) {\n+        LogPrint(BCLog::NET, \"peer %d sent invalid getcfilters/getcfheaders with \" /* Continued */\n+                 \"start height %d and stop height %d\\n\",\n+                 pfrom->GetId(), start_height, stop_height);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+    if (stop_height - start_height >= max_height_diff) {\n+        LogPrint(BCLog::NET, \"peer %d requested too many cfilters/cfheaders: %d / %d\\n\",\n+                 pfrom->GetId(), stop_height - start_height + 1, max_height_diff);\n+        pfrom->fDisconnect = true;\n+        return false;\n+    }\n+\n+    filter_index = GetBlockFilterIndex(filter_type);\n+    if (!filter_index) {\n+        return error(\"Filter index for supported type %s not found\", BlockFilterTypeName(filter_type));\n+    }\n+\n+    return true;\n+}\n+\n+static bool ProcessGetCFilters(CNode* pfrom, CDataStream& vRecv, const CChainParams& chain_params,\n+                               CConnman* connman)\n+{\n+    uint8_t filter_type_ser;\n+    uint32_t start_height;\n+    uint256 stop_hash;\n+\n+    vRecv >> filter_type_ser >> start_height >> stop_hash;\n+\n+    BlockFilterType filter_type = static_cast<BlockFilterType>(filter_type_ser);\n+\n+    const CBlockIndex* stop_index;\n+    BlockFilterIndex* filter_index;\n+    if (!PrepareBlockFilterRequest(pfrom, chain_params, filter_type, start_height, stop_hash,\n+                                   MAX_GETCFILTERS_SIZE, stop_index, filter_index)) {\n+        // Return true because the issue with the invalid request has already been logged.\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r419246556",
      "id" : 419246556,
      "in_reply_to_id" : 419023456,
      "line" : 2091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI0NjU1Ng==",
      "original_commit_id" : "14df7f7b17f1936ae641c619ae95989090f5a063",
      "original_line" : 2091,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 165,
      "pull_request_review_id" : 404748918,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-04T07:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419246556",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jimpo what's the bandwidth consumption by month of a BIP157 client ? I guess you have done simulations but how many clients you can onboard for a given number of public peers servicing filters, these peers allocating half of their 350GB/month available bandwidth to light clients ?",
      "created_at" : "2020-05-04T09:22:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623354890",
      "id" : 623354890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzM1NDg5MA==",
      "updated_at" : "2020-05-04T09:23:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623354890",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 6782deb365cc5a9db763aad1bd0604f515ee9a68 , only change is bumping the test timeout ð¦\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nre-ACK 6782deb365cc5a9db763aad1bd0604f515ee9a68 , only change is bumping the test timeout ð¦\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUgd5wv/fOA6Wp1SOJL7RkcBPP6E2vCWfAHgO1Nkqm8IM0b3ni39GycRiGPo8byX\r\nLb4OJoBp1eYn16M3jQM/6p+qwHIaGtK8PF3dYAHE5ausfPbU08i7lSXXgiwLhLRT\r\nyL80XA7GSfmndXRVlC4oT+gEZTiLmtHjRHPxncHBUwk0CsbDranHW26L5yWM837q\r\nIpEEvYmNGdY25EkdyomYPKdYubC1kg3KNfs2al/stHfnZOcc2qHER7TG1iae0uKS\r\nUR+LlZM8YC1m7YDNnfQax7YZha/7uO2mtWk4NRiMF0kKVc+5OMxYafYmG5TgsCyX\r\n/V6yf3PCsDljHqCVMLXIpq7yMa+HFkY0o5VHK/f/rzRHSN5O0by+jejhXqFuHbf4\r\n3hSLWGDxPOZ7t0sJRmmsUXvpd+3a4InTIwYFPXUnMb+8MtoZ+s1y8lyXGeJ0n4LY\r\nhqU/z6KG7Jwco1Jw31/OuLQEj9xps5c5n5sXRo7/RRSsOFVbaPYAyHy+T3X1etrU\r\n+ZINQMb8\r\n=R4ah\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `12b25cde2d674e19d526f72520f81959ca1a59d56f42ab8c777377410a6d12f9  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e89294010812b25cde2d674e19d526f72520f81959ca1a59d56f42ab8c777377410a6d12f9f010c7d24dbfb146ab6e6c5a22d57269ac1708fff0103e6c5ca09555ff20e7dd1e96b0976efb08f1045eb0002df008e35f7261b67005f90083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6dfff0109ccc1979b025bd9c1bf622b93174fa8708f120e4784dd7e8cac3b0c23c46c0bced1deff743b811d3e245fcc0ad5a9536cafcdf08f1045eb0002df008e09ae1e5e41df72f0083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff010f46b84a9e199245ef2f17a502946d28508f1204c580456716c88eb5b5acca33bfb5744c30c27222bcd40548fc2c5154f4fea8708f1045eb0002df0084706c0390824600b0083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267f010f7d0803aa5fd313cd8bca9e19a298a3908f1045eb0002cf00834c0a779f87cdfc80083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6d)\r\n\r\n</details>\r\n",
      "created_at" : "2020-05-04T11:45:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623415561",
      "id" : 623415561,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzQxNTU2MQ==",
      "updated_at" : "2020-05-04T11:45:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623415561",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ariard I think maxuploadtarget documentation can be added in a follow-up. No need to solve all issues in one pull request.",
      "created_at" : "2020-05-04T11:47:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623416425",
      "id" : 623416425,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzQxNjQyNQ==",
      "updated_at" : "2020-05-04T11:47:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623416425",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Yes, that would be very appreciated. Thank you @jnewbery!\r\n\r\nThanks @jimpo . I plan to do the following:\r\n\r\n- squash all fixup commits into their respective commits\r\n- rebase on master\r\n- re-order commits and then open PRs for subsets of the functionality so we can make some progress towards merging this.\r\n\r\nThanks again for all your work on this :)",
      "created_at" : "2020-05-04T17:19:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623593981",
      "id" : 623593981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzU5Mzk4MQ==",
      "updated_at" : "2020-05-04T17:19:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623593981",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke It's not a question of node resources management, but a more broader concern about light clients current scalability model. Even with a low-bandwidth protocol such as BIP157/158, you may still have a huge discrepancy between the numbers of requesting clients and opt-in public peers to serve them.\r\n\r\nAt its heart, you will always have a incentives conflict between clients asking for resources and offering nothing back and full-node operators. Unless your light client protocol is so ridiculous cheap to rely on niceness of a subset of nodes operators offering free resources, it won't scale for thousands or millions of clients. And it's likely you will always have a ratio disequilibrium between numbers of clients and numbers of full-node, even worst their growth rate won't be the same, first one are so much easier to setup.\r\n\r\nI have been through mailing posts about BIP157/158 design but haven't seen any realistic projections and specially what people do aim to achieve by integrating this at the *p2p* layer. I do understand people may be interested to use compact filters for their own Neutrino-style client and if so they should use the RPC interface. I'm worried about wallet vendors building such chain access backend for people not connecting to their own full-node but directly to the broader network, which maybe fine now because you have really few BIP157 clients, but going to hit a bandwidth scalability wall few years from now instead of pursing better solutions.\r\n\r\nMaybe I'm completely wrong, missing some numbers and I would be super glad to read about what have been previously thought on this issue. In the meanwhile I'm Concept NACK on this and happy to bring it during next meeting and explained issues as I perceived it on the ml.\r\n\r\nNote, that doesn't restrain to get this PR ready for merge.",
      "created_at" : "2020-05-04T20:34:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623690795",
      "id" : 623690795,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzY5MDc5NQ==",
      "updated_at" : "2020-05-04T20:38:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623690795",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ariard please take discussion of light-client scalability to the mailing list. Comments on this PR should be for review of the implementation.",
      "created_at" : "2020-05-04T20:53:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623699520",
      "id" : 623699520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzY5OTUyMA==",
      "updated_at" : "2020-05-04T20:53:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623699520",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ariard This is an optional feature, not enabled by default. It might make some sense to support it for trusted peers only (missing from this PR), although protocols like Stratum are probably better for that purpose (but nobody has implemented it for Core to date).\r\n\r\n@jnewbery Concept NACKs, and the explanation therefore (required by dev notes!) do belong on PRs...\r\n\r\nI think I'm going to mirror @ariard's Concept NACK. We do have bloom already for trusted peers, and using this for public peers does indeed harm the network. We can't stop anyone else from deploying it, but with Core's monopoly, that hardly matters.",
      "created_at" : "2020-05-04T21:39:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623722125",
      "id" : 623722125,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzcyMjEyNQ==",
      "updated_at" : "2020-05-04T21:39:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623722125",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ariard Of course there are always questions about incentives to provide public data for free by nodes, but that problem isn't unique to BIP157 - you can also question if nodes have reason to provide blocks, transactions, to participate in relay, ... etc. Perhaps there is a future where all these things eventually have to be paid for, but for now, trying to solve this perfectly would just lead you to the conclusion that all non-miner nodes should be turned off, and if someone wants to audit the chain they can connect directly to miners. The relevant question is how BIP157 costs compare to services already offered, which doesn't seem very bad to me.",
      "created_at" : "2020-05-04T21:56:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623729168",
      "id" : 623729168,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzcyOTE2OA==",
      "updated_at" : "2020-05-04T21:56:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623729168",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@luke-jr Certainly reasons to reject an implementation of a BIP should go on a PR, but you have principled objections to a BIP - which seems to be the case here - it is much more useful to have that criticism be visible more widely. It would be strange if there is apparent consensus that a BIP is a good idea, and then having it not be implemented in Core because of an argument only presented there.",
      "created_at" : "2020-05-04T22:03:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623731993",
      "id" : 623731993,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzczMTk5Mw==",
      "updated_at" : "2020-05-04T22:03:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623731993",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Github doesn't allow PRs to be transferred, so I've opened #18876 for the new branch.",
      "created_at" : "2020-05-05T02:59:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623808184",
      "id" : 623808184,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzgwODE4NA==",
      "updated_at" : "2020-05-05T02:59:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623808184",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closing this for #18876. Discussion / review should move to #18876 and the sub-PRs.",
      "created_at" : "2020-05-05T03:08:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623809735",
      "id" : 623809735,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzgwOTczNQ==",
      "updated_at" : "2020-05-05T03:08:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623809735",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr Yes I noticed that's an optional feature, used the term opt-in somehow IIRC.\r\n\r\n@sipa that's the right but you may have an indirect incentive to relay blocks and likely-to-be-blocks to foster network robustness and make your transactions more censorship-resistant. Killing a light client doesn't increase or decrease network security ?\r\n\r\nAnyway, thanks for your comments, throw a lengthy argumentation on the mailing list on this.",
      "created_at" : "2020-05-05T10:26:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-623975146",
      "id" : 623975146,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16442",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzk3NTE0Ng==",
      "updated_at" : "2020-05-05T10:26:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623975146",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r552292721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552292721"
         }
      },
      "author_association" : "NONE",
      "body" : "# # # # # # #",
      "commit_id" : "6782deb365cc5a9db763aad1bd0604f515ee9a68",
      "created_at" : "2021-01-06T00:46:36Z",
      "diff_hunk" : "@@ -1697,6 +1710,19 @@ bool AppInitMain(NodeContext& node)\n         GetBlockFilterIndex(filter_type)->Start();\n     }\n \n+    if (nLocalServices & NODE_COMPACT_FILTERS) {\n+        const BlockFilterIndex* const basic_filter_index =\n+            GetBlockFilterIndex(BlockFilterType::BASIC);\n+        if (!basic_filter_index) {\n+            error(\"NODE_COMPACT_FILTERS is signaled, but filter index is not available\");\n+            return false;\n+        }\n+        if (!basic_filter_index->IsSynced()) {\n+            InitError(strprintf(_(\"Cannot enable -peercfilters until basic block filter index is in sync. Please disable and reenable once filters have been indexed.\").translated));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16442#discussion_r552292721",
      "id" : 552292721,
      "in_reply_to_id" : 401443707,
      "line" : 1791,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI5MjcyMQ==",
      "original_commit_id" : "7608b32fc27254c84c16090af9a32d6bbdf60ec7",
      "original_line" : 1791,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 39,
      "pull_request_review_id" : 562251532,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16442",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-06T00:57:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552292721",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/17803411?v=4",
         "events_url" : "https://api.github.com/users/alejagapatrick/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alejagapatrick/followers",
         "following_url" : "https://api.github.com/users/alejagapatrick/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alejagapatrick/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alejagapatrick",
         "id" : 17803411,
         "login" : "alejagapatrick",
         "node_id" : "MDQ6VXNlcjE3ODAzNDEx",
         "organizations_url" : "https://api.github.com/users/alejagapatrick/orgs",
         "received_events_url" : "https://api.github.com/users/alejagapatrick/received_events",
         "repos_url" : "https://api.github.com/users/alejagapatrick/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alejagapatrick/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alejagapatrick/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alejagapatrick"
      }
   }
]
