[
   {
      "author_association" : "MEMBER",
      "body" : "Context: `LockedPool` is used for the `secure_allocator` which is used to allocate memory for private keys (mainly wallet, but also signrawtransactions and some import commands).\r\n\r\nPR makes sense to me.\r\nConcept ACK.",
      "created_at" : "2018-01-04T07:16:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12048#issuecomment-355214237",
      "id" : 355214237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12048",
      "updated_at" : "2018-01-04T07:16:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/355214237",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r159594718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159594718"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "typo: Coalesce",
      "commit_id" : "5fbf7c478a996974502d5d787b2ccf2fcc91ac78",
      "created_at" : "2018-01-04T07:49:50Z",
      "diff_hunk" : "@@ -97,16 +103,30 @@ void Arena::free(void *ptr)\n     if (i == chunks_used.end()) {\n         throw std::runtime_error(\"Arena: invalid or double free\");\n     }\n-    auto freed = *i;\n+    std::pair<char*, size_t> freed = *i;\n     chunks_used.erase(i);\n \n-    // Add space to free map, coalescing contiguous chunks\n-    auto next = chunks_free.upper_bound(freed.first);\n-    auto prev = (next == chunks_free.begin()) ? chunks_free.end() : std::prev(next);\n-    if (prev == chunks_free.end() || !extend(prev, freed))\n-        prev = chunks_free.emplace_hint(next, freed);\n-    if (next != chunks_free.end() && extend(prev, *next))\n+    // Coalesc freed with previous chunk",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r159594718",
      "id" : 159594718,
      "original_commit_id" : "1e0ee9095ce87a3cee0b44a120f6297ac672f5d0",
      "original_position" : 72,
      "path" : "src/support/lockedpool.cpp",
      "position" : null,
      "pull_request_review_id" : 86568297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048",
      "updated_at" : "2018-01-06T08:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159594718",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r159596074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159596074"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why is the `chunks_free_end` map required instead of iterating one backwards from `next` as is done in the current code?",
      "commit_id" : "5fbf7c478a996974502d5d787b2ccf2fcc91ac78",
      "created_at" : "2018-01-04T08:02:51Z",
      "diff_hunk" : "@@ -97,16 +103,30 @@ void Arena::free(void *ptr)\n     if (i == chunks_used.end()) {\n         throw std::runtime_error(\"Arena: invalid or double free\");\n     }\n-    auto freed = *i;\n+    std::pair<char*, size_t> freed = *i;\n     chunks_used.erase(i);\n \n-    // Add space to free map, coalescing contiguous chunks\n-    auto next = chunks_free.upper_bound(freed.first);\n-    auto prev = (next == chunks_free.begin()) ? chunks_free.end() : std::prev(next);\n-    if (prev == chunks_free.end() || !extend(prev, freed))\n-        prev = chunks_free.emplace_hint(next, freed);\n-    if (next != chunks_free.end() && extend(prev, *next))\n+    // Coalesc freed with previous chunk\n+    auto prev = chunks_free_end.find(freed.first);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r159596074",
      "id" : 159596074,
      "original_commit_id" : "1e0ee9095ce87a3cee0b44a120f6297ac672f5d0",
      "original_position" : 73,
      "path" : "src/support/lockedpool.cpp",
      "position" : null,
      "pull_request_review_id" : 86568297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048",
      "updated_at" : "2018-01-06T08:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159596074",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r159596248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159596248"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Variable names are snake_case, per [developer guidelines](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md). Fix `sizePtrIt`, `sizeRemaining`, `itRemaining`.",
      "commit_id" : "5fbf7c478a996974502d5d787b2ccf2fcc91ac78",
      "created_at" : "2018-01-04T08:04:33Z",
      "diff_hunk" : "@@ -63,26 +65,30 @@ void* Arena::alloc(size_t size)\n     if (size == 0)\n         return nullptr;\n \n-    // Pick a large enough free-chunk\n-    auto it = std::find_if(chunks_free.begin(), chunks_free.end(),\n-        [=](const std::map<char*, size_t>::value_type& chunk){ return chunk.second >= size; });\n-    if (it == chunks_free.end())\n+    // Pick a large enough free-chunk. Returns an iterator pointing to the first element that is not less than key.\n+    // This allocation strategy is best-fit. According to \"Dynamic Storage Allocation: A Survey and Critical Review\",\n+    // Wilson et. al. 1995, http://www.scs.stanford.edu/14wi-cs140/sched/readings/wilson.pdf, best-fit and first-fit\n+    // policies seem to work well in practice.\n+    auto sizePtrIt = size_to_free_chunk.lower_bound(size);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r159596248",
      "id" : 159596248,
      "original_commit_id" : "1e0ee9095ce87a3cee0b44a120f6297ac672f5d0",
      "original_position" : 23,
      "path" : "src/support/lockedpool.cpp",
      "position" : null,
      "pull_request_review_id" : 86568297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048",
      "updated_at" : "2018-01-06T08:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159596248",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r159608353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159608353"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "the `cunks_free` used to be an `std::map` that was sorted by `char*`. There it was possible to use `std::prev` to just find what memory address came before. I have replaced this sorted map with an `std::unordered_map`, then it's not possible any more to just find the previous address quickly within the same map. That's why I have added another map that contains the back links. So this change replaces one O(log(n)) lookup + std::prev() call with two O(1) lookups.\r\n  ",
      "commit_id" : "5fbf7c478a996974502d5d787b2ccf2fcc91ac78",
      "created_at" : "2018-01-04T09:25:10Z",
      "diff_hunk" : "@@ -97,16 +103,30 @@ void Arena::free(void *ptr)\n     if (i == chunks_used.end()) {\n         throw std::runtime_error(\"Arena: invalid or double free\");\n     }\n-    auto freed = *i;\n+    std::pair<char*, size_t> freed = *i;\n     chunks_used.erase(i);\n \n-    // Add space to free map, coalescing contiguous chunks\n-    auto next = chunks_free.upper_bound(freed.first);\n-    auto prev = (next == chunks_free.begin()) ? chunks_free.end() : std::prev(next);\n-    if (prev == chunks_free.end() || !extend(prev, freed))\n-        prev = chunks_free.emplace_hint(next, freed);\n-    if (next != chunks_free.end() && extend(prev, *next))\n+    // Coalesc freed with previous chunk\n+    auto prev = chunks_free_end.find(freed.first);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r159608353",
      "id" : 159608353,
      "in_reply_to_id" : 159596074,
      "original_commit_id" : "1e0ee9095ce87a3cee0b44a120f6297ac672f5d0",
      "original_position" : 73,
      "path" : "src/support/lockedpool.cpp",
      "position" : null,
      "pull_request_review_id" : 86584121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048",
      "updated_at" : "2018-01-06T08:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159608353",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r160021061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160021061"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done!",
      "commit_id" : "5fbf7c478a996974502d5d787b2ccf2fcc91ac78",
      "created_at" : "2018-01-06T08:38:58Z",
      "diff_hunk" : "@@ -63,26 +65,30 @@ void* Arena::alloc(size_t size)\n     if (size == 0)\n         return nullptr;\n \n-    // Pick a large enough free-chunk\n-    auto it = std::find_if(chunks_free.begin(), chunks_free.end(),\n-        [=](const std::map<char*, size_t>::value_type& chunk){ return chunk.second >= size; });\n-    if (it == chunks_free.end())\n+    // Pick a large enough free-chunk. Returns an iterator pointing to the first element that is not less than key.\n+    // This allocation strategy is best-fit. According to \"Dynamic Storage Allocation: A Survey and Critical Review\",\n+    // Wilson et. al. 1995, http://www.scs.stanford.edu/14wi-cs140/sched/readings/wilson.pdf, best-fit and first-fit\n+    // policies seem to work well in practice.\n+    auto sizePtrIt = size_to_free_chunk.lower_bound(size);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r160021061",
      "id" : 160021061,
      "in_reply_to_id" : 159596248,
      "original_commit_id" : "1e0ee9095ce87a3cee0b44a120f6297ac672f5d0",
      "original_position" : 23,
      "path" : "src/support/lockedpool.cpp",
      "position" : null,
      "pull_request_review_id" : 87070891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048",
      "updated_at" : "2018-01-06T08:38:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160021061",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r160021099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160021099"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "thanks, fixed",
      "commit_id" : "5fbf7c478a996974502d5d787b2ccf2fcc91ac78",
      "created_at" : "2018-01-06T08:39:11Z",
      "diff_hunk" : "@@ -97,16 +103,30 @@ void Arena::free(void *ptr)\n     if (i == chunks_used.end()) {\n         throw std::runtime_error(\"Arena: invalid or double free\");\n     }\n-    auto freed = *i;\n+    std::pair<char*, size_t> freed = *i;\n     chunks_used.erase(i);\n \n-    // Add space to free map, coalescing contiguous chunks\n-    auto next = chunks_free.upper_bound(freed.first);\n-    auto prev = (next == chunks_free.begin()) ? chunks_free.end() : std::prev(next);\n-    if (prev == chunks_free.end() || !extend(prev, freed))\n-        prev = chunks_free.emplace_hint(next, freed);\n-    if (next != chunks_free.end() && extend(prev, *next))\n+    // Coalesc freed with previous chunk",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12048#discussion_r160021099",
      "id" : 160021099,
      "in_reply_to_id" : 159594718,
      "original_commit_id" : "1e0ee9095ce87a3cee0b44a120f6297ac672f5d0",
      "original_position" : 72,
      "path" : "src/support/lockedpool.cpp",
      "position" : null,
      "pull_request_review_id" : 87070897,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12048",
      "updated_at" : "2018-01-06T08:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160021099",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Concept ACK - this is a great improvement, thanks! will need to review in detail that various data structures stay consistent, though.",
      "created_at" : "2018-03-06T22:24:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12048#issuecomment-370950939",
      "id" : 370950939,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12048",
      "updated_at" : "2018-03-06T22:24:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/370950939",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "I can find no problems with this, utACK 5fbf7c478a996974502d5d787b2ccf2fcc91ac78",
      "created_at" : "2018-03-22T13:26:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12048#issuecomment-375304697",
      "id" : 375304697,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12048",
      "updated_at" : "2018-03-22T13:26:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/375304697",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
