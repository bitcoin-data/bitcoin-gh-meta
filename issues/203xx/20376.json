{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "**Expected behavior**\r\nI expect ZMQ raw block subscription to publish every raw block even in the case of a chainplit. Today two blocks (656477-8, with tip hash `00000000000000000005f8f74e57aa4584aacfed509b8a6feb20bc22e7d60a34`) were orphaned and I decided to check my bitcoin node logs to see how it behaved during this event.\r\n\r\n**Actual behavior**\r\nThe node published a ZMQ notification for block 656476 and the first 656477 block it received at 18:47:39Z. Around 9 minutes later, the node receives blocks 656477 and 656478 that orphan the previous 656477 block. From the log, we see that the zmq notification for the second 656477 block was not published:\r\n\r\n```\r\n2020-11-11T18:27:47Z UpdateTip: new best=000000000000000000103c23bc9a56b6c08340f973fab41c7dfd6535700ad8f4 height=656476 version=0x37ffe000 log2_work=92.435868 tx=585895690 date='2020-11-11T18:27:18Z' prog\r\nress=1.000000 cache=24.6MiB(187792txo) warning='75 of last 100 blocks have unexpected version'\r\n2020-11-11T18:27:47Z zmq: Publish rawblock 000000000000000000103c23bc9a56b6c08340f973fab41c7dfd6535700ad8f4\r\n2020-11-11T18:47:39Z UpdateTip: new best=0000000000000000000457df9961a123212340daf566b899aaa54197d0648d1b height=656477 version=0x2000e000 log2_work=92.435884 tx=585898368 date='2020-11-11T18:49:01Z' prog\r\nress=1.000000 cache=26.5MiB(202707txo) warning='75 of last 100 blocks have unexpected version'\r\n2020-11-11T18:47:39Z zmq: Publish rawblock 0000000000000000000457df9961a123212340daf566b899aaa54197d0648d1b\r\n2020-11-11T18:55:44Z Pre-allocating up to position 0x5000000 in blk02316.dat\r\n2020-11-11T18:56:10Z UpdateTip: new best=000000000000000000103c23bc9a56b6c08340f973fab41c7dfd6535700ad8f4 height=656476 version=0x37ffe000 log2_work=92.435868 tx=585895690 date='2020-11-11T18:27:18Z' prog\r\nress=0.999990 cache=26.0MiB(198487txo) warning='75 of last 100 blocks have unexpected version'\r\n2020-11-11T18:56:10Z UpdateTip: new best=0000000000000000000821678efe7f53c388fd2c530ef46e6dd2d2f369c346cd height=656477 version=0x20000000 log2_work=92.435884 tx=585898371 date='2020-11-11T18:53:37Z' prog\r\nress=0.999999 cache=27.0MiB(206709txo) warning='74 of last 100 blocks have unexpected version'\r\n***************************ZMQ NOTIFICATION MISSING HERE************************************************\r\n2020-11-11T18:56:10Z Pre-allocating up to position 0xa00000 in rev02316.dat\r\n2020-11-11T18:56:14Z UpdateTip: new best=0000000000000000000aaf4126ad8beb7f643462d5111cf89068c2f25f5742b1 height=656478 version=0x37ffe000 log2_work=92.435899 tx=585901367 date='2020-11-11T18:54:58Z' prog\r\nress=1.000000 cache=27.6MiB(211581txo) warning='74 of last 100 blocks have unexpected version'\r\n2020-11-11T18:56:14Z BlockUntilSyncedToCurrentChain: txindex is catching up on block notifications\r\n2020-11-11T18:56:14Z zmq: Publish rawblock 0000000000000000000aaf4126ad8beb7f643462d5111cf89068c2f25f5742b1\r\n\r\n```\r\n\r\n**To reproduce**\r\nCheck your own logs if you had block zmq and `debug=zmq` enabled or reproduce a chainsplit on regtest.\r\n\r\n**System information**\r\nBitcoin core v0.20.1 running on Ubuntu 18.04\r\n",
   "closed_at" : "2021-01-14T20:00:15Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
      "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
      "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/MarcoFalke",
      "id" : 6399679,
      "login" : "MarcoFalke",
      "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
      "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
      "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
      "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/MarcoFalke"
   },
   "comments" : 4,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20376/comments",
   "created_at" : "2020-11-12T05:20:36Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20376/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/20376",
   "id" : 741288409,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20376/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU3NDEyODg0MDk=",
   "number" : 20376,
   "performed_via_github_app" : null,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "ZMQ rawblock doesn't publish new block in case of chainsplit.",
   "updated_at" : "2021-01-14T20:00:15Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20376",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/16596928?v=4",
      "events_url" : "https://api.github.com/users/pedr0-fr/events{/privacy}",
      "followers_url" : "https://api.github.com/users/pedr0-fr/followers",
      "following_url" : "https://api.github.com/users/pedr0-fr/following{/other_user}",
      "gists_url" : "https://api.github.com/users/pedr0-fr/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/pedr0-fr",
      "id" : 16596928,
      "login" : "pedr0-fr",
      "node_id" : "MDQ6VXNlcjE2NTk2OTI4",
      "organizations_url" : "https://api.github.com/users/pedr0-fr/orgs",
      "received_events_url" : "https://api.github.com/users/pedr0-fr/received_events",
      "repos_url" : "https://api.github.com/users/pedr0-fr/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/pedr0-fr/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/pedr0-fr/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/pedr0-fr"
   }
}
