[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hello, @mruddy! \r\n\r\nI've tested it with the same data you showed here and got same thing. I use a debugger to understand better what is happening and noticed:\r\n\r\n1 - When defining `dest`, it uses `AddAndGetMultisigDestination`\r\nhttps://github.com/bitcoin/bitcoin/blob/3aa851ad2ae836f2bb8071396efec8b67347adcd/src/rpc/output_script.cpp#L155\r\n\r\n2 - In `AddAndGetMultisigDestination`, I just noticed it goes to `AddAndGetDestinationForScript`.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/3aa851ad2ae836f2bb8071396efec8b67347adcd/src/rpc/util.cpp#L263\r\n\r\n3 - In `AddAndGetDestinationForScript`, it returns an `Active Type =  ScriptHash`\r\n```cpp\r\n    case OutputType::P2SH_SEGWIT:\r\n    case OutputType::BECH32: {\r\n        CTxDestination witdest = WitnessV0ScriptHash(script);\r\n        CScript witprog = GetScriptForDestination(witdest);\r\n        // Check if the resulting program is solvable (i.e. doesn't use an uncompressed key)\r\n        if (!IsSolvable(keystore, witprog)) return ScriptHash(script);\r\n        // Add the redeemscript, so that P2WSH and P2SH-P2WSH outputs are recognized as ours.\r\n        keystore.AddCScript(witprog);\r\n        if (type == OutputType::BECH32) {\r\n            return witdest;\r\n        } else {\r\n            return ScriptHash(witprog);\r\n        }\r\n    }\r\n```\r\n\r\n4 - Since `ScriptHash` is different to `P2SH_SEGWIT` in that comparison, it returns that warning.\r\n\r\n--------\r\n\r\nIn `test/functional/rpc_createmultisig.py`, I just noticed every time it is creating a multisig with p2sh-segwit as output type, it is returning the warning message.",
      "created_at" : "2022-05-20T17:14:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25127#issuecomment-1133137577",
      "id" : 1133137577,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25127",
      "node_id" : "IC_kwDOABII585Dik6p",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133137577/reactions"
      },
      "updated_at" : "2022-05-20T17:30:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133137577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for looking.\r\n\r\nI do agree that the tests must be wrong in order to accept this obviously wrong warning message.\r\n\r\nI'm a bit confused about what you are saying since I stepped it through in gdb and am sure the check that fails is at https://github.com/bitcoin/bitcoin/blob/225e5b57b2ee2bc1acd7f09c89ccccc15ef8c85f/src/rpc/output_script.cpp#L166",
      "created_at" : "2022-05-21T12:37:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25127#issuecomment-1133627267",
      "id" : 1133627267,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25127",
      "node_id" : "IC_kwDOABII585DkceD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133627267/reactions"
      },
      "updated_at" : "2022-05-21T12:37:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133627267",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry if I wasn't so clear, but in my point 4 I was saying:\r\n```\r\nOutputTypeFromDestination(dest) -> returning ScriptHash\r\noutput_type -> P2SH_SEGWIT \r\n```\r\n\r\nSo, `OutputTypeFromDestination(dest) != output_type` is true.\r\n\r\nI agree with you about the issue.",
      "created_at" : "2022-05-21T14:35:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25127#issuecomment-1133644542",
      "id" : 1133644542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25127",
      "node_id" : "IC_kwDOABII585Dkgr-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133644542/reactions"
      },
      "updated_at" : "2022-05-21T14:35:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133644542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "```cpp\r\nCTxDestination AddAndGetDestinationForScript(FillableSigningProvider& keystore, const CScript& script, OutputType type)\r\n{\r\n    // Add script to keystore\r\n    keystore.AddCScript(script);\r\n    // Note that scripts over 520 bytes are not yet supported.\r\n    switch (type) {\r\n    case OutputType::LEGACY:\r\n        return ScriptHash(script);\r\n    case OutputType::P2SH_SEGWIT:\r\n    case OutputType::BECH32: {\r\n        CTxDestination witdest = WitnessV0ScriptHash(script);\r\n        CScript witprog = GetScriptForDestination(witdest);\r\n        // Check if the resulting program is solvable (i.e. doesn't use an uncompressed key)\r\n        if (!IsSolvable(keystore, witprog)) return ScriptHash(script);\r\n        // Add the redeemscript, so that P2WSH and P2SH-P2WSH outputs are recognized as ours.\r\n        keystore.AddCScript(witprog);\r\n        if (type == OutputType::BECH32) {\r\n            return witdest;\r\n        } else {\r\n            return ScriptHash(witprog);\r\n        }\r\n    }\r\n    case OutputType::BECH32M: {} // This function should not be used for BECH32M, so let it assert\r\n    } // no default case, so the compiler can warn about missing cases\r\n    assert(false);\r\n}\r\n```\r\n\r\nYou can note here that both LEGACY and P2SH_SEGWIT returns ScriptHash.",
      "created_at" : "2022-05-21T20:38:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25127#issuecomment-1133765307",
      "id" : 1133765307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25127",
      "node_id" : "IC_kwDOABII585Dk-K7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133765307/reactions"
      },
      "updated_at" : "2022-05-21T20:38:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133765307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure if it would be the best approach, just did it for testing purpose and it worked:\r\n```cpp\r\nif (!request.params[2].isNull() && OutputTypeFromDestination(dest) != output_type) {\r\n    if (output_type == OutputType::P2SH_SEGWIT) {\r\n        if (descriptor->ToString().find(\"wsh\") == std::string::npos) {\r\n            // Only warns if the user has explicitly chosen an address type we cannot generate\r\n            warnings.push_back(\"Unable to make chosen address type, please ensure no uncompressed public keys are present.\");    \r\n        }\r\n    } else {\r\n      // Only warns if the user has explicitly chosen an address type we cannot generate\r\n      warnings.push_back(\"Unable to make chosen address type, please ensure no uncompressed public keys are present.\");\r\n    }\r\n}\r\n```",
      "created_at" : "2022-05-22T12:12:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25127#issuecomment-1133882634",
      "id" : 1133882634,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25127",
      "node_id" : "IC_kwDOABII585Dla0K",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133882634/reactions"
      },
      "updated_at" : "2022-05-22T12:12:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133882634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   }
]
