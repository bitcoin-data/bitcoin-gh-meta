[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The easiest way to reproduce this problem is to apply this patch, and then start `bitcoind` normally. This delays the main thread from loading the block index for 60 seconds.\r\n```diff\r\n--- a/src/init.cpp\r\n+++ b/src/init.cpp\r\n@@ -1343,6 +1343,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\r\n         bilingual_str strLoadError;\r\n \r\n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\r\n+        UninterruptibleSleep(std::chrono::milliseconds{60000});\r\n \r\n         do {\r\n             const int64_t load_block_index_start_time = GetTimeMillis();\r\n```",
      "created_at" : "2021-07-28T22:33:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-888664132",
      "id" : 888664132,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII58409_BE",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-28T22:33:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/888664132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#20295](https://github.com/bitcoin/bitcoin/pull/20295) (rpc: getblockfrompeer by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-07-29T03:33:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-888774167",
      "id" : 888774167,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5840-Z4X",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-03T20:44:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/888774167",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I have also received this failure when running the functional tests under ASAN in parallel.",
      "created_at" : "2021-07-29T18:01:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-889348674",
      "id" : 889348674,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841AmJC",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-29T18:01:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889348674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Wouldn't it make more sense to delay scheduling until later? Identical to how Connman does it?",
      "created_at" : "2021-07-30T09:34:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-889769312",
      "id" : 889769312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841CM1g",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T09:34:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889769312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke\r\n> Wouldn't it make more sense to delay scheduling until later? Identical to how Connman does it?\r\n\r\nGood idea, thanks! After more investigation, I think the root problem is that the peer manager's background tasks are started from `PeerManagerImpl()` constructor. The new version separates the starting of these background tasks from the constructor. It's done from a new method, `StartScheduledTasks()`, which is called at the end of `AppInitMain()` (startup). It should always be safe to delay (within reason) anything that runs in the background.\r\n\r\nForce-pushed ([previous version](https://github.com/LarryRuane/bitcoin/commit/c0f913de644bf5516bcfae0cc8a87c449ba80596)).",
      "created_at" : "2021-07-30T22:42:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890223175",
      "id" : 890223175,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841D7pH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T23:24:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890223175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Can we reproduce the crash with the new commit, or should it never occur now? I expected to see some removed code. Cheers.",
      "created_at" : "2021-07-31T01:23:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890271631",
      "id" : 890271631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841EHeP",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-31T01:23:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890271631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "You can reproduce the crash by running master plus the [patch](https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-888664132). This PR branch (either the first version or the current version) plus the patch should not reproduce the crash.\n\nThe reason there's no removed code (removing the first version) is because I did a force-push.",
      "created_at" : "2021-07-31T02:40:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890279856",
      "id" : 890279856,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841EJew",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-31T02:42:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890279856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "My interpretation was that `UninterruptibleSleep()` was enough to test the original commit https://github.com/LarryRuane/bitcoin/commit/c0f913de644bf5516bcfae0cc8a87c449ba80596 because of this asynchronous behavior:\r\n\r\n- `AppInitMain()` runs and `UninterruptibleSleep()` blocks the `loadblk` thread from connecting the tip\r\n- `PeerManagerImpl::CanDirectFetch()` runs elsewhere and causes an assertion because the blocks weren't connected yet\r\n\r\nHowever, now, it is not obvious to me that the original asynchronous crash can be observed with the new branch, because this behavior is synchronous:\r\n- `AppInitMain()` runs and `UninterruptibleSleep()` blocks the `loadblk` thread\r\n- `if (node.peerman) node.peerman->StartScheduledTasks(*node.scheduler);` is executed further down in the same stack of `AppInitMain()` after `UninterruptibleSleep()` finishes.\r\n\r\nSo even though master can produce the crash, I'm wondering if there's a creative way to reproduce it against the new commit, or we can somehow be sure it won't happen (other than conceptually). Maybe it can't happen at all now and it's not even worth, or even possible to recreate the crash against the latest commit (and then pull that code out to confirm the fix)?\r\n\r\nThanks!",
      "created_at" : "2021-07-31T03:19:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890283468",
      "id" : 890283468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841EKXM",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-31T03:25:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890283468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22577#discussion_r680299071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22577"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680299071"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: `CTxMemPool& pool,` can be moved to the line above to fill in the extra space that has been created.\r\n\r\nThere are four other lines in the commit that could use the same spacing fix:\r\nnet_processing.cpp:1401\r\nnet_processing.cpp:1408\r\nnet_processing.h:41\r\ntest/util/setup_common.cpp:201\r\n\r\nIt doesn't really matter too much but could save a future nit PR, although makes this code review slightly harder on the eyes",
      "commit_id" : "703b1e612a4bd4521e20ae21eb8fb7c19f4ef942",
      "created_at" : "2021-07-31T03:34:00Z",
      "diff_hunk" : "@@ -271,7 +271,7 @@ class PeerManagerImpl final : public PeerManager\n {\n public:\n     PeerManagerImpl(const CChainParams& chainparams, CConnman& connman, CAddrMan& addrman,\n-                    BanMan* banman, CScheduler& scheduler, ChainstateManager& chainman,\n+                    BanMan* banman, ChainstateManager& chainman,\n                     CTxMemPool& pool, bool ignore_incoming_txs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#discussion_r680299071",
      "id" : 680299071,
      "line" : 275,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDI5OTA3MQ==",
      "original_commit_id" : "703b1e612a4bd4521e20ae21eb8fb7c19f4ef942",
      "original_line" : 275,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 719541001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22577",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-31T03:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680299071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cr ACK 703b1e612a4bd4521e20ae21eb8fb7c19f4ef942",
      "created_at" : "2021-07-31T06:11:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890298433",
      "id" : 890298433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841EOBB",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-31T06:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890298433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22577#discussion_r680604671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22577"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680604671"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you, I thought about doing that but decided it would be better to minimize the diff. Also, `clang-format-diff.py` didn't suggest doing that.",
      "commit_id" : "703b1e612a4bd4521e20ae21eb8fb7c19f4ef942",
      "created_at" : "2021-08-02T01:45:00Z",
      "diff_hunk" : "@@ -271,7 +271,7 @@ class PeerManagerImpl final : public PeerManager\n {\n public:\n     PeerManagerImpl(const CChainParams& chainparams, CConnman& connman, CAddrMan& addrman,\n-                    BanMan* banman, CScheduler& scheduler, ChainstateManager& chainman,\n+                    BanMan* banman, ChainstateManager& chainman,\n                     CTxMemPool& pool, bool ignore_incoming_txs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#discussion_r680604671",
      "id" : 680604671,
      "in_reply_to_id" : 680299071,
      "line" : 275,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDYwNDY3MQ==",
      "original_commit_id" : "703b1e612a4bd4521e20ae21eb8fb7c19f4ef942",
      "original_line" : 275,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 719731955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22577",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-02T01:45:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680604671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tested ACK 703b1e612a4bd4521e20ae21eb8fb7c19f4ef942\r\n\r\nApproach ACK, prefer over the original changes conceptually. I find myself asking whether replacing a pointer check(https://github.com/bitcoin/bitcoin/commit/c0f913de644bf5516bcfae0cc8a87c449ba80596) with a whole new async task is worth it. Code-wise I think this adds a little abstraction, but it seems like the right direction, however.\r\n\r\nSgtm. \r\n\r\nDownside: can't insert a wrench in this code to duplicate the original bad behavior, but that doesn't seem necessary.\r\n\r\n",
      "created_at" : "2021-08-02T05:12:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890721436",
      "id" : 890721436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841F1Sc",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-02T05:22:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890721436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@tryphe\r\n> ... a whole new async task ...\r\n\r\nIt's not a new async task; all this PR does is move where the two peer-related async tasks are started to a later time during system initialization.\r\n\r\n> Downside: can't insert a wrench in this code to duplicate the original bad behavior ...\r\n\r\nI'm unclear on what you mean, and same with your earlier comment:\r\n\r\n> ... I'm wondering if there's a creative way to reproduce it against the new commit ...\r\n\r\nThe whole point of the PR is that even with the [reproduction patch](https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-888664132) (the extra delay) that causes the failure on master, it shouldn't be possible for that patch, or any patch, to reproduce the problem with this PR's new (or even with its old) commit. Maybe I'm missing something?",
      "created_at" : "2021-08-02T17:54:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-891218240",
      "id" : 891218240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841HulA",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-02T18:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/891218240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 703b1e612a4bd4521e20ae21eb8fb7c19f4ef942\r\n\r\nTested that master crashes with the patch from https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-888664132 and that 703b1e612a4bd4521e20ae21eb8fb7c19f4ef942 does not crash anymore.",
      "created_at" : "2021-08-02T21:45:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-891355420",
      "id" : 891355420,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841IQEc",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-02T21:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/891355420",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">     ... I'm wondering if there's a creative way to reproduce it against the new commit ...\r\n\r\nIt should be possible to reproduce again by moving the `node.peerman->StartScheduledTasks(*node.scheduler);` to right after the make_unique.",
      "created_at" : "2021-08-03T07:42:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-891615490",
      "id" : 891615490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841JPkC",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-03T07:42:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/891615490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@tryphe, Marco's comment helped me understand what you're asking for. You're looking for a patch to apply to the latest code that will cause the failure. \r\n<details>\r\n  <summary>Here's the patch that Marco suggested that should reproduce the problem (apply to this PR)</summary>\r\n  \r\n```diff\r\n--- a/src/init.cpp\r\n+++ b/src/init.cpp\r\n@@ -1181,6 +1181,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\r\n     assert(!node.peerman);\r\n     node.peerman = PeerManager::make(chainparams, *node.connman, *node.addrman, node.banman.get(),\r\n                                      chainman, *node.mempool, ignores_incoming_txs);\r\n+    if (node.peerman) node.peerman->StartScheduledTasks(*node.scheduler);\r\n     RegisterValidationInterface(node.peerman.get());\r\n \r\n     // sanitize comments per BIP-0014, format user agent and check total size\r\n@@ -1343,6 +1344,8 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\r\n         bilingual_str strLoadError;\r\n \r\n         uiInterface.InitMessage(_(\"Loading block indexâ¦\").translated);\r\n+        // This delay must be > EXTRA_PEER_CHECK_INTERVAL (45 seconds) to reproduce the failure\r\n+        UninterruptibleSleep(std::chrono::seconds{60});\r\n \r\n         do {\r\n             const int64_t load_block_index_start_time = GetTimeMillis();\r\n@@ -1789,8 +1792,6 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\r\n         banman->DumpBanlist();\r\n     }, DUMP_BANS_INTERVAL);\r\n \r\n-    if (node.peerman) node.peerman->StartScheduledTasks(*node.scheduler);\r\n-\r\n #if HAVE_SYSTEM\r\n     StartupNotify(args);\r\n #endif\r\n```\r\n</details>",
      "created_at" : "2021-08-04T14:51:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-892724230",
      "id" : 892724230,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841NeQG",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-04T14:51:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/892724230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-08-04T15:42:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-892765442",
      "id" : 892765442,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22577",
      "node_id" : "IC_kwDOABII5841NoUC",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-04T15:42:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/892765442",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
