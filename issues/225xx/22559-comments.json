[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you share the result for `bitcoin-cli -netinfo` and relevant options from bitcoin.conf ? Does this happen only with i2p peers?",
      "created_at" : "2021-07-26T22:07:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887060058",
      "id" : 887060058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII584033Za",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-26T22:07:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887060058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Can you share the result for `bitcoin-cli -netinfo` and relevant options from bitcoin.conf ? Does this happen only with i2p peers?\r\n\r\nSure! {moved extra info to original post about being an I2P-only node}\r\n\r\nEdit: I misread your initial request but here's the `-getinfo` output:\r\n```\r\nBitcoin Core v22.99.0-8193294caba0-dirty - 70016/Satoshi:22.99.0/\r\n\r\n        ipv4    ipv6   onion     i2p   total   block  manual\r\nin         0       0       0       3       3\r\nout        0       0       0      11      11       0       2\r\ntotal      0       0       0      14      14\r\n\r\nLocal addresses\r\nbitcornrd36coazsbzsz4pdebyzvaplmsalq4kpoljmn6cg6x5zq.b32.i2p     port      0    score      4\r\n```\r\n\r\n`getnetworkinfo`:\r\n```\r\n{\r\n  \"version\": 229900,\r\n  \"subversion\": \"/Satoshi:22.99.0/\",\r\n  \"protocolversion\": 70016,\r\n  \"localservices\": \"0000000000000409\",\r\n  \"localservicesnames\": [\r\n    \"NETWORK\",\r\n    \"WITNESS\",\r\n    \"NETWORK_LIMITED\"\r\n  ],\r\n  \"localrelay\": true,\r\n  \"timeoffset\": -6,\r\n  \"networkactive\": true,\r\n  \"connections\": 10,\r\n  \"connections_in\": 4,\r\n  \"connections_out\": 6,\r\n  \"networks\": [\r\n    {\r\n      \"name\": \"ipv4\",\r\n      \"limited\": true,\r\n      \"reachable\": false,\r\n      \"proxy\": \"\",\r\n      \"proxy_randomize_credentials\": false\r\n    },\r\n    {\r\n      \"name\": \"ipv6\",\r\n      \"limited\": true,\r\n      \"reachable\": false,\r\n      \"proxy\": \"\",\r\n      \"proxy_randomize_credentials\": false\r\n    },\r\n    {\r\n      \"name\": \"onion\",\r\n      \"limited\": true,\r\n      \"reachable\": false,\r\n      \"proxy\": \"\",\r\n      \"proxy_randomize_credentials\": false\r\n    },\r\n    {\r\n      \"name\": \"i2p\",\r\n      \"limited\": false,\r\n      \"reachable\": true,\r\n      \"proxy\": \"127.0.0.1:7656\",\r\n      \"proxy_randomize_credentials\": false\r\n    }\r\n  ],\r\n  \"relayfee\": 0.00001000,\r\n  \"incrementalfee\": 0.00001000,\r\n  \"localaddresses\": [\r\n    {\r\n      \"address\": \"bitcornrd36coazsbzsz4pdebyzvaplmsalq4kpoljmn6cg6x5zq.b32.i2p\",\r\n      \"port\": 0,\r\n      \"score\": 4\r\n    }\r\n  ],\r\n  \"warnings\": \"This is a pre-release test build - use at your own risk - do not use for mining or merchant applications\"\r\n}\r\n```\r\n\r\nbitcoin.conf:\r\n```\r\nlisten=1\r\nport=8333\r\nbind=127.0.0.1\r\nonlynet=i2p\r\ni2pacceptincoming=1\r\ni2psam=127.0.0.1:7656\r\n```\r\n\r\n(note: removed the `port=` line and the bug still occurs)",
      "created_at" : "2021-07-27T00:24:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887117828",
      "id" : 887117828,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404FgE",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-24T01:56:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887117828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for reporting and for testing an I2P service. Are you or the inbound peer running a version before https://github.com/bitcoin/bitcoin/pull/22112? I see you're setting port to 8333. (This might be a duplicate of https://github.com/bitcoin/bitcoin/issues/21389.)",
      "created_at" : "2021-07-27T03:46:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887184901",
      "id" : 887184901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404V4F",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T03:49:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887184901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Thanks for reporting. Are you or the inbound peer running a version before #22112? I see you're setting port to 8333. (This might be a duplicate of #21389.)\r\n\r\nNegative. The port=0 change was merged on 7/13, and the version was bumped to 0.22 on 7/20. I just happened to leave my config the same.",
      "created_at" : "2021-07-27T03:49:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887185619",
      "id" : 887185619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404WDT",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T03:49:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887185619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "As per `getnetworkinfo`, my I2P port is forced to 0, so I don't think this something to do with the bug.",
      "created_at" : "2021-07-27T03:53:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887186974",
      "id" : 887186974,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404WYe",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T03:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887186974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I tried to replicate the bug by waiting for a random I2P peer to make an inbound connection. Afterwards, I call `addconnection abc.b32.i2p full-outbound-relay`. I commented out [these lines](https://github.com/ytytgo/lit/blob/7f37a1d560a86aa0a4397c3dcdaa974337594c00/src/rpc/net.cpp#L350-L352) to skip the regtest check. \r\n\r\nBut I can't reproduce the bug in the OP, the call fails via debug.log: \r\n`Failed to open new connection, already connected`\r\n\r\nI think one or two things are happening here:\r\n1. Some environmental variables are at play. I did not connect to the peer as quickly as when the bug was produced. Ping times on I2P are often 5 to 20 seconds. I'm not sure if this could cause the issue. I often see inbound/outbound duplicate connections to the same peer at the same time, however the latter connection almost always closes within a few seconds, except for in the case of the OP and one other time that I've observed. Perhaps the bug happens if we connect simultaneously, but only under certain conditions?\r\n2. Maybe the call stack which fails during my test is not the same as during real time. There are many places in which we call `FindNode` in various fashions (sometimes called directly or through `AlreadyConnectedToAddress`, for example) and does not fail or succeed verbosely, which may lead to an edge case somewhere?\r\n",
      "created_at" : "2021-07-27T03:55:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887187447",
      "id" : 887187447,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404Wf3",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T05:15:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887187447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Are both peers you? (an inbound peer running an earlier version could still double connect to you.)",
      "created_at" : "2021-07-27T04:01:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887189364",
      "id" : 887189364,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404W90",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T04:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887189364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Are both peers you? (an inbound peer running an earlier version could still double connect to you.)\r\n\r\nNope, although they do have an @dunxen in their User Agent. But I'm unsure who that is. We are both running the i2p-port=0 branch.",
      "created_at" : "2021-07-27T04:03:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887190269",
      "id" : 887190269,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404XL9",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T04:03:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887190269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I just tried doing the reverse of what happens in the bug, except for the connections happening simultaneously. \r\n\r\nThe identical peer in the OP is connected to me. \r\nI try: \r\n`addconnection jz3s4eurm5vzjresf4mwo7oni4bk36daolwxh4iqtewakylgkxmq.b32.i2p outbound-full-relay` \r\nand it fails with:\r\n`Failed to open new connection, already connected`.\r\n\r\n So maybe it is a timing issue.",
      "created_at" : "2021-07-27T04:13:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887194071",
      "id" : 887194071,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404YHX",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T04:23:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887194071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Just restarted a clearnet/onion/i2p node and both peers were briefly double-connected to me as double inbound peers, but only for a few seconds and now down to one connection each.\r\n\r\n@duncandean, at what commit is your I2P service running? (cli -version or -netinfo will tell you)",
      "created_at" : "2021-07-27T04:29:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887199651",
      "id" : 887199651,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404Zej",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T04:30:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887199651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Just restarted a clearnet/onion/i2p node and both peers were briefly double-connected to me as double inbound peers, but only for a few seconds and now down to one connection each.\r\n\r\nSounds about right, I've observed this as well. I only spotted the bug because I frequently look at my peer list to see how quickly people are onboarding to I2P. But fwiw, my node was up for about a week before I observed the 12 hour long connections in the OP.\r\n\r\nI'm going to clone my I2P machine to see if I can reproduce the bug by connecting to myself.",
      "created_at" : "2021-07-27T04:45:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887204696",
      "id" : 887204696,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404atY",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T05:00:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887204696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @duncandean, at what commit is your I2P service running? (cli -version or -netinfo will tell you)\n\nI'm at fd557ceb.\n\nAlso, I do have an `addnode=bitcorn...` in my config.\n\n",
      "created_at" : "2021-07-27T05:35:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887223569",
      "id" : 887223569,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404fUR",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T05:45:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887223569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/duncandean/events{/privacy}",
         "followers_url" : "https://api.github.com/users/duncandean/followers",
         "following_url" : "https://api.github.com/users/duncandean/following{/other_user}",
         "gists_url" : "https://api.github.com/users/duncandean/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/duncandean",
         "id" : 3072149,
         "login" : "duncandean",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/duncandean/orgs",
         "received_events_url" : "https://api.github.com/users/duncandean/received_events",
         "repos_url" : "https://api.github.com/users/duncandean/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/duncandean/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/duncandean/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/duncandean"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > @duncandean, at what commit is your I2P service running? (cli -version or -netinfo will tell you)\r\n> \r\n> I'm at [fd557ce](https://github.com/bitcoin/bitcoin/commit/fd557ceb885ec55ac6865953e7325bcebc5a6972).\r\n> \r\n> Also, I do have an `addnode=bitcorn...` in my config.\r\n\r\nAhh, thanks for clarifying!\r\n\r\nI wonder why my node automatically maintained a connection to you, though. I don't use any addnodes.",
      "created_at" : "2021-07-27T05:52:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887230321",
      "id" : 887230321,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404g9x",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T05:53:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887230321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@tryphe you will probably see the address if you run rpc getnodeaddresses 0 \"i2p\", indicating its in your addrman. Then look at how many I2P peers your node knows (cli -addrinfo gives the totals).",
      "created_at" : "2021-07-27T07:15:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887272056",
      "id" : 887272056,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404rJ4",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T07:15:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887272056",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @tryphe you will probably see the address if you run rpc getnodeaddresses 0 \"i2p\", indicating its in your addrman. Then look at how many I2P peers your node knows (cli -addrinfo gives the totals).\r\n\r\n18 I2P peers currently.",
      "created_at" : "2021-07-27T07:54:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887295157",
      "id" : 887295157,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404wy1",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T07:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887295157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I was able to reproduce the behavior of the bug with 2 machines on mainnet. To reproduce:\r\n\r\nOptional steps on installing if you don't have an I2P node: \r\na. [stackexchange howto for I2P bitcoin](https://bitcoin.stackexchange.com/a/103403)\r\nb. Configure and confirm your i2pd mixnet(external) port and sam(local loopback) port in `/etc/i2pd/i2pd.conf`\r\nc. Restart i2pd: `sudo systemctl restart i2pd`\r\nd. Ensure the sam/mixnet ports are listening locally: `ss -lt`. You should see `127.0.0.1:sam_port`(default 7656) and `0.0.0.0:mixnet_port`(random port)\r\ne. Open a hole in your firewall to your mixnet ports. One mixnet port for each machine.\r\n\r\n1. Obtain two I2P bitcoin nodes and ensure the I2P mixnet port is _externally_ accessible on each machine. \r\n\r\n2. Start bitcoind or bitcoin-qt. Run `getnetworkinfo` until the service is established and you see your `abcdef.b32.i2p` address near the bottom of the output. Takes a few minutes.\r\n\r\n3. On machine A, enter `addnode machine_b_address.b32.i2p onetry`, and vice versa on machine B.\r\n\r\n4. Run the commands at the same time.\r\n\r\nIf you are fast enough, the machines will maintain two connections, and the bug occurs. If you are too slow, normal expected behavior will occur, and each subsequent connection will close.\r\n\r\nNote: also works with `addconnection` instead of `addnode`, which has the same behavior bugwise, but tags the connection differently, ie. \"Full Relay\" vs \"Manual\".",
      "created_at" : "2021-07-27T08:09:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887305332",
      "id" : 887305332,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404zR0",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T09:11:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887305332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I didn't test it on normal IP but I'm going to assume the latency has something to do with the bug. Otherwise it would have already been reported.... maybe. If anyone can try to reproduce it on non-i2p with/without some latency, that would be sweet!",
      "created_at" : "2021-07-27T09:19:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887352658",
      "id" : 887352658,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58404-1S",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T09:23:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887352658",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Doh, this seems like a duplicate of https://github.com/bitcoin/bitcoin/issues/21389. Just realized, sorry. Will follow up there if there's a good solution found.",
      "created_at" : "2021-07-27T10:47:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887409971",
      "id" : 887409971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58405M0z",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T10:47:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887409971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jonatack I think we should re-open the original issue instead of keeping this one open. Regarding [this comment](https://github.com/bitcoin/bitcoin/issues/21389#issuecomment-866925116), it should be fixed, but isn't.\r\n\r\nBut feel free to re-open this one if you want.\r\n\r\nNote: I removed the `port=` line from my config before and after testing, so it seems unrelated to that.",
      "created_at" : "2021-07-27T10:53:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887412967",
      "id" : 887412967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58405Njn",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T10:55:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887412967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Note: I removed the `port=` line from my config before and after testing, so it seems unrelated to that.\r\n\r\nI didn't try setting port=8333 while testing #22112, so thanks for checking and reporting on that.  I have `watch -netinfo 4` running all the time and haven't seen any persistent double connections lately but will keep an eye out.  Good to finally know who the `bitcorn...b32.i2p` address is!",
      "created_at" : "2021-07-27T11:43:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887442171",
      "id" : 887442171,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58405Ur7",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T11:43:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887442171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Naive idea that probably has issues or is redundant but I might look further into something like\r\n\r\n```diff\r\n@@ -1192,6 +1192,12 @@ void CConnman::CreateNodeFromAcceptedSocket(SOCKET hSocket,\r\n     // on all platforms.  Set it again here just to be sure.\r\n     SetSocketNoDelay(hSocket);\r\n \r\n+    // Don't accept connection if already connected.\r\n+    if (AlreadyConnectedToAddress(addr)) {\r\n+        CloseSocket(hSocket);\r\n+        return;\r\n+    }\r\n+\r\n```\r\n",
      "created_at" : "2021-07-27T12:05:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887455320",
      "id" : 887455320,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58405X5Y",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T12:05:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887455320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this is a different issue than https://github.com/bitcoin/bitcoin/issues/21389.\r\n\r\nThe latter allowed `A` to open more than one outgoing connections to `B` on different ports. This is I2P specific because ports are irrelevant in I2P (when using SAM 3.1), so connecting to `B:port1` and `B:port2` would be, for sure, connecting to the same peer.\r\n\r\nThis issue looks to be about `A` opening a connection to `B` while, at about the same time, `B` opening a connection to `A`. I think, with the right timing, this can happen also with other networks, i.e. is not I2P specific. I have not confirmed that with an experiment.",
      "created_at" : "2021-07-27T13:05:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887494942",
      "id" : 887494942,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58405hke",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T13:05:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887494942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks vasild! That makes sense. If one socket is already open, it works as intended. I'll reopen this.",
      "created_at" : "2021-07-27T20:36:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887817351",
      "id" : 887817351,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58406wSH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T20:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887817351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jonatack I tried your patch(looks like the comment is deleted now) with some added verbosity and both nodes disconnect each other instead of maintaining redundant connections.\r\n\r\nThis looks like an observation timing problem. From the perspective of node A and B, they both tried to connect first. If they disconnect on accept, both are disconnected. If we make them disconnect after accept, I assume both will disconnect unless there is some sort of agreement made on who will disconnect. Something like: `if (my_address < peer_address) { disconnect(); }` that way only one side will disconnect and no communication is required.\r\n\r\nBut putting in this kind of logic will require the other peer to have an updated binary. Maybe if they don't disconnect after a certain period and they are the one with a lower peer address, disconnect one of the redundant sockets after a certain period.\r\n\r\nOr maybe it can be done with just some `FindNode()` logic and an edge case is missing somewhere. I'm not sure.",
      "created_at" : "2021-07-27T22:35:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-887879011",
      "id" : 887879011,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58406_Vj",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T22:47:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887879011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I observed the bug happening again today while restarting my node on the current master branch with a different 22.99.0 peer.\r\n\r\nMaybe we can add a task scheduler routine to check for duplicate connections? It seems like we can't patch into existing functionality so this seems like the most obvious thing to do.\r\n\r\n",
      "created_at" : "2021-08-02T04:46:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-890710790",
      "id" : 890710790,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII5841FysG",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-02T04:49:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890710790",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Was the double connection in+in or in+out? An I2P peer?",
      "created_at" : "2021-08-02T10:01:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-890895300",
      "id" : 890895300,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII5841GfvE",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-02T10:01:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890895300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Was the double connection in+in or in+out? An I2P peer?\r\n\r\nIn + out, I2P",
      "created_at" : "2021-08-02T22:26:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-891375318",
      "id" : 891375318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII5841IU7W",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-02T22:26:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/891375318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I have a (hopefully straight forward) question that's not exactly the same that OP mentioned, but somewhat related:\r\n\r\nWould `bitcoind` ever connect to (and stay connected to) the same node more than once if that node was using some combination of Tor, I2P, and clearnet? Or would it detect this reliably and only keep one of the connections?  ",
      "created_at" : "2021-08-14T10:32:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-898876871",
      "id" : 898876871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII5841k8XH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-14T10:32:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/898876871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/77220130?v=4",
         "events_url" : "https://api.github.com/users/xanoni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/xanoni/followers",
         "following_url" : "https://api.github.com/users/xanoni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/xanoni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/xanoni",
         "id" : 77220130,
         "login" : "xanoni",
         "node_id" : "MDQ6VXNlcjc3MjIwMTMw",
         "organizations_url" : "https://api.github.com/users/xanoni/orgs",
         "received_events_url" : "https://api.github.com/users/xanoni/received_events",
         "repos_url" : "https://api.github.com/users/xanoni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/xanoni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/xanoni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/xanoni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Would `bitcoind` ever connect to (and stay connected to) the same node more than once if that node was using some combination of Tor, I2P, and clearnet? Or would it detect this reliably and only keep one of the connections?\r\n\r\nThere is no such detection. So we can connect to e.g. `2.39.173.126:8333` and `2g5qfdkn2vvcbqhzcyvyiitg4ceukybxklraxjnu7atlhd22gdwywaid.onion:8333` and remain connected even if that is the same (multi-homed) node.\r\n\r\nThere is only a detection that we do not keep a connection to ourselves. It works roughly like this: when `A` connects to `B`, `A` assigns a \"random\" nonce to that connection and sends it as part of the `VERSION` message to `B`. When `B` receives the `VERSION` message it checks if the nonce from it equals any of the nonces of its outgoing connections - if it does, then `B` closes the just accepted connection, thinking that it connected to itself:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/192a959b65660ffacedb5a5eb2a0d26736c636d7/src/net_processing.cpp#L2535-L2541",
      "created_at" : "2021-08-20T12:48:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-902666895",
      "id" : 902666895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII5841zZqP",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-20T12:49:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902666895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> There is no such detection.\r\n\r\nThank you. How difficult would it be to detect this, if desired? Is there some type of fingerprint/key/identifier that could be matched? Or would this require a whole new mechanism to be designed & implemented? [1]\r\n\r\nAlso, would it be possible for an attacker to just create 13,337 Hidden Services (e.g., all `.onion`'s or a mix of I2P and Tor) that all connect to the same `bitcoind`? Or does `bitcoind` only behave predictably with one address per network? I assume independent of the answer, an attacker could modify `bitcoind` to handle a large number of addresses predictably.\r\n\r\n(One could also reframe the above as: can I protect my node from Sybil-attacks by creating an undisclosed number of extra hidden services / I2P destinations?)\r\n\r\n[1] If yes, it could potentially be similar to what JoinMarket is doing with its Fidelity Bonds. (Assuming one wants protection from malicious Sybil activity ... otherwise I guess there would be a non-deposit solution.) However, I am aware that this would be a very major change and is probably not needed.",
      "created_at" : "2021-08-20T21:35:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-902970365",
      "id" : 902970365,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58410jv9",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-20T21:42:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902970365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/77220130?v=4",
         "events_url" : "https://api.github.com/users/xanoni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/xanoni/followers",
         "following_url" : "https://api.github.com/users/xanoni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/xanoni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/xanoni",
         "id" : 77220130,
         "login" : "xanoni",
         "node_id" : "MDQ6VXNlcjc3MjIwMTMw",
         "organizations_url" : "https://api.github.com/users/xanoni/orgs",
         "received_events_url" : "https://api.github.com/users/xanoni/received_events",
         "repos_url" : "https://api.github.com/users/xanoni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/xanoni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/xanoni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/xanoni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I noticed 2 inbound connections to me from a `22.0.0` peer which lasted many hours, so I updated the OP with the relevant peer info. I knew in+out was possible, but not in+in, which seems more dangerous as it seems like an I2P peer could _possibly_ maliciously fill as many of my inbound connections as they want, with careful timing. \r\n\r\nAlthough I'm not sure whether this is conceptually more dangerous than someone just creating a bunch of different I2P addresses and connecting to me normally, which is already possible without the bug.",
      "created_at" : "2021-08-22T21:36:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-903333808",
      "id" : 903333808,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII584118ew",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-23T04:11:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903333808",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I confirm the 2x inbound case: just execute the below two times quickly one after another (in different terminals, e.g. start connecting to the same peer at the same time):\r\n```\r\nbitcoin-cli addnode 4hllr6w55mbtemb3ebvlzl4zj6qke4si7zcob5qdyg63mjgq624a.b32.i2p:0 onetry\r\n```\r\n\r\nThe relevant code is:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/f6f7a12462b381945b1cb9bcb94b129d8fb7e289/src/net.cpp#L2214-L2233\r\n\r\nThis is the code that opens a new connection - on line 2216 or 2219 it checks if we are already connected to the peer (this looks into `vNodes`) and it adds the peer to `vNodes` later on line 2232. So, if two threads come here and pass the check \"not already connected to that peer\" they will both connect and add the peer to `vNodes`.\r\n\r\nThis is not I2P specific, but if `ConnectNode()` (line 2222) is slow like in I2P, that makes it more likely to occur. ",
      "created_at" : "2021-08-23T14:59:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-903851322",
      "id" : 903851322,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58413606",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-23T14:59:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903851322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @vasild! I can confirm this. I initially tried this with a bunch of peers that weren't myself, to no avial. Seems like my latency was too low to reproduce the bug after being connected to the mixnet for a while. But I tried again with a fresh VM and a fresh I2P address and was able to easily open 4 connections to my main node.\r\n\r\n```\r\n$ ./bitcoin-cli getpeerinfo | grep \\\"addr\\\":\r\n    \"addr\": \"yadcavfqg6urtrpss2zxylxumw6sbp5tgk6hon7uxosjippeulwa.b32.i2p:0\",\r\n    \"addr\": \"yadcavfqg6urtrpss2zxylxumw6sbp5tgk6hon7uxosjippeulwa.b32.i2p:0\",\r\n    \"addr\": \"yadcavfqg6urtrpss2zxylxumw6sbp5tgk6hon7uxosjippeulwa.b32.i2p:0\",\r\n    \"addr\": \"yadcavfqg6urtrpss2zxylxumw6sbp5tgk6hon7uxosjippeulwa.b32.i2p:0\",\r\n```\r\n",
      "created_at" : "2021-08-24T01:50:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-904256504",
      "id" : 904256504,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58415dv4",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-24T01:57:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/904256504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If we modify `ConnectNode()` to remove the outbound race condition, there is still an inbound race condition near this call to `AcceptConnection()`:\r\nhttps://github.com/bitcoin/bitcoin/blob/602c8eb8f0fb1a09ba44b8a744c4aaf3f8a6a78a/src/net.cpp#L1528 \r\n\r\nThe new connection is accepted but the node is not added to `vNodes` until these lines within the nested call to `CreateNodeFromAcceptedSocket()`:\r\nhttps://github.com/bitcoin/bitcoin/blob/602c8eb8f0fb1a09ba44b8a744c4aaf3f8a6a78a/src/net.cpp#L1205-L1208\r\n\r\nWe should look into fixing both inbound and outbound races so that even clients with OR without the outbound race won't be able to create duplicate connections to future nodes that have been patched for this bug.\r\n\r\nI'm not sure if acquiring the lock for the whole call to `AcceptConnection()` and `ConnectNode()` is necessary though, it seems a bit heavy handed and we could possibly avoid it with different logic flow.",
      "created_at" : "2021-08-24T02:04:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22559#issuecomment-904261220",
      "id" : 904261220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22559",
      "node_id" : "IC_kwDOABII58415e5k",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-24T04:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/904261220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   }
]
