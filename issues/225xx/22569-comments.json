[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22569#discussion_r679032482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679032482"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These don't strictly need to be atomic since they're guarded by cs_main now, but there's no harm in leaving them like this.",
      "commit_id" : "55fcbde5a9fc35b187a8cb31004e5ce94bdbbedd",
      "created_at" : "2021-07-29T10:34:17Z",
      "diff_hunk" : "@@ -387,6 +394,16 @@ struct CNodeState {\n     //! Whether this peer relays txs via wtxid\n     bool m_wtxid_relay{false};\n \n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{GetTime<std::chrono::microseconds>()};\n+    /** Total number of addresses that were dropped due to rate limiting. */\n+    std::atomic<uint64_t> m_addr_rate_limited{0};\n+    /** Total number of addresses that were processed (excludes rate limited ones). */\n+    std::atomic<uint64_t> m_addr_processed{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#discussion_r679032482",
      "id" : 679032482,
      "line" : 405,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTAzMjQ4Mg==",
      "original_commit_id" : "55fcbde5a9fc35b187a8cb31004e5ce94bdbbedd",
      "original_line" : 405,
      "original_position" : 26,
      "original_start_line" : 403,
      "path" : "src/net_processing.cpp",
      "position" : 26,
      "pull_request_review_id" : 717936061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22569",
      "side" : "RIGHT",
      "start_line" : 403,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-29T10:35:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679032482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22569#discussion_r679291362"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679291362"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree, I may address this if I retouch.",
      "commit_id" : "4e6661fe5c60f555246abec7e16287d951feb317",
      "created_at" : "2021-07-29T16:07:22Z",
      "diff_hunk" : "@@ -387,6 +394,16 @@ struct CNodeState {\n     //! Whether this peer relays txs via wtxid\n     bool m_wtxid_relay{false};\n \n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{GetTime<std::chrono::microseconds>()};\n+    /** Total number of addresses that were dropped due to rate limiting. */\n+    std::atomic<uint64_t> m_addr_rate_limited{0};\n+    /** Total number of addresses that were processed (excludes rate limited ones). */\n+    std::atomic<uint64_t> m_addr_processed{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#discussion_r679291362",
      "id" : 679291362,
      "in_reply_to_id" : 679032482,
      "line" : 405,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTI5MTM2Mg==",
      "original_commit_id" : "55fcbde5a9fc35b187a8cb31004e5ce94bdbbedd",
      "original_line" : 405,
      "original_position" : 26,
      "original_start_line" : 403,
      "path" : "src/net_processing.cpp",
      "position" : 26,
      "pull_request_review_id" : 718281718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22569",
      "side" : "RIGHT",
      "start_line" : 403,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-29T16:07:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679291362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22569#discussion_r679307646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679307646"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, no need to change the branch. Just pointing it out in case it confused other reviewers.",
      "commit_id" : "4e6661fe5c60f555246abec7e16287d951feb317",
      "created_at" : "2021-07-29T16:28:38Z",
      "diff_hunk" : "@@ -387,6 +394,16 @@ struct CNodeState {\n     //! Whether this peer relays txs via wtxid\n     bool m_wtxid_relay{false};\n \n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{GetTime<std::chrono::microseconds>()};\n+    /** Total number of addresses that were dropped due to rate limiting. */\n+    std::atomic<uint64_t> m_addr_rate_limited{0};\n+    /** Total number of addresses that were processed (excludes rate limited ones). */\n+    std::atomic<uint64_t> m_addr_processed{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#discussion_r679307646",
      "id" : 679307646,
      "in_reply_to_id" : 679032482,
      "line" : 405,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTMwNzY0Ng==",
      "original_commit_id" : "55fcbde5a9fc35b187a8cb31004e5ce94bdbbedd",
      "original_line" : 405,
      "original_position" : 26,
      "original_start_line" : 403,
      "path" : "src/net_processing.cpp",
      "position" : 26,
      "pull_request_review_id" : 718302274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22569",
      "side" : "RIGHT",
      "start_line" : 403,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-29T16:28:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679307646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK 651216e70b0cd1aaa1318db07e1d89d9cbb65cf3",
      "created_at" : "2021-07-29T16:47:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-889302390",
      "id" : 889302390,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841Aa12",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-29T16:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889302390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipsorcery @fanquake Any idea what is causing the appveyor failure here?",
      "created_at" : "2021-07-29T19:05:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-889387893",
      "id" : 889387893,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841Avt1",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-29T19:05:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889387893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I can fix the compiler error by adjusting `misc.cpp` line 390 to the below. I'm not enough of a C++ expert to say why.\r\n\r\n````\r\n  if (request.context.Has<NodeContext>()) {\r\n        auto & chainClients = request.context.Get<NodeContext>().chain_clients;\r\n        for (const auto& chain_client : chainClients) {\r\n            chain_client->setMockTime(time);\r\n        }\r\n    }\r\n````",
      "created_at" : "2021-07-29T20:07:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-889423669",
      "id" : 889423669,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841A4c1",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-29T20:07:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889423669",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I don't understand how this: ...\r\n\r\nProbably a msvc bug in C++11 mode?",
      "created_at" : "2021-07-30T10:01:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-889783823",
      "id" : 889783823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841CQYP",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T10:01:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889783823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Probably a msvc bug in C++11 mode?\r\n\r\nThe msvc build config uses C++14. As an experiment I did try with msvc & C++17 and it generated the same error.\r\n",
      "created_at" : "2021-07-30T10:16:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-889792974",
      "id" : 889792974,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841CSnO",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T10:16:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889792974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like the bug started happening unrelated to any of our changes between May 31st and June 19th (https://github.com/bitcoin/bitcoin/commit/926f76cb205ce9ef085f4945cdb439746b140414)",
      "created_at" : "2021-07-30T11:11:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-889821107",
      "id" : 889821107,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841CZez",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T11:11:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889821107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Hmm, now a fuzzer job times out?",
      "created_at" : "2021-07-31T03:37:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-890284871",
      "id" : 890284871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841EKtH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-31T03:37:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890284871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK 33332768c7",
      "created_at" : "2021-08-03T12:13:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-891796913",
      "id" : 891796913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841J72x",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-03T12:13:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/891796913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 33332768c7842a665679f4bcccc4504c542f09e6",
      "created_at" : "2021-08-03T20:31:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-892145144",
      "id" : 892145144,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841LQ34",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-03T20:31:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/892145144",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't understand why this needs the cs_main lock. The following backport compiled just fine:\r\n\r\n```diff\r\ndiff --git a/src/net_permissions.h b/src/net_permissions.h\r\nindex bba0ea1695..3b841ab138 100644\r\n--- a/src/net_permissions.h\r\n+++ b/src/net_permissions.h\r\n@@ -32,3 +32,4 @@ enum NetPermissionFlags {\r\n     PF_MEMPOOL = (1U << 5),\r\n-    // Can request addrs without hitting a privacy-preserving cache\r\n+    // Can request addrs without hitting a privacy-preserving cache, and send us\r\n+    // unlimited amounts of addrs.\r\n     PF_ADDR = (1U << 7),\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex f29be8d8a3..019d00e7d6 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -148,2 +148,9 @@ static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\r\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\r\n+/** The maximum rate of address records we're willing to process on average. Can be bypassed using\r\n+ *  the NetPermissionFlags::Addr permission. */\r\n+static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};\r\n+/** The soft limit of the address processing token bucket (the regular MAX_ADDR_RATE_PER_SECOND\r\n+ *  based increments won't go above this, but the MAX_ADDR_TO_SEND increment following GETADDR\r\n+ *  is exempt from this limit. */\r\n+static constexpr size_t MAX_ADDR_PROCESSING_TOKEN_BUCKET{MAX_ADDR_TO_SEND};\r\n \r\n@@ -456,2 +463,8 @@ struct Peer {\r\n \r\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\r\n+     *  permit self-announcement. */\r\n+    double m_addr_token_bucket{1.0};\r\n+    /** When m_addr_token_bucket was last updated */\r\n+    std::chrono::microseconds m_addr_token_timestamp{GetTime<std::chrono::microseconds>()};\r\n+\r\n     Peer(NodeId id) : m_id(id) {}\r\n@@ -2440,2 +2453,5 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\r\n             pfrom.fGetAddr = true;\r\n+            // When requesting a getaddr, accept an additional MAX_ADDR_TO_SEND addresses in response\r\n+            // (bypassing the MAX_ADDR_PROCESSING_TOKEN_BUCKET limit).\r\n+            peer->m_addr_token_bucket += MAX_ADDR_TO_SEND;\r\n         }\r\n@@ -2593,2 +2609,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\r\n         int64_t nSince = nNow - 10 * 60;\r\n+\r\n+        // Update/increment addr rate limiting bucket.\r\n+        const auto current_time = GetTime<std::chrono::microseconds>();\r\n+        if (peer->m_addr_token_bucket < MAX_ADDR_PROCESSING_TOKEN_BUCKET) {\r\n+            // Don't increment bucket if it's already full\r\n+            const auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, std::chrono::microseconds{0});\r\n+            const double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\r\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_PROCESSING_TOKEN_BUCKET);\r\n+        }\r\n+        peer->m_addr_token_timestamp = current_time;\r\n+\r\n+        const bool rate_limited = !pfrom.HasPermission(NetPermissionFlags::PF_ADDR);\r\n         for (CAddress& addr : vAddr)\r\n@@ -2598,2 +2626,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\r\n \r\n+            // Apply rate limiting.\r\n+            if (rate_limited) {\r\n+                if (peer->m_addr_token_bucket < 1.0) break;\r\n+                peer->m_addr_token_bucket -= 1.0;\r\n+            }\r\n             // We only bother storing full nodes, though this may include\r\n",
      "created_at" : "2021-08-05T14:45:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-893518482",
      "id" : 893518482,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841QgKS",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T14:45:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893518482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "merging this is also fine, if you don't want to retouch. The only difference should be unneeded cs_main locks",
      "created_at" : "2021-08-05T15:30:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-893553303",
      "id" : 893553303,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841QoqX",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T15:30:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893553303",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke Is that a backport? Peer doesn't exist in 0.21.",
      "created_at" : "2021-08-05T15:33:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-893555737",
      "id" : 893555737,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841QpQZ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T15:33:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893555737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/blob/0.21/src/net_processing.cpp#L438",
      "created_at" : "2021-08-05T15:35:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-893557586",
      "id" : 893557586,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841QptS",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T15:35:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893557586",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke It would appear that I need better glasses. Fixed.",
      "created_at" : "2021-08-05T16:42:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-893604484",
      "id" : 893604484,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841Q1KE",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T16:42:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893604484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 2a5710805195ca54a02aff3540ceaefb9cb3b3e2",
      "created_at" : "2021-08-05T19:12:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-893717256",
      "id" : 893717256,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841RQsI",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T19:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893717256",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Approach + code review ACK [2a57108](https://github.com/bitcoin/bitcoin/pull/22569/commits/2a5710805195ca54a02aff3540ceaefb9cb3b3e2)",
      "created_at" : "2021-08-05T22:07:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-893838798",
      "id" : 893838798,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841RuXO",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T22:07:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893838798",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/80422284?v=4",
         "events_url" : "https://api.github.com/users/GeneFerneau/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GeneFerneau/followers",
         "following_url" : "https://api.github.com/users/GeneFerneau/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GeneFerneau/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GeneFerneau",
         "id" : 80422284,
         "login" : "GeneFerneau",
         "node_id" : "MDQ6VXNlcjgwNDIyMjg0",
         "organizations_url" : "https://api.github.com/users/GeneFerneau/orgs",
         "received_events_url" : "https://api.github.com/users/GeneFerneau/received_events",
         "repos_url" : "https://api.github.com/users/GeneFerneau/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GeneFerneau/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GeneFerneau/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GeneFerneau"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK 2a5710805195ca54a02aff3540ceaefb9cb3b3e2",
      "created_at" : "2021-08-06T09:49:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22569#issuecomment-894144108",
      "id" : 894144108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22569",
      "node_id" : "IC_kwDOABII5841S45s",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-06T09:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/894144108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
