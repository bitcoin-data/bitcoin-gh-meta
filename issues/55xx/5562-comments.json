[
   {
      "body" : "@TheBlueMatt This will probably require a comparison tool update to remove tests for the BIP34 changeover logic.",
      "created_at" : "2014-12-30T00:59:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-68320464",
      "id" : 68320464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2014-12-30T00:59:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/68320464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "You know, conceptually it feels like what we really want here is for the block validation logic to only apply BIP34, but allow the test to fail if we're validating a block prior to a BIP34-specific checkpoint.\r\n\r\nWhat you've written now has the weird effect that a huge reorg can create a different blockchain where BIP34 rules are disabled prior to a certain block height. A pedantic difference sure in this case, but quite possible on testnet. In the event of a security fix it might even matter - suppose the fix is for an exploit that lets you mine blocks unexpectedly easily. In that case we'd definitely have to apply the new rules based on a specific hash, rather than block height.\r\n\r\nSpeaking of checkpoints... Rather than just removing them I was thinking they should be renamed something like \"validation shortcuts\", with the behavior that validation is skipped until we're past the shortcut. However in the event of a large reorg, we do allow the reorg to happen, but instead validate all reorged blocks 100% Thus we end up in a situation where checkpoints no longer define history, but they are used as a easily-auditable shortcut to allow validation to be skipped.",
      "created_at" : "2015-01-03T05:04:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-68583655",
      "id" : 68583655,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-01-03T05:04:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/68583655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "@petertodd Good point - ideally the BIP34 check is indeed guarded by a block hash rather than just height. It does add a complication in the decision logic though, as it means we need to wait until the switchover header is downloaded and validated before we can do block validation. I'm not convinced that complication is worth the benefit in this case.\r\n\r\nI don't think we can remove checkpoints entirely. They're still needed to prevent being spammed with huge amounts of low-height valid header chains that fill nodes' memory. Using like you suggest would be a nice and easy step though - and doesn't suffer from the complication listed above (if the headers leading to the checkpoint aren't known/validated yet, we just use the stricter rule and do full validation).",
      "created_at" : "2015-01-04T15:56:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-68637511",
      "id" : 68637511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-01-04T15:56:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/68637511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I agree it's not worth it yet; more thinking down the road when we've had a bunch of these little upgrades. My understanding with headers first was it'd be totally reasonable to download the entire set of block headers, and only then start downloading blocks.\r\n\r\nWe can't yet I agree, although it's easy to forsee us being able to in the nearish future when we have better ways of determining the total work represented by a peer's claimed headers. The main thing I don't want to see is us move to a model where we skip validation as an optimization, but we do that based on a large amount of hashing power rather than an explicit \"shortcut/checkpoint/whatever\" out of the control of hashing power.",
      "created_at" : "2015-01-04T23:48:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-68655394",
      "id" : 68655394,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-01-04T23:48:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/68655394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "I would think we may want to keep IsSuperMajority around for future softforks, and I agree testnet should not be hard-coded like this.",
      "created_at" : "2015-01-05T02:14:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-68661040",
      "id" : 68661040,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-01-05T02:14:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/68661040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "@luke-jr Oh, I'm not suggesting we remove it, just suggesting there may be a simpler way to deal with older rule changes.",
      "created_at" : "2015-01-05T03:52:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-68665648",
      "id" : 68665648,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-01-05T03:52:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/68665648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "@luke-jr Oh wait, you mean @sipa's removal - well, that can be recovered from git history.\r\n\r\nre: testnet, we should be careful to make sure testnet and mainnet use as similar code as possible - it might make sense to have the testnet rule switchover even be *not* block zero, certainly to keep the logic there w/ block zero as the switchover.",
      "created_at" : "2015-01-05T03:54:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-68665754",
      "id" : 68665754,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-01-05T03:54:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/68665754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "BIP34 checks are uninteresting enough (in terms of what you get from violating them) that I wouldn't want any additional complexity for them, and so I think it's fine to retcon the rule into being a straight up height threshold. Such a test is pretty much the easiest behaviour change to implement, and to implement mostly correctly.\r\n\r\nWhen we simplified BIP30 we were unable to do this (well, unable to keep it) and had to block-pin it  because someone feeding you an early chain fork with BIP30 violations was problematic, but that doesn't apply here.\r\n\r\nThe shortcut you're talking about sounds somewhat like one of the things I'd previously proposed for post-headers-first:  Abbreviate validation on blocks on the longest chain where the block is work-dominant over any competition. Work dominant means that chain after the block under consideration has at least threshold more work than any fork you know about which doesn't include that block. We'd talked about a threshold based on X days of work (e.g. 60 days) at the highest difficulty ever seen subject to some minimum. Pieter has been charting how much work there is in the whole chain at each time relative to that time: http://bitcoin.sipa.be/powdays-50k.png\r\n\r\nSome of these things should go along with reworking wallet facing security measures. I'd rather move some of the protective logic away from the consensus code and toward the wallet. E.g. I wouldn't consider refusing a 100 block reorg in the consensus code, such efforts are inevitably attack vectors, but I think having a wallet go into a safe mode where nothing shows confirmed (or additional confirms) and no transactions can be made without a manual kick would be a pretty advisable thing to do.\r\n\r\n\r\n",
      "created_at" : "2015-01-05T06:36:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-68673200",
      "id" : 68673200,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-01-05T06:37:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/68673200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@luke-jr I wouldn't want to use that implementation anymore for future rule changes, both semantically (it unnecessarily constrains the block version number further) and implementation-wise (it needs to scan over 1000 block index entries for every block check).",
      "created_at" : "2015-01-13T02:23:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-69685419",
      "id" : 69685419,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-01-13T02:23:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/69685419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa What alternative are you thinking of?",
      "created_at" : "2015-01-13T02:36:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-69686542",
      "id" : 69686542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-01-13T02:36:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/69686542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "We're using `IsSuperMajority` for the BIP66 block version 2 to 3 switch, so the implementation here needs to be changed.",
      "created_at" : "2015-03-26T07:15:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-86366546",
      "id" : 86366546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-03-26T07:15:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/86366546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Rebased as #5966",
      "created_at" : "2015-04-03T07:19:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5562#issuecomment-89200082",
      "id" : 89200082,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5562",
      "updated_at" : "2015-04-03T07:19:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/89200082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
