[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r571946307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571946307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This assumes that `GetTime()` is monotonic, which I don't think is true. `GetTime()` is mockable so may move backwards in tests.\r\n\r\nIt looks like `GetTime()` is also deprecated.",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-08T10:46:22Z",
      "diff_hunk" : "@@ -1305,6 +1305,14 @@ bool CChainState::IsInitialBlockDownload() const\n         return false;\n     if (fImporting || fReindex)\n         return true;\n+    uint64_t ibdtimeout = gArgs.GetArg(\"-ibdtimeout\", DEFAULT_IBD_TIMEOUT);\n+    int64_t uptime = GetTime() - GetStartupTime();\n+    assert(uptime >= 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r571946307",
      "id" : 571946307,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTk0NjMwNw==",
      "original_commit_id" : "22c27cca430298bfc0b76ab50b18dc639110d75e",
      "original_line" : 1310,
      "original_position" : 6,
      "original_start_line" : 1309,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 585370500,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-11T01:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571946307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> all or most of the listening nodes are restarted into Initial Block Download mode \r\n\r\nWouldn't that mean that there hasn't been a block in 24 hours? Then, waiting another two days for the next block doesn't seem like a fallback that will be needed.",
      "created_at" : "2021-02-08T11:58:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-775094408",
      "id" : 775094408,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTA5NDQwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-08T11:58:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775094408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r572483459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572483459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nodes in IBD will not respond to GETHEADERS. Nodes in IBD do not request headers from inbound peers only outbound.\r\n\r\nIf all or most of the listening nodes are in IBD (emergency hot fix or something) then nobody will be able to get headers.\r\n\r\nTo get out of this the listening nodes need to request headers from inbound connections, either by exiting IBD or special casing that limit while in IBD.",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-09T00:43:37Z",
      "diff_hunk" : "@@ -1305,6 +1305,14 @@ bool CChainState::IsInitialBlockDownload() const\n         return false;\n     if (fImporting || fReindex)\n         return true;\n+    uint64_t ibdtimeout = gArgs.GetArg(\"-ibdtimeout\", DEFAULT_IBD_TIMEOUT);\n+    int64_t uptime = GetTime() - GetStartupTime();\n+    assert(uptime >= 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r572483459",
      "id" : 572483459,
      "in_reply_to_id" : 571946307,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjQ4MzQ1OQ==",
      "original_commit_id" : "22c27cca430298bfc0b76ab50b18dc639110d75e",
      "original_line" : 1310,
      "original_position" : 6,
      "original_start_line" : 1309,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 586054492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-11T01:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572483459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke no it doesn't, just that the listening nodes haven't seen the block yet.",
      "created_at" : "2021-02-09T00:45:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-775567992",
      "id" : 775567992,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTU2Nzk5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-09T00:45:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775567992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If the listening nodes haven't seen a block from 24h ago, something is going wrong and needs human attention to manually fixup. Having an automated fallback that hits after two days doesn't seem needed when having to manually interfere anyway.",
      "created_at" : "2021-02-09T07:08:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-775723337",
      "id" : 775723337,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTcyMzMzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-09T07:08:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775723337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke  I respectfully disagree.  The network consists of thousands of listening nodes, tens of thousands of total nodes.  Many-- probably most-- are not observed on a daily or weekly basis.  If the network ends up in a bad state it may be difficult to recover nodes even manually if it is full of other nodes which are non-functional.\r\n\r\nWhen users do \"manually\" intervene, the results are not always pretty--  I've consoled more than one user through a thousands of dollars loss because in their efforts to 'fix' a 'stuck' node that wasn't actually stuck (e.g. when they were confused at the 0.99x progress display) and managed to delete or corrupt every copy of their wallet due to trying random things and/or following bad advice online.  Any particular user isn't likely to footgun themselves, but if you make 50,000 users do so, a few probably will.\r\n\r\nI'm not particularly sure about the approach in this PR right now, but the general practice that nodes should fix themselves if reasonable and safely possible is a really good one.  The whole behaviour switching on IBD handling is a pile of gross hacks on top of a pile of gross hacks,  several of which were needed to resolve cases where the network could more or less just spontaneously fail as a result of the IBD behaviour (some of which were witnessed on testnet).\r\n\r\nIt would be good to have a stronger assurance that things will recover if they end up in that state but the tricky part is being equally confident that the various attacks that the IBD specific behaviour is intended to protect against are still protected against-- esp because no one reviewing this work may remember all of them.\r\n\r\n\r\n",
      "created_at" : "2021-02-10T06:42:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776484069",
      "id" : 776484069,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjQ4NDA2OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T06:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776484069",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I fully agree that the node should try to recover (to avoid manual intervention as much as possible) when its both reasonable and safe to do. Though in this particular case, the users that are eager enough to corrupt their datadir, won't be patient enough to wait three full days for this workaround to take effect. And similarly, the patient users won't see the benefits either because some eager users successfully poked their node on the first day of issues.",
      "created_at" : "2021-02-10T07:04:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776494393",
      "id" : 776494393,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjQ5NDM5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T07:04:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776494393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r573569162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573569162"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `ibdtimeout` and `uptime` localvars can be `const`.\r\n\r\nAs @jnewbery mentions, we probably don't want to use `GetTime()` here, see `src/util/time.h`.\r\n\r\nAlso maybe consider how this interacts with `setmocktime`\r\n```\r\n    // For now, don't change mocktime if we're in the middle of validation, as\r\n    // this could have an effect on mempool time-based eviction, as well as\r\n    // IsCurrentForFeeEstimation() and IsInitialBlockDownload().\r\n    // TODO: figure out the right way to synchronize around mocktime, and\r\n    // ensure all call sites of GetTime() are accessing this safely.\r\n```\r\n",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-10T09:25:14Z",
      "diff_hunk" : "@@ -1305,11 +1305,19 @@ bool CChainState::IsInitialBlockDownload() const\n         return false;\n     if (fImporting || fReindex)\n         return true;\n+    uint64_t ibdtimeout = gArgs.GetArg(\"-ibdtimeout\", DEFAULT_IBD_TIMEOUT);\n+    int64_t uptime = GetTime() - GetStartupTime();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r573569162",
      "id" : 573569162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2OTE2Mg==",
      "original_commit_id" : "99283bf75197199191e433ae07456f3cf239308e",
      "original_line" : 1309,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 587402387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-11T01:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573569162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r573569430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573569430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can use `constexpr` and mention that the constant refers to a time duration in seconds.",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-10T09:25:37Z",
      "diff_hunk" : "@@ -53,6 +53,7 @@ struct DisconnectedBlockTransactions;\n struct PrecomputedTransactionData;\n struct LockPoints;\n \n+static const unsigned int DEFAULT_IBD_TIMEOUT = 3600 * 48; // 48 Hours",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r573569430",
      "id" : 573569430,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2OTQzMA==",
      "original_commit_id" : "99283bf75197199191e433ae07456f3cf239308e",
      "original_line" : 56,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 587402387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-11T01:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573569430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke  It's other peoples nodes not being broken (having since recovered instead of staying broken) that prevent the user we want to help from having issues (at all, or which don't recover quickly).   If nodes recover on their own it's much harder for the network to end up in a state where large numbers of nodes are in a broken state.",
      "created_at" : "2021-02-10T09:33:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776574375",
      "id" : 776574375,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjU3NDM3NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T09:35:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776574375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  the tricky part is being equally confident that the various attacks that the IBD specific behaviour is intended to protect against are still protected against-- esp because no one reviewing this work may remember all of them\r\n\r\nYes.",
      "created_at" : "2021-02-10T10:08:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776597233",
      "id" : 776597233,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjU5NzIzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T10:08:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776597233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It might be sufficient to instead latch IBD to false across restarts.\r\n\r\nBecause it might not be clear in the thread, here is a sequence I believe the PR is intended to address:   A DOS attack runs against all reachable nodes for a while preventing them from getting blocks (e.g. with volumetric DOS as without any non-tcp transports nodes are fairly vulnerable to just being flooded out),  then nodes are restarted either by operators trying to fix them or-- worse-- by some separate issue like a crasher bug.\r\n\r\nAfter (almost) all the listening network is in IBD it will stay stuck in IBD even if the DOS attacks stops because a node in IBD will not serve blocks/headers to others, and will only obtain them from peers it connects out to ... and it's extremely likely that the node it connects to will all be in the same state and not serve it anything.  It will only escape if the stale block detection mechanism causes it to eventually find a working node-- but this will take an extremely long time because it's stale block connections are infrequent and intended to heal a partitioned node in a network of mostly okay nodes.  Not to heal a partitioned node in a network of mostly partitioned node.  (And if there are a relatively small number of functional nodes a dos attacker can focus all their resources on those).\r\n\r\n(there is an altcoin that appears to be undergoing something like this recently--  potentially caused without much of an attacker, but mostly just by an enormous number of new nodes coming online effectively dos attacking the network.  It's unclear how it got into this state, but essentially all reachable nodes (including apparently long running ones) are stuck in IBD.)\r\n\r\nI understand pstratem's PR would improve the situation particularly if it took days to get most of the listening network into this state because they'd also be falling out of it on their own before the network became saturated-- in that case disruption would be prevented entirely. But if the issue is triggered all at once, it helps less-- there is still disruption, but the disruption heals completely in two days rather than having partitioned nodes hanging around for however long it takes a significant minority to get fixed via more manual means (such as by spinning up a lot of new working nodes).\r\n\r\nI think this pattern would be more completely and crisply resolved by simply persisting the latching state across restarts.  New nodes would have problems joining in a network under attack, but that is already the case for a bunch of reasons... and a new node you can assume has an operator present to do something (so, for example, a hidden option to force ibd=false might be a useful resource).  I think persisting the latch also actually reflects the *intent* of the latch, it just didn't do that when the latch was introduce because persisting state takes extra work.\r\n",
      "created_at" : "2021-02-10T10:37:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776614912",
      "id" : 776614912,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjYxNDkxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T10:38:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776614912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If this was a boolean option (default to false), it would be easier to review than this time-based threshold. Obviously, it would also lose the node-fixes-itself-after-three-days feature. Though, I am still sceptical of it's use. It assumes that *all* of your connections (inbound, as well as block-feeler, outbound block-relay, ...) are out of IBD for three days without a single one of them setting the flag manually.\r\n\r\n(Edit: I wrote this before the previous comment, so it is not a reply to that)",
      "created_at" : "2021-02-10T10:46:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776619931",
      "id" : 776619931,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjYxOTkzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T10:54:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776619931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke In IBD we do not request headers from inbound peers.  Literally only from a single outbound peer with a timeout.\r\n\r\nA setting to disable IBD for your own node might fix your node if your node is listening and receiving inbound connections from nodes which are sync'd with miners.  Relying on that would be extremely fragile.\r\n\r\nEven if you were able to fix your own node, you can't then heal the rest of the network without them connecting to you as the single initial sync peer, the odds of which are extremely low.\r\n\r\nThe timeout prevents the network from being in this state for more than 48 hours with a bunch of nodes stuck in IBD.\r\n\r\nI'm assuming that the vast majority of listening nodes are not actively maintained and have no wallet, but are rather used as a kind of gateway, so being down for 48 hours is a nuisance to the rest of the network, but is probably not directly going to cause them to take action.",
      "created_at" : "2021-02-10T18:51:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776932029",
      "id" : 776932029,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjkzMjAyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T18:51:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776932029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@gmaxwell Yes just writing the latch to disk is probably the best solution.",
      "created_at" : "2021-02-10T19:23:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776956299",
      "id" : 776956299,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3Njk1NjI5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T19:23:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776956299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, if we can avoid using time that would be a real win. Easier to test too.",
      "created_at" : "2021-02-10T19:26:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776957620",
      "id" : 776957620,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3Njk1NzYyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T19:26:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776957620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r574085139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574085139"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we now use bracket syntax for the conditional (after a famous Apple bug iirc)\r\n```diff\r\n-    if (!f) LogPrintf(\"Failed to write %s \\n\", latch_filename.c_str());\r\n-    else fclose(f);\r\n+    if (f) {\r\n+        fclose(f);\r\n+    } else {\r\n+        LogPrintf(\"Failed to write %s\\n\", latch_filename.c_str());\r\n+    }\r\n```\r\n",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-10T21:19:53Z",
      "diff_hunk" : "@@ -1312,6 +1323,9 @@ bool CChainState::IsInitialBlockDownload() const\n     if (m_chain.Tip()->GetBlockTime() < (GetTime() - nMaxTipAge))\n         return true;\n     LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n+    f = fsbridge::fopen(latch_filename, \"wb\");\n+    if (!f) LogPrintf(\"Failed to write %s \\n\", latch_filename.string().c_str());\n+    else fclose(f);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r574085139",
      "id" : 574085139,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDA4NTEzOQ==",
      "original_commit_id" : "cf742ecc4447f17751e13f0e61e23fd7859c5f57",
      "original_line" : 1328,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 588064190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-11T01:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574085139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r574092299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574092299"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Coding style guidelines doesn't agree, but I will expand it to new lines to make it easier to read.\r\n\r\n(Indeed ironically I argued for using braces everywhere, but we don't).\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-10T21:32:44Z",
      "diff_hunk" : "@@ -1312,6 +1323,9 @@ bool CChainState::IsInitialBlockDownload() const\n     if (m_chain.Tip()->GetBlockTime() < (GetTime() - nMaxTipAge))\n         return true;\n     LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n+    f = fsbridge::fopen(latch_filename, \"wb\");\n+    if (!f) LogPrintf(\"Failed to write %s \\n\", latch_filename.string().c_str());\n+    else fclose(f);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r574092299",
      "id" : 574092299,
      "in_reply_to_id" : 574085139,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDA5MjI5OQ==",
      "original_commit_id" : "cf742ecc4447f17751e13f0e61e23fd7859c5f57",
      "original_line" : 1328,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 588073442,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-11T01:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574092299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r574098661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574098661"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The developer notes state:\r\n```\r\n  - If an `if` only has a single-statement `then`-clause, it can appear\r\n    on the same line as the `if`, without braces. In every other case,\r\n    braces are required, and the `then` and `else` clauses must appear\r\n    correctly indented on a new line.\r\n```\r\n",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-10T21:43:51Z",
      "diff_hunk" : "@@ -1312,6 +1323,9 @@ bool CChainState::IsInitialBlockDownload() const\n     if (m_chain.Tip()->GetBlockTime() < (GetTime() - nMaxTipAge))\n         return true;\n     LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n+    f = fsbridge::fopen(latch_filename, \"wb\");\n+    if (!f) LogPrintf(\"Failed to write %s \\n\", latch_filename.string().c_str());\n+    else fclose(f);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r574098661",
      "id" : 574098661,
      "in_reply_to_id" : 574085139,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDA5ODY2MQ==",
      "original_commit_id" : "cf742ecc4447f17751e13f0e61e23fd7859c5f57",
      "original_line" : 1328,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 588081125,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-11T01:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574098661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r574099441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574099441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So if I read it correctly, without the `else` it would be fine, but with the `else` then braces are required (at any rate, that is what I've been doing).",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-10T21:45:19Z",
      "diff_hunk" : "@@ -1312,6 +1323,9 @@ bool CChainState::IsInitialBlockDownload() const\n     if (m_chain.Tip()->GetBlockTime() < (GetTime() - nMaxTipAge))\n         return true;\n     LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n+    f = fsbridge::fopen(latch_filename, \"wb\");\n+    if (!f) LogPrintf(\"Failed to write %s \\n\", latch_filename.string().c_str());\n+    else fclose(f);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r574099441",
      "id" : 574099441,
      "in_reply_to_id" : 574085139,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDA5OTQ0MQ==",
      "original_commit_id" : "cf742ecc4447f17751e13f0e61e23fd7859c5f57",
      "original_line" : 1328,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 588082083,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-11T01:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574099441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The CI failures are all random zmq issues.",
      "created_at" : "2021-02-11T03:16:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-777179339",
      "id" : 777179339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzE3OTMzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T03:16:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777179339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-02-11T18:27:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-777697260",
      "id" : 777697260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzY5NzI2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T18:27:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777697260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/60179867?v=4",
         "events_url" : "https://api.github.com/users/decryp2kanon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/decryp2kanon/followers",
         "following_url" : "https://api.github.com/users/decryp2kanon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/decryp2kanon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/decryp2kanon",
         "id" : 60179867,
         "login" : "decryp2kanon",
         "node_id" : "MDQ6VXNlcjYwMTc5ODY3",
         "organizations_url" : "https://api.github.com/users/decryp2kanon/orgs",
         "received_events_url" : "https://api.github.com/users/decryp2kanon/received_events",
         "repos_url" : "https://api.github.com/users/decryp2kanon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/decryp2kanon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/decryp2kanon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/decryp2kanon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r575687579"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575687579"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If this moves forward, noting that a file description should be added to `doc/files.md` (alternatively, perhaps persist the latch in `settings.json`, which is also chain-specific).",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-13T16:53:26Z",
      "diff_hunk" : "@@ -1294,15 +1295,23 @@ void CChainState::InitCoinsCache(size_t cache_size_bytes)\n // `const` so that `CValidationInterface` clients (which are given a `const CChainState*`)\n // can call it.\n //\n+// The file .ibd_complete is used to latch the datadir to IBD false across restarts",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r575687579",
      "id" : 575687579,
      "line" : 1298,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTY4NzU3OQ==",
      "original_commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "original_line" : 1298,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 12,
      "pull_request_review_id" : 589979886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T17:01:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575687579",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r575704729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575704729"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I did this as a separate file so that users can easily add the file to override, with GetDataDir() it should be chain specific, no?",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-13T19:35:56Z",
      "diff_hunk" : "@@ -1294,15 +1295,23 @@ void CChainState::InitCoinsCache(size_t cache_size_bytes)\n // `const` so that `CValidationInterface` clients (which are given a `const CChainState*`)\n // can call it.\n //\n+// The file .ibd_complete is used to latch the datadir to IBD false across restarts",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r575704729",
      "id" : 575704729,
      "in_reply_to_id" : 575687579,
      "line" : 1298,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTcwNDcyOQ==",
      "original_commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "original_line" : 1298,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 12,
      "pull_request_review_id" : 589990517,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T19:35:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575704729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r575706285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575706285"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, I think they should both be.",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-13T19:50:35Z",
      "diff_hunk" : "@@ -1294,15 +1295,23 @@ void CChainState::InitCoinsCache(size_t cache_size_bytes)\n // `const` so that `CValidationInterface` clients (which are given a `const CChainState*`)\n // can call it.\n //\n+// The file .ibd_complete is used to latch the datadir to IBD false across restarts",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r575706285",
      "id" : 575706285,
      "in_reply_to_id" : 575687579,
      "line" : 1298,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTcwNjI4NQ==",
      "original_commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "original_line" : 1298,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 12,
      "pull_request_review_id" : 589991512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T19:50:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575706285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Is there anything I need to do here?",
      "created_at" : "2021-02-22T05:10:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-783085787",
      "id" : 783085787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzA4NTc4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T05:10:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783085787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Is there anything I need to do here?\r\n\r\nConvince other contributors that this is a good idea. Currently, if a node is switched off and then switched back on some time later, it'll start up in IBD until it catches up to the tip. This seems like good behaviour - we don't want to download transactions, relay our address, respond to getheaders, etc until we've caught back up. If you want other contributors to ACK this PR, you'll need to convince them that changing that behaviour is an improvement, and does not introduce any regressions/vulnerabilities/etc.",
      "created_at" : "2021-02-22T09:37:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-783237486",
      "id" : 783237486,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzIzNzQ4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T09:37:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783237486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r580105756"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/580105756"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will set ibd to false, when `-reindex`? If yes, that seems wrong",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-22T09:40:15Z",
      "diff_hunk" : "@@ -1294,15 +1295,23 @@ void CChainState::InitCoinsCache(size_t cache_size_bytes)\n // `const` so that `CValidationInterface` clients (which are given a `const CChainState*`)\n // can call it.\n //\n+// The file .ibd_complete is used to latch the datadir to IBD false across restarts\n+//\n bool CChainState::IsInitialBlockDownload() const\n {\n+    static const fs::path latch_filename = GetDataDir() / \".ibd_complete\";\n     // Optimization: pre-test latch before taking the lock.\n     if (m_cached_finished_ibd.load(std::memory_order_relaxed))\n         return false;\n \n     LOCK(cs_main);\n     if (m_cached_finished_ibd.load(std::memory_order_relaxed))\n         return false;\n+    if (fs::exists(latch_filename)) {\n+        LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n+        m_cached_finished_ibd.store(true, std::memory_order_relaxed);\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r580105756",
      "id" : 580105756,
      "line" : 1313,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDEwNTc1Ng==",
      "original_commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "original_line" : 1313,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 27,
      "pull_request_review_id" : 595162546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-22T09:40:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/580105756",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "TL;DR: I think we should just drop the \"don't respond to GETHEADERS while in IBD\" behavior, rather than keeping the IsInitialBlockDownload() latch across restarts. Possibly we can also improve the find-another-peer-to-sync-headers-from logic (and, if that's the real problem, this PR doesn't currently address it).\r\n\r\nThese are the things that IsInitialBlockDownload() affects (there are more, but these are probably the most important ones).\r\n\r\n1) We don't respond to GETHEADERS while in IBD.\r\n2) We don't announce our local address while in IBD.\r\n3) The `getblocktemplate` RPC doesn't work while in IBD.\r\n4) We don't request transactions in IBD.\r\n5) Various compact block related things are disabled in IBD.\r\n\r\nThere is also a related behavior that is **not** controlled by IsInitialBlockDownload(), but by `pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60` instead:\r\n\r\n6) Only request headers from one peer at a time (however, if it times out, another peer will be selected).\r\n\r\nI believe it is mostly (1) and (6) we're concerned about here?\r\n\r\nI don't actually know why (1) exists in the first place. Perhaps it's trying to minimize time to be synced with the network first before providing services to others? I think that only has a minimal effect, especially when combined with (2). It seems to me that just removing (1) would address most of the concern here.\r\n\r\nIt seems possible to improve on (6) as well, but it's fundamentally a tradeoff between bandwidth and (high probability of) fast header syncing. The headers sync timeout is ~15 minutes though, which can be annoying, but is probably short enough that (6) doesn't actually matter for the scenario under consideration here.\r\n\r\nA way to improve (6) (especially useful when combined with removing (1)) would be to treat a \"less than 2000 headers received at once\" while the last one doesn't get out us out of IBD as \"done syncing with this peer, pick another one\".\r\n\r\nThese avoid the need to permanently latch to IBD, which seems like a very heavy hammer. Especially the transaction (4) and compact block related behaviours (5) we probably want to keep for nodes that were once out of IBD, but have been offline for a substantial period of time.\r\n\r\n(3) does look fairly scary if nodes can actually get stuck in IBD - but it's also a sign of a deeper problem. I'm not sure if that warrants addressing beyond just trying to make sure we don't get stuck in IBD.",
      "created_at" : "2021-02-22T21:10:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-783676898",
      "id" : 783676898,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzY3Njg5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T21:52:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783676898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r581543035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/581543035"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Users can easily override settings.json as well - they're just interpreted as command-line options.\r\n\r\nSo something like `--ibd_complete=0/1` would work",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-24T01:45:59Z",
      "diff_hunk" : "@@ -1294,15 +1295,23 @@ void CChainState::InitCoinsCache(size_t cache_size_bytes)\n // `const` so that `CValidationInterface` clients (which are given a `const CChainState*`)\n // can call it.\n //\n+// The file .ibd_complete is used to latch the datadir to IBD false across restarts",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r581543035",
      "id" : 581543035,
      "in_reply_to_id" : 575687579,
      "line" : 1298,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTU0MzAzNQ==",
      "original_commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "original_line" : 1298,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 12,
      "pull_request_review_id" : 596989001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-24T01:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/581543035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Because if you are on a fork below a checkpoint or min-work and you respond with a header from the fork to an in-sync node you will be insta-banned and disconnected.\r\n\r\nThat's a good point. But if that's the reason, isn't an explicit \"don't respond to header requests until past the last checkpoint\" better?\r\n\r\n> Which will either be in a few tens of seconds\r\n\r\nSure, if it's just a node that rebooted. But for nodes that have been down for a few days, weeks, maybe more - syncing up may take hours. I think it'd be undesirable if those would start trying to participate in tx relay immediately?",
      "created_at" : "2021-02-27T00:39:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-786967242",
      "id" : 786967242,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4Njk2NzI0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-27T00:39:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/786967242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@pstratem So I suspect that what happened in $ALTCOIN is the headers fetching logic is approximately doing this:\r\n- until the tip header is less than a day old, we pick a single peer to fetch headers from. If we have at least one outbound peer, only outbounds are considered.\r\n- headers fetching times out after 15 minutes, and after that a new peer is picked (but, in a normal situation, again an outbound one, and it'll never actually get to asking an inbound peer)\r\n\r\nI don't believe the current PR actually addresses this, because none of the logic above is dependent on IsInitialBlockDownload. If actually all reachable nodes on the network are in \"headers 24 hours behind\" state, then making them IsIBD()==false would make them respond to headers, but never enough to get close enough to $NOW to get the network unstuck.\r\n\r\nHere are a couple alternative ideas (not all necessary, but probably most powerful if all 3 are done):\r\n* When headers fetch reaches timeout, instead of disconnecting a peer, it is marked \"failed headers sync\", and another peer is tried. Perhaps such \"failed headers sync\" peers can be preferred for eviction/replacement.\r\n* If we can't respond to a GETHEADERS request (for whatever reason), just echo the reported tip back the requester in a HEADERS. That has no they-might-ban-us risk, because clearly that tip is valid to themselves, and can be used as a \"done sending you headers\" signed (see next point).\r\n* If a HEADERS message arrives from the headers sync peer with less than MAX_HEADERS entries, which doesn't get us within 24h of $NOW, treat that as a \"failed headers sync\" as well. That means that headers sync peer cycling can go almost instantly, rather than needing 15-minute timeouts.",
      "created_at" : "2021-02-27T02:00:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-786984053",
      "id" : 786984053,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4Njk4NDA1Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-27T02:00:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/786984053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r584207780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584207780"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yes, it is wrong",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-28T00:04:38Z",
      "diff_hunk" : "@@ -1294,15 +1295,23 @@ void CChainState::InitCoinsCache(size_t cache_size_bytes)\n // `const` so that `CValidationInterface` clients (which are given a `const CChainState*`)\n // can call it.\n //\n+// The file .ibd_complete is used to latch the datadir to IBD false across restarts\n+//\n bool CChainState::IsInitialBlockDownload() const\n {\n+    static const fs::path latch_filename = GetDataDir() / \".ibd_complete\";\n     // Optimization: pre-test latch before taking the lock.\n     if (m_cached_finished_ibd.load(std::memory_order_relaxed))\n         return false;\n \n     LOCK(cs_main);\n     if (m_cached_finished_ibd.load(std::memory_order_relaxed))\n         return false;\n+    if (fs::exists(latch_filename)) {\n+        LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n+        m_cached_finished_ibd.store(true, std::memory_order_relaxed);\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r584207780",
      "id" : 584207780,
      "in_reply_to_id" : 580105756,
      "line" : 1313,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDIwNzc4MA==",
      "original_commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "original_line" : 1313,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 27,
      "pull_request_review_id" : 600204813,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-28T00:04:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584207780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r584212675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584212675"
         }
      },
      "author_association" : "NONE",
      "body" : "bc1que90l5dy4yzn79x8xmem8t7dgn0c2zcqvxnr6x",
      "commit_id" : "a3e713ace8b6dd97b6048b267e51e74f5a386f5f",
      "created_at" : "2021-02-28T01:01:12Z",
      "diff_hunk" : "@@ -1305,6 +1305,14 @@ bool CChainState::IsInitialBlockDownload() const\n         return false;\n     if (fImporting || fReindex)\n         return true;\n+    uint64_t ibdtimeout = gArgs.GetArg(\"-ibdtimeout\", DEFAULT_IBD_TIMEOUT);\n+    int64_t uptime = GetTime() - GetStartupTime();\n+    assert(uptime >= 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r584212675",
      "id" : 584212675,
      "in_reply_to_id" : 571946307,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDIxMjY3NQ==",
      "original_commit_id" : "22c27cca430298bfc0b76ab50b18dc639110d75e",
      "original_line" : 1310,
      "original_position" : 6,
      "original_start_line" : 1309,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 600207246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-28T01:01:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584212675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/79707411?v=4",
         "events_url" : "https://api.github.com/users/schuie2528/events{/privacy}",
         "followers_url" : "https://api.github.com/users/schuie2528/followers",
         "following_url" : "https://api.github.com/users/schuie2528/following{/other_user}",
         "gists_url" : "https://api.github.com/users/schuie2528/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/schuie2528",
         "id" : 79707411,
         "login" : "schuie2528",
         "node_id" : "MDQ6VXNlcjc5NzA3NDEx",
         "organizations_url" : "https://api.github.com/users/schuie2528/orgs",
         "received_events_url" : "https://api.github.com/users/schuie2528/received_events",
         "repos_url" : "https://api.github.com/users/schuie2528/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/schuie2528/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/schuie2528/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/schuie2528"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipa Originally the logic was added to not respond to GETHEADERS while in IBD because we relaxed the checkpoint logic, so that we could accept a non-checkpointed chain during initial sync.  If a node was in IBD and fed a bogus initial headers chain, then a peer that is on the checkpointed chain would ban us if we gave them a checkpoint-violating header.\r\n\r\nSince then, our logic has changed a lot, both around banning and with the addition of minimum-chain-work.  An easy improvement would be to respond to getheaders messages as long as our tip is past the minimum chain work that we're configured with.\r\n\r\n@pstratem My understanding of block relay is that the scenario that I think you have in mind should not really exist, but perhaps I'm not understanding the scenario.  Let's say the whole network is in IBD for some reason, because no blocks have been found in several days and then everyone restarts their software.  At this point, initial headers sync with every peer is timing out every 20 minutes or whatever causing some peer churn (this all sounds bad, but not yet disastrous).\r\n\r\n(1) Then a miner finds a block and submits it to their node. That node is not a listening node, but (2) with the new block it will leave IBD.  It will also (3) announce that block (via INV) to all its peers, which will in turn immediately (4) send a getheaders to the node, which it will (5) respond to because its out of IBD.\r\n\r\nThat will (6) trigger block relay to all those peers via a getdata, which in turn will cause those nodes to (7) leave IBD and then (8) announce the block to their peers.  Things should progress fine from there, in the same way, I think -- what do you think is breaking down exactly?\r\n\r\nI guess (1) could break down because miners have to manually cause their own node to leave IBD in order for `getblocktemplate` to work, via the `-maxtipage` option.  But if you assume miners will quickly figure that out to not waste their hashpower, I think everything should work after that.",
      "created_at" : "2021-03-04T17:45:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-790802591",
      "id" : 790802591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDgwMjU5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T17:45:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790802591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> That will (6) trigger block relay to all those peers via a getdata, which in turn will cause those nodes to (7) leave IBD and then (8) announce the block to their peers. Things should progress fine from there, in the same way, I think -- what do you think is breaking down exactly?\r\n\r\nAha, on further investigation, I think (6) is where things break down: when a node is in IBD because its current tip is too old, if we learn of a new block header from an inbound peer, we will not fetch the block when we get the header via direct-fetch (because `CanDirectFetch` will return false due to our old tip), and we won't fetch the block through parallel block fetch (via `FindNextBlocksToDownload`) if we're in IBD and we have any outbound peers.  I was able to replicate this behavior in a simple regtest setting.\r\n\r\nMy recollection is that we don't want to do full-on IBD from inbound peers because users running bitcoind at home might not want to be used for some outbound peer's initial sync.  Assuming we think that is still a reasonable concern, a simple fix might be to try fetching blocks via `FindNextBlocksToDownload` from inbound peers if we have no blocks in flight, as presumably that means our outbound peers have nothing for us, so we might as well treat that scenario the same as if we have no outbounds at all.\r\n\r\n(To be clear, I don't believe that the headers-sync behaviors with inbound peers are really a problem, because if an inbound peer is the only one to be finding new blocks, we will get their headers via our inv-processing behavior.  I think this is just a concern around block fetching.)",
      "created_at" : "2021-03-04T18:33:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-790834342",
      "id" : 790834342,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDgzNDM0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T18:33:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790834342",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Noting that I was operating a signet for a while which crashed, and by the time I rebooted it (life happens) it was a few months later. Now after restarting, I think the IBD latch is keeping my seed/mining node in IBD since it's in the past, even though I'm producing new blocks. This also prevents this node from relaying the new blocks to peers.\r\n\r\nThis patch might fix this (pathological) case.\r\n\r\nh/t @ajtowns for pointing this out.",
      "created_at" : "2021-05-24T04:51:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-846730993",
      "id" : 846730993,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjczMDk5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-24T04:51:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846730993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Can this be closed now that #24171 was opened?",
      "created_at" : "2022-01-27T06:59:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-1022904131",
      "id" : 1022904131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "IC_kwDOABII5848-EdD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022904131/reactions"
      },
      "updated_at" : "2022-01-27T06:59:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022904131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Now after restarting, I think the IBD latch is keeping my seed/mining node in IBD since it's in the past, even though I'm producing new blocks.\r\n\r\nStaying in IBD while producing a block with a recent enough timestamp shouldn't be possible. It may only happen that `getblocktemplate` refuses to give you a reply due to IBD, but since you produced a block this is probably not something you ran into. (If you were, you could use `-maxtipage`)",
      "created_at" : "2022-01-27T07:56:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-1022940530",
      "id" : 1022940530,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "IC_kwDOABII5848-NVy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022940530/reactions"
      },
      "updated_at" : "2022-01-27T07:56:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022940530",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Going to close this for now, since there hasn't been any activity by the author for about a year after the author acknowledged that the current patch has a bug (https://github.com/bitcoin/bitcoin/pull/21106#discussion_r584207780).\r\n\r\nDiscussion can continue and this can be reopened any time.",
      "created_at" : "2022-01-27T13:05:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-1023185409",
      "id" : 1023185409,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "IC_kwDOABII5848_JIB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023185409/reactions"
      },
      "updated_at" : "2022-01-27T13:05:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023185409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Staying in IBD while producing a block with a recent enough timestamp shouldn't be possible.\r\n\r\nOnce started, the signet miner defaults to calculating timestamps as \"previous block time + 10 minutes\" with optional randomisation, so if the node was down for weeks or more it could take a while to catch up with realtime and hence leave the miner's node in IBD.\r\n",
      "created_at" : "2022-01-27T13:11:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-1023190674",
      "id" : 1023190674,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "IC_kwDOABII5848_KaS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023190674/reactions"
      },
      "updated_at" : "2022-01-27T13:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023190674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ok, I see. So this pull could indeed make sense for signet. Or, as an alternative the signet miner could modify the mine script to mine a block with a more recent timestamp or somehow mine the \"missing\" blocks faster if it is important to have them.\r\n\r\nFor mainnet, my understanding is that #24171 will be sufficient to address the issue, as explained in https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-790802591 and the following comment.",
      "created_at" : "2022-01-27T13:59:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-1023239020",
      "id" : 1023239020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "IC_kwDOABII5848_WNs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023239020/reactions"
      },
      "updated_at" : "2022-01-27T13:59:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023239020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Ok, I see. So this pull could indeed make sense for signet. Or, as an alternative the signet miner could modify the mine script to mine a block with a more recent timestamp or somehow mine the \"missing\" blocks faster if it is important to have them.\r\n\r\nIt's just a default: you can run the miner with `--set-block-time=-1 --max-blocks=1` to mine a single block at the current time, then restart with `--ongoing` which will continue from there. (Not sure if that had been implemented when Jeremy was having problems) So I don't think it's too important to optimise for that scenario.",
      "created_at" : "2022-01-27T14:06:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-1023246421",
      "id" : 1023246421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "IC_kwDOABII5848_YBV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023246421/reactions"
      },
      "updated_at" : "2022-01-27T14:06:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023246421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
