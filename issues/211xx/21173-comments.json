[
   {
      "author_association" : "MEMBER",
      "body" : "One nice property of the current version in `master` is that it doesn't use pointer arithmetic.\r\n\r\nFrom the [C++ Core Guidelines](https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#es42-keep-use-of-pointers-simple-and-straightforward):\r\n\r\n> Pointer arithmetic is fragile and easy to get wrong, the source of many, many bad bugs and security violations.",
      "created_at" : "2021-02-15T10:52:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779138472",
      "id" : 779138472,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTEzODQ3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T10:52:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779138472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The compiler should be able to produce the same binary with the pointer arithmetic replaced by `std::string::operator[](unsinged)`, no?",
      "created_at" : "2021-02-15T11:08:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779148414",
      "id" : 779148414,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTE0ODQxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T11:08:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779148414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, I didn't know there was no pointer arithmetic in `master`! I've played with a few variants:\r\n\r\n### Variant 1\r\n```cpp\r\n// 63,621,136.00 ns/op\r\nauto it = rv.begin();\r\nfor (uint8_t v: s) {\r\n    *it++ = hexmap[v >> 4];\r\n    *it++ = hexmap[v & 15];\r\n}\r\nassert(it == rv.end());\r\n```\r\n\r\nThis has basically has the same speed for me. `it` is basically a pointer in disguise, so I'm not sure anything is gained here. Having a simple `assert` after the loop is nice though.\r\n\r\n### Variant 2\r\n\r\nOr this, but it's a bit slower and not better in my opinion:\r\n\r\n```cpp\r\n// 65,479,162.00 ns/op\r\nsize_t i = 0;\r\nfor (uint8_t v: s) {\r\n    rv[i++] = hexmap[v >> 4];\r\n    rv[i++] = hexmap[v & 15];\r\n}\r\nassert(i == rv.size());\r\n```\r\n\r\n### Variant 3\r\nOr another variant:\r\n\r\n```cpp\r\n// 65,187,171.00 ns/op\r\nfor (size_t i = 0; i < rv.size(); i += 2) {\r\n    auto v = s[i / 2];\r\n    rv[i] = hexmap[v >> 4];\r\n    rv[i + 1] = hexmap[v & 15];\r\n};\r\n```\r\n",
      "created_at" : "2021-02-15T11:49:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779170806",
      "id" : 779170806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTE3MDgwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T11:49:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779170806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21173#discussion_r576354897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21173"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576354897"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is it allowed to write to a `std::string`'s backing memory? I vaguely remember it was not, but maybe that was pre C++11.",
      "commit_id" : "987192d5fc2e1b5f390c909e9798ed13362afe47",
      "created_at" : "2021-02-15T17:58:51Z",
      "diff_hunk" : "@@ -579,13 +579,13 @@ std::string Capitalize(std::string str)\n \n std::string HexStr(const Span<const uint8_t> s)\n {\n-    std::string rv;\n+    std::string rv(s.size() * 2, '\\0');\n     static constexpr char hexmap[16] = { '0', '1', '2', '3', '4', '5', '6', '7',\n                                          '8', '9', 'a', 'b', 'c', 'd', 'e', 'f' };\n-    rv.reserve(s.size() * 2);\n+    auto* out = rv.data();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#discussion_r576354897",
      "id" : 576354897,
      "line" : 585,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjM1NDg5Nw==",
      "original_commit_id" : "987192d5fc2e1b5f390c909e9798ed13362afe47",
      "original_line" : 585,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/util/strencodings.cpp",
      "position" : 9,
      "pull_request_review_id" : 590677536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21173",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T17:58:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576354897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm surprised this is so much faster. I mean, theoretically, `reserve` should effectively do this right?\r\n\r\nEdit: If I have to chose I think I like Variant 1 above most. Yes, an iterator is basically pointer arithmetic, but it looks cleaner than the pointer to `data()`, and \"proves\" it is allowed behavior.",
      "created_at" : "2021-02-15T17:59:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779376904",
      "id" : 779376904,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTM3NjkwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T18:08:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779376904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21173#discussion_r576392149"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21173"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576392149"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Before C++11 it was not guaranteed by the standard that std::string's memory is contiguous, but as far as I know all implementations did that anyways. It is certainly allowed since C++11",
      "commit_id" : "987192d5fc2e1b5f390c909e9798ed13362afe47",
      "created_at" : "2021-02-15T19:39:11Z",
      "diff_hunk" : "@@ -579,13 +579,13 @@ std::string Capitalize(std::string str)\n \n std::string HexStr(const Span<const uint8_t> s)\n {\n-    std::string rv;\n+    std::string rv(s.size() * 2, '\\0');\n     static constexpr char hexmap[16] = { '0', '1', '2', '3', '4', '5', '6', '7',\n                                          '8', '9', 'a', 'b', 'c', 'd', 'e', 'f' };\n-    rv.reserve(s.size() * 2);\n+    auto* out = rv.data();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#discussion_r576392149",
      "id" : 576392149,
      "in_reply_to_id" : 576354897,
      "line" : 585,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjM5MjE0OQ==",
      "original_commit_id" : "987192d5fc2e1b5f390c909e9798ed13362afe47",
      "original_line" : 585,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/util/strencodings.cpp",
      "position" : 9,
      "pull_request_review_id" : 590719286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21173",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-15T19:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576392149",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`push_back` is actually really slow, even when reserve already prepared the capacity. For each call it needs to check capacity, increase the size, set the data, and maybe also a check if it is small-string optimization. With an pointer / iterator this is much cheaper. \r\n\r\nSee the generated assembler code here: https://godbolt.org/z/zv1aP6 For `HexStr_variant1` the compiler can generate a very tight loop, only a single branch, and it looks to me like clang++ even unrolls it. The push_back variant produces a lot more code",
      "created_at" : "2021-02-15T19:58:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779423323",
      "id" : 779423323,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTQyMzMyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T19:58:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779423323",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> push_back is actually really slow, even when reserve already prepared the capacity. \r\n\r\nThanks. Yes I believe you, it's just counter-intuitive to me. So much for zero-cost abstraction. Oh wait, that was rust.",
      "created_at" : "2021-02-15T20:55:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779443764",
      "id" : 779443764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTQ0Mzc2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T20:55:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779443764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> One nice property of the current version in `master` is that it doesn't use pointer arithmetic.\r\n\r\nGood point, I didn't consider that in my review.\r\n\r\n> I've played with a few variants: ...\r\n\r\nI'd prefer Variant 1.\r\n\r\n\r\n",
      "created_at" : "2021-02-15T22:56:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779483157",
      "id" : 779483157,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTQ4MzE1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T22:56:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779483157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and changed the code to variant 1 (iterator & assert)",
      "created_at" : "2021-02-16T07:22:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779641593",
      "id" : 779641593,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTY0MTU5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T07:22:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779641593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for working on all these performance improvements martinus!\r\n\r\nmaster:\r\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|       69,630,868.00 |               14.36 |    0.6% |  575,779,102.00 |  138,122,873.00 |  4.169 | 107,462,304.00 |    0.5% |      0.81 | `BlockToJsonVerbose`\r\n\r\nthis PR (variant 1):\r\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|       66,411,979.00 |               15.06 |    0.2% |  509,925,986.00 |  126,353,971.00 |  4.036 |  96,559,744.00 |    0.5% |      0.76 | `BlockToJsonVerbose`\r\n\r\n\r\nWhich is a 4.6% performance improvement (when looking at `ns/op`) for me - however the benchmark warns me that these results might be unstable (probably because I'm not plugged into power). \r\n\r\nEDIT: As @martinus pointed out below, there is a 11,4% improvement when looking at `ins/op`.",
      "created_at" : "2021-02-16T09:17:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779698088",
      "id" : 779698088,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTY5ODA4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T10:01:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779698088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@0xB10C if runtime is not so stable than the number of instructions per operation might be a better way to see the performance change. 575,779,102 -> 509,925,986 is relatively similar to what @theStack wrote for the pointer version: 580,539,338 -> 505,937,562. So it's a bit slower but still quite a bit better",
      "created_at" : "2021-02-16T09:52:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-779719333",
      "id" : 779719333,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTcxOTMzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T09:52:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779719333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Couple of things in mind. \r\nSince there's no documentation in the code I'll just say what it does: \"This function returns a string containing the hexadecimal representation of every byte passed to it; The string is a continuous array that is twice the size of the input.\"\r\nOk, not the best doc I've wrote but it does the job. \r\n1) Has anyone measured performance of `std::foreach(s.begin(), s.end(), string_concat_lambda);`? \r\n2) The function isn't const correct (for loop makes non const copies for some reason). The copy is unnecessary (of the Span). \r\nTo further digress: can't the function be noexcept (do you expect it to throw? I know std::string can throw, that has little to do with the function you define. )\r\nDo we really need to initialize the std::string with s.size() * 2 0s? \r\n\r\nOtherwise it's pretty clean. I'm not a fan of `*it++` it does the job but it, in my opinion, adds some needless complexity. \r\nI rather see the increment at the end, or after each assignment. Might just be me. (Often is, tbh) ",
      "created_at" : "2021-02-17T02:33:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-780255049",
      "id" : 780255049,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDI1NTA0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-17T02:33:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780255049",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7462994?v=4",
         "events_url" : "https://api.github.com/users/ViralTaco/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ViralTaco/followers",
         "following_url" : "https://api.github.com/users/ViralTaco/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ViralTaco/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ViralTaco",
         "id" : 7462994,
         "login" : "ViralTaco",
         "node_id" : "MDQ6VXNlcjc0NjI5OTQ=",
         "organizations_url" : "https://api.github.com/users/ViralTaco/orgs",
         "received_events_url" : "https://api.github.com/users/ViralTaco/received_events",
         "repos_url" : "https://api.github.com/users/ViralTaco/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ViralTaco/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ViralTaco/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ViralTaco"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Has anyone measured performance of std::foreach(s.begin(), s.end(), string_concat_lambda);?\r\n\r\nI've benchmarked `std::for_each` with variant 1:\r\n```cpp\r\nauto it = rv.begin();\r\nstd::for_each(s.begin(), s.end(), [&](uint8_t v) {\r\n    *it++ = hexmap[v >> 4];\r\n    *it++ = hexmap[v & 15];\r\n});\r\nassert(it == rv.end());\r\n```\r\nUnsurprisingly it's exactly the same performance as the `for (uint8_t v : s)` version. Most likely it produces the same assembler code (the difference for ins/op is 0.0005%...)\r\n\r\n> The function isn't const correct (for loop makes non const copies for some reason).\r\n\r\nTwo reasons:\r\n1. Its simple bytes, so copies are cheap.\r\n2. The type needs to be unsigned so `v>>4` does the right thing, so I can't just use `for (auto const& c : s)`, because then `c` would be of type `char`. Using `uint8_t` converts char to unsigned (which generates no code, since its just a byte).\r\n\r\n> I'm not a fan of `*it++` it does the job but it\r\n\r\nMaybe I'm old school, but copy loops like like `while (*out++ = *in++);` still look natural to me :smile: \r\n\r\nEDIT: I forgot to mention, it can't be `noexcept` because std::string allocation is not noexcept (it can  throw `std::bad_alloc`). I'm no fan of `noexcept` because it is very difficult to really get it right.\r\n\r\nAlso, the std::string constructor always initializes its element. There is no constructor that just gets a size. You could do \r\n\r\n```cpp\r\nstd::string rv;\r\nrv.resize(s.size() * 2);\r\n```\r\n\r\nBut that seems to be a tad slower. It does basically the same (`resize()` zero initializes), but requires a bit more code.\r\n",
      "created_at" : "2021-02-17T06:16:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-780329853",
      "id" : 780329853,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDMyOTg1Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-17T07:16:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780329853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "First off: I can't help myself reviewing code. Everything I pointed out was 100% nitpicking. The code is fine.\r\n\r\n> 1. Its simple bytes, so copies are cheap.\r\n\r\nI know, that's why I understand you make a copy of it. (Might have expressed that poorly) \r\nWhat I don't understand is why it's _mutable_ (not const) since you don't (or aren't supposed to) change it.\r\nAgree it's cheap. It's a copy either way, here it's not an optimization for the compiler, just the reader (ie: we don't need to change that byte).\r\n\r\n> 2. [â¦]\r\n\r\nAddressed, no reference needed. auto is cute but counter productive, I agree.\r\n\r\n> still look natural to me ð\r\n\r\nD:\r\n\r\n> I forgot to mention, it can't be noexcept because std::string allocation is not noexcept (it can throw std::bad_alloc). \r\n\r\nThis is the part I was waiting for because now I'm sure I need to read the standard againâ¦ \r\nFirst I have to say I agree, it's not needed here, probably a future bug if used, doesn't add much. \r\nIt's just punctuation to me, at this point. \r\nAnd I know, allocation can fail, that's fine `std::terminate` is calledâ¦ We're deep into the rabbit hole here but I'll still cite the standard (C++17) since I had to look it up ð\r\n\r\n> Non-throwing functions are permitted to call potentially-throwing functions. Whenever an exception is thrown and the search for a handler encounters the outermost block of a non-throwing function, the function `std::terminate` [â¦] is called\r\n\r\ncf: [eel.is](http://eel.is/c++draft/except.spec#5)\r\nUnless you don't want to terminate, but then this function should throw, shouldn't it? ð¥º (Java has had the better of me, didn't it?) I need to read the standard anyway, will look into it :|\r\n\r\n",
      "created_at" : "2021-02-18T07:18:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-781113822",
      "id" : 781113822,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MTExMzgyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-18T07:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/781113822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7462994?v=4",
         "events_url" : "https://api.github.com/users/ViralTaco/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ViralTaco/followers",
         "following_url" : "https://api.github.com/users/ViralTaco/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ViralTaco/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ViralTaco",
         "id" : 7462994,
         "login" : "ViralTaco",
         "node_id" : "MDQ6VXNlcjc0NjI5OTQ=",
         "organizations_url" : "https://api.github.com/users/ViralTaco/orgs",
         "received_events_url" : "https://api.github.com/users/ViralTaco/received_events",
         "repos_url" : "https://api.github.com/users/ViralTaco/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ViralTaco/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ViralTaco/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ViralTaco"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 74bf850ac47735f2ef4306059d3e664d40cac85e\r\n",
      "created_at" : "2021-05-19T07:55:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21173#issuecomment-843845003",
      "id" : 843845003,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21173",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0Mzg0NTAwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-19T07:55:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/843845003",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
