{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "I'm seeing a very strange behavior with `signrawtransactionwithwallet` when I provide signed non-wallet inputs.\r\nThe following sample transaction (regtest) is a lightning HTLC transaction with added `bitcoind` wallet inputs/outputs to bump the fee:\r\n\r\n```\r\n020000000001027697c418d3c56138f1ea0469026d081705290bd0317ad9a133319fa7b4ac59b10200000000010000001cd5376d42e12bad24911ae73b13c40b530a18c3da34de8d16fcf356bf2e32180000000000fdffffff02bb080000000000002200209357506c5a4a2df7c685481aad0302a3ccfe44c4e41122e33818861a37e2e6cccdfbea020000000016001487c7624537496328484f590d04a805f0c2a213e30500483045022100aef712b8d806077872e894343f917473497841b6d859bb7cf20473597353e7d8022030c39a0dc43b742ad0b746e8968b763e3053ec1001bbae4f5368d15d20d1152683483045022100a71dba3a0ed7d005c5e99b3a3e603026e60cd2708e7590162892bae9391965ba0220179d15465950863401956d0d4bbad0f413ce465b111dc71fe511d9bbf4200d0f0120b27cf03ab42eb16a475e289df7878d8c36d9465ba6b4f22ce1d21ef217e4f3d88d76a914c333ee02e6633f9bce0281ae0dc09e29b1b2761f8763ac672103bcdf028d4e53f7fbddb817091a60118b1d2fb7ab8cbab4b14ebeb981450d6ff77c8201208763a91487520d9fc7939063f7244ce842e4a5d2507d93d188527c21036df69837ccd9b8b353bdd37a8c616e3ea094ffee4c9512fec902ae8250ffb9f952ae6775022701b175ac6851b275680000000000\r\n{\r\n  \"txid\": \"d922b3e02d77e7c522fcf46a308996df764dc61ef708a5702dc3dce6c2f58882\",\r\n  \"hash\": \"1f558b7fd77d1339c48772f6ef12a0bf6cdbc05e371c6871d885afc89e6a5e3c\",\r\n  \"version\": 2,\r\n  \"size\": 492,\r\n  \"vsize\": 248,\r\n  \"weight\": 990,\r\n  \"locktime\": 0,\r\n  \"vin\": [\r\n    {\r\n      \"txid\": \"b159acb4a79f3133a1d97a31d00b290517086d026904eaf13861c5d318c49776\",\r\n      \"vout\": 2,\r\n      \"scriptSig\": {\r\n        \"asm\": \"\",\r\n        \"hex\": \"\"\r\n      },\r\n      \"txinwitness\": [\r\n        \"\",\r\n        \"3045022100aef712b8d806077872e894343f917473497841b6d859bb7cf20473597353e7d8022030c39a0dc43b742ad0b746e8968b763e3053ec1001bbae4f5368d15d20d1152683\",\r\n        \"3045022100a71dba3a0ed7d005c5e99b3a3e603026e60cd2708e7590162892bae9391965ba0220179d15465950863401956d0d4bbad0f413ce465b111dc71fe511d9bbf4200d0f01\",\r\n        \"b27cf03ab42eb16a475e289df7878d8c36d9465ba6b4f22ce1d21ef217e4f3d8\",\r\n        \"76a914c333ee02e6633f9bce0281ae0dc09e29b1b2761f8763ac672103bcdf028d4e53f7fbddb817091a60118b1d2fb7ab8cbab4b14ebeb981450d6ff77c8201208763a91487520d9fc7939063f7244ce842e4a5d2507d93d188527c21036df69837ccd9b8b353bdd37a8c616e3ea094ffee4c9512fec902ae8250ffb9f952ae6775022701b175ac6851b27568\"\r\n      ],\r\n      \"sequence\": 1\r\n    },\r\n    {\r\n      \"txid\": \"18322ebf56f3fc168dde34dac3180a530bc4133be71a9124ad2be1426d37d51c\",\r\n      \"vout\": 0,\r\n      \"scriptSig\": {\r\n        \"asm\": \"\",\r\n        \"hex\": \"\"\r\n      },\r\n      \"sequence\": 4294967293\r\n    }\r\n  ],\r\n  \"vout\": [\r\n    {\r\n      \"value\": 0.00002235,\r\n      \"n\": 0,\r\n      \"scriptPubKey\": {\r\n        \"asm\": \"0 9357506c5a4a2df7c685481aad0302a3ccfe44c4e41122e33818861a37e2e6cc\",\r\n        \"hex\": \"00209357506c5a4a2df7c685481aad0302a3ccfe44c4e41122e33818861a37e2e6cc\",\r\n        \"reqSigs\": 1,\r\n        \"type\": \"witness_v0_scripthash\",\r\n        \"addresses\": [\r\n          \"bcrt1qjdt4qmz6fgkl0359fqd26qcz50x0u3xyusgj9cecrzrp5dlzumxq6sxuyz\"\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      \"value\": 0.48954317,\r\n      \"n\": 1,\r\n      \"scriptPubKey\": {\r\n        \"asm\": \"0 87c7624537496328484f590d04a805f0c2a213e3\",\r\n        \"hex\": \"001487c7624537496328484f590d04a805f0c2a213e3\",\r\n        \"reqSigs\": 1,\r\n        \"type\": \"witness_v0_keyhash\",\r\n        \"addresses\": [\r\n          \"bcrt1qslrky3fhf93jsjz0tyxsf2q97rp2yylr3fd72n\"\r\n        ]\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nNotice that the first input (the non-wallet one) has a stack with 5 elements (the first of which is empty). It is correctly signed and passes script validation.\r\n\r\nWhen I send this transaction to `signrawtransactionwithwallet`, `bitcoind` returns the following error: `Unable to sign input, invalid stack size (possibly missing key) (code: -1)` referencing the non-wallet input.\r\n\r\nBut it does correctly sign the wallet input and returns the following transaction:\r\n\r\n```\r\n020000000001027697c418d3c56138f1ea0469026d081705290bd0317ad9a133319fa7b4ac59b10200000000010000001cd5376d42e12bad24911ae73b13c40b530a18c3da34de8d16fcf356bf2e32180000000000fdffffff02bb080000000000002200209357506c5a4a2df7c685481aad0302a3ccfe44c4e41122e33818861a37e2e6cccdfbea020000000016001487c7624537496328484f590d04a805f0c2a213e3018d76a914c333ee02e6633f9bce0281ae0dc09e29b1b2761f8763ac672103bcdf028d4e53f7fbddb817091a60118b1d2fb7ab8cbab4b14ebeb981450d6ff77c8201208763a91487520d9fc7939063f7244ce842e4a5d2507d93d188527c21036df69837ccd9b8b353bdd37a8c616e3ea094ffee4c9512fec902ae8250ffb9f952ae6775022701b175ac6851b275680247304402201566b009b4e392ca16d0e5658e7fd2257e511e8974f198fb8ac265473d492949022001c9b41d261f8eacc19c41f179aa36a449200fe66abb8f3aab45c5d49e280f2901210271f8ed45eddce4cb9f990998f1d28f91fe4f747a7d67900b5382484276ae4bfd00000000\r\n{\r\n  \"txid\": \"d922b3e02d77e7c522fcf46a308996df764dc61ef708a5702dc3dce6c2f58882\",\r\n  \"hash\": \"06722d22306472337f1229ad9642c3530f161b7ef3d54e061acf7ca09fb8ed76\",\r\n  \"version\": 2,\r\n  \"size\": 418,\r\n  \"vsize\": 229,\r\n  \"weight\": 916,\r\n  \"locktime\": 0,\r\n  \"vin\": [\r\n    {\r\n      \"txid\": \"b159acb4a79f3133a1d97a31d00b290517086d026904eaf13861c5d318c49776\",\r\n      \"vout\": 2,\r\n      \"scriptSig\": {\r\n        \"asm\": \"\",\r\n        \"hex\": \"\"\r\n      },\r\n      \"txinwitness\": [\r\n        \"76a914c333ee02e6633f9bce0281ae0dc09e29b1b2761f8763ac672103bcdf028d4e53f7fbddb817091a60118b1d2fb7ab8cbab4b14ebeb981450d6ff77c8201208763a91487520d9fc7939063f7244ce842e4a5d2507d93d188527c21036df69837ccd9b8b353bdd37a8c616e3ea094ffee4c9512fec902ae8250ffb9f952ae6775022701b175ac6851b27568\"\r\n      ],\r\n      \"sequence\": 1\r\n    },\r\n    {\r\n      \"txid\": \"18322ebf56f3fc168dde34dac3180a530bc4133be71a9124ad2be1426d37d51c\",\r\n      \"vout\": 0,\r\n      \"scriptSig\": {\r\n        \"asm\": \"\",\r\n        \"hex\": \"\"\r\n      },\r\n      \"txinwitness\": [\r\n        \"304402201566b009b4e392ca16d0e5658e7fd2257e511e8974f198fb8ac265473d492949022001c9b41d261f8eacc19c41f179aa36a449200fe66abb8f3aab45c5d49e280f2901\",\r\n        \"0271f8ed45eddce4cb9f990998f1d28f91fe4f747a7d67900b5382484276ae4bfd\"\r\n      ],\r\n      \"sequence\": 4294967293\r\n    }\r\n  ],\r\n  \"vout\": [\r\n    {\r\n      \"value\": 0.00002235,\r\n      \"n\": 0,\r\n      \"scriptPubKey\": {\r\n        \"asm\": \"0 9357506c5a4a2df7c685481aad0302a3ccfe44c4e41122e33818861a37e2e6cc\",\r\n        \"hex\": \"00209357506c5a4a2df7c685481aad0302a3ccfe44c4e41122e33818861a37e2e6cc\",\r\n        \"reqSigs\": 1,\r\n        \"type\": \"witness_v0_scripthash\",\r\n        \"addresses\": [\r\n          \"bcrt1qjdt4qmz6fgkl0359fqd26qcz50x0u3xyusgj9cecrzrp5dlzumxq6sxuyz\"\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      \"value\": 0.48954317,\r\n      \"n\": 1,\r\n      \"scriptPubKey\": {\r\n        \"asm\": \"0 87c7624537496328484f590d04a805f0c2a213e3\",\r\n        \"hex\": \"001487c7624537496328484f590d04a805f0c2a213e3\",\r\n        \"reqSigs\": 1,\r\n        \"type\": \"witness_v0_keyhash\",\r\n        \"addresses\": [\r\n          \"bcrt1qslrky3fhf93jsjz0tyxsf2q97rp2yylr3fd72n\"\r\n        ]\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**Notice how it drops all witness stack elements from the non-wallet input except the last one**: this seems to be the culprit. If I ignore `bitcoind`'s error and restore the witness stack of the non-wallet input, the transaction becomes valid and can be correctly published.\r\n\r\nI tested this with Bitcoin Core 0.20.1 and 0.21.0, let me know if you want me to test against other versions.",
   "closed_at" : "2021-04-07T04:48:07Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   },
   "comments" : 4,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21151/comments",
   "created_at" : "2021-02-11T08:26:21Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21151/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/21151",
   "id" : 806177119,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21151/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU4MDYxNzcxMTk=",
   "number" : 21151,
   "performed_via_github_app" : null,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "signrawtransactionwithwallet fails with signed non-wallet inputs with many witness stack elements",
   "updated_at" : "2021-04-07T04:48:07Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21151",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/31281497?v=4",
      "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
      "followers_url" : "https://api.github.com/users/t-bast/followers",
      "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
      "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/t-bast",
      "id" : 31281497,
      "login" : "t-bast",
      "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
      "organizations_url" : "https://api.github.com/users/t-bast/orgs",
      "received_events_url" : "https://api.github.com/users/t-bast/received_events",
      "repos_url" : "https://api.github.com/users/t-bast/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/t-bast"
   }
}
