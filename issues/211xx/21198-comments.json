[
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for reviewing #20721 @ajtowns @amitiuttarwar @MarcoFalke. Here are your suggested changes.\r\n\r\n~I've marked as draft for now and will rebase on main once #21015 is merged so I can take @MarcoFalke's suggestion here: https://github.com/bitcoin/bitcoin/pull/20721#discussion_r576774527.~\r\n\r\nEDIT: That suggestion was taken in #21015, which has now been merged.",
      "created_at" : "2021-02-16T15:57:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#issuecomment-779931096",
      "id" : 779931096,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21198",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTkzMTA5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-30T09:50:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779931096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r576963891"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576963891"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you can use `std::optional<uint64_t>::value_or(uint64_t)` instead of passing pointers, no?",
      "commit_id" : "240ff15977e4966b37150252dd3f6bfff737a93e",
      "created_at" : "2021-02-16T16:33:49Z",
      "diff_hunk" : "@@ -1022,8 +1022,12 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n-    /** Return true if the peer has been connected for long enough to do inactivity checks. */\n-    bool RunInactivityChecks(const CNode& node) const;\n+    /** Return true if we should disconnect the peer for failing an inactivity check. */\n+    bool ShouldRunInactivityChecks(const CNode& node, const uint64_t const* pnow=nullptr) const\n+    {\n+        const uint64_t now = (pnow ? *pnow : GetSystemTimeInSeconds());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r576963891",
      "id" : 576963891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Njk2Mzg5MQ==",
      "original_commit_id" : "cb849ced9bed1d884395df972efe81e29fb20627",
      "original_line" : 1028,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 591407553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576963891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577361023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577361023"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Was there any reason to move this from net.cpp to net.h? (Coding guidelines say stuff should be in the .cpp unless inlining is critical [EDIT: I assumed the coding guidelines were why you didn't make it inline in the first place])\r\n\r\nI don't think `optnow.value_or(GetSystemTimeInseconds())` would be a good idea -- that would mean always invoking `GetSystemTimeInSeconds` and throwing away the result if you'd passed in a time.",
      "commit_id" : "240ff15977e4966b37150252dd3f6bfff737a93e",
      "created_at" : "2021-02-17T06:43:37Z",
      "diff_hunk" : "@@ -1022,8 +1022,12 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n-    /** Return true if the peer has been connected for long enough to do inactivity checks. */\n-    bool RunInactivityChecks(const CNode& node) const;\n+    /** Return true if we should disconnect the peer for failing an inactivity check. */\n+    bool ShouldRunInactivityChecks(const CNode& node, const uint64_t const* pnow=nullptr) const\n+    {\n+        const uint64_t now = (pnow ? *pnow : GetSystemTimeInSeconds());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577361023",
      "id" : 577361023,
      "in_reply_to_id" : 576963891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzM2MTAyMw==",
      "original_commit_id" : "cb849ced9bed1d884395df972efe81e29fb20627",
      "original_line" : 1028,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 591878394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577361023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577368098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577368098"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah good point on the arg to value_or always being evaluated. Though, keeping the ternary as is and changing the type to optional would work?",
      "commit_id" : "240ff15977e4966b37150252dd3f6bfff737a93e",
      "created_at" : "2021-02-17T07:01:37Z",
      "diff_hunk" : "@@ -1022,8 +1022,12 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n-    /** Return true if the peer has been connected for long enough to do inactivity checks. */\n-    bool RunInactivityChecks(const CNode& node) const;\n+    /** Return true if we should disconnect the peer for failing an inactivity check. */\n+    bool ShouldRunInactivityChecks(const CNode& node, const uint64_t const* pnow=nullptr) const\n+    {\n+        const uint64_t now = (pnow ? *pnow : GetSystemTimeInSeconds());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577368098",
      "id" : 577368098,
      "in_reply_to_id" : 576963891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzM2ODA5OA==",
      "original_commit_id" : "cb849ced9bed1d884395df972efe81e29fb20627",
      "original_line" : 1028,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 591886642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577368098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577464260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577464260"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Was there any reason to move this from net.cpp to net.h? (Coding guidelines say stuff should be in the .cpp unless inlining is critical [EDIT: I assumed the coding guidelines were why you didn't make it inline in the first place])\r\n\r\nOnly because you and amiti seemed to want it inlined. I didn't realise that this guidance was in the developer notes, but I completely agree. net.h is included in just about everything so any lines of code in this file are compiled hundreds of times.\r\n\r\nI'll move it back to the cpp file.",
      "commit_id" : "240ff15977e4966b37150252dd3f6bfff737a93e",
      "created_at" : "2021-02-17T09:43:57Z",
      "diff_hunk" : "@@ -1022,8 +1022,12 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n-    /** Return true if the peer has been connected for long enough to do inactivity checks. */\n-    bool RunInactivityChecks(const CNode& node) const;\n+    /** Return true if we should disconnect the peer for failing an inactivity check. */\n+    bool ShouldRunInactivityChecks(const CNode& node, const uint64_t const* pnow=nullptr) const\n+    {\n+        const uint64_t now = (pnow ? *pnow : GetSystemTimeInSeconds());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577464260",
      "id" : 577464260,
      "in_reply_to_id" : 576963891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzQ2NDI2MA==",
      "original_commit_id" : "cb849ced9bed1d884395df972efe81e29fb20627",
      "original_line" : 1028,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 592005519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577464260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577466358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577466358"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@jnewbery Having it inline means the `?:` can be resolved at compile time for every use case, and I couldn't resist the temptation.\r\n\r\n@MarcoFalke Yes, keeping the `?:` should work fine with optional instead of pointer.",
      "commit_id" : "240ff15977e4966b37150252dd3f6bfff737a93e",
      "created_at" : "2021-02-17T09:46:54Z",
      "diff_hunk" : "@@ -1022,8 +1022,12 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n-    /** Return true if the peer has been connected for long enough to do inactivity checks. */\n-    bool RunInactivityChecks(const CNode& node) const;\n+    /** Return true if we should disconnect the peer for failing an inactivity check. */\n+    bool ShouldRunInactivityChecks(const CNode& node, const uint64_t const* pnow=nullptr) const\n+    {\n+        const uint64_t now = (pnow ? *pnow : GetSystemTimeInSeconds());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577466358",
      "id" : 577466358,
      "in_reply_to_id" : 576963891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzQ2NjM1OA==",
      "original_commit_id" : "cb849ced9bed1d884395df972efe81e29fb20627",
      "original_line" : 1028,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 592008192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577466358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577479197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577479197"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't have a strong opinion about any of this. My default is to implement things in the cpp file unless the function is in a tight loop where performance really matters and the function call overhead is meaningful. Your suggestion in the previous PR was to inline it, and amiti mentioned the same thing to me, so I made that change here.\r\n\r\nI've now moved it back to the cpp and made the optional `now` arg a std::optional.",
      "commit_id" : "240ff15977e4966b37150252dd3f6bfff737a93e",
      "created_at" : "2021-02-17T10:04:05Z",
      "diff_hunk" : "@@ -1022,8 +1022,12 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n-    /** Return true if the peer has been connected for long enough to do inactivity checks. */\n-    bool RunInactivityChecks(const CNode& node) const;\n+    /** Return true if we should disconnect the peer for failing an inactivity check. */\n+    bool ShouldRunInactivityChecks(const CNode& node, const uint64_t const* pnow=nullptr) const\n+    {\n+        const uint64_t now = (pnow ? *pnow : GetSystemTimeInSeconds());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r577479197",
      "id" : 577479197,
      "in_reply_to_id" : 576963891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzQ3OTE5Nw==",
      "original_commit_id" : "cb849ced9bed1d884395df972efe81e29fb20627",
      "original_line" : 1028,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 592024761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/577479197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r578101941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578101941"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, it wouldn't surprise me if it gets optimised during linking these days anyway. My bad habits don't need to be yours!",
      "commit_id" : "240ff15977e4966b37150252dd3f6bfff737a93e",
      "created_at" : "2021-02-18T03:09:22Z",
      "diff_hunk" : "@@ -1022,8 +1022,12 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n-    /** Return true if the peer has been connected for long enough to do inactivity checks. */\n-    bool RunInactivityChecks(const CNode& node) const;\n+    /** Return true if we should disconnect the peer for failing an inactivity check. */\n+    bool ShouldRunInactivityChecks(const CNode& node, const uint64_t const* pnow=nullptr) const\n+    {\n+        const uint64_t now = (pnow ? *pnow : GetSystemTimeInSeconds());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r578101941",
      "id" : 578101941,
      "in_reply_to_id" : 576963891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODEwMTk0MQ==",
      "original_commit_id" : "cb849ced9bed1d884395df972efe81e29fb20627",
      "original_line" : 1028,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 592818407,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578101941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r578102337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578102337"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`if (   !    ShouldRunInactivityChecks())`",
      "commit_id" : "240ff15977e4966b37150252dd3f6bfff737a93e",
      "created_at" : "2021-02-18T03:10:23Z",
      "diff_hunk" : "@@ -1219,6 +1220,8 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     // use setmocktime in the tests).\n     int64_t now = GetSystemTimeInSeconds();\n \n+    if (ShouldRunInactivityChecks(node, now)) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r578102337",
      "id" : 578102337,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODEwMjMzNw==",
      "original_commit_id" : "ae12c657fa179e8a4187c579a7d49a7505142a81",
      "original_line" : 1223,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 592818729,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578102337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r578212689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578212689"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":flushed: \r\n\r\nfixed",
      "commit_id" : "ae12c657fa179e8a4187c579a7d49a7505142a81",
      "created_at" : "2021-02-18T08:17:16Z",
      "diff_hunk" : "@@ -1219,6 +1220,8 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     // use setmocktime in the tests).\n     int64_t now = GetSystemTimeInSeconds();\n \n+    if (ShouldRunInactivityChecks(node, now)) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r578212689",
      "id" : 578212689,
      "in_reply_to_id" : 578102337,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODIxMjY4OQ==",
      "original_commit_id" : "ae12c657fa179e8a4187c579a7d49a7505142a81",
      "original_line" : 1223,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 17,
      "pull_request_review_id" : 592948331,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578212689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r578213352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578213352"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think we have link time optimization enabled yet, but hopefully in the future!",
      "commit_id" : "240ff15977e4966b37150252dd3f6bfff737a93e",
      "created_at" : "2021-02-18T08:18:17Z",
      "diff_hunk" : "@@ -1022,8 +1022,12 @@ class CConnman\n \n     void SetAsmap(std::vector<bool> asmap) { addrman.m_asmap = std::move(asmap); }\n \n-    /** Return true if the peer has been connected for long enough to do inactivity checks. */\n-    bool RunInactivityChecks(const CNode& node) const;\n+    /** Return true if we should disconnect the peer for failing an inactivity check. */\n+    bool ShouldRunInactivityChecks(const CNode& node, const uint64_t const* pnow=nullptr) const\n+    {\n+        const uint64_t now = (pnow ? *pnow : GetSystemTimeInSeconds());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#discussion_r578213352",
      "id" : 578213352,
      "in_reply_to_id" : 576963891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODIxMzM1Mg==",
      "original_commit_id" : "cb849ced9bed1d884395df972efe81e29fb20627",
      "original_line" : 1028,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 592949092,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21198",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:18:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578213352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased on master to pick up fix for interface_zmq.py in #21008.",
      "created_at" : "2021-02-22T08:46:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#issuecomment-783203197",
      "id" : 783203197,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21198",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzIwMzE5Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T08:46:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783203197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21563 (net: Drop cs_sendProcessing mutex that guards nothing by hebasto)\n* #21236 (net processing: Extract `addr` send functionality into MaybeSendAddr() by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-04T16:33:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#issuecomment-790749274",
      "id" : 790749274,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21198",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDc0OTI3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-01T06:24:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790749274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and moved out of draft.",
      "created_at" : "2021-03-30T09:52:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#issuecomment-810084084",
      "id" : 810084084,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21198",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMDA4NDA4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-30T09:52:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/810084084",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-01T09:05:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#issuecomment-811767726",
      "id" : 811767726,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21198",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTc2NzcyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-01T09:05:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811767726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2021-04-01T10:35:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#issuecomment-811818121",
      "id" : 811818121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21198",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTgxODEyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-01T10:35:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811818121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 5ed535a02f8f0a6f65bbe19f48a8c81f43298393",
      "created_at" : "2021-04-01T14:36:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21198#issuecomment-811951990",
      "id" : 811951990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21198",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTk1MTk5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-01T14:36:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811951990",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
