[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21270 ([Bundle 4/n] Prune g_chainman usage in validation-adjacent modules by dongcarl)\n* #21224 ([p2p] Halt processing of unrequested transactions by ariard)\n* #21162 (Net Processing: Move RelayTransaction() into PeerManager by jnewbery)\n* #21160 (Net/Net processing: Move tx inventory into net_processing by jnewbery)\n* #21061 ([p2p] Introduce node rebroadcast module by amitiuttarwar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-02-11T05:54:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-777218822",
      "id" : 777218822,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzIxODgyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-25T20:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777218822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased for conflict with #21062 ",
      "created_at" : "2021-02-15T02:32:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-778900606",
      "id" : 778900606,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3ODkwMDYwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T02:32:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/778900606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Will review once this is rebased and out of draft status.",
      "created_at" : "2021-02-15T11:42:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-779167259",
      "id" : 779167259,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTE2NzI1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T11:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779167259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased, tweaked the orphan code a little, and cleaned up the results some. Should be ready for review.",
      "created_at" : "2021-02-15T14:24:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-779255411",
      "id" : 779255411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTI1NTQxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T14:24:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779255411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "concept ACK, starting to review. \r\n\r\ntwo thoughts for now-\r\n1. I don't quite understand the context of the first commit. There are other commits that are essentially move-only, so wondering how you grouped together the changes in that commit. \r\n2. Are you open to some feedback around improvements of code you moved around? eg. using chrono instead of ints? or are you trying to keep the diff as minimal as possible? I personally think it'd be a good time for stuff that would be small, clear improvements, but won't leave those sorts of review comments if you're not interested :) ",
      "created_at" : "2021-02-16T03:42:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-779561043",
      "id" : 779561043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTU2MTA0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T03:42:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779561043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@amitiuttarwar 1) The first commit just sets up the new files and moves whole functions / globals into it. Later commits are pulling code out into their own functions, restructuring functions into classes, etc. 2) hmm, I was ignoring chrono stuff since #21015 exists, but I guess it didn't switch COrphanTx to chrono. Not sure it makes sense to add more things to this PR versus adding to the #20758 backlog. [EDIT: ie, feel free to add suggestions to 20758, but maybe this PR already has enough stuff in scope?]",
      "created_at" : "2021-02-17T07:30:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-780364661",
      "id" : 780364661,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDM2NDY2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-17T07:31:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780364661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-02-20T09:56:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-782598136",
      "id" : 782598136,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MjU5ODEzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-20T09:56:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/782598136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582712110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582712110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's generally recommended to include the c++ versions of the c headers:\r\n\r\n```suggestion\r\n#include <cassert>\r\n```",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T10:18:48Z",
      "diff_hunk" : "@@ -0,0 +1,201 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txorphanage.h>\n+\n+#include <consensus/validation.h>\n+#include <policy/policy.h>\n+\n+#include <assert.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582712110",
      "id" : 582712110,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjcxMjExMA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 10,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582712110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582740285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582740285"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Possibly slightly more idiomatic to drop the `> 0`:\r\n\r\n```suggestion\r\n        return m_wtxid_to_orphan_it.count(gtxid.GetHash());\r\n```\r\n\r\nSame below",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T10:59:54Z",
      "diff_hunk" : "@@ -0,0 +1,201 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txorphanage.h>\n+\n+#include <consensus/validation.h>\n+#include <policy/policy.h>\n+\n+#include <assert.h>\n+\n+/** Expiration time for orphan transactions in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_TIME = 20 * 60;\n+/** Minimum time between orphan transactions expire time checks in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_INTERVAL = 5 * 60;\n+\n+RecursiveMutex g_cs_orphans;\n+\n+bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    const uint256& hash = tx->GetHash();\n+    if (m_orphans.count(hash))\n+        return false;\n+\n+    // Ignore big transactions, to avoid a\n+    // send-big-orphans memory exhaustion attack. If a peer has a legitimate\n+    // large transaction with a missing parent then we assume\n+    // it will rebroadcast it later, after the parent transaction(s)\n+    // have been mined or received.\n+    // 100 orphans, each of which is at most 100,000 bytes big is\n+    // at most 10 megabytes of orphans and somewhat more byprev index (in the worst case):\n+    unsigned int sz = GetTransactionWeight(*tx);\n+    if (sz > MAX_STANDARD_TX_WEIGHT)\n+    {\n+        LogPrint(BCLog::MEMPOOL, \"ignoring large orphan tx (size: %u, hash: %s)\\n\", sz, hash.ToString());\n+        return false;\n+    }\n+\n+    auto ret = m_orphans.emplace(hash, OrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, m_orphan_list.size()});\n+    assert(ret.second);\n+    m_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    m_wtxid_to_orphan_it.emplace(tx->GetWitnessHash(), ret.first);\n+    for (const CTxIn& txin : tx->vin) {\n+        m_outpoint_to_orphan_it[txin.prevout].insert(ret.first);\n+    }\n+\n+    LogPrint(BCLog::MEMPOOL, \"stored orphan tx %s (mapsz %u outsz %u)\\n\", hash.ToString(),\n+             m_orphans.size(), m_outpoint_to_orphan_it.size());\n+    return true;\n+}\n+\n+int TxOrphanage::EraseTx(const uint256& txid)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    std::map<uint256, OrphanTx>::iterator it = m_orphans.find(txid);\n+    if (it == m_orphans.end())\n+        return 0;\n+    for (const CTxIn& txin : it->second.tx->vin)\n+    {\n+        auto itPrev = m_outpoint_to_orphan_it.find(txin.prevout);\n+        if (itPrev == m_outpoint_to_orphan_it.end())\n+            continue;\n+        itPrev->second.erase(it);\n+        if (itPrev->second.empty())\n+            m_outpoint_to_orphan_it.erase(itPrev);\n+    }\n+\n+    size_t old_pos = it->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it);\n+    if (old_pos + 1 != m_orphan_list.size()) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    m_wtxid_to_orphan_it.erase(it->second.tx->GetWitnessHash());\n+\n+    m_orphans.erase(it);\n+    return 1;\n+}\n+\n+void TxOrphanage::EraseForPeer(NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    int nErased = 0;\n+    std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+    while (iter != m_orphans.end())\n+    {\n+        std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        if (maybeErase->second.fromPeer == peer)\n+        {\n+            nErased += EraseTx(maybeErase->second.tx->GetHash());\n+        }\n+    }\n+    if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+}\n+\n+unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    unsigned int nEvicted = 0;\n+    static int64_t nNextSweep;\n+    int64_t nNow = GetTime();\n+    if (nNextSweep <= nNow) {\n+        // Sweep out expired orphan pool entries:\n+        int nErased = 0;\n+        int64_t nMinExpTime = nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL;\n+        std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+        while (iter != m_orphans.end())\n+        {\n+            std::map<uint256, OrphanTx>::iterator maybeErase = iter++;\n+            if (maybeErase->second.nTimeExpire <= nNow) {\n+                nErased += EraseTx(maybeErase->second.tx->GetHash());\n+            } else {\n+                nMinExpTime = std::min(maybeErase->second.nTimeExpire, nMinExpTime);\n+            }\n+        }\n+        // Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.\n+        nNextSweep = nMinExpTime + ORPHAN_TX_EXPIRE_INTERVAL;\n+        if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx due to expiration\\n\", nErased);\n+    }\n+    FastRandomContext rng;\n+    while (m_orphans.size() > max_orphans)\n+    {\n+        // Evict a random orphan:\n+        size_t randompos = rng.randrange(m_orphan_list.size());\n+        EraseTx(m_orphan_list[randompos]->first);\n+        ++nEvicted;\n+    }\n+    return nEvicted;\n+}\n+\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    for (unsigned int i = 0; i < tx.vout.size(); i++) {\n+        const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n+        if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n+            for (const auto& elem : it_by_prev->second) {\n+                orphan_work_set.insert(elem->first);\n+            }\n+        }\n+    }\n+}\n+\n+bool TxOrphanage::HaveTx(const GenTxid& gtxid)\n+{\n+    LOCK(g_cs_orphans);\n+    if (gtxid.IsWtxid()) {\n+        return m_wtxid_to_orphan_it.count(gtxid.GetHash()) > 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582740285",
      "id" : 582740285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc0MDI4NQ==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 157,
      "original_position" : 157,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582740285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582748821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582748821"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This feels like it's exposing too much of the internals to the caller. The pointer is only valid as long as `m_orphans` isn't updated while it's being held. That's protected by `g_cs_orphans`, but it still feels unnecessary.\r\n\r\nThe only parts of `OrphanTx` that are needed by the caller in the one place this is used are the `CTransactionRef` and the `NodeId`, both of which are cheap to copy. How about:\r\n\r\n```suggestion\r\n    /** Get a transation ref and originating peer for an orphan transaction\r\n      * (transaction ref will be nullptr if not found) */\r\n    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\r\n```\r\n\r\n<details>\r\n<summary>Full diff</summary>\r\n\r\n```diff\r\niff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex df3de89094..b138844a50 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -2057,17 +2057,16 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\r\n         const uint256 orphanHash = *orphan_work_set.begin();\r\n         orphan_work_set.erase(orphan_work_set.begin());\r\n \r\n-        const TxOrphanage::OrphanTx* orphantx = m_orphanage.GetTx(orphanHash);\r\n-        if (orphantx == nullptr) continue;\r\n+        auto [tx, from_peer] = m_orphanage.GetTx(orphanHash);\r\n+        if (!tx) continue;\r\n \r\n-        const CTransactionRef porphanTx = orphantx->tx;\r\n-        const MempoolAcceptResult result = AcceptToMemoryPool(::ChainstateActive(), m_mempool, porphanTx, false /* bypass_limits */);\r\n+        const MempoolAcceptResult result = AcceptToMemoryPool(::ChainstateActive(), m_mempool, tx, false /* bypass_limits */);\r\n         const TxValidationState& state = result.m_state;\r\n \r\n         if (result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\r\n             LogPrint(BCLog::MEMPOOL, \"   accepted orphan tx %s\\n\", orphanHash.ToString());\r\n-            RelayTransaction(orphanHash, porphanTx->GetWitnessHash(), m_connman);\r\n-            m_orphanage.AddChildrenToWorkSet(*porphanTx, orphan_work_set);\r\n+            RelayTransaction(orphanHash, tx->GetWitnessHash(), m_connman);\r\n+            m_orphanage.AddChildrenToWorkSet(*tx, orphan_work_set);\r\n             m_orphanage.EraseTx(orphanHash);\r\n             for (const CTransactionRef& removedTx : result.m_replaced_transactions.value()) {\r\n                 AddToCompactExtraTransactions(removedTx);\r\n@@ -2077,10 +2076,10 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\r\n             if (state.IsInvalid()) {\r\n                 LogPrint(BCLog::MEMPOOL, \"   invalid orphan tx %s from peer=%d. %s\\n\",\r\n                     orphanHash.ToString(),\r\n-                    orphantx->fromPeer,\r\n+                    from_peer,\r\n                     state.ToString());\r\n                 // Maybe punish peer that gave us an invalid orphan tx\r\n-                MaybePunishNodeForTx(orphantx->fromPeer, state);\r\n+                MaybePunishNodeForTx(from_peer, state);\r\n             }\r\n             // Has inputs but not accepted to mempool\r\n             // Probably non-standard or insufficient fee\r\n@@ -2100,7 +2099,7 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\r\n                 // for concerns around weakening security of unupgraded nodes\r\n                 // if we start doing this too early.\r\n                 assert(recentRejects);\r\n-                recentRejects->insert(porphanTx->GetWitnessHash());\r\n+                recentRejects->insert(tx->GetWitnessHash());\r\n                 // If the transaction failed for TX_INPUTS_NOT_STANDARD,\r\n                 // then we know that the witness was irrelevant to the policy\r\n                 // failure, since this check depends only on the txid\r\n@@ -2109,10 +2108,10 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\r\n                 // processing of this transaction in the event that child\r\n                 // transactions are later received (resulting in\r\n                 // parent-fetching by txid via the orphan-handling logic).\r\n-                if (state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD && porphanTx->GetWitnessHash() != porphanTx->GetHash()) {\r\n+                if (state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD && tx->GetWitnessHash() != tx->GetHash()) {\r\n                     // We only add the txid if it differs from the wtxid, to\r\n                     // avoid wasting entries in the rolling bloom filter.\r\n-                    recentRejects->insert(porphanTx->GetHash());\r\n+                    recentRejects->insert(tx->GetHash());\r\n                 }\r\n             }\r\n             m_orphanage.EraseTx(orphanHash);\r\ndiff --git a/src/txorphanage.cpp b/src/txorphanage.cpp\r\nindex a634bde953..a311984705 100644\r\n--- a/src/txorphanage.cpp\r\n+++ b/src/txorphanage.cpp\r\n@@ -160,13 +160,13 @@ bool TxOrphanage::HaveTx(const GenTxid& gtxid)\r\n     }\r\n }\r\n \r\n-TxOrphanage::OrphanTx* TxOrphanage::GetTx(const uint256& txid)\r\n+std::pair<CTransactionRef, NodeId> TxOrphanage::GetTx(const uint256& txid)\r\n {\r\n     AssertLockHeld(g_cs_orphans);\r\n \r\n     const auto it = m_orphans.find(txid);\r\n-    if (it == m_orphans.end()) return nullptr;\r\n-    return &it->second;\r\n+    if (it == m_orphans.end()) return {nullptr, 0};\r\n+    return {it->second.tx, it->second.fromPeer};\r\n }\r\n \r\n void TxOrphanage::EraseForBlock(const CBlock& block)\r\ndiff --git a/src/txorphanage.h b/src/txorphanage.h\r\nindex f33415ad95..bf1249a154 100644\r\n--- a/src/txorphanage.h\r\n+++ b/src/txorphanage.h\r\n@@ -30,7 +30,7 @@ public:\r\n     bool HaveTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\r\n \r\n     /** Get the details of an orphan transaction (returns nullptr if not found) */\r\n-    OrphanTx* GetTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\r\n+    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\r\n \r\n     /** Erase an orphan by txid */\r\n     int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\r\n```\r\n</details>",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T11:14:07Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;\n+        size_t list_pos;\n+    };\n+\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    OrphanTx* GetTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582748821",
      "id" : 582748821,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc0ODgyMQ==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 33,
      "original_position" : 33,
      "original_start_line" : 32,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582748821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582750624"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582750624"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you include `logging.h` rather than relying on it being included transitively?\r\n\r\nIt might also make sense to change all these logs' categories to NET at some point?",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T11:17:02Z",
      "diff_hunk" : "@@ -0,0 +1,201 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txorphanage.h>\n+\n+#include <consensus/validation.h>\n+#include <policy/policy.h>\n+\n+#include <assert.h>\n+\n+/** Expiration time for orphan transactions in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_TIME = 20 * 60;\n+/** Minimum time between orphan transactions expire time checks in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_INTERVAL = 5 * 60;\n+\n+RecursiveMutex g_cs_orphans;\n+\n+bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    const uint256& hash = tx->GetHash();\n+    if (m_orphans.count(hash))\n+        return false;\n+\n+    // Ignore big transactions, to avoid a\n+    // send-big-orphans memory exhaustion attack. If a peer has a legitimate\n+    // large transaction with a missing parent then we assume\n+    // it will rebroadcast it later, after the parent transaction(s)\n+    // have been mined or received.\n+    // 100 orphans, each of which is at most 100,000 bytes big is\n+    // at most 10 megabytes of orphans and somewhat more byprev index (in the worst case):\n+    unsigned int sz = GetTransactionWeight(*tx);\n+    if (sz > MAX_STANDARD_TX_WEIGHT)\n+    {\n+        LogPrint(BCLog::MEMPOOL, \"ignoring large orphan tx (size: %u, hash: %s)\\n\", sz, hash.ToString());\n+        return false;\n+    }\n+\n+    auto ret = m_orphans.emplace(hash, OrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, m_orphan_list.size()});\n+    assert(ret.second);\n+    m_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    m_wtxid_to_orphan_it.emplace(tx->GetWitnessHash(), ret.first);\n+    for (const CTxIn& txin : tx->vin) {\n+        m_outpoint_to_orphan_it[txin.prevout].insert(ret.first);\n+    }\n+\n+    LogPrint(BCLog::MEMPOOL, \"stored orphan tx %s (mapsz %u outsz %u)\\n\", hash.ToString(),\n+             m_orphans.size(), m_outpoint_to_orphan_it.size());\n+    return true;\n+}\n+\n+int TxOrphanage::EraseTx(const uint256& txid)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    std::map<uint256, OrphanTx>::iterator it = m_orphans.find(txid);\n+    if (it == m_orphans.end())\n+        return 0;\n+    for (const CTxIn& txin : it->second.tx->vin)\n+    {\n+        auto itPrev = m_outpoint_to_orphan_it.find(txin.prevout);\n+        if (itPrev == m_outpoint_to_orphan_it.end())\n+            continue;\n+        itPrev->second.erase(it);\n+        if (itPrev->second.empty())\n+            m_outpoint_to_orphan_it.erase(itPrev);\n+    }\n+\n+    size_t old_pos = it->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it);\n+    if (old_pos + 1 != m_orphan_list.size()) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    m_wtxid_to_orphan_it.erase(it->second.tx->GetWitnessHash());\n+\n+    m_orphans.erase(it);\n+    return 1;\n+}\n+\n+void TxOrphanage::EraseForPeer(NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    int nErased = 0;\n+    std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+    while (iter != m_orphans.end())\n+    {\n+        std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        if (maybeErase->second.fromPeer == peer)\n+        {\n+            nErased += EraseTx(maybeErase->second.tx->GetHash());\n+        }\n+    }\n+    if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+}\n+\n+unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    unsigned int nEvicted = 0;\n+    static int64_t nNextSweep;\n+    int64_t nNow = GetTime();\n+    if (nNextSweep <= nNow) {\n+        // Sweep out expired orphan pool entries:\n+        int nErased = 0;\n+        int64_t nMinExpTime = nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL;\n+        std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+        while (iter != m_orphans.end())\n+        {\n+            std::map<uint256, OrphanTx>::iterator maybeErase = iter++;\n+            if (maybeErase->second.nTimeExpire <= nNow) {\n+                nErased += EraseTx(maybeErase->second.tx->GetHash());\n+            } else {\n+                nMinExpTime = std::min(maybeErase->second.nTimeExpire, nMinExpTime);\n+            }\n+        }\n+        // Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.\n+        nNextSweep = nMinExpTime + ORPHAN_TX_EXPIRE_INTERVAL;\n+        if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx due to expiration\\n\", nErased);\n+    }\n+    FastRandomContext rng;\n+    while (m_orphans.size() > max_orphans)\n+    {\n+        // Evict a random orphan:\n+        size_t randompos = rng.randrange(m_orphan_list.size());\n+        EraseTx(m_orphan_list[randompos]->first);\n+        ++nEvicted;\n+    }\n+    return nEvicted;\n+}\n+\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    for (unsigned int i = 0; i < tx.vout.size(); i++) {\n+        const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n+        if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n+            for (const auto& elem : it_by_prev->second) {\n+                orphan_work_set.insert(elem->first);\n+            }\n+        }\n+    }\n+}\n+\n+bool TxOrphanage::HaveTx(const GenTxid& gtxid)\n+{\n+    LOCK(g_cs_orphans);\n+    if (gtxid.IsWtxid()) {\n+        return m_wtxid_to_orphan_it.count(gtxid.GetHash()) > 0;\n+    } else {\n+        return m_orphans.count(gtxid.GetHash()) > 0;\n+    }\n+}\n+\n+TxOrphanage::OrphanTx* TxOrphanage::GetTx(const uint256& txid)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    const auto it = m_orphans.find(txid);\n+    if (it == m_orphans.end()) return nullptr;\n+    return &it->second;\n+}\n+\n+void TxOrphanage::EraseForBlock(const CBlock& block)\n+{\n+    LOCK(g_cs_orphans);\n+\n+    std::vector<uint256> vOrphanErase;\n+\n+    for (const CTransactionRef& ptx : block.vtx) {\n+        const CTransaction& tx = *ptx;\n+\n+        // Which orphan pool entries must we evict?\n+        for (const auto& txin : tx.vin) {\n+            auto itByPrev = m_outpoint_to_orphan_it.find(txin.prevout);\n+            if (itByPrev == m_outpoint_to_orphan_it.end()) continue;\n+            for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n+                const CTransaction& orphanTx = *(*mi)->second.tx;\n+                const uint256& orphanHash = orphanTx.GetHash();\n+                vOrphanErase.push_back(orphanHash);\n+            }\n+        }\n+    }\n+\n+    // Erase orphan transactions included or precluded by this block\n+    if (vOrphanErase.size()) {\n+        int nErased = 0;\n+        for (const uint256& orphanHash : vOrphanErase) {\n+            nErased += EraseTx(orphanHash);\n+        }\n+        LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582750624",
      "id" : 582750624,
      "line" : 200,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc1MDYyNA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 200,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 200,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582750624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582761488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582761488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is using the definition for `CBlock` which is included transitively through txorphanage.h -> net.h -> chainparams.h -> primitives/block.h.\r\n\r\nYou could erase that dependency, so that the orphanage has no concept of blocks:\r\n\r\n```suggestion\r\n    /** Erase orphans */\r\n    void EraseOrphans(const std::vector<CTransactionRef>& txs) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\r\n```\r\n\r\nAnd then calling this from net_processing with:\r\n\r\n`m_orphanage.EraseOrphans(pblock->vtx);`",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T11:35:38Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;\n+        size_t list_pos;\n+    };\n+\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    OrphanTx* GetTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans included in / invalidated by a new block */\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582761488",
      "id" : 582761488,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc2MTQ4OA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 36,
      "original_position" : 42,
      "original_start_line" : 41,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582761488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582765024"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582765024"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure if this alias is very useful. It's only used in two places.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T11:41:37Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;\n+        size_t list_pos;\n+    };\n+\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    OrphanTx* GetTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans included in / invalidated by a new block */\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Limit the orphanage to the given maximum */\n+    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** A set of orphans to be tested for potential acceptance into the mempool */\n+    using WorkSet = std::set<uint256>;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582765024",
      "id" : 582765024,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc2NTAyNA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 48,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582765024",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582766809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582766809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you're touching this comment, then maybe just remove it. These section markers have long outlived their usefulness.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T11:44:18Z",
      "diff_hunk" : "@@ -1119,10 +1088,10 @@ bool PeerManagerImpl::GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats)\n \n //////////////////////////////////////////////////////////////////////////////\n //\n-// mapOrphanTransactions\n+// Orphan handling",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582766809",
      "id" : 582766809,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc2NjgwOQ==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 1091,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582766809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582767376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582767376"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":heart: ",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T11:45:20Z",
      "diff_hunk" : "@@ -4948,15 +4759,3 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     return true;\n }\n \n-class CNetProcessingCleanup",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582767376",
      "id" : 582767376,
      "line" : 4951,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc2NzM3Ng==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 4951,
      "original_position" : 405,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 402,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582767376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582768423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582768423"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It might make sense to move the orphanage unit tests into their own file now that txorphanage has been split out from net_processing?",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T11:47:05Z",
      "diff_hunk" : "@@ -295,15 +284,23 @@ BOOST_AUTO_TEST_CASE(DoS_bantime)\n     peerLogic->FinalizeNode(dummyNode, dummy);\n }\n \n-static CTransactionRef RandomOrphan()\n+class TxOrphanageTest : public TxOrphanage",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582768423",
      "id" : 582768423,
      "line" : 287,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc2ODQyMw==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 287,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : 32,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582768423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582771389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582771389"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Doesn't have to be in this PR, but perhaps a future PR could make `nMaxOrphanTx` a ctor argument, and then just call `LimitOrphans()` without an argument. This is the only place in the non-test code that `LimitOrphans` is called, and it's always with the same argument.\r\n\r\nIn fact, once `const nMaxOrphanTx` is a member of the orphanage, we don't need a `LimitOrphans()` call at all. We can just limit the size within the `TxOrphanage::AddTx` function.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T11:51:58Z",
      "diff_hunk" : "@@ -3330,11 +3141,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 m_txrequest.ForgetTxHash(tx.GetHash());\n                 m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n \n-                // DoS prevention: do not allow mapOrphanTransactions to grow unbounded (see CVE-2012-3789)\n+                // DoS prevention: do not allow m_orphanage to grow unbounded (see CVE-2012-3789)\n                 unsigned int nMaxOrphanTx = (unsigned int)std::max((int64_t)0, gArgs.GetArg(\"-maxorphantx\", DEFAULT_MAX_ORPHAN_TRANSACTIONS));\n-                unsigned int nEvicted = LimitOrphanTxSize(nMaxOrphanTx);\n+                unsigned int nEvicted = m_orphanage.LimitOrphans(nMaxOrphanTx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582771389",
      "id" : 582771389,
      "line" : 3129,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc3MTM4OQ==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 3129,
      "original_position" : 394,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 391,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582771389",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582774084"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582774084"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider just removing this function entirely:\r\n\r\n- it's only called in one place\r\n- it consists of two function calls\r\n- the return value is discarded",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T11:56:27Z",
      "diff_hunk" : "@@ -1133,126 +1102,17 @@ static void AddToCompactExtraTransactions(const CTransactionRef& tx) EXCLUSIVE_L\n     vExtraTxnForCompactIt = (vExtraTxnForCompactIt + 1) % max_extra_txn;\n }\n \n-bool AddOrphanTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans)\n+bool PeerManagerImpl::AddOrphanTx(const CTransactionRef& tx, NodeId peer)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582774084",
      "id" : 582774084,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjc3NDA4NA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 1105,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 598406016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582774084",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582850158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582850158"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think these could be const, they should never change?\r\n```suggestion\r\n        const NodeId fromPeer;\r\n        const int64_t nTimeExpire;\r\n```",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-25T13:54:57Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r582850158",
      "id" : 582850158,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mjg1MDE1OA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 22,
      "original_position" : 22,
      "original_start_line" : 21,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 598586736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/582850158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583670694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583670694"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that would be a good idea for a later PR (particularly one that added more test coverage)",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-26T14:20:26Z",
      "diff_hunk" : "@@ -295,15 +284,23 @@ BOOST_AUTO_TEST_CASE(DoS_bantime)\n     peerLogic->FinalizeNode(dummyNode, dummy);\n }\n \n-static CTransactionRef RandomOrphan()\n+class TxOrphanageTest : public TxOrphanage",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583670694",
      "id" : 583670694,
      "in_reply_to_id" : 582768423,
      "line" : 287,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzY3MDY5NA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 287,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : 32,
      "pull_request_review_id" : 599617937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583670694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583671340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583671340"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure about the `const` part -- it might make sense for the limit to change depending on how much pressure there is in the mempool at large. Agree otherwise.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-26T14:21:19Z",
      "diff_hunk" : "@@ -3330,11 +3141,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 m_txrequest.ForgetTxHash(tx.GetHash());\n                 m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n \n-                // DoS prevention: do not allow mapOrphanTransactions to grow unbounded (see CVE-2012-3789)\n+                // DoS prevention: do not allow m_orphanage to grow unbounded (see CVE-2012-3789)\n                 unsigned int nMaxOrphanTx = (unsigned int)std::max((int64_t)0, gArgs.GetArg(\"-maxorphantx\", DEFAULT_MAX_ORPHAN_TRANSACTIONS));\n-                unsigned int nEvicted = LimitOrphanTxSize(nMaxOrphanTx);\n+                unsigned int nEvicted = m_orphanage.LimitOrphans(nMaxOrphanTx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583671340",
      "id" : 583671340,
      "in_reply_to_id" : 582771389,
      "line" : 3129,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzY3MTM0MA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 3129,
      "original_position" : 394,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 391,
      "pull_request_review_id" : 599618810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583671340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583691471"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583691471"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Dang, why didn't I think of that.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-26T14:49:22Z",
      "diff_hunk" : "@@ -1133,126 +1102,17 @@ static void AddToCompactExtraTransactions(const CTransactionRef& tx) EXCLUSIVE_L\n     vExtraTxnForCompactIt = (vExtraTxnForCompactIt + 1) % max_extra_txn;\n }\n \n-bool AddOrphanTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans)\n+bool PeerManagerImpl::AddOrphanTx(const CTransactionRef& tx, NodeId peer)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583691471",
      "id" : 583691471,
      "in_reply_to_id" : 582774084,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzY5MTQ3MQ==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 1105,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 599645616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583691471",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583698718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583698718"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done. First instance of structure binding in the codebase?",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-26T14:59:21Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;\n+        size_t list_pos;\n+    };\n+\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    OrphanTx* GetTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583698718",
      "id" : 583698718,
      "in_reply_to_id" : 582748821,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzY5ODcxOA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 33,
      "original_position" : 33,
      "original_start_line" : 32,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 599655393,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583698718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583702390"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583702390"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Definite nack on the comment change -- the function erases orphans that are double-spent by txs in the block, not just orphans that are included in the block directly.\r\n\r\nI'm not against having vtx dereferenced in the caller, but the logic seems specific to a block arriving: if it were just an in-mempool tx double-spending an orphan tx, it might be that the orphan is actually a successful RBF and should be accepted once we know all its parents. So I think having it be the actual block as the argument makes sense; and since it's a lightweight header that's transitively included anyway, I've kept it as-is (but included the header explicitly).",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-26T15:04:39Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;\n+        size_t list_pos;\n+    };\n+\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    OrphanTx* GetTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans included in / invalidated by a new block */\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583702390",
      "id" : 583702390,
      "in_reply_to_id" : 582761488,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzcwMjM5MA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 36,
      "original_position" : 42,
      "original_start_line" : 41,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 599660572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583702390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added most of jnewbery's suggestions, and also added some missing `const` annotations on `TxOrphanage` methods.",
      "created_at" : "2021-02-26T15:06:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-786703013",
      "id" : 786703013,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NjcwMzAxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-26T15:06:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/786703013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583784124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583784124"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, good point about erasing orphans that are conflicted by the block. I agree that it's fine to keep this as it is.\r\n\r\nThanks for including primitives/block.h",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-26T17:02:59Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;\n+        size_t list_pos;\n+    };\n+\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    OrphanTx* GetTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans included in / invalidated by a new block */\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r583784124",
      "id" : 583784124,
      "in_reply_to_id" : 582761488,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Mzc4NDEyNA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 36,
      "original_position" : 42,
      "original_start_line" : 41,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 599768750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/583784124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r584096409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584096409"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps update this comment to reflect the new return value:\r\n\r\n```suggestion\r\n    /** Get a transation ref and originating peer for an orphan transaction\r\n      * (transaction ref will be nullptr if not found) */```",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-27T09:32:20Z",
      "diff_hunk" : "@@ -0,0 +1,80 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r584096409",
      "id" : 584096409,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDA5NjQwOQ==",
      "original_commit_id" : "eeeafb324ef6057f40b5c5fdd8464110e809b0f7",
      "original_line" : 26,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 600123368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584096409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r584097273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584097273"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    /** Erase all orphans included in or invalidated by a new block */\r\n```\r\n\r\nis slightly clearer. The `/` could be interpreted as 'and'.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-02-27T09:41:10Z",
      "diff_hunk" : "@@ -0,0 +1,80 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans included in / invalidated by a new block */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r584097273",
      "id" : 584097273,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDA5NzI3Mw==",
      "original_commit_id" : "eeeafb324ef6057f40b5c5fdd8464110e809b0f7",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 600123368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584097273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r584999313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584999313"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "~Question: Would using a `std::list` be simpler? It looks like we use `list_pos` + swapping with the last element to get better performance on random eviction in a vector, but why not just use a linked list?~",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-01T19:42:42Z",
      "diff_hunk" : "@@ -0,0 +1,80 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans included in / invalidated by a new block */\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Limit the orphanage to the given maximum */\n+    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Add any orphans that list a particular tx as a parent into a peer's work set\n+     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n+    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+protected:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;\n+        size_t list_pos;\n+    };\n+\n+    /** Map from txid to orphan transaction record. Limited by\n+     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n+    std::map<uint256, OrphanTx> m_orphans GUARDED_BY(g_cs_orphans);\n+\n+    using OrphanMap = decltype(m_orphans);\n+\n+    struct IteratorComparator\n+    {\n+        template<typename I>\n+        bool operator()(const I& a, const I& b) const\n+        {\n+            return &(*a) < &(*b);\n+        }\n+    };\n+\n+    /** Index from the parents' COutPoint into the m_orphans. Used\n+     *  to remove orphan transactions from the m_orphans */\n+    std::map<COutPoint, std::set<OrphanMap::iterator, IteratorComparator>> m_outpoint_to_orphan_it GUARDED_BY(g_cs_orphans);\n+\n+    /** Orphan transactions in vector for quick random eviction */\n+    std::vector<OrphanMap::iterator> m_orphan_list GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r584999313",
      "id" : 584999313,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk5OTMxMw==",
      "original_commit_id" : "eeeafb324ef6057f40b5c5fdd8464110e809b0f7",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 78,
      "pull_request_review_id" : 598586736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584999313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585004118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585004118"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Question: This data structure doesn't seem entirely necessary to me... Would it be better to just have `HaveTx` search for the tx in `m_orphans` using `std::find_if()` and a predicate like `[&, uint256 wtxid](OrphanTx& orphan) { return orphan.tx->GetWitnessHash() == wtxid }` ?",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-01T19:50:38Z",
      "diff_hunk" : "@@ -0,0 +1,80 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans included in / invalidated by a new block */\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Limit the orphanage to the given maximum */\n+    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Add any orphans that list a particular tx as a parent into a peer's work set\n+     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n+    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+protected:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;\n+        size_t list_pos;\n+    };\n+\n+    /** Map from txid to orphan transaction record. Limited by\n+     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n+    std::map<uint256, OrphanTx> m_orphans GUARDED_BY(g_cs_orphans);\n+\n+    using OrphanMap = decltype(m_orphans);\n+\n+    struct IteratorComparator\n+    {\n+        template<typename I>\n+        bool operator()(const I& a, const I& b) const\n+        {\n+            return &(*a) < &(*b);\n+        }\n+    };\n+\n+    /** Index from the parents' COutPoint into the m_orphans. Used\n+     *  to remove orphan transactions from the m_orphans */\n+    std::map<COutPoint, std::set<OrphanMap::iterator, IteratorComparator>> m_outpoint_to_orphan_it GUARDED_BY(g_cs_orphans);\n+\n+    /** Orphan transactions in vector for quick random eviction */\n+    std::vector<OrphanMap::iterator> m_orphan_list GUARDED_BY(g_cs_orphans);\n+\n+    /** Index from wtxid into the m_orphans to lookup orphan\n+     *  transactions using their witness ids. */\n+    std::map<uint256, OrphanMap::iterator> m_wtxid_to_orphan_it GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585004118",
      "id" : 585004118,
      "line" : 82,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTAwNDExOA==",
      "original_commit_id" : "eeeafb324ef6057f40b5c5fdd8464110e809b0f7",
      "original_line" : 77,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 82,
      "pull_request_review_id" : 598586736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585004118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585027396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585027396"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Technically not guaranteed to be orphans? I think adding a bit more overall context could help someone looking at orphan handling for the first time (was the case for me)\r\n```suggestion\r\n/** A class to temporarily track transactions we believe to be orphans (failed on TX_MISSING_INPUTS)\r\n* while we request the missing parent(s). Since we cannot distinguish orphans from bad transactions\r\n* with nonexistent inputs, we limit orphan count, size, and duration we'll keep them around for.\r\n```\r\n\r\n",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-01T20:29:02Z",
      "diff_hunk" : "@@ -0,0 +1,80 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585027396",
      "id" : 585027396,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTAyNzM5Ng==",
      "original_commit_id" : "eeeafb324ef6057f40b5c5fdd8464110e809b0f7",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 598586736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585027396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585166595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585166595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit 38a11c355acfc15134c682571b3d92f66b0e7c3c, âtxorphanage: Add lock annotationsâ \r\n\r\nIs the main advantage of moving where we grab `g_cs_orphans` from `EraseOrphansFor` into the call site in `FinalizeNode` to allow for the clang safety annotations / dynamic `AssertLockHeld` check? Since my understanding is that `FinalizeNode` is sometimes called with `g_cs_orphans` already held, so this doesn't seem to reduce the recursive locking. ",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T00:58:02Z",
      "diff_hunk" : "@@ -1003,7 +1003,7 @@ void PeerManagerImpl::FinalizeNode(const CNode& node, bool& fUpdateConnectionTim\n     for (const QueuedBlock& entry : state->vBlocksInFlight) {\n         mapBlocksInFlight.erase(entry.hash);\n     }\n-    EraseOrphansFor(nodeid);\n+    WITH_LOCK(g_cs_orphans, EraseOrphansFor(nodeid));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585166595",
      "id" : 585166595,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTE2NjU5NQ==",
      "original_commit_id" : "38a11c355acfc15134c682571b3d92f66b0e7c3c",
      "original_line" : 1006,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 601311887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585166595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585180763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585180763"
         }
      },
      "author_association" : "MEMBER",
      "body" : "aw yeah, that structure binding â¨",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T01:31:19Z",
      "diff_hunk" : "@@ -2104,10 +2104,9 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n         const uint256 orphanHash = *orphan_work_set.begin();\n         orphan_work_set.erase(orphan_work_set.begin());\n \n-        auto orphan_it = mapOrphanTransactions.find(orphanHash);\n-        if (orphan_it == mapOrphanTransactions.end()) continue;\n+        const auto [porphanTx, from_peer] = GetOrphanTx(orphanHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585180763",
      "id" : 585180763,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTE4MDc2Mw==",
      "original_commit_id" : "f294da727413210fda279afdc206a4dd12046d56",
      "original_line" : 2107,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 601311887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585180763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585196203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585196203"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there a reason `peer` here and `AddTx`, `EraseForPeer` are non-const? I think they can be but since most things in this header are constified & it's consistently the `peer NodeId` that's not, I'm wondering if I'm missing something.\r\n\r\nAlso, I like the const member functions, that's awesome for communicating/enforcing the intention of the functions. ",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T02:13:43Z",
      "diff_hunk" : "@@ -13,30 +13,48 @@\n /** Guards orphan transactions and extra txs for compact blocks */\n extern RecursiveMutex g_cs_orphans;\n \n-struct COrphanTx {\n-    // When modifying, adapt the copy of this definition in tests/DoS_tests.\n-    CTransactionRef tx;\n-    NodeId fromPeer;\n-    int64_t nTimeExpire;\n-    size_t list_pos;\n-};\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-int EraseOrphanTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-void EraseOrphansFor(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-void EraseOrphansForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n-unsigned int LimitOrphanTxSize(unsigned int nMaxOrphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-bool HaveOrphanTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n-std::pair<CTransactionRef, NodeId> GetOrphanTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-bool OrphanageAddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-/** Map from txid to orphan transaction record. Limited by\n- *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n-extern std::map<uint256, COrphanTx> mapOrphanTransactions GUARDED_BY(g_cs_orphans);\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585196203",
      "id" : 585196203,
      "line" : 38,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTE5NjIwMw==",
      "original_commit_id" : "6bd4963c069bfd0af420e8a3fb724c3b693a1e76",
      "original_line" : 33,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 38,
      "pull_request_review_id" : 601311887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585196203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585203876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585203876"
         }
      },
      "author_association" : "MEMBER",
      "body" : "hmm, it seems like a tradeoff between memory & runtime complexity. the `HaveTx` lookup is currently logarithmic, but using a `find_if` would be linear. I'm guessing opting for the additional data structure was chosen to minimize the runtime impact on the program since we call this function so frequently (at least.. for every txid in inv messages, before we send a getdata, when processing a tx)",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T02:36:45Z",
      "diff_hunk" : "@@ -0,0 +1,80 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Erase all orphans included in / invalidated by a new block */\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Limit the orphanage to the given maximum */\n+    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Add any orphans that list a particular tx as a parent into a peer's work set\n+     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n+    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+protected:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;\n+        size_t list_pos;\n+    };\n+\n+    /** Map from txid to orphan transaction record. Limited by\n+     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n+    std::map<uint256, OrphanTx> m_orphans GUARDED_BY(g_cs_orphans);\n+\n+    using OrphanMap = decltype(m_orphans);\n+\n+    struct IteratorComparator\n+    {\n+        template<typename I>\n+        bool operator()(const I& a, const I& b) const\n+        {\n+            return &(*a) < &(*b);\n+        }\n+    };\n+\n+    /** Index from the parents' COutPoint into the m_orphans. Used\n+     *  to remove orphan transactions from the m_orphans */\n+    std::map<COutPoint, std::set<OrphanMap::iterator, IteratorComparator>> m_outpoint_to_orphan_it GUARDED_BY(g_cs_orphans);\n+\n+    /** Orphan transactions in vector for quick random eviction */\n+    std::vector<OrphanMap::iterator> m_orphan_list GUARDED_BY(g_cs_orphans);\n+\n+    /** Index from wtxid into the m_orphans to lookup orphan\n+     *  transactions using their witness ids. */\n+    std::map<uint256, OrphanMap::iterator> m_wtxid_to_orphan_it GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585203876",
      "id" : 585203876,
      "in_reply_to_id" : 585004118,
      "line" : 82,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTIwMzg3Ng==",
      "original_commit_id" : "eeeafb324ef6057f40b5c5fdd8464110e809b0f7",
      "original_line" : 77,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 82,
      "pull_request_review_id" : 601311887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585203876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585207010"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585207010"
         }
      },
      "author_association" : "MEMBER",
      "body" : "+1 came here to make a very similar suggestion :) ",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T02:45:44Z",
      "diff_hunk" : "@@ -3330,11 +3141,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 m_txrequest.ForgetTxHash(tx.GetHash());\n                 m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n \n-                // DoS prevention: do not allow mapOrphanTransactions to grow unbounded (see CVE-2012-3789)\n+                // DoS prevention: do not allow m_orphanage to grow unbounded (see CVE-2012-3789)\n                 unsigned int nMaxOrphanTx = (unsigned int)std::max((int64_t)0, gArgs.GetArg(\"-maxorphantx\", DEFAULT_MAX_ORPHAN_TRANSACTIONS));\n-                unsigned int nEvicted = LimitOrphanTxSize(nMaxOrphanTx);\n+                unsigned int nEvicted = m_orphanage.LimitOrphans(nMaxOrphanTx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585207010",
      "id" : 585207010,
      "in_reply_to_id" : 582771389,
      "line" : 3129,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTIwNzAxMA==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 3129,
      "original_position" : 394,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 391,
      "pull_request_review_id" : 601311887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585207010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585212013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585212013"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Woah! I forgot we got that with C++17.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T03:00:15Z",
      "diff_hunk" : "@@ -2104,10 +2104,9 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n         const uint256 orphanHash = *orphan_work_set.begin();\n         orphan_work_set.erase(orphan_work_set.begin());\n \n-        auto orphan_it = mapOrphanTransactions.find(orphanHash);\n-        if (orphan_it == mapOrphanTransactions.end()) continue;\n+        const auto [porphanTx, from_peer] = GetOrphanTx(orphanHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585212013",
      "id" : 585212013,
      "in_reply_to_id" : 585180763,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTIxMjAxMw==",
      "original_commit_id" : "f294da727413210fda279afdc206a4dd12046d56",
      "original_line" : 2107,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 601363657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585212013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585379261"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585379261"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The `CTransactionRef tx` could be const as well; the only entry that changes after insertion is `list_pos`. Not sure there's much benefit to adding the const annotations for that though.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T08:59:07Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    struct OrphanTx {\n+        CTransactionRef tx;\n+        NodeId fromPeer;\n+        int64_t nTimeExpire;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585379261",
      "id" : 585379261,
      "in_reply_to_id" : 582850158,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTM3OTI2MQ==",
      "original_commit_id" : "649cad4fc8fcc107a02a5e448cf9495d38e18add",
      "original_line" : 22,
      "original_position" : 22,
      "original_start_line" : 21,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 601575094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585379261",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585403627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585403627"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "denialofservice_tests locks `g_cs_orphans` then calls `EraseOrphansFor`, so it would have required more changes to have `EraseOrphansFor` do the locking.\r\n\r\nI don't think `FinalizeNode` is called from anywhere that holds `g_cs_orphans`? Am I missing somewhere?",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T09:31:25Z",
      "diff_hunk" : "@@ -1003,7 +1003,7 @@ void PeerManagerImpl::FinalizeNode(const CNode& node, bool& fUpdateConnectionTim\n     for (const QueuedBlock& entry : state->vBlocksInFlight) {\n         mapBlocksInFlight.erase(entry.hash);\n     }\n-    EraseOrphansFor(nodeid);\n+    WITH_LOCK(g_cs_orphans, EraseOrphansFor(nodeid));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585403627",
      "id" : 585403627,
      "in_reply_to_id" : 585166595,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTQwMzYyNw==",
      "original_commit_id" : "38a11c355acfc15134c682571b3d92f66b0e7c3c",
      "original_line" : 1006,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 601607647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585403627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585406986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585406986"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't usually add `const` to arguments that are passed by vaue rather than reference -- it makes no difference to the caller; and not much difference to the implementation.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T09:35:51Z",
      "diff_hunk" : "@@ -13,30 +13,48 @@\n /** Guards orphan transactions and extra txs for compact blocks */\n extern RecursiveMutex g_cs_orphans;\n \n-struct COrphanTx {\n-    // When modifying, adapt the copy of this definition in tests/DoS_tests.\n-    CTransactionRef tx;\n-    NodeId fromPeer;\n-    int64_t nTimeExpire;\n-    size_t list_pos;\n-};\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-int EraseOrphanTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-void EraseOrphansFor(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-void EraseOrphansForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n-unsigned int LimitOrphanTxSize(unsigned int nMaxOrphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-bool HaveOrphanTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n-std::pair<CTransactionRef, NodeId> GetOrphanTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-bool OrphanageAddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-/** Map from txid to orphan transaction record. Limited by\n- *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n-extern std::map<uint256, COrphanTx> mapOrphanTransactions GUARDED_BY(g_cs_orphans);\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585406986",
      "id" : 585406986,
      "in_reply_to_id" : 585196203,
      "line" : 38,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTQwNjk4Ng==",
      "original_commit_id" : "6bd4963c069bfd0af420e8a3fb724c3b693a1e76",
      "original_line" : 33,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 38,
      "pull_request_review_id" : 601612135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T09:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585406986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added a commit to update comments with suggestions.\r\n\r\n@jnewbery yeah, other commit could have been dropped -- it was only there to move `AddOrphan` into `PeerManagerImpl` so that `m_orphanage` could also be in `PeerManagerImpl`, but that stopped being an issue after doing away with net_processing's `AddOrphan` -- but should be pretty harmless to leave it there.",
      "created_at" : "2021-03-02T09:43:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-788772866",
      "id" : 788772866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4ODc3Mjg2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T09:43:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/788772866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 5e50e2d1b9",
      "created_at" : "2021-03-02T11:37:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-788844262",
      "id" : 788844262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4ODg0NDI2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T11:37:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/788844262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585492464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585492464"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Here: https://github.com/bitcoin/bitcoin/blob/b9f41df1ead4b6a83a51fc41966b111c8459c313/src/init.cpp#L213-L214 ?",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T11:39:27Z",
      "diff_hunk" : "@@ -1003,7 +1003,7 @@ void PeerManagerImpl::FinalizeNode(const CNode& node, bool& fUpdateConnectionTim\n     for (const QueuedBlock& entry : state->vBlocksInFlight) {\n         mapBlocksInFlight.erase(entry.hash);\n     }\n-    EraseOrphansFor(nodeid);\n+    WITH_LOCK(g_cs_orphans, EraseOrphansFor(nodeid));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585492464",
      "id" : 585492464,
      "in_reply_to_id" : 585166595,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTQ5MjQ2NA==",
      "original_commit_id" : "38a11c355acfc15134c682571b3d92f66b0e7c3c",
      "original_line" : 1006,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 601721779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T11:39:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585492464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585566739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585566739"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, that's it!\r\n\r\nStopNodes() calls DeleteNode() calls FinalizeNode() calls EraseForPeer(); with EraseForPeer needing `g_cs_orphans`. StopNodes locks `cs_vNodes` before calling DeleteNode, so `g_cs_orphans` has to be locked before calling CConnman::StopNodes but only if it's linked to a PeerManagerImpl.\r\n\r\nStopNodes is also called from `~CConnman` so that path will still get a lock order violation error, I think.\r\n\r\nDeleteNode is also called from DisconnectNodes which is called from ThreadSocketHandler; but there it's called after `cs_vNodes` is released, so lock ordering is not an issue, but `g_cs_orphans` still has to get locked prior to doing the work in EraseForPeer, so responsibility can't be moved all the way back up the chain. \r\n\r\nSo I don't think there's a simple way to make it non-recursive for this PR; for a future PR, I think the aim is to make `g_cs_orphans` become `private: TxOrphanage::m_mutex` and not have it be the last thing locked / first thing released so that the ordering constraint goes away, and then it should trivially be non-recursive.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T13:33:06Z",
      "diff_hunk" : "@@ -1003,7 +1003,7 @@ void PeerManagerImpl::FinalizeNode(const CNode& node, bool& fUpdateConnectionTim\n     for (const QueuedBlock& entry : state->vBlocksInFlight) {\n         mapBlocksInFlight.erase(entry.hash);\n     }\n-    EraseOrphansFor(nodeid);\n+    WITH_LOCK(g_cs_orphans, EraseOrphansFor(nodeid));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585566739",
      "id" : 585566739,
      "in_reply_to_id" : 585166595,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTU2NjczOQ==",
      "original_commit_id" : "38a11c355acfc15134c682571b3d92f66b0e7c3c",
      "original_line" : 1006,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 601817102,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T13:33:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585566739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585616200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585616200"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> for a future PR, I think the aim is to make g_cs_orphans become private: TxOrphanage::m_mutex and not have it be the last thing locked / first thing released so that the ordering constraint goes away, and then it should trivially be non-recursive.\r\n\r\nConcept ACK :)",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T14:35:23Z",
      "diff_hunk" : "@@ -1003,7 +1003,7 @@ void PeerManagerImpl::FinalizeNode(const CNode& node, bool& fUpdateConnectionTim\n     for (const QueuedBlock& entry : state->vBlocksInFlight) {\n         mapBlocksInFlight.erase(entry.hash);\n     }\n-    EraseOrphansFor(nodeid);\n+    WITH_LOCK(g_cs_orphans, EraseOrphansFor(nodeid));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585616200",
      "id" : 585616200,
      "in_reply_to_id" : 585166595,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTYxNjIwMA==",
      "original_commit_id" : "38a11c355acfc15134c682571b3d92f66b0e7c3c",
      "original_line" : 1006,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 601883605,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T14:35:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585616200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585725021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585725021"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/ajtowns/bitcoin/commits/202102-orphanworkset has work-in-progress that turns g_cs_orphans a protected m_mutex, doesn't quite turn orphans back into the responsibility of who sent them rather than who sent their final parent though.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T16:39:23Z",
      "diff_hunk" : "@@ -1003,7 +1003,7 @@ void PeerManagerImpl::FinalizeNode(const CNode& node, bool& fUpdateConnectionTim\n     for (const QueuedBlock& entry : state->vBlocksInFlight) {\n         mapBlocksInFlight.erase(entry.hash);\n     }\n-    EraseOrphansFor(nodeid);\n+    WITH_LOCK(g_cs_orphans, EraseOrphansFor(nodeid));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585725021",
      "id" : 585725021,
      "in_reply_to_id" : 585166595,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTcyNTAyMQ==",
      "original_commit_id" : "38a11c355acfc15134c682571b3d92f66b0e7c3c",
      "original_line" : 1006,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 602028779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T16:39:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585725021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585870278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585870278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah, right. thanks ",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-02T20:03:10Z",
      "diff_hunk" : "@@ -13,30 +13,48 @@\n /** Guards orphan transactions and extra txs for compact blocks */\n extern RecursiveMutex g_cs_orphans;\n \n-struct COrphanTx {\n-    // When modifying, adapt the copy of this definition in tests/DoS_tests.\n-    CTransactionRef tx;\n-    NodeId fromPeer;\n-    int64_t nTimeExpire;\n-    size_t list_pos;\n-};\n+/** Data structure to keep track of orphan transactions\n+ */\n+class TxOrphanage {\n+public:\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get the details of an orphan transaction (returns nullptr if not found) */\n+    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-int EraseOrphanTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-void EraseOrphansFor(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-void EraseOrphansForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n-unsigned int LimitOrphanTxSize(unsigned int nMaxOrphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-bool HaveOrphanTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n-std::pair<CTransactionRef, NodeId> GetOrphanTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n-bool OrphanageAddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Erase an orphan by txid */\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-/** Map from txid to orphan transaction record. Limited by\n- *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n-extern std::map<uint256, COrphanTx> mapOrphanTransactions GUARDED_BY(g_cs_orphans);\n+    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r585870278",
      "id" : 585870278,
      "in_reply_to_id" : 585196203,
      "line" : 38,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTg3MDI3OA==",
      "original_commit_id" : "6bd4963c069bfd0af420e8a3fb724c3b693a1e76",
      "original_line" : 33,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 38,
      "pull_request_review_id" : 602215084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-02T20:03:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585870278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8 ",
      "created_at" : "2021-03-02T20:04:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-789177849",
      "id" : 789177849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4OTE3Nzg0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T20:04:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/789177849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re ACK https://github.com/bitcoin/bitcoin/pull/21148/commits/5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8, comment updates",
      "created_at" : "2021-03-02T23:47:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-789306761",
      "id" : 789306761,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4OTMwNjc2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T23:47:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/789306761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> the orphanage is v. beautiful! my least favorite thing about it is the two-line if statements without parenthesis (they were copied over in move-only commits), but I'll survive :)\r\n\r\nYes I like how this cleanly encapsulates the transaction orphan handling, exposing a single documented interface in a small header file.\r\n\r\nIt is clearly an improvement. The only thing I don't completely understand is why the `g_cs_orphans` lock is global and not on the orphanage itself, but maybe that's too much impact? I think lock refactoring could be a topic for a future PR, anyhow, no need to hold this up.\r\n\r\nCode review ACK 5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-04T09:16:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-790460791",
      "id" : 790460791,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDQ2MDc5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T09:16:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790460791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  The only thing I don't completely understand is why the g_cs_orphans lock is global and not on the orphanage itself, but maybe that's too much impact?\r\n\r\n`g_cs_orphans` is still used to guard some objects outside the orphange (`Peer.m_orphan_work_set` and `vExtraTxnForCompact`). The plan is for future PRs to remove those dependencies and make the orphan mutex a member of the orphanage.",
      "created_at" : "2021-03-04T10:13:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-790499978",
      "id" : 790499978,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDQ5OTk3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T10:13:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790499978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery Good to know, thanks!",
      "created_at" : "2021-03-04T12:08:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-790572101",
      "id" : 790572101,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDU3MjEwMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T12:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790572101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r587522262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587522262"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Let's say an attacker sends an invalid orphan Z to Alice. Such orphan will be stored\r\nin `m_orphans` until expiration time, random eviction or parent reception. Another honest\r\npeer Bob announce Z's parent and Z through txid-relay to Alice. Announcement for Z from Bob\r\nwon't be scheduled for request by `AddTxAnnouncement()` as it'll be bounced off before\r\ndue to a positive `AlreadyHaveTx()`.\r\n\r\nIf Bob sends a valid Z's parent, it should be accepted but Alice's version of Z will be\r\nrejected as invalid. Assuming Bob is initial broadcaster of Z and same trick is repeated\r\nagainst all his tx-relay peers, Z won't propagate until next Bob rebroadcast.\r\n\r\nIs the following description correct ? If yes, I don't think that's concerning, assuming Bob\r\nrebroadcast frequency is pretty high (which is the case for time-sensitive Bitcoin\r\napplications).\r\n\r\nThough not introduced by this PR.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-04T14:37:28Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txorphanage.h>\n+\n+#include <consensus/validation.h>\n+#include <logging.h>\n+#include <policy/policy.h>\n+\n+#include <cassert>\n+\n+/** Expiration time for orphan transactions in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_TIME = 20 * 60;\n+/** Minimum time between orphan transactions expire time checks in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_INTERVAL = 5 * 60;\n+\n+RecursiveMutex g_cs_orphans;\n+\n+bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    const uint256& hash = tx->GetHash();\n+    if (m_orphans.count(hash))\n+        return false;\n+\n+    // Ignore big transactions, to avoid a\n+    // send-big-orphans memory exhaustion attack. If a peer has a legitimate\n+    // large transaction with a missing parent then we assume\n+    // it will rebroadcast it later, after the parent transaction(s)\n+    // have been mined or received.\n+    // 100 orphans, each of which is at most 100,000 bytes big is\n+    // at most 10 megabytes of orphans and somewhat more byprev index (in the worst case):\n+    unsigned int sz = GetTransactionWeight(*tx);\n+    if (sz > MAX_STANDARD_TX_WEIGHT)\n+    {\n+        LogPrint(BCLog::MEMPOOL, \"ignoring large orphan tx (size: %u, hash: %s)\\n\", sz, hash.ToString());\n+        return false;\n+    }\n+\n+    auto ret = m_orphans.emplace(hash, OrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, m_orphan_list.size()});\n+    assert(ret.second);\n+    m_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    m_wtxid_to_orphan_it.emplace(tx->GetWitnessHash(), ret.first);\n+    for (const CTxIn& txin : tx->vin) {\n+        m_outpoint_to_orphan_it[txin.prevout].insert(ret.first);\n+    }\n+\n+    LogPrint(BCLog::MEMPOOL, \"stored orphan tx %s (mapsz %u outsz %u)\\n\", hash.ToString(),\n+             m_orphans.size(), m_outpoint_to_orphan_it.size());\n+    return true;\n+}\n+\n+int TxOrphanage::EraseTx(const uint256& txid)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    std::map<uint256, OrphanTx>::iterator it = m_orphans.find(txid);\n+    if (it == m_orphans.end())\n+        return 0;\n+    for (const CTxIn& txin : it->second.tx->vin)\n+    {\n+        auto itPrev = m_outpoint_to_orphan_it.find(txin.prevout);\n+        if (itPrev == m_outpoint_to_orphan_it.end())\n+            continue;\n+        itPrev->second.erase(it);\n+        if (itPrev->second.empty())\n+            m_outpoint_to_orphan_it.erase(itPrev);\n+    }\n+\n+    size_t old_pos = it->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it);\n+    if (old_pos + 1 != m_orphan_list.size()) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    m_wtxid_to_orphan_it.erase(it->second.tx->GetWitnessHash());\n+\n+    m_orphans.erase(it);\n+    return 1;\n+}\n+\n+void TxOrphanage::EraseForPeer(NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    int nErased = 0;\n+    std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+    while (iter != m_orphans.end())\n+    {\n+        std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        if (maybeErase->second.fromPeer == peer)\n+        {\n+            nErased += EraseTx(maybeErase->second.tx->GetHash());\n+        }\n+    }\n+    if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+}\n+\n+unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    unsigned int nEvicted = 0;\n+    static int64_t nNextSweep;\n+    int64_t nNow = GetTime();\n+    if (nNextSweep <= nNow) {\n+        // Sweep out expired orphan pool entries:\n+        int nErased = 0;\n+        int64_t nMinExpTime = nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL;\n+        std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+        while (iter != m_orphans.end())\n+        {\n+            std::map<uint256, OrphanTx>::iterator maybeErase = iter++;\n+            if (maybeErase->second.nTimeExpire <= nNow) {\n+                nErased += EraseTx(maybeErase->second.tx->GetHash());\n+            } else {\n+                nMinExpTime = std::min(maybeErase->second.nTimeExpire, nMinExpTime);\n+            }\n+        }\n+        // Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.\n+        nNextSweep = nMinExpTime + ORPHAN_TX_EXPIRE_INTERVAL;\n+        if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx due to expiration\\n\", nErased);\n+    }\n+    FastRandomContext rng;\n+    while (m_orphans.size() > max_orphans)\n+    {\n+        // Evict a random orphan:\n+        size_t randompos = rng.randrange(m_orphan_list.size());\n+        EraseTx(m_orphan_list[randompos]->first);\n+        ++nEvicted;\n+    }\n+    return nEvicted;\n+}\n+\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    for (unsigned int i = 0; i < tx.vout.size(); i++) {\n+        const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n+        if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n+            for (const auto& elem : it_by_prev->second) {\n+                orphan_work_set.insert(elem->first);\n+            }\n+        }\n+    }\n+}\n+\n+bool TxOrphanage::HaveTx(const GenTxid& gtxid) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r587522262",
      "id" : 587522262,
      "line" : 154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzUyMjI2Mg==",
      "original_commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "original_line" : 154,
      "original_position" : 154,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 154,
      "pull_request_review_id" : 604169093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-04T15:21:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587522262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r587536050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587536050"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Couldn't the \"orphanage overflow\" log L3131 in net_processing be moved here instead of returning `nEvicted` ? And change the message to dissociate clearly expiration-from-eviction.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-04T14:54:04Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txorphanage.h>\n+\n+#include <consensus/validation.h>\n+#include <logging.h>\n+#include <policy/policy.h>\n+\n+#include <cassert>\n+\n+/** Expiration time for orphan transactions in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_TIME = 20 * 60;\n+/** Minimum time between orphan transactions expire time checks in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_INTERVAL = 5 * 60;\n+\n+RecursiveMutex g_cs_orphans;\n+\n+bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    const uint256& hash = tx->GetHash();\n+    if (m_orphans.count(hash))\n+        return false;\n+\n+    // Ignore big transactions, to avoid a\n+    // send-big-orphans memory exhaustion attack. If a peer has a legitimate\n+    // large transaction with a missing parent then we assume\n+    // it will rebroadcast it later, after the parent transaction(s)\n+    // have been mined or received.\n+    // 100 orphans, each of which is at most 100,000 bytes big is\n+    // at most 10 megabytes of orphans and somewhat more byprev index (in the worst case):\n+    unsigned int sz = GetTransactionWeight(*tx);\n+    if (sz > MAX_STANDARD_TX_WEIGHT)\n+    {\n+        LogPrint(BCLog::MEMPOOL, \"ignoring large orphan tx (size: %u, hash: %s)\\n\", sz, hash.ToString());\n+        return false;\n+    }\n+\n+    auto ret = m_orphans.emplace(hash, OrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, m_orphan_list.size()});\n+    assert(ret.second);\n+    m_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    m_wtxid_to_orphan_it.emplace(tx->GetWitnessHash(), ret.first);\n+    for (const CTxIn& txin : tx->vin) {\n+        m_outpoint_to_orphan_it[txin.prevout].insert(ret.first);\n+    }\n+\n+    LogPrint(BCLog::MEMPOOL, \"stored orphan tx %s (mapsz %u outsz %u)\\n\", hash.ToString(),\n+             m_orphans.size(), m_outpoint_to_orphan_it.size());\n+    return true;\n+}\n+\n+int TxOrphanage::EraseTx(const uint256& txid)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    std::map<uint256, OrphanTx>::iterator it = m_orphans.find(txid);\n+    if (it == m_orphans.end())\n+        return 0;\n+    for (const CTxIn& txin : it->second.tx->vin)\n+    {\n+        auto itPrev = m_outpoint_to_orphan_it.find(txin.prevout);\n+        if (itPrev == m_outpoint_to_orphan_it.end())\n+            continue;\n+        itPrev->second.erase(it);\n+        if (itPrev->second.empty())\n+            m_outpoint_to_orphan_it.erase(itPrev);\n+    }\n+\n+    size_t old_pos = it->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it);\n+    if (old_pos + 1 != m_orphan_list.size()) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    m_wtxid_to_orphan_it.erase(it->second.tx->GetWitnessHash());\n+\n+    m_orphans.erase(it);\n+    return 1;\n+}\n+\n+void TxOrphanage::EraseForPeer(NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    int nErased = 0;\n+    std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+    while (iter != m_orphans.end())\n+    {\n+        std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        if (maybeErase->second.fromPeer == peer)\n+        {\n+            nErased += EraseTx(maybeErase->second.tx->GetHash());\n+        }\n+    }\n+    if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+}\n+\n+unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    unsigned int nEvicted = 0;\n+    static int64_t nNextSweep;\n+    int64_t nNow = GetTime();\n+    if (nNextSweep <= nNow) {\n+        // Sweep out expired orphan pool entries:\n+        int nErased = 0;\n+        int64_t nMinExpTime = nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL;\n+        std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+        while (iter != m_orphans.end())\n+        {\n+            std::map<uint256, OrphanTx>::iterator maybeErase = iter++;\n+            if (maybeErase->second.nTimeExpire <= nNow) {\n+                nErased += EraseTx(maybeErase->second.tx->GetHash());\n+            } else {\n+                nMinExpTime = std::min(maybeErase->second.nTimeExpire, nMinExpTime);\n+            }\n+        }\n+        // Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.\n+        nNextSweep = nMinExpTime + ORPHAN_TX_EXPIRE_INTERVAL;\n+        if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx due to expiration\\n\", nErased);\n+    }\n+    FastRandomContext rng;\n+    while (m_orphans.size() > max_orphans)\n+    {\n+        // Evict a random orphan:\n+        size_t randompos = rng.randrange(m_orphan_list.size());\n+        EraseTx(m_orphan_list[randompos]->first);\n+        ++nEvicted;\n+    }\n+    return nEvicted;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r587536050",
      "id" : 587536050,
      "line" : 138,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzUzNjA1MA==",
      "original_commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "original_line" : 138,
      "original_position" : 138,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 138,
      "pull_request_review_id" : 604169093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-04T15:21:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587536050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r587547275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587547275"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If we had a `std::map<uint256, OrphanMap::iterator> m_parentid_to_orphan_it` index we could update each peer's `orphan_work_set` in function of the parent received through this block. \r\n\r\nOtherwise, I think you might have stalling valid orphans never re-processed. Any ulterior parent announcement should be bounce off by `m_recent_confirmed_transactions`. Though rare enough to not be worthy of the complexity...",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-04T15:06:40Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txorphanage.h>\n+\n+#include <consensus/validation.h>\n+#include <logging.h>\n+#include <policy/policy.h>\n+\n+#include <cassert>\n+\n+/** Expiration time for orphan transactions in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_TIME = 20 * 60;\n+/** Minimum time between orphan transactions expire time checks in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_INTERVAL = 5 * 60;\n+\n+RecursiveMutex g_cs_orphans;\n+\n+bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    const uint256& hash = tx->GetHash();\n+    if (m_orphans.count(hash))\n+        return false;\n+\n+    // Ignore big transactions, to avoid a\n+    // send-big-orphans memory exhaustion attack. If a peer has a legitimate\n+    // large transaction with a missing parent then we assume\n+    // it will rebroadcast it later, after the parent transaction(s)\n+    // have been mined or received.\n+    // 100 orphans, each of which is at most 100,000 bytes big is\n+    // at most 10 megabytes of orphans and somewhat more byprev index (in the worst case):\n+    unsigned int sz = GetTransactionWeight(*tx);\n+    if (sz > MAX_STANDARD_TX_WEIGHT)\n+    {\n+        LogPrint(BCLog::MEMPOOL, \"ignoring large orphan tx (size: %u, hash: %s)\\n\", sz, hash.ToString());\n+        return false;\n+    }\n+\n+    auto ret = m_orphans.emplace(hash, OrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, m_orphan_list.size()});\n+    assert(ret.second);\n+    m_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    m_wtxid_to_orphan_it.emplace(tx->GetWitnessHash(), ret.first);\n+    for (const CTxIn& txin : tx->vin) {\n+        m_outpoint_to_orphan_it[txin.prevout].insert(ret.first);\n+    }\n+\n+    LogPrint(BCLog::MEMPOOL, \"stored orphan tx %s (mapsz %u outsz %u)\\n\", hash.ToString(),\n+             m_orphans.size(), m_outpoint_to_orphan_it.size());\n+    return true;\n+}\n+\n+int TxOrphanage::EraseTx(const uint256& txid)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    std::map<uint256, OrphanTx>::iterator it = m_orphans.find(txid);\n+    if (it == m_orphans.end())\n+        return 0;\n+    for (const CTxIn& txin : it->second.tx->vin)\n+    {\n+        auto itPrev = m_outpoint_to_orphan_it.find(txin.prevout);\n+        if (itPrev == m_outpoint_to_orphan_it.end())\n+            continue;\n+        itPrev->second.erase(it);\n+        if (itPrev->second.empty())\n+            m_outpoint_to_orphan_it.erase(itPrev);\n+    }\n+\n+    size_t old_pos = it->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it);\n+    if (old_pos + 1 != m_orphan_list.size()) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    m_wtxid_to_orphan_it.erase(it->second.tx->GetWitnessHash());\n+\n+    m_orphans.erase(it);\n+    return 1;\n+}\n+\n+void TxOrphanage::EraseForPeer(NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    int nErased = 0;\n+    std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+    while (iter != m_orphans.end())\n+    {\n+        std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        if (maybeErase->second.fromPeer == peer)\n+        {\n+            nErased += EraseTx(maybeErase->second.tx->GetHash());\n+        }\n+    }\n+    if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+}\n+\n+unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    unsigned int nEvicted = 0;\n+    static int64_t nNextSweep;\n+    int64_t nNow = GetTime();\n+    if (nNextSweep <= nNow) {\n+        // Sweep out expired orphan pool entries:\n+        int nErased = 0;\n+        int64_t nMinExpTime = nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL;\n+        std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+        while (iter != m_orphans.end())\n+        {\n+            std::map<uint256, OrphanTx>::iterator maybeErase = iter++;\n+            if (maybeErase->second.nTimeExpire <= nNow) {\n+                nErased += EraseTx(maybeErase->second.tx->GetHash());\n+            } else {\n+                nMinExpTime = std::min(maybeErase->second.nTimeExpire, nMinExpTime);\n+            }\n+        }\n+        // Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.\n+        nNextSweep = nMinExpTime + ORPHAN_TX_EXPIRE_INTERVAL;\n+        if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx due to expiration\\n\", nErased);\n+    }\n+    FastRandomContext rng;\n+    while (m_orphans.size() > max_orphans)\n+    {\n+        // Evict a random orphan:\n+        size_t randompos = rng.randrange(m_orphan_list.size());\n+        EraseTx(m_orphan_list[randompos]->first);\n+        ++nEvicted;\n+    }\n+    return nEvicted;\n+}\n+\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    for (unsigned int i = 0; i < tx.vout.size(); i++) {\n+        const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n+        if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n+            for (const auto& elem : it_by_prev->second) {\n+                orphan_work_set.insert(elem->first);\n+            }\n+        }\n+    }\n+}\n+\n+bool TxOrphanage::HaveTx(const GenTxid& gtxid) const\n+{\n+    LOCK(g_cs_orphans);\n+    if (gtxid.IsWtxid()) {\n+        return m_wtxid_to_orphan_it.count(gtxid.GetHash());\n+    } else {\n+        return m_orphans.count(gtxid.GetHash());\n+    }\n+}\n+\n+std::pair<CTransactionRef, NodeId> TxOrphanage::GetTx(const uint256& txid) const\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    const auto it = m_orphans.find(txid);\n+    if (it == m_orphans.end()) return {nullptr, -1};\n+    return {it->second.tx, it->second.fromPeer};\n+}\n+\n+void TxOrphanage::EraseForBlock(const CBlock& block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r587547275",
      "id" : 587547275,
      "line" : 173,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzU0NzI3NQ==",
      "original_commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "original_line" : 173,
      "original_position" : 173,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 173,
      "pull_request_review_id" : 604169093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-04T15:21:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587547275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r587548092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587548092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: originating",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-04T15:07:34Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXORPHANAGE_H\n+#define BITCOIN_TXORPHANAGE_H\n+\n+#include <net.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <sync.h>\n+\n+/** Guards orphan transactions and extra txs for compact blocks */\n+extern RecursiveMutex g_cs_orphans;\n+\n+/** A class to track orphan transactions (failed on TX_MISSING_INPUTS)\n+ * Since we cannot distinguish orphans from bad transactions with\n+ * non-existent inputs, we heavily limit the number of orphans\n+ * we keep and the duration we keep them for.\n+ */\n+class TxOrphanage {\n+public:\n+    /** Add a new orphan transaction */\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+\n+    /** Check if we already have an orphan transaction (by txid or wtxid) */\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+\n+    /** Get an orphan transaction and its orginating peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r587548092",
      "id" : 587548092,
      "line" : 29,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzU0ODA5Mg==",
      "original_commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "original_line" : 29,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 29,
      "pull_request_review_id" : 604169093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-04T15:21:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587548092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "pm ACK",
      "created_at" : "2021-03-05T11:12:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#issuecomment-791352871",
      "id" : 791352871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21148",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTM1Mjg3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T11:12:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791352871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r588994829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588994829"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think what you're saying is: Bob has tx `P` (parent) and a child of that tx `C`. Mallory knows both and malleates the witness of `C` so that it creates a new invalid tx `X` that has the same txid as `C` but obviously a different wtxid. Mallory relays `X` to Alice before Alice hears about `P` or `C`. Alice adds `X` to the orphan pool and requests `P` from Mallory by wtxid.\r\n\r\nI think the expected behaviour is then: Carol announces both `P` and `C` to Alice; if wtxid relay is active, both are announced via wtxid so don't conflict with `X`, and both are requested. If the request for `P` from Mallory is still active, `C` will be requested first, and when we receive it, we'll see there's already an entry for that txid in the orphan pool and ignore it. I'm not sure if we'll re-request from other honest peers at that point in normal usage; though I think this is a case where #21061 would eventually save the day.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-07T08:40:07Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txorphanage.h>\n+\n+#include <consensus/validation.h>\n+#include <logging.h>\n+#include <policy/policy.h>\n+\n+#include <cassert>\n+\n+/** Expiration time for orphan transactions in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_TIME = 20 * 60;\n+/** Minimum time between orphan transactions expire time checks in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_INTERVAL = 5 * 60;\n+\n+RecursiveMutex g_cs_orphans;\n+\n+bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    const uint256& hash = tx->GetHash();\n+    if (m_orphans.count(hash))\n+        return false;\n+\n+    // Ignore big transactions, to avoid a\n+    // send-big-orphans memory exhaustion attack. If a peer has a legitimate\n+    // large transaction with a missing parent then we assume\n+    // it will rebroadcast it later, after the parent transaction(s)\n+    // have been mined or received.\n+    // 100 orphans, each of which is at most 100,000 bytes big is\n+    // at most 10 megabytes of orphans and somewhat more byprev index (in the worst case):\n+    unsigned int sz = GetTransactionWeight(*tx);\n+    if (sz > MAX_STANDARD_TX_WEIGHT)\n+    {\n+        LogPrint(BCLog::MEMPOOL, \"ignoring large orphan tx (size: %u, hash: %s)\\n\", sz, hash.ToString());\n+        return false;\n+    }\n+\n+    auto ret = m_orphans.emplace(hash, OrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, m_orphan_list.size()});\n+    assert(ret.second);\n+    m_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    m_wtxid_to_orphan_it.emplace(tx->GetWitnessHash(), ret.first);\n+    for (const CTxIn& txin : tx->vin) {\n+        m_outpoint_to_orphan_it[txin.prevout].insert(ret.first);\n+    }\n+\n+    LogPrint(BCLog::MEMPOOL, \"stored orphan tx %s (mapsz %u outsz %u)\\n\", hash.ToString(),\n+             m_orphans.size(), m_outpoint_to_orphan_it.size());\n+    return true;\n+}\n+\n+int TxOrphanage::EraseTx(const uint256& txid)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    std::map<uint256, OrphanTx>::iterator it = m_orphans.find(txid);\n+    if (it == m_orphans.end())\n+        return 0;\n+    for (const CTxIn& txin : it->second.tx->vin)\n+    {\n+        auto itPrev = m_outpoint_to_orphan_it.find(txin.prevout);\n+        if (itPrev == m_outpoint_to_orphan_it.end())\n+            continue;\n+        itPrev->second.erase(it);\n+        if (itPrev->second.empty())\n+            m_outpoint_to_orphan_it.erase(itPrev);\n+    }\n+\n+    size_t old_pos = it->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it);\n+    if (old_pos + 1 != m_orphan_list.size()) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    m_wtxid_to_orphan_it.erase(it->second.tx->GetWitnessHash());\n+\n+    m_orphans.erase(it);\n+    return 1;\n+}\n+\n+void TxOrphanage::EraseForPeer(NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    int nErased = 0;\n+    std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+    while (iter != m_orphans.end())\n+    {\n+        std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        if (maybeErase->second.fromPeer == peer)\n+        {\n+            nErased += EraseTx(maybeErase->second.tx->GetHash());\n+        }\n+    }\n+    if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+}\n+\n+unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    unsigned int nEvicted = 0;\n+    static int64_t nNextSweep;\n+    int64_t nNow = GetTime();\n+    if (nNextSweep <= nNow) {\n+        // Sweep out expired orphan pool entries:\n+        int nErased = 0;\n+        int64_t nMinExpTime = nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL;\n+        std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+        while (iter != m_orphans.end())\n+        {\n+            std::map<uint256, OrphanTx>::iterator maybeErase = iter++;\n+            if (maybeErase->second.nTimeExpire <= nNow) {\n+                nErased += EraseTx(maybeErase->second.tx->GetHash());\n+            } else {\n+                nMinExpTime = std::min(maybeErase->second.nTimeExpire, nMinExpTime);\n+            }\n+        }\n+        // Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.\n+        nNextSweep = nMinExpTime + ORPHAN_TX_EXPIRE_INTERVAL;\n+        if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx due to expiration\\n\", nErased);\n+    }\n+    FastRandomContext rng;\n+    while (m_orphans.size() > max_orphans)\n+    {\n+        // Evict a random orphan:\n+        size_t randompos = rng.randrange(m_orphan_list.size());\n+        EraseTx(m_orphan_list[randompos]->first);\n+        ++nEvicted;\n+    }\n+    return nEvicted;\n+}\n+\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    for (unsigned int i = 0; i < tx.vout.size(); i++) {\n+        const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n+        if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n+            for (const auto& elem : it_by_prev->second) {\n+                orphan_work_set.insert(elem->first);\n+            }\n+        }\n+    }\n+}\n+\n+bool TxOrphanage::HaveTx(const GenTxid& gtxid) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r588994829",
      "id" : 588994829,
      "in_reply_to_id" : 587522262,
      "line" : 154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODk5NDgyOQ==",
      "original_commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "original_line" : 154,
      "original_position" : 154,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 154,
      "pull_request_review_id" : 605821963,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-07T08:40:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588994829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r589393892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589393892"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I'm not sure if we'll re-request from other honest peers at that point in normal usage\r\n\r\nOnce the transaction is rejected from orphanage in reason of an already present orphan, we forget its txid/wtxid from tx-requester. So effectively, we shouldn't re-request it from other onest peers at that stage. Ultimately, parent `P` withhold by Mallory should expire, Alice will fetch a valid parent `P` from another peer. When Bob rebroadcasts `C`, Mallory isn't able to interfere anymore as malleated `X` will be rejected directly, without being logged in orphan pool.\r\n\r\nYes I agree #21061 should make things better.",
      "commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "created_at" : "2021-03-08T12:43:54Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txorphanage.h>\n+\n+#include <consensus/validation.h>\n+#include <logging.h>\n+#include <policy/policy.h>\n+\n+#include <cassert>\n+\n+/** Expiration time for orphan transactions in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_TIME = 20 * 60;\n+/** Minimum time between orphan transactions expire time checks in seconds */\n+static constexpr int64_t ORPHAN_TX_EXPIRE_INTERVAL = 5 * 60;\n+\n+RecursiveMutex g_cs_orphans;\n+\n+bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    const uint256& hash = tx->GetHash();\n+    if (m_orphans.count(hash))\n+        return false;\n+\n+    // Ignore big transactions, to avoid a\n+    // send-big-orphans memory exhaustion attack. If a peer has a legitimate\n+    // large transaction with a missing parent then we assume\n+    // it will rebroadcast it later, after the parent transaction(s)\n+    // have been mined or received.\n+    // 100 orphans, each of which is at most 100,000 bytes big is\n+    // at most 10 megabytes of orphans and somewhat more byprev index (in the worst case):\n+    unsigned int sz = GetTransactionWeight(*tx);\n+    if (sz > MAX_STANDARD_TX_WEIGHT)\n+    {\n+        LogPrint(BCLog::MEMPOOL, \"ignoring large orphan tx (size: %u, hash: %s)\\n\", sz, hash.ToString());\n+        return false;\n+    }\n+\n+    auto ret = m_orphans.emplace(hash, OrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, m_orphan_list.size()});\n+    assert(ret.second);\n+    m_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    m_wtxid_to_orphan_it.emplace(tx->GetWitnessHash(), ret.first);\n+    for (const CTxIn& txin : tx->vin) {\n+        m_outpoint_to_orphan_it[txin.prevout].insert(ret.first);\n+    }\n+\n+    LogPrint(BCLog::MEMPOOL, \"stored orphan tx %s (mapsz %u outsz %u)\\n\", hash.ToString(),\n+             m_orphans.size(), m_outpoint_to_orphan_it.size());\n+    return true;\n+}\n+\n+int TxOrphanage::EraseTx(const uint256& txid)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    std::map<uint256, OrphanTx>::iterator it = m_orphans.find(txid);\n+    if (it == m_orphans.end())\n+        return 0;\n+    for (const CTxIn& txin : it->second.tx->vin)\n+    {\n+        auto itPrev = m_outpoint_to_orphan_it.find(txin.prevout);\n+        if (itPrev == m_outpoint_to_orphan_it.end())\n+            continue;\n+        itPrev->second.erase(it);\n+        if (itPrev->second.empty())\n+            m_outpoint_to_orphan_it.erase(itPrev);\n+    }\n+\n+    size_t old_pos = it->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it);\n+    if (old_pos + 1 != m_orphan_list.size()) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    m_wtxid_to_orphan_it.erase(it->second.tx->GetWitnessHash());\n+\n+    m_orphans.erase(it);\n+    return 1;\n+}\n+\n+void TxOrphanage::EraseForPeer(NodeId peer)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    int nErased = 0;\n+    std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+    while (iter != m_orphans.end())\n+    {\n+        std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        if (maybeErase->second.fromPeer == peer)\n+        {\n+            nErased += EraseTx(maybeErase->second.tx->GetHash());\n+        }\n+    }\n+    if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+}\n+\n+unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n+{\n+    AssertLockHeld(g_cs_orphans);\n+\n+    unsigned int nEvicted = 0;\n+    static int64_t nNextSweep;\n+    int64_t nNow = GetTime();\n+    if (nNextSweep <= nNow) {\n+        // Sweep out expired orphan pool entries:\n+        int nErased = 0;\n+        int64_t nMinExpTime = nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL;\n+        std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n+        while (iter != m_orphans.end())\n+        {\n+            std::map<uint256, OrphanTx>::iterator maybeErase = iter++;\n+            if (maybeErase->second.nTimeExpire <= nNow) {\n+                nErased += EraseTx(maybeErase->second.tx->GetHash());\n+            } else {\n+                nMinExpTime = std::min(maybeErase->second.nTimeExpire, nMinExpTime);\n+            }\n+        }\n+        // Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.\n+        nNextSweep = nMinExpTime + ORPHAN_TX_EXPIRE_INTERVAL;\n+        if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx due to expiration\\n\", nErased);\n+    }\n+    FastRandomContext rng;\n+    while (m_orphans.size() > max_orphans)\n+    {\n+        // Evict a random orphan:\n+        size_t randompos = rng.randrange(m_orphan_list.size());\n+        EraseTx(m_orphan_list[randompos]->first);\n+        ++nEvicted;\n+    }\n+    return nEvicted;\n+}\n+\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const\n+{\n+    AssertLockHeld(g_cs_orphans);\n+    for (unsigned int i = 0; i < tx.vout.size(); i++) {\n+        const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n+        if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n+            for (const auto& elem : it_by_prev->second) {\n+                orphan_work_set.insert(elem->first);\n+            }\n+        }\n+    }\n+}\n+\n+bool TxOrphanage::HaveTx(const GenTxid& gtxid) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21148#discussion_r589393892",
      "id" : 589393892,
      "in_reply_to_id" : 587522262,
      "line" : 154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTM5Mzg5Mg==",
      "original_commit_id" : "5e50e2d1b95e7ca7709a9671ab21f1164b8d0cb8",
      "original_line" : 154,
      "original_position" : 154,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 154,
      "pull_request_review_id" : 606250567,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21148",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-08T12:43:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589393892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   }
]
