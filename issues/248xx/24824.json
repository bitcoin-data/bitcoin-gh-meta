{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "### Per task number 1 in issue #17020 , \"Read ASNs from a file instead of hardcoding\"\r\nThe function 'lookup_asn' has been replaced in a drop in manner by a tab separated value (.tsv) file loader class and function set. This drop in bypasses the current REST based ASN implementation where a 3rd party is contacted per ip address to fetch the current ASN for that ip address. A REST approach is slower than the localized database search found in this PR. \r\n\r\n**Tech Details**\r\nThis drop in replacement utilizes a class object that upon construction loads an ASN database file into memory. This class should be instantiated in 'makeseeds.py'. Once the class has been constructed the makeseeds.py can call asn_lookup() to get the ASN of an ip address from the now localized database. This approach affords speed and decentralization at the cost of a marginal repository size increase.  As the old saying goes there is no such thing as a free lunch.  \r\n\r\nEdit: 4/11/2022\r\nThe class object has been reworked in such a manner that upon instantiation the class if the constructor is provided with a True value for 'fetch'. The class will acquire the compressed dataset upon runtime from the web address stored in the class object (_this could be passes as parameter theoretically_). This fetching process removes the need to store the ip to asn database as a blob in the repository. If fetch is set to False then the class object will attempt to load the default file. If neither a asn db file is present or a fetch is requested the failover mechanism kicks in an performs ip to asn decoding using the previous method currently in master. Failover is slower in all cases and seemly doesn't resolve ip addresses as frequently. \r\n\r\nDatasource: [https://iptoasn.com/](https://iptoasn.com/) Combined IPv4+IPv6 to ASN map\r\n\r\nError messages for failed ip lookups from the previous REST are identical. Additional asserts have been added to avoid feeding the ASN database loader invalid data.  These asserts should cover some of the most common issues.\r\n\r\n- IP has too many segments\r\n- File does not exist\r\n- Invalid number of columns (currently 5)\r\n- IP address has too many segments\r\n- Decimal/Hexdecimal range is invalid within a segment\r\n- ASN database has no records\r\n\r\n**Cost and Changes** \r\n2 files were added. 'ansdecode.py' which contains a class that loads a .tsv.gz file and has member functions that replace existing ASN lookups that are performed by parsing http://www.team-cymru.com/IP-ASN-mapping.html. The second file by default is ip2asn.tsv.gz. This filename is a class constructor parameter that can be changed if a user would like to use a custom file location. This ip2asn.tsv.gz is a compressed .tsv that has a format of [rangeStart rangeEnd asnNumber ...]\\n. Only the first 3 columns of the TSV are utilized additional columns can be included but will only make importing less efficient by doing so. \r\n\r\n**Advantages**\r\n\r\n- Faster: on an Intel Xeon 2699v4 Linux time was reduced from ~2:40 to ~1:50\r\n- Decreases dependance on 3rd party services - Changes to the ASN allocations are infrequent. \r\n- Auditable data format _Uncompressed_\r\n- Asserts on class load with the ample information to identify broken/corrupt lines in the input file\r\n- IPV4/6 Detection function is included and could be used to replace the need for manual definitions in makeseeds.py\r\n\r\n**Disadvantages**\r\n\r\n- Uncompressed ASN database unmodified is 26MB - https://iptoasn.com/ - Data is public domain.\r\n- Compressed ASN databased is ~7.8MB - https://iptoasn.com/ - Data is public domain.\r\n- ASN .tsv.gz database would need to be updated occasionally.\r\n\r\n**Notes**\r\n\r\n- ansdecode.py can be included into the makeseeds.py at the cost of additional file length\r\n- Deliberate use of a class to make testing and auditing of IP hex strings to integer possible.\r\n- The TSV file could be converted to a CSV easily\r\n- The TSV file could be downloaded at runtime instead of being included\r\n- At the cost of complexity one could implement a parallel threaded search for the applicable ip range\r\n- Internet based fallback and failover is possible though that would be quite extreme. ",
   "closed_at" : "2022-04-15T15:29:18Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 20,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24824/comments",
   "created_at" : "2022-04-11T03:24:40Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24824/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/24824",
   "id" : 1199335049,
   "labels" : [
      {
         "color" : "ffffee",
         "default" : false,
         "description" : null,
         "id" : 231994551,
         "name" : "Scripts and tools",
         "node_id" : "MDU6TGFiZWwyMzE5OTQ1NTE=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Scripts%20and%20tools"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24824/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII5841-GCw",
   "number" : 24824,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/24824.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24824",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/24824.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24824"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24824/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24824/timeline",
   "title" : "net: create IP to ASN database from file - makeseeds.py ",
   "updated_at" : "2022-04-15T15:29:19Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24824",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3104223?v=4",
      "events_url" : "https://api.github.com/users/russeree/events{/privacy}",
      "followers_url" : "https://api.github.com/users/russeree/followers",
      "following_url" : "https://api.github.com/users/russeree/following{/other_user}",
      "gists_url" : "https://api.github.com/users/russeree/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/russeree",
      "id" : 3104223,
      "login" : "russeree",
      "node_id" : "MDQ6VXNlcjMxMDQyMjM=",
      "organizations_url" : "https://api.github.com/users/russeree/orgs",
      "received_events_url" : "https://api.github.com/users/russeree/received_events",
      "repos_url" : "https://api.github.com/users/russeree/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/russeree/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/russeree/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/russeree"
   }
}
