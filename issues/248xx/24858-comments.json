[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "An easy way to reproduce this issue is to:\r\n1. setup a new temp node data directory containing only the `blocks` directory that contains only one 516 byte long file, blk00000.dat\r\n    1. the blk00000.dat file contains\r\n        1. the 8 byte serialization header for the genesis block\r\n        1. the genesis block (blockhash 000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f)\r\n        1. the 8 byte serialization header for block at height 2\r\n        1. the block at height 2 (blockhash 000000006a625f06636b8bb6ac7b960a8d03705d1ace08b1a19da3fdcc99ddbd)\r\n\r\n    in other words:\r\n\r\n    ```\r\n    $ cd /tmp/btc && find .\r\n    .\r\n    ./blocks\r\n    ./blocks/blk00000.dat\r\n    $ sha256sum blocks/blk00000.dat\r\n    713be71e35a2bc25481cc66b465da1e439df1c2570d065fa0aecc11eaecbea94  blocks/blk00000.dat\r\n    $ xxd -g 4 blocks/blk00000.dat\r\n    00000000: f9beb4d9 1d010000 01000000 00000000  ................\r\n    00000010: 00000000 00000000 00000000 00000000  ................\r\n    00000020: 00000000 00000000 00000000 3ba3edfd  ............;...\r\n    00000030: 7a7b12b2 7ac72c3e 67768f61 7fc81bc3  z{..z.,>gv.a....\r\n    00000040: 888a5132 3a9fb8aa 4b1e5e4a 29ab5f49  ..Q2:...K.^J)._I\r\n    00000050: ffff001d 1dac2b7c 01010000 00010000  ......+|........\r\n    00000060: 00000000 00000000 00000000 00000000  ................\r\n    00000070: 00000000 00000000 00000000 0000ffff  ................\r\n    00000080: ffff4d04 ffff001d 01044554 68652054  ..M.......EThe T\r\n    00000090: 696d6573 2030332f 4a616e2f 32303039  imes 03/Jan/2009\r\n    000000a0: 20436861 6e63656c 6c6f7220 6f6e2062   Chancellor on b\r\n    000000b0: 72696e6b 206f6620 7365636f 6e642062  rink of second b\r\n    000000c0: 61696c6f 75742066 6f722062 616e6b73  ailout for banks\r\n    000000d0: ffffffff 0100f205 2a010000 00434104  ........*....CA.\r\n    000000e0: 678afdb0 fe554827 1967f1a6 7130b710  g....UH'.g..q0..\r\n    000000f0: 5cd6a828 e03909a6 7962e0ea 1f61deb6  \\..(.9..yb...a..\r\n    00000100: 49f6bc3f 4cef38c4 f35504e5 1ec112de  I..?L.8..U......\r\n    00000110: 5c384df7 ba0b8d57 8a4c702b 6bf11d5f  \\8M....W.Lp+k.._\r\n    00000120: ac000000 00f9beb4 d9d70000 00010000  ................\r\n    00000130: 004860eb 18bf1b16 20e37e94 90fc8a42  .H`..... .~....B\r\n    00000140: 7514416f d75159ab 86688e9a 83000000  u.Ao.QY..h......\r\n    00000150: 00d5fdcc 541e25de 1c7a5add edf24858  ....T.%..zZ...HX\r\n    00000160: b8bb665c 9f36ef74 4ee42c31 6022c90f  ..f\\.6.tN.,1`\"..\r\n    00000170: 9bb0bc66 49ffff00 1d08d2bd 61010100  ...fI.......a...\r\n    00000180: 00000100 00000000 00000000 00000000  ................\r\n    00000190: 00000000 00000000 00000000 00000000  ................\r\n    000001a0: 000000ff ffffff07 04ffff00 1d010bff  ................\r\n    000001b0: ffffff01 00f2052a 01000000 43410472  .......*....CA.r\r\n    000001c0: 11a824f5 5b505228 e4c3d519 4c1fcfaa  ..$.[PR(....L...\r\n    000001d0: 15a456ab df37f9b9 d97a4040 afc073de  ..V..7...z@@..s.\r\n    000001e0: e6c89064 984f0338 5237d921 67c13e23  ...d.O.8R7.!g.>#\r\n    000001f0: 6446b417 ab79a0fc ae412ae3 316b77ac  dF...y...A*.1kw.\r\n    00000200: 00000000                             ....\r\n    ```\r\n\r\n\r\n1. start the node with the command line similar to: `bitcoin-qt -debug -datadir=/tmp/btc -reindex`\r\n1. wait for header synchronization to finish and you see this in the debug log:\r\n`UpdatedBlockTip: new block hash=00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048`\r\n1. shutdown the node\r\n\r\n\r\n\r\nWe setup like this in order to hit the case where an \"Out of order block\" is found during reindexing and it is left disconnected since it's ancestor block at height 1 (blockhash 00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048) is not present in the blk00000.dat file for the reindexing process to attach.\r\n\r\nNow, if we examine the blk00000.dat file, we can see that the corruption has occured at offset 0x125 through 0x12c. The serialization header and data for block at height 1 follow at offset 0x12d:\r\n\r\n```\r\n$ xxd -g 4 -l 524 blocks/blk00000.dat\r\n00000000: f9beb4d9 1d010000 01000000 00000000  ................\r\n00000010: 00000000 00000000 00000000 00000000  ................\r\n00000020: 00000000 00000000 00000000 3ba3edfd  ............;...\r\n00000030: 7a7b12b2 7ac72c3e 67768f61 7fc81bc3  z{..z.,>gv.a....\r\n00000040: 888a5132 3a9fb8aa 4b1e5e4a 29ab5f49  ..Q2:...K.^J)._I\r\n00000050: ffff001d 1dac2b7c 01010000 00010000  ......+|........\r\n00000060: 00000000 00000000 00000000 00000000  ................\r\n00000070: 00000000 00000000 00000000 0000ffff  ................\r\n00000080: ffff4d04 ffff001d 01044554 68652054  ..M.......EThe T\r\n00000090: 696d6573 2030332f 4a616e2f 32303039  imes 03/Jan/2009\r\n000000a0: 20436861 6e63656c 6c6f7220 6f6e2062   Chancellor on b\r\n000000b0: 72696e6b 206f6620 7365636f 6e642062  rink of second b\r\n000000c0: 61696c6f 75742066 6f722062 616e6b73  ailout for banks\r\n000000d0: ffffffff 0100f205 2a010000 00434104  ........*....CA.\r\n000000e0: 678afdb0 fe554827 1967f1a6 7130b710  g....UH'.g..q0..\r\n000000f0: 5cd6a828 e03909a6 7962e0ea 1f61deb6  \\..(.9..yb...a..\r\n00000100: 49f6bc3f 4cef38c4 f35504e5 1ec112de  I..?L.8..U......\r\n00000110: 5c384df7 ba0b8d57 8a4c702b 6bf11d5f  \\8M....W.Lp+k.._\r\n00000120: ac000000 00f9beb4 d9d70000 00f9beb4  ................      <----- offset 0x125 through 0x12c demonstrate the incorrect offset calculated by the reindexing process. those bytes are from the original data that was already in the file and were erroneously not overwritten due to the bad offset.\r\n00000130: d9d70000 00010000 006fe28c 0ab6f1b3  .........o......\r\n00000140: 72c1a6a2 46ae63f7 4f931e83 65e15a08  r...F.c.O...e.Z.\r\n00000150: 9c68d619 00000000 00982051 fd1e4ba7  .h........ Q..K.\r\n00000160: 44bbbe68 0e1fee14 677ba1a3 c3540bf7  D..h....g{...T..\r\n00000170: b1cdb606 e857233e 0e61bc66 49ffff00  .....W#>.a.fI...\r\n00000180: 1d01e362 99010100 00000100 00000000  ...b............\r\n00000190: 00000000 00000000 00000000 00000000  ................\r\n000001a0: 00000000 00000000 000000ff ffffff07  ................\r\n000001b0: 04ffff00 1d0104ff ffffff01 00f2052a  ...............*\r\n000001c0: 01000000 43410496 b538e853 519c726a  ....CA...8.SQ.rj\r\n000001d0: 2c91e61e c11600ae 1390813a 627c66fb  ,..........:b|f.\r\n000001e0: 8be7947b e63c52da 75893795 15d4e0a6  ...{.<R.u.7.....\r\n000001f0: 04f81417 81e62294 721166bf 621e73a8  ......\".r.f.b.s.\r\n00000200: 2cbf2342 c858eeac 00000000           ,.#B.X......\r\n```\r\n1. If we now restart the node with the same command line as before, `bitcoin-qt -debug -datadir=/tmp/btc -reindex` we will soon see a message in the debug.log like:\r\n`LoadExternalBlockFile: Deserialize or I/O error - ReadCompactSize(): size too large: iostream error`",
      "created_at" : "2022-04-15T02:16:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1099788622",
      "id" : 1099788622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585BjXFO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099788622/reactions"
      },
      "updated_at" : "2022-04-15T02:21:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099788622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "ØªØºÙØ± Ø§ÙÙÙÙØ§Øª",
      "created_at" : "2022-04-15T04:57:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1099849383",
      "id" : 1099849383,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Bjl6n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099849383/reactions"
      },
      "updated_at" : "2022-04-29T16:44:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099849383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/101409499?v=4",
         "events_url" : "https://api.github.com/users/samahanas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/samahanas/followers",
         "following_url" : "https://api.github.com/users/samahanas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/samahanas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/samahanas",
         "id" : 101409499,
         "login" : "samahanas",
         "node_id" : "U_kgDOBgti2w",
         "organizations_url" : "https://api.github.com/users/samahanas/orgs",
         "received_events_url" : "https://api.github.com/users/samahanas/received_events",
         "repos_url" : "https://api.github.com/users/samahanas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/samahanas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/samahanas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/samahanas"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Attached here is the blk00000.dat file with sha256sum of\r\n`713be71e35a2bc25481cc66b465da1e439df1c2570d065fa0aecc11eaecbea94` used by my easy reproduction comment above https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1099788622. \r\n\r\nSimply remove the \".txt\" file extension that I had to add in order to upload it here.\r\n\r\n[blk00000.dat.txt](https://github.com/bitcoin/bitcoin/files/8495215/blk00000.dat.txt)\r\n",
      "created_at" : "2022-04-15T09:39:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1100000135",
      "id" : 1100000135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585BkKuH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1100000135/reactions"
      },
      "updated_at" : "2022-04-15T09:39:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1100000135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "noting for historical purposes that this updates a fix made by https://github.com/bitcoin/bitcoin/pull/5864 @theuni",
      "created_at" : "2022-04-18T12:54:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1101385689",
      "id" : 1101385689,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Bpc_Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101385689/reactions"
      },
      "updated_at" : "2022-04-18T12:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101385689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, will review this week.",
      "created_at" : "2022-04-18T15:26:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1101497557",
      "id" : 1101497557,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Bp4TV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101497557/reactions"
      },
      "updated_at" : "2022-04-18T15:26:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101497557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852467662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467662"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think an alternative fix would be to have two distinct calls to `FindBlockPos` in `BlockManager::SaveBlockToDisk` conditional on whether `dbp == nullptr` (not adding 8 to nAddSize parameter if that is the case). Maybe that would be a little bit clearer than adding and substracting 8.\r\n\r\nIn general, such a high percentage of code in  `FindBlockPos()` is conditional on `fKnown` or `!fKnown` that I wonder whether it would make sense to refactor this into two separate functions (not here, but as a possible follow-up).",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T22:54:06Z",
      "diff_hunk" : "@@ -611,7 +611,12 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n \n     m_blockfile_info[nFile].AddBlock(nHeight, nTime);\n     if (fKnown) {\n-        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize, m_blockfile_info[nFile].nSize);\n+        // pos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // nAddSize already has 8 added to it too. we subtract 8 to avoid over accounting for the serialization\n+        // header. such over accounting was a long standing bug that added undesirable 8 byte gaps into blk data files following\n+        // a -reindex operation. for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize - 8, m_blockfile_info[nFile].nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852467662",
      "id" : 852467662,
      "line" : 619,
      "node_id" : "PRRC_kwDOABII584yz5_O",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 619,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 10,
      "pull_request_review_id" : 944897633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467662/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:12:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852467981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467981"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: remove 2011- , it's new",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T22:54:54Z",
      "diff_hunk" : "@@ -0,0 +1,40 @@\n+// Copyright (c) 2011-2022 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852467981",
      "id" : 852467981,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII584yz6EN",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 1,
      "pull_request_review_id" : 944897633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467981/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852471681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852471681"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I wonder whether it might be better to keep this an unconditional log, so that there is a higher chance of getting reports such as the one in #21379.\r\nI think the expectation is that it shouldn't be possible to get this warning (unless there is actual disk corruption) after this PR, unless you have an existing datadir that is already slightly corrupted by past reindexes.",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T23:04:19Z",
      "diff_hunk" : "@@ -4356,7 +4356,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {\n-                LogPrintf(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\n+                // historical bugs added extra data to the block files that does not deserialize cleanly.\n+                // commonly this data is between readable blocks, but it does not really matter. such data is not fatal to the import process.\n+                // the code that reads the block files deals with invalid data by simply ignoring it.\n+                // it continues to search for the next {4 byte magic message start bytes + 4 byte length + block} that does deserialize cleanly\n+                // and passes all of the other block validation checks dealing with POW and the merkle root, etc...\n+                // we merely note with this informational log message when unexpected data is encountered.\n+                // we could also be experiencing a storage system read error, or a read of a previous bad write. these are possible, but\n+                // less likely scenarios. we don't have enough information to tell a difference here.\n+                // the reindex process is not the place to attempt to clean and/or compact the block files. if so desired, a studious node operator\n+                // may use knowledge of the fact that the block files are not entirely pristine in order to prepare a set of pristine, and\n+                // perhaps ordered, block files for later reindexing.\n+                LogPrint(BCLog::REINDEX, \"%s: unexpected data at file offset 0x%x - %s. continuing\\n\", __func__, (nRewind - 1), e.what());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852471681",
      "id" : 852471681,
      "line" : 4370,
      "node_id" : "PRRC_kwDOABII584yz6-B",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 4370,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 944897633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852471681/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852471681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852491726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852491726"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review!\r\n\r\nI resonate with what you said about not subtracting 8 within `BlockManager::FindBlockPos` for code clarity. Subtracting 8 was just the first simplest fix that I thought of.\r\n\r\nBuilding off of your idea, instead of making two different calls, we could get the same effect by doing something like the following in `BlockManager::SaveBlockToDisk`:\r\n\r\n```\r\n    const auto position_known = dbp != nullptr;\r\n    const auto additional_size = nBlockSize + (position_known ? 0 : 8);\r\n    if (!FindBlockPos(blockPos, additional_size, nHeight, active_chain, block.GetBlockTime(), position_known)) {\r\n```",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T23:57:25Z",
      "diff_hunk" : "@@ -611,7 +611,12 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n \n     m_blockfile_info[nFile].AddBlock(nHeight, nTime);\n     if (fKnown) {\n-        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize, m_blockfile_info[nFile].nSize);\n+        // pos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // nAddSize already has 8 added to it too. we subtract 8 to avoid over accounting for the serialization\n+        // header. such over accounting was a long standing bug that added undesirable 8 byte gaps into blk data files following\n+        // a -reindex operation. for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize - 8, m_blockfile_info[nFile].nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852491726",
      "id" : 852491726,
      "in_reply_to_id" : 852467662,
      "line" : 619,
      "node_id" : "PRRC_kwDOABII584yz_3O",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 619,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 10,
      "pull_request_review_id" : 944926396,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852491726/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:57:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852491726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852492114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852492114"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ok, i will update when i update the commit along with updates from the other comments",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T23:58:28Z",
      "diff_hunk" : "@@ -0,0 +1,40 @@\n+// Copyright (c) 2011-2022 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852492114",
      "id" : 852492114,
      "in_reply_to_id" : 852467981,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII584yz_9S",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 1,
      "pull_request_review_id" : 944926830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852492114/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852492114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852496122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852496122"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I did consider keeping this log message unconditional. I think we'd get a fair number of false positive reports if we leave this scary log message as it was. This bug has been around for about 7 years, and maybe more if you count the bugs that the last fix tried to handle. So, there are probably a lot of blk files that have been _recoverably_ corrupted (i.e. corrupted in a way that is still processable). To me, it's more of a notification for a concerned node operator that really cares about having a clean set of blk files. The new message gives the exact offset to go look, and maybe edit the file, if you really want to. But, The existing message doesn't really do much to help the operator. It kind of just scares them, even though the processing goes on. Maybe there is a balance that we need to hit. But, I'm not sure what that looks like besides this right now.",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-19T00:10:35Z",
      "diff_hunk" : "@@ -4356,7 +4356,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {\n-                LogPrintf(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\n+                // historical bugs added extra data to the block files that does not deserialize cleanly.\n+                // commonly this data is between readable blocks, but it does not really matter. such data is not fatal to the import process.\n+                // the code that reads the block files deals with invalid data by simply ignoring it.\n+                // it continues to search for the next {4 byte magic message start bytes + 4 byte length + block} that does deserialize cleanly\n+                // and passes all of the other block validation checks dealing with POW and the merkle root, etc...\n+                // we merely note with this informational log message when unexpected data is encountered.\n+                // we could also be experiencing a storage system read error, or a read of a previous bad write. these are possible, but\n+                // less likely scenarios. we don't have enough information to tell a difference here.\n+                // the reindex process is not the place to attempt to clean and/or compact the block files. if so desired, a studious node operator\n+                // may use knowledge of the fact that the block files are not entirely pristine in order to prepare a set of pristine, and\n+                // perhaps ordered, block files for later reindexing.\n+                LogPrint(BCLog::REINDEX, \"%s: unexpected data at file offset 0x%x - %s. continuing\\n\", __func__, (nRewind - 1), e.what());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852496122",
      "id" : 852496122,
      "in_reply_to_id" : 852471681,
      "line" : 4370,
      "node_id" : "PRRC_kwDOABII584y0A76",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 4370,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 944931964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852496122/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-19T00:10:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852496122",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852532300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852532300"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "made updates for this in 66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-19T01:58:10Z",
      "diff_hunk" : "@@ -611,7 +611,12 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n \n     m_blockfile_info[nFile].AddBlock(nHeight, nTime);\n     if (fKnown) {\n-        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize, m_blockfile_info[nFile].nSize);\n+        // pos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // nAddSize already has 8 added to it too. we subtract 8 to avoid over accounting for the serialization\n+        // header. such over accounting was a long standing bug that added undesirable 8 byte gaps into blk data files following\n+        // a -reindex operation. for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize - 8, m_blockfile_info[nFile].nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852532300",
      "id" : 852532300,
      "in_reply_to_id" : 852467662,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584y0JxM",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 619,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 944976204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852532300/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-19T01:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852532300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, will review soon.",
      "created_at" : "2022-04-19T03:40:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1101961207",
      "id" : 1101961207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Brpf3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101961207/reactions"
      },
      "updated_at" : "2022-04-19T03:40:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101961207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r853007258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/853007258"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "okay, makes sense. By the way, node operators also have the option to apply the `linearize-data.py` script in `/contrib/linearize` (which was adjusted in #16802 to deal with this bug, after a report in #14986), but this will also remove orphaned blocks from the blk files.",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-19T12:33:09Z",
      "diff_hunk" : "@@ -4356,7 +4356,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {\n-                LogPrintf(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\n+                // historical bugs added extra data to the block files that does not deserialize cleanly.\n+                // commonly this data is between readable blocks, but it does not really matter. such data is not fatal to the import process.\n+                // the code that reads the block files deals with invalid data by simply ignoring it.\n+                // it continues to search for the next {4 byte magic message start bytes + 4 byte length + block} that does deserialize cleanly\n+                // and passes all of the other block validation checks dealing with POW and the merkle root, etc...\n+                // we merely note with this informational log message when unexpected data is encountered.\n+                // we could also be experiencing a storage system read error, or a read of a previous bad write. these are possible, but\n+                // less likely scenarios. we don't have enough information to tell a difference here.\n+                // the reindex process is not the place to attempt to clean and/or compact the block files. if so desired, a studious node operator\n+                // may use knowledge of the fact that the block files are not entirely pristine in order to prepare a set of pristine, and\n+                // perhaps ordered, block files for later reindexing.\n+                LogPrint(BCLog::REINDEX, \"%s: unexpected data at file offset 0x%x - %s. continuing\\n\", __func__, (nRewind - 1), e.what());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r853007258",
      "id" : 853007258,
      "in_reply_to_id" : 852471681,
      "line" : 4370,
      "node_id" : "PRRC_kwDOABII584y19ua",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 4370,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 945625443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/853007258/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-19T12:33:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/853007258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854198361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854198361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe move this docstring to the header file?",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-20T14:21:30Z",
      "diff_hunk" : "@@ -785,19 +785,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854198361",
      "id" : 854198361,
      "line" : 788,
      "node_id" : "PRRC_kwDOABII584y6ghZ",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 788,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 4,
      "pull_request_review_id" : 947253618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854198361/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T15:49:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854198361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854234515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854234515"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(comment about existing code, not a criticism on this patch)\r\n\r\nThe breadth of what this is catching is concerning to me - it makes it difficult to tell where we realistically expect exceptions to be thrown, and is making understanding this fix more difficult than I think it otherwise would be. From what I can tell, there are really two lines within this `try` that we expect the catch to handle, \r\n- `blkdat >> block;`\r\n- `if (ReadBlockFromDisk(...`\r\n  - but maybe not even this line, since exceptions are handled within `ReadBlockFromDisk`\r\n\r\nAm I wrong about this? Is there a good reason the try block is so broad?\r\n\r\nIf not, maybe (in future PRs?) we can limit this `try`/`catch` block to the specific line(s) where we expect to throw.",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-20T14:51:57Z",
      "diff_hunk" : "@@ -4356,7 +4356,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854234515",
      "id" : 854234515,
      "line" : 4358,
      "node_id" : "PRRC_kwDOABII584y6pWT",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 4358,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 3,
      "pull_request_review_id" : 947253618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854234515/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T15:49:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854234515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854254239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854254239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Aid to reviewers: the 8 bytes mentioned are added on writing the block to disk in `blockstorage.cpp:WriteBlockToDisk()`.",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-20T15:09:02Z",
      "diff_hunk" : "@@ -785,19 +785,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr}; // if dbp is not nullptr, then the file and block within it are known to already reside on disk\n+    if (position_known) {\n         blockPos = *dbp;\n-    }\n-    if (!FindBlockPos(blockPos, nBlockSize + 8, nHeight, active_chain, block.GetBlockTime(), dbp != nullptr)) {\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // we add 8 only for new blocks since they will have the serialization header added when written to disk.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854254239",
      "id" : 854254239,
      "line" : 798,
      "node_id" : "PRRC_kwDOABII584y6uKf",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 798,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 18,
      "pull_request_review_id" : 947253618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854254239/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T15:49:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854254239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854257419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854257419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could also be phrased as `nBlockSize += sizeof(unsigned int) + CMessageHeader::MESSAGE_START_SIZE` to avoid hardcoding the expected header size.\r\n\r\nWe could also include \r\n```cpp\r\nconstexpr size_t BLOCK_SERIALIZATION_HEADER_LEN = \r\n    sizeof(unsigned int) + CMessageHeader::MESSAGE_START_SIZE;\r\n```\r\nnearby `WriteBlockToDisk` to avoid having that information live too far away from its source of truth.",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-20T15:11:50Z",
      "diff_hunk" : "@@ -785,19 +785,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr}; // if dbp is not nullptr, then the file and block within it are known to already reside on disk\n+    if (position_known) {\n         blockPos = *dbp;\n-    }\n-    if (!FindBlockPos(blockPos, nBlockSize + 8, nHeight, active_chain, block.GetBlockTime(), dbp != nullptr)) {\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // we add 8 only for new blocks since they will have the serialization header added when written to disk.\n+        // this avoids over accounting for the serialization header on existing blocks. such over accounting was a long\n+        // standing bug that added undesirable 8 byte gaps into blk data files following a -reindex operation.\n+        // for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        nBlockSize += 8U;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854257419",
      "id" : 854257419,
      "line" : 802,
      "node_id" : "PRRC_kwDOABII584y6u8L",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 802,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 22,
      "pull_request_review_id" : 947253618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854257419/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T15:49:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854257419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854330013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854330013"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "i removed that doc string and put the meat of the comment into the context where it made sense on line 792. i figured that the remaining part of the comment \"Store block on disk\" was pretty self-evident for the method named \"SaveBlockToDisk\". if i were to make more changes, then i'd probably rename the parameter to be meaningful and potentially add a comment. but then that begins to make the change larger. so, i'll leave it for now unless i have to to get this merged.",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-20T16:23:15Z",
      "diff_hunk" : "@@ -785,19 +785,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854330013",
      "id" : 854330013,
      "in_reply_to_id" : 854198361,
      "line" : 788,
      "node_id" : "PRRC_kwDOABII584y7Aqd",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 788,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 4,
      "pull_request_review_id" : 947439613,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854330013/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T16:23:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854330013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854332134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854332134"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "also, the position comes from `CChainState::LoadExternalBlockFile` when it's read in again. that position is past the serialization header already (it points directly at the block data) and thus why we don't need to add 8 with the old code `nBlockSize + 8`.",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-20T16:25:33Z",
      "diff_hunk" : "@@ -785,19 +785,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr}; // if dbp is not nullptr, then the file and block within it are known to already reside on disk\n+    if (position_known) {\n         blockPos = *dbp;\n-    }\n-    if (!FindBlockPos(blockPos, nBlockSize + 8, nHeight, active_chain, block.GetBlockTime(), dbp != nullptr)) {\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // we add 8 only for new blocks since they will have the serialization header added when written to disk.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854332134",
      "id" : 854332134,
      "in_reply_to_id" : 854254239,
      "line" : 798,
      "node_id" : "PRRC_kwDOABII584y7BLm",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 798,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 18,
      "pull_request_review_id" : 947442452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854332134/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T16:25:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854332134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854343492"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854343492"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "maybe. this actually crossed my mind. i wasn't sure if it was better to go with the hardcoded 8 that has been around for so long, or to go with the `sizeof(unsigned int)` that could be wrong for LP32 and ILP64 (https://en.cppreference.com/w/cpp/language/types). we may go with what you suggest, but i'd like to get some feedback and make this change on purpose.",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-04-20T16:38:10Z",
      "diff_hunk" : "@@ -785,19 +785,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr}; // if dbp is not nullptr, then the file and block within it are known to already reside on disk\n+    if (position_known) {\n         blockPos = *dbp;\n-    }\n-    if (!FindBlockPos(blockPos, nBlockSize + 8, nHeight, active_chain, block.GetBlockTime(), dbp != nullptr)) {\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // we add 8 only for new blocks since they will have the serialization header added when written to disk.\n+        // this avoids over accounting for the serialization header on existing blocks. such over accounting was a long\n+        // standing bug that added undesirable 8 byte gaps into blk data files following a -reindex operation.\n+        // for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        nBlockSize += 8U;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854343492",
      "id" : 854343492,
      "in_reply_to_id" : 854257419,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584y7D9E",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 802,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 947458394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854343492/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T18:23:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854343492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> My best guess is that those 8 bytes are included in LoadExternalBlockFile (nRewind = blkdat.GetPos()) after an existing block is read (which then determines the value of dbp), whereas during the addition of a new block, no existing data is read and therefore those 8 header bytes are unaccounted for.\r\n\r\n@jamesob Thanks for the review! You're very close and you have the right idea. The exact line where they come from is in `CChainState::LoadExternalBlockFile` at the line `dbp->nPos = nBlockPos;` https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L4288\r\nThat is why blindly adding another 8 on the call to `FindBlockPos` in `BlockManager::SaveBlockToDisk` is wrong for already known blocks.",
      "created_at" : "2022-04-20T16:54:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1104179409",
      "id" : 1104179409,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585B0HDR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1104179409/reactions"
      },
      "updated_at" : "2022-04-20T16:54:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1104179409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854479312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854479312"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "i just found in src/compat/assumptions.h `static_assert(sizeof(unsigned) == 4, \"32-bit unsigned assumed\");`\r\nthat is what i need to feel safe making this change. i'll do it in my next update.",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-04-20T19:21:45Z",
      "diff_hunk" : "@@ -785,19 +785,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr}; // if dbp is not nullptr, then the file and block within it are known to already reside on disk\n+    if (position_known) {\n         blockPos = *dbp;\n-    }\n-    if (!FindBlockPos(blockPos, nBlockSize + 8, nHeight, active_chain, block.GetBlockTime(), dbp != nullptr)) {\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // we add 8 only for new blocks since they will have the serialization header added when written to disk.\n+        // this avoids over accounting for the serialization header on existing blocks. such over accounting was a long\n+        // standing bug that added undesirable 8 byte gaps into blk data files following a -reindex operation.\n+        // for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        nBlockSize += 8U;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854479312",
      "id" : 854479312,
      "in_reply_to_id" : 854257419,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584y7lHQ",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 802,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 947656466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854479312/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T19:21:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854479312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854524043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854524043"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "update in 425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-04-20T20:22:08Z",
      "diff_hunk" : "@@ -785,19 +785,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr}; // if dbp is not nullptr, then the file and block within it are known to already reside on disk\n+    if (position_known) {\n         blockPos = *dbp;\n-    }\n-    if (!FindBlockPos(blockPos, nBlockSize + 8, nHeight, active_chain, block.GetBlockTime(), dbp != nullptr)) {\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // we add 8 only for new blocks since they will have the serialization header added when written to disk.\n+        // this avoids over accounting for the serialization header on existing blocks. such over accounting was a long\n+        // standing bug that added undesirable 8 byte gaps into blk data files following a -reindex operation.\n+        // for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        nBlockSize += 8U;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854524043",
      "id" : 854524043,
      "in_reply_to_id" : 854257419,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584y7wCL",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 802,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 947720570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854524043/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T20:22:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854524043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854525540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854525540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "update in 425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-04-20T20:24:25Z",
      "diff_hunk" : "@@ -785,19 +785,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r854525540",
      "id" : 854525540,
      "in_reply_to_id" : 854198361,
      "line" : 788,
      "node_id" : "PRRC_kwDOABII584y7wZk",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 788,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 13,
      "pull_request_review_id" : 947722670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854525540/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-20T20:24:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854525540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "please add error recovery to `rescan` such that from any ioerror the following blk.dat files can still be imported while/after the missing data is downloaded form a peer. Currently all considered blk.dat files after  yield 0 imported blocks (btw one could stop after first ioerror  right away!)\r\nalso: does it reverse already padded blk.dats that got touched by `reindex` ?\r\nIt reduces stress from network and oneself!",
      "created_at" : "2022-05-01T15:52:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1114270108",
      "id" : 1114270108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Cammc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1114270108/reactions"
      },
      "updated_at" : "2022-05-01T16:09:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1114270108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/52429424?v=4",
         "events_url" : "https://api.github.com/users/vwas2/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vwas2/followers",
         "following_url" : "https://api.github.com/users/vwas2/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vwas2/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vwas2",
         "id" : 52429424,
         "login" : "vwas2",
         "node_id" : "MDQ6VXNlcjUyNDI5NDI0",
         "organizations_url" : "https://api.github.com/users/vwas2/orgs",
         "received_events_url" : "https://api.github.com/users/vwas2/received_events",
         "repos_url" : "https://api.github.com/users/vwas2/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vwas2/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vwas2/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vwas2"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Currently all considered blk.dat files after yield 0 imported blocks (btw one could stop after first ioerror right away!)\r\n\r\nThat can be the case, but it is not the case a lot of the time. For example, this issue deals with the cases where reads fail, and get skipped, in-between blocks. The case where no subsequent blocks get imported is where an actual block read fails and that makes every subsequent block appear to be out of order. That's a different thing.\r\n\r\n> does it reverse already padded blk.dats\r\n\r\nNo, this change does not attempt to alter the block files if an error is found (and skipped). This change attempts to stop setting up data that is used by later processing which winds up corrupting the block files.\r\n\r\nI'd like to keep this change focused on fixing the original issue and not trying to re-design the import processes.",
      "created_at" : "2022-05-02T14:23:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1114955764",
      "id" : 1114955764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585CdN_0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1114955764/reactions"
      },
      "updated_at" : "2022-05-02T14:23:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1114955764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r864089748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864089748"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"reindex, log, test: fixes #21379\" (425fc8813307b8d96a48e4b45d0a7b00bbc2289e)\r\n\r\nCould you add a comment documenting this variable? Would suggest `/** Size of header written by WriteBlockToDisk() before a serialized CBlock */`",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-05-03T18:47:02Z",
      "diff_hunk" : "@@ -653,6 +653,8 @@ bool BlockManager::FindUndoPos(BlockValidationState& state, int nFile, FlatFileP\n     return true;\n }\n \n+static constexpr size_t BLOCK_SERIALIZATION_HEADER_SIZE = CMessageHeader::MESSAGE_START_SIZE + sizeof(unsigned int);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r864089748",
      "id" : 864089748,
      "line" : 656,
      "node_id" : "PRRC_kwDOABII584zgPaU",
      "original_commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "original_line" : 656,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 4,
      "pull_request_review_id" : 960849459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864089748/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-03T20:41:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864089748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r864117753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864117753"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"reindex, log, test: fixes #21379\" (425fc8813307b8d96a48e4b45d0a7b00bbc2289e)\r\n\r\nJust IMO, but I don't think adding the `position_known` variable is helpful here. Just adds another piece of state and the name doesn't convey the main thing this variable actually does, which is skip writing to disk.",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-05-03T19:20:22Z",
      "diff_hunk" : "@@ -785,19 +787,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r864117753",
      "id" : 864117753,
      "line" : 794,
      "node_id" : "PRRC_kwDOABII584zgWP5",
      "original_commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "original_line" : 794,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 19,
      "pull_request_review_id" : 960849459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864117753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-03T20:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864117753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r864136131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864136131"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"reindex, log, test: fixes #21379\" (425fc8813307b8d96a48e4b45d0a7b00bbc2289e)\r\n\r\nIt seems fragile to be passing `FindBlockPos` different lengths for the same block depending on whether `dbp` is null. The bug in the previous version of the code was not that it was passing the wrong *length* when _dbp_ is non-null. The bug was that it was passing the wrong _position_. (It was passing a different position than the one the original FindBlockPos call returned when the block was first written). Fixing the new position being 8 bytes ahead by making the length 8 bytes shorter seems fragile because it assumes FindBlockPos will be ok with this. Better to just pass later FindBlockPos calls the same position earlier calls returned, than work around this by passing a different length.\r\n\r\nI also think this comment is a little confusing, and that it's generally not helpful for comments to describe bugs in previous versions of the code that are no longer present. Information about the bug is helpful in the other part of the commit to understand the log statement, but I think is just distracting here in this part of the code.\r\n\r\nSuggested an alternate version of this fix in https://github.com/ryanofsky/bitcoin/commit/07c05a1b24bf42e57f8c229f505ed448a6df81f7",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-05-03T19:43:37Z",
      "diff_hunk" : "@@ -785,19 +787,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n-    }\n-    if (!FindBlockPos(blockPos, nBlockSize + 8, nHeight, active_chain, block.GetBlockTime(), dbp != nullptr)) {\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        // this avoids over accounting for the serialization header on existing blocks. such over accounting was a long\n+        // standing bug that added undesirable 8 byte gaps into blk data files following a -reindex operation.\n+        // for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r864136131",
      "id" : 864136131,
      "line" : 804,
      "node_id" : "PRRC_kwDOABII584zgavD",
      "original_commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "original_line" : 804,
      "original_position" : 31,
      "original_start_line" : 798,
      "path" : "src/node/blockstorage.cpp",
      "position" : 31,
      "pull_request_review_id" : 960849459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864136131/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 798,
      "start_side" : "RIGHT",
      "updated_at" : "2022-05-03T20:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864136131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r864179556"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864179556"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"reindex, log, test: fixes #21379\" (425fc8813307b8d96a48e4b45d0a7b00bbc2289e)\r\n\r\nMay be less fragile to write `8 + GetSerializeSize(GenesisBlock())` instead of `301`",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-05-03T20:11:50Z",
      "diff_hunk" : "@@ -0,0 +1,40 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <node/blockstorage.h>\n+#include <node/context.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+#include <test/util/setup_common.h>\n+\n+using node::BlockManager;\n+\n+// use BasicTestingSetup here for the data directory configuration, setup, and cleanup\n+BOOST_FIXTURE_TEST_SUITE(blockmanager_tests, BasicTestingSetup)\n+\n+BOOST_AUTO_TEST_CASE(blockmanager_find_block_pos)\n+{\n+    const auto params {CreateChainParams(ArgsManager{}, CBaseChainParams::MAIN)};\n+    BlockManager blockman {};\n+    CChain chain {};\n+    // simulate adding a genesis block normally\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, *params, nullptr).nPos, 8U);\n+    // simulate what happens during reindex\n+    // simulate a well-formed genesis block being found at offset 8 in the blk00000.dat file\n+    // the block is found at offset 8 because there is an 8 byte serialization header\n+    // consisting of 4 magic bytes + 4 length bytes before each block in a well-formed blk file.\n+    FlatFilePos pos{0, 8};\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, *params, &pos).nPos, 8U);\n+    // now simulate what happens after reindex for the first new block processed\n+    // the actual block contents don't matter, just that it's a block.\n+    // verify that the write position is at offset 0x12d.\n+    // this is a check to make sure that https://github.com/bitcoin/bitcoin/issues/21379 does not recur\n+    // 8 bytes (for serialization header) + 285 (for serialized genesis block) = 293\n+    // add another 8 bytes for the second block's serialization header and we get 293 + 8 = 301\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 1, chain, *params, nullptr).nPos, 301U);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r864179556",
      "id" : 864179556,
      "line" : 37,
      "node_id" : "PRRC_kwDOABII584zglVk",
      "original_commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 37,
      "pull_request_review_id" : 960849459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864179556/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-03T20:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/864179556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r865122278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865122278"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I could do this.\r\n\r\nMy follow-up question is whether to move the `BLOCK_SERIALIZATION_HEADER_SIZE` constant into `node/blockstorage.h` and reference it here too?\r\nFor example, `node::BLOCK_SERIALIZATION_HEADER_SIZE + ::GetSerializeSize(params->GenesisBlock())`, instead of using the magic 8.\r\n\r\nThe tradeoff is that it moves the constant further from the code where it is used. Is that worth doing when the genesis block is immutable? I am fine with either approach. I kind of prefer putting it in the header file, but, I'd just like to get opinions before pushing up another commit.",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-05-04T17:58:48Z",
      "diff_hunk" : "@@ -0,0 +1,40 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <node/blockstorage.h>\n+#include <node/context.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+#include <test/util/setup_common.h>\n+\n+using node::BlockManager;\n+\n+// use BasicTestingSetup here for the data directory configuration, setup, and cleanup\n+BOOST_FIXTURE_TEST_SUITE(blockmanager_tests, BasicTestingSetup)\n+\n+BOOST_AUTO_TEST_CASE(blockmanager_find_block_pos)\n+{\n+    const auto params {CreateChainParams(ArgsManager{}, CBaseChainParams::MAIN)};\n+    BlockManager blockman {};\n+    CChain chain {};\n+    // simulate adding a genesis block normally\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, *params, nullptr).nPos, 8U);\n+    // simulate what happens during reindex\n+    // simulate a well-formed genesis block being found at offset 8 in the blk00000.dat file\n+    // the block is found at offset 8 because there is an 8 byte serialization header\n+    // consisting of 4 magic bytes + 4 length bytes before each block in a well-formed blk file.\n+    FlatFilePos pos{0, 8};\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, *params, &pos).nPos, 8U);\n+    // now simulate what happens after reindex for the first new block processed\n+    // the actual block contents don't matter, just that it's a block.\n+    // verify that the write position is at offset 0x12d.\n+    // this is a check to make sure that https://github.com/bitcoin/bitcoin/issues/21379 does not recur\n+    // 8 bytes (for serialization header) + 285 (for serialized genesis block) = 293\n+    // add another 8 bytes for the second block's serialization header and we get 293 + 8 = 301\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 1, chain, *params, nullptr).nPos, 301U);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r865122278",
      "id" : 865122278,
      "in_reply_to_id" : 864179556,
      "line" : 37,
      "node_id" : "PRRC_kwDOABII584zkLfm",
      "original_commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 37,
      "pull_request_review_id" : 962272461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865122278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-04T17:58:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865122278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r865122449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865122449"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I'll add this comment in the next commit.",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-05-04T17:59:00Z",
      "diff_hunk" : "@@ -653,6 +653,8 @@ bool BlockManager::FindUndoPos(BlockValidationState& state, int nFile, FlatFileP\n     return true;\n }\n \n+static constexpr size_t BLOCK_SERIALIZATION_HEADER_SIZE = CMessageHeader::MESSAGE_START_SIZE + sizeof(unsigned int);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r865122449",
      "id" : 865122449,
      "in_reply_to_id" : 864089748,
      "line" : 656,
      "node_id" : "PRRC_kwDOABII584zkLiR",
      "original_commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "original_line" : 656,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 4,
      "pull_request_review_id" : 962272705,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865122449/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-04T17:59:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865122449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r865122616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865122616"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I did this because `dbp` was compared to `nullptr` three times in this method, and I thought that giving a name to the concept that it represents seemed more descriptive/readable. Whether we have a known position for the block plays a large role in what goes on in `BlockManager::FindBlockPos` one call deeper, so, to me, it adds some continuity to the concept when you add in that context. By calling it `position_known` the reader gets an answer for why we don't write it to disk again -- because it's position in a blk file is already known; it's already written to disk.",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-05-04T17:59:12Z",
      "diff_hunk" : "@@ -785,19 +787,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r865122616",
      "id" : 865122616,
      "in_reply_to_id" : 864117753,
      "line" : 794,
      "node_id" : "PRRC_kwDOABII584zkLk4",
      "original_commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "original_line" : 794,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 19,
      "pull_request_review_id" : 962272970,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865122616/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-04T17:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865122616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r865242559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865242559"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review. I can see it both ways. I'm not feeling a big difference either way. To me, it kind of feels like two sides of the same coin.\r\n\r\nWhat I'm thinking is that `BlockManager::FindBlockPos` is multi-purpose. It's kind of funky because of how much within that method is conditioned upon the position being known, or not.\r\nIn one use, it's trying to figure out a spot where it can put the new header + block into a block file while respecting the file size limit.\r\nIn another use, it's trying to compute where it should put new blocks once we're done processing blocks that we already have in a file.\r\nSince in the second use, it knows the actual position and the block size, it can make sense why the passed in size to add, `nAddSize`, is different between the two invocations.\r\n\r\nThanks for providing an example of what you envisoned (07c05a1b24bf42e57f8c229f505ed448a6df81f7).\r\nI kind of like my commit because I don't have to go back and add the header size.\r\nBut, I can also see what you're saying about passing `FindBlockPos` the same positions that it returns.\r\nI'm undecided. Any other thoughts?\r\n\r\nLastly, I'm fine with trimming the comment to take out the info about past bug.\r\n",
      "commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "created_at" : "2022-05-04T19:42:42Z",
      "diff_hunk" : "@@ -785,19 +787,27 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n-    }\n-    if (!FindBlockPos(blockPos, nBlockSize + 8, nHeight, active_chain, block.GetBlockTime(), dbp != nullptr)) {\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        // this avoids over accounting for the serialization header on existing blocks. such over accounting was a long\n+        // standing bug that added undesirable 8 byte gaps into blk data files following a -reindex operation.\n+        // for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r865242559",
      "id" : 865242559,
      "in_reply_to_id" : 864136131,
      "line" : 804,
      "node_id" : "PRRC_kwDOABII584zko2_",
      "original_commit_id" : "425fc8813307b8d96a48e4b45d0a7b00bbc2289e",
      "original_line" : 804,
      "original_position" : 31,
      "original_start_line" : 798,
      "path" : "src/node/blockstorage.cpp",
      "position" : 31,
      "pull_request_review_id" : 962439209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865242559/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 798,
      "start_side" : "RIGHT",
      "updated_at" : "2022-05-04T19:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/865242559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ryanofsky Thanks for the review. I've put updates related to your comments into 011f6ec54fffb7600ae300851cc9816423f3f4dd. I'll squash the commits after positive code review of these.\r\n\r\nI still like what I have in `SaveBlockToDisk` regarding what is passed into `FindBlockPos` for the second parameter, `nAddSize`. When the position and size is known, we pass that in. When only size is known, we pass in block size + header size because we know that's what we'll have to add to the file. And, by doing it this way, we don't have to re-adjust the known position on the way out of `SaveBlockToDisk`. We will never pass the same position into `FindBlockPos` for a given block because we either don't know the position, or we pass in where we found the block. The only question is whether we should pass in the positon  that `FindBlockPos` previously returned. I don't see the advantage to doing that because it's kind of like trying to pretend that we don't know what we do know.",
      "created_at" : "2022-05-05T08:03:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1118276909",
      "id" : 1118276909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Cp40t",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1118276909/reactions"
      },
      "updated_at" : "2022-05-05T08:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1118276909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\n(The linter needs appeasing when you repush; consider presenting this pull in its intended final form to ease review.)\r\n```\r\nThe subject line of commit hash 011f6ec54fffb7600ae300851cc9816423f3f4dd is followed by a non-empty line. Subject lines should always be followed by a blank line.\r\n```\r\n",
      "created_at" : "2022-05-05T08:08:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1118281119",
      "id" : 1118281119,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Cp52f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1118281119/reactions"
      },
      "updated_at" : "2022-05-05T08:08:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1118281119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r867349213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867349213"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for looking at this. I agree, it's likely an overly broad try-catch block and that it's difficult to reason about what types of exceptions might be thrown, and from where, since there is no compile time concept of \"checked\" exceptions, like in Java. This is why I don't want to try changing it for this PR :-) I'm sure I'll miss something and it'll break at runtime. And, it'll just make the patch larger without impacting the usefulness of this specific fix.\r\n\r\nI can see that `blkdat >> block;` will throw at least `std::ios_base::failure` from at least a couple different places within the deserialization code. These are the exceptions that the original issue reported.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-05-07T12:54:09Z",
      "diff_hunk" : "@@ -4356,7 +4356,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r867349213",
      "id" : 867349213,
      "in_reply_to_id" : 854234515,
      "line" : 4380,
      "node_id" : "PRRC_kwDOABII584zsrLd",
      "original_commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "original_line" : 4380,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 3,
      "pull_request_review_id" : 965329304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867349213/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-07T12:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867349213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ok, i squashed the commits and rebased onto the latest master. bcb0cacac28e98a39dc856c574a0872fe17059e9 is the latest \r\n after working through the feedback. i tested and it still looks good.",
      "created_at" : "2022-05-07T13:07:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1120206793",
      "id" : 1120206793,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585CxP_J",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1120206793/reactions"
      },
      "updated_at" : "2022-05-07T13:07:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1120206793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "just to summarize, i think bcb0cacac28e98a39dc856c574a0872fe17059e9 is the final form of this patch. it's a small, targeted, and uncomplicated bug fix. i think that if we can get some final reviews that this would be ready to merge. thanks!",
      "created_at" : "2022-05-12T09:52:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1124789132",
      "id" : 1124789132,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585DCuuM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124789132/reactions"
      },
      "updated_at" : "2022-05-12T09:52:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124789132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Is there anything that I can do to get this merged? It's ready to merge as far as I can tell.",
      "created_at" : "2022-06-07T10:39:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1148496050",
      "id" : 1148496050,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585EdKiy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1148496050/reactions"
      },
      "updated_at" : "2022-06-07T10:39:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1148496050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r895769516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895769516"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"reindex, log, test: fixes #21379\" (bcb0cacac28e98a39dc856c574a0872fe17059e9)\r\n\r\nThis comment doesn't address the confusing thing here because it doesn't say why nBlockSize is set to different sizes for the same block depending on position_known. Would suggest a comment that says why the code is using a different size in each case. Could use:\r\n\r\n```c++\r\n// When position_known is false, the CBlock has not been written to the\r\n// disk yet, so the nBlockSize value passed to FindBlockPos needs to be\r\n// set so FindBlockPos allocates enough bytes for the CBlock data *plus*\r\n// the size of the header WriteBlockToDisk will write before the CBlock\r\n// data.\r\n//\r\n// When position_known is true, WriteBlockToDisk will have already been\r\n// called, and it will have adjusted blockPos.nPos to point to the CBlock\r\n// data after the header, instead of to the header, so the nBlockSize\r\n// value passed to FindBlockPos should only include the CBlock size,\r\n// *not* the header size.\r\n```\r\n\r\nI still prefer the approach of passing a consistent size and position to FindBlockPos like https://github.com/ryanofsky/bitcoin/commit/07c05a1b24bf42e57f8c229f505ed448a6df81f7 instead of dealing with an inconsistent position value by introducing an inconsistent size value. But both approaches have the same ultimate effect, so the more important thing is to document the code clearly.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-06-13T14:13:47Z",
      "diff_hunk" : "@@ -788,19 +788,24 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r895769516",
      "id" : 895769516,
      "line" : 802,
      "node_id" : "PRRC_kwDOABII5841ZFus",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 802,
      "original_position" : 17,
      "original_start_line" : 799,
      "path" : "src/node/blockstorage.cpp",
      "position" : 17,
      "pull_request_review_id" : 1004412712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895769516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 799,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-13T16:32:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895769516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r896649670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/896649670"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "First, thanks for the feedback. While I'm not opposed to adding these comments if they help get this merged, I'd rather let the commit stay as it is so that the reviews can accumulate and we can get this stuff merged.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-06-14T10:27:24Z",
      "diff_hunk" : "@@ -788,19 +788,24 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r896649670",
      "id" : 896649670,
      "in_reply_to_id" : 895769516,
      "line" : 802,
      "node_id" : "PRRC_kwDOABII5841ccnG",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 802,
      "original_position" : 17,
      "original_start_line" : 799,
      "path" : "src/node/blockstorage.cpp",
      "position" : 17,
      "pull_request_review_id" : 1005619441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/896649670/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 799,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-14T10:27:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/896649670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ryanofsky Thanks for the code review ACK!\r\n\r\nI appreciate your comments and I spent quite a while responding to them.\r\nIn the end, I decided not to post my responses in order to avoid confusion and focus on this being ready to merge.\r\nI hear you though. I think we accomplish the same result just in a pretty minorly different way that comes down to personal preference.",
      "created_at" : "2022-06-14T10:31:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1155006934",
      "id" : 1155006934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585E2AHW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1155006934/reactions"
      },
      "updated_at" : "2022-06-14T10:31:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1155006934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913299788"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913299788"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: With the convention [\"`<source_filename>_tests.cpp`\"](https://github.com/bitcoin/bitcoin/blob/87d012324afa285221073540781295f1b7381a15/src/test/README.md?plain=1#L64), the name of the file/test suite should be `blockstorage_tests`.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-05T00:00:55Z",
      "diff_hunk" : "@@ -0,0 +1,42 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <node/blockstorage.h>\n+#include <node/context.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+#include <test/util/setup_common.h>\n+\n+using node::BlockManager;\n+using node::BLOCK_SERIALIZATION_HEADER_SIZE;\n+\n+// use BasicTestingSetup here for the data directory configuration, setup, and cleanup\n+BOOST_FIXTURE_TEST_SUITE(blockmanager_tests, BasicTestingSetup)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913299788",
      "id" : 913299788,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII5842b9lM",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 17,
      "pull_request_review_id" : 1027938042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913299788/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-05T04:48:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913299788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913361932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913361932"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I would drop the last two sentences (seems a bit verbose and out of place to explain what reindex is not and what studious node operators may do),  and I find long comments like this one easier to read when full sentences start with capitals.\r\n",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-05T03:43:58Z",
      "diff_hunk" : "@@ -4378,7 +4378,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {\n-                LogPrintf(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\n+                // historical bugs added extra data to the block files that does not deserialize cleanly.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913361932",
      "id" : 913361932,
      "line" : 4381,
      "node_id" : "PRRC_kwDOABII5842cMwM",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 4381,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 1027938042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913361932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-05T04:48:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913361932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913370952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913370952"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I also think this comment would be helpful, except for the point below.\r\n\r\n> ```c++\r\n> // When position_known is true, WriteBlockToDisk will have already been\r\n> // called, and it will have adjusted blockPos.nPos to point to the CBlock\r\n> // data after the header\r\n> ```\r\nIsn't this incorrect? My understanding is that when `position_known` is true, `blockPos.nPos` was set by the `LoadExternalBlockFile` code which has read past the header in the existing block file and moved the position accordingly - but not `WriteBlockToDisk`, which wasn't called for this block at all during this invocation of `bitcoind`.\r\n",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-05T04:13:15Z",
      "diff_hunk" : "@@ -788,19 +788,24 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913370952",
      "id" : 913370952,
      "in_reply_to_id" : 895769516,
      "line" : 802,
      "node_id" : "PRRC_kwDOABII5842cO9I",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 802,
      "original_position" : 17,
      "original_start_line" : 799,
      "path" : "src/node/blockstorage.cpp",
      "position" : 17,
      "pull_request_review_id" : 1027938042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913370952/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 799,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-05T04:52:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913370952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913376464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913376464"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Just from reading this comment it's not clear to me why this function is even called when the block is already on disk - it apparently doesn't need to be stored in that case.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-05T04:30:32Z",
      "diff_hunk" : "@@ -171,6 +174,7 @@ class BlockManager\n     bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams)\n         EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    /** Store block on disk. If dbp is not nullptr, then it provides the known position of the block within a block file on disk. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913376464",
      "id" : 913376464,
      "line" : 177,
      "node_id" : "PRRC_kwDOABII5842cQTQ",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 177,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 14,
      "pull_request_review_id" : 1027938042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913376464/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-05T05:12:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913376464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913943497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913943497"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913370952\r\n\r\n> > ```c++\r\n> > // When position_known is true, WriteBlockToDisk will have already been\r\n> > // called, and it will have adjusted blockPos.nPos to point to the CBlock\r\n> > // data after the header\r\n> > ```\r\n> \r\n> Isn't this incorrect?\r\n\r\nI think it is correct ð. The line that changes `blockPos.nPos` to point after the header instead of before the header is here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/9fb2a2bc6768ab03fcada9155d52a16ce6f6a0cc/src/node/blockstorage.cpp#L676\r\n\r\nThis is the critical code calculating the block position which is saved in the `CBlockIndex` struct, and written to BlockIndexDb and used when `ReadBlockFromDisk` is called to read back block data.\r\n\r\n> My understanding is that when `position_known` is true, `blockPos.nPos` was set by the `LoadExternalBlockFile` code which has read past the header in the existing block file and moved the position accordingly\r\n\r\nI don't think `LoadExternalBlockFile` is relevant to normal operation, only used when importing or reindexing is requested.\r\n\r\n> but not `WriteBlockToDisk`, which wasn't called for this block at all during this invocation of `bitcoind`.\r\n\r\nIt's true that `WriteBlockToDisk` may or may not have been called during this invocation of `bitcoind`, but it must have been called previously at some point, and the position it returns is written to BlockIndexDb and used to read blocks in future invocations.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-05T15:42:12Z",
      "diff_hunk" : "@@ -788,19 +788,24 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913943497",
      "id" : 913943497,
      "in_reply_to_id" : 895769516,
      "line" : 802,
      "node_id" : "PRRC_kwDOABII5842eavJ",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 802,
      "original_position" : 17,
      "original_start_line" : 799,
      "path" : "src/node/blockstorage.cpp",
      "position" : 17,
      "pull_request_review_id" : 1028847814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913943497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 799,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-05T15:42:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913943497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913997594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913997594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, but the suggested comment is not in `ReadBlockFromDisk` but in `SaveBlockToDisk`, and it is about the case when \"position_known is true\", or `dbp != nullptr`. I think this is only possible when this function is called via `AcceptBlock()` from `LoadExternalBlockFile` which has set the blockPos - the normal operation calls to `SaveBlockToDisk` (via `AcceptBlock()` and `ProcessNewBlock()`) have `dbp==nullptr`, so `position_known` is false and the other half of the comment applies.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-05T16:42:36Z",
      "diff_hunk" : "@@ -788,19 +788,24 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r913997594",
      "id" : 913997594,
      "in_reply_to_id" : 895769516,
      "line" : 802,
      "node_id" : "PRRC_kwDOABII5842en8a",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 802,
      "original_position" : 17,
      "original_start_line" : 799,
      "path" : "src/node/blockstorage.cpp",
      "position" : 17,
      "pull_request_review_id" : 1028924036,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913997594/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 799,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-05T16:42:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/913997594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r914027908"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/914027908"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sure, if you feel it is more useful for the comment to go into those things, feel free to make a suggestion along those lines. My suggestion was rejected anyway so maybe you will have better luck.\r\n\r\nAlso, I wrote this comment to describe a piece of code that I think is unnecessarily confusing. I would personally prefer not to have this piece of code, and not to have this comment explaining it, and instead use a solution like https://github.com/ryanofsky/bitcoin/commit/07c05a1b24bf42e57f8c229f505ed448a6df81f7 which does not require understanding external places where `SaveBlockToDisk` is called to understand, and only requires understanding internally how it always returns the same position.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-05T17:21:20Z",
      "diff_hunk" : "@@ -788,19 +788,24 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r914027908",
      "id" : 914027908,
      "in_reply_to_id" : 895769516,
      "line" : 802,
      "node_id" : "PRRC_kwDOABII5842evWE",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 802,
      "original_position" : 17,
      "original_start_line" : 799,
      "path" : "src/node/blockstorage.cpp",
      "position" : 17,
      "pull_request_review_id" : 1028965947,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/914027908/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 799,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-05T17:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/914027908",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r915032603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915032603"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't have a strong preference - it seems that both approaches only affect the blockstorage-internal logic, and since neither solution changes the public interface `SaveBlockToDisk`, this sholdn't change what external places will need to know: In particular, that if they pass `dbp!=nullptr`, dbp needs to point right after the header and before the block data (which should be documented in `SaveBlockToDisk` imo).\r\n\r\nHowever, I think that the internal function `FindBlockPos()` would be clearer if it was split up depending on whether the block is known, with so much code being conditional on it: If `dbp!=nullptr` , the function doesn't \"find\" anything new but only updates the block info statistics (and sometimes does a Flush which I'm not convinced is necessary). I had an initial go at this in https://github.com/mzumsande/bitcoin/commits/202207_refactor_findblockpos , which is outside the scope of this PR, but might make sense as a follow-up.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-06T16:20:56Z",
      "diff_hunk" : "@@ -788,19 +788,24 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r915032603",
      "id" : 915032603,
      "in_reply_to_id" : 895769516,
      "line" : 802,
      "node_id" : "PRRC_kwDOABII5842ikob",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 802,
      "original_position" : 17,
      "original_start_line" : 799,
      "path" : "src/node/blockstorage.cpp",
      "position" : 17,
      "pull_request_review_id" : 1030374634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915032603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 799,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-06T16:20:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915032603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r928166861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/928166861"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, if you retouch (bcb0cacac28e98a39dc856c574a0872fe17059e9)\r\n```suggestion\r\n    const bool position_known{dbp != nullptr};\r\n```",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-23T21:31:42Z",
      "diff_hunk" : "@@ -788,19 +788,24 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r928166861",
      "id" : 928166861,
      "line" : 795,
      "node_id" : "PRRC_kwDOABII5843UrPN",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 795,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 10,
      "pull_request_review_id" : 1048570690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/928166861/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-27T01:39:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/928166861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r930542594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930542594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree with @ryanofsky's [comment](https://github.com/bitcoin/bitcoin/pull/24858/files#r895769516) (above) about consistency. I'd also note that adding 8 to `nBlockSize` is confusing because it's no longer a block size!",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-27T01:38:22Z",
      "diff_hunk" : "@@ -788,19 +788,24 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n     return true;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CChain& active_chain, const CChainParams& chainparams, const FlatFilePos* dbp)\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    if (dbp != nullptr) {\n+    const auto position_known {dbp != nullptr};\n+    if (position_known) {\n         blockPos = *dbp;\n+    } else {\n+        // when known, blockPos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes = BLOCK_SERIALIZATION_HEADER_SIZE).\n+        // we add BLOCK_SERIALIZATION_HEADER_SIZE only for new blocks since they will have the serialization header added when written to disk.\n+        nBlockSize += static_cast<unsigned int>(BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r930542594",
      "id" : 930542594,
      "in_reply_to_id" : 895769516,
      "line" : 802,
      "node_id" : "PRRC_kwDOABII5843dvQC",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 802,
      "original_position" : 17,
      "original_start_line" : 799,
      "path" : "src/node/blockstorage.cpp",
      "position" : 17,
      "pull_request_review_id" : 1048570690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930542594/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 799,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-27T14:40:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930542594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r930593528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930593528"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This test is slightly unrealistic because it's simulating a normal (new) block add followed by a reindex. A reindex, if it occurs, always happens immediately after the node starts up, before any blocks have been added from peers. As a result of this, this (the second) test call to `SaveBlockToDisk` causes `m_blockfile_info.nBlocks` to increment to 2 [here](https://github.com/bitcoin/bitcoin/blob/6dc3084eec912cf2abfe18d1c05655defaa45e20/src/node/blockstorage.cpp#L615), which is strange, since there's only one block. \r\n\r\nThis doesn't cause any problems now, but some future change could cause this test to break in mysterious ways. \r\n\r\nA way to fix this would be to allocate a new `BlockManager` (and probably `CChain`) for this call, to simulate restarting the node. (The third call to `SaveBlockToDisk`, below, can use the same ones as this one does, because following a reindex, the real node does go ahead and start adding new blocks.)\r\n\r\nIn case it's not clear, I updated that [commit](https://github.com/LarryRuane/bitcoin/commit/e8b90d475b193c1c1b1a74d7751c9ec830c82867) (containing other suggestions) to show what I mean.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-07-27T03:53:19Z",
      "diff_hunk" : "@@ -0,0 +1,42 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <node/blockstorage.h>\n+#include <node/context.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+#include <test/util/setup_common.h>\n+\n+using node::BlockManager;\n+using node::BLOCK_SERIALIZATION_HEADER_SIZE;\n+\n+// use BasicTestingSetup here for the data directory configuration, setup, and cleanup\n+BOOST_FIXTURE_TEST_SUITE(blockmanager_tests, BasicTestingSetup)\n+\n+BOOST_AUTO_TEST_CASE(blockmanager_find_block_pos)\n+{\n+    const auto params {CreateChainParams(ArgsManager{}, CBaseChainParams::MAIN)};\n+    BlockManager blockman {};\n+    CChain chain {};\n+    // simulate adding a genesis block normally\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, *params, nullptr).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);\n+    // simulate what happens during reindex\n+    // simulate a well-formed genesis block being found at offset 8 in the blk00000.dat file\n+    // the block is found at offset 8 because there is an 8 byte serialization header\n+    // consisting of 4 magic bytes + 4 length bytes before each block in a well-formed blk file.\n+    FlatFilePos pos{0, BLOCK_SERIALIZATION_HEADER_SIZE};\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, *params, &pos).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r930593528",
      "id" : 930593528,
      "line" : 31,
      "node_id" : "PRRC_kwDOABII5843d7r4",
      "original_commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "original_line" : 31,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 31,
      "pull_request_review_id" : 1051852827,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930593528/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-27T03:53:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/930593528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think this would be a good bug to fix, so it would be nice to see some progress here. @mruddy do you think you'll be able to address some of the outstanding feedback? I think it might be good to at least incorporate some of the clarifying commentary that @ryanofsky proposed.\r\n\r\nThis PR is a step in the right direction; the fix could possibly clearer, along the lines of what @ryanofsky or @LarryRuane have suggested. But in any case, one of these approaches should be committed to, reviewed, and merged (with credit to @mruddy in any case for proposing the conceptual solution).\r\n\r\nEdit: to be clear, merging this PR as-is would be a big improvement over the current state of things. I think we're bikeshedding a little at this point, and a follow-up could be done if necessary. ",
      "created_at" : "2022-08-04T19:57:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1205707862",
      "id" : 1205707862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585H3aRW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1205707862/reactions"
      },
      "updated_at" : "2022-08-04T20:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1205707862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2022-08-05T10:07:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1206278126",
      "id" : 1206278126,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585H5lfu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1206278126/reactions"
      },
      "updated_at" : "2022-10-06T00:04:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1206278126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If I have to change something, then I'd probably go back in the direction that @LarryRuane suggested with e8b90d475b193c1c1b1a74d7751c9ec830c82867. I'd have to review and test those changes closer, but at a glance, they seem plausible. They are close to my original fix in that they keep the change within `FindBlockPos`. I changed to the current approach trying to be responsive to feedback in April. I'd probably avoid adding comments in any potential future commit as those seem to cause a relatively large amount of friction. The current commit has gathered review, testing, and works, so I hate to start the process all over again. But, if this fix isn't going to get merged for some reason, then let me know and I'll do it.",
      "created_at" : "2022-08-10T19:50:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1211195961",
      "id" : 1211195961,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585IMWI5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1211195961/reactions"
      },
      "updated_at" : "2022-08-10T19:50:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1211195961",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tested code-review ACK bcb0cacac28e98a39dc856c574a0872fe17059e9\r\nI strongly agree with [@jamesob](https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1205707862), this should get merged asap; any possible improvements can be done in a follow-up PR. My apologies for stirring the pot too much!",
      "created_at" : "2022-08-13T01:31:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1213627499",
      "id" : 1213627499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585IVnxr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1213627499/reactions"
      },
      "updated_at" : "2022-08-13T01:31:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1213627499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think this is ready for merge.",
      "created_at" : "2022-10-12T14:35:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1276286709",
      "id" : 1276286709,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585MEpb1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1276286709/reactions"
      },
      "updated_at" : "2022-10-12T14:35:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1276286709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r994533957"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/994533957"
         }
      },
      "author_association" : "MEMBER",
      "body" : "unrelated: If the intent is to hide this, it would be good to clarify the log level. Currently it defaults to INFO, which is hidden, but this might be about to change, so maybe DEBUG might be better? cc @jonatack Not sure what the plan on the log levels currently is.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-10-13T11:41:02Z",
      "diff_hunk" : "@@ -4356,7 +4356,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {\n-                LogPrintf(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\n+                // historical bugs added extra data to the block files that does not deserialize cleanly.\n+                // commonly this data is between readable blocks, but it does not really matter. such data is not fatal to the import process.\n+                // the code that reads the block files deals with invalid data by simply ignoring it.\n+                // it continues to search for the next {4 byte magic message start bytes + 4 byte length + block} that does deserialize cleanly\n+                // and passes all of the other block validation checks dealing with POW and the merkle root, etc...\n+                // we merely note with this informational log message when unexpected data is encountered.\n+                // we could also be experiencing a storage system read error, or a read of a previous bad write. these are possible, but\n+                // less likely scenarios. we don't have enough information to tell a difference here.\n+                // the reindex process is not the place to attempt to clean and/or compact the block files. if so desired, a studious node operator\n+                // may use knowledge of the fact that the block files are not entirely pristine in order to prepare a set of pristine, and\n+                // perhaps ordered, block files for later reindexing.\n+                LogPrint(BCLog::REINDEX, \"%s: unexpected data at file offset 0x%x - %s. continuing\\n\", __func__, (nRewind - 1), e.what());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r994533957",
      "id" : 994533957,
      "in_reply_to_id" : 852471681,
      "line" : 4392,
      "node_id" : "PRRC_kwDOABII5847R2JF",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 4392,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 1140624261,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/994533957/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-13T11:41:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/994533957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r994667976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/994667976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The default loglevel is currently debug and will become info.\n\nWarning and error levels are currently logged unconditionally, and the plan is to log info unconditionally as well.\n\nI've made a note to check this in the severity logging updates.",
      "commit_id" : "bcb0cacac28e98a39dc856c574a0872fe17059e9",
      "created_at" : "2022-10-13T13:46:14Z",
      "diff_hunk" : "@@ -4356,7 +4356,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {\n-                LogPrintf(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\n+                // historical bugs added extra data to the block files that does not deserialize cleanly.\n+                // commonly this data is between readable blocks, but it does not really matter. such data is not fatal to the import process.\n+                // the code that reads the block files deals with invalid data by simply ignoring it.\n+                // it continues to search for the next {4 byte magic message start bytes + 4 byte length + block} that does deserialize cleanly\n+                // and passes all of the other block validation checks dealing with POW and the merkle root, etc...\n+                // we merely note with this informational log message when unexpected data is encountered.\n+                // we could also be experiencing a storage system read error, or a read of a previous bad write. these are possible, but\n+                // less likely scenarios. we don't have enough information to tell a difference here.\n+                // the reindex process is not the place to attempt to clean and/or compact the block files. if so desired, a studious node operator\n+                // may use knowledge of the fact that the block files are not entirely pristine in order to prepare a set of pristine, and\n+                // perhaps ordered, block files for later reindexing.\n+                LogPrint(BCLog::REINDEX, \"%s: unexpected data at file offset 0x%x - %s. continuing\\n\", __func__, (nRewind - 1), e.what());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r994667976",
      "id" : 994667976,
      "in_reply_to_id" : 852471681,
      "line" : 4392,
      "node_id" : "PRRC_kwDOABII5847SW3I",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 4392,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 1140828223,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/994667976/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-13T13:46:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/994667976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
