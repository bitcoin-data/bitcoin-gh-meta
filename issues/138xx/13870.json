{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "I am creating a php script to use the sendmany() call to bitcoind. After some database calisthenics involving hitting three tables for permissions, checking user privileges and ensuring the send amounts are correct and there are enough bitcoins on the server, I wind up with the following array to send bitcoins to:\r\n\r\n\r\n    Array\r\n    (\r\n        [0] => Array\r\n            (\r\n                [coinadd] => mteCLqiEK7v5d3YbDQtxj8oKcdhtHRtXcw\r\n                [amount] => 0.21445033\r\n            )\r\n    \r\n        [1] => Array\r\n            (\r\n                [coinadd] => 2N5aa9FBxGf5xmeLiDz1yJVNYdsfK9GUWWe\r\n                [amount] => 0.02588679\r\n            )\r\n    \r\n        [2] => Array\r\n            (\r\n                [coinadd] => 2Muf4WEzFqNviURTdvkGSswHyrgMzR8optK\r\n                [amount] => 0.02601681\r\n            )\r\n    \r\n    )\r\n\r\nThe below foreach generates the array below that.\r\n\r\n\tforeach($paydata as $pay){\r\n\t\t$mrules = getmerchrules($pay['merchant_id']);\r\n\t\t$coinadd = get_merch_address_to_send_to($pay['merchant_id']);\r\n\t\tif($mrules['autopay'] == 'yes'){\r\n\t\t\tif($pay['balance'] > $mrules['minpay']){\r\n\t\t\t\tif($coinadd !== ''){\r\n\t\t\t\t\t$paynow[$coinadd['coinadd']] = $pay['balance'];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n    Array\r\n    (\r\n        [mteCLqiEK7v5d3YbDQtxj8oKcdhtHRtXcw] => 0.21445033\r\n        [2N5aa9FBxGf5xmeLiDz1yJVNYdsfK9GUWWe] => 0.02588679\r\n        [2Muf4WEzFqNviURTdvkGSswHyrgMzR8optK] => 0.02601681\r\n    )\r\n\r\nSo far so good.\r\n\r\nNow on to the RPC call\r\n\r\n\t\r\nhere's the request echoed from the actual easybitcoin curl call.  -- \r\n```\r\necho \"here's the request -- \\n\".$request.\"\\n\"; <-- line 132 easybitcoin.php\r\n\r\n{\"method\":\"sendmany\",\"params\":[\"\",\"{\\\"mteCLqiEK7v5d3YbDQtxj8oKcdhtHRtXcw\\\":\\\"0.24020698\\\",\\\"2N5aa9FBxGf5xmeLiDz1yJVNYdsfK9GUWWe\\\":\\\"0.02588679\\\",\\\"2Muf4WEzFqNviURTdvkGSswHyrgMzR8optK\\\":\\\"0.02601681\\\"}\",1],\"id\":4}\r\n```\r\n\r\n\r\n**EDIT: Some fancy echoing gets me this string which is what is actually sent to the bitcoind server through curl. This string also passes the jsonlint.com test.**\r\n\r\n    Array\r\n    (\r\n        [19913] => 1\r\n        [52] => 1\r\n        [68] => 10\r\n        [10023] => Array\r\n            (\r\n                [0] => Content-type: application/json\r\n            )\r\n    \r\n        [47] => 1\r\n        [10015] => {\"method\":\"sendmany\",\"params\":[\"\",\"{\\\"mteCLqiEK7v5d3YbDQtxj8oKcdhtHRtXcw\\\":\\\"0.24020698\\\",\\\"2N5aa9FBxGf5xmeLiDz1yJVNYdsfK9GUWWe\\\":\\\"0.02588679\\\",\\\"2Muf4WEzFqNviURTdvkGSswHyrgMzR8optK\\\":\\\"0.02601681\\\"}\",1],\"id\":4}\r\n    )\r\n\r\n**EDIT: STILL NO CHANGE**\r\n\r\n    Array\r\n    (\r\n        [result] => \r\n        [error] => Array\r\n            (\r\n                [code] => -1\r\n                [message] => JSON value is not an object as expected\r\n            )\r\n    \r\n        [id] => 4\r\n    )\r\n\r\nAaaand Kablooie!\r\nI get the following error from Bitcoind:\r\n\r\n\"JSON value is not an array as expected\"\r\n\r\nIf I turn the JSON string into an object, then the error switches to \r\n\r\n\"JSON value is not an object as expected\".\r\n\r\nThis snippet of code is from the library's __call method in easybitcoin.php\r\n\r\n\r\n    // If no parameters are passed, this will be an empty array\r\n    $params = array_values($params);\r\n    \r\n    ...\r\n    \r\n    // Build the request, it's ok that params might have any empty array\r\n    $request = json_encode(array(\r\n        'method' => $method,\r\n        'params' => $params,\r\n        'id'     => $this->id\r\n    ));\r\n\r\nOther than slitting my wrists and offering my blood to the programming gods, I've done everything I can think of. Can anyone spot what I am doing wrong here?\r\n\r\nFor anyone wondering, this command worked on ./bitcoin-cli\r\n\r\n    ./bitcoin-cli sendmany \"\" \"{\\\"mteCLqiEK7v5d3YbDQtxj8oKcdhtHRtXcw\\\":0.21445033, \\\"2N5aa9FBxGf5xmeLiDz1yJVNYdsfK9GUWWe\\\":0.02588679, \\\"2Muf4WEzFqNviURTdvkGSswHyrgMzR8optK\\\":0.02601681}\" 1\r\n\r\nBitcoind response is a txid number\r\n\r\nf4c443881a40054efbd5c3064268a91253f4cb2f7ba8caca96878d0dec46d774\r\n\r\n\r\n\r\n<!-- This issue tracker is only for technical issues related to Bitcoin Core.\r\n\r\nGeneral bitcoin questions and/or support requests are best directed to the Bitcoin StackExchange at https://bitcoin.stackexchange.com.\r\n\r\nFor reporting security issues, please read instructions at https://bitcoincore.org/en/contact/.\r\n\r\nIf the node is \"stuck\" during sync or giving \"block checksum mismatch\" errors, please ensure your hardware is stable by running memtest and observe CPU temperature with a load-test tool such as linpack before creating an issue! -->\r\n\r\n<!-- Describe the issue -->\r\n<!--- What behavior did you expect? -->\r\n\r\n<!--- What was the actual behavior (provide screenshots if the issue is GUI-related)? -->\r\n\r\n<!--- How reliably can you reproduce the issue, what are the steps to do so? -->\r\n\r\n<!-- What version of Bitcoin Core are you using, where did you get it (website, self-compiled, etc)? -->\r\n\r\n<!-- What type of machine are you observing the error on (OS/CPU and disk type)? -->\r\n\r\n<!-- Any extra information that might be useful in the debugging process. -->\r\n<!--- This is normally the contents of a `debug.log` or `config.log` file. Raw text or a link to a pastebin type site are preferred. -->\r\n",
   "closed_at" : "2018-08-03T22:31:32Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
      "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
      "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/MarcoFalke",
      "id" : 6399679,
      "login" : "MarcoFalke",
      "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
      "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
      "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
      "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/MarcoFalke"
   },
   "comments" : 4,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13870/comments",
   "created_at" : "2018-08-03T22:28:41Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13870/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/13870",
   "id" : 347553354,
   "labels" : [
      {
         "color" : "006688",
         "default" : false,
         "id" : 477890092,
         "name" : "Questions and Help",
         "node_id" : "MDU6TGFiZWw0Nzc4OTAwOTI=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Questions%20and%20Help"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13870/labels{/name}",
   "locked" : true,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUzNDc1NTMzNTQ=",
   "number" : 13870,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Bitcoind returns error âJSON value is not an array as expectedâ, using easybitcoin.php to call sendmany()",
   "updated_at" : "2018-08-04T02:32:13Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13870",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/25734007?v=4",
      "events_url" : "https://api.github.com/users/rhinogroup/events{/privacy}",
      "followers_url" : "https://api.github.com/users/rhinogroup/followers",
      "following_url" : "https://api.github.com/users/rhinogroup/following{/other_user}",
      "gists_url" : "https://api.github.com/users/rhinogroup/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/rhinogroup",
      "id" : 25734007,
      "login" : "rhinogroup",
      "node_id" : "MDQ6VXNlcjI1NzM0MDA3",
      "organizations_url" : "https://api.github.com/users/rhinogroup/orgs",
      "received_events_url" : "https://api.github.com/users/rhinogroup/received_events",
      "repos_url" : "https://api.github.com/users/rhinogroup/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/rhinogroup/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/rhinogroup/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/rhinogroup"
   }
}
