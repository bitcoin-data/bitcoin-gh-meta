{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "Just writing down some thoughts on this.\r\n\r\nI find it quite counter-intuitive that if you have a 1 BTC output and make a transaction spending 0.01 BTC and sending 0.99 BTC back to yourself in change, that unless that transaction is in your mempool, your balance drops from 1 to 0.   Unconfirmed change in the mempool appears in available balance (assuming we can spend 0-conf change), but if it is not in the mempool it is not reflected at all, but the output spent in the transaction is still spent.\r\n\r\nThis can occur because walletbroadcast=0 and you're delaying broadcast or using another broadcast method or because the initial transaction was evicted.  In either case though it doesn't make sense to count the entire input as spent but not credit the change output.\r\n\r\nI believe it would make sense to include the unconfirmed non-mempool change in the pending balance.\r\n\r\nUnfortunately this is non-trivial.  This can best be seen by the example of two transactions in the wallet that spend the same input.  Naively you'd double count the change, which is clearly wrong.  It's non-obvious which change you should count nor how you would go about implementing that if you did have a plan.  One idea would be if you had a mempool package acceptance test (ala @sdaftuar) you could try to add all non-mempooled wallet transactions incrementally in time order, and take the resulting putative mempool state as what would count.  But its starting to get a bit cumbersome.  Another idea would be to check the unconfirmed non-mempool change for potential conflicts and only count the smallest change.\r\n\r\nThere are other aspects of trickiness such as mixed debit transactions.\r\n\r\n\r\n\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 2,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11887/comments",
   "created_at" : "2017-12-13T17:53:22Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11887/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/11887",
   "id" : 281840489,
   "labels" : [
      {
         "color" : "ebd775",
         "default" : false,
         "id" : 64584,
         "name" : "Brainstorming",
         "node_id" : "MDU6TGFiZWw2NDU4NA==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming"
      },
      {
         "color" : "08a781",
         "default" : false,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11887/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUyODE4NDA0ODk=",
   "number" : 11887,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Could the wallet count unconfirmed non-mempool change?",
   "updated_at" : "2018-01-09T20:16:38Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11887",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/4360349?v=4",
      "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
      "followers_url" : "https://api.github.com/users/morcos/followers",
      "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/morcos",
      "id" : 4360349,
      "login" : "morcos",
      "node_id" : "MDQ6VXNlcjQzNjAzNDk=",
      "organizations_url" : "https://api.github.com/users/morcos/orgs",
      "received_events_url" : "https://api.github.com/users/morcos/received_events",
      "repos_url" : "https://api.github.com/users/morcos/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/morcos"
   }
}
