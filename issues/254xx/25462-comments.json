[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-06-24T02:51:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25462#issuecomment-1165139833",
      "id" : 1165139833,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25462",
      "node_id" : "IC_kwDOABII585Fcp95",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1165139833/reactions"
      },
      "updated_at" : "2022-06-24T02:51:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1165139833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @mzumsande @ryanofsky ",
      "created_at" : "2022-06-24T09:07:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25462#issuecomment-1165368023",
      "id" : 1165368023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25462",
      "node_id" : "IC_kwDOABII585FdhrX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1165368023/reactions"
      },
      "updated_at" : "2022-06-24T09:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1165368023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I didn't see the conflict PR earlier #24230, but I _think_ it solves this issue by only registering on the validation interface once the initial sync is done",
      "created_at" : "2022-06-24T12:04:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25462#issuecomment-1165507314",
      "id" : 1165507314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25462",
      "node_id" : "IC_kwDOABII585FeDry",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1165507314/reactions"
      },
      "updated_at" : "2022-06-24T12:04:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1165507314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25462#discussion_r906057118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25462"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906057118"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"index: ignore BlockConnected if pindex is in chain\" (270579f85fbe8cf97a9f506a258ad3ed865fcbeb)\r\n\r\nComment is a little off. Should say \"If pindex in an ancestor of best_block_index\" not \"If best_block_index is an ancestor of pindex\"",
      "commit_id" : "270579f85fbe8cf97a9f506a258ad3ed865fcbeb",
      "created_at" : "2022-06-24T13:21:26Z",
      "diff_hunk" : "@@ -262,13 +264,27 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n                       best_block_index->GetBlockHash().ToString());\n             return;\n         }\n-        if (best_block_index != pindex->pprev && !Rewind(best_block_index, pindex->pprev)) {\n+\n+        // If best_block_index is an ancestor of pindex, then this is a block that we've already",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25462#discussion_r906057118",
      "id" : 906057118,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII5842AVWe",
      "original_commit_id" : "270579f85fbe8cf97a9f506a258ad3ed865fcbeb",
      "original_line" : 268,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 15,
      "pull_request_review_id" : 1018471425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25462",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906057118/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T13:58:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906057118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25462#discussion_r906061602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25462"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906061602"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"index: ignore BlockConnected if pindex is in chain\" (270579f85fbe8cf97a9f506a258ad3ed865fcbeb)\r\n\r\nSeems like code would be more straightforward without `skip_write` variable. Maybe just:\r\n\r\n```c++\r\nif (best_block_index->GetAncestor(pindex->nHeight) == pindex) {\r\n    LogPrintf(\"%s: WARNING: Block %s does is already-processed ancestor of \" /* Continued */\r\n              \"known best chain (tip=%s); not updating index\\n\",\r\n              __func__, pindex->GetBlockHash().ToString(),\r\n              best_block_index->GetBlockHash().ToString());\r\n    return;\r\n}\r\n```",
      "commit_id" : "270579f85fbe8cf97a9f506a258ad3ed865fcbeb",
      "created_at" : "2022-06-24T13:24:53Z",
      "diff_hunk" : "@@ -262,13 +264,27 @@ void BaseIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const\n                       best_block_index->GetBlockHash().ToString());\n             return;\n         }\n-        if (best_block_index != pindex->pprev && !Rewind(best_block_index, pindex->pprev)) {\n+\n+        // If best_block_index is an ancestor of pindex, then this is a block that we've already\n+        // processed. This can occur if the sync thread is almost done catching up, the tip\n+        // updates to the next block, and the sync thread finishes catching up to tip before\n+        // the BlockConnected event is received. If we've already seen it, there's no reason to\n+        // call Rewind, WriteBlock, and SetBestBlockIndex.\n+        if (best_block_index->GetAncestor(pindex->nHeight) == pindex) {\n+            skip_write = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25462#discussion_r906061602",
      "id" : 906061602,
      "line" : 274,
      "node_id" : "PRRC_kwDOABII5842AWci",
      "original_commit_id" : "270579f85fbe8cf97a9f506a258ad3ed865fcbeb",
      "original_line" : 274,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 21,
      "pull_request_review_id" : 1018471425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25462",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906061602/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T13:58:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906061602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Even if this happens it seems fine, but I would want to think a little more about whether there are other side effects from this change and be explicit about what they are in PR description or release notes.\r\n\r\nI checked each of the indexes behavior in this situation and it seems fine, but is not something I considered when opening the PR. I also didn't consider the multiple re-org case which this PR doesn't fix.\r\n\r\n> So I do think https://github.com/bitcoin/bitcoin/pull/24230 is a better long term fix. But still this PR could be a short term improvement\r\n\r\nAfter taking a look at #24230 and seeing that it fixes the racy issues with indexes and the validation interface queue, I don't think it makes much sense to have a short term change when there is a PR that fixes the root of the problem. So I think I'll close this unless you have a strong opinion about keeping this one?",
      "created_at" : "2022-06-26T12:28:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25462#issuecomment-1166517559",
      "id" : 1166517559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25462",
      "node_id" : "IC_kwDOABII585Fh6U3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1166517559/reactions"
      },
      "updated_at" : "2022-06-26T12:28:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1166517559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I checked each of the indexes behavior in this situation and it seems fine, but is not something I considered when opening the PR. I also didn't consider the multiple re-org case which this PR doesn't fix.\r\n\r\nYes, I think the index would just stay at the previous tip in case of `invalidateblock`, and I think that the RPC `gettxoutsetinfo` would keep on working correctly. However, this probably wouldn't go so well with the current save/load logic assumptions: With the coinstatsindex, the running muhash would stay at the old (now invalidated) tip. If you now stop the node, a locator corresponding to that old tip is saved. On next startup, we'd read that locator together with the muhash, call `FindForkInGlobalIndex()` and set the index' best block to the last valid block (before the invalidated one). So the muhash and the best block would be out of sync, and we'd probably throw an InitError [here](https://github.com/bitcoin/bitcoin/blob/0dd34773334c7f4db7b05df30ee61b011795b46d/src/index/coinstatsindex.cpp#L373).",
      "created_at" : "2022-06-26T20:51:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25462#issuecomment-1166642148",
      "id" : 1166642148,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25462",
      "node_id" : "IC_kwDOABII585FiYvk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1166642148/reactions"
      },
      "updated_at" : "2022-06-26T20:53:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1166642148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> With the coinstatsindex, the running muhash would stay at the old (now invalidated) tip. If you now stop the node, a locator corresponding to that old tip is saved.\r\n\r\nOh I didn't think about that, that would be bad.",
      "created_at" : "2022-06-27T12:47:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25462#issuecomment-1167310351",
      "id" : 1167310351,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25462",
      "node_id" : "IC_kwDOABII585Fk74P",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1167310351/reactions"
      },
      "updated_at" : "2022-06-27T12:47:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1167310351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   }
]
