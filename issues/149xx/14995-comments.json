[
   {
      "author_association" : "MEMBER",
      "body" : "@xuzhitong \r\n\r\nThanks a lot for reporting!\r\n\r\nWhat is the output of `bitcoind --version | head -1`?\r\n\r\nAre you able to reproduce this consistently? \r\n\r\nIf you start a fresh `bitcoind` instance and run your test script; will the issue trigger?",
      "created_at" : "2018-12-18T17:07:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14995#issuecomment-448295379",
      "id" : 448295379,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0ODI5NTM3OQ==",
      "updated_at" : "2018-12-18T17:07:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/448295379",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I checked the code,i found there is no log printed for this line\r\n\r\n@xuzhitong you have to give us more details Ã¢ÂÂÃ¯Â¸Â ",
      "created_at" : "2018-12-19T00:34:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14995#issuecomment-448424871",
      "id" : 448424871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0ODQyNDg3MQ==",
      "updated_at" : "2018-12-19T00:34:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/448424871",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> > I checked the code,i found there is no log printed for this line\r\n> \r\n> @xuzhitong you have to give us more details Ã¢ÂÂÃ¯Â¸Â\r\n\r\nOK.Sorry for not clear it.\r\nThe line is in function \"RPCRunLater\"  which called by \"walletpassphrase\" .\r\nThe code is below:\r\nvoid RPCRunLater(const std::string& name, std::function<void(void)> func, int64_t nSeconds)\r\n{\r\n    if (!timerInterface)\r\n        throw JSONRPCError(RPC_INTERNAL_ERROR, \"No timer handler registered for RPC\");\r\n    deadlineTimers.erase(name);\r\n    **LogPrint(BCLog::RPC, \"queue run of timer %s in %i seconds (using %s)\\n\", name, nSeconds, timerInterface->Name());**\r\n    deadlineTimers.emplace(name, std::unique_ptr<RPCTimerBase>(timerInterface->NewTimer(func, nSeconds*1000)));\r\n}\r\nstatic UniValue walletpassphrase(const JSONRPCRequest& request)\r\n{\r\n    std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(request);\r\n    CWallet* const pwallet = wallet.get();\r\n\r\n    if (!EnsureWalletIsAvailable(pwallet, request.fHelp)) {\r\n        return NullUniValue;\r\n    }\r\n    ......\r\n    LOCK2(cs_main, pwallet->cs_wallet);\r\n    if (!pwallet->IsCrypted()) {\r\n        throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, \"Error: running with an unencrypted wallet, but walletpassphrase was called.\");\r\n    }\r\n\r\n    // Note that the walletpassphrase is stored in request.params[0] which is not mlock()ed\r\n    SecureString strWalletPass;\r\n    strWalletPass.reserve(100);\r\n    // TODO: get rid of this .c_str() by implementing SecureString::operator=(std::string)\r\n    // Alternately, find a way to make request.params[0] mlock()'d to begin with.\r\n    strWalletPass = request.params[0].get_str().c_str();\r\n\r\n    // Get the timeout\r\n    int64_t nSleepTime = request.params[1].get_int64();\r\n    // Timeout cannot be negative, otherwise it will relock immediately\r\n    if (nSleepTime < 0) {\r\n        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Timeout cannot be negative.\");\r\n    }\r\n    // Clamp timeout\r\n    constexpr int64_t MAX_SLEEP_TIME = 100000000; // larger values trigger a macos/libevent bug?\r\n    if (nSleepTime > MAX_SLEEP_TIME) {\r\n        nSleepTime = MAX_SLEEP_TIME;\r\n    }\r\n\r\n    if (strWalletPass.length() > 0)\r\n    {\r\n        if (!pwallet->Unlock(strWalletPass)) {\r\n            throw JSONRPCError(RPC_WALLET_PASSPHRASE_INCORRECT, \"Error: The wallet passphrase entered was incorrect.\");\r\n        }\r\n    }\r\n    else\r\n        throw std::runtime_error(\r\n            \"walletpassphrase <passphrase> <timeout>\\n\"\r\n            \"Stores the wallet decryption key in memory for <timeout> seconds.\");\r\n\r\n    pwallet->TopUpKeyPool();\r\n\r\n    pwallet->nRelockTime = GetTime() + nSleepTime;\r\n    **RPCRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), std::bind(LockWallet, pwallet), nSleepTime);**\r\n\r\n    return NullUniValue;\r\n}",
      "created_at" : "2018-12-19T01:18:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14995#issuecomment-448433694",
      "id" : 448433694,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0ODQzMzY5NA==",
      "updated_at" : "2018-12-19T01:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/448433694",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/18006914?v=4",
         "events_url" : "https://api.github.com/users/xuzhitong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/xuzhitong/followers",
         "following_url" : "https://api.github.com/users/xuzhitong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/xuzhitong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/xuzhitong",
         "id" : 18006914,
         "login" : "xuzhitong",
         "node_id" : "MDQ6VXNlcjE4MDA2OTE0",
         "organizations_url" : "https://api.github.com/users/xuzhitong/orgs",
         "received_events_url" : "https://api.github.com/users/xuzhitong/received_events",
         "repos_url" : "https://api.github.com/users/xuzhitong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/xuzhitong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/xuzhitong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/xuzhitong"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> @xuzhitong\r\n> \r\n> Thanks a lot for reporting!\r\n> \r\n> What is the output of `bitcoind --version | head -1`?\r\n> \r\n> Are you able to reproduce this consistently?\r\n> \r\n> If you start a fresh `bitcoind` instance and run your test script; will the issue trigger?\r\n\r\nYes.The issue is not difficulty to reproduce in my test condition.I will try the newest version later. I compared the newest version code,but I didn't find any difference associated with \"walletpassphrase\".So i think the issue may be also exist in the fresh \"bitcoind\".",
      "created_at" : "2018-12-19T01:25:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14995#issuecomment-448435078",
      "id" : 448435078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0ODQzNTA3OA==",
      "updated_at" : "2018-12-19T01:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/448435078",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/18006914?v=4",
         "events_url" : "https://api.github.com/users/xuzhitong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/xuzhitong/followers",
         "following_url" : "https://api.github.com/users/xuzhitong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/xuzhitong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/xuzhitong",
         "id" : 18006914,
         "login" : "xuzhitong",
         "node_id" : "MDQ6VXNlcjE4MDA2OTE0",
         "organizations_url" : "https://api.github.com/users/xuzhitong/orgs",
         "received_events_url" : "https://api.github.com/users/xuzhitong/received_events",
         "repos_url" : "https://api.github.com/users/xuzhitong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/xuzhitong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/xuzhitong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/xuzhitong"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I mean, let us know what version you have.",
      "created_at" : "2018-12-19T07:44:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14995#issuecomment-448499680",
      "id" : 448499680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0ODQ5OTY4MA==",
      "updated_at" : "2018-12-19T07:44:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/448499680",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> I mean, let us know what version you have.\r\n\r\nThe version is 0.15.2.It's must be too old.But for some reason,i couldn't update the version to the newest.So if the issue has been repair in some version,please tell me,thanks very much!",
      "created_at" : "2018-12-19T11:56:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14995#issuecomment-448569148",
      "id" : 448569148,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0ODU2OTE0OA==",
      "updated_at" : "2018-12-19T11:56:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/448569148",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/18006914?v=4",
         "events_url" : "https://api.github.com/users/xuzhitong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/xuzhitong/followers",
         "following_url" : "https://api.github.com/users/xuzhitong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/xuzhitong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/xuzhitong",
         "id" : 18006914,
         "login" : "xuzhitong",
         "node_id" : "MDQ6VXNlcjE4MDA2OTE0",
         "organizations_url" : "https://api.github.com/users/xuzhitong/orgs",
         "received_events_url" : "https://api.github.com/users/xuzhitong/received_events",
         "repos_url" : "https://api.github.com/users/xuzhitong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/xuzhitong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/xuzhitong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/xuzhitong"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@xuzhitong The probability that this has been fixed since 0.15.2 is quite high, so please try to reproduce against the current version. Thanks for reporting!",
      "created_at" : "2018-12-19T12:10:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14995#issuecomment-448572419",
      "id" : 448572419,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0ODU3MjQxOQ==",
      "updated_at" : "2018-12-19T12:10:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/448572419",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> @xuzhitong The probability that this has been fixed since 0.15.2 is quite high, so please try to reproduce against the current version. Thanks for reporting!\r\n\r\nI compared the two version code and tried to merge the code  associated  with httprpc mutithread part.I noticed the significant modify is changing the boost thread call to std thread call.The merged files list are below:\r\nsync.h,sync.cpp,httprpc.cpp,init.cpp,rpc/mining.cpp.\r\nThen I make and upgrade to test the same scenario,but unfortunately the issue is also exist.\r\nI think the issue caused by erasing a pending(waiting cs_wallet lock)  timer from \"deadlinetimes\" map ,so i tried a fix using \"evtimer_pending\" and \"EV_PERSIST\" to check if the timer pending or active.If the timer is pending and the tv_out time is earlier than the current time,keep it in map,else,delete it.I found the issue has gone.I think it's not a very good way.Please help to confirm the issue.Thanks very much! ",
      "created_at" : "2018-12-20T10:46:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14995#issuecomment-448953884",
      "id" : 448953884,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0ODk1Mzg4NA==",
      "updated_at" : "2018-12-20T11:20:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/448953884",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/18006914?v=4",
         "events_url" : "https://api.github.com/users/xuzhitong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/xuzhitong/followers",
         "following_url" : "https://api.github.com/users/xuzhitong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/xuzhitong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/xuzhitong",
         "id" : 18006914,
         "login" : "xuzhitong",
         "node_id" : "MDQ6VXNlcjE4MDA2OTE0",
         "organizations_url" : "https://api.github.com/users/xuzhitong/orgs",
         "received_events_url" : "https://api.github.com/users/xuzhitong/received_events",
         "repos_url" : "https://api.github.com/users/xuzhitong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/xuzhitong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/xuzhitong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/xuzhitong"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@xuzhitong I'm afraid 0.19.1 still has this problem. FYI #18487 might fix the issue. Thanks for reporting!",
      "created_at" : "2020-03-31T23:34:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14995#issuecomment-606941293",
      "id" : 606941293,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjk0MTI5Mw==",
      "updated_at" : "2020-03-31T23:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606941293",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
