[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Over the last 24h i ran a blocks-only node that saw 106 blocks and downloaded 3.8MB in `cmpctblock` messages. Thats an average of 12KB bytes per `cmpctblock` message received from three high-bandwidth peers. Only 26KB would have been downloaded if `headers` messages would have been used instead.\r\nAssuming an average block size of 1.38MB the `cmpctblock` messages represented **2.5%** of downloaded block data.",
      "created_at" : "2021-06-26T15:12:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-869016710",
      "id" : 869016710,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTAxNjcxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-26T15:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869016710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery @amitiuttarwar @sipa @ajtowns Any thoughts?",
      "created_at" : "2021-07-01T02:46:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-871869724",
      "id" : 871869724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MTg2OTcyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-01T02:46:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/871869724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems workable? Compact blocks should be seeing:\r\n\r\n * 12kB for short tx ids per cmpctblock message announcing a new block (for each high bw peer per block)\r\n * 2kB per getblocktxn message asking for the tx data (per block)\r\n * ~0 overhead for blocktxn message providing the block txns\r\n\r\nWhich should be ~38kB per block or about 5MB per day/144 blocks. Legacy block relay should just be:\r\n\r\n * ~0 overhead for headers message\r\n * ~0 overhead for GETDATA MSG_BLOCK request\r\n * ~0 ovehead for BLOCK message\r\n\r\nSo this makes sense to me.",
      "created_at" : "2021-07-02T05:20:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-872723147",
      "id" : 872723147,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjcyMzE0Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T05:20:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872723147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r662872834"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662872834"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you can just exit this function immediately if `!m_ignore_incoming_txs`:\r\n\r\n```diff\r\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\r\n {\r\n     AssertLockHeld(cs_main);\r\n+\r\n+    // Never request high-bandwidth mode from peers if we're blocks-only. Our\r\n+    // mempool will not contain the transactions necessary to reconstruct the\r\n+    // compact block.\r\n+    if (m_ignore_incoming_txs) return;\r\n+\r\n     CNodeState* nodestate = State(nodeid);\r\n     if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\r\n         // Never ask from peers who can't provide witnesses.\r\n@@ -859,12 +865,10 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\r\n                 lNodesAnnouncingHeaderAndIDs.pop_front();\r\n             }\r\n \r\n-            if (!m_ignore_incoming_txs) {\r\n-                m_connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\r\n-                // save BIP152 bandwidth state: we select peer to be high-bandwidth\r\n-                pfrom->m_bip152_highbandwidth_to = true;\r\n-                lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\r\n-            }\r\n+            m_connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\r\n+            // save BIP152 bandwidth state: we select peer to be high-bandwidth\r\n+            pfrom->m_bip152_highbandwidth_to = true;\r\n+            lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\r\n             return true;\r\n         });\r\n     }\r\n```",
      "commit_id" : "e5993385d554655e4faf094826546b4f0d71dc8b",
      "created_at" : "2021-07-02T09:23:50Z",
      "diff_hunk" : "@@ -857,10 +858,13 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n                 });\n                 lNodesAnnouncingHeaderAndIDs.pop_front();\n             }\n-            m_connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n-            // save BIP152 bandwidth state: we select peer to be high-bandwidth\n-            pfrom->m_bip152_highbandwidth_to = true;\n-            lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+\n+            if (!m_ignore_incoming_txs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r662872834",
      "id" : 662872834,
      "line" : 862,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjg3MjgzNA==",
      "original_commit_id" : "e5993385d554655e4faf094826546b4f0d71dc8b",
      "original_line" : 862,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 697997837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T09:27:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662872834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r662873537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662873537"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can I convince you to make this conditional a bit more readable:\r\n\r\n```diff\r\n-                    if (!m_ignore_incoming_txs && nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\r\n+                    if (!m_ignore_incoming_txs\r\n+                        && nodestate->fSupportsDesiredCmpctVersion\r\n+                        && vGetData.size() == 1\r\n+                        && mapBlocksInFlight.size() == 1\r\n+                        && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\r\n```",
      "commit_id" : "e5993385d554655e4faf094826546b4f0d71dc8b",
      "created_at" : "2021-07-02T09:25:05Z",
      "diff_hunk" : "@@ -2100,7 +2104,7 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n+                    if (!m_ignore_incoming_txs && nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r662873537",
      "id" : 662873537,
      "line" : 2107,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjg3MzUzNw==",
      "original_commit_id" : "e5993385d554655e4faf094826546b4f0d71dc8b",
      "original_line" : 2107,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 31,
      "pull_request_review_id" : 697997837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T09:27:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662873537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 6dfee13f650521f7542df0926aff01af9ac6a328",
      "created_at" : "2021-07-02T12:58:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-872977968",
      "id" : 872977968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3Mjk3Nzk2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T12:58:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872977968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Is this true for transactions received via `sendrawtransaction`? What if some node, for whatever reason, receives all transactions, while having blocks-only mode?  For them, compact blocks are going to be beneficial, but this PR will disable it?",
      "created_at" : "2021-07-07T11:57:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-875542706",
      "id" : 875542706,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTU0MjcwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T11:57:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875542706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : ">  For them, compact blocks are going to be beneficial, but this PR will disable it?\r\n\r\n@naumenkogs yes this PR would disable compact blocks even if txs were received through `sendrawtransaction` and i think overall that's ok since that seems like an edge case to me. I would presume most blocks-only nodes don't submit enough txs through `sendrawtransaction` for this to matter, especially not continuously so that most blocks contain many of those txs. Or if a node is broadcasting that many txs it might not care about the additional bandwidth?\r\n\r\n[1] Technically it would be possible for a blocks-only node to ask for compact blocks if its mempool size (significantly) exceeds the overhead of compact blocks.\r\n[2] A config option enabling compact blocks for those individual blocks-only nodes that heavily use  `sendrawtransaction` could also help.\r\n\r\nDo you think adding [1] or [2] to this PR would be worth it?",
      "created_at" : "2021-07-08T18:14:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-876644398",
      "id" : 876644398,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjY0NDM5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T18:14:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876644398",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think [2] is better than [1].\r\n\r\nWhether we want to add a new config option for this use case or just implement what you suggested originally âÂ my personal choice would be to ask for thoughts at the #bitcoin-core-dev meeting.",
      "created_at" : "2021-07-09T05:46:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-876930777",
      "id" : 876930777,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjkzMDc3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-09T05:46:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876930777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> yes this PR would disable compact blocks even if txs were received through sendrawtransaction and i think overall that's ok since that seems like an edge case to me.\r\n\r\nI agree that this seems like an edge case that wouldn't actually be used. Compact blocks exist to improve propagation speed/efficiency when a node is participating in tx relay. I'd prefer not to add a configuration option that we don't expect to be used, or to increase the complexity of this PR.",
      "created_at" : "2021-07-09T08:36:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-877017862",
      "id" : 877017862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NzAxNzg2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-09T08:36:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/877017862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">I agree that this seems like an edge case that wouldn't actually be used. Compact blocks exist to improve propagation speed/efficiency when a node is participating in tx relay. I'd prefer not to add a configuration option that we don't expect to be used, or to increase the complexity of this PR.\r\n\r\nTo be clear, my worry is that some miners use the following setting:\r\n`A node in blocks-only mode with low-latency requirements (hence mining) is constantly fed with transactions via sendrawtransaction`, for whatever reason (e.g., they consider p2p tx relay insecure and disable it).\r\n\r\nI don't have any evidence of someone using this, just wanted to point out we are going to break this use case here, so I thought asking around makes sense.",
      "created_at" : "2021-07-09T08:55:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-877030117",
      "id" : 877030117,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NzAzMDExNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-09T08:55:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/877030117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@naumenkogs That seems very unlikely to me.",
      "created_at" : "2021-07-19T15:59:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-882665490",
      "id" : 882665490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5840nGgS",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-19T15:59:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/882665490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#20799](https://github.com/bitcoin/bitcoin/pull/20799) (net processing: Only support version 2 compact blocks by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-07-23T01:16:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-885337899",
      "id" : 885337899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5840xS8r",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-17T08:38:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/885337899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r682637215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682637215"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe its better to add here that we are also not sending getdata(CMPCT) in case of block-only? \r\n\r\nMy initial confusion was what about the low-band with case, and I missed the getdata(CMPCT) part in the code. \r\n\r\nIt would help clarify the doc a little better.    ",
      "commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "created_at" : "2021-08-04T13:52:15Z",
      "diff_hunk" : "@@ -831,6 +831,12 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n {\n     AssertLockHeld(cs_main);\n+\n+    // Never request high-bandwidth mode from peers if we're blocks-only. Our\n+    // mempool will not contain the transactions necessary to reconstruct the\n+    // compact block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r682637215",
      "id" : 682637215,
      "line" : 837,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MjYzNzIxNQ==",
      "original_commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "original_line" : 837,
      "original_position" : 7,
      "original_start_line" : 835,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 722311718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : 835,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-04T18:07:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682637215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-08-04T14:23:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-892702469",
      "id" : 892702469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841NY8F",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-04T14:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/892702469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r682694454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682694454"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is there any reason why we use `MaybeSetPeerAsAnnouncingHeaderAndIDs` instead of `MaybeSetPeerAsAnncouncingCompactBlocks`? Are they different things?",
      "commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "created_at" : "2021-08-04T14:54:01Z",
      "diff_hunk" : "@@ -831,6 +831,12 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r682694454",
      "id" : 682694454,
      "line" : 831,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MjY5NDQ1NA==",
      "original_commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "original_line" : 831,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 1,
      "pull_request_review_id" : 722311718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-04T18:07:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682694454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK.\r\n\r\nPerhaps a new test case in `p2p_compactblocks.py` or `p2p_compactblocks_hb.py` might be a good addition here, or in a follow-up? This changes behaviour but doesn't fail any tests.",
      "created_at" : "2021-08-04T16:39:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-892806688",
      "id" : 892806688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841NyYg",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-04T16:39:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/892806688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 6dfee13f650521f7542df0926aff01af9ac6a328\r\nbut (as others have said) a test would be nice",
      "created_at" : "2021-08-04T18:06:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-892863104",
      "id" : 892863104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841OAKA",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-04T18:06:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/892863104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r683306717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683306717"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This isn't the right place for that documentation. This function is for sending `sendcmpct(hb=true)` to the three peers that sent us blocks most recently.",
      "commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "created_at" : "2021-08-05T09:53:20Z",
      "diff_hunk" : "@@ -831,6 +831,12 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n {\n     AssertLockHeld(cs_main);\n+\n+    // Never request high-bandwidth mode from peers if we're blocks-only. Our\n+    // mempool will not contain the transactions necessary to reconstruct the\n+    // compact block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r683306717",
      "id" : 683306717,
      "in_reply_to_id" : 682637215,
      "line" : 837,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzMwNjcxNw==",
      "original_commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "original_line" : 837,
      "original_position" : 7,
      "original_start_line" : 835,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 723160728,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : 835,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-05T09:53:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683306717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r684200376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684200376"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In [BIP 152](https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki#headerandshortids) the structure that is used for the `cmcptblock` message is called `HeaderAndShortIDs`.\r\nI am assuming that this were the name came from. The function was introduced in the initial compact block PR: https://github.com/bitcoin/bitcoin/pull/8068",
      "commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "created_at" : "2021-08-06T12:36:01Z",
      "diff_hunk" : "@@ -831,6 +831,12 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r684200376",
      "id" : 684200376,
      "in_reply_to_id" : 682694454,
      "line" : 831,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDIwMDM3Ng==",
      "original_commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "original_line" : 831,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 1,
      "pull_request_review_id" : 724310624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-06T12:36:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684200376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r684369129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684369129"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @jnewbery, that makes sense.",
      "commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "created_at" : "2021-08-06T16:42:40Z",
      "diff_hunk" : "@@ -831,6 +831,12 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n {\n     AssertLockHeld(cs_main);\n+\n+    // Never request high-bandwidth mode from peers if we're blocks-only. Our\n+    // mempool will not contain the transactions necessary to reconstruct the\n+    // compact block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r684369129",
      "id" : 684369129,
      "in_reply_to_id" : 682637215,
      "line" : 837,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDM2OTEyOQ==",
      "original_commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "original_line" : 837,
      "original_position" : 7,
      "original_start_line" : 835,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 724536328,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : 835,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-06T16:42:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684369129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r684371206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684371206"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, I guess it comes from there. Still a little hard to guess, as the name seems quite generic (Headers and IDs). It also doesn't have any doc comment above it indicate it's related to compact blocks. Could help with some pointers.  ",
      "commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "created_at" : "2021-08-06T16:46:10Z",
      "diff_hunk" : "@@ -831,6 +831,12 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r684371206",
      "id" : 684371206,
      "in_reply_to_id" : 682694454,
      "line" : 831,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDM3MTIwNg==",
      "original_commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "original_line" : 831,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 1,
      "pull_request_review_id" : 724539068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-06T16:46:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684371206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r684419963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684419963"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that headers-and-ids is not very helpful here (and in a few other places in the code). Maybe it could be updated in a different PR.",
      "commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "created_at" : "2021-08-06T18:12:40Z",
      "diff_hunk" : "@@ -831,6 +831,12 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r684419963",
      "id" : 684419963,
      "in_reply_to_id" : 682694454,
      "line" : 831,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDQxOTk2Mw==",
      "original_commit_id" : "6dfee13f650521f7542df0926aff01af9ac6a328",
      "original_line" : 831,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 1,
      "pull_request_review_id" : 724602472,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-06T18:12:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684419963",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685218980"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685218980"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you use the cached chain, all the nodes will already be out of IBD:\r\n\r\n```diff\r\ndiff --git a/test/functional/p2p_compactblocks_blocksonly.py b/test/functional/p2p_compactblocks_blocksonly.py\r\nindex b97fdfdb14..bf486d8eda 100755\r\n--- a/test/functional/p2p_compactblocks_blocksonly.py\r\n+++ b/test/functional/p2p_compactblocks_blocksonly.py\r\n@@ -25,7 +25,6 @@ from test_framework.messages import (\r\n \r\n class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n     def set_test_params(self):\r\n-        self.setup_clean_chain = True\r\n         self.num_nodes = 3\r\n         self.extra_args = [[\"-blocksonly\"], [], []]\r\n \r\n@@ -41,15 +40,9 @@ class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n         return block\r\n \r\n     def run_test(self):\r\n-        self.connect_nodes(0, 2)\r\n-        self.connect_nodes(1, 2)\r\n-\r\n-        # Generate some blocks so all nodes are out of IBD.\r\n-        self.nodes[2].generate(10)\r\n-        self.sync_blocks()\r\n-\r\n-        self.disconnect_nodes(0, 2)\r\n-        self.disconnect_nodes(1, 2)\r\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\r\n+        for i in range(3):\r\n+            assert not self.nodes[i].getblockchaininfo()['initialblockdownload']\r\n \r\n         p2p_conn_node0 = self.nodes[0].add_p2p_connection(P2PInterface())\r\n         p2p_conn_node1 = self.nodes[1].add_p2p_connection(P2PInterface())\r\n\r\n```",
      "commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "created_at" : "2021-08-09T13:59:46Z",
      "diff_hunk" : "@@ -0,0 +1,100 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test p2p blocksonly mode & compact block relay\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+from test_framework.blocktools import (\n+    NORMAL_GBT_REQUEST_PARAMS,\n+    add_witness_commitment,\n+    create_block,\n+)\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    MSG_CMPCT_BLOCK,\n+    CInv,\n+    CBlockHeader,\n+    msg_block,\n+    msg_sendcmpct,\n+    msg_headers,\n+)\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+        self.extra_args = [[\"-blocksonly\"], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        block = create_block(tmpl=self.nodes[2].getblocktemplate(NORMAL_GBT_REQUEST_PARAMS))\n+        add_witness_commitment(block)\n+        block.solve()\n+        self.nodes[2].submitblock(block.serialize().hex())\n+        return block\n+\n+    def run_test(self):\n+        self.connect_nodes(0, 2)\n+        self.connect_nodes(1, 2)\n+\n+        # Generate some blocks so all nodes are out of IBD.\n+        self.nodes[2].generate(10)\n+        self.sync_blocks()\n+\n+        self.disconnect_nodes(0, 2)\n+        self.disconnect_nodes(1, 2)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685218980",
      "id" : 685218980,
      "line" : 52,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTIxODk4MA==",
      "original_commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "original_line" : 52,
      "original_position" : 52,
      "original_start_line" : 44,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 52,
      "pull_request_review_id" : 725414813,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : 44,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-09T15:53:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685218980",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685306116"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685306116"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Alternatively, just generate the block on the node:\r\n\r\n```diff\r\ndiff --git a/test/functional/p2p_compactblocks_blocksonly.py b/test/functional/p2p_compactblocks_blocksonly.py\r\nindex b97fdfdb14..b55dddc01a 100755\r\n--- a/test/functional/p2p_compactblocks_blocksonly.py\r\n+++ b/test/functional/p2p_compactblocks_blocksonly.py\r\n@@ -7,17 +7,14 @@\r\n from test_framework.test_framework import BitcoinTestFramework\r\n from test_framework.p2p import P2PInterface\r\n from test_framework.util import assert_equal\r\n-from test_framework.blocktools import (\r\n-    NORMAL_GBT_REQUEST_PARAMS,\r\n-    add_witness_commitment,\r\n-    create_block,\r\n-)\r\n from test_framework.messages import (\r\n     MSG_BLOCK,\r\n     MSG_WITNESS_FLAG,\r\n     MSG_CMPCT_BLOCK,\r\n+    CBlock,\r\n     CInv,\r\n     CBlockHeader,\r\n+    from_hex,\r\n     msg_block,\r\n     msg_sendcmpct,\r\n     msg_headers,\r\n@@ -34,10 +31,10 @@ class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n         self.sync_all()\r\n \r\n     def build_block_on_tip(self):\r\n-        block = create_block(tmpl=self.nodes[2].getblocktemplate(NORMAL_GBT_REQUEST_PARAMS))\r\n-        add_witness_commitment(block)\r\n-        block.solve()\r\n-        self.nodes[2].submitblock(block.serialize().hex())\r\n+        blockhash = self.nodes[2].generate(1)[0]\r\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\r\n+        block = from_hex(CBlock(), block_hex)\r\n+        block.rehash()\r\n         return block\r\n \r\n     def run_test(self):\r\n```",
      "commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "created_at" : "2021-08-09T15:39:45Z",
      "diff_hunk" : "@@ -0,0 +1,100 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test p2p blocksonly mode & compact block relay\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+from test_framework.blocktools import (\n+    NORMAL_GBT_REQUEST_PARAMS,\n+    add_witness_commitment,\n+    create_block,\n+)\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    MSG_CMPCT_BLOCK,\n+    CInv,\n+    CBlockHeader,\n+    msg_block,\n+    msg_sendcmpct,\n+    msg_headers,\n+)\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+        self.extra_args = [[\"-blocksonly\"], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685306116",
      "id" : 685306116,
      "line" : 36,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTMwNjExNg==",
      "original_commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 36,
      "pull_request_review_id" : 725414813,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T15:53:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685306116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685306379"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685306379"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please sort imports :slightly_smiling_face: ",
      "commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "created_at" : "2021-08-09T15:40:02Z",
      "diff_hunk" : "@@ -0,0 +1,100 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test p2p blocksonly mode & compact block relay\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685306379",
      "id" : 685306379,
      "line" : 7,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTMwNjM3OQ==",
      "original_commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "original_line" : 7,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 7,
      "pull_request_review_id" : 725414813,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T15:53:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685306379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685312787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685312787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This assumes that the node will send `sendcmpct` synchronously and before responding to the `ping` above. That's true right now, since `MaybeSetPeerAsAnnouncingHeaderAndIDs` is called in the synchronous `BlockChecked()` validation interface callback, but that may change in the future. (I'd like to change this to remove the synchronous `BlockChecked` callback).\r\n\r\nA less racy way to do this would be to use `wait_until()` so that the test doesn't immediately fail if the `sendcmpct` message isn't received before the `pong`.",
      "commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "created_at" : "2021-08-09T15:47:41Z",
      "diff_hunk" : "@@ -0,0 +1,100 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test p2p blocksonly mode & compact block relay\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+from test_framework.blocktools import (\n+    NORMAL_GBT_REQUEST_PARAMS,\n+    add_witness_commitment,\n+    create_block,\n+)\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    MSG_CMPCT_BLOCK,\n+    CInv,\n+    CBlockHeader,\n+    msg_block,\n+    msg_sendcmpct,\n+    msg_headers,\n+)\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+        self.extra_args = [[\"-blocksonly\"], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        block = create_block(tmpl=self.nodes[2].getblocktemplate(NORMAL_GBT_REQUEST_PARAMS))\n+        add_witness_commitment(block)\n+        block.solve()\n+        self.nodes[2].submitblock(block.serialize().hex())\n+        return block\n+\n+    def run_test(self):\n+        self.connect_nodes(0, 2)\n+        self.connect_nodes(1, 2)\n+\n+        # Generate some blocks so all nodes are out of IBD.\n+        self.nodes[2].generate(10)\n+        self.sync_blocks()\n+\n+        self.disconnect_nodes(0, 2)\n+        self.disconnect_nodes(1, 2)\n+\n+        p2p_conn_node0 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_node1 = self.nodes[1].add_p2p_connection(P2PInterface())\n+        assert_equal(p2p_conn_node0.message_count['sendcmpct'], 2)\n+        assert_equal(p2p_conn_node1.message_count['sendcmpct'], 2)\n+        p2p_conn_node0.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+        p2p_conn_node1.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Topology:\n+        #   p2p_conn_node0 ---> node0         node1 <--- p2p_conn_node1\n+        #                              node2\n+        #\n+        # node2 produces blocks which get passed to node0 and node1\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Part 1: Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_node0.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        assert_equal(p2p_conn_node0.message_count['sendcmpct'], 2)\n+        assert_equal(p2p_conn_node0.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.\n+        p2p_conn_node1.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\n+        assert_equal(p2p_conn_node1.message_count['sendcmpct'], 3)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685312787",
      "id" : 685312787,
      "line" : 83,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTMxMjc4Nw==",
      "original_commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "original_line" : 83,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 83,
      "pull_request_review_id" : 725414813,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T15:53:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685312787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685317001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685317001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for \"Part 1\" or \"Part 2\" in these logs (tests have a habit of being rearranged, so these logs will fall out of date)",
      "commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "created_at" : "2021-08-09T15:52:39Z",
      "diff_hunk" : "@@ -0,0 +1,100 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test p2p blocksonly mode & compact block relay\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+from test_framework.blocktools import (\n+    NORMAL_GBT_REQUEST_PARAMS,\n+    add_witness_commitment,\n+    create_block,\n+)\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    MSG_CMPCT_BLOCK,\n+    CInv,\n+    CBlockHeader,\n+    msg_block,\n+    msg_sendcmpct,\n+    msg_headers,\n+)\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+        self.extra_args = [[\"-blocksonly\"], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        block = create_block(tmpl=self.nodes[2].getblocktemplate(NORMAL_GBT_REQUEST_PARAMS))\n+        add_witness_commitment(block)\n+        block.solve()\n+        self.nodes[2].submitblock(block.serialize().hex())\n+        return block\n+\n+    def run_test(self):\n+        self.connect_nodes(0, 2)\n+        self.connect_nodes(1, 2)\n+\n+        # Generate some blocks so all nodes are out of IBD.\n+        self.nodes[2].generate(10)\n+        self.sync_blocks()\n+\n+        self.disconnect_nodes(0, 2)\n+        self.disconnect_nodes(1, 2)\n+\n+        p2p_conn_node0 = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_node1 = self.nodes[1].add_p2p_connection(P2PInterface())\n+        assert_equal(p2p_conn_node0.message_count['sendcmpct'], 2)\n+        assert_equal(p2p_conn_node1.message_count['sendcmpct'], 2)\n+        p2p_conn_node0.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+        p2p_conn_node1.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Topology:\n+        #   p2p_conn_node0 ---> node0         node1 <--- p2p_conn_node1\n+        #                              node2\n+        #\n+        # node2 produces blocks which get passed to node0 and node1\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Part 1: Test that blocksonly nodes do not request high bandwidth mode.\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r685317001",
      "id" : 685317001,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTMxNzAwMQ==",
      "original_commit_id" : "217a80d9157f7d8b14351ed5bf529f9959f11110",
      "original_line" : 68,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 68,
      "pull_request_review_id" : 725414813,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T15:53:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685317001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review @jnewbery! I took all your suggestions.\r\n\r\nI also added two new test cases:\r\nOne to test that on regular low bandwidth connections (no blocksonly nodes involved) `getdata(CMPCT)` is still sent. 8b1b308555382ea1b7390615371ecaa066c4af3b\r\nAnd one to test that blocksonly nodes still serve compact blocks in hb and lb mode. 8c4159aeccdad58a71ff61b3e21b26a4f24a6029",
      "created_at" : "2021-08-09T20:45:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-895531146",
      "id" : 895531146,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841YLiK",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-09T20:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/895531146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686056461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686056461"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        # node2 produces blocks which get passed to the rest of the nodes\r\n```",
      "commit_id" : "8c4159aeccdad58a71ff61b3e21b26a4f24a6029",
      "created_at" : "2021-08-10T14:09:03Z",
      "diff_hunk" : "@@ -0,0 +1,133 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for i in range(3):\n+            assert not self.nodes[i].getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        assert_equal(p2p_conn_blocksonly.message_count['sendcmpct'], 2)\n+        assert_equal(p2p_conn_high_bw.message_count['sendcmpct'], 2)\n+        assert_equal(p2p_conn_low_bw.message_count['sendcmpct'], 2)\n+        p2p_conn_blocksonly.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+        p2p_conn_high_bw.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+        p2p_conn_low_bw.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the reset of the nodes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686056461",
      "id" : 686056461,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjA1NjQ2MQ==",
      "original_commit_id" : "8c4159aeccdad58a71ff61b3e21b26a4f24a6029",
      "original_line" : 68,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 68,
      "pull_request_review_id" : 726487585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-10T14:55:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686056461",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686065386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686065386"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be 4 now that there are 4 nodes? Or maybe even better:\r\n\r\n```suggestion\r\n        for node in self.nodes:\r\n            assert not node.getblockchaininfo()['initialblockdownload']\r\n```",
      "commit_id" : "8c4159aeccdad58a71ff61b3e21b26a4f24a6029",
      "created_at" : "2021-08-10T14:18:39Z",
      "diff_hunk" : "@@ -0,0 +1,133 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for i in range(3):\n+            assert not self.nodes[i].getblockchaininfo()['initialblockdownload']",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686065386",
      "id" : 686065386,
      "line" : 44,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjA2NTM4Ng==",
      "original_commit_id" : "8c4159aeccdad58a71ff61b3e21b26a4f24a6029",
      "original_line" : 44,
      "original_position" : 44,
      "original_start_line" : 43,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 44,
      "pull_request_review_id" : 726487585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : 43,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-10T14:55:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686065386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686094198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686094198"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\r\n            assert_equal(conn.message_count['sendcmpct'], 2)\r\n            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\r\n```",
      "commit_id" : "8c4159aeccdad58a71ff61b3e21b26a4f24a6029",
      "created_at" : "2021-08-10T14:49:12Z",
      "diff_hunk" : "@@ -0,0 +1,133 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for i in range(3):\n+            assert not self.nodes[i].getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        assert_equal(p2p_conn_blocksonly.message_count['sendcmpct'], 2)\n+        assert_equal(p2p_conn_high_bw.message_count['sendcmpct'], 2)\n+        assert_equal(p2p_conn_low_bw.message_count['sendcmpct'], 2)\n+        p2p_conn_blocksonly.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+        p2p_conn_high_bw.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+        p2p_conn_low_bw.send_and_ping(msg_sendcmpct(announce=False, version=2))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686094198",
      "id" : 686094198,
      "line" : 54,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjA5NDE5OA==",
      "original_commit_id" : "8c4159aeccdad58a71ff61b3e21b26a4f24a6029",
      "original_line" : 54,
      "original_position" : 54,
      "original_start_line" : 49,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 54,
      "pull_request_review_id" : 726487585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : 49,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-10T14:55:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686094198",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686097074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686097074"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you separate the test for existence of the `cmpctblock` message from the test of its hash, you don't need the `sync_send_with_ping()` call:\r\n\r\n```suggestion\r\n                if 'cmpctblock' not in p2p_conn_blocksonly.last_message:\r\n                    return False\r\n                sha256 = p2p_conn_blocksonly.last_message['cmpctblock'].header_and_shortids.header.rehash()\r\n```\r\n\r\nI'd also suggest using a lambda so that you don't need to have a named function returning the inner function, and also parametrizing the connection. Full diff:\r\n\r\n```diff\r\n         self.log.info(\"Test that blocksonly nodes still serve compact blocks.\")\r\n \r\n-        def test_for_cmpctblock(block):\r\n-            def test():\r\n-                sha256 = p2p_conn_blocksonly.last_message['cmpctblock'].header_and_shortids.header.rehash()\r\n-                return sha256 == block.sha256\r\n-            return test\r\n+        def test_for_cmpctblock(conn, block):\r\n+            if 'cmpctblock' not in conn.last_message:\r\n+                return False\r\n+            return conn.last_message['cmpctblock'].header_and_shortids.header.rehash() == block.sha256\r\n \r\n         p2p_conn_blocksonly.send_message(msg_getdata([CInv(MSG_CMPCT_BLOCK, block0.sha256)]))\r\n-        p2p_conn_blocksonly.sync_send_with_ping()\r\n-        p2p_conn_blocksonly.wait_until(test_for_cmpctblock(block0))\r\n+        p2p_conn_blocksonly.wait_until(lambda: test_for_cmpctblock(p2p_conn_blocksonly, block0))\r\n \r\n         # Request high bandwidth mode from node0\r\n         p2p_conn_blocksonly.send_and_ping(msg_sendcmpct(announce=True, version=2))\r\n@@ -127,7 +123,7 @@ class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n         block2 = self.build_block_on_tip()\r\n         self.nodes[0].submitblock(block1.serialize().hex())\r\n         self.nodes[0].submitblock(block2.serialize().hex())\r\n-        p2p_conn_blocksonly.wait_until(test_for_cmpctblock(block2))\r\n+        p2p_conn_blocksonly.wait_until(lambda: test_for_cmpctblock(p2p_conn_blocksonly, block2))\r\n```",
      "commit_id" : "8c4159aeccdad58a71ff61b3e21b26a4f24a6029",
      "created_at" : "2021-08-10T14:52:14Z",
      "diff_hunk" : "@@ -0,0 +1,133 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for i in range(3):\n+            assert not self.nodes[i].getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        assert_equal(p2p_conn_blocksonly.message_count['sendcmpct'], 2)\n+        assert_equal(p2p_conn_high_bw.message_count['sendcmpct'], 2)\n+        assert_equal(p2p_conn_low_bw.message_count['sendcmpct'], 2)\n+        p2p_conn_blocksonly.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+        p2p_conn_high_bw.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+        p2p_conn_low_bw.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the reset of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\n+        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.\n+        p2p_conn_high_bw.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\n+        assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\n+\n+        # Don't send a block from the p2p_conn_low_bw so the bitcoind node\n+        # doesn't select it for high bw relay.\n+        self.nodes[3].submitblock(block0.serialize().hex())\n+\n+        self.log.info(\"Test that blocksonly nodes send getdata(BLOCK) instead\"\n+                      \"of getdata(CMPCT) in low bandwidth mode.\")\n+\n+        block1 = self.build_block_on_tip()\n+\n+        p2p_conn_blocksonly.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_blocksonly.sync_send_with_ping()\n+        assert_equal(p2p_conn_blocksonly.last_message['getdata'].inv, [CInv(MSG_BLOCK | MSG_WITNESS_FLAG, block1.sha256)])\n+\n+        p2p_conn_high_bw.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_high_bw.sync_send_with_ping()\n+        assert_equal(p2p_conn_high_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\n+\n+        self.log.info(\"Test that getdata(CMPCT) is still sent on regular low bandwdith connections.\")\n+\n+        p2p_conn_low_bw.send_and_ping(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_low_bw.sync_with_ping()\n+        assert_equal(p2p_conn_low_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\n+\n+        self.log.info(\"Test that blocksonly nodes still serve compact blocks.\")\n+\n+        def test_for_cmpctblock(block):\n+            def test():\n+                sha256 = p2p_conn_blocksonly.last_message['cmpctblock'].header_and_shortids.header.rehash()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686097074",
      "id" : 686097074,
      "line" : 116,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjA5NzA3NA==",
      "original_commit_id" : "8c4159aeccdad58a71ff61b3e21b26a4f24a6029",
      "original_line" : 116,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 116,
      "pull_request_review_id" : 726487585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-10T14:55:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686097074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Started looking at this PR.  Rebased to current master, debug build is clean, <strike>but the new test times out for me locally on every run (out of five).</strike>\r\n\r\n<details><summary>test output</summary><p>\r\n\r\n```\r\n$ test/functional/p2p_compactblocks_blocksonly.py \r\n2021-08-10T15:36:10.388000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_ypwy_8d2\r\n2021-08-10T15:36:11.582000Z TestFramework (INFO): Test that blocksonly nodes do not request high bandwidth mode.\r\n2021-08-10T15:37:11.677000Z TestFramework.utils (ERROR): wait_until() failed. Predicate: ''''\r\n        def test_function():\r\n            if check_connected:\r\n                assert self.is_connected\r\n            return test_function_in()\r\n'''\r\n2021-08-10T15:37:11.677000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/test_framework.py\", line 131, in main\r\n    self.run_test()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/p2p_compactblocks_blocksonly.py\", line 79, in run_test\r\n    p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/p2p.py\", line 451, in wait_until\r\n    wait_until_helper(test_function, timeout=timeout, lock=p2p_lock, timeout_factor=self.timeout_factor)\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/util.py\", line 256, in wait_until_helper\r\n    raise AssertionError(\"Predicate {} not true after {} seconds\".format(predicate_source, timeout))\r\nAssertionError: Predicate ''''\r\n        def test_function():\r\n            if check_connected:\r\n                assert self.is_connected\r\n            return test_function_in()\r\n''' not true after 60.0 seconds\r\n2021-08-10T15:37:11.729000Z TestFramework (INFO): Stopping nodes\r\n2021-08-10T15:37:11.891000Z TestFramework (WARNING): Not cleaning up dir /tmp/bitcoin_func_test_ypwy_8d2\r\n2021-08-10T15:37:11.892000Z TestFramework (ERROR): Test failed. Test logging available at /tmp/bitcoin_func_test_ypwy_8d2/test_framework.log\r\n2021-08-10T15:37:11.894000Z TestFramework (ERROR): \r\n2021-08-10T15:37:11.896000Z TestFramework (ERROR): Hint: Call /home/jon/projects/bitcoin/bitcoin/test/functional/combine_logs.py '/tmp/bitcoin_func_test_ypwy_8d2' to consolidate all logs\r\n2021-08-10T15:37:11.896000Z TestFramework (ERROR): \r\n2021-08-10T15:37:11.897000Z TestFramework (ERROR): If this failure happened unexpectedly or intermittently, please file a bug and provide a link or upload of the combined log.\r\n2021-08-10T15:37:11.897000Z TestFramework (ERROR): https://github.com/bitcoin/bitcoin/issues\r\n2021-08-10T15:37:11.897000Z TestFramework (ERROR): \r\n```\r\n</p></details>\r\n",
      "created_at" : "2021-08-10T17:13:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-896164568",
      "id" : 896164568,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841amLY",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-10T21:25:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896164568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jonatack that's odd. I tried rebasing on master & the tests are passing ð¤ \r\n\r\nAnd based on the logs you posted, I don't see why rebasing would cause a difference. The test file introduced is new, and I don't believe anything has changed recently around compact block p2p messages. Do you have any more info you can offer? ",
      "created_at" : "2021-08-10T20:01:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-896280776",
      "id" : 896280776,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841bCjI",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-10T20:01:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896280776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It's late but I'll try again tomorrow (and do a review, looks like an interesting PR). I rebased and did a debug build with clang 13 on debian before running the test. Maybe it was spurious.",
      "created_at" : "2021-08-10T20:13:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-896288047",
      "id" : 896288047,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841bEUv",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-10T20:13:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896288047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ok, the test runs fine. Here is what happened: I forgot about the footgun on master that currently doesn't build when DEBUG_ADDRMAN is defined. I built with my bash alias that does a debug build with that, the build failed, I didn't notice, and so I was running the test on the wrong build. I just verified that the failure I reported occurs on master. Apologies for the noise! Will review tomorrow.",
      "created_at" : "2021-08-10T21:06:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-896316519",
      "id" : 896316519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841bLRn",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-10T21:06:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896316519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jnewbery great suggestions! Incorporated them all again.\r\n\r\n[`nocmpct_blocksonly_0`](https://github.com/dergoegge/bitcoin/tree/nocmpct_blocksonly_0) -> [`nocmpct_blocksonly_1`](https://github.com/dergoegge/bitcoin/tree/nocmpct_blocksonly_1)\r\n\r\n<details>\r\n<summary>git range-diff nocmpct_blocksonly_0...nocmpct_blocksonly_1</summary>\r\n\r\n```\r\n1:  5a29943a9 ! 1:  e58cfb118 [test] Test that blocksonly nodes do not request high bandwidth mode.\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py (new)\r\n     +\r\n     +    def run_test(self):\r\n     +        # Nodes will only request hb compact blocks mode when they're out of IBD\r\n    -+        for i in range(3):\r\n    -+            assert not self.nodes[i].getblockchaininfo()['initialblockdownload']\r\n    ++        for node in self.nodes:\r\n    ++            assert not node.getblockchaininfo()['initialblockdownload']\r\n     +\r\n     +        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\r\n     +        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\r\n    -+        assert_equal(p2p_conn_blocksonly.message_count['sendcmpct'], 2)\r\n    -+        assert_equal(p2p_conn_high_bw.message_count['sendcmpct'], 2)\r\n    -+        p2p_conn_blocksonly.send_and_ping(msg_sendcmpct(announce=False, version=2))\r\n    -+        p2p_conn_high_bw.send_and_ping(msg_sendcmpct(announce=False, version=2))\r\n    ++        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw]:\r\n    ++            assert_equal(conn.message_count['sendcmpct'], 2)\r\n    ++            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\r\n     +\r\n     +        # Nodes:\r\n     +        #   0 -> blocksonly\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py (new)\r\n     +        #   p2p_conn_high_bw    ---> node1\r\n     +        #   node2 (no connections)\r\n     +        #\r\n    -+        # node2 produces blocks which get passed to the reset of the nodes\r\n    ++        # node2 produces blocks which get passed to the rest of the nodes\r\n     +        # through the respective p2p connections.\r\n     +\r\n     +        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\r\n2:  beeea3fbc = 2:  c99978d94 [test] Test that blocksonly nodes do not send getdata(CMPCT) on a low bandwidth connection.\r\n3:  8b1b30855 ! 3:  770c5f1a4 [test] Test that getdata(CMPCT) is still sent on regular low bandwdith connections.\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n\r\n              p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\r\n              p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\r\n    +-        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw]:\r\n     +        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\r\n    -         assert_equal(p2p_conn_blocksonly.message_count['sendcmpct'], 2)\r\n    -         assert_equal(p2p_conn_high_bw.message_count['sendcmpct'], 2)\r\n    -+        assert_equal(p2p_conn_low_bw.message_count['sendcmpct'], 2)\r\n    -         p2p_conn_blocksonly.send_and_ping(msg_sendcmpct(announce=False, version=2))\r\n    -         p2p_conn_high_bw.send_and_ping(msg_sendcmpct(announce=False, version=2))\r\n    -+        p2p_conn_low_bw.send_and_ping(msg_sendcmpct(announce=False, version=2))\r\n    ++        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\r\n    +             assert_equal(conn.message_count['sendcmpct'], 2)\r\n    +             conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\r\n\r\n    -         # Nodes:\r\n    +@@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n              #   0 -> blocksonly\r\n              #   1 -> high bandwidth\r\n              #   2 -> miner\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n     +        #   p2p_conn_low_bw     ---> node3\r\n              #   node2 (no connections)\r\n              #\r\n    -         # node2 produces blocks which get passed to the reset of the nodes\r\n    +         # node2 produces blocks which get passed to the rest of the nodes\r\n     @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n              p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\r\n              assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\r\n4:  8c4159aec ! 4:  e21f2e4f0 [test] Test that blocksonly nodes still serve compact blocks.\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n     +        self.log.info(\"Test that blocksonly nodes still serve compact blocks.\")\r\n     +\r\n     +        def test_for_cmpctblock(block):\r\n    -+            def test():\r\n    -+                sha256 = p2p_conn_blocksonly.last_message['cmpctblock'].header_and_shortids.header.rehash()\r\n    -+                return sha256 == block.sha256\r\n    -+            return test\r\n    ++            if 'cmpctblock' not in p2p_conn_blocksonly.last_message:\r\n    ++                return False\r\n    ++            return p2p_conn_blocksonly.last_message['cmpctblock'].header_and_shortids.header.rehash() == block.sha256\r\n     +\r\n     +        p2p_conn_blocksonly.send_message(msg_getdata([CInv(MSG_CMPCT_BLOCK, block0.sha256)]))\r\n    -+        p2p_conn_blocksonly.sync_send_with_ping()\r\n    -+        p2p_conn_blocksonly.wait_until(test_for_cmpctblock(block0))\r\n    ++        p2p_conn_blocksonly.wait_until(lambda: test_for_cmpctblock(block0))\r\n     +\r\n     +        # Request high bandwidth mode from node0\r\n     +        p2p_conn_blocksonly.send_and_ping(msg_sendcmpct(announce=True, version=2))\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n     +        block2 = self.build_block_on_tip()\r\n     +        self.nodes[0].submitblock(block1.serialize().hex())\r\n     +        self.nodes[0].submitblock(block2.serialize().hex())\r\n    -+        p2p_conn_blocksonly.wait_until(test_for_cmpctblock(block2))\r\n    ++        p2p_conn_blocksonly.wait_until(lambda: test_for_cmpctblock(block2))\r\n     +\r\n      if __name__ == '__main__':\r\n          P2PCompactBlocksBlocksOnly().main()\r\n```\r\n</details>",
      "created_at" : "2021-08-10T21:30:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-896328217",
      "id" : 896328217,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841bOIZ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-10T21:30:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896328217",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "created_at" : "2021-08-11T09:46:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-896678716",
      "id" : 896678716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841cjs8",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-11T09:46:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896678716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686955459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686955459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e58cfb11875728d90716577f34482ddddb898cdb pico-nit, unless this test has been under development since 2019 (maybe it has!)\r\n```suggestion\r\n# Copyright (c) 2021-2021 The Bitcoin Core developers\r\n```\r\n\r\n(yes, there is an automated update script run occasionally but IDK if it's smart enough to set the start year) ",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T15:44:24Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686955459",
      "id" : 686955459,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk1NTQ1OQ==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 2,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:10:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686955459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686960157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686960157"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e58cfb11 suggestion stolen from review of #22651, feel free to ignore\r\n```diff\r\n-        self.num_nodes = 4\r\n         self.extra_args = [[\"-blocksonly\"], [], [], []]\r\n+        self.num_nodes = len(self.extra_args)\r\n```\r\n",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T15:50:09Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686960157",
      "id" : 686960157,
      "line" : 27,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk2MDE1Nw==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 27,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 27,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686960157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686969838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686969838"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e58cfb11875728d90716577f34482ddddb898cdb \r\n```suggestion\r\n        # node2 produces blocks that are passed to the rest of the nodes\r\n```",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T16:01:17Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686969838",
      "id" : 686969838,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk2OTgzOA==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 65,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686969838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686977088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686977088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        self.log.info(\"Test -blocksonly nodes do not select peers for BIP152 high bandwidth mode\")\r\n```",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T16:10:31Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686977088",
      "id" : 686977088,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk3NzA4OA==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 68,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686977088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686977814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686977814"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c99978d9 missing space \"insteadof\" + other suggestions while here\r\n```diff\r\n-        self.log.info(\"Test that blocksonly nodes send getdata(BLOCK) instead\"\r\n-                      \"of getdata(CMPCT) in low bandwidth mode.\")\r\n+        self.log.info(\"Test -blocksonly nodes send getdata(BLOCK) instead\"\r\n+                      \" of getdata(CMPCT) in BIP152 low bandwidth mode\")\r\n```\r\n",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T16:11:26Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\n+        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.\n+        p2p_conn_high_bw.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\n+        assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\n+\n+        # Don't send a block from the p2p_conn_low_bw so the bitcoind node\n+        # doesn't select it for high bw relay.\n+        self.nodes[3].submitblock(block0.serialize().hex())\n+\n+        self.log.info(\"Test that blocksonly nodes send getdata(BLOCK) instead\"\n+                      \"of getdata(CMPCT) in low bandwidth mode.\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686977814",
      "id" : 686977814,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk3NzgxNA==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 91,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686977814",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686978385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686978385"
         }
      },
      "author_association" : "MEMBER",
      "body" : "770c5f1a s/bandwdith/bandwidth/ + minor suggestions while here\r\n```suggestion\r\n        self.log.info(\"Test getdata(CMPCT) is still sent on BIP152 low bandwidth connections\")\r\n```",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T16:12:10Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\n+        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.\n+        p2p_conn_high_bw.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\n+        assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\n+\n+        # Don't send a block from the p2p_conn_low_bw so the bitcoind node\n+        # doesn't select it for high bw relay.\n+        self.nodes[3].submitblock(block0.serialize().hex())\n+\n+        self.log.info(\"Test that blocksonly nodes send getdata(BLOCK) instead\"\n+                      \"of getdata(CMPCT) in low bandwidth mode.\")\n+\n+        block1 = self.build_block_on_tip()\n+\n+        p2p_conn_blocksonly.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_blocksonly.sync_send_with_ping()\n+        assert_equal(p2p_conn_blocksonly.last_message['getdata'].inv, [CInv(MSG_BLOCK | MSG_WITNESS_FLAG, block1.sha256)])\n+\n+        p2p_conn_high_bw.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_high_bw.sync_send_with_ping()\n+        assert_equal(p2p_conn_high_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\n+\n+        self.log.info(\"Test that getdata(CMPCT) is still sent on regular low bandwdith connections.\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686978385",
      "id" : 686978385,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk3ODM4NQ==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 103,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:02:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686978385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686978680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686978680"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        self.log.info(\"Test -blocksonly nodes still serve compact blocks\")\r\n```",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T16:12:33Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\n+        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.\n+        p2p_conn_high_bw.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\n+        assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\n+\n+        # Don't send a block from the p2p_conn_low_bw so the bitcoind node\n+        # doesn't select it for high bw relay.\n+        self.nodes[3].submitblock(block0.serialize().hex())\n+\n+        self.log.info(\"Test that blocksonly nodes send getdata(BLOCK) instead\"\n+                      \"of getdata(CMPCT) in low bandwidth mode.\")\n+\n+        block1 = self.build_block_on_tip()\n+\n+        p2p_conn_blocksonly.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_blocksonly.sync_send_with_ping()\n+        assert_equal(p2p_conn_blocksonly.last_message['getdata'].inv, [CInv(MSG_BLOCK | MSG_WITNESS_FLAG, block1.sha256)])\n+\n+        p2p_conn_high_bw.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_high_bw.sync_send_with_ping()\n+        assert_equal(p2p_conn_high_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\n+\n+        self.log.info(\"Test that getdata(CMPCT) is still sent on regular low bandwdith connections.\")\n+\n+        p2p_conn_low_bw.send_and_ping(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_low_bw.sync_with_ping()\n+        assert_equal(p2p_conn_low_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\n+\n+        self.log.info(\"Test that blocksonly nodes still serve compact blocks.\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686978680",
      "id" : 686978680,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk3ODY4MA==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 109,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686978680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686984726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686984726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c99978d added the low bandwidth node as a sanity check\r\n```diff\r\n+\r\n+        p2p_conn_low_bw.send_message(msg_headers(headers=[CBlockHeader(block1)]))\r\n+        p2p_conn_low_bw.sync_send_with_ping()\r\n+        assert_equal(p2p_conn_low_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\r\n```\r\n",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T16:20:07Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\n+        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.\n+        p2p_conn_high_bw.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\n+        assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\n+\n+        # Don't send a block from the p2p_conn_low_bw so the bitcoind node\n+        # doesn't select it for high bw relay.\n+        self.nodes[3].submitblock(block0.serialize().hex())\n+\n+        self.log.info(\"Test that blocksonly nodes send getdata(BLOCK) instead\"\n+                      \"of getdata(CMPCT) in low bandwidth mode.\")\n+\n+        block1 = self.build_block_on_tip()\n+\n+        p2p_conn_blocksonly.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_blocksonly.sync_send_with_ping()\n+        assert_equal(p2p_conn_blocksonly.last_message['getdata'].inv, [CInv(MSG_BLOCK | MSG_WITNESS_FLAG, block1.sha256)])\n+\n+        p2p_conn_high_bw.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_high_bw.sync_send_with_ping()\n+        assert_equal(p2p_conn_high_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r686984726",
      "id" : 686984726,
      "line" : 101,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njk4NDcyNg==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 101,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 101,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686984726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687026270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687026270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "770c5f1a \"bitcoind node\"...which one?",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T17:17:07Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\n+        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.\n+        p2p_conn_high_bw.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\n+        assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\n+\n+        # Don't send a block from the p2p_conn_low_bw so the bitcoind node",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687026270",
      "id" : 687026270,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzAyNjI3MA==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 86,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687026270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687028672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687028672"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e58cfb11 added the low bandwidth node as a sanity check\r\n```diff\r\n+\r\n+        p2p_conn_low_bw.send_and_ping(msg_block(block0))\r\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\r\n+        p2p_conn_low_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\r\n+        assert_equal(p2p_conn_low_bw.last_message['sendcmpct'].announce, True)\r\n```\r\n",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T17:20:37Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\n+        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.\n+        p2p_conn_high_bw.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\n+        assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687028672",
      "id" : 687028672,
      "line" : 85,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzAyODY3Mg==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 85,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 85,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687028672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687031407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687031407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e21f2e4\r\n```suggestion\r\n        # Request high bandwidth mode from the -blocksonly node\r\n```",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T17:24:31Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\n+        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.\n+        p2p_conn_high_bw.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\n+        assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\n+\n+        # Don't send a block from the p2p_conn_low_bw so the bitcoind node\n+        # doesn't select it for high bw relay.\n+        self.nodes[3].submitblock(block0.serialize().hex())\n+\n+        self.log.info(\"Test that blocksonly nodes send getdata(BLOCK) instead\"\n+                      \"of getdata(CMPCT) in low bandwidth mode.\")\n+\n+        block1 = self.build_block_on_tip()\n+\n+        p2p_conn_blocksonly.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_blocksonly.sync_send_with_ping()\n+        assert_equal(p2p_conn_blocksonly.last_message['getdata'].inv, [CInv(MSG_BLOCK | MSG_WITNESS_FLAG, block1.sha256)])\n+\n+        p2p_conn_high_bw.send_message(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_high_bw.sync_send_with_ping()\n+        assert_equal(p2p_conn_high_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\n+\n+        self.log.info(\"Test that getdata(CMPCT) is still sent on regular low bandwdith connections.\")\n+\n+        p2p_conn_low_bw.send_and_ping(msg_headers(headers=[CBlockHeader(block1)]))\n+        p2p_conn_low_bw.sync_with_ping()\n+        assert_equal(p2p_conn_low_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\n+\n+        self.log.info(\"Test that blocksonly nodes still serve compact blocks.\")\n+\n+        def test_for_cmpctblock(block):\n+            if 'cmpctblock' not in p2p_conn_blocksonly.last_message:\n+                return False\n+            return p2p_conn_blocksonly.last_message['cmpctblock'].header_and_shortids.header.rehash() == block.sha256\n+\n+        p2p_conn_blocksonly.send_message(msg_getdata([CInv(MSG_CMPCT_BLOCK, block0.sha256)]))\n+        p2p_conn_blocksonly.wait_until(lambda: test_for_cmpctblock(block0))\n+\n+        # Request high bandwidth mode from node0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687031407",
      "id" : 687031407,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzAzMTQwNw==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 119,
      "original_position" : 119,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687031407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687040731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687040731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e58cfb11875728d90716577f34482ddddb898cdb in general, ISTM mentioning BIP152 makes \"high/low bandwidth mode\" more clear\r\n```diff\r\n-        # A normal node participating in transaction relay should request high\r\n-        # bandwidth mode upon receiving a new valid block at the tip.\r\n+        # A normal node participating in transaction relay should request BIP152\r\n+        # high bandwidth mode upon receiving a new valid block at the tip.\r\n```",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T17:37:58Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\n+        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\n+\n+        # A normal node participating in transaction relay should request high\n+        # bandwidth mode upon receiving a new valid block at the tip.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687040731",
      "id" : 687040731,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzA0MDczMQ==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 80,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:09:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687040731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687041175"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687041175"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e58cfb11875728d90716577f34482ddddb898cdb (micro-nit in general): blocksonly -> -blocksonly (or) blocks-only, the former might make clear for newer people that it is a config option and the latter describes the state clearly",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T17:38:33Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks which get passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A blocksonly node should not request high bandwidth mode upon",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687041175",
      "id" : 687041175,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzA0MTE3NQ==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 72,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687041175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687050643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687050643"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6dfee13 in general, ISTM that mentioning BIP152 makes \"high/low bandwidth mode\" more clear, especially for newer people\r\n```suggestion\r\n    // Never request BIP152 high-bandwidth mode from peers if we're blocks-only. Our\r\n```",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T17:52:21Z",
      "diff_hunk" : "@@ -831,6 +831,12 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n {\n     AssertLockHeld(cs_main);\n+\n+    // Never request high-bandwidth mode from peers if we're blocks-only. Our",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687050643",
      "id" : 687050643,
      "line" : 835,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzA1MDY0Mw==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 835,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:12:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687050643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687051208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687051208"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6dfee13f650521f7542df0926aff01af9ac6a328 Perhaps add a comment here as well (feel free to ignore).",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-11T17:53:08Z",
      "diff_hunk" : "@@ -2116,7 +2122,11 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n+                    if (!m_ignore_incoming_txs &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r687051208",
      "id" : 687051208,
      "line" : 2125,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzA1MTIwOA==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 2125,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 727649377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T18:04:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/687051208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Consider also updating `doc/reduce-traffic.md` regarding the effects of setting `-blocksonly` (maybe also in the Memory Pool section of `doc/reduce-memory.md`).",
      "created_at" : "2021-08-12T09:09:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-897474657",
      "id" : 897474657,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841fmBh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-12T09:11:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/897474657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jonatack Thanks for the review! I took most of your suggestions.\r\n\r\nI did not modify 6dfee13f650521f7542df0926aff01af9ac6a328 because i don't want to invalidate the utACKs that this commit has already gotten. I will make a follow up PR for those suggestions as well as the other doc changes (Release note, `doc/reduce-traffic.md`).\r\n\r\n[`nocmpct_blocksonly_1`](https://github.com/dergoegge/bitcoin/tree/nocmpct_blocksonly_1) -> [`nocmpct_blocksonly_2`](https://github.com/dergoegge/bitcoin/tree/nocmpct_blocksonly_2)\r\n\r\n<details>\r\n<summary>git range-diff nocmpct_blocksonly_1...nocmpct_blocksonly_2</summary>\r\n\r\n```\r\n1:  e58cfb118 ! 1:  1bd2f889c [test] Test that blocksonly nodes do not request high bandwidth mode.\r\n    @@ Metadata\r\n     Author: Niklas GÃ¶gge <n.goeggi@gmail.com>\r\n     \r\n      ## Commit message ##\r\n    -    [test] Test that blocksonly nodes do not request high bandwidth mode.\r\n    +    [test] Test that -blocksonly nodes do not request high bandwidth mode.\r\n     \r\n         Co-authored-by: Amiti Uttarwar <amiti@uttarwar.org>\r\n     \r\n      ## test/functional/p2p_compactblocks_blocksonly.py (new) ##\r\n     @@\r\n     +#!/usr/bin/env python3\r\n    -+# Copyright (c) 2019-2020 The Bitcoin Core developers\r\n    ++# Copyright (c) 2021-2021 The Bitcoin Core developers\r\n     +# Distributed under the MIT software license, see the accompanying\r\n     +# file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n     +\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py (new)\r\n     +\r\n     +class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n     +    def set_test_params(self):\r\n    -+        self.num_nodes = 3\r\n     +        self.extra_args = [[\"-blocksonly\"], [], []]\r\n    ++        self.num_nodes = len(self.extra_args)\r\n     +\r\n     +    def setup_network(self):\r\n     +        self.setup_nodes()\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py (new)\r\n     +        #   p2p_conn_high_bw    ---> node1\r\n     +        #   node2 (no connections)\r\n     +        #\r\n    -+        # node2 produces blocks which get passed to the rest of the nodes\r\n    ++        # node2 produces blocks that are passed to the rest of the nodes\r\n     +        # through the respective p2p connections.\r\n     +\r\n    -+        self.log.info(\"Test that blocksonly nodes do not request high bandwidth mode.\")\r\n    ++        self.log.info(\"Test that -blocksonly nodes do not select peers for BIP 152 high bandwidth mode.\")\r\n     +\r\n     +        block0 = self.build_block_on_tip()\r\n     +\r\n    -+        # A blocksonly node should not request high bandwidth mode upon\r\n    ++        # A -blocksonly node should not request BIP152 high bandwidth mode upon\r\n     +        # receiving a new valid block at the tip.\r\n     +        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\r\n     +        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\r\n     +        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\r\n     +        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\r\n     +\r\n    -+        # A normal node participating in transaction relay should request high\r\n    -+        # bandwidth mode upon receiving a new valid block at the tip.\r\n    ++        # A normal node participating in transaction relay should request BIP152\r\n    ++        # high bandwidth mode upon receiving a new valid block at the tip.\r\n     +        p2p_conn_high_bw.send_and_ping(msg_block(block0))\r\n     +        assert_equal(int(self.nodes[1].getbestblockhash(), 16), block0.sha256)\r\n     +        p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\r\n2:  c99978d94 ! 2:  abe3c5cf7 [test] Test that blocksonly nodes do not send getdata(CMPCT) on a low bandwidth connection.\r\n    @@ Metadata\r\n     Author: Niklas GÃ¶gge <n.goeggi@gmail.com>\r\n     \r\n      ## Commit message ##\r\n    -    [test] Test that blocksonly nodes do not send getdata(CMPCT) on a low bandwidth connection.\r\n    +    [test] Test that -blocksonly nodes do not send getdata(CMPCT) on a low bandwidth connection.\r\n     \r\n         Co-authored-by: Amiti Uttarwar <amiti@uttarwar.org>\r\n     \r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n              p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\r\n              assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\r\n      \r\n    -+        self.log.info(\"Test that blocksonly nodes send getdata(BLOCK) instead\"\r\n    -+                      \"of getdata(CMPCT) in low bandwidth mode.\")\r\n    ++        self.log.info(\"Test that -blocksonly nodes send getdata(BLOCK) instead\"\r\n    ++                      \" of getdata(CMPCT) in BIP152 low bandwidth mode.\")\r\n     +\r\n     +        block1 = self.build_block_on_tip()\r\n     +\r\n3:  770c5f1a4 ! 3:  c652e187e [test] Test that getdata(CMPCT) is still sent on regular low bandwdith connections.\r\n    @@ Metadata\r\n     Author: Niklas GÃ¶gge <n.goeggi@gmail.com>\r\n     \r\n      ## Commit message ##\r\n    -    [test] Test that getdata(CMPCT) is still sent on regular low bandwdith connections.\r\n    +    [test] Test that getdata(CMPCT) is still sent on regular low bandwidth connections.\r\n     \r\n         Co-authored-by: Amiti Uttarwar <amiti@uttarwar.org>\r\n     \r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: from test_framework.util import\r\n      \r\n      class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n          def set_test_params(self):\r\n    --        self.num_nodes = 3\r\n     -        self.extra_args = [[\"-blocksonly\"], [], []]\r\n    -+        self.num_nodes = 4\r\n     +        self.extra_args = [[\"-blocksonly\"], [], [], []]\r\n    +         self.num_nodes = len(self.extra_args)\r\n      \r\n          def setup_network(self):\r\n    -         self.setup_nodes()\r\n     @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n      \r\n              p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n     +        #   p2p_conn_low_bw     ---> node3\r\n              #   node2 (no connections)\r\n              #\r\n    -         # node2 produces blocks which get passed to the rest of the nodes\r\n    +         # node2 produces blocks that are passed to the rest of the nodes\r\n     @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n              p2p_conn_high_bw.wait_until(lambda: p2p_conn_high_bw.message_count['sendcmpct'] == 3)\r\n              assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\r\n      \r\n    -+        # Don't send a block from the p2p_conn_low_bw so the bitcoind node\r\n    -+        # doesn't select it for high bw relay.\r\n    ++        # Don't send a block from the p2p_conn_low_bw so the low bandwidth node\r\n    ++        # doesn't select it for BIP152 high bandwidth relay.\r\n     +        self.nodes[3].submitblock(block0.serialize().hex())\r\n     +\r\n    -         self.log.info(\"Test that blocksonly nodes send getdata(BLOCK) instead\"\r\n    -                       \"of getdata(CMPCT) in low bandwidth mode.\")\r\n    +         self.log.info(\"Test that -blocksonly nodes send getdata(BLOCK) instead\"\r\n    +                       \" of getdata(CMPCT) in BIP152 low bandwidth mode.\")\r\n      \r\n     @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n              p2p_conn_high_bw.sync_send_with_ping()\r\n              assert_equal(p2p_conn_high_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\r\n      \r\n    -+        self.log.info(\"Test that getdata(CMPCT) is still sent on regular low bandwdith connections.\")\r\n    ++        self.log.info(\"Test that getdata(CMPCT) is still sent on BIP152 low bandwidth connections\"\r\n    ++                      \" when no -blocksonly nodes are involved.\")\r\n     +\r\n     +        p2p_conn_low_bw.send_and_ping(msg_headers(headers=[CBlockHeader(block1)]))\r\n     +        p2p_conn_low_bw.sync_with_ping()\r\n4:  e21f2e4f0 ! 4:  ae54485c4 [test] Test that blocksonly nodes still serve compact blocks.\r\n    @@ Metadata\r\n     Author: Niklas GÃ¶gge <n.goeggi@gmail.com>\r\n     \r\n      ## Commit message ##\r\n    -    [test] Test that blocksonly nodes still serve compact blocks.\r\n    +    [test] Test that -blocksonly nodes still serve compact blocks.\r\n     \r\n      ## test/functional/p2p_compactblocks_blocksonly.py ##\r\n     @@ test/functional/p2p_compactblocks_blocksonly.py: from test_framework.messages import (\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n              p2p_conn_low_bw.sync_with_ping()\r\n              assert_equal(p2p_conn_low_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\r\n      \r\n    -+        self.log.info(\"Test that blocksonly nodes still serve compact blocks.\")\r\n    ++        self.log.info(\"Test that -blocksonly nodes still serve compact blocks.\")\r\n     +\r\n     +        def test_for_cmpctblock(block):\r\n     +            if 'cmpctblock' not in p2p_conn_blocksonly.last_message:\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n     +        p2p_conn_blocksonly.send_message(msg_getdata([CInv(MSG_CMPCT_BLOCK, block0.sha256)]))\r\n     +        p2p_conn_blocksonly.wait_until(lambda: test_for_cmpctblock(block0))\r\n     +\r\n    -+        # Request high bandwidth mode from node0\r\n    ++        # Request BIP152 high bandwidth mode from the -blocksonly node.\r\n     +        p2p_conn_blocksonly.send_and_ping(msg_sendcmpct(announce=True, version=2))\r\n     +\r\n     +        block2 = self.build_block_on_tip()\r\n```\r\n</details>",
      "created_at" : "2021-08-13T16:56:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-898596046",
      "id" : 898596046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841j3zO",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-13T16:56:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/898596046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r688658700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688658700"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "will do this in a follow up PR.",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-13T17:03:46Z",
      "diff_hunk" : "@@ -831,6 +831,12 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n {\n     AssertLockHeld(cs_main);\n+\n+    // Never request high-bandwidth mode from peers if we're blocks-only. Our",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r688658700",
      "id" : 688658700,
      "in_reply_to_id" : 687050643,
      "line" : 835,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODY1ODcwMA==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 835,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 729813183,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T17:03:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688658700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r688658778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688658778"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "will do this in a follow up PR.",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-13T17:03:55Z",
      "diff_hunk" : "@@ -2116,7 +2122,11 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n+                    if (!m_ignore_incoming_txs &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r688658778",
      "id" : 688658778,
      "in_reply_to_id" : 687051208,
      "line" : 2125,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODY1ODc3OA==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 2125,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 729813300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T17:03:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688658778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r689391914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689391914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(micro style nits only if you retouch now or later, feel free to ignore)\r\n\r\n- s/BIP 152/BIP152/ on this one line (as elsewhere)\r\n- in general the test logging doesn't use EOL full stops/periods\r\n- in general `s/Test that/Test/` in the test logging, as all the `that`'s are needlessly verbose and add horizontal space (just my opinion though)",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-16T09:47:16Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+        self.num_nodes = len(self.extra_args)\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks that are passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that -blocksonly nodes do not select peers for BIP 152 high bandwidth mode.\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r689391914",
      "id" : 689391914,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTM5MTkxNA==",
      "original_commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "original_line" : 68,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 68,
      "pull_request_review_id" : 730523580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T10:06:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689391914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I did not modify [6dfee13](https://github.com/bitcoin/bitcoin/commit/6dfee13f650521f7542df0926aff01af9ac6a328) because i don't want to invalidate the utACKs that this commit has already gotten\r\n\r\nYour mileage may vary. In review feedback a year ago it was suggested to me to not worry too much about invalidating ACKs and I ended up \"invalidating\" 7 ACKs on that pull, which was subsequently merged. Since then I no longer worry about it and AFAICT doing so doesn't seem to have slowed anything down. (Sharing a thought in general, not for this case!)",
      "created_at" : "2021-08-16T10:43:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-899409929",
      "id" : 899409929,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841m-gJ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-16T10:43:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/899409929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r689543553"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689543553"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is an improvement. Yes, it means that you don't need to change this line if the number of nodes in the test changes, but on the other hand I think it's very useful for people reading the code to be able to see at a glance how many nodes are used in the test. Making this a `len(list_of_some_length)` makes it less readable.",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-16T13:35:53Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r689543553",
      "id" : 689543553,
      "in_reply_to_id" : 686960157,
      "line" : 27,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTU0MzU1Mw==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 27,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 27,
      "pull_request_review_id" : 730722775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T13:37:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689543553",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-16T13:38:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-899518549",
      "id" : 899518549,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5841nZBV",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-16T13:38:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/899518549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r689548769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689548769"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's fair.",
      "commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "created_at" : "2021-08-16T13:42:20Z",
      "diff_hunk" : "@@ -0,0 +1,128 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r689548769",
      "id" : 689548769,
      "in_reply_to_id" : 686960157,
      "line" : 27,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTU0ODc2OQ==",
      "original_commit_id" : "e21f2e4f04c5f15eccac529c6e8c59aba5283351",
      "original_line" : 27,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 27,
      "pull_request_review_id" : 730729736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T13:42:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689548769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r690056675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/690056675"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        self.setup_nodes()\r\n        # Start network with everyone disconnected\r\n        self.sync_all()\r\n```\r\nNot required, as its evident by definition. But wouldn't hurt having commented to specify we want an unconnected network topology. Also done in `p2p_comapctblocks_hb.py`. ",
      "commit_id" : "f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "created_at" : "2021-08-17T05:55:38Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+        self.num_nodes = len(self.extra_args)\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r690056675",
      "id" : 690056675,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MDA1NjY3NQ==",
      "original_commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "original_line" : 33,
      "original_position" : 32,
      "original_start_line" : 31,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 731357894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-17T06:49:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/690056675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r690081504"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/690081504"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It seems `message_count['sendcmpct']` is already at 2 before reaching here. So the code isn't waiting for anything. Maybe we should wait for some other things that changes after previous step? Like `block` count or `inv` count? ",
      "commit_id" : "f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "created_at" : "2021-08-17T06:46:33Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+        self.num_nodes = len(self.extra_args)\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks that are passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that -blocksonly nodes do not select peers for BIP 152 high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A -blocksonly node should not request BIP152 high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r690081504",
      "id" : 690081504,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MDA4MTUwNA==",
      "original_commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "original_line" : 76,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 731357894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-17T06:49:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/690081504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r702273124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702273124"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Changed it to wait for the  expected `block` count and after that assert that the `sendcmpct` count is still 2.",
      "commit_id" : "f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "created_at" : "2021-09-04T11:30:01Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+        self.num_nodes = len(self.extra_args)\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks that are passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that -blocksonly nodes do not select peers for BIP 152 high bandwidth mode.\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A -blocksonly node should not request BIP152 high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\n+        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r702273124",
      "id" : 702273124,
      "in_reply_to_id" : 690081504,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjI3MzEyNA==",
      "original_commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "original_line" : 76,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 746563406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-04T11:30:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702273124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r702273189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702273189"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I disagree on the third point because omitting the `that` does not sound like correct english to me. (i am not a native english speaker so i might be totally wrong)\r\nAlso a lot of the other tests also have the `that` so i kept it here.",
      "commit_id" : "f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "created_at" : "2021-09-04T11:30:40Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+        self.num_nodes = len(self.extra_args)\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks that are passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that -blocksonly nodes do not select peers for BIP 152 high bandwidth mode.\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r702273189",
      "id" : 702273189,
      "in_reply_to_id" : 689391914,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjI3MzE4OQ==",
      "original_commit_id" : "ae54485c406bcf88c94450ffceabf709d5a18379",
      "original_line" : 68,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 746563439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-04T11:30:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702273189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @rajarshimaitra and @jonatack for the reviews and advice!\r\n\r\n[`nocmpct_blocksonly_2`](https://github.com/dergoegge/bitcoin/tree/nocmpct_blocksonly_2) -> [`nocmpct_blocksonly_3`](https://github.com/dergoegge/bitcoin/tree/nocmpct_blocksonly_3)\r\n\r\n<details>\r\n<summary>git range-diff nocmpct_blocksonly_2...nocmpct_blocksonly_3</summary>\r\n\r\n```\r\n1:  1bd2f889c ! 1:  ac90610e1 [test] Test that -blocksonly nodes do not request high bandwidth mode.\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py (new)\r\n     +\r\n     +    def setup_network(self):\r\n     +        self.setup_nodes()\r\n    ++        # Start network with everyone disconnected\r\n     +        self.sync_all()\r\n     +\r\n     +    def build_block_on_tip(self):\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py (new)\r\n     +        # node2 produces blocks that are passed to the rest of the nodes\r\n     +        # through the respective p2p connections.\r\n     +\r\n    -+        self.log.info(\"Test that -blocksonly nodes do not select peers for BIP 152 high bandwidth mode.\")\r\n    ++        self.log.info(\"Test that -blocksonly nodes do not select peers for BIP152 high bandwidth mode\")\r\n     +\r\n     +        block0 = self.build_block_on_tip()\r\n     +\r\n     +        # A -blocksonly node should not request BIP152 high bandwidth mode upon\r\n     +        # receiving a new valid block at the tip.\r\n    -+        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\r\n    ++        p2p_conn_blocksonly.send_message(msg_block(block0))\r\n    ++        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['block'] == 1)\r\n     +        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\r\n    -+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['sendcmpct'] == 2)\r\n    ++        assert_equal(p2p_conn_blocksonly.message_count['sendcmpct'], 2)\r\n     +        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\r\n     +\r\n     +        # A normal node participating in transaction relay should request BIP152\r\n2:  abe3c5cf7 ! 2:  90776a869 [test] Test that -blocksonly nodes do not send getdata(CMPCT) on a low bandwidth connection.\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n              assert_equal(p2p_conn_high_bw.last_message['sendcmpct'].announce, True)\r\n      \r\n     +        self.log.info(\"Test that -blocksonly nodes send getdata(BLOCK) instead\"\r\n    -+                      \" of getdata(CMPCT) in BIP152 low bandwidth mode.\")\r\n    ++                      \" of getdata(CMPCT) in BIP152 low bandwidth mode\")\r\n     +\r\n     +        block1 = self.build_block_on_tip()\r\n     +\r\n3:  c652e187e ! 3:  e38eb9288 [test] Test that getdata(CMPCT) is still sent on regular low bandwidth connections.\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n     +        self.nodes[3].submitblock(block0.serialize().hex())\r\n     +\r\n              self.log.info(\"Test that -blocksonly nodes send getdata(BLOCK) instead\"\r\n    -                       \" of getdata(CMPCT) in BIP152 low bandwidth mode.\")\r\n    +                       \" of getdata(CMPCT) in BIP152 low bandwidth mode\")\r\n      \r\n     @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n              p2p_conn_high_bw.sync_send_with_ping()\r\n              assert_equal(p2p_conn_high_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\r\n      \r\n     +        self.log.info(\"Test that getdata(CMPCT) is still sent on BIP152 low bandwidth connections\"\r\n    -+                      \" when no -blocksonly nodes are involved.\")\r\n    ++                      \" when no -blocksonly nodes are involved\")\r\n     +\r\n     +        p2p_conn_low_bw.send_and_ping(msg_headers(headers=[CBlockHeader(block1)]))\r\n     +        p2p_conn_low_bw.sync_with_ping()\r\n4:  ae54485c4 ! 4:  f30eb1fe4 [test] Test that -blocksonly nodes still serve compact blocks.\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnl\r\n              p2p_conn_low_bw.sync_with_ping()\r\n              assert_equal(p2p_conn_low_bw.last_message['getdata'].inv, [CInv(MSG_CMPCT_BLOCK, block1.sha256)])\r\n      \r\n    -+        self.log.info(\"Test that -blocksonly nodes still serve compact blocks.\")\r\n    ++        self.log.info(\"Test that -blocksonly nodes still serve compact blocks\")\r\n     +\r\n     +        def test_for_cmpctblock(block):\r\n     +            if 'cmpctblock' not in p2p_conn_blocksonly.last_message:\r\n```\r\n</details>",
      "created_at" : "2021-09-04T11:35:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-912959004",
      "id" : 912959004,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5842aqYc",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-04T11:35:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/912959004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "created_at" : "2021-09-22T07:15:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-924653198",
      "id" : 924653198,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5843HRaO",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-22T07:15:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/924653198",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r713703646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713703646"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this would be clearer if it was explicit about the number of nodes:\r\n\r\n```suggestion\r\n        self.num_nodes = 3\r\n```\r\n\r\nChecking the number of test nodes is one of the first things I do when reading a functional test. It should be immediately obvious what the topology of the test is.",
      "commit_id" : "f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "created_at" : "2021-09-22T08:18:51Z",
      "diff_hunk" : "@@ -0,0 +1,131 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+        self.num_nodes = len(self.extra_args)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r713703646",
      "id" : 713703646,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII584qikDe",
      "original_commit_id" : "f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 28,
      "pull_request_review_id" : 760595575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T08:24:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713703646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r713707938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713707938"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems wrong. The `message_count` property is counting how many message of each type has been received _from_ the bitcoind node since the start of the test. Here, you're _sending_ a `block` message, and then waiting for the count of _received_ `block` messages to be 1.\r\n\r\nI think here it'd be better to `send_and_ping()` the block message as you were before, and then use RPC to verify that the chain tip is as expected.",
      "commit_id" : "f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "created_at" : "2021-09-22T08:23:40Z",
      "diff_hunk" : "@@ -0,0 +1,131 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+        self.num_nodes = len(self.extra_args)\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        # Start network with everyone disconnected\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks that are passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that -blocksonly nodes do not select peers for BIP152 high bandwidth mode\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A -blocksonly node should not request BIP152 high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_message(msg_block(block0))\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['block'] == 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r713707938",
      "id" : 713707938,
      "line" : 76,
      "node_id" : "PRRC_kwDOABII584qilGi",
      "original_commit_id" : "f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "original_line" : 76,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : 76,
      "pull_request_review_id" : 760595575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T08:24:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713707938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r714283242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714283242"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You are right, thanks for catching this!",
      "commit_id" : "c24c52d51cc8faaa79dc554c64ca6d1ee231f112",
      "created_at" : "2021-09-22T20:24:27Z",
      "diff_hunk" : "@@ -0,0 +1,131 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that a node in blocksonly mode does not request compact blocks.\"\"\"\n+\n+from test_framework.messages import (\n+    MSG_BLOCK,\n+    MSG_CMPCT_BLOCK,\n+    MSG_WITNESS_FLAG,\n+    CBlock,\n+    CBlockHeader,\n+    CInv,\n+    from_hex,\n+    msg_block,\n+    msg_getdata,\n+    msg_headers,\n+    msg_sendcmpct,\n+)\n+from test_framework.p2p import P2PInterface\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.extra_args = [[\"-blocksonly\"], [], [], []]\n+        self.num_nodes = len(self.extra_args)\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        # Start network with everyone disconnected\n+        self.sync_all()\n+\n+    def build_block_on_tip(self):\n+        blockhash = self.nodes[2].generate(1)[0]\n+        block_hex = self.nodes[2].getblock(blockhash=blockhash, verbosity=0)\n+        block = from_hex(CBlock(), block_hex)\n+        block.rehash()\n+        return block\n+\n+    def run_test(self):\n+        # Nodes will only request hb compact blocks mode when they're out of IBD\n+        for node in self.nodes:\n+            assert not node.getblockchaininfo()['initialblockdownload']\n+\n+        p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\n+        p2p_conn_high_bw = self.nodes[1].add_p2p_connection(P2PInterface())\n+        p2p_conn_low_bw = self.nodes[3].add_p2p_connection(P2PInterface())\n+        for conn in [p2p_conn_blocksonly, p2p_conn_high_bw, p2p_conn_low_bw]:\n+            assert_equal(conn.message_count['sendcmpct'], 2)\n+            conn.send_and_ping(msg_sendcmpct(announce=False, version=2))\n+\n+        # Nodes:\n+        #   0 -> blocksonly\n+        #   1 -> high bandwidth\n+        #   2 -> miner\n+        #   3 -> low bandwidth\n+        #\n+        # Topology:\n+        #   p2p_conn_blocksonly ---> node0\n+        #   p2p_conn_high_bw    ---> node1\n+        #   p2p_conn_low_bw     ---> node3\n+        #   node2 (no connections)\n+        #\n+        # node2 produces blocks that are passed to the rest of the nodes\n+        # through the respective p2p connections.\n+\n+        self.log.info(\"Test that -blocksonly nodes do not select peers for BIP152 high bandwidth mode\")\n+\n+        block0 = self.build_block_on_tip()\n+\n+        # A -blocksonly node should not request BIP152 high bandwidth mode upon\n+        # receiving a new valid block at the tip.\n+        p2p_conn_blocksonly.send_message(msg_block(block0))\n+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['block'] == 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r714283242",
      "id" : 714283242,
      "in_reply_to_id" : 713707938,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qkxjq",
      "original_commit_id" : "f30eb1fe4a62fd9c927ba57b2a549678bde3f3c7",
      "original_line" : 76,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 761370609,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T20:24:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714283242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "[`nocmpct_blocksonly_3`](https://github.com/dergoegge/bitcoin/tree/nocmpct_blocksonly_3) -> [`nocmpct_blocksonly_4`](https://github.com/dergoegge/bitcoin/tree/nocmpct_blocksonly_4)\r\n\r\n<details>\r\n<summary>git range-diff nocmpct_blocksonly_3...nocmpct_blocksonly_4</summary>\r\n\r\n```\r\n1:  ac90610e1 ! 1:  df6794e80 [test] Test that -blocksonly nodes do not request high bandwidth mode.\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py (new)\r\n     +class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n     +    def set_test_params(self):\r\n     +        self.extra_args = [[\"-blocksonly\"], [], []]\r\n    -+        self.num_nodes = len(self.extra_args)\r\n    ++        self.num_nodes = 3\r\n     +\r\n     +    def setup_network(self):\r\n     +        self.setup_nodes()\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py (new)\r\n     +\r\n     +        # A -blocksonly node should not request BIP152 high bandwidth mode upon\r\n     +        # receiving a new valid block at the tip.\r\n    -+        p2p_conn_blocksonly.send_message(msg_block(block0))\r\n    -+        p2p_conn_blocksonly.wait_until(lambda: p2p_conn_blocksonly.message_count['block'] == 1)\r\n    ++        p2p_conn_blocksonly.send_and_ping(msg_block(block0))\r\n     +        assert_equal(int(self.nodes[0].getbestblockhash(), 16), block0.sha256)\r\n     +        assert_equal(p2p_conn_blocksonly.message_count['sendcmpct'], 2)\r\n     +        assert_equal(p2p_conn_blocksonly.last_message['sendcmpct'].announce, False)\r\n2:  90776a869 = 2:  548115650 [test] Test that -blocksonly nodes do not send getdata(CMPCT) on a low bandwidth connection.\r\n3:  e38eb9288 ! 3:  01db031b5 [test] Test that getdata(CMPCT) is still sent on regular low bandwidth connections.\r\n    @@ test/functional/p2p_compactblocks_blocksonly.py: from test_framework.util import\r\n      class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n          def set_test_params(self):\r\n     -        self.extra_args = [[\"-blocksonly\"], [], []]\r\n    +-        self.num_nodes = 3\r\n     +        self.extra_args = [[\"-blocksonly\"], [], [], []]\r\n    -         self.num_nodes = len(self.extra_args)\r\n    ++        self.num_nodes = 4\r\n\r\n          def setup_network(self):\r\n    +         self.setup_nodes()\r\n     @@ test/functional/p2p_compactblocks_blocksonly.py: class P2PCompactBlocksBlocksOnly(BitcoinTestFramework):\r\n\r\n              p2p_conn_blocksonly = self.nodes[0].add_p2p_connection(P2PInterface())\r\n4:  f30eb1fe4 = 4:  c24c52d51 [test] Test that -blocksonly nodes still serve compact blocks.\r\n```\r\n</details>",
      "created_at" : "2021-09-22T20:24:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-925302854",
      "id" : 925302854,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5843JwBG",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-22T20:24:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/925302854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK c24c52d51cc8faaa79dc554c64ca6d1ee231f112",
      "created_at" : "2021-09-23T10:13:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-925678312",
      "id" : 925678312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5843LLro",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-23T10:13:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/925678312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK c24c52d",
      "created_at" : "2021-09-24T12:00:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-926569816",
      "id" : 926569816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5843OlVY",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-24T12:00:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926569816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on latest master.\r\n\r\n@jnewbery @theStack @jonatack @naumenkogs @rajarshimaitra I would appreciate it if you folks could have another look and re-ACK since i think this is pretty close to being ready :)",
      "created_at" : "2021-09-29T08:55:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-929976680",
      "id" : 929976680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5843blFo",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-29T08:55:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929976680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 18c5b23a0f7adf9a08bcaa967ed800badf62d90a",
      "created_at" : "2021-09-29T10:52:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-930065752",
      "id" : 930065752,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5843b61Y",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-29T10:52:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/930065752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tACK https://github.com/bitcoin/bitcoin/pull/22340/commits/18c5b23a0f7adf9a08bcaa967ed800badf62d90a",
      "created_at" : "2021-09-29T16:06:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-930318410",
      "id" : 930318410,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5843c4hK",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-29T16:06:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/930318410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK 18c5b23a0f\r\n\r\nDid the rebase myself and verified the same result.",
      "created_at" : "2021-09-29T16:18:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-930329146",
      "id" : 930329146,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5843c7I6",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-29T16:18:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/930329146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This has been merged.",
      "created_at" : "2021-10-01T06:45:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-931954516",
      "id" : 931954516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "IC_kwDOABII5843jH9U",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931954516/reactions"
      },
      "updated_at" : "2021-10-01T06:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931954516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
