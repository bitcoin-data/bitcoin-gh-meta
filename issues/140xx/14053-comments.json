[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20404 (Remove names from translatable strings by hebasto)\n* #20012 (rpc: Remove duplicate name and argNames from CRPCCommand by MarcoFalke)\n* #19873 (Flush dbcache early if system is under memory pressure by luke-jr)\n* #19806 (validation: UTXO snapshot activation by jamesob)\n* #19521 (Coinstats Index (without UTXO set hash) by fjahr)\n* #15946 (Allow maintaining the blockfilterindex when using prune by jonasschnelli)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2018-08-24T19:23:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-415858539",
      "id" : 415858539,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxNTg1ODUzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-02T19:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415858539",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213754112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213754112"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Introduce address index\" (3c7cc3c705b08828dc8dc919e53343df78568ebd)\r\n\r\nNote: this class is moved from `src/index/txindex.cpp` with no changes (except whitespace)",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-29T16:47:20Z",
      "diff_hunk" : "@@ -93,6 +96,33 @@ class BaseIndex : public CValidationInterface\n \n     /// Stops the instance from staying in sync with blockchain updates.\n     void Stop();\n+\n+    bool IsInSyncWithMainChain() const;\n+};\n+\n+struct CDiskTxPos : public CDiskBlockPos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213754112",
      "id" : 213754112,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMzc1NDExMg==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 103,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : null,
      "pull_request_review_id" : 150655713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213754112",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213756026"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213756026"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Introduce address index\" (3c7cc3c705b08828dc8dc919e53343df78568ebd)\r\n\r\nNote: new `index/addrindex.cpp`, `index/addrindex.h`, and `test/addrindex_tests.cpp` files in this commit mirror existing `index/txindex.cpp` and `index/txindex.h`, `test/txindex_tests.cpp` files and have some code and comments in common. It can help to diff the `addr` files against the `tx` files when reviewing this PR.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-29T16:53:38Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213756026",
      "id" : 213756026,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMzc1NjAyNg==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 23,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 150655713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213756026",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213770206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213770206"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Introduce address index\" (3c7cc3c705b08828dc8dc919e53343df78568ebd)\r\n\r\nI think this code could benefit from some typedefs and more consistent use of types internally to improve readability. Maybe:\r\n\r\n```\r\nusing AddressId = uint64_t;\r\nusing BlockId = uint64;\r\nusing DbKey = std::pair<std::pair<char, AddressID>, CDiskTxPos>;\r\nusing DbValue = BlockId;\r\n```\r\n\r\nI also wonder if `std::tuple<char, AddressId, CDiskTxPos>` might be a more natural key format than the nested pair.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-29T17:37:39Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213770206",
      "id" : 213770206,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMzc3MDIwNg==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 150655713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213770206",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213773597"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213773597"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Introduce address index\" (3c7cc3c705b08828dc8dc919e53343df78568ebd)\r\n\r\nCould just make this a return value instead of an output parameter. Existing return value seems redundant.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-29T17:47:55Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213773597",
      "id" : 213773597,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMzc3MzU5Nw==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 150655713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213773597",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213773659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213773659"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Introduce address index\" (3c7cc3c705b08828dc8dc919e53343df78568ebd)\r\n\r\nCould consolidate last two parameters into single `boost::optional<AddressId> filter_value` param.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-29T17:48:07Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213773659",
      "id" : 213773659,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMzc3MzY1OQ==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 57,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 150655713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213773659",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213782329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213782329"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Introduce address index\" (3c7cc3c705b08828dc8dc919e53343df78568ebd)\r\n\r\nThis sleep + BlockUntilSyncedToCurrentChain call is pretty hacky but probably ok in principle. I think @jimpo could easily tell you how to improve it. I would move this code out of the `AddrIndex` class and into a `g_txindex->WaitForSync()` or similar method, and probably replace the sleep with a condition variable wait.\r\n\r\nOr maybe this code will be unnecessary with #14035 undo data?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-29T18:14:05Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213782329",
      "id" : 213782329,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMzc4MjMyOQ==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 124,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 150655713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213782329",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213785140"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213785140"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Introduce address index\" (3c7cc3c705b08828dc8dc919e53343df78568ebd)\r\n\r\nShould probably reorder this condition. It seems pointless to retrieve the value when the key is wrong, and maybe dangerous if the value is a different format and deserializing could throw an exception.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-29T18:22:29Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213785140",
      "id" : 213785140,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMzc4NTE0MA==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 66,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 150655713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213785140",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213788343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213788343"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add searchrawtransactions RPC\" (226eeea9736127269058fbbf7816c7100f90974d)\r\n\r\nShould add a basic python functional test for the new RPC method.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-29T18:32:17Z",
      "diff_hunk" : "@@ -203,6 +204,123 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r213788343",
      "id" : 213788343,
      "line" : 223,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMzc4ODM0Mw==",
      "original_commit_id" : "226eeea9736127269058fbbf7816c7100f90974d",
      "original_line" : 223,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 12,
      "pull_request_review_id" : 150655713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/213788343",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214013007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214013007"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There is no such thing as a \"spend from address\"",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T12:37:52Z",
      "diff_hunk" : "@@ -1611,6 +1625,13 @@ bool AppInitMain()\n         g_txindex->Start();\n     }\n \n+    if (gArgs.GetBoolArg(\"-addrindex\", DEFAULT_ADDRINDEX)) {\n+        if (!g_txindex)\n+            InitWarning(_(\"-txindex must be enabled for -addrindex to index spends from addresses.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214013007",
      "id" : 214013007,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDAxMzAwNw==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 1630,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 150972075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214013007",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214013753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214013753"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`skip` and `count` probably make sense on an options object instead.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T12:40:10Z",
      "diff_hunk" : "@@ -203,6 +204,129 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+            \"searchrawtransactions <address> [verbose=true] [skip=0] [count=100]\\n\"\n+            \"\\nReturns raw transactions that contain the given address and the hash of the block(s) they were found in.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\"\n+            \"1. \\\"address\\\"    (string, required) The address to search for\\n\"\n+            \"2. \\\"verbose\\\"    (bool, optional, default = false) If set to false, only returns data for hex-encoded `txid`s. \\n\"\n+            \"3. \\\"skip\\\"       (numeric, optional, default = 0) If set, the result skips this number of initial values. \\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214013753",
      "id" : 214013753,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDAxMzc1Mw==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 216,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 150972977,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214013753",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214013906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214013906"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(this would be number 4, but n/a once on an options object)",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T12:40:32Z",
      "diff_hunk" : "@@ -203,6 +204,129 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+            \"searchrawtransactions <address> [verbose=true] [skip=0] [count=100]\\n\"\n+            \"\\nReturns raw transactions that contain the given address and the hash of the block(s) they were found in.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\"\n+            \"1. \\\"address\\\"    (string, required) The address to search for\\n\"\n+            \"2. \\\"verbose\\\"    (bool, optional, default = false) If set to false, only returns data for hex-encoded `txid`s. \\n\"\n+            \"3. \\\"skip\\\"       (numeric, optional, default = 0) If set, the result skips this number of initial values. \\n\"\n+            \"3. \\\"count\\\"      (numeric, optional, default = 100) If set, the result will only contain this amount of values. \\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214013906",
      "id" : 214013906,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDAxMzkwNg==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 217,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 150972977,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214013906",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214015214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214015214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This basically shouldn't be here. The address used to receive a coin has zero relationship with the transaction spending that coin.\r\n\r\nIf someone really cares about getting it anyway, there should be a separate input txid/index -> spend txid index.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T12:45:05Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214015214",
      "id" : 214015214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDAxNTIxNA==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 114,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 150972977,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214015214",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214015281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214015281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This looks like a very fragile assumption.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T12:45:18Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.\n+                    }\n+\n+                    // It's also possible we can't find the tx in txindex because it fell behind in\n+                    // the ValidationInterface queue. In this case we also let it finish before continuing.\n+                    g_txindex->BlockUntilSyncedToCurrentChain();\n+\n+                    // If we still can't find the tx then a re-org may have happened.\n+                    if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214015281",
      "id" : 214015281,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDAxNTI4MQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 132,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 150972977,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214015281",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214015451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214015451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "With this, why is the loop waiting for IsInSyncWithMainChain needed?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T12:45:50Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.\n+                    }\n+\n+                    // It's also possible we can't find the tx in txindex because it fell behind in\n+                    // the ValidationInterface queue. In this case we also let it finish before continuing.\n+                    g_txindex->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214015451",
      "id" : 214015451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDAxNTQ1MQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 129,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 150972977,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214015451",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214093388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214093388"
         }
      },
      "author_association" : "NONE",
      "body" : "`BlockUntilSyncedToCurrentChain` returns false immediately if `m_synced` is false.\r\n\r\nThe loop waiting for `IsInSyncWithMainChain` waits for txindex to finish in `ThreadSync`. Once txindex finishes in `ThreadSync` it will be updated by ValiditionInterface callbacks from that point on.\r\n\r\nThis line (since txindex must have `m_synced` =  true now) will actually block now until txindex syncs with the ValidationInterface queue.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T16:16:00Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.\n+                    }\n+\n+                    // It's also possible we can't find the tx in txindex because it fell behind in\n+                    // the ValidationInterface queue. In this case we also let it finish before continuing.\n+                    g_txindex->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214093388",
      "id" : 214093388,
      "in_reply_to_id" : 214015451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDA5MzM4OA==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 129,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 151073881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214093388",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214136359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214136359"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: Introduce address index\r\n\r\nCan you move this comment to `BaseIndex::DB` and delete from `TxIndex::DB` as well? No need to copy it to every new index file, especially since it's handled at the base layer.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T18:31:21Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214136359",
      "id" : 214136359,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDEzNjM1OQ==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 25,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214136359",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214149325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214149325"
         }
      },
      "author_association" : "NONE",
      "body" : "This needs an `if (!m_synced) return;`",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T19:14:05Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.\n+                    }\n+\n+                    // It's also possible we can't find the tx in txindex because it fell behind in\n+                    // the ValidationInterface queue. In this case we also let it finish before continuing.\n+                    g_txindex->BlockUntilSyncedToCurrentChain();\n+\n+                    // If we still can't find the tx then a re-org may have happened.\n+                    if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) return false;\n+                }\n+\n+                CScript script_pub_key = tx->vout[tx_in.prevout.n].scriptPubKey;\n+                positions.emplace_back(GetAddrID(script_pub_key), pos);\n+            }\n+        }\n+\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+\n+    return m_db->WriteToIndex(positions, block.GetHash());\n+}\n+\n+bool AddrIndex::DB::WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>>& positions, const uint256 block_hash)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& pos : positions) {\n+        // Insert (address, position) pair with a part of the block hash.\n+        // Different transactions for the same address will be differentiated\n+        // in leveldb by their CDiskTxPos suffix.\n+        batch.Write(std::make_pair(std::make_pair(DB_ADDRINDEX, pos.first), pos.second), block_hash.GetUint64(0));\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+void AddrIndex::BlockDisconnected(const std::shared_ptr<const CBlock> &block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214149325",
      "id" : 214149325,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDE0OTMyNQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 158,
      "original_position" : 158,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 151142587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214149325",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214203100"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214203100"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Spends from an address should at least get indexed under a separate key prefix even if it's done by the same indexer.\r\n\r\nUsing the undo files is a much better way to get this information than the txindex.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T22:45:49Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214203100",
      "id" : 214203100,
      "in_reply_to_id" : 214015214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDIwMzEwMA==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 114,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214203100",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214203436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214203436"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There should be a way of differentiating between txs where the script is the output and ones that spend from the address. Perhaps two methods or two output vector parameters.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T22:47:56Z",
      "diff_hunk" : "@@ -0,0 +1,56 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_ADDRINDEX_H\n+#define BITCOIN_INDEX_ADDRINDEX_H\n+\n+#include <chain.h>\n+#include <index/base.h>\n+#include <vector>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <script/script.h>\n+\n+/**\n+ * AddrIndex is used to look up transactions included in the blockchain by script.\n+ * The index is written to a LevelDB database and records the filesystem\n+ * location of transactions by script.\n+ */\n+class AddrIndex final : public BaseIndex\n+{\n+protected:\n+    class DB;\n+\n+private:\n+    const std::unique_ptr<DB> m_db;\n+\n+protected:\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex) override;\n+\n+    BaseIndex::DB& GetDB() const override;\n+\n+    void BlockDisconnected(const std::shared_ptr<const CBlock> &block) override;\n+\n+    const char* GetName() const override { return \"addrindex\"; }\n+\n+public:\n+    /// Constructs the index, which becomes available to be queried.\n+    explicit AddrIndex(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Destructor is declared because this class contains a unique_ptr to an incomplete type.\n+    virtual ~AddrIndex() override;\n+\n+    /// Lookup transaction(s) by scriptPubKey. Fills txs vector with (block_hash, tx) pairs.\n+    bool FindTxsByScript(const CScript& dest, std::vector<std::pair<uint256, CTransactionRef>> &txs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214203436",
      "id" : 214203436,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDIwMzQzNg==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 47,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/index/addrindex.h",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214203436",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214203723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214203723"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A better way to do it is to loop until `BlockUntilSyncedToCurrentChain` becomes true.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T22:49:33Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.\n+                    }\n+\n+                    // It's also possible we can't find the tx in txindex because it fell behind in\n+                    // the ValidationInterface queue. In this case we also let it finish before continuing.\n+                    g_txindex->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214203723",
      "id" : 214203723,
      "in_reply_to_id" : 214015451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDIwMzcyMw==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 129,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214203723",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204067"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Use the undo files instead of CCoinsViewCache.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T22:51:37Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.\n+                    }\n+\n+                    // It's also possible we can't find the tx in txindex because it fell behind in\n+                    // the ValidationInterface queue. In this case we also let it finish before continuing.\n+                    g_txindex->BlockUntilSyncedToCurrentChain();\n+\n+                    // If we still can't find the tx then a re-org may have happened.\n+                    if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) return false;\n+                }\n+\n+                CScript script_pub_key = tx->vout[tx_in.prevout.n].scriptPubKey;\n+                positions.emplace_back(GetAddrID(script_pub_key), pos);\n+            }\n+        }\n+\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+\n+    return m_db->WriteToIndex(positions, block.GetHash());\n+}\n+\n+bool AddrIndex::DB::WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>>& positions, const uint256 block_hash)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& pos : positions) {\n+        // Insert (address, position) pair with a part of the block hash.\n+        // Different transactions for the same address will be differentiated\n+        // in leveldb by their CDiskTxPos suffix.\n+        batch.Write(std::make_pair(std::make_pair(DB_ADDRINDEX, pos.first), pos.second), block_hash.GetUint64(0));\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+void AddrIndex::BlockDisconnected(const std::shared_ptr<const CBlock> &block) {\n+    const uint64_t block_hash_bits = block->GetHash().GetUint64(0);\n+    std::unordered_set<uint64_t> addr_ids_to_remove;\n+\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204067",
      "id" : 214204067,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDIwNDA2Nw==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 162,
      "original_position" : 162,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204067",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204133"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204133"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This shouldn't be necessary.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T22:52:00Z",
      "diff_hunk" : "@@ -276,3 +278,8 @@ void BaseIndex::Stop()\n         m_thread_sync.join();\n     }\n }\n+\n+\n+bool BaseIndex::IsInSyncWithMainChain() const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204133",
      "id" : 214204133,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDIwNDEzMw==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 283,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204133",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204265"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why? The implementation is empty.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T22:52:49Z",
      "diff_hunk" : "@@ -61,6 +62,8 @@ class BaseIndex : public CValidationInterface\n     void BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n                         const std::vector<CTransactionRef>& txn_conflicted) override;\n \n+    void BlockDisconnected(const std::shared_ptr<const CBlock> &block) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204265",
      "id" : 214204265,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDIwNDI2NQ==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 65,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204265",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204406"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'd vote to move it to it's own file, like `src/index/disktxpos.{h,cpp}`.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T22:53:47Z",
      "diff_hunk" : "@@ -93,6 +96,33 @@ class BaseIndex : public CValidationInterface\n \n     /// Stops the instance from staying in sync with blockchain updates.\n     void Stop();\n+\n+    bool IsInSyncWithMainChain() const;\n+};\n+\n+struct CDiskTxPos : public CDiskBlockPos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204406",
      "id" : 214204406,
      "in_reply_to_id" : 213754112,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDIwNDQwNg==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 103,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204406",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204889"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why is this exposed? It seems internal.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T22:56:35Z",
      "diff_hunk" : "@@ -0,0 +1,56 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_ADDRINDEX_H\n+#define BITCOIN_INDEX_ADDRINDEX_H\n+\n+#include <chain.h>\n+#include <index/base.h>\n+#include <vector>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <script/script.h>\n+\n+/**\n+ * AddrIndex is used to look up transactions included in the blockchain by script.\n+ * The index is written to a LevelDB database and records the filesystem\n+ * location of transactions by script.\n+ */\n+class AddrIndex final : public BaseIndex\n+{\n+protected:\n+    class DB;\n+\n+private:\n+    const std::unique_ptr<DB> m_db;\n+\n+protected:\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex) override;\n+\n+    BaseIndex::DB& GetDB() const override;\n+\n+    void BlockDisconnected(const std::shared_ptr<const CBlock> &block) override;\n+\n+    const char* GetName() const override { return \"addrindex\"; }\n+\n+public:\n+    /// Constructs the index, which becomes available to be queried.\n+    explicit AddrIndex(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Destructor is declared because this class contains a unique_ptr to an incomplete type.\n+    virtual ~AddrIndex() override;\n+\n+    /// Lookup transaction(s) by scriptPubKey. Fills txs vector with (block_hash, tx) pairs.\n+    bool FindTxsByScript(const CScript& dest, std::vector<std::pair<uint256, CTransactionRef>> &txs);\n+\n+    // Returns part of key used to store information in db.\n+    static uint64_t GetAddrID(const CScript& script);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214204889",
      "id" : 214204889,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDIwNDg4OQ==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 50,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/index/addrindex.h",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214204889",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214205452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214205452"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems that `filter_by_value` functionality isn't used? Also, I'd rename to something like `filter_by_block` because it's not clear what value means and is tightly coupled to the database layout chosen.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-08-30T23:00:15Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r214205452",
      "id" : 214205452,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNDIwNTQ1Mg==",
      "original_commit_id" : "3c7cc3c705b08828dc8dc919e53343df78568ebd",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 151126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/214205452",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for all the reviews. \r\n\r\nTo answer some of @jimpo's questions:\r\n2 & 4. I included part of the block hash so that in BlockDisconnected we ae sure to remove the entries in the index from this block only (that's where  `filter_by_value` is used). The reason I chose to remove entries from the database is to prevent reading into a block file using an old `CDiskTxPos`  that may no longer be a valid position. Otherwise in `FindTxsByScript` you could run into errors. You're right that this problem would be better handled by higher level methods.\r\n\r\nI think that returning just the outpoint is a better idea than the current choice so I'll switch to that and try to incorporate all the other feedback here.",
      "created_at" : "2018-08-31T15:19:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-417697510",
      "id" : 417697510,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxNzY5NzUxMA==",
      "updated_at" : "2018-08-31T15:19:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/417697510",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215161819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215161819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Redundant condition `filter_by_value`: what about `!filter_by_value || value == value_wanted` instead?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-05T07:30:12Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215161819",
      "id" : 215161819,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTE2MTgxOQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 68,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 152365361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215161819",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215161936"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215161936"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`block_hash` should be passed by const reference?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-05T07:30:41Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.\n+                    }\n+\n+                    // It's also possible we can't find the tx in txindex because it fell behind in\n+                    // the ValidationInterface queue. In this case we also let it finish before continuing.\n+                    g_txindex->BlockUntilSyncedToCurrentChain();\n+\n+                    // If we still can't find the tx then a re-org may have happened.\n+                    if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) return false;\n+                }\n+\n+                CScript script_pub_key = tx->vout[tx_in.prevout.n].scriptPubKey;\n+                positions.emplace_back(GetAddrID(script_pub_key), pos);\n+            }\n+        }\n+\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+\n+    return m_db->WriteToIndex(positions, block.GetHash());\n+}\n+\n+bool AddrIndex::DB::WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>>& positions, const uint256 block_hash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215161936",
      "id" : 215161936,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTE2MTkzNg==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 146,
      "original_position" : 146,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 152365501,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215161936",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215161992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215161992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`prev_hash` should be passed by const reference?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-05T07:30:58Z",
      "diff_hunk" : "@@ -173,6 +175,76 @@ TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransaction>&\n     return result;\n }\n \n+// Based off of BuildChain in validation_block_tests.cpp\n+\n+// Build a chain of blocks that contains all of the transactions in txns.\n+void TestChain100Setup::BuildChain(const uint256 prev_hash, const uint32_t prev_time, int height, std::vector<CMutableTransaction> &txns, const CScript& scriptPubKey, std::vector<std::shared_ptr<const CBlock>>& blocks) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215161992",
      "id" : 215161992,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTE2MTk5Mg==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 181,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/test/test_bitcoin.cpp",
      "position" : null,
      "pull_request_review_id" : 152365584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215161992",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215162067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215162067"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`prev_hash` should be passed by const reference?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-05T07:31:15Z",
      "diff_hunk" : "@@ -89,6 +89,15 @@ struct TestChain100Setup : public TestingSetup {\n     CBlock CreateAndProcessBlock(const std::vector<CMutableTransaction>& txns,\n                                  const CScript& scriptPubKey);\n \n+    void BuildChain(const uint256 prev_hash,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215162067",
      "id" : 215162067,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTE2MjA2Nw==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 92,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/test_bitcoin.h",
      "position" : null,
      "pull_request_review_id" : 152365666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215162067",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215162287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215162287"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`coinbase_script_pub_key` should be passed by const reference?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-05T07:32:04Z",
      "diff_hunk" : "@@ -173,6 +175,76 @@ TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransaction>&\n     return result;\n }\n \n+// Based off of BuildChain in validation_block_tests.cpp\n+\n+// Build a chain of blocks that contains all of the transactions in txns.\n+void TestChain100Setup::BuildChain(const uint256 prev_hash, const uint32_t prev_time, int height, std::vector<CMutableTransaction> &txns, const CScript& scriptPubKey, std::vector<std::shared_ptr<const CBlock>>& blocks) {\n+    if (height <= 0) return;\n+\n+    const CChainParams& chainparams = Params();\n+    std::unique_ptr<CBlockTemplate> pblocktemplate = BlockAssembler(chainparams).CreateNewBlock(scriptPubKey);\n+    CBlock& block = pblocktemplate->block;\n+\n+    // Replace mempool-selected txns with just coinbase plus some of the passed-in txns:\n+    block.vtx.resize(1);\n+\n+    // If this is the last block, add all remaining transactions.\n+    // Otherwise add with some randomness.\n+    for (auto it = txns.begin(); it != txns.end();) {\n+        bool add_tx = (height == 1) || (GetRandInt(height) < txns.size());\n+\n+        if (add_tx) {\n+            CMutableTransaction tx = *it;\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+            it = txns.erase(it);\n+        } else {\n+            it++;\n+        }\n+    }\n+\n+    block.hashPrevBlock = prev_hash;\n+    block.nTime = prev_time + 1;\n+\n+    // This is the body of IncrementExtraNonce, modified specifically for this function.\n+    // (IncrementExtraNonce creates a valid coinbase and merkleRoot)\n+    // Height first in coinbase required for block.version=2\n+    unsigned int extraNonce = 1;\n+    unsigned int nHeight = chainActive.Tip()->nHeight+1+blocks.size();\n+    CMutableTransaction txCoinbase(*block.vtx[0]);\n+    txCoinbase.vin[0].scriptSig = (CScript() << nHeight << CScriptNum(extraNonce)) + COINBASE_FLAGS;\n+    assert(txCoinbase.vin[0].scriptSig.size() <= 100);\n+\n+    block.vtx[0] = MakeTransactionRef(std::move(txCoinbase));\n+    block.hashMerkleRoot = BlockMerkleRoot(block);\n+\n+    while (!CheckProofOfWork(block.GetHash(), block.nBits, chainparams.GetConsensus())) ++block.nNonce;\n+\n+    std::shared_ptr<const CBlock> shared_pblock = std::make_shared<const CBlock>(block);\n+    blocks.push_back(shared_pblock);\n+\n+    BuildChain(blocks.back()->GetHash(), blocks.back()->nTime, height - 1, txns, scriptPubKey, blocks);\n+}\n+\n+void TestChain100Setup::CreateSpendingTxs(int coinbase_spent_offset, std::vector<CScript>& script_pub_keys, std::vector<CMutableTransaction> &spends, CScript coinbase_script_pub_key) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215162287",
      "id" : 215162287,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTE2MjI4Nw==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 228,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/test/test_bitcoin.cpp",
      "position" : null,
      "pull_request_review_id" : 152365920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215162287",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215162430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215162430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: `++it`",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-05T07:32:35Z",
      "diff_hunk" : "@@ -203,6 +204,129 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+            \"searchrawtransactions <address> [verbose=true] [skip=0] [count=100]\\n\"\n+            \"\\nReturns raw transactions that contain the given address and the hash of the block(s) they were found in.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\"\n+            \"1. \\\"address\\\"    (string, required) The address to search for\\n\"\n+            \"2. \\\"verbose\\\"    (bool, optional, default = false) If set to false, only returns data for hex-encoded `txid`s. \\n\"\n+            \"3. \\\"skip\\\"       (numeric, optional, default = 0) If set, the result skips this number of initial values. \\n\"\n+            \"3. \\\"count\\\"      (numeric, optional, default = 100) If set, the result will only contain this amount of values. \\n\"\n+            \"\\nResult:\\n\"\n+            \" [                                    (array of json objects)\\n\"\n+            \"   {\\n\"\n+            \"      \\\"hex\\\" : \\\"data\\\",             (string) The serialized, hex-encoded data for 'txid'\\n\"\n+            \"      \\\"txid\\\" : \\\"id\\\",              (string) The transaction id (same as provided)\\n\"\n+            \"      \\\"hash\\\" : \\\"id\\\",              (string) The transaction hash (differs from txid for witness transactions)\\n\"\n+            \"      \\\"size\\\" : n,                   (numeric) The serialized transaction size\\n\"\n+            \"      \\\"vsize\\\" : n,                  (numeric) The virtual transaction size (differs from size for witness transactions)\\n\"\n+            \"      \\\"weight\\\" : n,                 (numeric) The transaction's weight (between vsize*4-3 and vsize*4)\\n\"\n+            \"      \\\"version\\\" : n,                (numeric) The version\\n\"\n+            \"      \\\"locktime\\\" : ttt,             (numeric) The lock time\\n\"\n+            \"      \\\"vin\\\" : [                     (array of json objects)\\n\"\n+            \"        {\\n\"\n+            \"          \\\"txid\\\": \\\"id\\\",           (string) The transaction id\\n\"\n+            \"          \\\"vout\\\": n,                (numeric) \\n\"\n+            \"          \\\"scriptSig\\\": {            (json object) The script\\n\"\n+            \"            \\\"asm\\\": \\\"asm\\\",         (string) asm\\n\"\n+            \"            \\\"hex\\\": \\\"hex\\\"          (string) hex\\n\"\n+            \"        },\\n\"\n+            \"      \\\"sequence\\\": n                 (numeric) The script sequence number\\n\"\n+            \"      \\\"txinwitness\\\": [\\\"hex\\\", ...] (array of string) hex-encoded witness data (if any)\\n\"\n+            \"    }\\n\"\n+            \"    ,...\\n\"\n+            \"    \\\"vout\\\" : [                       (array of json objects)\\n\"\n+            \"       {\\n\"\n+            \"         \\\"value\\\" : x.xxx,            (numeric) The value in \" + CURRENCY_UNIT + \"\\n\"\n+            \"         \\\"n\\\" : n,                    (numeric) index\\n\"\n+            \"         \\\"scriptPubKey\\\" : {          (json object)\\n\"\n+            \"           \\\"asm\\\" : \\\"asm\\\",          (string) the asm\\n\"\n+            \"           \\\"hex\\\" : \\\"hex\\\",          (string) the hex\\n\"\n+            \"           \\\"reqSigs\\\" : n,            (numeric) The required sigs\\n\"\n+            \"           \\\"type\\\" : \\\"pubkeyhash\\\",  (string) The type, eg 'pubkeyhash'\\n\"\n+            \"           \\\"addresses\\\" : [           (json array of string)\\n\"\n+            \"             \\\"address\\\"               (string) bitcoin address\\n\"\n+            \"             ,...\\n\"\n+            \"           ]\\n\"\n+            \"         }\\n\"\n+            \"       }\\n\"\n+            \"       ,...\\n\"\n+            \"    ],\\n\"\n+            \"    \\\"blockhash\\\" : \\\"hash\\\",         (string) the block hash\\n\"\n+            \"  }\\n\"\n+            \" ]\\n\"\n+            );\n+\n+\n+    CScript scriptPubKey;\n+    const CTxDestination dest = DecodeDestination(request.params[0].get_str());\n+    if(IsValidDestination(dest)) {\n+        scriptPubKey = GetScriptForDestination(dest);\n+    } else if(IsHex(request.params[0].get_str())) {\n+        std::vector<unsigned char> data(ParseHex(request.params[0].get_str()));\n+        scriptPubKey = CScript(data.begin(), data.end());\n+    } else {\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address or script\");\n+    }\n+\n+    // Accept either a bool (true) or a num (>=1) to indicate verbose output.\n+    bool verbose = false;\n+    if (!request.params[1].isNull()) {\n+        verbose = request.params[1].isNum() ? (request.params[1].get_int() != 0) : request.params[1].get_bool();\n+    }\n+\n+    int skip = 0;\n+    int count = 100;\n+    if (request.params.size() > 2) {\n+        if (!request.params[2].isNum()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid parameter, argument 3 must be an integer\");\n+        }\n+        skip = request.params[2].get_int();\n+    }\n+    if (request.params.size() > 3) {\n+        if (!request.params[3].isNum()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid parameter, argument 4 must be an integer\");\n+        }\n+        count = request.params[3].get_int();\n+    }\n+\n+    if (!g_addrindex) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"This RPC requires -addrindex to be enabled.\");\n+    }\n+\n+    bool addrindex_ready = g_addrindex->BlockUntilSyncedToCurrentChain();\n+\n+    UniValue ret(UniValue::VARR);\n+    std::vector<std::pair<uint256, CTransactionRef>> result;\n+    if (!g_addrindex->FindTxsByScript(scriptPubKey, result)) {\n+        if (!addrindex_ready) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY,\"Transactions with given address not found. Blockchain transactions are still in the process of being indexed\");\n+        }\n+        return ret;\n+    }\n+\n+    std::vector<std::pair<uint256, CTransactionRef>>::const_iterator it = result.begin();\n+    while (it != result.end() && skip--) it++; // Skip first set of results as needed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215162430",
      "id" : 215162430,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTE2MjQzMA==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 312,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 152366108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215162430",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215162543"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215162543"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: `++it`",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-05T07:32:59Z",
      "diff_hunk" : "@@ -203,6 +204,129 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+            \"searchrawtransactions <address> [verbose=true] [skip=0] [count=100]\\n\"\n+            \"\\nReturns raw transactions that contain the given address and the hash of the block(s) they were found in.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\"\n+            \"1. \\\"address\\\"    (string, required) The address to search for\\n\"\n+            \"2. \\\"verbose\\\"    (bool, optional, default = false) If set to false, only returns data for hex-encoded `txid`s. \\n\"\n+            \"3. \\\"skip\\\"       (numeric, optional, default = 0) If set, the result skips this number of initial values. \\n\"\n+            \"3. \\\"count\\\"      (numeric, optional, default = 100) If set, the result will only contain this amount of values. \\n\"\n+            \"\\nResult:\\n\"\n+            \" [                                    (array of json objects)\\n\"\n+            \"   {\\n\"\n+            \"      \\\"hex\\\" : \\\"data\\\",             (string) The serialized, hex-encoded data for 'txid'\\n\"\n+            \"      \\\"txid\\\" : \\\"id\\\",              (string) The transaction id (same as provided)\\n\"\n+            \"      \\\"hash\\\" : \\\"id\\\",              (string) The transaction hash (differs from txid for witness transactions)\\n\"\n+            \"      \\\"size\\\" : n,                   (numeric) The serialized transaction size\\n\"\n+            \"      \\\"vsize\\\" : n,                  (numeric) The virtual transaction size (differs from size for witness transactions)\\n\"\n+            \"      \\\"weight\\\" : n,                 (numeric) The transaction's weight (between vsize*4-3 and vsize*4)\\n\"\n+            \"      \\\"version\\\" : n,                (numeric) The version\\n\"\n+            \"      \\\"locktime\\\" : ttt,             (numeric) The lock time\\n\"\n+            \"      \\\"vin\\\" : [                     (array of json objects)\\n\"\n+            \"        {\\n\"\n+            \"          \\\"txid\\\": \\\"id\\\",           (string) The transaction id\\n\"\n+            \"          \\\"vout\\\": n,                (numeric) \\n\"\n+            \"          \\\"scriptSig\\\": {            (json object) The script\\n\"\n+            \"            \\\"asm\\\": \\\"asm\\\",         (string) asm\\n\"\n+            \"            \\\"hex\\\": \\\"hex\\\"          (string) hex\\n\"\n+            \"        },\\n\"\n+            \"      \\\"sequence\\\": n                 (numeric) The script sequence number\\n\"\n+            \"      \\\"txinwitness\\\": [\\\"hex\\\", ...] (array of string) hex-encoded witness data (if any)\\n\"\n+            \"    }\\n\"\n+            \"    ,...\\n\"\n+            \"    \\\"vout\\\" : [                       (array of json objects)\\n\"\n+            \"       {\\n\"\n+            \"         \\\"value\\\" : x.xxx,            (numeric) The value in \" + CURRENCY_UNIT + \"\\n\"\n+            \"         \\\"n\\\" : n,                    (numeric) index\\n\"\n+            \"         \\\"scriptPubKey\\\" : {          (json object)\\n\"\n+            \"           \\\"asm\\\" : \\\"asm\\\",          (string) the asm\\n\"\n+            \"           \\\"hex\\\" : \\\"hex\\\",          (string) the hex\\n\"\n+            \"           \\\"reqSigs\\\" : n,            (numeric) The required sigs\\n\"\n+            \"           \\\"type\\\" : \\\"pubkeyhash\\\",  (string) The type, eg 'pubkeyhash'\\n\"\n+            \"           \\\"addresses\\\" : [           (json array of string)\\n\"\n+            \"             \\\"address\\\"               (string) bitcoin address\\n\"\n+            \"             ,...\\n\"\n+            \"           ]\\n\"\n+            \"         }\\n\"\n+            \"       }\\n\"\n+            \"       ,...\\n\"\n+            \"    ],\\n\"\n+            \"    \\\"blockhash\\\" : \\\"hash\\\",         (string) the block hash\\n\"\n+            \"  }\\n\"\n+            \" ]\\n\"\n+            );\n+\n+\n+    CScript scriptPubKey;\n+    const CTxDestination dest = DecodeDestination(request.params[0].get_str());\n+    if(IsValidDestination(dest)) {\n+        scriptPubKey = GetScriptForDestination(dest);\n+    } else if(IsHex(request.params[0].get_str())) {\n+        std::vector<unsigned char> data(ParseHex(request.params[0].get_str()));\n+        scriptPubKey = CScript(data.begin(), data.end());\n+    } else {\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address or script\");\n+    }\n+\n+    // Accept either a bool (true) or a num (>=1) to indicate verbose output.\n+    bool verbose = false;\n+    if (!request.params[1].isNull()) {\n+        verbose = request.params[1].isNum() ? (request.params[1].get_int() != 0) : request.params[1].get_bool();\n+    }\n+\n+    int skip = 0;\n+    int count = 100;\n+    if (request.params.size() > 2) {\n+        if (!request.params[2].isNum()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid parameter, argument 3 must be an integer\");\n+        }\n+        skip = request.params[2].get_int();\n+    }\n+    if (request.params.size() > 3) {\n+        if (!request.params[3].isNum()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid parameter, argument 4 must be an integer\");\n+        }\n+        count = request.params[3].get_int();\n+    }\n+\n+    if (!g_addrindex) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"This RPC requires -addrindex to be enabled.\");\n+    }\n+\n+    bool addrindex_ready = g_addrindex->BlockUntilSyncedToCurrentChain();\n+\n+    UniValue ret(UniValue::VARR);\n+    std::vector<std::pair<uint256, CTransactionRef>> result;\n+    if (!g_addrindex->FindTxsByScript(scriptPubKey, result)) {\n+        if (!addrindex_ready) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY,\"Transactions with given address not found. Blockchain transactions are still in the process of being indexed\");\n+        }\n+        return ret;\n+    }\n+\n+    std::vector<std::pair<uint256, CTransactionRef>>::const_iterator it = result.begin();\n+    while (it != result.end() && skip--) it++; // Skip first set of results as needed.\n+    while (it != result.end() && count--) {\n+        const auto& tuple = *it;\n+        UniValue tx_val(UniValue::VOBJ);\n+        if (verbose) {\n+            TxToJSON(*(tuple.second), tuple.first, tx_val);\n+        } else {\n+            std::string hex_tx = EncodeHexTx(*(tuple.second), RPCSerializationFlags());\n+            tx_val.pushKV(\"hex\", hex_tx);\n+            tx_val.pushKV(\"blockhash\", tuple.first.GetHex());\n+        }\n+        ret.push_back(tx_val);\n+        it++;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215162543",
      "id" : 215162543,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTE2MjU0Mw==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 324,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 152366243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215162543",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215762841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215762841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\ntest/test_bitcoin.cpp:194:60: warning: comparison of integers of different signs: 'int' and 'std::vector::size_type' (aka 'unsigned long') [-Wsign-compare]\r\n        bool add_tx = (height == 1) || (GetRandInt(height) < txns.size());\r\n                                        ~~~~~~~~~~~~~~~~~~ ^ ~~~~~~~~~~~\r\n```",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-06T20:16:34Z",
      "diff_hunk" : "@@ -173,6 +175,76 @@ TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransaction>&\n     return result;\n }\n \n+// Based off of BuildChain in validation_block_tests.cpp\n+\n+// Build a chain of blocks that contains all of the transactions in txns.\n+void TestChain100Setup::BuildChain(const uint256 prev_hash, const uint32_t prev_time, int height, std::vector<CMutableTransaction> &txns, const CScript& scriptPubKey, std::vector<std::shared_ptr<const CBlock>>& blocks) {\n+    if (height <= 0) return;\n+\n+    const CChainParams& chainparams = Params();\n+    std::unique_ptr<CBlockTemplate> pblocktemplate = BlockAssembler(chainparams).CreateNewBlock(scriptPubKey);\n+    CBlock& block = pblocktemplate->block;\n+\n+    // Replace mempool-selected txns with just coinbase plus some of the passed-in txns:\n+    block.vtx.resize(1);\n+\n+    // If this is the last block, add all remaining transactions.\n+    // Otherwise add with some randomness.\n+    for (auto it = txns.begin(); it != txns.end();) {\n+        bool add_tx = (height == 1) || (GetRandInt(height) < txns.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215762841",
      "id" : 215762841,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2Mjg0MQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 194,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/test/test_bitcoin.cpp",
      "position" : null,
      "pull_request_review_id" : 153102413,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215762841",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763081"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\nindex/addrindex.cpp:110:25: warning: loop variable 'tx_out' of type 'const CTxOut' creates a copy from type 'const CTxOut' [-Wrange-loop-analysis]\r\n        for (const auto tx_out : tx->vout){\r\n                        ^\r\nindex/addrindex.cpp:110:14: note: use reference type 'const CTxOut &' to prevent copying\r\n        for (const auto tx_out : tx->vout){\r\n             ^~~~~~~~~~~~~~~~~~~\r\n```",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-06T20:17:28Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763081",
      "id" : 215763081,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2MzA4MQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 110,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 153102721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763081",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same here - see above.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-06T20:17:47Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763177",
      "id" : 215763177,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2MzE3Nw==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 115,
      "original_position" : 115,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 153102835,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763177",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763264"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same here - see above.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-06T20:18:04Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.\n+                    }\n+\n+                    // It's also possible we can't find the tx in txindex because it fell behind in\n+                    // the ValidationInterface queue. In this case we also let it finish before continuing.\n+                    g_txindex->BlockUntilSyncedToCurrentChain();\n+\n+                    // If we still can't find the tx then a re-org may have happened.\n+                    if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) return false;\n+                }\n+\n+                CScript script_pub_key = tx->vout[tx_in.prevout.n].scriptPubKey;\n+                positions.emplace_back(GetAddrID(script_pub_key), pos);\n+            }\n+        }\n+\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+\n+    return m_db->WriteToIndex(positions, block.GetHash());\n+}\n+\n+bool AddrIndex::DB::WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>>& positions, const uint256 block_hash)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& pos : positions) {\n+        // Insert (address, position) pair with a part of the block hash.\n+        // Different transactions for the same address will be differentiated\n+        // in leveldb by their CDiskTxPos suffix.\n+        batch.Write(std::make_pair(std::make_pair(DB_ADDRINDEX, pos.first), pos.second), block_hash.GetUint64(0));\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+void AddrIndex::BlockDisconnected(const std::shared_ptr<const CBlock> &block) {\n+    const uint64_t block_hash_bits = block->GetHash().GetUint64(0);\n+    std::unordered_set<uint64_t> addr_ids_to_remove;\n+\n+    {\n+        LOCK(cs_main);\n+        CCoinsViewCache view(pcoinsTip.get());\n+\n+        // Collect all addr_ids from txs in this block.\n+        for (const auto& tx : block->vtx) {\n+            for (const auto tx_out : tx->vout){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763264",
      "id" : 215763264,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2MzI2NA==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 168,
      "original_position" : 168,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 153102932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763264",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same here - see above.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-06T20:18:20Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.\n+                    }\n+\n+                    // It's also possible we can't find the tx in txindex because it fell behind in\n+                    // the ValidationInterface queue. In this case we also let it finish before continuing.\n+                    g_txindex->BlockUntilSyncedToCurrentChain();\n+\n+                    // If we still can't find the tx then a re-org may have happened.\n+                    if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) return false;\n+                }\n+\n+                CScript script_pub_key = tx->vout[tx_in.prevout.n].scriptPubKey;\n+                positions.emplace_back(GetAddrID(script_pub_key), pos);\n+            }\n+        }\n+\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+\n+    return m_db->WriteToIndex(positions, block.GetHash());\n+}\n+\n+bool AddrIndex::DB::WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>>& positions, const uint256 block_hash)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& pos : positions) {\n+        // Insert (address, position) pair with a part of the block hash.\n+        // Different transactions for the same address will be differentiated\n+        // in leveldb by their CDiskTxPos suffix.\n+        batch.Write(std::make_pair(std::make_pair(DB_ADDRINDEX, pos.first), pos.second), block_hash.GetUint64(0));\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+void AddrIndex::BlockDisconnected(const std::shared_ptr<const CBlock> &block) {\n+    const uint64_t block_hash_bits = block->GetHash().GetUint64(0);\n+    std::unordered_set<uint64_t> addr_ids_to_remove;\n+\n+    {\n+        LOCK(cs_main);\n+        CCoinsViewCache view(pcoinsTip.get());\n+\n+        // Collect all addr_ids from txs in this block.\n+        for (const auto& tx : block->vtx) {\n+            for (const auto tx_out : tx->vout){\n+                addr_ids_to_remove.emplace(GetAddrID(tx_out.scriptPubKey));\n+            }\n+\n+            if (!tx->IsCoinBase()) {\n+                for (const auto tx_in : tx->vin){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763353",
      "id" : 215763353,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2MzM1Mw==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 173,
      "original_position" : 173,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 153103042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763353",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763499"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763499"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\ntest/addrindex_tests.cpp:112:23: warning: unused variable 'block' [-Wunused-variable]\r\n        const CBlock& block = CreateAndProcessBlock(no_txns, coinbase_script_pub_key);\r\n                      ^\r\n```",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-06T20:18:50Z",
      "diff_hunk" : "@@ -0,0 +1,418 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <script/standard.h>\n+#include <test/test_bitcoin.h>\n+#include <util.h>\n+#include <utiltime.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(addrindex_tests)\n+\n+BOOST_FIXTURE_TEST_CASE(addrindex_initial_sync, TestChain100Setup)\n+{\n+    AddrIndex addr_index(1 << 20, true);\n+\n+    CTransactionRef tx_disk;\n+    uint256 block_hash;\n+\n+    // Transactions should not be found in the index before it is started.\n+    for (const auto& txn : m_coinbase_txns) {\n+        for (const auto& out : txn->vout) {\n+            std::vector<std::pair<uint256, CTransactionRef>> txs;\n+            BOOST_CHECK(!addr_index.FindTxsByScript(out.scriptPubKey, txs));\n+        }\n+    }\n+\n+    // BlockUntilSyncedToCurrentChain should return false before addrindex is started.\n+    BOOST_CHECK(!addr_index.BlockUntilSyncedToCurrentChain());\n+    addr_index.Start();\n+\n+    // Allow addrindex to catch up with the block index.\n+    constexpr int64_t timeout_ms = 10 * 1000;\n+    int64_t time_start = GetTimeMillis();\n+    while (!addr_index.BlockUntilSyncedToCurrentChain()) {\n+        BOOST_REQUIRE(time_start + timeout_ms > GetTimeMillis());\n+        MilliSleep(100);\n+    }\n+\n+    // Check that addrindex has all addresses sent to that were in the chain before it started.\n+    for (const auto& txn : m_coinbase_txns) {\n+        uint256 tx_hash = txn->GetHash();\n+        for (const auto& out : txn->vout) {\n+            std::vector<std::pair<uint256, CTransactionRef>> txs;\n+            if (!addr_index.FindTxsByScript(out.scriptPubKey, txs)) {\n+                    BOOST_ERROR(\"FindTxsByScript failed\");\n+            }\n+\n+            // Confirm that the transaction's destination is in the index.\n+            bool found_tx = false;\n+            for (const auto& tuple : txs) {\n+                if (tuple.second->GetHash() == tx_hash) {\n+                    found_tx = true;\n+                    break;\n+                }\n+            }\n+\n+            if (!found_tx) {\n+                BOOST_ERROR(\"Transaction not found by destination\");\n+            }\n+        }\n+    }\n+\n+    // Check that new transactions in new blocks make it into the index.\n+    CScript coinbase_script_pub_key = GetScriptForDestination(coinbaseKey.GetPubKey().GetID());\n+    for (int i = 0; i < 10; i++) {\n+        std::vector<CMutableTransaction> no_txns;\n+        const CBlock& block = CreateAndProcessBlock(no_txns, coinbase_script_pub_key);\n+        const CTransaction& txn = *block.vtx[0];\n+\n+        BOOST_CHECK(addr_index.BlockUntilSyncedToCurrentChain());\n+\n+        uint256 tx_hash = txn.GetHash();\n+        std::vector<std::pair<uint256, CTransactionRef>> txs;\n+        if (!addr_index.FindTxsByScript(coinbase_script_pub_key, txs)) {\n+            BOOST_ERROR(\"FindTransactionsByDestionation failed\");\n+        }\n+\n+        // Every coinbase tx sends to the same address so we should expect the number of txs\n+        // for this address to increase with each tx we add.\n+        BOOST_CHECK_EQUAL(txs.size(), i + 1);\n+\n+        // Confirm that the transaction's destination is in the index.\n+        bool found_tx = false;\n+        for (const auto& tuple : txs) {\n+            if (tuple.second->GetHash() == tx_hash) {\n+                found_tx = true;\n+                break;\n+            }\n+        }\n+\n+        if (!found_tx) {\n+            BOOST_ERROR(\"Transaction not found by destination\");\n+        }\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(addrindex_many_spends, TestChain100Setup)\n+{\n+    AddrIndex addr_index(1 << 20, true);\n+    addr_index.Start();\n+\n+    // Mine blocks for coinbase maturity, so we can spend some coinbase outputs in the test.\n+    CScript coinbase_script_pub_key = CScript() <<  ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG;\n+    for (int i = 0; i < 20; i++) {\n+        std::vector<CMutableTransaction> no_txns;\n+        const CBlock& block = CreateAndProcessBlock(no_txns, coinbase_script_pub_key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r215763499",
      "id" : 215763499,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2MzQ5OQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 33,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/test/addrindex_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 153103233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763499",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r216033759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216033759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Suggest dropping \"to index spends from addresses\"; if someone configures `addrindex=` I assume they know why. Also prevents a long debate :-)",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-07T17:35:14Z",
      "diff_hunk" : "@@ -1611,6 +1625,13 @@ bool AppInitMain()\n         g_txindex->Start();\n     }\n \n+    if (gArgs.GetBoolArg(\"-addrindex\", DEFAULT_ADDRINDEX)) {\n+        if (!g_txindex)\n+            InitWarning(_(\"-txindex must be enabled for -addrindex to index spends from addresses.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r216033759",
      "id" : 216033759,
      "in_reply_to_id" : 214013007,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNjAzMzc1OQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 1630,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 153436851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216033759",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r216034219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216034219"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke why is it again that Travis doesn't fail on warnings?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-07T17:37:02Z",
      "diff_hunk" : "@@ -173,6 +175,76 @@ TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransaction>&\n     return result;\n }\n \n+// Based off of BuildChain in validation_block_tests.cpp\n+\n+// Build a chain of blocks that contains all of the transactions in txns.\n+void TestChain100Setup::BuildChain(const uint256 prev_hash, const uint32_t prev_time, int height, std::vector<CMutableTransaction> &txns, const CScript& scriptPubKey, std::vector<std::shared_ptr<const CBlock>>& blocks) {\n+    if (height <= 0) return;\n+\n+    const CChainParams& chainparams = Params();\n+    std::unique_ptr<CBlockTemplate> pblocktemplate = BlockAssembler(chainparams).CreateNewBlock(scriptPubKey);\n+    CBlock& block = pblocktemplate->block;\n+\n+    // Replace mempool-selected txns with just coinbase plus some of the passed-in txns:\n+    block.vtx.resize(1);\n+\n+    // If this is the last block, add all remaining transactions.\n+    // Otherwise add with some randomness.\n+    for (auto it = txns.begin(); it != txns.end();) {\n+        bool add_tx = (height == 1) || (GetRandInt(height) < txns.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r216034219",
      "id" : 216034219,
      "in_reply_to_id" : 215762841,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNjAzNDIxOQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 194,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/test/test_bitcoin.cpp",
      "position" : null,
      "pull_request_review_id" : 153436851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216034219",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r216037366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216037366"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `Blockchain transactions are still in the process of being indexed` warning should always be shown, because there might be missing transactions while indexing is in progress (`txindex` doesn't have that problem).",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-07T17:47:50Z",
      "diff_hunk" : "@@ -203,6 +204,129 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+            \"searchrawtransactions <address> [verbose=true] [skip=0] [count=100]\\n\"\n+            \"\\nReturns raw transactions that contain the given address and the hash of the block(s) they were found in.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\"\n+            \"1. \\\"address\\\"    (string, required) The address to search for\\n\"\n+            \"2. \\\"verbose\\\"    (bool, optional, default = false) If set to false, only returns data for hex-encoded `txid`s. \\n\"\n+            \"3. \\\"skip\\\"       (numeric, optional, default = 0) If set, the result skips this number of initial values. \\n\"\n+            \"3. \\\"count\\\"      (numeric, optional, default = 100) If set, the result will only contain this amount of values. \\n\"\n+            \"\\nResult:\\n\"\n+            \" [                                    (array of json objects)\\n\"\n+            \"   {\\n\"\n+            \"      \\\"hex\\\" : \\\"data\\\",             (string) The serialized, hex-encoded data for 'txid'\\n\"\n+            \"      \\\"txid\\\" : \\\"id\\\",              (string) The transaction id (same as provided)\\n\"\n+            \"      \\\"hash\\\" : \\\"id\\\",              (string) The transaction hash (differs from txid for witness transactions)\\n\"\n+            \"      \\\"size\\\" : n,                   (numeric) The serialized transaction size\\n\"\n+            \"      \\\"vsize\\\" : n,                  (numeric) The virtual transaction size (differs from size for witness transactions)\\n\"\n+            \"      \\\"weight\\\" : n,                 (numeric) The transaction's weight (between vsize*4-3 and vsize*4)\\n\"\n+            \"      \\\"version\\\" : n,                (numeric) The version\\n\"\n+            \"      \\\"locktime\\\" : ttt,             (numeric) The lock time\\n\"\n+            \"      \\\"vin\\\" : [                     (array of json objects)\\n\"\n+            \"        {\\n\"\n+            \"          \\\"txid\\\": \\\"id\\\",           (string) The transaction id\\n\"\n+            \"          \\\"vout\\\": n,                (numeric) \\n\"\n+            \"          \\\"scriptSig\\\": {            (json object) The script\\n\"\n+            \"            \\\"asm\\\": \\\"asm\\\",         (string) asm\\n\"\n+            \"            \\\"hex\\\": \\\"hex\\\"          (string) hex\\n\"\n+            \"        },\\n\"\n+            \"      \\\"sequence\\\": n                 (numeric) The script sequence number\\n\"\n+            \"      \\\"txinwitness\\\": [\\\"hex\\\", ...] (array of string) hex-encoded witness data (if any)\\n\"\n+            \"    }\\n\"\n+            \"    ,...\\n\"\n+            \"    \\\"vout\\\" : [                       (array of json objects)\\n\"\n+            \"       {\\n\"\n+            \"         \\\"value\\\" : x.xxx,            (numeric) The value in \" + CURRENCY_UNIT + \"\\n\"\n+            \"         \\\"n\\\" : n,                    (numeric) index\\n\"\n+            \"         \\\"scriptPubKey\\\" : {          (json object)\\n\"\n+            \"           \\\"asm\\\" : \\\"asm\\\",          (string) the asm\\n\"\n+            \"           \\\"hex\\\" : \\\"hex\\\",          (string) the hex\\n\"\n+            \"           \\\"reqSigs\\\" : n,            (numeric) The required sigs\\n\"\n+            \"           \\\"type\\\" : \\\"pubkeyhash\\\",  (string) The type, eg 'pubkeyhash'\\n\"\n+            \"           \\\"addresses\\\" : [           (json array of string)\\n\"\n+            \"             \\\"address\\\"               (string) bitcoin address\\n\"\n+            \"             ,...\\n\"\n+            \"           ]\\n\"\n+            \"         }\\n\"\n+            \"       }\\n\"\n+            \"       ,...\\n\"\n+            \"    ],\\n\"\n+            \"    \\\"blockhash\\\" : \\\"hash\\\",         (string) the block hash\\n\"\n+            \"  }\\n\"\n+            \" ]\\n\"\n+            );\n+\n+\n+    CScript scriptPubKey;\n+    const CTxDestination dest = DecodeDestination(request.params[0].get_str());\n+    if(IsValidDestination(dest)) {\n+        scriptPubKey = GetScriptForDestination(dest);\n+    } else if(IsHex(request.params[0].get_str())) {\n+        std::vector<unsigned char> data(ParseHex(request.params[0].get_str()));\n+        scriptPubKey = CScript(data.begin(), data.end());\n+    } else {\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address or script\");\n+    }\n+\n+    // Accept either a bool (true) or a num (>=1) to indicate verbose output.\n+    bool verbose = false;\n+    if (!request.params[1].isNull()) {\n+        verbose = request.params[1].isNum() ? (request.params[1].get_int() != 0) : request.params[1].get_bool();\n+    }\n+\n+    int skip = 0;\n+    int count = 100;\n+    if (request.params.size() > 2) {\n+        if (!request.params[2].isNum()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid parameter, argument 3 must be an integer\");\n+        }\n+        skip = request.params[2].get_int();\n+    }\n+    if (request.params.size() > 3) {\n+        if (!request.params[3].isNum()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid parameter, argument 4 must be an integer\");\n+        }\n+        count = request.params[3].get_int();\n+    }\n+\n+    if (!g_addrindex) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"This RPC requires -addrindex to be enabled.\");\n+    }\n+\n+    bool addrindex_ready = g_addrindex->BlockUntilSyncedToCurrentChain();\n+\n+    UniValue ret(UniValue::VARR);\n+    std::vector<std::pair<uint256, CTransactionRef>> result;\n+    if (!g_addrindex->FindTxsByScript(scriptPubKey, result)) {\n+        if (!addrindex_ready) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY,\"Transactions with given address not found. Blockchain transactions are still in the process of being indexed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r216037366",
      "id" : 216037366,
      "line" : 310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNjAzNzM2Ng==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 310,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 99,
      "pull_request_review_id" : 153436851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216037366",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r219691269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/219691269"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\n2018-09-22 21:20:09 cpplint(pr=14053): src/index/addrindex.cpp:124:  Should have a space between // and comment  [whitespace/comments] [4]\r\n```",
      "commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "created_at" : "2018-09-23T07:59:31Z",
      "diff_hunk" : "@@ -0,0 +1,225 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+constexpr char DB_ADDRINDEX = 'a';\n+std::unique_ptr<AddrIndex> g_addrindex;\n+\n+/**\n+ * Access to the addrindex database (indexes/addrindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the AddrIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Find all entries in the index for addr_id.\n+    // If filter_by_value is true, only returns keys with values equal to value_wanted.\n+    bool ReadAddrIndex(const uint64_t addr_id,\n+                       std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                       const bool filter_by_value = false,\n+                       const uint64_t value_wanted = 0);\n+\n+    bool WriteToIndex(const std::vector<std::pair<uint64_t, CDiskTxPos>> &positions, const uint256 block_hash);\n+\n+    void RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove);\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addrindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+bool AddrIndex::DB::ReadAddrIndex(const uint64_t addr_id,\n+                                  std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_found,\n+                                  const bool filter_by_value,\n+                                  const uint64_t value_wanted){\n+    bool found_tx = false; // return true only if at least one transaction was found\n+    const std::pair<char, uint64_t> key_prefix = std::make_pair(DB_ADDRINDEX, addr_id);\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+\n+    iter->Seek(key_prefix);\n+    while (iter->Valid()) {\n+        std::pair<std::pair<char, uint64_t>, CDiskTxPos> key;\n+        uint64_t value;\n+        if (!iter->GetKey(key) || !iter->GetValue(value) || key.first != key_prefix) break;\n+\n+        if  (!filter_by_value || (filter_by_value && value == value_wanted)) {\n+            found_tx = true;\n+            keys_found.emplace_back(key);\n+        }\n+\n+        iter->Next();\n+    }\n+\n+    return found_tx;\n+}\n+\n+void AddrIndex::DB::RemoveKeys(const std::vector<std::pair<std::pair<char, uint64_t>, CDiskTxPos>> &keys_to_remove) {\n+    CDBBatch batch(*this);\n+    for (const auto& key : keys_to_remove) {\n+        batch.Erase(key);\n+    }\n+    WriteBatch(batch);\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)){}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+uint64_t AddrIndex::GetAddrID(const CScript& script) {\n+    uint256 hashed_script;\n+\n+    CSHA256 hasher;\n+    hasher.Write((unsigned char*)&(*script.begin()), script.end() - script.begin());\n+    hasher.Finalize(hashed_script.begin());\n+\n+    return hashed_script.GetUint64(0);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint64_t, CDiskTxPos>> positions;\n+    positions.reserve(2 * block.vtx.size());  // Most transactions have at least 1 input and 1 output.\n+\n+    // Index addresses of spent outputs if txindex is enabled,\n+    for (const auto& tx : block.vtx) {\n+        for (const auto tx_out : tx->vout){\n+            positions.emplace_back(GetAddrID(tx_out.scriptPubKey), pos);\n+        }\n+\n+        if (g_txindex && !tx->IsCoinBase()) {\n+            for (const auto tx_in : tx->vin) {\n+                CTransactionRef tx;\n+                uint256 block_hash;\n+\n+                if (!g_txindex->FindTx(tx_in.prevout.hash, block_hash, tx)) {\n+                    // Both addrindex and txindex may be syncing in parallel, and addrindex might\n+                    // be ahead of txindex. We let txindex sync first so that addrindex can continue\n+                    // after it.\n+                    while (!g_txindex->IsInSyncWithMainChain()) {\n+                        MilliSleep(1000); //TODO: find a less arbitrary sleep time.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r219691269",
      "id" : 219691269,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxOTY5MTI2OQ==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_position" : 124,
      "path" : "src/index/addrindex.cpp",
      "position" : 124,
      "pull_request_review_id" : 157931834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "updated_at" : "2018-09-23T07:59:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/219691269",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r219691273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/219691273"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\n2018-09-22 21:20:09 cpplint(pr=14053): src/index/addrindex.h:44:  \"virtual\" is redundant since function is already declared as \"override\"  [readability/inheritance] [4]\r\n```",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2018-09-23T07:59:48Z",
      "diff_hunk" : "@@ -0,0 +1,56 @@\n+// Copyright (c) 2017-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_ADDRINDEX_H\n+#define BITCOIN_INDEX_ADDRINDEX_H\n+\n+#include <chain.h>\n+#include <index/base.h>\n+#include <vector>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <script/script.h>\n+\n+/**\n+ * AddrIndex is used to look up transactions included in the blockchain by script.\n+ * The index is written to a LevelDB database and records the filesystem\n+ * location of transactions by script.\n+ */\n+class AddrIndex final : public BaseIndex\n+{\n+protected:\n+    class DB;\n+\n+private:\n+    const std::unique_ptr<DB> m_db;\n+\n+protected:\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex) override;\n+\n+    BaseIndex::DB& GetDB() const override;\n+\n+    void BlockDisconnected(const std::shared_ptr<const CBlock> &block) override;\n+\n+    const char* GetName() const override { return \"addrindex\"; }\n+\n+public:\n+    /// Constructs the index, which becomes available to be queried.\n+    explicit AddrIndex(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    // Destructor is declared because this class contains a unique_ptr to an incomplete type.\n+    virtual ~AddrIndex() override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r219691273",
      "id" : 219691273,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxOTY5MTI3Mw==",
      "original_commit_id" : "4865275573a56abb9e079d8a4ff5957c3694c583",
      "original_line" : 52,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/index/addrindex.h",
      "position" : null,
      "pull_request_review_id" : 157931838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/219691273",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2018-09-24T22:23:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-424145334",
      "id" : 424145334,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNDE0NTMzNA==",
      "updated_at" : "2018-09-24T22:23:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/424145334",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Comments to the concept\r\n\r\nSome time ago I have rebased bitpay's bitcore patches (from their insight block explorer) to bitcoin core here (without much work on my own)\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/10370\r\n\r\nThe consensus back then seemed to be that more indexes in the core is not a good thing, and work should be instead done on external indexes. However I am no sure how this PR differs, I just quickly skimmed it.",
      "created_at" : "2018-10-05T06:40:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-427261876",
      "id" : 427261876,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNzI2MTg3Ng==",
      "updated_at" : "2018-10-05T07:09:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/427261876",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/104945?v=4",
         "events_url" : "https://api.github.com/users/karel-3d/events{/privacy}",
         "followers_url" : "https://api.github.com/users/karel-3d/followers",
         "following_url" : "https://api.github.com/users/karel-3d/following{/other_user}",
         "gists_url" : "https://api.github.com/users/karel-3d/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/karel-3d",
         "id" : 104945,
         "login" : "karel-3d",
         "node_id" : "MDQ6VXNlcjEwNDk0NQ==",
         "organizations_url" : "https://api.github.com/users/karel-3d/orgs",
         "received_events_url" : "https://api.github.com/users/karel-3d/received_events",
         "repos_url" : "https://api.github.com/users/karel-3d/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/karel-3d/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/karel-3d/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/karel-3d"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@karel-3d I think this one is based on  #13033, so at least the performance impact should be less pronounced. Other than that it should be rather similar.",
      "created_at" : "2018-10-05T08:02:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-427280137",
      "id" : 427280137,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNzI4MDEzNw==",
      "updated_at" : "2018-10-05T08:02:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/427280137",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We talked about (address) indexes during the previous [IRC meeting](http://www.erisian.com.au/meetbot/bitcoin-core-dev/2018/bitcoin-core-dev.2018-12-13-19.00.html). ",
      "created_at" : "2018-12-15T10:14:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-447556680",
      "id" : 447556680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0NzU1NjY4MA==",
      "updated_at" : "2018-12-15T10:14:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/447556680",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r250509440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250509440"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`spends` shadows a variable existing in the outer scope.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2019-01-24T08:48:21Z",
      "diff_hunk" : "@@ -0,0 +1,154 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <script/standard.h>\n+#include <test/test_bitcoin.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(addrindex_tests)\n+\n+BOOST_FIXTURE_TEST_CASE(addrindex_initial_sync_and_spends, TestChain100Setup)\n+{\n+    AddrIndex addr_index(1 << 20, true);\n+    CScript coinbase_script_pub_key = CScript() <<  ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG;\n+\n+    // Transactions should not be found in the index before it is started.\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> spends;\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> creations;\n+    BOOST_CHECK(!addr_index.FindTxsByScript(coinbase_script_pub_key, spends, creations));\n+\n+    // BlockUntilSyncedToCurrentChain should return false before addrindex is started.\n+    BOOST_CHECK(!addr_index.BlockUntilSyncedToCurrentChain());\n+    addr_index.Start();\n+\n+    // Mine blocks for coinbase maturity, so we can spend some coinbase outputs in the test.\n+    for (int i = 0; i < 20; i++) {\n+        std::vector<CMutableTransaction> no_txns;\n+        CreateAndProcessBlock(no_txns, coinbase_script_pub_key);\n+    }\n+\n+    // Allow addrindex to catch up with the block index.\n+    constexpr int64_t timeout_ms = 10 * 1000;\n+    int64_t time_start = GetTimeMillis();\n+    while (!addr_index.BlockUntilSyncedToCurrentChain()) {\n+        BOOST_REQUIRE(time_start + timeout_ms > GetTimeMillis());\n+        MilliSleep(100);\n+    }\n+\n+    // Check that addrindex has all coinbase outputs indexed.\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> spends2;\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> creations2;\n+    if (!addr_index.FindTxsByScript(coinbase_script_pub_key, spends2, creations2)) {\n+            BOOST_ERROR(\"FindTxsByScript failed\");\n+    }\n+    // The coinbase transactions have the same scriptPubKey in their output.\n+    BOOST_CHECK_EQUAL(spends2.size(), 0);\n+    BOOST_CHECK_EQUAL(creations2.size(), 120);\n+\n+    // Create several new key pairs to test sending to many different addresses in the same block.\n+    std::vector<CKey> priv_keys(10);\n+    std::vector<CScript> script_pub_keys(10);\n+    for (int i = 0; i < 10; i++) {\n+        priv_keys[i].MakeNewKey(true);\n+        script_pub_keys[i] = CScript() <<  ToByteVector(priv_keys[i].GetPubKey()) << OP_CHECKSIG;\n+    }\n+\n+    // Create a transaction sending to each of the new addresses.\n+    std::vector<CMutableTransaction> spend_txns(10);\n+    CreateSpendingTxs(0, script_pub_keys, spend_txns, coinbase_script_pub_key);\n+\n+    const CBlock& block = CreateAndProcessBlock(spend_txns, coinbase_script_pub_key);\n+    const uint256 block_hash = block.GetHash();\n+    BOOST_CHECK(addr_index.BlockUntilSyncedToCurrentChain()); // Let the address index catch up.\n+    BOOST_CHECK(chainActive.Tip()->GetBlockHash() == block_hash); // Sanity check to make sure this block is actually being used.\n+\n+    // Now check that all the addresses we sent to are present in the index.\n+    for (int i = 0; i < 10; i++) {\n+        std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> spends;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r250509440",
      "id" : 250509440,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1MDUwOTQ0MA==",
      "original_commit_id" : "fc075a0d94bcc5b8453da5da3ac78614c76470df",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/test/addrindex_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 195908542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250509440",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r250509491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250509491"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same here but for `creations`.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2019-01-24T08:48:33Z",
      "diff_hunk" : "@@ -0,0 +1,154 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/addrindex.h>\n+#include <index/txindex.h>\n+#include <script/standard.h>\n+#include <test/test_bitcoin.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(addrindex_tests)\n+\n+BOOST_FIXTURE_TEST_CASE(addrindex_initial_sync_and_spends, TestChain100Setup)\n+{\n+    AddrIndex addr_index(1 << 20, true);\n+    CScript coinbase_script_pub_key = CScript() <<  ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG;\n+\n+    // Transactions should not be found in the index before it is started.\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> spends;\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> creations;\n+    BOOST_CHECK(!addr_index.FindTxsByScript(coinbase_script_pub_key, spends, creations));\n+\n+    // BlockUntilSyncedToCurrentChain should return false before addrindex is started.\n+    BOOST_CHECK(!addr_index.BlockUntilSyncedToCurrentChain());\n+    addr_index.Start();\n+\n+    // Mine blocks for coinbase maturity, so we can spend some coinbase outputs in the test.\n+    for (int i = 0; i < 20; i++) {\n+        std::vector<CMutableTransaction> no_txns;\n+        CreateAndProcessBlock(no_txns, coinbase_script_pub_key);\n+    }\n+\n+    // Allow addrindex to catch up with the block index.\n+    constexpr int64_t timeout_ms = 10 * 1000;\n+    int64_t time_start = GetTimeMillis();\n+    while (!addr_index.BlockUntilSyncedToCurrentChain()) {\n+        BOOST_REQUIRE(time_start + timeout_ms > GetTimeMillis());\n+        MilliSleep(100);\n+    }\n+\n+    // Check that addrindex has all coinbase outputs indexed.\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> spends2;\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> creations2;\n+    if (!addr_index.FindTxsByScript(coinbase_script_pub_key, spends2, creations2)) {\n+            BOOST_ERROR(\"FindTxsByScript failed\");\n+    }\n+    // The coinbase transactions have the same scriptPubKey in their output.\n+    BOOST_CHECK_EQUAL(spends2.size(), 0);\n+    BOOST_CHECK_EQUAL(creations2.size(), 120);\n+\n+    // Create several new key pairs to test sending to many different addresses in the same block.\n+    std::vector<CKey> priv_keys(10);\n+    std::vector<CScript> script_pub_keys(10);\n+    for (int i = 0; i < 10; i++) {\n+        priv_keys[i].MakeNewKey(true);\n+        script_pub_keys[i] = CScript() <<  ToByteVector(priv_keys[i].GetPubKey()) << OP_CHECKSIG;\n+    }\n+\n+    // Create a transaction sending to each of the new addresses.\n+    std::vector<CMutableTransaction> spend_txns(10);\n+    CreateSpendingTxs(0, script_pub_keys, spend_txns, coinbase_script_pub_key);\n+\n+    const CBlock& block = CreateAndProcessBlock(spend_txns, coinbase_script_pub_key);\n+    const uint256 block_hash = block.GetHash();\n+    BOOST_CHECK(addr_index.BlockUntilSyncedToCurrentChain()); // Let the address index catch up.\n+    BOOST_CHECK(chainActive.Tip()->GetBlockHash() == block_hash); // Sanity check to make sure this block is actually being used.\n+\n+    // Now check that all the addresses we sent to are present in the index.\n+    for (int i = 0; i < 10; i++) {\n+        std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> spends;\n+        std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> creations;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r250509491",
      "id" : 250509491,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI1MDUwOTQ5MQ==",
      "original_commit_id" : "fc075a0d94bcc5b8453da5da3ac78614c76470df",
      "original_line" : 74,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/test/addrindex_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 195908614,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/250509491",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@Sjors \r\n> Lightly tested on macOS. It doesn't find the coinbase transaction to `mtnNvZY7iQCfzJCVon13tfJSVYDn9iiUWD` in [block 120](https://testnet.blockchain.info/en/block/0000000058dbb5e3fce9be42ae79beb564be666866c6b85c9791863219ec36db), `mg4bQva8w7Cjs8KaKHeEbyXUaCzoQAcXyH` in [block 10001](https://testnet.blockchain.info/nl/block/0000000000629d100db387f37d0f37c51118f250fb0946310a8c37316cbc4028) and several others.\r\n\r\nI'm confused at what you're referring to by`mtn...` and `mg4...`. The outputs for those two coinbase transactions are P2PK, so the only way to search for them is by scriptPubKey.  I used the hex value of the scriptPubKey from [here](https://blockstream.info/block/00000000000080b66c911bd5ba14a74260057311eaeb1982802f7010f1a9f090) and was able to find it.",
      "created_at" : "2019-01-30T22:19:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-459132969",
      "id" : 459132969,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1OTEzMjk2OQ==",
      "updated_at" : "2019-01-30T22:19:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/459132969",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-03-18T18:09:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-474037115",
      "id" : 474037115,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NDAzNzExNQ==",
      "updated_at" : "2019-03-18T18:09:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/474037115",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-03-20T16:39:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-474920795",
      "id" : 474920795,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NDkyMDc5NQ==",
      "updated_at" : "2019-03-20T16:39:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/474920795",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-03-21T08:26:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-475145006",
      "id" : 475145006,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NTE0NTAwNg==",
      "updated_at" : "2019-03-21T08:26:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/475145006",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe tag this [needing concept ack](https://github.com/bitcoin/bitcoin/labels/Needs%20Conceptual%20Review).\r\n\r\nThis would probably be pretty easy to rebase, and has a previous concept ack from jimpo, but it's not clear if other people want this change or might object to it.",
      "created_at" : "2019-07-17T21:36:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-512578228",
      "id" : 512578228,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMjU3ODIyOA==",
      "updated_at" : "2019-07-17T21:36:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/512578228",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I for one would be very happy to see an optional addr index + api finally available in bitcoin-core, and not as a separate patch or hacky thing.\r\n\r\n@marcinja is there an API in your PR that accepts multiple addresses as input and returns total received/spent for each?  Some block explorers have this functionality and it is great because much more efficient than calling API for each addr individually.  \r\n\r\nAlso I think it should be caller's option (via param) whether to return list of tx or not.  Sometimes only addr summary info is needed eg total received/spent and tx info just adds bloat and slows things down in such cases.",
      "created_at" : "2019-08-07T06:50:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-518964997",
      "id" : 518964997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxODk2NDk5Nw==",
      "updated_at" : "2019-08-07T06:50:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/518964997",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5110592?v=4",
         "events_url" : "https://api.github.com/users/dan-da/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dan-da/followers",
         "following_url" : "https://api.github.com/users/dan-da/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dan-da/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dan-da",
         "id" : 5110592,
         "login" : "dan-da",
         "node_id" : "MDQ6VXNlcjUxMTA1OTI=",
         "organizations_url" : "https://api.github.com/users/dan-da/orgs",
         "received_events_url" : "https://api.github.com/users/dan-da/received_events",
         "repos_url" : "https://api.github.com/users/dan-da/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dan-da/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dan-da/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dan-da"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@marcinja you're so close. Thanks for all your hard work on this! Does anyone know if this is getting merged anytime soon?",
      "created_at" : "2019-10-01T14:33:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-537065474",
      "id" : 537065474,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzNzA2NTQ3NA==",
      "updated_at" : "2019-10-01T14:33:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/537065474",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/93429?v=4",
         "events_url" : "https://api.github.com/users/abunsen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/abunsen/followers",
         "following_url" : "https://api.github.com/users/abunsen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/abunsen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/abunsen",
         "id" : 93429,
         "login" : "abunsen",
         "node_id" : "MDQ6VXNlcjkzNDI5",
         "organizations_url" : "https://api.github.com/users/abunsen/orgs",
         "received_events_url" : "https://api.github.com/users/abunsen/received_events",
         "repos_url" : "https://api.github.com/users/abunsen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/abunsen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/abunsen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/abunsen"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-10-16T22:39:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-542920248",
      "id" : 542920248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MjkyMDI0OA==",
      "updated_at" : "2019-10-16T22:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/542920248",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I haven't looked at how this is implemented, at all-- but the goal is one that is extraordinarily useful and addresses a severe and growing usability probable in the software that has burned me many times. ",
      "created_at" : "2019-11-20T11:12:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-555957701",
      "id" : 555957701,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTk1NzcwMQ==",
      "updated_at" : "2019-11-20T11:12:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555957701",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I haven't looked at how this is implemented, at all-- but the goal is one that is extraordinarily useful and addresses a severe and growing usability probable in the software that has burned me many times.\r\n\r\nSorry for the dumb question, but what's the severe usability problem?",
      "created_at" : "2019-11-21T14:48:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-557117513",
      "id" : 557117513,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzExNzUxMw==",
      "updated_at" : "2019-11-21T14:48:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557117513",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Most recent IRC discussion I could find about address indexes, http://www.erisian.com.au/bitcoin-core-dev/log-2018-12-13.html#l-601 seemed to have conclusion (from @jamesob) with: \r\n\"I'll report on any compelling usecases I find for addr index, but I suspect sipa et al are right that that's usually just the Wrong way\"",
      "created_at" : "2019-11-25T20:38:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558330123",
      "id" : 558330123,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODMzMDEyMw==",
      "updated_at" : "2019-11-25T20:38:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558330123",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> \"usually just the Wrong way\"\r\n\r\nThis sounds like an ivory tower attitude to me.   So tell us wise ones, if an addrindex is the wrong way, then what exactly is the right way?   Because thus far bitcoin-core's answer seems to be:  don't lookup transactions related to an address AT ALL unless they are in your own wallet, which is useless for anyone trying to provide address lookup as a service.  They then must either run a patched bitcoind or turn to btcd or some other 3rd party solution.",
      "created_at" : "2019-11-25T20:52:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558335048",
      "id" : 558335048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODMzNTA0OA==",
      "updated_at" : "2019-11-25T20:52:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558335048",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5110592?v=4",
         "events_url" : "https://api.github.com/users/dan-da/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dan-da/followers",
         "following_url" : "https://api.github.com/users/dan-da/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dan-da/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dan-da",
         "id" : 5110592,
         "login" : "dan-da",
         "node_id" : "MDQ6VXNlcjUxMTA1OTI=",
         "organizations_url" : "https://api.github.com/users/dan-da/orgs",
         "received_events_url" : "https://api.github.com/users/dan-da/received_events",
         "repos_url" : "https://api.github.com/users/dan-da/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dan-da/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dan-da/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dan-da"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> what exactly is the right way?\r\n\r\nThe right way to do what? Can you provide more detail? I think it'd be good to keep the discussion as concrete as possible and discuss specific problems and use cases.",
      "created_at" : "2019-11-25T20:58:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558337160",
      "id" : 558337160,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODMzNzE2MA==",
      "updated_at" : "2019-11-25T20:58:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558337160",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "ok, here are two tools I alone have written that need something like searchrawtransactions().\r\n\r\n[hd-wallet-addrs](https://github.com/dan-da/hd-wallet-addrs#blockchain-api-provider-notes) - a tool for discovering all hd-wallet addresses that have ever been used.  So it derives [receive,change] and checks if each address has ever received funds, up to gap limit.  Presently it must rely on 3rd party block explorers APIs.\r\n\r\n[bitprices](https://github.com/dan-da/bitprices#blockchain-api-provider-notes) A tool for querying all transactions for all used addresses in a wallet (or any group of addresses) and generating reports including historical prices on the date of each transaction.  Useful for audits and finding gain/loss, etc after the fact.  Presently btcd has the best/fastest implementation, but only after I submitted patches for searchrawtransactions.\r\n\r\nHere is a [website frontend](https://mybitprices.info).\r\n\r\nNote that the above tools work with any arbitrary seeds or addresses and are expected to return results quickly, so creating a watch-only wallet for each request is not a good option, and anyway it would then just be discarded immediately, so why bother?\r\n\r\nThe first two links above actually link to discussions of the various API providers and their various strengths/weaknesses for these purposes.\r\n\r\nOthers have their own reasons.  afaict, most block explorers or bitcoin API providers need some sort of address index and are rolling their own somehow.",
      "created_at" : "2019-11-25T21:19:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558344637",
      "id" : 558344637,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODM0NDYzNw==",
      "updated_at" : "2019-11-25T21:20:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558344637",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5110592?v=4",
         "events_url" : "https://api.github.com/users/dan-da/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dan-da/followers",
         "following_url" : "https://api.github.com/users/dan-da/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dan-da/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dan-da",
         "id" : 5110592,
         "login" : "dan-da",
         "node_id" : "MDQ6VXNlcjUxMTA1OTI=",
         "organizations_url" : "https://api.github.com/users/dan-da/orgs",
         "received_events_url" : "https://api.github.com/users/dan-da/received_events",
         "repos_url" : "https://api.github.com/users/dan-da/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dan-da/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dan-da/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dan-da"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks. From what I can gather the tools described in https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558344637 are accounting / auditing tools useful for someone running the bitcoin wallet, and this PR would let people who want to use these tools run them locally instead of relying on centralized third party services.\r\n\r\nIt seems like a good argument in favor of this feature.\r\n\r\nI'm not sure what the better arguments against this feature are, so it would be helpful if someone wanted to articulate them. One argument might be that we don't want people getting used to using tools like these, because eventually in the future historical indexes will be less able to scale, and people who are using these tools in their workflow will be forced to turn to centralized third party services.",
      "created_at" : "2019-11-25T21:37:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558351495",
      "id" : 558351495,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODM1MTQ5NQ==",
      "updated_at" : "2019-11-25T21:37:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558351495",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. The main argument against adding an address index to Bitcoin Core is that people/services will come to rely on them, and they're not scalable long term. My response to that is that people are already using address indexes and block explorers. Providing/not providing that functionality in Bitcoin Core isn't going to change that.\r\n\r\nThe new indexing infrastructure means that this can be done in a very unobtrusive way. The index has no direct interaction at all with validation or networking. Instead it hooks into the validation interface and runs in a background thread, and so should have no performance impact when the node is sync'ed (I expect this might slow down IBD as `ActivateBestChain()` gets blocked on `LimitValidationInterfaceQueue()`, but presumably users who are indexing the entire transaction history are prepared to wait a bit longer).",
      "created_at" : "2019-11-25T22:07:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558361845",
      "id" : 558361845,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODM2MTg0NQ==",
      "updated_at" : "2019-11-25T22:07:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558361845",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "addr-index is the most frequently patched-in change to Core, across the years, IME.",
      "created_at" : "2019-11-25T22:08:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558362070",
      "id" : 558362070,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODM2MjA3MA==",
      "updated_at" : "2019-11-25T22:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558362070",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/494411?v=4",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "node_id" : "MDQ6VXNlcjQ5NDQxMQ==",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "querying a 3rd party entails a loss of privacy and requires trusting the 3rd party to return truthful data.  ",
      "created_at" : "2019-11-25T22:21:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558366875",
      "id" : 558366875,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODM2Njg3NQ==",
      "updated_at" : "2019-11-25T22:21:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558366875",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5110592?v=4",
         "events_url" : "https://api.github.com/users/dan-da/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dan-da/followers",
         "following_url" : "https://api.github.com/users/dan-da/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dan-da/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dan-da",
         "id" : 5110592,
         "login" : "dan-da",
         "node_id" : "MDQ6VXNlcjUxMTA1OTI=",
         "organizations_url" : "https://api.github.com/users/dan-da/orgs",
         "received_events_url" : "https://api.github.com/users/dan-da/received_events",
         "repos_url" : "https://api.github.com/users/dan-da/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dan-da/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dan-da/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dan-da"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nI know I've flip-flopped on this feature historically, but I agree very much with the points that @jnewbery makes. Trading the maintenance burden of ~800 lines of relatively non-consensus-risky indexing code for some very practical gains in user privacy is compelling to me. Even with the caveat that we don't think some of these uses are architecturally sound for years and years.\r\n\r\nOne might make the argument that there's a slippery slope here - if we consent to this index now, would demand for yet another index come along, and the next and so on? I don't think so. In the few years I've followed this, there has been reliable demand for an address index (and numerous community implementations of varying repute) and nothing else - aside of course from the compact block index - so I don't think a slippery-slope argument holds.\r\n\r\n@marcinja do you have time to rebase this PR?",
      "created_at" : "2019-11-26T16:45:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558717488",
      "id" : 558717488,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODcxNzQ4OA==",
      "updated_at" : "2019-11-26T16:45:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558717488",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Yes, I will rebase this and clean it up a bit. Thanks for the conceptual review.  ",
      "created_at" : "2019-11-26T23:18:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-558858883",
      "id" : 558858883,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODg1ODg4Mw==",
      "updated_at" : "2019-11-26T23:18:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558858883",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe we should log a warning when the address index is enabled, like:\r\n\r\n<dl><dd>Warning: built-in address index is enabled! Address indexing is going to become less scalable as transaction history increases, and will eventually need to be removed from [PACKAGE_NAME] and replaced by a dedicated external index. Users relying on the address index for accounting purposes are advised to track metadata in real time so relying on a historical index is not necessary.</dd></dl>\r\n\r\nCould also add a coda if the built in wallet is enabled:\r\n\r\n<dl><dd>If using the address index to work around lack of tagging or notifications from the built-in [PACKAGE_NAME] wallet, please file wallet feature requests: [PACKAGE_BUGREPORT]</dd></dl>\r\n\r\nThe idea would be to give end users relying on third party accounting tools a way of knowing about the limitations of those tools, and encouraging authors to implement more scalable approaches.",
      "created_at" : "2019-11-27T14:18:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-559105948",
      "id" : 559105948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1OTEwNTk0OA==",
      "updated_at" : "2019-11-27T14:18:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/559105948",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2019-12-01T23:51:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-560176208",
      "id" : 560176208,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MDE3NjIwOA==",
      "updated_at" : "2019-12-01T23:51:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/560176208",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Nice set of notes on this PR at https://bitcoincore.reviews/14053.html",
      "created_at" : "2020-01-06T16:31:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-571208221",
      "id" : 571208221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTIwODIyMQ==",
      "updated_at" : "2020-01-06T16:31:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571208221",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363953762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363953762"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: this is added in the wrong commit (should be in _Move only: Move CDiskTxPos to own file_, not _Add address index_)",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-07T21:14:19Z",
      "diff_hunk" : "@@ -135,6 +135,8 @@ BITCOIN_CORE_H = \\\n   httpserver.h \\\n   index/base.h \\\n   index/blockfilterindex.h \\\n+  index/addrindex.h \\\n+  index/disktxpos.h \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363953762",
      "id" : 363953762,
      "line" : 144,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk1Mzc2Mg==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 144,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/Makefile.am",
      "position" : 7,
      "pull_request_review_id" : 339511029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363953762",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363956015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363956015"
         }
      },
      "author_association" : "MEMBER",
      "body" : "spelling: there",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-07T21:19:58Z",
      "diff_hunk" : "@@ -0,0 +1,62 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_ADDRINDEX_H\n+#define BITCOIN_INDEX_ADDRINDEX_H\n+\n+#include <chain.h>\n+#include <index/base.h>\n+#include <vector>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <primitives/transaction.h>\n+#include <script/standard.h>\n+#include <script/script.h>\n+#include <undo.h>\n+\n+/**\n+ * AddrIndex is used to look up transactions included in the blockchain by script.\n+ * The index is written to a LevelDB database and records the filesystem\n+ * location of transactions by script.\n+ */\n+class AddrIndex final : public BaseIndex\n+{\n+protected:\n+    class DB;\n+\n+private:\n+    const std::unique_ptr<DB> m_db;\n+\n+    // m_hash_seed is used by GetAddrID in its calls to MurmurHash3.\n+    // It is stored in the index, and restored from their on construction",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363956015",
      "id" : 363956015,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk1NjAxNQ==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 32,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/index/addrindex.h",
      "position" : null,
      "pull_request_review_id" : 339511029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363956015",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363963378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363963378"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure if this is actually needed. The other indexes have different prefixes for the different object types that they store, but all objects in this index are given the same prefix, so is it necessary?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-07T21:38:17Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363963378",
      "id" : 363963378,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk2MzM3OA==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 23,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 339511029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363963378",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363965804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363965804"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Does this branch need to advance the iterator? If not, I think `value` will be the same the next time round and we'll never break out of this loop.\r\n\r\nI think the following is what we want:\r\n\r\n```\r\n    ...\r\n    if (value.second == script) {\r\n        result.emplace_back(std::make_pair(key, value));\r\n    }\r\n\r\n    iter->Next();\r\n}\r\n```",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-07T21:44:27Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';\n+\n+// DBKeyType is used by the address index to distinguish between the\n+// different kinds of values stored.\n+enum class DBKeyType : uint8_t {\n+    SEED,    // Seed used for MurmurHash3 inside GetAddrId\n+    SPENT,   // Used for values in the index indicating a spend\n+    CREATED, // Used for values in the index indicating the creation of an input\n+};\n+\n+// AddrId is used to identify each script.\n+using AddrId = unsigned int;\n+\n+namespace {\n+\n+struct DBKeyPrefix {\n+  AddrId m_addr_id;\n+\n+  DBKeyPrefix() {}\n+  explicit DBKeyPrefix(AddrId addr_id) :  m_addr_id(addr_id) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    char prefix = DB_ADDR_INDEX;\n+    READWRITE(prefix);\n+    if (prefix != DB_ADDR_INDEX) {\n+      throw std::ios_base::failure(\"Invalid format for address index DB key\");\n+    }\n+\n+    READWRITE(m_addr_id);\n+  }\n+};\n+\n+struct DBKey : DBKeyPrefix {\n+  DBKeyType m_key_type;\n+  COutPoint m_outpoint;\n+\n+  DBKey() {}\n+  explicit DBKey(DBKeyType key_type, AddrId addr_id, COutPoint outpoint) : DBKeyPrefix(addr_id), m_key_type(key_type), m_outpoint(outpoint) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    READWRITEAS(DBKeyPrefix, *this);\n+\n+    uint8_t key_type = static_cast<uint8_t>(m_key_type);\n+    READWRITE(key_type);\n+    m_key_type = static_cast<DBKeyType>(key_type);\n+\n+    // Check if the key type is a valid key. SEED keys are excluded because they\n+    // are never created with this type.\n+    if ((m_key_type != DBKeyType::SPENT) && (m_key_type != DBKeyType::CREATED)) {\n+      throw std::ios_base::failure(\"Invalid key type for address index DB key\");\n+    }\n+\n+    READWRITE(m_outpoint);\n+  }\n+};\n+\n+}; // namespace\n+\n+// The address index stores information needed to get relevant transactions,\n+// and a copy of the CScript to double check against in case of hash collisions.\n+using DBValue = std::pair<CDiskTxPos, CScript>;\n+\n+/** Access to the addr_index database (indexes/addr_index/)*/\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /** ReadAddrIndex returns the set of entries stored in the index for this addr_id. */\n+    std::vector<std::pair<DBKey, DBValue>> ReadAddrIndex(const unsigned int addr_id, const CScript& script);\n+\n+    /** WriteToIndex writes the input vector of database entries into the index.  */\n+    bool WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries);\n+\n+    /** SetupHashSeed is used to create/backup/restore the seed used by the index for hashing. */\n+    unsigned int SetupHashSeed();\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addr_index\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+std::vector<std::pair<DBKey, DBValue>> AddrIndex::DB::ReadAddrIndex(const unsigned int addr_id, const CScript& script)\n+{\n+    std::vector<std::pair<DBKey, DBValue>> result;\n+    DBKeyPrefix search_key(addr_id);\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    iter->Seek(search_key);\n+    while (iter->Valid()) {\n+        DBKey key;\n+        DBValue value;\n+        if (!iter->GetKey(key) || key.m_addr_id != addr_id || !iter->GetValue(value) ) break;\n+\n+        // Check that the stored script matches the one we're searching for, in case of hash collisions.\n+        if (value.second != script) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363965804",
      "id" : 363965804,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk2NTgwNA==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 126,
      "original_position" : 126,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 339511029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363965804",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363967426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363967426"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit: having a variable defined as `not_thing` seems unintuitive to me. I think it'd be better to define `genesis` and then test on `!genesis`.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-07T21:48:29Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';\n+\n+// DBKeyType is used by the address index to distinguish between the\n+// different kinds of values stored.\n+enum class DBKeyType : uint8_t {\n+    SEED,    // Seed used for MurmurHash3 inside GetAddrId\n+    SPENT,   // Used for values in the index indicating a spend\n+    CREATED, // Used for values in the index indicating the creation of an input\n+};\n+\n+// AddrId is used to identify each script.\n+using AddrId = unsigned int;\n+\n+namespace {\n+\n+struct DBKeyPrefix {\n+  AddrId m_addr_id;\n+\n+  DBKeyPrefix() {}\n+  explicit DBKeyPrefix(AddrId addr_id) :  m_addr_id(addr_id) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    char prefix = DB_ADDR_INDEX;\n+    READWRITE(prefix);\n+    if (prefix != DB_ADDR_INDEX) {\n+      throw std::ios_base::failure(\"Invalid format for address index DB key\");\n+    }\n+\n+    READWRITE(m_addr_id);\n+  }\n+};\n+\n+struct DBKey : DBKeyPrefix {\n+  DBKeyType m_key_type;\n+  COutPoint m_outpoint;\n+\n+  DBKey() {}\n+  explicit DBKey(DBKeyType key_type, AddrId addr_id, COutPoint outpoint) : DBKeyPrefix(addr_id), m_key_type(key_type), m_outpoint(outpoint) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    READWRITEAS(DBKeyPrefix, *this);\n+\n+    uint8_t key_type = static_cast<uint8_t>(m_key_type);\n+    READWRITE(key_type);\n+    m_key_type = static_cast<DBKeyType>(key_type);\n+\n+    // Check if the key type is a valid key. SEED keys are excluded because they\n+    // are never created with this type.\n+    if ((m_key_type != DBKeyType::SPENT) && (m_key_type != DBKeyType::CREATED)) {\n+      throw std::ios_base::failure(\"Invalid key type for address index DB key\");\n+    }\n+\n+    READWRITE(m_outpoint);\n+  }\n+};\n+\n+}; // namespace\n+\n+// The address index stores information needed to get relevant transactions,\n+// and a copy of the CScript to double check against in case of hash collisions.\n+using DBValue = std::pair<CDiskTxPos, CScript>;\n+\n+/** Access to the addr_index database (indexes/addr_index/)*/\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /** ReadAddrIndex returns the set of entries stored in the index for this addr_id. */\n+    std::vector<std::pair<DBKey, DBValue>> ReadAddrIndex(const unsigned int addr_id, const CScript& script);\n+\n+    /** WriteToIndex writes the input vector of database entries into the index.  */\n+    bool WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries);\n+\n+    /** SetupHashSeed is used to create/backup/restore the seed used by the index for hashing. */\n+    unsigned int SetupHashSeed();\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addr_index\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+std::vector<std::pair<DBKey, DBValue>> AddrIndex::DB::ReadAddrIndex(const unsigned int addr_id, const CScript& script)\n+{\n+    std::vector<std::pair<DBKey, DBValue>> result;\n+    DBKeyPrefix search_key(addr_id);\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    iter->Seek(search_key);\n+    while (iter->Valid()) {\n+        DBKey key;\n+        DBValue value;\n+        if (!iter->GetKey(key) || key.m_addr_id != addr_id || !iter->GetValue(value) ) break;\n+\n+        // Check that the stored script matches the one we're searching for, in case of hash collisions.\n+        if (value.second != script) continue;\n+\n+        result.emplace_back(std::make_pair(key, value));\n+        iter->Next();\n+    }\n+\n+    return result;\n+}\n+\n+bool AddrIndex::Init() {\n+        m_hash_seed = m_db->SetupHashSeed();\n+        return BaseIndex::Init();\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)) {}\n+\n+unsigned int AddrIndex::DB::SetupHashSeed() {\n+    static const auto seed_key = std::make_pair(DB_ADDR_INDEX, static_cast<uint8_t>(DBKeyType::SEED));\n+    unsigned int seed;\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    std::pair<char, uint8_t> key;\n+\n+    // If key is in the index already, read it and return.\n+    iter->Seek(seed_key);\n+    if (iter->Valid() && iter->GetKey(key) && key == seed_key && iter->GetValue(seed)) {\n+        return seed;\n+    }\n+\n+    // Generate a random key and write it to the index.\n+    seed = GetRandInt(std::numeric_limits<int>::max());\n+    Write(seed_key, seed);\n+    return seed;\n+}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+unsigned int AddrIndex::GetAddrId(const CScript& script) {\n+    std::vector<unsigned char> script_data;\n+    for (auto it = script.begin(); it != script.end(); ++it) {\n+        script_data.push_back(*it);\n+    }\n+    return MurmurHash3(m_hash_seed, script_data);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<DBKey, DBValue>> entries;\n+\n+    const bool not_genesis_block = (pindex->nHeight > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363967426",
      "id" : 363967426,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk2NzQyNg==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 178,
      "original_position" : 178,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 339511029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363967426",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363971325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363971325"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this isn't the information that we want to save in the address index. For a given scriptPubKey, a user wants to know:\r\n\r\n- which txouts (txid, output index) spent to that scriptPubKey (the CREATED DBKeyType above)\r\n- which txins (txid, input index) consume UTXOs for that scriptPubKey (the SPENT DBKeyType here)\r\n\r\nSo here, I think you want to save the txid and input index spending the coin. You're actually saving the txid and output index that creates the coin, because you're using the prevout.\r\n\r\n(I'm not entirely sure about this. Perhaps you are trying to return the outpoint that created the coin in the spent outputs array, but that's not clear to me from the RPC documentation).",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-07T21:57:55Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';\n+\n+// DBKeyType is used by the address index to distinguish between the\n+// different kinds of values stored.\n+enum class DBKeyType : uint8_t {\n+    SEED,    // Seed used for MurmurHash3 inside GetAddrId\n+    SPENT,   // Used for values in the index indicating a spend\n+    CREATED, // Used for values in the index indicating the creation of an input\n+};\n+\n+// AddrId is used to identify each script.\n+using AddrId = unsigned int;\n+\n+namespace {\n+\n+struct DBKeyPrefix {\n+  AddrId m_addr_id;\n+\n+  DBKeyPrefix() {}\n+  explicit DBKeyPrefix(AddrId addr_id) :  m_addr_id(addr_id) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    char prefix = DB_ADDR_INDEX;\n+    READWRITE(prefix);\n+    if (prefix != DB_ADDR_INDEX) {\n+      throw std::ios_base::failure(\"Invalid format for address index DB key\");\n+    }\n+\n+    READWRITE(m_addr_id);\n+  }\n+};\n+\n+struct DBKey : DBKeyPrefix {\n+  DBKeyType m_key_type;\n+  COutPoint m_outpoint;\n+\n+  DBKey() {}\n+  explicit DBKey(DBKeyType key_type, AddrId addr_id, COutPoint outpoint) : DBKeyPrefix(addr_id), m_key_type(key_type), m_outpoint(outpoint) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    READWRITEAS(DBKeyPrefix, *this);\n+\n+    uint8_t key_type = static_cast<uint8_t>(m_key_type);\n+    READWRITE(key_type);\n+    m_key_type = static_cast<DBKeyType>(key_type);\n+\n+    // Check if the key type is a valid key. SEED keys are excluded because they\n+    // are never created with this type.\n+    if ((m_key_type != DBKeyType::SPENT) && (m_key_type != DBKeyType::CREATED)) {\n+      throw std::ios_base::failure(\"Invalid key type for address index DB key\");\n+    }\n+\n+    READWRITE(m_outpoint);\n+  }\n+};\n+\n+}; // namespace\n+\n+// The address index stores information needed to get relevant transactions,\n+// and a copy of the CScript to double check against in case of hash collisions.\n+using DBValue = std::pair<CDiskTxPos, CScript>;\n+\n+/** Access to the addr_index database (indexes/addr_index/)*/\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /** ReadAddrIndex returns the set of entries stored in the index for this addr_id. */\n+    std::vector<std::pair<DBKey, DBValue>> ReadAddrIndex(const unsigned int addr_id, const CScript& script);\n+\n+    /** WriteToIndex writes the input vector of database entries into the index.  */\n+    bool WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries);\n+\n+    /** SetupHashSeed is used to create/backup/restore the seed used by the index for hashing. */\n+    unsigned int SetupHashSeed();\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addr_index\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+std::vector<std::pair<DBKey, DBValue>> AddrIndex::DB::ReadAddrIndex(const unsigned int addr_id, const CScript& script)\n+{\n+    std::vector<std::pair<DBKey, DBValue>> result;\n+    DBKeyPrefix search_key(addr_id);\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    iter->Seek(search_key);\n+    while (iter->Valid()) {\n+        DBKey key;\n+        DBValue value;\n+        if (!iter->GetKey(key) || key.m_addr_id != addr_id || !iter->GetValue(value) ) break;\n+\n+        // Check that the stored script matches the one we're searching for, in case of hash collisions.\n+        if (value.second != script) continue;\n+\n+        result.emplace_back(std::make_pair(key, value));\n+        iter->Next();\n+    }\n+\n+    return result;\n+}\n+\n+bool AddrIndex::Init() {\n+        m_hash_seed = m_db->SetupHashSeed();\n+        return BaseIndex::Init();\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)) {}\n+\n+unsigned int AddrIndex::DB::SetupHashSeed() {\n+    static const auto seed_key = std::make_pair(DB_ADDR_INDEX, static_cast<uint8_t>(DBKeyType::SEED));\n+    unsigned int seed;\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    std::pair<char, uint8_t> key;\n+\n+    // If key is in the index already, read it and return.\n+    iter->Seek(seed_key);\n+    if (iter->Valid() && iter->GetKey(key) && key == seed_key && iter->GetValue(seed)) {\n+        return seed;\n+    }\n+\n+    // Generate a random key and write it to the index.\n+    seed = GetRandInt(std::numeric_limits<int>::max());\n+    Write(seed_key, seed);\n+    return seed;\n+}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+unsigned int AddrIndex::GetAddrId(const CScript& script) {\n+    std::vector<unsigned char> script_data;\n+    for (auto it = script.begin(); it != script.end(); ++it) {\n+        script_data.push_back(*it);\n+    }\n+    return MurmurHash3(m_hash_seed, script_data);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<DBKey, DBValue>> entries;\n+\n+    const bool not_genesis_block = (pindex->nHeight > 0);\n+    if (not_genesis_block && !UndoReadFromDisk(block_undo, pindex)) {\n+      return false;\n+    }\n+\n+    for (size_t i = 0; i < block.vtx.size(); ++i) {\n+        const CTransaction& tx = *(block.vtx[i]);\n+        const uint256 tx_hash = tx.GetHash();\n+        for (size_t j = 0; j < tx.vout.size(); ++j) {\n+            CScript script_pub_key = tx.vout[j].scriptPubKey;\n+            DBKey key(DBKeyType::CREATED, GetAddrId(script_pub_key), COutPoint(tx_hash, j));\n+            entries.emplace_back(key, std::make_pair(pos, script_pub_key));\n+        }\n+\n+        // Skip coinbase inputs.\n+        if (not_genesis_block && i > 0) {\n+            const CTxUndo& tx_undo = block_undo.vtxundo[i-1];\n+            for (size_t k = 0; k < tx.vin.size(); ++k) {\n+                CScript spent_outputs_scriptpubkey = tx_undo.vprevout[k].out.scriptPubKey;\n+                DBKey key(DBKeyType::SPENT, GetAddrId(spent_outputs_scriptpubkey), tx.vin[k].prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363971325",
      "id" : 363971325,
      "line" : 209,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk3MTMyNQ==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 209,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : 209,
      "pull_request_review_id" : 339511029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363971325",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363973201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363973201"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"The block in which to look for the transaction\" is wrong",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-07T22:02:33Z",
      "diff_hunk" : "@@ -213,6 +214,142 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+             RPCHelpMan{ \"searchrawtransactions\\n\",\n+            \"\\nReturns raw transactions that contain outputs with the given script/address, and outpoint information for those outputs.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\",\n+                {\n+                    {\"address\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, /* default_val */ \"\", \"address or scriptPubKey\"},\n+                    {\"verbose\", RPCArg::Type::BOOL, RPCArg::Optional::OMITTED, /* default_val */ \"false\", \"If false, return hex-encoded tx, otherwise return a json object\"},\n+                    {\"count\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, /* default_val */ \"\", \"The block in which to look for the transaction\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363973201",
      "id" : 363973201,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk3MzIwMQ==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 227,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 339511029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363973201",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363976031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363976031"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggest you make this an object with two keys: `creates` and `spends`",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-07T22:10:07Z",
      "diff_hunk" : "@@ -213,6 +214,142 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+             RPCHelpMan{ \"searchrawtransactions\\n\",\n+            \"\\nReturns raw transactions that contain outputs with the given script/address, and outpoint information for those outputs.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\",\n+                {\n+                    {\"address\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, /* default_val */ \"\", \"address or scriptPubKey\"},\n+                    {\"verbose\", RPCArg::Type::BOOL, RPCArg::Optional::OMITTED, /* default_val */ \"false\", \"If false, return hex-encoded tx, otherwise return a json object\"},\n+                    {\"count\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, /* default_val */ \"\", \"The block in which to look for the transaction\"},\n+                },\n+                {\n+                    RPCResult{\"if verbose is not set or set to false\",\n+            \"\\nResult:\\n\"\n+            \" [                                    (array of json objects)\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r363976031",
      "id" : 363976031,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk3NjAzMQ==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 232,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 339511029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/363976031",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364043704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364043704"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    if (request.fHelp || request.params.size() < 1 || request.params.size() > 3)\r\n```",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T02:45:03Z",
      "diff_hunk" : "@@ -213,6 +214,142 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364043704",
      "id" : 364043704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA0MzcwNA==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 218,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 339621545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364043704",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364044637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364044637"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The default value is implicitly 100. It should be explicitly defined here.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T02:50:16Z",
      "diff_hunk" : "@@ -213,6 +214,142 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+             RPCHelpMan{ \"searchrawtransactions\\n\",\n+            \"\\nReturns raw transactions that contain outputs with the given script/address, and outpoint information for those outputs.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\",\n+                {\n+                    {\"address\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, /* default_val */ \"\", \"address or scriptPubKey\"},\n+                    {\"verbose\", RPCArg::Type::BOOL, RPCArg::Optional::OMITTED, /* default_val */ \"false\", \"If false, return hex-encoded tx, otherwise return a json object\"},\n+                    {\"count\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, /* default_val */ \"\", \"The block in which to look for the transaction\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364044637",
      "id" : 364044637,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA0NDYzNw==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 227,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 339622658,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364044637",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364047738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364047738"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Shouldn't this method take the count as a parameter and return early when enough entries are found?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T03:09:17Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';\n+\n+// DBKeyType is used by the address index to distinguish between the\n+// different kinds of values stored.\n+enum class DBKeyType : uint8_t {\n+    SEED,    // Seed used for MurmurHash3 inside GetAddrId\n+    SPENT,   // Used for values in the index indicating a spend\n+    CREATED, // Used for values in the index indicating the creation of an input\n+};\n+\n+// AddrId is used to identify each script.\n+using AddrId = unsigned int;\n+\n+namespace {\n+\n+struct DBKeyPrefix {\n+  AddrId m_addr_id;\n+\n+  DBKeyPrefix() {}\n+  explicit DBKeyPrefix(AddrId addr_id) :  m_addr_id(addr_id) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    char prefix = DB_ADDR_INDEX;\n+    READWRITE(prefix);\n+    if (prefix != DB_ADDR_INDEX) {\n+      throw std::ios_base::failure(\"Invalid format for address index DB key\");\n+    }\n+\n+    READWRITE(m_addr_id);\n+  }\n+};\n+\n+struct DBKey : DBKeyPrefix {\n+  DBKeyType m_key_type;\n+  COutPoint m_outpoint;\n+\n+  DBKey() {}\n+  explicit DBKey(DBKeyType key_type, AddrId addr_id, COutPoint outpoint) : DBKeyPrefix(addr_id), m_key_type(key_type), m_outpoint(outpoint) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    READWRITEAS(DBKeyPrefix, *this);\n+\n+    uint8_t key_type = static_cast<uint8_t>(m_key_type);\n+    READWRITE(key_type);\n+    m_key_type = static_cast<DBKeyType>(key_type);\n+\n+    // Check if the key type is a valid key. SEED keys are excluded because they\n+    // are never created with this type.\n+    if ((m_key_type != DBKeyType::SPENT) && (m_key_type != DBKeyType::CREATED)) {\n+      throw std::ios_base::failure(\"Invalid key type for address index DB key\");\n+    }\n+\n+    READWRITE(m_outpoint);\n+  }\n+};\n+\n+}; // namespace\n+\n+// The address index stores information needed to get relevant transactions,\n+// and a copy of the CScript to double check against in case of hash collisions.\n+using DBValue = std::pair<CDiskTxPos, CScript>;\n+\n+/** Access to the addr_index database (indexes/addr_index/)*/\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /** ReadAddrIndex returns the set of entries stored in the index for this addr_id. */\n+    std::vector<std::pair<DBKey, DBValue>> ReadAddrIndex(const unsigned int addr_id, const CScript& script);\n+\n+    /** WriteToIndex writes the input vector of database entries into the index.  */\n+    bool WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries);\n+\n+    /** SetupHashSeed is used to create/backup/restore the seed used by the index for hashing. */\n+    unsigned int SetupHashSeed();\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addr_index\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+std::vector<std::pair<DBKey, DBValue>> AddrIndex::DB::ReadAddrIndex(const unsigned int addr_id, const CScript& script)\n+{\n+    std::vector<std::pair<DBKey, DBValue>> result;\n+    DBKeyPrefix search_key(addr_id);\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    iter->Seek(search_key);\n+    while (iter->Valid()) {\n+        DBKey key;\n+        DBValue value;\n+        if (!iter->GetKey(key) || key.m_addr_id != addr_id || !iter->GetValue(value) ) break;\n+\n+        // Check that the stored script matches the one we're searching for, in case of hash collisions.\n+        if (value.second != script) continue;\n+\n+        result.emplace_back(std::make_pair(key, value));\n+        iter->Next();\n+    }\n+\n+    return result;\n+}\n+\n+bool AddrIndex::Init() {\n+        m_hash_seed = m_db->SetupHashSeed();\n+        return BaseIndex::Init();\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)) {}\n+\n+unsigned int AddrIndex::DB::SetupHashSeed() {\n+    static const auto seed_key = std::make_pair(DB_ADDR_INDEX, static_cast<uint8_t>(DBKeyType::SEED));\n+    unsigned int seed;\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    std::pair<char, uint8_t> key;\n+\n+    // If key is in the index already, read it and return.\n+    iter->Seek(seed_key);\n+    if (iter->Valid() && iter->GetKey(key) && key == seed_key && iter->GetValue(seed)) {\n+        return seed;\n+    }\n+\n+    // Generate a random key and write it to the index.\n+    seed = GetRandInt(std::numeric_limits<int>::max());\n+    Write(seed_key, seed);\n+    return seed;\n+}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+unsigned int AddrIndex::GetAddrId(const CScript& script) {\n+    std::vector<unsigned char> script_data;\n+    for (auto it = script.begin(); it != script.end(); ++it) {\n+        script_data.push_back(*it);\n+    }\n+    return MurmurHash3(m_hash_seed, script_data);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<DBKey, DBValue>> entries;\n+\n+    const bool not_genesis_block = (pindex->nHeight > 0);\n+    if (not_genesis_block && !UndoReadFromDisk(block_undo, pindex)) {\n+      return false;\n+    }\n+\n+    for (size_t i = 0; i < block.vtx.size(); ++i) {\n+        const CTransaction& tx = *(block.vtx[i]);\n+        const uint256 tx_hash = tx.GetHash();\n+        for (size_t j = 0; j < tx.vout.size(); ++j) {\n+            CScript script_pub_key = tx.vout[j].scriptPubKey;\n+            DBKey key(DBKeyType::CREATED, GetAddrId(script_pub_key), COutPoint(tx_hash, j));\n+            entries.emplace_back(key, std::make_pair(pos, script_pub_key));\n+        }\n+\n+        // Skip coinbase inputs.\n+        if (not_genesis_block && i > 0) {\n+            const CTxUndo& tx_undo = block_undo.vtxundo[i-1];\n+            for (size_t k = 0; k < tx.vin.size(); ++k) {\n+                CScript spent_outputs_scriptpubkey = tx_undo.vprevout[k].out.scriptPubKey;\n+                DBKey key(DBKeyType::SPENT, GetAddrId(spent_outputs_scriptpubkey), tx.vin[k].prevout);\n+                entries.emplace_back(key, std::make_pair(pos, spent_outputs_scriptpubkey));\n+            }\n+        }\n+        pos.nTxOffset += ::GetSerializeSize(tx, CLIENT_VERSION);\n+    }\n+\n+    return m_db->WriteToIndex(entries);\n+}\n+\n+bool AddrIndex::DB::WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& entry : entries) {\n+        batch.Write(entry.first, entry.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+// FindTxsByScript fills the spends_result vector with outpoints corresponding\n+// to the output spent with the given script, and the transaction it was spent\n+// in. creations_result is filled with outpoints for outputs created with this\n+// script as their script pubkey, and the transactions they were created in.\n+bool AddrIndex::FindTxsByScript(const CScript& script,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364047738",
      "id" : 364047738,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA0NzczOA==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 220,
      "original_position" : 220,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 339626587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364047738",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364048337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364048337"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If there are more spends than `count` then no creates will be returned. Ideally the spends and creates will be returned in order, rather than all spends first.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T03:13:01Z",
      "diff_hunk" : "@@ -213,6 +214,142 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+             RPCHelpMan{ \"searchrawtransactions\\n\",\n+            \"\\nReturns raw transactions that contain outputs with the given script/address, and outpoint information for those outputs.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\",\n+                {\n+                    {\"address\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, /* default_val */ \"\", \"address or scriptPubKey\"},\n+                    {\"verbose\", RPCArg::Type::BOOL, RPCArg::Optional::OMITTED, /* default_val */ \"false\", \"If false, return hex-encoded tx, otherwise return a json object\"},\n+                    {\"count\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, /* default_val */ \"\", \"The block in which to look for the transaction\"},\n+                },\n+                {\n+                    RPCResult{\"if verbose is not set or set to false\",\n+            \"\\nResult:\\n\"\n+            \" [                                    (array of json objects)\\n\"\n+            \" [                                    (array of json objects) outpoint/tx pairs for spent outputs with this scriptPubKey\\n\"\n+            \"   {\\n\"\n+            \"      \\\"spent_outpoint\\\" : \\n\"\n+            \"      {\\n\"\n+            \"        \\\"txid\\\" : \\\"id\\\",            (string) The transaction id\\n\"\n+            \"        \\\"hex\\\" : \\\"data\\\",           (string) The serialized, hex-encoded data for 'txid'\\n\"\n+            \"      }\\n\"\n+            \"      (raw transaction OR hex-encoded transaction) \\n\"\n+            \"   }\\n\"\n+            \" ],\\n\"\n+            \"     \\n\"\n+            \" [                                    (array of json objects) outpoint/tx pairs for outputs created with this scriptPubKey\\n\"\n+            \"   {\\n\"\n+            \"      \\\"created_outpoint\\\" : \\n\"\n+            \"      {\\n\"\n+            \"        \\\"txid\\\" : \\\"id\\\",            (string) The transaction id\\n\"\n+            \"        \\\"hex\\\" : \\\"data\\\",           (string) The serialized, hex-encoded data for 'txid'\\n\"\n+            \"      }\\n\"\n+            \"      (raw transaction OR hex-encoded transaction) \\n\"\n+            \"   }\\n\"\n+            \" ],\\n\"\n+            \" ]\\n\"\n+                },\n+            },\n+            RPCExamples{\n+                    HelpExampleCli(\"searchrawtransactions\", \"\\\"address\\\"\")\n+        + HelpExampleCli(\"searchrawtransactions\", \"\\\"address\\\" true\")\n+            },\n+        }.ToString());\n+\n+    CScript scriptPubKey;\n+    const CTxDestination dest = DecodeDestination(request.params[0].get_str());\n+    if(IsValidDestination(dest)) {\n+        scriptPubKey = GetScriptForDestination(dest);\n+    } else if(IsHex(request.params[0].get_str())) {\n+        std::vector<unsigned char> data(ParseHex(request.params[0].get_str()));\n+        scriptPubKey = CScript(data.begin(), data.end());\n+    } else {\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address or script\");\n+    }\n+\n+    // Accept either a bool (true) or a num (>=1) to indicate verbose output.\n+    bool verbose = false;\n+    if (!request.params[1].isNull()) {\n+        verbose = request.params[1].isNum() ? (request.params[1].get_int() != 0) : request.params[1].get_bool();\n+    }\n+\n+    int count = 100;\n+    if (request.params.size() > 2) {\n+        if (!request.params[2].isNum()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid parameter, argument 3 must be an integer\");\n+        }\n+        count = request.params[2].get_int();\n+    }\n+\n+    if (!g_addr_index) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"This RPC requires -addrindex to be enabled.\");\n+    }\n+\n+    bool addrindex_ready = g_addr_index->BlockUntilSyncedToCurrentChain();\n+\n+    UniValue ret(UniValue::VARR);\n+\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> spends_result;\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> creations_result;\n+    if (!g_addr_index->FindTxsByScript(scriptPubKey, spends_result, creations_result)) {\n+        if (!addrindex_ready) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY,\"Transactions with given address not found. Blockchain transactions are still in the process of being indexed\");\n+        }\n+        return ret;\n+    }\n+\n+    UniValue spends(UniValue::VARR);\n+    UniValue creations(UniValue::VARR);\n+\n+    auto spends_it = spends_result.begin();\n+    while (spends_it != spends_result.end() && count--) {\n+        const auto& spend = *spends_it;\n+        UniValue tx_val(UniValue::VOBJ);\n+\n+        UniValue outpoint_val(UniValue::VOBJ);\n+        outpoint_val.pushKV(\"txid\", spend.first.hash.GetHex());\n+        outpoint_val.pushKV(\"n\", static_cast<int>(spend.first.n));\n+\n+        tx_val.pushKV(\"spent_outpoint\", outpoint_val);\n+        if (verbose) {\n+            TxToJSON(*(spend.second.first), spend.second.second, tx_val);\n+        } else {\n+            std::string hex_tx = EncodeHexTx(*(spend.second.first), RPCSerializationFlags());\n+            tx_val.pushKV(\"hex\", hex_tx);\n+        }\n+        spends.push_back(tx_val);\n+        ++spends_it;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364048337",
      "id" : 364048337,
      "line" : 336,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA0ODMzNw==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 336,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 125,
      "pull_request_review_id" : 339627272,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364048337",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364048499"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364048499"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There doesn't seem to be a way to skip transactions anymore. Was this removed intentionally?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T03:14:01Z",
      "diff_hunk" : "@@ -213,6 +214,142 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364048499",
      "id" : 364048499,
      "line" : 223,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA0ODQ5OQ==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 223,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 12,
      "pull_request_review_id" : 339627472,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364048499",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364324758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364324758"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Do you want to log or throw something here? If I understand the LevelDB docs correctly, you have what LevelDB says is a valid iterator which should be positioned at the key. I think if any of these return false you'd want to know as the DB could be corrupted.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T16:31:43Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';\n+\n+// DBKeyType is used by the address index to distinguish between the\n+// different kinds of values stored.\n+enum class DBKeyType : uint8_t {\n+    SEED,    // Seed used for MurmurHash3 inside GetAddrId\n+    SPENT,   // Used for values in the index indicating a spend\n+    CREATED, // Used for values in the index indicating the creation of an input\n+};\n+\n+// AddrId is used to identify each script.\n+using AddrId = unsigned int;\n+\n+namespace {\n+\n+struct DBKeyPrefix {\n+  AddrId m_addr_id;\n+\n+  DBKeyPrefix() {}\n+  explicit DBKeyPrefix(AddrId addr_id) :  m_addr_id(addr_id) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    char prefix = DB_ADDR_INDEX;\n+    READWRITE(prefix);\n+    if (prefix != DB_ADDR_INDEX) {\n+      throw std::ios_base::failure(\"Invalid format for address index DB key\");\n+    }\n+\n+    READWRITE(m_addr_id);\n+  }\n+};\n+\n+struct DBKey : DBKeyPrefix {\n+  DBKeyType m_key_type;\n+  COutPoint m_outpoint;\n+\n+  DBKey() {}\n+  explicit DBKey(DBKeyType key_type, AddrId addr_id, COutPoint outpoint) : DBKeyPrefix(addr_id), m_key_type(key_type), m_outpoint(outpoint) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    READWRITEAS(DBKeyPrefix, *this);\n+\n+    uint8_t key_type = static_cast<uint8_t>(m_key_type);\n+    READWRITE(key_type);\n+    m_key_type = static_cast<DBKeyType>(key_type);\n+\n+    // Check if the key type is a valid key. SEED keys are excluded because they\n+    // are never created with this type.\n+    if ((m_key_type != DBKeyType::SPENT) && (m_key_type != DBKeyType::CREATED)) {\n+      throw std::ios_base::failure(\"Invalid key type for address index DB key\");\n+    }\n+\n+    READWRITE(m_outpoint);\n+  }\n+};\n+\n+}; // namespace\n+\n+// The address index stores information needed to get relevant transactions,\n+// and a copy of the CScript to double check against in case of hash collisions.\n+using DBValue = std::pair<CDiskTxPos, CScript>;\n+\n+/** Access to the addr_index database (indexes/addr_index/)*/\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /** ReadAddrIndex returns the set of entries stored in the index for this addr_id. */\n+    std::vector<std::pair<DBKey, DBValue>> ReadAddrIndex(const unsigned int addr_id, const CScript& script);\n+\n+    /** WriteToIndex writes the input vector of database entries into the index.  */\n+    bool WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries);\n+\n+    /** SetupHashSeed is used to create/backup/restore the seed used by the index for hashing. */\n+    unsigned int SetupHashSeed();\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addr_index\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+std::vector<std::pair<DBKey, DBValue>> AddrIndex::DB::ReadAddrIndex(const unsigned int addr_id, const CScript& script)\n+{\n+    std::vector<std::pair<DBKey, DBValue>> result;\n+    DBKeyPrefix search_key(addr_id);\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    iter->Seek(search_key);\n+    while (iter->Valid()) {\n+        DBKey key;\n+        DBValue value;\n+        if (!iter->GetKey(key) || key.m_addr_id != addr_id || !iter->GetValue(value) ) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364324758",
      "id" : 364324758,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMyNDc1OA==",
      "original_commit_id" : "e739288bd5eadfd4f684b869a2e8067a1406052e",
      "original_line" : 123,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 339988317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364324758",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364329232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364329232"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think in general it would be nice if this class did some of the error logging that I see in `blockfilterindex.cpp`.  ",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T16:40:09Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';\n+\n+// DBKeyType is used by the address index to distinguish between the\n+// different kinds of values stored.\n+enum class DBKeyType : uint8_t {\n+    SEED,    // Seed used for MurmurHash3 inside GetAddrId\n+    SPENT,   // Used for values in the index indicating a spend\n+    CREATED, // Used for values in the index indicating the creation of an input\n+};\n+\n+// AddrId is used to identify each script.\n+using AddrId = unsigned int;\n+\n+namespace {\n+\n+struct DBKeyPrefix {\n+  AddrId m_addr_id;\n+\n+  DBKeyPrefix() {}\n+  explicit DBKeyPrefix(AddrId addr_id) :  m_addr_id(addr_id) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    char prefix = DB_ADDR_INDEX;\n+    READWRITE(prefix);\n+    if (prefix != DB_ADDR_INDEX) {\n+      throw std::ios_base::failure(\"Invalid format for address index DB key\");\n+    }\n+\n+    READWRITE(m_addr_id);\n+  }\n+};\n+\n+struct DBKey : DBKeyPrefix {\n+  DBKeyType m_key_type;\n+  COutPoint m_outpoint;\n+\n+  DBKey() {}\n+  explicit DBKey(DBKeyType key_type, AddrId addr_id, COutPoint outpoint) : DBKeyPrefix(addr_id), m_key_type(key_type), m_outpoint(outpoint) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    READWRITEAS(DBKeyPrefix, *this);\n+\n+    uint8_t key_type = static_cast<uint8_t>(m_key_type);\n+    READWRITE(key_type);\n+    m_key_type = static_cast<DBKeyType>(key_type);\n+\n+    // Check if the key type is a valid key. SEED keys are excluded because they\n+    // are never created with this type.\n+    if ((m_key_type != DBKeyType::SPENT) && (m_key_type != DBKeyType::CREATED)) {\n+      throw std::ios_base::failure(\"Invalid key type for address index DB key\");\n+    }\n+\n+    READWRITE(m_outpoint);\n+  }\n+};\n+\n+}; // namespace\n+\n+// The address index stores information needed to get relevant transactions,\n+// and a copy of the CScript to double check against in case of hash collisions.\n+using DBValue = std::pair<CDiskTxPos, CScript>;\n+\n+/** Access to the addr_index database (indexes/addr_index/)*/\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /** ReadAddrIndex returns the set of entries stored in the index for this addr_id. */\n+    std::vector<std::pair<DBKey, DBValue>> ReadAddrIndex(const unsigned int addr_id, const CScript& script);\n+\n+    /** WriteToIndex writes the input vector of database entries into the index.  */\n+    bool WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries);\n+\n+    /** SetupHashSeed is used to create/backup/restore the seed used by the index for hashing. */\n+    unsigned int SetupHashSeed();\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addr_index\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+std::vector<std::pair<DBKey, DBValue>> AddrIndex::DB::ReadAddrIndex(const unsigned int addr_id, const CScript& script)\n+{\n+    std::vector<std::pair<DBKey, DBValue>> result;\n+    DBKeyPrefix search_key(addr_id);\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    iter->Seek(search_key);\n+    while (iter->Valid()) {\n+        DBKey key;\n+        DBValue value;\n+        if (!iter->GetKey(key) || key.m_addr_id != addr_id || !iter->GetValue(value) ) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364329232",
      "id" : 364329232,
      "in_reply_to_id" : 364324758,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMyOTIzMg==",
      "original_commit_id" : "e739288bd5eadfd4f684b869a2e8067a1406052e",
      "original_line" : 123,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : null,
      "pull_request_review_id" : 339994050,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364329232",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364353217"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364353217"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Please also test the spends_results path (returning transactions which spend from this address).",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T17:31:40Z",
      "diff_hunk" : "@@ -487,6 +486,44 @@ def run_test(self):\n         assert_equal(testres['allowed'], True)\n         self.nodes[2].sendrawtransaction(hexstring=rawTxSigned['hex'], maxfeerate='0.20000000')\n \n+        self._test_searchrawtransactions()\n+\n+    def _test_searchrawtransactions(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364353217",
      "id" : 364353217,
      "line" : 494,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM1MzIxNw==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 494,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/rpc_rawtransaction.py",
      "position" : 23,
      "pull_request_review_id" : 340025939,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364353217",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364361434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364361434"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I *think* this is correct because he is using the prevout in the *key*. When looking up by this script with this outpoint, one would want to find this transaction because it spends this outpoint.\r\n\r\nAFAICT the value just contains the position of the relevant transaction on disk and the scriptPubKey (to detect collisions).  The value does not contain any indexes into inputs or outputs.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T17:50:39Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';\n+\n+// DBKeyType is used by the address index to distinguish between the\n+// different kinds of values stored.\n+enum class DBKeyType : uint8_t {\n+    SEED,    // Seed used for MurmurHash3 inside GetAddrId\n+    SPENT,   // Used for values in the index indicating a spend\n+    CREATED, // Used for values in the index indicating the creation of an input\n+};\n+\n+// AddrId is used to identify each script.\n+using AddrId = unsigned int;\n+\n+namespace {\n+\n+struct DBKeyPrefix {\n+  AddrId m_addr_id;\n+\n+  DBKeyPrefix() {}\n+  explicit DBKeyPrefix(AddrId addr_id) :  m_addr_id(addr_id) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    char prefix = DB_ADDR_INDEX;\n+    READWRITE(prefix);\n+    if (prefix != DB_ADDR_INDEX) {\n+      throw std::ios_base::failure(\"Invalid format for address index DB key\");\n+    }\n+\n+    READWRITE(m_addr_id);\n+  }\n+};\n+\n+struct DBKey : DBKeyPrefix {\n+  DBKeyType m_key_type;\n+  COutPoint m_outpoint;\n+\n+  DBKey() {}\n+  explicit DBKey(DBKeyType key_type, AddrId addr_id, COutPoint outpoint) : DBKeyPrefix(addr_id), m_key_type(key_type), m_outpoint(outpoint) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    READWRITEAS(DBKeyPrefix, *this);\n+\n+    uint8_t key_type = static_cast<uint8_t>(m_key_type);\n+    READWRITE(key_type);\n+    m_key_type = static_cast<DBKeyType>(key_type);\n+\n+    // Check if the key type is a valid key. SEED keys are excluded because they\n+    // are never created with this type.\n+    if ((m_key_type != DBKeyType::SPENT) && (m_key_type != DBKeyType::CREATED)) {\n+      throw std::ios_base::failure(\"Invalid key type for address index DB key\");\n+    }\n+\n+    READWRITE(m_outpoint);\n+  }\n+};\n+\n+}; // namespace\n+\n+// The address index stores information needed to get relevant transactions,\n+// and a copy of the CScript to double check against in case of hash collisions.\n+using DBValue = std::pair<CDiskTxPos, CScript>;\n+\n+/** Access to the addr_index database (indexes/addr_index/)*/\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /** ReadAddrIndex returns the set of entries stored in the index for this addr_id. */\n+    std::vector<std::pair<DBKey, DBValue>> ReadAddrIndex(const unsigned int addr_id, const CScript& script);\n+\n+    /** WriteToIndex writes the input vector of database entries into the index.  */\n+    bool WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries);\n+\n+    /** SetupHashSeed is used to create/backup/restore the seed used by the index for hashing. */\n+    unsigned int SetupHashSeed();\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addr_index\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+std::vector<std::pair<DBKey, DBValue>> AddrIndex::DB::ReadAddrIndex(const unsigned int addr_id, const CScript& script)\n+{\n+    std::vector<std::pair<DBKey, DBValue>> result;\n+    DBKeyPrefix search_key(addr_id);\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    iter->Seek(search_key);\n+    while (iter->Valid()) {\n+        DBKey key;\n+        DBValue value;\n+        if (!iter->GetKey(key) || key.m_addr_id != addr_id || !iter->GetValue(value) ) break;\n+\n+        // Check that the stored script matches the one we're searching for, in case of hash collisions.\n+        if (value.second != script) continue;\n+\n+        result.emplace_back(std::make_pair(key, value));\n+        iter->Next();\n+    }\n+\n+    return result;\n+}\n+\n+bool AddrIndex::Init() {\n+        m_hash_seed = m_db->SetupHashSeed();\n+        return BaseIndex::Init();\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)) {}\n+\n+unsigned int AddrIndex::DB::SetupHashSeed() {\n+    static const auto seed_key = std::make_pair(DB_ADDR_INDEX, static_cast<uint8_t>(DBKeyType::SEED));\n+    unsigned int seed;\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    std::pair<char, uint8_t> key;\n+\n+    // If key is in the index already, read it and return.\n+    iter->Seek(seed_key);\n+    if (iter->Valid() && iter->GetKey(key) && key == seed_key && iter->GetValue(seed)) {\n+        return seed;\n+    }\n+\n+    // Generate a random key and write it to the index.\n+    seed = GetRandInt(std::numeric_limits<int>::max());\n+    Write(seed_key, seed);\n+    return seed;\n+}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+unsigned int AddrIndex::GetAddrId(const CScript& script) {\n+    std::vector<unsigned char> script_data;\n+    for (auto it = script.begin(); it != script.end(); ++it) {\n+        script_data.push_back(*it);\n+    }\n+    return MurmurHash3(m_hash_seed, script_data);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<DBKey, DBValue>> entries;\n+\n+    const bool not_genesis_block = (pindex->nHeight > 0);\n+    if (not_genesis_block && !UndoReadFromDisk(block_undo, pindex)) {\n+      return false;\n+    }\n+\n+    for (size_t i = 0; i < block.vtx.size(); ++i) {\n+        const CTransaction& tx = *(block.vtx[i]);\n+        const uint256 tx_hash = tx.GetHash();\n+        for (size_t j = 0; j < tx.vout.size(); ++j) {\n+            CScript script_pub_key = tx.vout[j].scriptPubKey;\n+            DBKey key(DBKeyType::CREATED, GetAddrId(script_pub_key), COutPoint(tx_hash, j));\n+            entries.emplace_back(key, std::make_pair(pos, script_pub_key));\n+        }\n+\n+        // Skip coinbase inputs.\n+        if (not_genesis_block && i > 0) {\n+            const CTxUndo& tx_undo = block_undo.vtxundo[i-1];\n+            for (size_t k = 0; k < tx.vin.size(); ++k) {\n+                CScript spent_outputs_scriptpubkey = tx_undo.vprevout[k].out.scriptPubKey;\n+                DBKey key(DBKeyType::SPENT, GetAddrId(spent_outputs_scriptpubkey), tx.vin[k].prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364361434",
      "id" : 364361434,
      "in_reply_to_id" : 363971325,
      "line" : 209,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2MTQzNA==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 209,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : 209,
      "pull_request_review_id" : 340036491,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364361434",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364363443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364363443"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you add a comment with your key/value format somewhere and the justification?",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T17:55:21Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';\n+\n+// DBKeyType is used by the address index to distinguish between the\n+// different kinds of values stored.\n+enum class DBKeyType : uint8_t {\n+    SEED,    // Seed used for MurmurHash3 inside GetAddrId\n+    SPENT,   // Used for values in the index indicating a spend\n+    CREATED, // Used for values in the index indicating the creation of an input\n+};\n+\n+// AddrId is used to identify each script.\n+using AddrId = unsigned int;\n+\n+namespace {\n+\n+struct DBKeyPrefix {\n+  AddrId m_addr_id;\n+\n+  DBKeyPrefix() {}\n+  explicit DBKeyPrefix(AddrId addr_id) :  m_addr_id(addr_id) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    char prefix = DB_ADDR_INDEX;\n+    READWRITE(prefix);\n+    if (prefix != DB_ADDR_INDEX) {\n+      throw std::ios_base::failure(\"Invalid format for address index DB key\");\n+    }\n+\n+    READWRITE(m_addr_id);\n+  }\n+};\n+\n+struct DBKey : DBKeyPrefix {\n+  DBKeyType m_key_type;\n+  COutPoint m_outpoint;\n+\n+  DBKey() {}\n+  explicit DBKey(DBKeyType key_type, AddrId addr_id, COutPoint outpoint) : DBKeyPrefix(addr_id), m_key_type(key_type), m_outpoint(outpoint) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    READWRITEAS(DBKeyPrefix, *this);\n+\n+    uint8_t key_type = static_cast<uint8_t>(m_key_type);\n+    READWRITE(key_type);\n+    m_key_type = static_cast<DBKeyType>(key_type);\n+\n+    // Check if the key type is a valid key. SEED keys are excluded because they\n+    // are never created with this type.\n+    if ((m_key_type != DBKeyType::SPENT) && (m_key_type != DBKeyType::CREATED)) {\n+      throw std::ios_base::failure(\"Invalid key type for address index DB key\");\n+    }\n+\n+    READWRITE(m_outpoint);\n+  }\n+};\n+\n+}; // namespace\n+\n+// The address index stores information needed to get relevant transactions,\n+// and a copy of the CScript to double check against in case of hash collisions.\n+using DBValue = std::pair<CDiskTxPos, CScript>;\n+\n+/** Access to the addr_index database (indexes/addr_index/)*/\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /** ReadAddrIndex returns the set of entries stored in the index for this addr_id. */\n+    std::vector<std::pair<DBKey, DBValue>> ReadAddrIndex(const unsigned int addr_id, const CScript& script);\n+\n+    /** WriteToIndex writes the input vector of database entries into the index.  */\n+    bool WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries);\n+\n+    /** SetupHashSeed is used to create/backup/restore the seed used by the index for hashing. */\n+    unsigned int SetupHashSeed();\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addr_index\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+std::vector<std::pair<DBKey, DBValue>> AddrIndex::DB::ReadAddrIndex(const unsigned int addr_id, const CScript& script)\n+{\n+    std::vector<std::pair<DBKey, DBValue>> result;\n+    DBKeyPrefix search_key(addr_id);\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    iter->Seek(search_key);\n+    while (iter->Valid()) {\n+        DBKey key;\n+        DBValue value;\n+        if (!iter->GetKey(key) || key.m_addr_id != addr_id || !iter->GetValue(value) ) break;\n+\n+        // Check that the stored script matches the one we're searching for, in case of hash collisions.\n+        if (value.second != script) continue;\n+\n+        result.emplace_back(std::make_pair(key, value));\n+        iter->Next();\n+    }\n+\n+    return result;\n+}\n+\n+bool AddrIndex::Init() {\n+        m_hash_seed = m_db->SetupHashSeed();\n+        return BaseIndex::Init();\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)) {}\n+\n+unsigned int AddrIndex::DB::SetupHashSeed() {\n+    static const auto seed_key = std::make_pair(DB_ADDR_INDEX, static_cast<uint8_t>(DBKeyType::SEED));\n+    unsigned int seed;\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    std::pair<char, uint8_t> key;\n+\n+    // If key is in the index already, read it and return.\n+    iter->Seek(seed_key);\n+    if (iter->Valid() && iter->GetKey(key) && key == seed_key && iter->GetValue(seed)) {\n+        return seed;\n+    }\n+\n+    // Generate a random key and write it to the index.\n+    seed = GetRandInt(std::numeric_limits<int>::max());\n+    Write(seed_key, seed);\n+    return seed;\n+}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+unsigned int AddrIndex::GetAddrId(const CScript& script) {\n+    std::vector<unsigned char> script_data;\n+    for (auto it = script.begin(); it != script.end(); ++it) {\n+        script_data.push_back(*it);\n+    }\n+    return MurmurHash3(m_hash_seed, script_data);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<DBKey, DBValue>> entries;\n+\n+    const bool not_genesis_block = (pindex->nHeight > 0);\n+    if (not_genesis_block && !UndoReadFromDisk(block_undo, pindex)) {\n+      return false;\n+    }\n+\n+    for (size_t i = 0; i < block.vtx.size(); ++i) {\n+        const CTransaction& tx = *(block.vtx[i]);\n+        const uint256 tx_hash = tx.GetHash();\n+        for (size_t j = 0; j < tx.vout.size(); ++j) {\n+            CScript script_pub_key = tx.vout[j].scriptPubKey;\n+            DBKey key(DBKeyType::CREATED, GetAddrId(script_pub_key), COutPoint(tx_hash, j));\n+            entries.emplace_back(key, std::make_pair(pos, script_pub_key));\n+        }\n+\n+        // Skip coinbase inputs.\n+        if (not_genesis_block && i > 0) {\n+            const CTxUndo& tx_undo = block_undo.vtxundo[i-1];\n+            for (size_t k = 0; k < tx.vin.size(); ++k) {\n+                CScript spent_outputs_scriptpubkey = tx_undo.vprevout[k].out.scriptPubKey;\n+                DBKey key(DBKeyType::SPENT, GetAddrId(spent_outputs_scriptpubkey), tx.vin[k].prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364363443",
      "id" : 364363443,
      "in_reply_to_id" : 363971325,
      "line" : 209,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2MzQ0Mw==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 209,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : 209,
      "pull_request_review_id" : 340039105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364363443",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "For me what this PR is missing some analysis on the current size of the index in mainnet and the growth rate of the data. Has anyone run the numbers recently and can report?",
      "created_at" : "2020-01-08T18:39:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-572200658",
      "id" : 572200658,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MjIwMDY1OA==",
      "updated_at" : "2020-01-08T18:39:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/572200658",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364388433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364388433"
         }
      },
      "author_association" : "NONE",
      "body" : "```suggestion\r\n        outpoint_val.pushKV(\"txid\", spend.second.first.hash.GetHex());\r\n```\r\nI'll write a functional test that catches this too :)",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T18:53:46Z",
      "diff_hunk" : "@@ -213,6 +214,142 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)\n+        throw std::runtime_error(\n+             RPCHelpMan{ \"searchrawtransactions\\n\",\n+            \"\\nReturns raw transactions that contain outputs with the given script/address, and outpoint information for those outputs.\\n\"\n+            \"\\nRequires -addrindex to be enabled.\\n\"\n+            \"\\nArguments:\\n\",\n+                {\n+                    {\"address\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, /* default_val */ \"\", \"address or scriptPubKey\"},\n+                    {\"verbose\", RPCArg::Type::BOOL, RPCArg::Optional::OMITTED, /* default_val */ \"false\", \"If false, return hex-encoded tx, otherwise return a json object\"},\n+                    {\"count\", RPCArg::Type::NUM, RPCArg::Optional::OMITTED, /* default_val */ \"\", \"The block in which to look for the transaction\"},\n+                },\n+                {\n+                    RPCResult{\"if verbose is not set or set to false\",\n+            \"\\nResult:\\n\"\n+            \" [                                    (array of json objects)\\n\"\n+            \" [                                    (array of json objects) outpoint/tx pairs for spent outputs with this scriptPubKey\\n\"\n+            \"   {\\n\"\n+            \"      \\\"spent_outpoint\\\" : \\n\"\n+            \"      {\\n\"\n+            \"        \\\"txid\\\" : \\\"id\\\",            (string) The transaction id\\n\"\n+            \"        \\\"hex\\\" : \\\"data\\\",           (string) The serialized, hex-encoded data for 'txid'\\n\"\n+            \"      }\\n\"\n+            \"      (raw transaction OR hex-encoded transaction) \\n\"\n+            \"   }\\n\"\n+            \" ],\\n\"\n+            \"     \\n\"\n+            \" [                                    (array of json objects) outpoint/tx pairs for outputs created with this scriptPubKey\\n\"\n+            \"   {\\n\"\n+            \"      \\\"created_outpoint\\\" : \\n\"\n+            \"      {\\n\"\n+            \"        \\\"txid\\\" : \\\"id\\\",            (string) The transaction id\\n\"\n+            \"        \\\"hex\\\" : \\\"data\\\",           (string) The serialized, hex-encoded data for 'txid'\\n\"\n+            \"      }\\n\"\n+            \"      (raw transaction OR hex-encoded transaction) \\n\"\n+            \"   }\\n\"\n+            \" ],\\n\"\n+            \" ]\\n\"\n+                },\n+            },\n+            RPCExamples{\n+                    HelpExampleCli(\"searchrawtransactions\", \"\\\"address\\\"\")\n+        + HelpExampleCli(\"searchrawtransactions\", \"\\\"address\\\" true\")\n+            },\n+        }.ToString());\n+\n+    CScript scriptPubKey;\n+    const CTxDestination dest = DecodeDestination(request.params[0].get_str());\n+    if(IsValidDestination(dest)) {\n+        scriptPubKey = GetScriptForDestination(dest);\n+    } else if(IsHex(request.params[0].get_str())) {\n+        std::vector<unsigned char> data(ParseHex(request.params[0].get_str()));\n+        scriptPubKey = CScript(data.begin(), data.end());\n+    } else {\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address or script\");\n+    }\n+\n+    // Accept either a bool (true) or a num (>=1) to indicate verbose output.\n+    bool verbose = false;\n+    if (!request.params[1].isNull()) {\n+        verbose = request.params[1].isNum() ? (request.params[1].get_int() != 0) : request.params[1].get_bool();\n+    }\n+\n+    int count = 100;\n+    if (request.params.size() > 2) {\n+        if (!request.params[2].isNum()) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid parameter, argument 3 must be an integer\");\n+        }\n+        count = request.params[2].get_int();\n+    }\n+\n+    if (!g_addr_index) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"This RPC requires -addrindex to be enabled.\");\n+    }\n+\n+    bool addrindex_ready = g_addr_index->BlockUntilSyncedToCurrentChain();\n+\n+    UniValue ret(UniValue::VARR);\n+\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> spends_result;\n+    std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> creations_result;\n+    if (!g_addr_index->FindTxsByScript(scriptPubKey, spends_result, creations_result)) {\n+        if (!addrindex_ready) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY,\"Transactions with given address not found. Blockchain transactions are still in the process of being indexed\");\n+        }\n+        return ret;\n+    }\n+\n+    UniValue spends(UniValue::VARR);\n+    UniValue creations(UniValue::VARR);\n+\n+    auto spends_it = spends_result.begin();\n+    while (spends_it != spends_result.end() && count--) {\n+        const auto& spend = *spends_it;\n+        UniValue tx_val(UniValue::VOBJ);\n+\n+        UniValue outpoint_val(UniValue::VOBJ);\n+        outpoint_val.pushKV(\"txid\", spend.first.hash.GetHex());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364388433",
      "id" : 364388433,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM4ODQzMw==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 314,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 340071893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364388433",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364389525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364389525"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "As pointed out by jnewbery in review club, I think this is wrong. \r\n\r\nThe DB's key always represents the outpoint that *created* the scriptPubKey.  For spends_result, you want the txid of the transaction that *spends* the scriptPubKey.  So instead of the DB key's outpoint as the transaction id to be returned to the user, you want the transaction id of the transaction in the DB value.  Or, in the RPC code lines 314 and 315, use the txid from `spend.second`.\r\n\r\nEdit: Or maybe this field of the returned result is always the created_outpoint, even though it's called the spent_outpoint sometimes?  Would be good to clarify this.",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-08T18:56:02Z",
      "diff_hunk" : "@@ -0,0 +1,263 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+#include <boost/thread.hpp>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+static constexpr char DB_ADDR_INDEX = 'a';\n+\n+// DBKeyType is used by the address index to distinguish between the\n+// different kinds of values stored.\n+enum class DBKeyType : uint8_t {\n+    SEED,    // Seed used for MurmurHash3 inside GetAddrId\n+    SPENT,   // Used for values in the index indicating a spend\n+    CREATED, // Used for values in the index indicating the creation of an input\n+};\n+\n+// AddrId is used to identify each script.\n+using AddrId = unsigned int;\n+\n+namespace {\n+\n+struct DBKeyPrefix {\n+  AddrId m_addr_id;\n+\n+  DBKeyPrefix() {}\n+  explicit DBKeyPrefix(AddrId addr_id) :  m_addr_id(addr_id) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    char prefix = DB_ADDR_INDEX;\n+    READWRITE(prefix);\n+    if (prefix != DB_ADDR_INDEX) {\n+      throw std::ios_base::failure(\"Invalid format for address index DB key\");\n+    }\n+\n+    READWRITE(m_addr_id);\n+  }\n+};\n+\n+struct DBKey : DBKeyPrefix {\n+  DBKeyType m_key_type;\n+  COutPoint m_outpoint;\n+\n+  DBKey() {}\n+  explicit DBKey(DBKeyType key_type, AddrId addr_id, COutPoint outpoint) : DBKeyPrefix(addr_id), m_key_type(key_type), m_outpoint(outpoint) {}\n+\n+  ADD_SERIALIZE_METHODS;\n+\n+  template <typename Stream, typename Operation>\n+  inline void SerializationOp(Stream& s, Operation ser_action) {\n+    READWRITEAS(DBKeyPrefix, *this);\n+\n+    uint8_t key_type = static_cast<uint8_t>(m_key_type);\n+    READWRITE(key_type);\n+    m_key_type = static_cast<DBKeyType>(key_type);\n+\n+    // Check if the key type is a valid key. SEED keys are excluded because they\n+    // are never created with this type.\n+    if ((m_key_type != DBKeyType::SPENT) && (m_key_type != DBKeyType::CREATED)) {\n+      throw std::ios_base::failure(\"Invalid key type for address index DB key\");\n+    }\n+\n+    READWRITE(m_outpoint);\n+  }\n+};\n+\n+}; // namespace\n+\n+// The address index stores information needed to get relevant transactions,\n+// and a copy of the CScript to double check against in case of hash collisions.\n+using DBValue = std::pair<CDiskTxPos, CScript>;\n+\n+/** Access to the addr_index database (indexes/addr_index/)*/\n+class AddrIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /** ReadAddrIndex returns the set of entries stored in the index for this addr_id. */\n+    std::vector<std::pair<DBKey, DBValue>> ReadAddrIndex(const unsigned int addr_id, const CScript& script);\n+\n+    /** WriteToIndex writes the input vector of database entries into the index.  */\n+    bool WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries);\n+\n+    /** SetupHashSeed is used to create/backup/restore the seed used by the index for hashing. */\n+    unsigned int SetupHashSeed();\n+};\n+\n+AddrIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"addr_index\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+BaseIndex::DB& AddrIndex::GetDB() const { return *m_db; }\n+\n+std::vector<std::pair<DBKey, DBValue>> AddrIndex::DB::ReadAddrIndex(const unsigned int addr_id, const CScript& script)\n+{\n+    std::vector<std::pair<DBKey, DBValue>> result;\n+    DBKeyPrefix search_key(addr_id);\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    iter->Seek(search_key);\n+    while (iter->Valid()) {\n+        DBKey key;\n+        DBValue value;\n+        if (!iter->GetKey(key) || key.m_addr_id != addr_id || !iter->GetValue(value) ) break;\n+\n+        // Check that the stored script matches the one we're searching for, in case of hash collisions.\n+        if (value.second != script) continue;\n+\n+        result.emplace_back(std::make_pair(key, value));\n+        iter->Next();\n+    }\n+\n+    return result;\n+}\n+\n+bool AddrIndex::Init() {\n+        m_hash_seed = m_db->SetupHashSeed();\n+        return BaseIndex::Init();\n+}\n+\n+AddrIndex::AddrIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(MakeUnique<AddrIndex::DB>(n_cache_size, f_memory, f_wipe)) {}\n+\n+unsigned int AddrIndex::DB::SetupHashSeed() {\n+    static const auto seed_key = std::make_pair(DB_ADDR_INDEX, static_cast<uint8_t>(DBKeyType::SEED));\n+    unsigned int seed;\n+\n+    std::unique_ptr<CDBIterator> iter(NewIterator());\n+    std::pair<char, uint8_t> key;\n+\n+    // If key is in the index already, read it and return.\n+    iter->Seek(seed_key);\n+    if (iter->Valid() && iter->GetKey(key) && key == seed_key && iter->GetValue(seed)) {\n+        return seed;\n+    }\n+\n+    // Generate a random key and write it to the index.\n+    seed = GetRandInt(std::numeric_limits<int>::max());\n+    Write(seed_key, seed);\n+    return seed;\n+}\n+\n+AddrIndex::~AddrIndex() {}\n+\n+unsigned int AddrIndex::GetAddrId(const CScript& script) {\n+    std::vector<unsigned char> script_data;\n+    for (auto it = script.begin(); it != script.end(); ++it) {\n+        script_data.push_back(*it);\n+    }\n+    return MurmurHash3(m_hash_seed, script_data);\n+}\n+\n+bool AddrIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CBlockUndo block_undo;\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<DBKey, DBValue>> entries;\n+\n+    const bool not_genesis_block = (pindex->nHeight > 0);\n+    if (not_genesis_block && !UndoReadFromDisk(block_undo, pindex)) {\n+      return false;\n+    }\n+\n+    for (size_t i = 0; i < block.vtx.size(); ++i) {\n+        const CTransaction& tx = *(block.vtx[i]);\n+        const uint256 tx_hash = tx.GetHash();\n+        for (size_t j = 0; j < tx.vout.size(); ++j) {\n+            CScript script_pub_key = tx.vout[j].scriptPubKey;\n+            DBKey key(DBKeyType::CREATED, GetAddrId(script_pub_key), COutPoint(tx_hash, j));\n+            entries.emplace_back(key, std::make_pair(pos, script_pub_key));\n+        }\n+\n+        // Skip coinbase inputs.\n+        if (not_genesis_block && i > 0) {\n+            const CTxUndo& tx_undo = block_undo.vtxundo[i-1];\n+            for (size_t k = 0; k < tx.vin.size(); ++k) {\n+                CScript spent_outputs_scriptpubkey = tx_undo.vprevout[k].out.scriptPubKey;\n+                DBKey key(DBKeyType::SPENT, GetAddrId(spent_outputs_scriptpubkey), tx.vin[k].prevout);\n+                entries.emplace_back(key, std::make_pair(pos, spent_outputs_scriptpubkey));\n+            }\n+        }\n+        pos.nTxOffset += ::GetSerializeSize(tx, CLIENT_VERSION);\n+    }\n+\n+    return m_db->WriteToIndex(entries);\n+}\n+\n+bool AddrIndex::DB::WriteToIndex(const std::vector<std::pair<DBKey, DBValue>> &entries)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& entry : entries) {\n+        batch.Write(entry.first, entry.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+// FindTxsByScript fills the spends_result vector with outpoints corresponding\n+// to the output spent with the given script, and the transaction it was spent\n+// in. creations_result is filled with outpoints for outputs created with this\n+// script as their script pubkey, and the transactions they were created in.\n+bool AddrIndex::FindTxsByScript(const CScript& script,\n+                                std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> &spends_result,\n+                                std::vector<std::pair<COutPoint, std::pair<CTransactionRef, uint256>>> &creations_result)\n+{\n+    auto db_entries = m_db->ReadAddrIndex(GetAddrId(script), script);\n+    if (db_entries.size() == 0) return false;\n+\n+    for (const auto& entry : db_entries) {\n+        DBKey key = entry.first;\n+        CDiskTxPos pos = entry.second.first;\n+\n+        CAutoFile file(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION);\n+        if (file.IsNull()) {\n+            return error(\"%s: OpenBlockFile failed\", __func__);\n+        }\n+        CBlockHeader header;\n+        CTransactionRef tx;\n+        try {\n+            file >> header;\n+            if (fseek(file.Get(), pos.nTxOffset, SEEK_CUR)) {\n+                return error(\"%s: fseek(...) failed\", __func__);\n+            }\n+            file >> tx;\n+        } catch (const std::exception& e) {\n+            return error(\"%s: Deserialize or I/O error - %s\", __func__, e.what());\n+        }\n+        std::pair<CTransactionRef, uint256> result =  std::make_pair(tx, header.GetHash());\n+\n+        // Place entry into correct vector depending on its type.\n+        switch (key.m_key_type) {\n+            case DBKeyType::SPENT:\n+                spends_result.emplace_back(std::make_pair(key.m_outpoint, result));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r364389525",
      "id" : 364389525,
      "line" : 267,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM4OTUyNQ==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 267,
      "original_position" : 251,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : 267,
      "pull_request_review_id" : 340073212,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/364389525",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think @jnewbery was hinting at this in the PR Review Club as well: it seems like this index does not handle reorgs. `BaseIndex` handles this through `Rewind` which is not overridden.",
      "created_at" : "2020-01-08T20:19:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-572239482",
      "id" : 572239482,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MjIzOTQ4Mg==",
      "updated_at" : "2020-01-08T20:19:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/572239482",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ran on i7-8750H, took about 48 hours on an already synced node. Took 200 GB disk space.\r\n```\r\n2020-01-08T02:22:01Z addr_index thread start\r\n...\r\n2020-01-10T02:37:07Z addr_index is enabled at height 611001\r\n2020-01-10T02:37:07Z addr_index thread exit\r\n```\r\n```\r\n$ du -h addr_index\r\n200G\taddr_index\r\n```",
      "created_at" : "2020-01-10T02:49:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-572849475",
      "id" : 572849475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3Mjg0OTQ3NQ==",
      "updated_at" : "2020-01-10T18:07:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/572849475",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r365356888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/365356888"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should use the new `.Check()` syntax instead",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-01-10T17:56:13Z",
      "diff_hunk" : "@@ -213,6 +214,142 @@ static UniValue getrawtransaction(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue searchrawtransactions(const JSONRPCRequest& request) {\n+    if (request.fHelp || request.params.size() < 1 || request.params.size() > 4)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r365356888",
      "id" : 365356888,
      "in_reply_to_id" : 364043704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1Njg4OA==",
      "original_commit_id" : "c21767116be0d0ebcac5966db240d596be2b5920",
      "original_line" : 218,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 341326570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-30T23:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/365356888",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-01-22T10:41:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-577120859",
      "id" : 577120859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NzEyMDg1OQ==",
      "updated_at" : "2020-01-22T10:41:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/577120859",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Might be a good idea to replace `CDiskTxPos` with a height+tx# for [future?] pruning compatibility, like #13014",
      "created_at" : "2020-01-29T03:06:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-579571607",
      "id" : 579571607,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTU3MTYwNw==",
      "updated_at" : "2020-01-29T03:06:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579571607",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think @jnewbery was hinting at this in the PR Review Club as well: it seems like this index does not handle reorgs. BaseIndex handles this through Rewind which is not overridden.\r\n\r\nHandling reorgs might actually be undesirable for this... but changing CDiskTxPos like I just suggested to a block height could be incompatible with saving references to blocks not in the main chain too. (Maybe storing height OR blockhash would work?)",
      "created_at" : "2020-01-29T03:07:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-579571984",
      "id" : 579571984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTU3MTk4NA==",
      "updated_at" : "2020-01-29T03:07:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579571984",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-06T21:00:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-610034274",
      "id" : 610034274,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMDAzNDI3NA==",
      "updated_at" : "2020-04-06T21:00:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/610034274",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@marcinja Do you believe this index could allow wallets such as Electrum to avoid relying on extra applications (like ElectrumX, Electrum Private Server, etc), and (if leared how to speak Bitcoin RPC) use Bitcoin Core node directly?",
      "created_at" : "2020-04-08T12:56:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-610942861",
      "id" : 610942861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMDk0Mjg2MQ==",
      "updated_at" : "2020-04-08T12:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/610942861",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Any update when this could be merged?",
      "created_at" : "2020-06-28T08:18:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-650716222",
      "id" : 650716222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MDcxNjIyMg==",
      "updated_at" : "2020-06-28T08:18:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/650716222",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/1388925?v=4",
         "events_url" : "https://api.github.com/users/baso10/events{/privacy}",
         "followers_url" : "https://api.github.com/users/baso10/followers",
         "following_url" : "https://api.github.com/users/baso10/following{/other_user}",
         "gists_url" : "https://api.github.com/users/baso10/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/baso10",
         "id" : 1388925,
         "login" : "baso10",
         "node_id" : "MDQ6VXNlcjEzODg5MjU=",
         "organizations_url" : "https://api.github.com/users/baso10/orgs",
         "received_events_url" : "https://api.github.com/users/baso10/received_events",
         "repos_url" : "https://api.github.com/users/baso10/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/baso10/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/baso10/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/baso10"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Any update when this could be merged?\r\n\r\nI kind of thought that this was still in conceptual review but it has received 5 Concept ACKs from experienced Core developers and I did not see much of the push back this has received historically, so I tend to believe this can be moved out of Conceptual review phase and move forward. There is still a lot of work to be done in terms of testing, documentation etc.\r\n\r\n@marcinja If you are currently unable to work on this I would be happy to take this over since I have some experience with indexes already :)",
      "created_at" : "2020-06-28T09:49:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-650726577",
      "id" : 650726577,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MDcyNjU3Nw==",
      "updated_at" : "2020-06-28T09:49:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/650726577",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Past NACKs don't disappear just because a new PR is opened...",
      "created_at" : "2020-06-28T10:00:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-650727850",
      "id" : 650727850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MDcyNzg1MA==",
      "updated_at" : "2020-06-28T10:00:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/650727850",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Past NACKs don't disappear just because a new PR is opened...\r\n\r\nDefinitely agree, especially if the PRs are very close. But I think if a new PR is opened with a different approach it can still be expected for the reviewers who gave NACKs in the past, to participate in the discussion again and reinstate their NACK or someone else who agrees with their view should do it for them. Otherwise, we might never be able to move forward if a concept is NACKed and then the reviewer leaves the project or just does not comment on the new approach. But it would probably be good if @marcinja would address the past NACKs directly and give those reviewers another chance to say if they have changed their minds or not.",
      "created_at" : "2020-06-28T10:12:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-650729233",
      "id" : 650729233,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MDcyOTIzMw==",
      "updated_at" : "2020-06-28T10:12:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/650729233",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-06-28T11:22:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-650737107",
      "id" : 650737107,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MDczNzEwNw==",
      "updated_at" : "2020-06-28T11:22:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/650737107",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Any update when this could be merged?\r\n\r\n@baso10 \r\n\r\n1. This PR needs to be rebased, as you can see in https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-610034274\r\n\r\n2. The PR is still going through peer review -- see the discussion above\r\n\r\n3. See https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review for more info about the peer review process in this project\r\n",
      "created_at" : "2020-06-28T11:49:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-650740221",
      "id" : 650740221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MDc0MDIyMQ==",
      "updated_at" : "2020-06-28T11:49:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/650740221",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "A good resource for more context and history and reasons for and against this addition: https://bitcoincore.reviews/14053.\r\n",
      "created_at" : "2020-06-28T11:49:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-650740253",
      "id" : 650740253,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MDc0MDI1Mw==",
      "updated_at" : "2020-06-28T11:49:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/650740253",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-14T07:20:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-658015558",
      "id" : 658015558,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODAxNTU1OA==",
      "updated_at" : "2020-07-14T07:20:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658015558",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Hey everyone. Just wanted to give a small update here. I am still planning on keeping this PR up-to-date and rebased. I've realized it's more annoying to rebase after procrastinating, and also it's not fair to the reviewers and other people interested so I will be much more diligent about rebasing now.\r\n\r\nThe total size of the address index right now is 223GB. I don't have a good answer on  index sync time because I was re-syncing on a laptop. This was done on the 8f3fc6b4b8fb1a2db3035398d3dd5a2ed91cc3f9 branch over the course of a few days.  I'm going to time an IBD and addrindex sync on a desktop with a good SSD so as to get meaningful results.\r\n\r\nThe good news is that `searchrawtransactions` is not prohibitively slow. \r\n```\r\ntime ./src/bitcoin-cli searchrawtransactions 3EiAcrzq1cELXScc98KeCswGWZaPGceT1d true 30000 > big-search\r\n\r\n./src/bitcoin-cli searchrawtransactions 3EiAcrzq1cELXScc98KeCswGWZaPGceT1d     4.79s user 1.95s system 49% cpu 13.575 total\r\n```\r\n(the file `big-search` created here is about 366MB)\r\n\r\nI have also confirmed that the address index has the same number of created/spent outpoints as on this explorer:  https://blockstream.info/address/3EiAcrzq1cELXScc98KeCswGWZaPGceT1d\r\n\r\n",
      "created_at" : "2020-07-15T01:54:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-658499547",
      "id" : 658499547,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODQ5OTU0Nw==",
      "updated_at" : "2020-07-15T01:56:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658499547",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-07-30T16:28:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-666507188",
      "id" : 666507188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjUwNzE4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T16:28:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666507188",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@marcinja If you feel like it, you could pull 2ce521784432550007c0df1da85b4d3d0b1c7477 and 2761d11cc798d42839676f98250781a3ea445ce2 out of here and PR separately.",
      "created_at" : "2020-07-31T03:19:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-666891128",
      "id" : 666891128,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2Njg5MTEyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-31T03:19:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666891128",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r466563287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466563287"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n * uniqueness and to support multiple values for a single addr_id and key_type\r\n```",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-08-06T17:16:24Z",
      "diff_hunk" : "@@ -0,0 +1,279 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+/*\n+ * The address index stores two main types of objects that allow for\n+ * script-based/address-based look-ups of all created outputs and all spent\n+ * outputs in the Bitcoin blockchain. These are differentiated by their key_type\n+ * as either DBKeyType::SPENT or DBKekyType::CREATED. The address index also\n+ * stores one unique global value under the DBKeyType::SEED key that seeds the\n+ * MurmurHash3 hasher used to create AddrIds.\n+ *\n+ * The DB keys are structured as follows: <addr_id, key_type, outpoint>\n+ *\n+ * addr_id is the hash of the script_pub_key computed using MurmurHash3, a a\n+ * short non-cryptographic hash function. It also functions as the search key,\n+ * since LevelDB keys are iterated through in lexicograpical order. Collisions\n+ * are resolved by storing the full script_pub_key in the DB value. This can be\n+ * checked against the script used to make a look-up in the index.\n+ *\n+ * key_type is SPENT when the outpoint stored in the key is spent, i.e. it is\n+ * used as a prevout in a transaction input.  It is CREATED when the outpoint is\n+ * created as a new  COutpoint in that transaction.\n+ *\n+ * outpoints are stored in the key as opposed to in the DB value to preserve\n+ * uniqueness and to support multiple values for a a single addr_id and key_type",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r466563287",
      "id" : 466563287,
      "line" : 41,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MzI4Nw==",
      "original_commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "original_line" : 41,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : 41,
      "pull_request_review_id" : 462721671,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:17:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466563287",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/9900?v=4",
         "events_url" : "https://api.github.com/users/romanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/romanz/followers",
         "following_url" : "https://api.github.com/users/romanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/romanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/romanz",
         "id" : 9900,
         "login" : "romanz",
         "node_id" : "MDQ6VXNlcjk5MDA=",
         "organizations_url" : "https://api.github.com/users/romanz/orgs",
         "received_events_url" : "https://api.github.com/users/romanz/received_events",
         "repos_url" : "https://api.github.com/users/romanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/romanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/romanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/romanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r466563439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466563439"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n * addr_id is the hash of the script_pub_key computed using MurmurHash3, a\r\n```",
      "commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "created_at" : "2020-08-06T17:16:41Z",
      "diff_hunk" : "@@ -0,0 +1,279 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <dbwrapper.h>\n+#include <hash.h>\n+#include <index/addrindex.h>\n+#include <index/disktxpos.h>\n+#include <shutdown.h>\n+#include <primitives/transaction.h>\n+#include <random.h>\n+#include <script/standard.h>\n+#include <txdb.h>\n+#include <validation.h>\n+#include <vector>\n+#include <uint256.h>\n+\n+std::unique_ptr<AddrIndex> g_addr_index;\n+\n+/*\n+ * The address index stores two main types of objects that allow for\n+ * script-based/address-based look-ups of all created outputs and all spent\n+ * outputs in the Bitcoin blockchain. These are differentiated by their key_type\n+ * as either DBKeyType::SPENT or DBKekyType::CREATED. The address index also\n+ * stores one unique global value under the DBKeyType::SEED key that seeds the\n+ * MurmurHash3 hasher used to create AddrIds.\n+ *\n+ * The DB keys are structured as follows: <addr_id, key_type, outpoint>\n+ *\n+ * addr_id is the hash of the script_pub_key computed using MurmurHash3, a a",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#discussion_r466563439",
      "id" : 466563439,
      "line" : 30,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MzQzOQ==",
      "original_commit_id" : "75e044564bc0561c72fe1bcbb6d21dfc3a3314fd",
      "original_line" : 30,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/index/addrindex.cpp",
      "position" : 30,
      "pull_request_review_id" : 462721671,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14053",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:17:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466563439",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/9900?v=4",
         "events_url" : "https://api.github.com/users/romanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/romanz/followers",
         "following_url" : "https://api.github.com/users/romanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/romanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/romanz",
         "id" : 9900,
         "login" : "romanz",
         "node_id" : "MDQ6VXNlcjk5MDA=",
         "organizations_url" : "https://api.github.com/users/romanz/orgs",
         "received_events_url" : "https://api.github.com/users/romanz/received_events",
         "repos_url" : "https://api.github.com/users/romanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/romanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/romanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/romanz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-13T09:57:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-673383887",
      "id" : 673383887,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MzM4Mzg4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-13T09:57:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/673383887",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-21T05:57:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-678055852",
      "id" : 678055852,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3ODA1NTg1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-21T05:57:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/678055852",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-22T17:08:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-696855631",
      "id" : 696855631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5Njg1NTYzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-22T17:08:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/696855631",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Can someone plz approve this?",
      "created_at" : "2020-10-13T07:01:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-707536003",
      "id" : 707536003,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNzUzNjAwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-13T07:01:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/707536003",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/10693052?v=4",
         "events_url" : "https://api.github.com/users/c78867886/events{/privacy}",
         "followers_url" : "https://api.github.com/users/c78867886/followers",
         "following_url" : "https://api.github.com/users/c78867886/following{/other_user}",
         "gists_url" : "https://api.github.com/users/c78867886/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/c78867886",
         "id" : 10693052,
         "login" : "c78867886",
         "node_id" : "MDQ6VXNlcjEwNjkzMDUy",
         "organizations_url" : "https://api.github.com/users/c78867886/orgs",
         "received_events_url" : "https://api.github.com/users/c78867886/received_events",
         "repos_url" : "https://api.github.com/users/c78867886/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/c78867886/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/c78867886/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/c78867886"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2020-11-08T01:48:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-723519083",
      "id" : 723519083,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMzUxOTA4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-08T01:48:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/723519083",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/60179867?v=4",
         "events_url" : "https://api.github.com/users/decryp2kanon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/decryp2kanon/followers",
         "following_url" : "https://api.github.com/users/decryp2kanon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/decryp2kanon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/decryp2kanon",
         "id" : 60179867,
         "login" : "decryp2kanon",
         "node_id" : "MDQ6VXNlcjYwMTc5ODY3",
         "organizations_url" : "https://api.github.com/users/decryp2kanon/orgs",
         "received_events_url" : "https://api.github.com/users/decryp2kanon/received_events",
         "repos_url" : "https://api.github.com/users/decryp2kanon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/decryp2kanon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/decryp2kanon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/decryp2kanon"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@marcinja will this allow other wallets like Electrum to utilize this feature (RPC credentials provided, of course) and avoid having to run ElecturmX (https://github.com/spesmilo/electrumx), EPS (https://github.com/chris-belcher/electrum-personal-server) or BWT (https://github.com/shesek/bwt) intermediary software?\r\n\r\n@ecdsa @SomberNight @chris-belcher @shesek could you provide your input on how this feature might be useful (or not)?",
      "created_at" : "2020-12-13T12:47:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-744002909",
      "id" : 744002909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NDAwMjkwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-13T12:47:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/744002909",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The main issue AFAIU is that Electrum is using `SHA256(scriptPubKey)` while this PR is using `MurmurHash3(scriptPubKey)`.\r\nAlso, ElectrumX & [electrs](https://github.com/romanz/electrs) are using RocksDB for the index storage - resulting in better performance and disk usage (compared to LevelDB).",
      "created_at" : "2020-12-13T14:30:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-744015971",
      "id" : 744015971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NDAxNTk3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-13T14:30:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/744015971",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/9900?v=4",
         "events_url" : "https://api.github.com/users/romanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/romanz/followers",
         "following_url" : "https://api.github.com/users/romanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/romanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/romanz",
         "id" : 9900,
         "login" : "romanz",
         "node_id" : "MDQ6VXNlcjk5MDA=",
         "organizations_url" : "https://api.github.com/users/romanz/orgs",
         "received_events_url" : "https://api.github.com/users/romanz/received_events",
         "repos_url" : "https://api.github.com/users/romanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/romanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/romanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/romanz"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@Talkless note that while some Electrum users run their own bitcoind, many do not. Electrum wants to support both use cases, and in fact the suspicion is that most users just use a public server. When using a public server, the client cannot use bitcoind RPC, hence in that case I don't see how the middleware (e.g. ElectrumX) could be avoided.\r\n\r\nFor the own bitcoind use case, maybe the client could have another optional mode of operation where it uses bitcoind RPC directly, which is I guess what you are asking about. For that, an address-index in bitcoind is the main thing missing indeed, however not the only one. For one, the electrum protocol (the client<->\"middleware server\" connection) has address subscriptions - the client gets a notification when a history of one its addresses changes. We are also planning on soon adding another method into the protocol that allows `txoutpoint->spender_txid` lookups (and notifications); I guess that could be implemented using the index in this PR albeit in a very inefficient way for heavily reused addresses.\r\n\r\nIMHO there are multiple upsides for having this middleware setup for Electrum:\r\n- for the project, it keeps the codebase simpler (again, we want to support users without own bitcoind)\r\n- for the project, it also allows for more flexibility for implementing new functionality: just consider present PR here, we have needed such an index for 9 years but bitcoind did not have it or want it, so we could just implement it ourselves\r\n- for the server operator, even if they don't want to open up the server for the public, they could share it with their friends and family. I don't think that's feasible with bitcoind RPC. I think this is a common use case.\r\n\r\nNevertheless if someone steps up and contributes patches, this kind of thing could be added.\r\n\r\n-----\r\n\r\n> The total size of the address index right now is 223GB\r\n\r\nThat sounds much larger than expected.\r\nEven with the `txoutpoint->spender_txid` map I mentioned above, when using LevelDB, ElectrumX uses around 90 GiB of disk space.\r\n\r\n> The DB keys are structured as follows: `<addr_id, key_type, outpoint>`\r\n> The DB values are simply: `<CDiskTxPos, CScript> `\r\n\r\nInstead of having both `addr_id` and `CScript`, why not just put a long hash, e.g. `sha256(CScript)` into the key?\r\n\r\nAlso, I expect most users of this index would also want txindex enabled. You might want to consider making address index dependent on txindex. Have you investigated how much space that would save? There would be no need to store `CDiskTxPos`.\r\n\r\nAnother trick that ElectrumX uses is that only the best chain is indexed. We have a `tx_num->txid` map as raw files on disk. A `tx_num` is the index of the transaction in the linear history of the blockchain, a 5-byte integer (so e.g. the genesis block coinbase tx has `tx_num=0`). This map uses around 17 GiB atm. With this, you can encode the txid part of the `outpoint` as 5 bytes instead of 32 bytes.",
      "created_at" : "2020-12-13T15:04:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-744020488",
      "id" : 744020488,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NDAyMDQ4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-13T15:04:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/744020488",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/29142493?v=4",
         "events_url" : "https://api.github.com/users/SomberNight/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SomberNight/followers",
         "following_url" : "https://api.github.com/users/SomberNight/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SomberNight/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SomberNight",
         "id" : 29142493,
         "login" : "SomberNight",
         "node_id" : "MDQ6VXNlcjI5MTQyNDkz",
         "organizations_url" : "https://api.github.com/users/SomberNight/orgs",
         "received_events_url" : "https://api.github.com/users/SomberNight/received_events",
         "repos_url" : "https://api.github.com/users/SomberNight/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SomberNight/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SomberNight/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SomberNight"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK (might have already done that)",
      "created_at" : "2020-12-17T19:09:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-747639681",
      "id" : 747639681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzYzOTY4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-17T19:09:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747639681",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm concept -0 on this.\r\n\r\nMy primary objection is that I think it's a bad idea for any infrastructure to be built all that relies on having fully-indexed blockchain data available (this also applies to txindex, but we can't just remove support...).\r\n\r\nHowever, it seems many people want something like this, and are going to use it anyway. The question is then whether it belongs in the bitcoin-core codebase. Alternative, and more performant presumably, like electrs exist already too, so it isn't exactly impossible to do this elsewhere.\r\n\r\nStill, given that we now have the indexes infrastructure, it means that things like this are easy to add in a fairly modular way without invading consensus code. So if people really want this, fine.\r\n\r\nOverall approach comment: I don't think MurmurHash should be used for anything new; there are strictly better hash functions available. I'd suggest SipHash if that's fast enough.",
      "created_at" : "2020-12-17T19:25:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-747648440",
      "id" : 747648440,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzY0ODQ0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-17T19:28:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747648440",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm also a little more negative on having this in Core than I previously was. After working in a few industrial contexts on wallet stuff, it's clear to me that an address index is really only required if you want to implement a block explorer or do chain analysis. For both of these applications, using something like electrs seems sufficient.\r\n\r\nFor personal wallet management, a full address index is not required. I think the origin of some confusion is that things like the Electrum Personal Server have become synonymous with this kind of usage, but in reality a full index is overkill when descriptor-specific rescans can be done once for a historical backfill and then per-block scanning can be done from there on out.\r\n\r\nI want to point out that this is a nice implementation and good work by @marcinja, but I'm leaning slightly against the inclusion of such an index in Core at this point.",
      "created_at" : "2020-12-17T19:42:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-747658388",
      "id" : 747658388,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzY1ODM4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-17T19:42:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747658388",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> My primary objection is that I think it's a bad idea for any infrastructure to be built that relies on having fully-indexed blockchain data available.\r\n\r\nI agree on this.\r\n\r\nIMO the only use cases to ever use a full address index are:\r\n* 1) Instant seed/xpriv backup recovery including spent history\r\n* 2) Backend service for thousands of wallets\r\n* 3) Debug/explore purposes\r\n\r\n**1** (instant backup recovery) could be solved with either `scantxoutset` (take a minute or two) or by an address-index for the utxo set only. But both would not restore the spent history.\r\nA scalable non-enterprise solution to restore the spent history is using blockfilters. Scan through the filters and rescan only the relevant blocks (a matter of minutes), see #20664.\r\n\r\n**2** (a backend for thousands of wallets): out of scope for this project.\r\n\r\n**3** (explore purposes): I think this is a valid use case. Though adding this PR to Bitcoin Core will lead to **many many projects** using it **in production** increasing the traffic in this project and eventually *steal* time from existing contributors (rebase, maintenance, drag-along)\r\n\r\n**My main fear is that people are going to use this index (a full address index) to use it as an electrum(ish) backend for a handful of wallets.**\r\n\r\nWith multiwallet, watch-only-wallets, PSBT, we have all tools to server multiple wallets in a scalable way for external applications.\r\n\r\nI also think merging this as it is, would be in contradiction to the process- and repository-separation effort.\r\n\r\nTherefore I'm ~0 (slightly towards NACK) to add this.\r\nIf this would be in another repository (still under `bitcoin/*`) and process separated, I would ACK it.",
      "created_at" : "2020-12-17T19:48:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-747661798",
      "id" : 747661798,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzY2MTc5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-17T19:48:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747661798",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hi all, thanks for the feedback and review. This was an enjoyable PR to work on and I learned a lot from all your comments.\r\n\r\nI'm closing this PR because its size probably requires stronger support from contributors to get in. It also seems more clear now that all of the practical use-cases are covered by existing features and some lightweight alternatives (https://github.com/bitcoin/bitcoin/pull/20664) .\r\n\r\nI also agree that it would be bad to incentivize using an address index to support an external electrum wallet, when it's not the intended use-case and would cause unnecessary burden on contributors and maintainers in this project, e.g. from users of those wallets wanting new features or updates.",
      "created_at" : "2021-01-04T16:21:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-754071381",
      "id" : 754071381,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NDA3MTM4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-04T16:21:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/754071381",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12243734?v=4",
         "events_url" : "https://api.github.com/users/marcinja/events{/privacy}",
         "followers_url" : "https://api.github.com/users/marcinja/followers",
         "following_url" : "https://api.github.com/users/marcinja/following{/other_user}",
         "gists_url" : "https://api.github.com/users/marcinja/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/marcinja",
         "id" : 12243734,
         "login" : "marcinja",
         "node_id" : "MDQ6VXNlcjEyMjQzNzM0",
         "organizations_url" : "https://api.github.com/users/marcinja/orgs",
         "received_events_url" : "https://api.github.com/users/marcinja/received_events",
         "repos_url" : "https://api.github.com/users/marcinja/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/marcinja/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/marcinja"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@marcinja thank you and I hope to see more contributions of this quality from you.",
      "created_at" : "2021-01-04T16:53:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14053#issuecomment-754089336",
      "id" : 754089336,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14053",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NDA4OTMzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-04T16:53:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/754089336",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
