{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "When entering bitcoin://1F1tAaz5x1HUXrCNLbtMDqcw6o5GNn4xqX in the Safari address bar, it opens BitcoinQT, but then says: \r\n \r\n<img width=\"432\" alt=\"invalid\" src=\"https://user-images.githubusercontent.com/10217/32615780-e8e88142-c570-11e7-962d-d3f7c4abe346.png\">\r\n\r\nDev hint: try [RCDefault](http://www.rubicode.com/Software/Bundles.html#RCDefaultApp) in order to make OSX open these links using a custom build.\r\n\r\nTested with v0.15.1rc1 as well as master. Using QT 5.8.0.\r\n\r\nThis doesn't happen when I start QT from the command line:\r\n`Bitcoin-Qt bitcoin://1F1tAaz5x1HUXrCNLbtMDqcw6o5GNn4xqX`\r\n\r\nIt does happen if I use:\r\n`open bitcoin://1F1tAaz5x1HUXrCNLbtMDqcw6o5GNn4xqX`\r\n\r\nSo it's not a Safari issue.\r\n\r\nUsing log statements I found that this downcase happens somewhere before `bool parseBitcoinURI` in `guiutil.cpp`. This function actually strips `//` from the URI because:\r\n\r\n```  \r\n//    Cannot handle this later, because bitcoin:// will cause Qt to see the part after // as host,\r\n```\r\n\r\nSee also #854.\r\n\r\nThis function is called from `PaymentServer::handleURIOrFile` in `paymentserver.cpp`. \r\n\r\nBefore that `bool PaymentServer::eventFilter` uses:\r\n\r\n```cpp\r\n      QFileOpenEvent *fileEvent = static_cast<QFileOpenEvent*>(event);\r\n      ...\r\n          handleURIOrFile(fileEvent->url().toString());\r\n```\r\n\r\nLower case already happened here.\r\n\r\nIf I use a single slash, there's no downcase, altough the UI then complains about the initial slash.\r\n\r\nSo perhaps something changed in QT and we need to do this earlier. Or it's OSX that's broken.\r\n\r\nThis does behave, suggesting that indeed something is treating the address as a host name:\r\n`open bitcoin:1F1tAaz5x1HUXrCNLbtMDqcw6o5GNn4xqX`\r\n\r\nQT documentation for [QUrl](http://doc.qt.io/qt-5/qurl.html#UrlFormattingOption-enum) suggests this is expected behavior:\r\n\r\n> Note that the case folding rules in Nameprep, which QUrl conforms to, require host names to always be converted to lower case, regardless of the Qt::FormattingOptions used.\r\n\r\nThat remark has been in their documentation more or less [forever](https://github.com/qt/qtbase/blame/5.8/src/corelib/io/qurl.cpp#L247-L249). \r\n\r\nI can't find a workaround, unless there's some way to get additional information out of [QFileOpenEvent](http://doc.qt.io/qt-5/qfileopenevent.html).",
   "closed_at" : "2018-03-27T22:11:42Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
      "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
      "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/MarcoFalke",
      "id" : 6399679,
      "login" : "MarcoFalke",
      "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
      "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
      "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
      "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/MarcoFalke"
   },
   "comments" : 19,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11645/comments",
   "created_at" : "2017-11-09T16:21:46Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11645/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/11645",
   "id" : 272624603,
   "labels" : [
      {
         "color" : "02d7e1",
         "default" : false,
         "id" : 135946,
         "name" : "GUI",
         "node_id" : "MDU6TGFiZWwxMzU5NDY=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/GUI"
      },
      {
         "color" : "660000",
         "default" : false,
         "id" : 234879,
         "name" : "macOS",
         "node_id" : "MDU6TGFiZWwyMzQ4Nzk=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/macOS"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11645/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUyNzI2MjQ2MDM=",
   "number" : 11645,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "BitcoinQT downcases bitcoin://... address on OSX",
   "updated_at" : "2018-03-27T22:11:42Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11645",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
      "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
      "followers_url" : "https://api.github.com/users/Sjors/followers",
      "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/Sjors",
      "id" : 10217,
      "login" : "Sjors",
      "node_id" : "MDQ6VXNlcjEwMjE3",
      "organizations_url" : "https://api.github.com/users/Sjors/orgs",
      "received_events_url" : "https://api.github.com/users/Sjors/received_events",
      "repos_url" : "https://api.github.com/users/Sjors/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/Sjors"
   }
}
