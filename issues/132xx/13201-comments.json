[
   {
      "author_association" : "MEMBER",
      "body" : "I believe I encountered the race condition I describe in the OP during a run of the `p2p_node_network_limited.py` test.  An exception was raised in `disconnect_all()`, where the test disconnects each pair of peers.  Here's the relevant test log snippet:\r\n\r\n```\r\n node0 2018-05-09T16:27:51.966761Z Received a POST request for / from 127.0.0.1:57133 \r\n node0 2018-05-09T16:27:51.966844Z ThreadRPCServer method=getpeerinfo user=__cookie__ \r\n node0 2018-05-09T16:27:51.968238Z Received a POST request for / from 127.0.0.1:57133 \r\n node0 2018-05-09T16:27:51.973861Z ThreadRPCServer method=disconnectnode user=__cookie__ \r\n node0 2018-05-09T16:27:51.980630Z Received a POST request for / from 127.0.0.1:57133 \r\n node0 2018-05-09T16:27:51.986890Z ThreadRPCServer method=disconnectnode user=__cookie__ \r\n node0 2018-05-09T16:27:51.993866Z Received a POST request for / from 127.0.0.1:57133 \r\n node0 2018-05-09T16:27:51.998753Z ThreadRPCServer method=getpeerinfo user=__cookie__ \r\n node0 2018-05-09T16:27:51.999412Z disconnecting peer=0 \r\n node0 2018-05-09T16:27:52.007234Z disconnecting peer=1 \r\n node1 2018-05-09T16:27:52.007299Z socket closed \r\n node0 2018-05-09T16:27:52.007387Z Cleared nodestate for peer=0 \r\n node1 2018-05-09T16:27:52.008380Z Received a POST request for / from 127.0.0.1:57134 \r\n node0 2018-05-09T16:27:52.012901Z Cleared nodestate for peer=1 \r\n node1 2018-05-09T16:27:52.015917Z disconnecting peer=0 \r\n node1 2018-05-09T16:27:52.022234Z ThreadRPCServer method=getpeerinfo user=__cookie__ \r\n node1 2018-05-09T16:27:52.022266Z Cleared nodestate for peer=0 \r\n node1 2018-05-09T16:27:52.022394Z socket closed \r\n node1 2018-05-09T16:27:52.022435Z disconnecting peer=1 \r\n node1 2018-05-09T16:27:52.022482Z Cleared nodestate for peer=1 \r\n node1 2018-05-09T16:27:52.023900Z Received a POST request for / from 127.0.0.1:57134 \r\n node1 2018-05-09T16:27:52.028597Z ThreadRPCServer method=disconnectnode user=__cookie__ \r\n test  2018-05-09T16:27:52.034000Z TestFramework (ERROR): JSONRPC error\r\n```\r\nSo we're telling node0 to disconnect from node1 first, and then we're telling node1 to disconnect from node0.  Note that the calculation of which nodes to disconnect node1 from (which happens in the node1.getpeerinfo() call) is before node1 disconnects node0, but we actual call node1.disconnectnode() after that.\r\n\r\n@jnewbery Does this look right to you?",
      "created_at" : "2018-05-09T17:28:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13201#issuecomment-387814473",
      "id" : 387814473,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13201",
      "updated_at" : "2018-05-09T17:28:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/387814473",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 09c6699900da962c5e35eb82e358240a4099838f.\r\n\r\nSeems reasonable - the only way we can receive a `RPC_CLIENT_NODE_NOT_CONNECTED` is if the requested node to disconnect is not found in conman's `vNodes`. In that case it's fine to just continue, since we're already disconnected by definition.",
      "created_at" : "2018-05-09T20:10:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13201#issuecomment-387860362",
      "id" : 387860362,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13201",
      "updated_at" : "2018-05-09T20:10:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/387860362",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Making disconnection idempotent seems a good idea. utACK 09c6699900da962c5e35eb82e358240a4099838f",
      "created_at" : "2018-05-10T07:17:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13201#issuecomment-387973394",
      "id" : 387973394,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13201",
      "updated_at" : "2018-05-10T07:17:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/387973394",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 09c6699900da962c5e35eb82e358240a4099838f. Nice fixup, that should be backported",
      "created_at" : "2018-05-10T14:30:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13201#issuecomment-388071062",
      "id" : 388071062,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13201",
      "updated_at" : "2018-05-10T14:30:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/388071062",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
