[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r349952741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349952741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit: Instead of returning an UniValue, I'd prefer to return a `CAmount`, so that (if needed) the function can also be called from unit tests easily.",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2019-11-24T22:38:32Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static UniValue GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r349952741",
      "id" : 349952741,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTk1Mjc0MQ==",
      "original_commit_id" : "2377697e3660808890faf9c820791dfd38f26d20",
      "original_position" : 4,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 321991887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-01-26T04:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349952741",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2019-11-24T23:53:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#issuecomment-557942635",
      "id" : 557942635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17579",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1Nzk0MjYzNQ==",
      "updated_at" : "2020-03-27T01:40:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557942635",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r350471066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/350471066"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2019-11-25T23:12:04Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static UniValue GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r350471066",
      "id" : 350471066,
      "in_reply_to_id" : 349952741,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MDQ3MTA2Ng==",
      "original_commit_id" : "2377697e3660808890faf9c820791dfd38f26d20",
      "original_position" : 4,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 322639265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-01-26T04:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/350471066",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r351043470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/351043470"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke can you expand on how returning `CAmount` makes it easier to test? Is it due to not having `UniValue` as a dependency? In that case I should remove `UniValue` as a parameter as well.",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2019-11-27T00:21:30Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static UniValue GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r351043470",
      "id" : 351043470,
      "in_reply_to_id" : 349952741,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MTA0MzQ3MA==",
      "original_commit_id" : "2377697e3660808890faf9c820791dfd38f26d20",
      "original_position" : 4,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 323364360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-01-26T04:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/351043470",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r352824275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/352824275"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This uses the multiple address case, used by `getreceivedbylabel`, and the singular case used by `getreceivedbyaddress` is no longer needed.",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2019-12-02T20:56:59Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static CAmount GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)\n+{\n+    std::set<CTxDestination> addresses;\n+\n+    if (by_label) {\n+        // Get the set of pub keys assigned to label\n+        std::string label = LabelFromValue(params[0]);\n+        addresses = wallet->GetLabelAddresses(label);\n+    } else {\n+        // Get the address\n+        CTxDestination dest = DecodeDestination(params[0].get_str());\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address\");\n+        }\n+        CScript script_pub_key = GetScriptForDestination(dest);\n+        if (!wallet->IsMine(script_pub_key)) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Address not found in wallet\");\n+        }\n+        addresses.insert(dest);\n+    }\n+\n+    // Minimum confirmations\n+    int min_depth = 1;\n+    if (!params[1].isNull())\n+        min_depth = params[1].get_int();\n+\n+    // Tally\n+    CAmount amount = 0;\n+    for (const std::pair<const uint256, CWalletTx>& wtx_pair : wallet->mapWallet) {\n+        const CWalletTx& wtx = wtx_pair.second;\n+        if (wtx.IsCoinBase() || !locked_chain.checkFinalTx(*wtx.tx)) {\n+            continue;\n+        }\n+\n+        int depth = wtx.GetDepthInMainChain();\n+        if (depth < min_depth) {\n+            continue;\n+        }\n+\n+        for (const CTxOut& txout : wtx.tx->vout) {\n+            CTxDestination address;\n+            if (ExtractDestination(txout.scriptPubKey, address) && wallet->IsMine(address) && addresses.count(address)) {\n+                amount += txout.nValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r352824275",
      "id" : 352824275,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MjgyNDI3NQ==",
      "original_commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "original_position" : 46,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 41,
      "pull_request_review_id" : 325737413,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-01-26T04:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/352824275",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370402737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370402737"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Variable naming: s/`wallet`/`pwallet` (see e.g. `ListReceived()` and `SendMoney()` in the same file) to be more consistent",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2020-01-23T23:08:32Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static CAmount GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370402737",
      "id" : 370402737,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwMjczNw==",
      "original_commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "original_position" : 4,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 347668337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-01-26T04:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370402737",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370403279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370403279"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Remove extra space after `return`",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2020-01-23T23:10:18Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static CAmount GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)\n+{\n+    std::set<CTxDestination> addresses;\n+\n+    if (by_label) {\n+        // Get the set of pub keys assigned to label\n+        std::string label = LabelFromValue(params[0]);\n+        addresses = wallet->GetLabelAddresses(label);\n+    } else {\n+        // Get the address\n+        CTxDestination dest = DecodeDestination(params[0].get_str());\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address\");\n+        }\n+        CScript script_pub_key = GetScriptForDestination(dest);\n+        if (!wallet->IsMine(script_pub_key)) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Address not found in wallet\");\n+        }\n+        addresses.insert(dest);\n+    }\n+\n+    // Minimum confirmations\n+    int min_depth = 1;\n+    if (!params[1].isNull())\n+        min_depth = params[1].get_int();\n+\n+    // Tally\n+    CAmount amount = 0;\n+    for (const std::pair<const uint256, CWalletTx>& wtx_pair : wallet->mapWallet) {\n+        const CWalletTx& wtx = wtx_pair.second;\n+        if (wtx.IsCoinBase() || !locked_chain.checkFinalTx(*wtx.tx)) {\n+            continue;\n+        }\n+\n+        int depth = wtx.GetDepthInMainChain();\n+        if (depth < min_depth) {\n+            continue;\n+        }\n+\n+        for (const CTxOut& txout : wtx.tx->vout) {\n+            CTxDestination address;\n+            if (ExtractDestination(txout.scriptPubKey, address) && wallet->IsMine(address) && addresses.count(address)) {\n+                amount += txout.nValue;\n+            }\n+        }\n+    }\n+\n+    return  amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370403279",
      "id" : 370403279,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwMzI3OQ==",
      "original_commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "original_position" : 51,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 347668337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-01-26T04:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370403279",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370405036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370405036"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "More a matter of taste, but this could simply be put in the `if` condition above and without an extra variable (that is used only once anyway)? Like\r\n```\r\nif (wtx.IsCoinBase() || !locked_chain.checkFinalTx(*wtx.tx) || wtx.GetDepthInMainChain() < min_depth) {\r\n    continue;\r\n}\r\n```",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2020-01-23T23:15:47Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static CAmount GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)\n+{\n+    std::set<CTxDestination> addresses;\n+\n+    if (by_label) {\n+        // Get the set of pub keys assigned to label\n+        std::string label = LabelFromValue(params[0]);\n+        addresses = wallet->GetLabelAddresses(label);\n+    } else {\n+        // Get the address\n+        CTxDestination dest = DecodeDestination(params[0].get_str());\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address\");\n+        }\n+        CScript script_pub_key = GetScriptForDestination(dest);\n+        if (!wallet->IsMine(script_pub_key)) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Address not found in wallet\");\n+        }\n+        addresses.insert(dest);\n+    }\n+\n+    // Minimum confirmations\n+    int min_depth = 1;\n+    if (!params[1].isNull())\n+        min_depth = params[1].get_int();\n+\n+    // Tally\n+    CAmount amount = 0;\n+    for (const std::pair<const uint256, CWalletTx>& wtx_pair : wallet->mapWallet) {\n+        const CWalletTx& wtx = wtx_pair.second;\n+        if (wtx.IsCoinBase() || !locked_chain.checkFinalTx(*wtx.tx)) {\n+            continue;\n+        }\n+\n+        int depth = wtx.GetDepthInMainChain();\n+        if (depth < min_depth) {\n+            continue;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370405036",
      "id" : 370405036,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwNTAzNg==",
      "original_commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "original_position" : 41,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 347668337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-01-26T04:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370405036",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370406635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370406635"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: put `/* by_label */` before boolean parameter `false` to increase readability.",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2020-01-23T23:21:17Z",
      "diff_hunk" : "@@ -620,36 +671,7 @@ static UniValue getreceivedbyaddress(const JSONRPCRequest& request)\n     auto locked_chain = pwallet->chain().lock();\n     LOCK(pwallet->cs_wallet);\n \n-    // Bitcoin address\n-    CTxDestination dest = DecodeDestination(request.params[0].get_str());\n-    if (!IsValidDestination(dest)) {\n-        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address\");\n-    }\n-    CScript scriptPubKey = GetScriptForDestination(dest);\n-    if (!pwallet->IsMine(scriptPubKey)) {\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"Address not found in wallet\");\n-    }\n-\n-    // Minimum confirmations\n-    int nMinDepth = 1;\n-    if (!request.params[1].isNull())\n-        nMinDepth = request.params[1].get_int();\n-\n-    // Tally\n-    CAmount nAmount = 0;\n-    for (const std::pair<const uint256, CWalletTx>& pairWtx : pwallet->mapWallet) {\n-        const CWalletTx& wtx = pairWtx.second;\n-        if (wtx.IsCoinBase() || !locked_chain->checkFinalTx(*wtx.tx)) {\n-            continue;\n-        }\n-\n-        for (const CTxOut& txout : wtx.tx->vout)\n-            if (txout.scriptPubKey == scriptPubKey)\n-                if (wtx.GetDepthInMainChain() >= nMinDepth)\n-                    nAmount += txout.nValue;\n-    }\n-\n-    return  ValueFromAmount(nAmount);\n+    return ValueFromAmount(GetReceived(*locked_chain, pwallet, request.params, false));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370406635",
      "id" : 370406635,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwNjYzNQ==",
      "original_commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "original_position" : 92,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 347668337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-01-26T04:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370406635",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370406744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370406744"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: put `/* by_label */` before boolean parameter `true` to increase readability.",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2020-01-23T23:21:40Z",
      "diff_hunk" : "@@ -690,34 +712,7 @@ static UniValue getreceivedbylabel(const JSONRPCRequest& request)\n     auto locked_chain = pwallet->chain().lock();\n     LOCK(pwallet->cs_wallet);\n \n-    // Minimum confirmations\n-    int nMinDepth = 1;\n-    if (!request.params[1].isNull())\n-        nMinDepth = request.params[1].get_int();\n-\n-    // Get the set of pub keys assigned to label\n-    std::string label = LabelFromValue(request.params[0]);\n-    std::set<CTxDestination> setAddress = pwallet->GetLabelAddresses(label);\n-\n-    // Tally\n-    CAmount nAmount = 0;\n-    for (const std::pair<const uint256, CWalletTx>& pairWtx : pwallet->mapWallet) {\n-        const CWalletTx& wtx = pairWtx.second;\n-        if (wtx.IsCoinBase() || !locked_chain->checkFinalTx(*wtx.tx)) {\n-            continue;\n-        }\n-\n-        for (const CTxOut& txout : wtx.tx->vout)\n-        {\n-            CTxDestination address;\n-            if (ExtractDestination(txout.scriptPubKey, address) && pwallet->IsMine(address) && setAddress.count(address)) {\n-                if (wtx.GetDepthInMainChain() >= nMinDepth)\n-                    nAmount += txout.nValue;\n-            }\n-        }\n-    }\n-\n-    return ValueFromAmount(nAmount);\n+    return ValueFromAmount(GetReceived(*locked_chain, pwallet, request.params, true));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r370406744",
      "id" : 370406744,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwNjc0NA==",
      "original_commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "original_position" : 128,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 347668337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-01-26T04:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370406744",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@theStack thank you for the review. I've addressed all comments.",
      "created_at" : "2020-01-25T01:27:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#issuecomment-578362213",
      "id" : 578362213,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17579",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODM2MjIxMw==",
      "updated_at" : "2020-01-25T01:27:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578362213",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 4111967281a37cfe0d34802a80dba0715bfe3ffb\r\n\r\nNice cleanup, and also nice to hoist the DepthInMainChain check out of the inner loop.\r\n\r\nOptionally, since this is more than a pure code move, some of the variable names/comments could be improved as well (the \"addresses\" variable name, as well as the comment referring to pubkeys are outdated).",
      "created_at" : "2020-03-27T03:27:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#issuecomment-604795680",
      "id" : 604795680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17579",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNDc5NTY4MA==",
      "updated_at" : "2020-03-27T03:27:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604795680",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r399386787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399386787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nstatic CAmount GetReceived(interfaces::Chain::Lock& locked_chain, const CWallet& wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet.cs_wallet)\r\n```",
      "commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "created_at" : "2020-03-27T16:24:36Z",
      "diff_hunk" : "@@ -583,6 +583,52 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static CAmount GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r399386787",
      "id" : 399386787,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4Njc4Nw==",
      "original_commit_id" : "4111967281a37cfe0d34802a80dba0715bfe3ffb",
      "original_position" : 4,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 4,
      "pull_request_review_id" : 383011785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2020-03-27T16:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399386787",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
