{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "~~Intended to fix 19853~~\r\n\r\nThere appears to be a race condition when using the wallet RPCs right after starting a node and that causes the tests to be flaky: in the `wallet_basic.py` a node is restarted and `getbalance` gets called right after. `getbalance` then sometimes reports a balance of 0 because the wallet is not loaded yet. It looks like this only appeared after the `zapwallettxs` tests [were removed from this test](https://github.com/bitcoin/bitcoin/commit/3340dbadd38f5624642cf0e14dddbe6f83a3863b#diff-02ae125bb09504d8766277c965a739f9) but it should not directly be caused by the removal, it rather hides the issue less often. I wouldn't be surprised if this is a known issue that has popped up in a different context already but I didn't find anything on it yet.\r\n\r\nMy naive solution is to track a ready state for `CWallet` but I am very much looking for concept feedback on that. Returning `Null` seems to be the default behavior for wallet RPCs in early failure cases like this. An explicit error might be more helpful for users to figure out what happened but I am opting for consistency for now. Either option is much better than reporting a balance 0 that is incorrect but that could be real and could cause alarm systems to go off because all of a sudden a wallet balance is 0 after a node restarts.\r\n\r\nWhether this ends up being the final solution or not, after the conceptual discussion I think it will make sense to add this check to other wallet RPCs and I will also check if there are other open flaky wallet test issues that might be caused by the same bug.\r\n\r\nTo reproduce the issue see the commented out block of code that I left in the test file. This reproduces the issue on ~4 out of 5 tries on my machine.\r\n\r\nEDIT: The actual error that appears in the CI is hit [here](https://github.com/bitcoin/bitcoin/pull/19876/files#diff-02ae125bb09504d8766277c965a739f9R611) where `node0_balance` is 0 and then `sendtoaddress` is called with a negative amount.",
   "closed_at" : "2022-10-12T18:15:37Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
      "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
      "followers_url" : "https://api.github.com/users/achow101/followers",
      "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/achow101",
      "id" : 3782274,
      "login" : "achow101",
      "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
      "organizations_url" : "https://api.github.com/users/achow101/orgs",
      "received_events_url" : "https://api.github.com/users/achow101/received_events",
      "repos_url" : "https://api.github.com/users/achow101/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/achow101"
   },
   "comments" : 14,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19876/comments",
   "created_at" : "2020-09-04T20:31:49Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19876/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/19876",
   "id" : 693591822,
   "labels" : [
      {
         "color" : "08a781",
         "default" : false,
         "description" : null,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      },
      {
         "color" : "0052cc",
         "default" : false,
         "description" : null,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "node_id" : "MDU6TGFiZWw5ODI3OTE3Nw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      },
      {
         "color" : "cccccc",
         "default" : false,
         "description" : "",
         "id" : 955867938,
         "name" : "Needs rebase",
         "node_id" : "MDU6TGFiZWw5NTU4Njc5Mzg=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19876/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NDgwMDY3NTkz",
   "number" : 19876,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/19876.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19876",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/19876.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19876"
   },
   "reactions" : {
      "+1" : 1,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 1,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19876/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19876/timeline",
   "title" : "wallet: Fix wallet loading race during node start",
   "updated_at" : "2022-10-12T18:15:37Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19876",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
      "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fjahr/followers",
      "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fjahr",
      "id" : 1322187,
      "login" : "fjahr",
      "node_id" : "MDQ6VXNlcjEzMjIxODc=",
      "organizations_url" : "https://api.github.com/users/fjahr/orgs",
      "received_events_url" : "https://api.github.com/users/fjahr/received_events",
      "repos_url" : "https://api.github.com/users/fjahr/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fjahr"
   }
}
