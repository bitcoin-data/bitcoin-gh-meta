[
   {
      "author_association" : "MEMBER",
      "body" : "Build failing\r\n```\r\nnet_processing.cpp:2478:27: error: writing variable 'm_next_local_addr_send' requires holding mutex 'pfrom.cs_sendProcessing' exclusively [-Werror,-Wthread-safety-analysis]\r\n                    pfrom.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\r\n```",
      "created_at" : "2020-08-31T12:37:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-683752038",
      "id" : 683752038,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4Mzc1MjAzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-31T12:37:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683752038",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20864 (net: Move SocketSendData lock annotation to header by MarcoFalke)\n* #20729 (p2p: standardize on outbound-{full, block}-relay connection type naming by jonatack)\n* #20726 (p2p: Add DISABLETX message for negotiating block-relay-only connections by sdaftuar)\n* #20196 (net: fix GetListenPort() to derive the proper port by vasild)\n* #17944 (netaddress: Simplify reachability logic by dongcarl)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-08-31T12:38:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-683752544",
      "id" : 683752544,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4Mzc1MjU0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-06T21:07:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683752544",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-03T13:20:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-686485681",
      "id" : 686485681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NjQ4NTY4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-03T13:20:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686485681",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-21T07:46:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-695957307",
      "id" : 695957307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTk1NzMwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-21T07:46:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695957307",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r498937654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498937654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "shouldn't the `cs_sendProcessing` be acquired here? I'm slightly confused because I'd expect a CI job to fail since `m_next_local_addr_send` has the `GUARDED_BY(cs_sendProcessing)` safety annotation. am I missing something? ",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-02T16:53:50Z",
      "diff_hunk" : "@@ -4140,7 +4130,9 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         int64_t nNow = GetTimeMicros();\n         auto current_time = GetTime<std::chrono::microseconds>();\n \n-        if (pto->RelayAddrsWithConn() && !::ChainstateActive().IsInitialBlockDownload() && pto->m_next_local_addr_send < current_time) {\n+        if (pto->RelayAddrsWithConn() && !m_chainman.ActiveChainstate().IsInitialBlockDownload() && fListen &&\n+            pto->fSuccessfullyConnected && pto->m_next_local_addr_send < current_time) {\n+\n             AdvertiseLocal(pto);\n             pto->m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r498937654",
      "id" : 498937654,
      "line" : 4074,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkzNzY1NA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 4074,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 80,
      "pull_request_review_id" : 501296232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498937654",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499276450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499276450"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is it the case that this entire `SendMessages` call is locked? https://github.com/bitcoin/bitcoin/blob/df2129a2349b1877049f250551f49a4592e73765/src/net.cpp#L2164-L2168",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-04T18:47:01Z",
      "diff_hunk" : "@@ -4140,7 +4130,9 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         int64_t nNow = GetTimeMicros();\n         auto current_time = GetTime<std::chrono::microseconds>();\n \n-        if (pto->RelayAddrsWithConn() && !::ChainstateActive().IsInitialBlockDownload() && pto->m_next_local_addr_send < current_time) {\n+        if (pto->RelayAddrsWithConn() && !m_chainman.ActiveChainstate().IsInitialBlockDownload() && fListen &&\n+            pto->fSuccessfullyConnected && pto->m_next_local_addr_send < current_time) {\n+\n             AdvertiseLocal(pto);\n             pto->m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499276450",
      "id" : 499276450,
      "in_reply_to_id" : 498937654,
      "line" : 4074,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NjQ1MA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 4074,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 80,
      "pull_request_review_id" : 501649004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499276450",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@amitiuttarwar how would you suggest to split the first commit into two? I'd be happy to take suggestions :)\r\nI don't see a way to do it, because the refactor is to merge two *a little different* chunks of code into one (`AdvertiseLocal`). \r\n\r\nThe only way I see is to add a flag to `AdvertiseLocal` to discern the two, and then drop the flag right in the next commit (\"behaviour change\"). But do you think that would make the code easier to follow? :)",
      "created_at" : "2020-10-05T08:17:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-703478443",
      "id" : 703478443,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMzQ3ODQ0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-05T08:17:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/703478443",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499743996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499743996"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    // In absence of other information, we assume that the locally seen address is the \"best\" addr for peers to refer to our node.\r\n```",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-05T17:01:36Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499743996",
      "id" : 499743996,
      "line" : 207,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0Mzk5Ng==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 207,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 72,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499743996",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499747657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499747657"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This comment confuses me. If Peer_A gave us \"the address it tells us that it sees us as\", why would we need to give Peer_A our address?\r\n\r\nIs this comment supposed to mean that we sometimes refer to ourselves as the address that another peer gave us? I.e. we heard from Peer_A that they know us as `addrRemote`, and we sometimes announce our address to another peer `Peer_B` as `addrRemote` instead of `addrLocal`?",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-05T17:08:25Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499747657",
      "id" : 499747657,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NzY1Nw==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 217,
      "original_position" : 19,
      "original_start_line" : 207,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499747657",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499749612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499749612"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am not sure whether I am understanding this right. Is this suggesting that we keep track of each `addr` that some peer refers to us as separately, or are we catering to the possibility that our IP from remote looks different than what we see locally?",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-05T17:12:10Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499749612",
      "id" : 499749612,
      "in_reply_to_id" : 499743996,
      "line" : 207,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0OTYxMg==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 207,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 72,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499749612",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499752581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499752581"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It looks to me as if we are updating here the address that we think we are reachable on per the information of a peer. Would it be possible for different peers to see us at different addresses (e.g. if our node has a client in our LAN)? How do we verify that the address is a good address to adopt?",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-05T17:17:23Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499752581",
      "id" : 499752581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MjU4MQ==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 214,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499752581",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499753279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499753279"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n * to relay to a given node as scheduled. The relay is not guaranteed.\r\n```",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-05T17:18:38Z",
      "diff_hunk" : "@@ -614,6 +614,11 @@ enum\n };\n \n bool IsPeerAddrLocalGood(CNode *pnode);\n+\n+/**\n+ * Adds our \"best\" local address to the batch of addresses we are planning\n+ * to relay a given node as scheduled. The relay is not guaranteed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499753279",
      "id" : 499753279,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MzI3OQ==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 620,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499753279",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499763658"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499763658"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since `addrLocal` seems to be a local variable here, would it make sense to change it to `addr_local`? My understanding is that per style guide variable symbols should prefer to use snake_case.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-05T17:37:38Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());\n+    }\n+    if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499763658",
      "id" : 499763658,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MzY1OA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 216,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499763658",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499922947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499922947"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ahhh ð¡  that makes sense. thanks! ",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-05T23:19:36Z",
      "diff_hunk" : "@@ -4140,7 +4130,9 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         int64_t nNow = GetTimeMicros();\n         auto current_time = GetTime<std::chrono::microseconds>();\n \n-        if (pto->RelayAddrsWithConn() && !::ChainstateActive().IsInitialBlockDownload() && pto->m_next_local_addr_send < current_time) {\n+        if (pto->RelayAddrsWithConn() && !m_chainman.ActiveChainstate().IsInitialBlockDownload() && fListen &&\n+            pto->fSuccessfullyConnected && pto->m_next_local_addr_send < current_time) {\n+\n             AdvertiseLocal(pto);\n             pto->m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499922947",
      "id" : 499922947,
      "in_reply_to_id" : 498937654,
      "line" : 4074,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyMjk0Nw==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 4074,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 80,
      "pull_request_review_id" : 502484802,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499922947",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500055283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500055283"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">we keep track of each addr that some peer refers to us as separately, or are we catering to the possibility that our IP from remote looks different than what we see locally?\r\n\r\nSort of both :)\r\nA remote peer always tells us via which IP they see us (within VERSION message, see `addrMe` field there). Then, we store this to consider in future. Among all these options, we sometimes choose the best to advertise it to a remote peer instead of advertising what *we think* is our local addr. ",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T07:17:53Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500055283",
      "id" : 500055283,
      "in_reply_to_id" : 499743996,
      "line" : 207,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1NTI4Mw==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 207,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 72,
      "pull_request_review_id" : 502646382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500055283",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500056598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500056598"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hopefully [this](https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500055283) comment answers.\r\n\r\nWhy we give it to them? Because we ask them to *forward* our self-announcement to other nodes. Peer_A is not supposed currently to modify an `ADDR` they receive, so they just take what we give them and forward it.\r\n\r\nYou are right that they could, but it has other implications...",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T07:20:24Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500056598",
      "id" : 500056598,
      "in_reply_to_id" : 499747657,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1NjU5OA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 217,
      "original_position" : 19,
      "original_start_line" : 207,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502648040,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500056598",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500059166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500059166"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">Would it be possible for different peers to see us at different addresses (e.g. if our node has a client in our LAN)?\r\n\r\nYes, see `SeenLocal` and `GetLocal`, it's an under-documented scoring scheme.\r\n\r\nYou are right that it's not the most robust feature, someone can trick us to believe something wrong, but the harm is limited I guess.\r\n\r\nThis feature is definitely worth extra research and documenting.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T07:25:21Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500059166",
      "id" : 500059166,
      "in_reply_to_id" : 499752581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1OTE2Ng==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 214,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502651465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500059166",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500060454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500060454"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Even though it looks like I rewrote the whole method, most of the changes is just moving the code out of the `{}` block. I chose to preserve variable names to make review easier. I prefer to not touch existing variable names, unless it's really easy, or if I'm changing their type for example.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T07:27:43Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());\n+    }\n+    if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500060454",
      "id" : 500060454,
      "in_reply_to_id" : 499763658,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA2MDQ1NA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 216,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502653188,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500060454",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Per @amitiuttarwar 's suggestion, here's one way I might split your first commit 89c77a015a3ad14d1c05b4b975ed6532392e4654 into two separate parts for easier review:\r\n\r\n* Refactoring-only changes: e4bca91105d580d11d977e397b78cee28728ef8f\r\n* Behavior changes: 1ca2235aaa3cba43e2a1dbccaa89aa8577f91152\r\n\r\nAlternatively, here's a more fine-grained approach, in which I split your first commit 89c77a015a3ad14d1c05b4b975ed6532392e4654 into 8 separate commits, 5 refactoring only commits and 3 behavior changes:\r\n\r\na0a422c34cfd6514d0cc445bd784d3ee1a2d1749...e2c1c58d8d602cd413e435b03d3c634fb2c5bbd6\r\n\r\nThe more fine-grained approach might also be helpful for PR Review Club participants who are trying to understand exactly what changed in your first commit.",
      "created_at" : "2020-10-06T08:59:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-704131702",
      "id" : 704131702,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNDEzMTcwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-06T08:59:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/704131702",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500140568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500140568"
         }
      },
      "author_association" : "MEMBER",
      "body" : "join with line above while you're touching this",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T09:38:08Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500140568",
      "id" : 500140568,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MDU2OA==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 213,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500140568",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500140845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500140845"
         }
      },
      "author_association" : "MEMBER",
      "body" : "add blank line above and join `{` below onto this line.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T09:38:34Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());\n+    }\n+    if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500140845",
      "id" : 500140845,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MDg0NQ==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 216,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500140845",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500141353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500141353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/Adds/Add/ (make function doxygen comments the indicative case)",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T09:39:23Z",
      "diff_hunk" : "@@ -614,6 +614,11 @@ enum\n };\n \n bool IsPeerAddrLocalGood(CNode *pnode);\n+\n+/**\n+ * Adds our \"best\" local address to the batch of addresses we are planning",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500141353",
      "id" : 500141353,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MTM1Mw==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 619,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500141353",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142152"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since you're completely refactoring this function and both call sites, you may as well fix the signature to take a `CNode&` instead of a `CNode*`. I think you may also be able to make it a const reference.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T09:40:41Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142152",
      "id" : 500142152,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MjE1Mg==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 196,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142152",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142539"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please don't change `::ChainstateActive` to `m_chainman.ActiveChainstate` in this PR. It adds noise for reviewers.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T09:41:20Z",
      "diff_hunk" : "@@ -2476,19 +2476,12 @@ void PeerLogicValidation::ProcessMessage(CNode& pfrom, const std::string& msg_ty\n             // We skip these operations for BLOCK_RELAY peers to avoid\n             // potentially leaking information about our BLOCK_RELAY\n             // connections via the addrman or address relay.\n-            if (fListen && !::ChainstateActive().IsInitialBlockDownload())\n+            if (fListen && !m_chainman.ActiveChainstate().IsInitialBlockDownload())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142539",
      "id" : 500142539,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MjUzOQ==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 2479,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142539",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142933"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This mutex shouldn't actually be guarding `m_next_local_addr_send`. See https://github.com/bitcoin/bitcoin/pull/13123#issuecomment-647505130. You may as well remove that annotation if you're touching all the places where this variable is used.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T09:42:02Z",
      "diff_hunk" : "@@ -2476,19 +2476,12 @@ void PeerLogicValidation::ProcessMessage(CNode& pfrom, const std::string& msg_ty\n             // We skip these operations for BLOCK_RELAY peers to avoid\n             // potentially leaking information about our BLOCK_RELAY\n             // connections via the addrman or address relay.\n-            if (fListen && !::ChainstateActive().IsInitialBlockDownload())\n+            if (fListen && !m_chainman.ActiveChainstate().IsInitialBlockDownload())\n             {\n-                CAddress addr = GetLocalAddress(&pfrom.addr, pfrom.GetLocalServices());\n-                FastRandomContext insecure_rand;\n-                if (addr.IsRoutable())\n-                {\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                } else if (IsPeerAddrLocalGood(&pfrom)) {\n-                    addr.SetIP(addrMe);\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                }\n+                AdvertiseLocal(&pfrom);\n+                const auto current_time = GetTime<std::chrono::microseconds>();\n+                LOCK(pfrom.cs_sendProcessing);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142933",
      "id" : 500142933,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MjkzMw==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 2483,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142933",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500182214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500182214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think const reference is possible due to `PushAddress` call.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T10:53:19Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500182214",
      "id" : 500182214,
      "in_reply_to_id" : 500142152,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4MjIxNA==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 196,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502814691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500182214",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery thanks for the feedback, all addressed.\r\nI agree with your hesitation regarding the further commit. It probably doesn't change behavior at all, I just thought it would make it easier to understand what's going on (despite adding 2 extra lines).\r\n\r\nLet's see others' preferences, I'm fine with dropping this commit too.",
      "created_at" : "2020-10-06T11:11:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-704197957",
      "id" : 704197957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNDE5Nzk1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-06T11:11:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/704197957",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500587078"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500587078"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay, so we are giving `Peer_A` the address they gave us to forward to its peers. Now that makes more sense to me. :)",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T20:49:42Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500587078",
      "id" : 500587078,
      "in_reply_to_id" : 499747657,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU4NzA3OA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 217,
      "original_position" : 19,
      "original_start_line" : 207,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 503347443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500587078",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500589695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500589695"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You removed too much here! Since `m_next_local_addr_send` is left uninitialized, `p2p_node_network_limited.py` fails intermittently.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T20:54:41Z",
      "diff_hunk" : "@@ -966,8 +966,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500589695",
      "id" : 500589695,
      "line" : 999,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU4OTY5NQ==",
      "original_commit_id" : "e8da279a38705bf8a90108431d252aa214cc5799",
      "original_line" : 999,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 44,
      "pull_request_review_id" : 503350894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500589695",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500589908"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500589908"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In one line this is dropping only `GUARDED_BY(cs_sendProcessing)`, in the other line the `{0}` is also dropped. Is it possible that both lines should either drop or retain the `{0}`?",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T20:55:03Z",
      "diff_hunk" : "@@ -966,8 +966,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500589908",
      "id" : 500589908,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU4OTkwOA==",
      "original_commit_id" : "e8da279a38705bf8a90108431d252aa214cc5799",
      "original_line" : 970,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 503351147,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500589908",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500593775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500593775"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "How about:\r\n\r\n```\r\n// If discovery is enabled, we request that peers advertise our node to their peers. \r\n// Under some circumstances, our peers may have a more accurate perspective \r\n// on our address than our own node. Sometimes, we ask our peer to advertise \r\n// our node under the address they see us as at instead of the address that our \r\n// node thinks it has.\r\n```",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T21:02:08Z",
      "diff_hunk" : "@@ -191,37 +191,38 @@ static int GetnScore(const CService& addr)\n }\n \n // Is our peer's addrLocal potentially useful as an external IP source?\n-bool IsPeerAddrLocalGood(CNode *pnode)\n+bool IsPeerAddrLocalGood(CNode& pnode)\n {\n-    CService addrLocal = pnode->GetAddrLocal();\n-    return fDiscover && pnode->addr.IsRoutable() && addrLocal.IsRoutable() &&\n+    CService addrLocal = pnode.GetAddrLocal();\n+    return fDiscover && pnode.addr.IsRoutable() && addrLocal.IsRoutable() &&\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n-void AdvertiseLocal(CNode *pnode)\n+void AdvertiseLocal(CNode& pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n-    {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+    assert(fListen);\n+\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    // In absence of other information, we assume that the locally seen address\n+    // is the \"best\" addr for peers to refer to our node.\n+    CAddress addrLocal = GetLocalAddress(pnode.addr, pnode.GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode.GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500593775",
      "id" : 500593775,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5Mzc3NQ==",
      "original_commit_id" : "a8d262bdbd3544c93f3db0464f3b56d27833ed1b",
      "original_line" : 217,
      "original_position" : 67,
      "original_start_line" : 215,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 503351147,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500593775",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500596241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500596241"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If we hear multiple addresses for ourselves from peers, how do we determine \"best\"?",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T21:07:11Z",
      "diff_hunk" : "@@ -640,8 +640,13 @@ enum\n     LOCAL_MAX\n };\n \n-bool IsPeerAddrLocalGood(CNode *pnode);\n-void AdvertiseLocal(CNode *pnode);\n+bool IsPeerAddrLocalGood(CNode& pnode);\n+\n+/**\n+ * Add our \"best\" local address to the batch of addresses we are planning",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500596241",
      "id" : 500596241,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5NjI0MQ==",
      "original_commit_id" : "a8d262bdbd3544c93f3db0464f3b56d27833ed1b",
      "original_line" : 646,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 503351147,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500596241",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500599829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500599829"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@naumenkogs Was it on purpose that you left the original comment in while also adding the suggestion? Just checking...",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T21:14:35Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500599829",
      "id" : 500599829,
      "in_reply_to_id" : 499743996,
      "line" : 207,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5OTgyOQ==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 207,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 72,
      "pull_request_review_id" : 503363912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500599829",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500614931"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500614931"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same here as https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142539 concerning `::ChainstateActive()`?",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-06T21:46:55Z",
      "diff_hunk" : "@@ -4105,8 +4105,11 @@ bool PeerManager::SendMessages(CNode* pto)\n         int64_t nNow = GetTimeMicros();\n         auto current_time = GetTime<std::chrono::microseconds>();\n \n-        if (pto->RelayAddrsWithConn() && !::ChainstateActive().IsInitialBlockDownload() && pto->m_next_local_addr_send < current_time) {\n-            AdvertiseLocal(pto);\n+\n+        if (pto->RelayAddrsWithConn() && !m_chainman.ActiveChainstate().IsInitialBlockDownload() && fListen &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500614931",
      "id" : 500614931,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYxNDkzMQ==",
      "original_commit_id" : "a8d262bdbd3544c93f3db0464f3b56d27833ed1b",
      "original_line" : 4109,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 503363912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500614931",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500764505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500764505"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes it was. It still applies, I'm just adding a bit clarification I hope :)",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-07T06:25:10Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500764505",
      "id" : 500764505,
      "in_reply_to_id" : 499743996,
      "line" : 207,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2NDUwNQ==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 207,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 72,
      "pull_request_review_id" : 503557496,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500764505",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500767101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500767101"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sounds good, thanks!",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-07T06:31:40Z",
      "diff_hunk" : "@@ -191,37 +191,38 @@ static int GetnScore(const CService& addr)\n }\n \n // Is our peer's addrLocal potentially useful as an external IP source?\n-bool IsPeerAddrLocalGood(CNode *pnode)\n+bool IsPeerAddrLocalGood(CNode& pnode)\n {\n-    CService addrLocal = pnode->GetAddrLocal();\n-    return fDiscover && pnode->addr.IsRoutable() && addrLocal.IsRoutable() &&\n+    CService addrLocal = pnode.GetAddrLocal();\n+    return fDiscover && pnode.addr.IsRoutable() && addrLocal.IsRoutable() &&\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n-void AdvertiseLocal(CNode *pnode)\n+void AdvertiseLocal(CNode& pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n-    {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+    assert(fListen);\n+\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    // In absence of other information, we assume that the locally seen address\n+    // is the \"best\" addr for peers to refer to our node.\n+    CAddress addrLocal = GetLocalAddress(pnode.addr, pnode.GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode.GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500767101",
      "id" : 500767101,
      "in_reply_to_id" : 500593775,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2NzEwMQ==",
      "original_commit_id" : "a8d262bdbd3544c93f3db0464f3b56d27833ed1b",
      "original_line" : 217,
      "original_position" : 67,
      "original_start_line" : 215,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 503560704,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500767101",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500768077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500768077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Expanded this comment a bit to refer to `GetLocal`.\r\nEvaluating the security of `GetLocal` is on my TODO list, but for now we can assume it works I guess...",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-07T06:34:12Z",
      "diff_hunk" : "@@ -640,8 +640,13 @@ enum\n     LOCAL_MAX\n };\n \n-bool IsPeerAddrLocalGood(CNode *pnode);\n-void AdvertiseLocal(CNode *pnode);\n+bool IsPeerAddrLocalGood(CNode& pnode);\n+\n+/**\n+ * Add our \"best\" local address to the batch of addresses we are planning",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500768077",
      "id" : 500768077,
      "in_reply_to_id" : 500596241,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2ODA3Nw==",
      "original_commit_id" : "a8d262bdbd3544c93f3db0464f3b56d27833ed1b",
      "original_line" : 646,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 503561911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500768077",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r502783353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502783353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6dc9c7535daa931d7f747958d0dc6fa29417dd80 please remove trailing space to make linter happy:\r\n```suggestion\r\n    // If discovery is enabled, we request that peers advertise our node to their peers.\r\n    // Under some circumstances, our peers may have a more accurate perspective\r\n    // on our address than our own node. Sometimes, we ask our peer to advertise\r\n    // our node under the address they see us as at instead of the address that our\r\n```",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-10T12:02:57Z",
      "diff_hunk" : "@@ -191,37 +191,40 @@ static int GetnScore(const CService& addr)\n }\n \n // Is our peer's addrLocal potentially useful as an external IP source?\n-bool IsPeerAddrLocalGood(CNode *pnode)\n+bool IsPeerAddrLocalGood(CNode& pnode)\n {\n-    CService addrLocal = pnode->GetAddrLocal();\n-    return fDiscover && pnode->addr.IsRoutable() && addrLocal.IsRoutable() &&\n+    CService addrLocal = pnode.GetAddrLocal();\n+    return fDiscover && pnode.addr.IsRoutable() && addrLocal.IsRoutable() &&\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n-void AdvertiseLocal(CNode *pnode)\n+void AdvertiseLocal(CNode& pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n-    {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+    assert(fListen);\n+\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    // In absence of other information, we assume that the locally seen address\n+    // is the \"best\" addr for peers to refer to our node.\n+    CAddress addrLocal = GetLocalAddress(pnode.addr, pnode.GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode.GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, we request that peers advertise our node to their peers. \n+    // Under some circumstances, our peers may have a more accurate perspective \n+    // on our address than our own node. Sometimes, we ask our peer to advertise \n+    // our node under the address they see us as at instead of the address that our ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r502783353",
      "id" : 502783353,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc4MzM1Mw==",
      "original_commit_id" : "6dc9c7535daa931d7f747958d0dc6fa29417dd80",
      "original_line" : 218,
      "original_position" : 68,
      "original_start_line" : 215,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 506092449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502783353",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r503296373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/503296373"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is wrong. `CService` shouldn't be const, and making it const here makes this declaration different from the definition in the cpp file.\r\n\r\nIn fact, this declaration could just be removed entirely from this header file since the function isn't used outside the translation unit. You could also make it static in the cpp file to remove external linkage.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-12T13:29:04Z",
      "diff_hunk" : "@@ -658,8 +664,8 @@ bool AddLocal(const CNetAddr& addr, int nScore = LOCAL_NONE);\n void RemoveLocal(const CService& addr);\n bool SeenLocal(const CService& addr);\n bool IsLocal(const CService& addr);\n-bool GetLocal(CService &addr, const CNetAddr *paddrPeer = nullptr);\n-CAddress GetLocalAddress(const CNetAddr *paddrPeer, ServiceFlags nLocalServices);\n+bool GetLocal(const CService &addr, const CNetAddr *paddrPeer = nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r503296373",
      "id" : 503296373,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5NjM3Mw==",
      "original_commit_id" : "fa16765e4c5b95e495e6e7855e6cd281163e32e8",
      "original_line" : 667,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 506619628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/503296373",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r503296982"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/503296982"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggest removing this. The fact that addresses added to `vAddrToSend` are not guaranteed to be sent is not a property of `AdvertiseLocal`, so the comment shouldn't be here.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-12T13:30:04Z",
      "diff_hunk" : "@@ -640,8 +640,14 @@ enum\n     LOCAL_MAX\n };\n \n-bool IsPeerAddrLocalGood(CNode *pnode);\n-void AdvertiseLocal(CNode *pnode);\n+bool IsPeerAddrLocalGood(CNode& pnode);\n+\n+/**\n+ * Add our \"best\" local address (see GetLocal) to the batch of addresses\n+ * we are planning to relay to a given node as scheduled.\n+ * The relay is not guaranteed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r503296982",
      "id" : 503296982,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5Njk4Mg==",
      "original_commit_id" : "fa16765e4c5b95e495e6e7855e6cd281163e32e8",
      "original_line" : 648,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 506619628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/503296982",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r503304343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/503304343"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It might actually be better to turn these into atomics now that they're being accessed in both SendMessages and ProcessMessages. We know that those functions always run single threaded, but if someone exposes these values through an RPC then there' the potential of a data race.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-12T13:41:38Z",
      "diff_hunk" : "@@ -966,8 +972,8 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};\n     bool fGetAddr{false};\n-    std::chrono::microseconds m_next_addr_send GUARDED_BY(cs_sendProcessing){0};\n-    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(cs_sendProcessing){0};\n+    std::chrono::microseconds m_next_addr_send{0};\n+    std::chrono::microseconds m_next_local_addr_send{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r503304343",
      "id" : 503304343,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMwNDM0Mw==",
      "original_commit_id" : "fa16765e4c5b95e495e6e7855e6cd281163e32e8",
      "original_line" : 976,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 506629994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/503304343",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The only behavior change is that the following will be also applied to the first (pre-VERACK) self-announcement:\r\n\r\n> // If discovery is enabled, sometimes give our peer the address it\r\n// tells us that it sees us as in case it has a better idea of our\r\n// address than we do.\r\n\r\n> And I think it's a good change anyway.\r\n\r\nI've been trying to work out whether that really is a good change. When is it better that the first (and potentially only) address that we advertise to the peer is our own view of our best address and when is it better that we advertise the address that they told us?\r\n\r\nI think we can make the logic much simpler by always calling `PushAddress()` with _both_ addresses (as long as we think they're routable). The `vAddrToSend` buffer means we're not sending individual messages for each address, and the `m_addr_known` filter means we won't send the same address multiple times. I can't see any downside to doing this.",
      "created_at" : "2020-10-13T11:35:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-707679704",
      "id" : 707679704,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNzY3OTcwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-13T11:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/707679704",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The _Refactor AdvertiseLocal_ commit is a bit of a jumble - it's changing function signatures, removing declarations, moving comments around, changing where variables are checked from functions to their callers and more. I'm sorry, that might have been because I've asked you to do too much in this PR. I'd suggest either removing some of those tidy-ups, or split the commit out, so it's obvious for reviewers what the point of each change is. I've done that here: https://github.com/jnewbery/bitcoin/tree/pr19843.1 . Feel free to take that branch if you think it's an improvement.",
      "created_at" : "2020-10-13T11:38:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-707681181",
      "id" : 707681181,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNzY4MTE4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-13T11:38:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/707681181",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r505808735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505808735"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A question I had during last week's review club meeting:\r\nSince this PR unifies the two spots from which self-advertisements are sent (`ProcessMessage` -> VERSION only to outbound peers, and `SendMessages` also to inbound peers) - Does this call during VERSION processing still have a point? \r\nIf we simply removed it, wouldn't we self-advertise a few moment later anyway after we are successfully connected (because `m_next_local_addr_send` is initialized to 0 in the `SendMessages()` loop)?",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-10-15T20:08:40Z",
      "diff_hunk" : "@@ -2489,19 +2489,10 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // We skip these operations for BLOCK_RELAY peers to avoid\n             // potentially leaking information about our BLOCK_RELAY\n             // connections via the addrman or address relay.\n-            if (fListen && !::ChainstateActive().IsInitialBlockDownload())\n-            {\n-                CAddress addr = GetLocalAddress(&pfrom.addr, pfrom.GetLocalServices());\n-                FastRandomContext insecure_rand;\n-                if (addr.IsRoutable())\n-                {\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                } else if (IsPeerAddrLocalGood(&pfrom)) {\n-                    addr.SetIP(addrMe);\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                }\n+            if (fListen && !::ChainstateActive().IsInitialBlockDownload()) {\n+                AdvertiseLocal(pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r505808735",
      "id" : 505808735,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTgwODczNQ==",
      "original_commit_id" : "699d5ed3127322bea263b83150d9626515b67d0c",
      "original_line" : 2419,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 509751625,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505808735",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-11-03T03:13:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-720881211",
      "id" : 720881211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMDg4MTIxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-03T03:13:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/720881211",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r537899813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537899813"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"\"Refactor AdvertiseLocal\".\r\n\r\nThe addition of `pto->fSuccessfullyConnected` here is unnecessary; `SendMessages()` returns early if that isn't the case (see line 4064 in commit 2a0e47909fab5c831031e35e871626b463dfee1c).",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-12-07T23:03:59Z",
      "diff_hunk" : "@@ -4105,8 +4105,11 @@ bool PeerManager::SendMessages(CNode* pto)\n         int64_t nNow = GetTimeMicros();\n         auto current_time = GetTime<std::chrono::microseconds>();\n \n-        if (pto->RelayAddrsWithConn() && !::ChainstateActive().IsInitialBlockDownload() && pto->m_next_local_addr_send.load() < current_time) {\n-            AdvertiseLocal(pto);\n+\n+        if (pto->RelayAddrsWithConn() && !::ChainstateActive().IsInitialBlockDownload() && fListen &&\n+            pto->fSuccessfullyConnected && pto->m_next_local_addr_send.load() < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r537899813",
      "id" : 537899813,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5OTgxMw==",
      "original_commit_id" : "2a0e47909fab5c831031e35e871626b463dfee1c",
      "original_line" : 4110,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 546611797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537899813",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r537900878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537900878"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Refactor AdvertiseLocal \":\r\n\r\n\r\nThe `pnode->fSuccessfullyConnected` condition is dropped here. It's pointless as all AdvertiseLocal call sites guarantee that condition is satisfied anyway, but perhaps add it as an assert?",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-12-07T23:06:14Z",
      "diff_hunk" : "@@ -191,37 +191,40 @@ static int GetnScore(const CService& addr)\n }\n \n // Is our peer's addrLocal potentially useful as an external IP source?\n-bool IsPeerAddrLocalGood(CNode *pnode)\n+bool IsPeerAddrLocalGood(CNode& pnode)\n {\n-    CService addrLocal = pnode->GetAddrLocal();\n-    return fDiscover && pnode->addr.IsRoutable() && addrLocal.IsRoutable() &&\n+    CService addrLocal = pnode.GetAddrLocal();\n+    return fDiscover && pnode.addr.IsRoutable() && addrLocal.IsRoutable() &&\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n-void AdvertiseLocal(CNode *pnode)\n+void AdvertiseLocal(CNode& pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n-    {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+    assert(fListen);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r537900878",
      "id" : 537900878,
      "line" : 204,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMDg3OA==",
      "original_commit_id" : "2a0e47909fab5c831031e35e871626b463dfee1c",
      "original_line" : 204,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 546611797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537900878",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r537930294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537930294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Unify self-announcement behavior\".\r\n\r\nThere is no perfect overlap between the two mechanisms that trigger announcing. This one only sends to outbound connections, but does so even during IBD. The other periodic one also sends to inbound connections, but not during IBD.\r\n\r\nI don't know if there is a point to keeping this one.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-12-08T00:07:31Z",
      "diff_hunk" : "@@ -2489,19 +2489,10 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // We skip these operations for BLOCK_RELAY peers to avoid\n             // potentially leaking information about our BLOCK_RELAY\n             // connections via the addrman or address relay.\n-            if (fListen && !::ChainstateActive().IsInitialBlockDownload())\n-            {\n-                CAddress addr = GetLocalAddress(&pfrom.addr, pfrom.GetLocalServices());\n-                FastRandomContext insecure_rand;\n-                if (addr.IsRoutable())\n-                {\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                } else if (IsPeerAddrLocalGood(&pfrom)) {\n-                    addr.SetIP(addrMe);\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                }\n+            if (fListen && !::ChainstateActive().IsInitialBlockDownload()) {\n+                AdvertiseLocal(pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r537930294",
      "id" : 537930294,
      "in_reply_to_id" : 505808735,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkzMDI5NA==",
      "original_commit_id" : "699d5ed3127322bea263b83150d9626515b67d0c",
      "original_line" : 2419,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 546611797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537930294",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r539161730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539161730"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, I also don't have a good answer here.\r\nAs Pieter notices, it's not *that* pointless, because of the send-during-IBD property. Now, whether that's something we want is an open question and requires understanding the expectations from addr relay as a whole.\r\nI think this could be discussed/implemented separately in another PR.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-12-09T09:50:49Z",
      "diff_hunk" : "@@ -2489,19 +2489,10 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // We skip these operations for BLOCK_RELAY peers to avoid\n             // potentially leaking information about our BLOCK_RELAY\n             // connections via the addrman or address relay.\n-            if (fListen && !::ChainstateActive().IsInitialBlockDownload())\n-            {\n-                CAddress addr = GetLocalAddress(&pfrom.addr, pfrom.GetLocalServices());\n-                FastRandomContext insecure_rand;\n-                if (addr.IsRoutable())\n-                {\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                } else if (IsPeerAddrLocalGood(&pfrom)) {\n-                    addr.SetIP(addrMe);\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                }\n+            if (fListen && !::ChainstateActive().IsInitialBlockDownload()) {\n+                AdvertiseLocal(pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r539161730",
      "id" : 539161730,
      "in_reply_to_id" : 505808735,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2MTczMA==",
      "original_commit_id" : "699d5ed3127322bea263b83150d9626515b67d0c",
      "original_line" : 2419,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 548009392,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539161730",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Took @jnewbery's branch and added suggestions from @sipa.\r\n\r\n>I think we can make the logic much simpler by always calling PushAddress() with both addresses (as long as we think they're routable).\r\n\r\nYeah, good point. Not only it makes the code simpler, but also makes addr relay better without negative side-effects (I think from the first grasp).\r\nI think it deserves a separate PR though.",
      "created_at" : "2020-12-09T11:28:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-741712168",
      "id" : 741712168,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTcxMjE2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-09T11:28:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741712168",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r539253278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539253278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As Travis caught, it doesn't work :)\r\n\r\nWe set it on receiving VERACK, but AdvertiseLocal is called on receiving VERSION, which might happen in either order...\r\nI assume AdvertiseLocal never worked properly in the first place? Like, it did work in half of the cases on a new connection :)\r\n\r\nI suggest we do AdvertiseLocal on VERSION no matter whether we received VERACK or not.\r\n",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-12-09T12:09:16Z",
      "diff_hunk" : "@@ -191,37 +191,40 @@ static int GetnScore(const CService& addr)\n }\n \n // Is our peer's addrLocal potentially useful as an external IP source?\n-bool IsPeerAddrLocalGood(CNode *pnode)\n+bool IsPeerAddrLocalGood(CNode& pnode)\n {\n-    CService addrLocal = pnode->GetAddrLocal();\n-    return fDiscover && pnode->addr.IsRoutable() && addrLocal.IsRoutable() &&\n+    CService addrLocal = pnode.GetAddrLocal();\n+    return fDiscover && pnode.addr.IsRoutable() && addrLocal.IsRoutable() &&\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n-void AdvertiseLocal(CNode *pnode)\n+void AdvertiseLocal(CNode& pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n-    {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+    assert(fListen);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r539253278",
      "id" : 539253278,
      "in_reply_to_id" : 537900878,
      "line" : 204,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI1MzI3OA==",
      "original_commit_id" : "2a0e47909fab5c831031e35e871626b463dfee1c",
      "original_line" : 204,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 548118390,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539253278",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r539260044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539260044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or even better, this should be just done on VERACK.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-12-09T12:19:57Z",
      "diff_hunk" : "@@ -191,37 +191,40 @@ static int GetnScore(const CService& addr)\n }\n \n // Is our peer's addrLocal potentially useful as an external IP source?\n-bool IsPeerAddrLocalGood(CNode *pnode)\n+bool IsPeerAddrLocalGood(CNode& pnode)\n {\n-    CService addrLocal = pnode->GetAddrLocal();\n-    return fDiscover && pnode->addr.IsRoutable() && addrLocal.IsRoutable() &&\n+    CService addrLocal = pnode.GetAddrLocal();\n+    return fDiscover && pnode.addr.IsRoutable() && addrLocal.IsRoutable() &&\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n-void AdvertiseLocal(CNode *pnode)\n+void AdvertiseLocal(CNode& pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n-    {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+    assert(fListen);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r539260044",
      "id" : 539260044,
      "in_reply_to_id" : 537900878,
      "line" : 204,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI2MDA0NA==",
      "original_commit_id" : "2a0e47909fab5c831031e35e871626b463dfee1c",
      "original_line" : 204,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 548126660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/539260044",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "~~As I noticed [here](https://github.com/bitcoin/bitcoin/pull/19843#discussion_r539253278), the current code had some ambiguity. We send initial AdvertiseLocal only if we receive VERSION before VERACK from the peer (see `fSuccessfullyConnected`).~~\r\n\r\n~~I see two alternatives to fix this:~~\r\nIt's unclear when we should really do AdvertiseLocal for the first time:\r\n1. Do AdvertiseLocal on VERSION. There is a chance of the peer dropping us (due to undesirable VERSION content) before they get this ADDR message from us, so this may be wasteful.\r\n2. Do AdvertiseLocal on VERACK. If we do this, we would never ask a peer who rejects our VERSION (and not send VERACK) to announce our addr forward.\r\n\r\nThat's it, this is the trade-off I think.\r\n\r\nNote that this matters only for outbound-non-IBD case (see [discussion](https://github.com/bitcoin/bitcoin/pull/19843#discussion_r537930294)).\r\nOtherwise, another AdvertiseLocal is called anyway (before sending out local addr).\r\n\r\nAlso note that this has nothing to do with feelers, because we disconnect them earlier than sending addrs out to them.\r\n\r\nSo, see the commit \"[net] Call AdvertiseLocal on VERACK\" where I implement (2).",
      "created_at" : "2020-12-09T12:40:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-741745405",
      "id" : 741745405,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTc0NTQwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-10T13:17:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741745405",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "No clue why fuzzing fails. cc @MarcoFalke ",
      "created_at" : "2020-12-09T14:50:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-741821043",
      "id" : 741821043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTgyMTA0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-09T14:50:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741821043",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nfatal: unable to access 'https://github.com/bitcoin-core/qa-assets/': Failed to connect to github.com port 443: Connection timed out",
      "created_at" : "2020-12-09T15:04:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-741829812",
      "id" : 741829812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTgyOTgxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-09T15:04:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741829812",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-09T17:31:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-741925446",
      "id" : 741925446,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTkyNTQ0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-09T17:31:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741925446",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r540057740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540057740"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> We set it on receiving VERACK, but AdvertiseLocal is called on receiving VERSION, which might happen in either order\r\n\r\nThis isn't true. We must receive the version message before the verack message.\r\n\r\nI agree that it's better to do the initial `PushAddress()` on receiving the verack.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-12-10T10:35:08Z",
      "diff_hunk" : "@@ -191,37 +191,40 @@ static int GetnScore(const CService& addr)\n }\n \n // Is our peer's addrLocal potentially useful as an external IP source?\n-bool IsPeerAddrLocalGood(CNode *pnode)\n+bool IsPeerAddrLocalGood(CNode& pnode)\n {\n-    CService addrLocal = pnode->GetAddrLocal();\n-    return fDiscover && pnode->addr.IsRoutable() && addrLocal.IsRoutable() &&\n+    CService addrLocal = pnode.GetAddrLocal();\n+    return fDiscover && pnode.addr.IsRoutable() && addrLocal.IsRoutable() &&\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n-void AdvertiseLocal(CNode *pnode)\n+void AdvertiseLocal(CNode& pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n-    {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+    assert(fListen);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r540057740",
      "id" : 540057740,
      "in_reply_to_id" : 537900878,
      "line" : 204,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA1Nzc0MA==",
      "original_commit_id" : "2a0e47909fab5c831031e35e871626b463dfee1c",
      "original_line" : 204,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 549061473,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540057740",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r540140576"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540140576"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">This isn't true. We must receive the version message before the verack message.\r\n\r\nYou're right, thanks. I was confused in my own code stack of commits I guess. This part was just fine before my changes.\r\nLet me just update my commit messages now.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-12-10T12:46:28Z",
      "diff_hunk" : "@@ -191,37 +191,40 @@ static int GetnScore(const CService& addr)\n }\n \n // Is our peer's addrLocal potentially useful as an external IP source?\n-bool IsPeerAddrLocalGood(CNode *pnode)\n+bool IsPeerAddrLocalGood(CNode& pnode)\n {\n-    CService addrLocal = pnode->GetAddrLocal();\n-    return fDiscover && pnode->addr.IsRoutable() && addrLocal.IsRoutable() &&\n+    CService addrLocal = pnode.GetAddrLocal();\n+    return fDiscover && pnode.addr.IsRoutable() && addrLocal.IsRoutable() &&\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n-void AdvertiseLocal(CNode *pnode)\n+void AdvertiseLocal(CNode& pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n-    {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+    assert(fListen);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r540140576",
      "id" : 540140576,
      "in_reply_to_id" : 537900878,
      "line" : 204,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE0MDU3Ng==",
      "original_commit_id" : "2a0e47909fab5c831031e35e871626b463dfee1c",
      "original_line" : 204,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 549160390,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540140576",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r540166735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540166735"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually, both of them are non-IBD? Both are inside the `!::ChainstateActive().IsInitialBlockDownload()` check?\r\nSo really, the periodic one should encompass the initial one.\r\n\r\nThe only reason to keep the initial one is if it somehow worked when the other one is not reached. But it's not true in practice, because the periodic happens *right before* actually sending ADDR message out.\r\n\r\nI think the initial one should be dropped.",
      "commit_id" : "c1bc31d7ec67cafbb33fedcf28cc8374ad34d6f3",
      "created_at" : "2020-12-10T13:26:40Z",
      "diff_hunk" : "@@ -2489,19 +2489,10 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // We skip these operations for BLOCK_RELAY peers to avoid\n             // potentially leaking information about our BLOCK_RELAY\n             // connections via the addrman or address relay.\n-            if (fListen && !::ChainstateActive().IsInitialBlockDownload())\n-            {\n-                CAddress addr = GetLocalAddress(&pfrom.addr, pfrom.GetLocalServices());\n-                FastRandomContext insecure_rand;\n-                if (addr.IsRoutable())\n-                {\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                } else if (IsPeerAddrLocalGood(&pfrom)) {\n-                    addr.SetIP(addrMe);\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                }\n+            if (fListen && !::ChainstateActive().IsInitialBlockDownload()) {\n+                AdvertiseLocal(pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r540166735",
      "id" : 540166735,
      "in_reply_to_id" : 505808735,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE2NjczNQ==",
      "original_commit_id" : "699d5ed3127322bea263b83150d9626515b67d0c",
      "original_line" : 2419,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549192546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-10T13:26:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540166735",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Okay, so a bunch of new stuff.\r\n\r\n1. I do think AdvertiseLocal encompasses PushAddress(self) on VERSION: both of them are non-IBD, and sending out ADDRs happens *after* both of them, so dropping the VERSION-one should have no impact. I do it in \"[net] Don't PushAddress(self) on VERSION\".\r\n2. Well, the only another difference is that there's a probability that VERSION-one will push how-we-see-us while *at the same time* AdvertiseLocal will push how-they-see-us (due to the randomization). And then we end up advertising both within the first ADDR message. So, to preserve the behavior, in AdvertiseLocal I *always* use both how-they-see-us and how-we-see-us (as suggested by John earlier).\r\n\r\nThe only problem I can think of is that how-they-see-us and how-we-see-us is gonna flow across the network in a batch. This kinda was happening before already with some probability, but still, I'm wondering if this is a privacy leak or not?\r\n\r\nOtherwise, we can also switch to *always choose one of two* with some chance, as we did before, or even *maybe do both but with some probability*.\r\n\r\nInterested in your opinion w.r.t privacy leak @jnewbery @sipa @sdaftuar @mzumsande \r\n\r\n(PR post is slightly outdated now, will update it once I'm sure we're on the same page here)",
      "created_at" : "2020-12-10T20:41:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-742786041",
      "id" : 742786041,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0Mjc4NjA0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-10T20:53:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742786041",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-17T13:08:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-747428828",
      "id" : 747428828,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzQyODgyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-17T13:08:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747428828",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-07T15:06:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-756172520",
      "id" : 756172520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NjE3MjUyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-07T15:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/756172520",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Much changed since I opened this PR. Pretty sure dropping a redundant self-announcement from `ProcessMessage` still makes sense, but perhaps we should revisit that after #21186 lands.",
      "created_at" : "2021-04-16T09:28:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-821047626",
      "id" : 821047626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMTA0NzYyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-16T09:28:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821047626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Pretty sure dropping a redundant self-announcement from ProcessMessage still makes sense, but perhaps we should revisit that after #21186 lands.\r\n\r\n@naumenkogs - do you plan on picking this up now that #21186 is merged? Should we mark this PR up for grabs?",
      "created_at" : "2021-07-23T10:37:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-885551229",
      "id" : 885551229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "IC_kwDOABII5840yHB9",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-23T10:37:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/885551229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery Yeah I'd be happy to let someone else lead this. Let's mark it up for grabs.",
      "created_at" : "2021-07-23T11:03:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-885562927",
      "id" : 885562927,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "IC_kwDOABII5840yJ4v",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-23T11:03:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/885562927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dergoegge @mzumsande either of you might be interested in following up with the final commit, 99f67685a223148693c400292ef8fec9de8d01d3, if it's still relevant?",
      "created_at" : "2022-08-05T15:39:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-1206593625",
      "id" : 1206593625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "IC_kwDOABII585H6yhZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1206593625/reactions"
      },
      "updated_at" : "2022-08-05T15:39:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1206593625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @dergoegge @mzumsande either of you might be interested in following up with the final commit, [99f6768](https://github.com/bitcoin/bitcoin/commit/99f67685a223148693c400292ef8fec9de8d01d3), if it's still relevant?\r\n\r\nOnly saw this now, because I was looking at the self-advertising logic, and I think it's still relevant, so I'm planing on following up.\r\n\r\nAnother problem with the self-advertising within Version message processing is that it doesn't work well with addrv2:\r\nIf the local address we want to advertise is an outbound peer is an `.onion` address, then we don't actually advertise it (`IsAddrCompatible()` returns `false`) because we haven't received a `sendaddrv2` yet at this point. So that is another reason why it makes sense to wait with the advertising until feature negotiation is finished.\r\n",
      "created_at" : "2022-09-27T15:18:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-1259661608",
      "id" : 1259661608,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "IC_kwDOABII585LFOko",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1259661608/reactions"
      },
      "updated_at" : "2022-09-27T15:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1259661608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
