[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20724 (Cleanup of -debug=net log messages by ajtowns)\n* #20158 (tree-wide: De-globalize ChainstateManager by dongcarl)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-08-28T21:21:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-683152078",
      "id" : 683152078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzE1MjA3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-20T02:14:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683152078",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479586353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479586353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"Discovered at version message exchange. Used at tip update, to decide if our chain is fresh enough compared to peer's one to be worthy of headers announcement.\" ?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-08-29T00:49:49Z",
      "diff_hunk" : "@@ -488,6 +488,9 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Starting height of this peer */\n+    std::atomic<int> nStartingHeight{-1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479586353",
      "id" : 479586353,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NjM1Mw==",
      "original_commit_id" : "cc2c15fd73979e60e63526cc071c1fd025c3a7e3",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 478083375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479586353",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479588290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479588290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What's the distinction you loose by dropping `unfiltered blocks to relay` ?\r\n\r\nI guess this is a reference to sort done at headers announcement, L4218 src/net_processing.cpp:\r\nhttps://github.com/bitcoin/bitcoin/blob/1cf73fb8eba3b89a30d5e943deaec5052a8b21b7/src/net_processing.cpp#L4218\r\n\r\nBefore to announce headers, we check both with regards to peer's context (\"Does this header connect to known peer's tip ?\") and our context (\"Does this header is part of best chain ?\"). It wasn't a clear comment, so yes either drop it or extend ?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-08-29T01:06:25Z",
      "diff_hunk" : "@@ -928,9 +922,6 @@ class CNode\n     // m_tx_relay == nullptr if we're not relaying transactions with this peer\n     std::unique_ptr<TxRelay> m_tx_relay;\n \n-    // Used for headers announcements - unfiltered blocks to relay",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479588290",
      "id" : 479588290,
      "line" : 1046,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4ODI5MA==",
      "original_commit_id" : "3ee51652e93fc41c750713070200f98014d64bf3",
      "original_line" : 1046,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 35,
      "pull_request_review_id" : 478083375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479588290",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479590868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479590868"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`vBlockHashesToAnnounce` is a list of block hashes not headers ? With regards to renaming follow-up commit, I would lean towards the most verbose option `m_blockids_for_inv_relay/m_blockids_for_headers_relay` to denotate that these vectors contain an identifier even if the endgoal is to relay the identifiee (either block or headers).",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-08-29T01:30:53Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479590868",
      "id" : 479590868,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5MDg2OA==",
      "original_commit_id" : "3ee51652e93fc41c750713070200f98014d64bf3",
      "original_line" : 455,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 478083375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479590868",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479628361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479628361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment doesn't need to document _everything_ that the variable is used for. That's what the code does.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-08-29T09:02:28Z",
      "diff_hunk" : "@@ -488,6 +488,9 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Starting height of this peer */\n+    std::atomic<int> nStartingHeight{-1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479628361",
      "id" : 479628361,
      "in_reply_to_id" : 479586353,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYyODM2MQ==",
      "original_commit_id" : "cc2c15fd73979e60e63526cc071c1fd025c3a7e3",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 478112685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479628361",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479629760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479629760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, I'll update the comment to \"List of block ids to announce headers for\".\r\n\r\n> I would lean towards the most verbose option m_blockids_for_inv_relay/m_blockids_for_headers_relay\r\n\r\nSure. I'll update.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-08-29T09:19:00Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479629760",
      "id" : 479629760,
      "in_reply_to_id" : 479590868,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYyOTc2MA==",
      "original_commit_id" : "3ee51652e93fc41c750713070200f98014d64bf3",
      "original_line" : 455,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 478113517,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479629760",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479629856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479629856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think drop it.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-08-29T09:20:07Z",
      "diff_hunk" : "@@ -928,9 +922,6 @@ class CNode\n     // m_tx_relay == nullptr if we're not relaying transactions with this peer\n     std::unique_ptr<TxRelay> m_tx_relay;\n \n-    // Used for headers announcements - unfiltered blocks to relay",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479629856",
      "id" : 479629856,
      "in_reply_to_id" : 479588290,
      "line" : 1046,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYyOTg1Ng==",
      "original_commit_id" : "3ee51652e93fc41c750713070200f98014d64bf3",
      "original_line" : 1046,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 35,
      "pull_request_review_id" : 478113570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479629856",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @ariard . I've addressed your comments.",
      "created_at" : "2020-08-29T09:27:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-683264367",
      "id" : 683264367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzI2NDM2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-29T09:27:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683264367",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-02T14:27:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-685773362",
      "id" : 685773362,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTc3MzM2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T14:27:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685773362",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-09-02T15:26:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-685811311",
      "id" : 685811311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTgxMTMxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T15:26:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685811311",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-09-02T15:34:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-685817072",
      "id" : 685817072,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTgxNzA3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T15:34:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685817072",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-03T13:20:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-686485715",
      "id" : 686485715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NjQ4NTcxNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-03T13:20:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686485715",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-09-03T15:56:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-686588115",
      "id" : 686588115,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NjU4ODExNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-03T15:56:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686588115",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-05T07:06:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-687563790",
      "id" : 687563790,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NzU2Mzc5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-05T07:06:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/687563790",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483928636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483928636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45\r\nCould using of `RecursiveMutex` type be avoided?\r\n(as there was `Mutex cs_inventory;`)",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-05T08:46:00Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483928636",
      "id" : 483928636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkyODYzNg==",
      "original_commit_id" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483041519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483928636",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483929087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483929087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27\r\nIt is good for concurrency to limit the lock scope. But is it safe to call `func` on potentially stale `peer_copies`?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-05T08:51:13Z",
      "diff_hunk" : "@@ -505,6 +505,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)\n+{\n+    std::vector<PeerRef> peer_copies;\n+    {\n+        LOCK(g_peer_mutex);\n+        peer_copies.reserve(g_peer_map.size());\n+        for (auto peer : g_peer_map) {\n+            peer_copies.push_back(peer.second);\n+        }\n+    }\n+\n+    for (auto&& peer : peer_copies) {\n+        func(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483929087",
      "id" : 483929087,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkyOTA4Nw==",
      "original_commit_id" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27",
      "original_line" : 502,
      "original_position" : 18,
      "original_start_line" : 512,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483041519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483929087",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch! `cs_inventory` was a RecursiveMutex when I opened this PR, and I missed the change when I rebased. Fixed.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-05T09:41:20Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933383",
      "id" : 483933383,
      "in_reply_to_id" : 483928636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMzM4Mw==",
      "original_commit_id" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483044394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933383",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933457"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. `peer_copies` holds shared_ptr references, so the objects pointed to can't be destructed while it's in scope.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-05T09:42:16Z",
      "diff_hunk" : "@@ -505,6 +505,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)\n+{\n+    std::vector<PeerRef> peer_copies;\n+    {\n+        LOCK(g_peer_mutex);\n+        peer_copies.reserve(g_peer_map.size());\n+        for (auto peer : g_peer_map) {\n+            peer_copies.push_back(peer.second);\n+        }\n+    }\n+\n+    for (auto&& peer : peer_copies) {\n+        func(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933457",
      "id" : 483933457,
      "in_reply_to_id" : 483929087,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMzQ1Nw==",
      "original_commit_id" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27",
      "original_line" : 502,
      "original_position" : 18,
      "original_start_line" : 512,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483044446,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933457",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @hebasto . I've addressed both of your comments.",
      "created_at" : "2020-09-05T09:42:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-687580549",
      "id" : 687580549,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NzU4MDU0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-05T09:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/687580549",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#19347 is yours, btw :)",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-05T09:48:56Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933970",
      "id" : 483933970,
      "in_reply_to_id" : 483928636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMzk3MA==",
      "original_commit_id" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483044795,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933970",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483934204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483934204"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I mean not language safety rather client behavior safety: if another thread removes a `peer` from the `g_peer_map`, can we rely on result of `func(peer)`?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-05T09:51:52Z",
      "diff_hunk" : "@@ -505,6 +505,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)\n+{\n+    std::vector<PeerRef> peer_copies;\n+    {\n+        LOCK(g_peer_mutex);\n+        peer_copies.reserve(g_peer_map.size());\n+        for (auto peer : g_peer_map) {\n+            peer_copies.push_back(peer.second);\n+        }\n+    }\n+\n+    for (auto&& peer : peer_copies) {\n+        func(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483934204",
      "id" : 483934204,
      "in_reply_to_id" : 483929087,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzNDIwNA==",
      "original_commit_id" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27",
      "original_line" : 502,
      "original_position" : 18,
      "original_start_line" : 512,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483044925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483934204",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483935273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483935273"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, because peer still exists in that case.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-05T10:05:20Z",
      "diff_hunk" : "@@ -505,6 +505,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)\n+{\n+    std::vector<PeerRef> peer_copies;\n+    {\n+        LOCK(g_peer_mutex);\n+        peer_copies.reserve(g_peer_map.size());\n+        for (auto peer : g_peer_map) {\n+            peer_copies.push_back(peer.second);\n+        }\n+    }\n+\n+    for (auto&& peer : peer_copies) {\n+        func(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483935273",
      "id" : 483935273,
      "in_reply_to_id" : 483929087,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzNTI3Mw==",
      "original_commit_id" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27",
      "original_line" : 502,
      "original_position" : 18,
      "original_start_line" : 512,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483045575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483935273",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483935288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483935288"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":flushed: ",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-05T10:05:39Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483935288",
      "id" : 483935288,
      "in_reply_to_id" : 483928636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzNTI4OA==",
      "original_commit_id" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483045586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483935288",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-07T17:39:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-688451759",
      "id" : 688451759,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ1MTc1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T17:39:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688451759",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-09-07T18:51:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-688473718",
      "id" : 688473718,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ3MzcxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T18:51:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688473718",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-08T20:45:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-689126592",
      "id" : 689126592,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTEyNjU5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T20:45:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689126592",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-09-08T21:44:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-689152626",
      "id" : 689152626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTE1MjYyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T21:44:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689152626",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-26T17:21:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-699523574",
      "id" : 699523574,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5OTUyMzU3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-26T17:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/699523574",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-09-28T09:50:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-699903877",
      "id" : 699903877,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5OTkwMzg3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-28T09:50:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/699903877",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r495931907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495931907"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 8d3a068 I suppose this is placed at the top of the function, instead of where it is used 150 lines below, as you plan to add more uses of it to this function.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T13:18:52Z",
      "diff_hunk" : "@@ -1542,6 +1582,7 @@ static void RelayAddress(const CAddress& addr, bool fReachable, const CConnman&\n \n void static ProcessGetBlockData(CNode& pfrom, const CChainParams& chainparams, const CInv& inv, CConnman& connman)\n {\n+    PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r495931907",
      "id" : 495931907,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkzMTkwNw==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1530,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495931907",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r495978760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495978760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit 85e7deb, perhaps go a bit further in the added comment to clarify that the refcount is often > 1 here.\r\n\r\nIn my testing, adding `assert(peer.use_count() <= 1);` after this line as suggested in https://github.com/bitcoin/bitcoin/pull/19607#discussion_r470173964 causes bitcoind on mainnet to halt nearly immediately after net processing begins and 1-2 peers start to connect.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T14:23:45Z",
      "diff_hunk" : "@@ -913,6 +948,10 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LOCK(cs_main);\n     int misbehavior{0};\n     {\n+        // We remove the Peer object from g_peer_map here, but it's not guaranteed that\n+        // we'll destruct Peer here since another thread could potentially still hold\n+        // a reference to the object. Be careful not to do any processing here that\n+        // assumes Peer won't be changed before it's destructed.\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r495978760",
      "id" : 495978760,
      "line" : 800,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3ODc2MA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 800,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 10,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495978760",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496054882"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496054882"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cff5d286 What are your plans with respect to this function `ForEachPeer()` in your roadmap...end game interface, or more of an intermediary step?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T15:49:03Z",
      "diff_hunk" : "@@ -502,6 +519,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496054882",
      "id" : 496054882,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1NDg4Mg==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 490,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496054882",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496056128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496056128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9b14eb372 verified manually that this displays as before, as there is no GUI test coverage. Unfortunately, it is broken at this commit and returns only the initial value of `-1` until 3 commits later at f27a1e221d.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T15:50:47Z",
      "diff_hunk" : "@@ -1148,6 +1147,8 @@ void RPCConsole::updateNodeDetail(const CNodeCombinedStats *stats)\n             ui->peerCommonHeight->setText(QString(\"%1\").arg(stats->nodeStateStats.nCommonHeight));\n         else\n             ui->peerCommonHeight->setText(tr(\"Unknown\"));\n+\n+        ui->peerHeight->setText(QString::number(stats->nodeStateStats.m_starting_height));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496056128",
      "id" : 496056128,
      "line" : 1138,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1NjEyOA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1138,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/qt/rpcconsole.cpp",
      "position" : 13,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496056128",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496058069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496058069"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9b14eb37 verified this functions as before per `./src/bitcoin-cli getpeerinfo | grep 'startingheight' | sort`, as there appear to be no functional tests for `getpeerinfo#startingheight`. As above, it is broken at this commit and returns only the initial value of `-1`. Functionality returns 3 commits later at f27a1e221d.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T15:53:27Z",
      "diff_hunk" : "@@ -202,14 +202,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.m_starting_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496058069",
      "id" : 496058069,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1ODA2OQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496058069",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496068251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496068251"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9b14eb372 `m_starting_height` presumably still needs to be `std::atomic_int`? \r\n\r\nIf you retouch, perhaps `s/height/block height/` for the Doxygen doc.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T16:09:02Z",
      "diff_hunk" : "@@ -488,6 +488,23 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+\n+    /** Starting height of this peer */\n+    std::atomic<int> m_starting_height{-1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496068251",
      "id" : 496068251,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2ODI1MQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 459,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496068251",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496071488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496071488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In general, is there a plan to eventually no longer need to set `PeerRef peer = GetPeerRef(...)` in many net processing methods? ",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T16:14:03Z",
      "diff_hunk" : "@@ -2334,6 +2375,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496071488",
      "id" : 496071488,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MTQ4OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 2281,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496071488",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496080304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496080304"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f27a1e221 nit, while touching this and lines 4334 and 4366 (3 places), if so inclined\r\n```suggestion\r\n                for (const uint256& hash : peer->m_blocks_for_headers_relay) {\r\n```",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T16:27:33Z",
      "diff_hunk" : "@@ -4196,7 +4239,7 @@ bool PeerManager::SendMessages(CNode* pto)\n                 // Try to find first header that our peer doesn't have, and\n                 // then send all headers past that one.  If we come across any\n                 // headers that aren't on ::ChainActive(), give up.\n-                for (const uint256 &hash : pto->vBlockHashesToAnnounce) {\n+                for (const uint256 &hash : peer->m_blocks_for_headers_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496080304",
      "id" : 496080304,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4MDMwNA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 4242,
      "original_position" : 226,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496080304",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496082768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496082768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8d3a068 nit, remove extra line created by this deletion",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T16:31:28Z",
      "diff_hunk" : "@@ -940,8 +940,6 @@ class CNode\n     mapMsgCmdSize mapRecvBytesPerMsgCmd GUARDED_BY(cs_vRecv);\n \n public:\n-    uint256 hashContinue;\n-    std::atomic<int> nStartingHeight{-1};\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496082768",
      "id" : 496082768,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4Mjc2OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1000,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496082768",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496083616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496083616"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8d3a068 pico-nits, `s/a INV/an INV/` and `s/them/it|the peer/`",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T16:32:58Z",
      "diff_hunk" : "@@ -488,6 +488,23 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+\n+    /** Starting height of this peer */\n+    std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in a INV message. When the peer requests this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496083616",
      "id" : 496083616,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4MzYxNg==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 502,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496083616",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496090875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496090875"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 9b14eb37 is it safe to remove `LOCK(pnode->cs_inventory);` this early? Another lock doesn't replace it until 3 commits later in f27a1e22.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-28T16:44:55Z",
      "diff_hunk" : "@@ -1399,11 +1439,11 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n             }\n         }\n         // Relay inventory, but don't relay old inventory during initial block download.\n-        m_connman.ForEachNode([nNewHeight, &vHashes](CNode* pnode) {\n-            LOCK(pnode->cs_inventory);\n-            if (nNewHeight > (pnode->nStartingHeight != -1 ? pnode->nStartingHeight - 2000 : 0)) {\n+        ForEachPeer([nNewHeight, &vHashes](const PeerRef& peer) {\n+            LOCK(peer->m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496090875",
      "id" : 496090875,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5MDg3NQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1387,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496090875",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496578664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496578664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Correct. Future commits will use `peer` throughout the function, and there's no downside to holding on to the object for a bit longer.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T09:35:59Z",
      "diff_hunk" : "@@ -1542,6 +1582,7 @@ static void RelayAddress(const CAddress& addr, bool fReachable, const CConnman&\n \n void static ProcessGetBlockData(CNode& pfrom, const CChainParams& chainparams, const CInv& inv, CConnman& connman)\n {\n+    PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496578664",
      "id" : 496578664,
      "in_reply_to_id" : 495931907,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU3ODY2NA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1530,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 498287785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496578664",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496581548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496581548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T09:40:26Z",
      "diff_hunk" : "@@ -913,6 +948,10 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LOCK(cs_main);\n     int misbehavior{0};\n     {\n+        // We remove the Peer object from g_peer_map here, but it's not guaranteed that\n+        // we'll destruct Peer here since another thread could potentially still hold\n+        // a reference to the object. Be careful not to do any processing here that\n+        // assumes Peer won't be changed before it's destructed.\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496581548",
      "id" : 496581548,
      "in_reply_to_id" : 495978760,
      "line" : 800,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4MTU0OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 800,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 10,
      "pull_request_review_id" : 498291388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496581548",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496582845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496582845"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, potentially we could just pass a `Peer&` to many of the private functions (just as `CNodeState*` is passed to some of the functions now).",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T09:42:29Z",
      "diff_hunk" : "@@ -2334,6 +2375,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496582845",
      "id" : 496582845,
      "in_reply_to_id" : 496071488,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4Mjg0NQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 2281,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 498292946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496582845",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647277"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647277"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T11:38:21Z",
      "diff_hunk" : "@@ -940,8 +940,6 @@ class CNode\n     mapMsgCmdSize mapRecvBytesPerMsgCmd GUARDED_BY(cs_vRecv);\n \n public:\n-    uint256 hashContinue;\n-    std::atomic<int> nStartingHeight{-1};\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647277",
      "id" : 496647277,
      "in_reply_to_id" : 496082768,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0NzI3Nw==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1000,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 498376974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647277",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't have a strong opinion. I've done it this way here to minimize the difference in logic, but if people want to change the internal implementation later, I'm fine with that.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T11:39:17Z",
      "diff_hunk" : "@@ -502,6 +519,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647768",
      "id" : 496647768,
      "in_reply_to_id" : 496054882,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0Nzc2OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 490,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 498377624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647768",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops. I think this was a bad rebase. Should be fixed now.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T11:39:36Z",
      "diff_hunk" : "@@ -1148,6 +1147,8 @@ void RPCConsole::updateNodeDetail(const CNodeCombinedStats *stats)\n             ui->peerCommonHeight->setText(QString(\"%1\").arg(stats->nodeStateStats.nCommonHeight));\n         else\n             ui->peerCommonHeight->setText(tr(\"Unknown\"));\n+\n+        ui->peerHeight->setText(QString::number(stats->nodeStateStats.m_starting_height));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647935",
      "id" : 496647935,
      "in_reply_to_id" : 496056128,
      "line" : 1138,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0NzkzNQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1138,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/qt/rpcconsole.cpp",
      "position" : 13,
      "pull_request_review_id" : 498377856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647935",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496648070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496648070"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As above, should now be fixed.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T11:39:49Z",
      "diff_hunk" : "@@ -202,14 +202,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.m_starting_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496648070",
      "id" : 496648070,
      "in_reply_to_id" : 496058069,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0ODA3MA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 498378020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496648070",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496649424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496649424"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> m_starting_height presumably still needs to be std::atomic_int?\r\n\r\nI don't understand. It's a `std::atomic<int>` before and after this PR.\r\n\r\n> If you retouch, perhaps s/height/block height/ for the Doxygen doc.\r\n\r\nI've updated the Doxygen comment to be clearer.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T11:42:04Z",
      "diff_hunk" : "@@ -488,6 +488,23 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+\n+    /** Starting height of this peer */\n+    std::atomic<int> m_starting_height{-1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496649424",
      "id" : 496649424,
      "in_reply_to_id" : 496068251,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0OTQyNA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 459,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 498379591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496649424",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496652482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496652482"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T11:47:52Z",
      "diff_hunk" : "@@ -4196,7 +4239,7 @@ bool PeerManager::SendMessages(CNode* pto)\n                 // Try to find first header that our peer doesn't have, and\n                 // then send all headers past that one.  If we come across any\n                 // headers that aren't on ::ChainActive(), give up.\n-                for (const uint256 &hash : pto->vBlockHashesToAnnounce) {\n+                for (const uint256 &hash : peer->m_blocks_for_headers_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496652482",
      "id" : 496652482,
      "in_reply_to_id" : 496080304,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MjQ4Mg==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 4242,
      "original_position" : 226,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 498383510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496652482",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496653268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496653268"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T11:49:25Z",
      "diff_hunk" : "@@ -488,6 +488,23 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+\n+    /** Starting height of this peer */\n+    std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in a INV message. When the peer requests this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496653268",
      "id" : 496653268,
      "in_reply_to_id" : 496083616,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MzI2OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 502,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 498384511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496653268",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496653399"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496653399"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops. Bad rebase. Should be fixed now.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-09-29T11:49:38Z",
      "diff_hunk" : "@@ -1399,11 +1439,11 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n             }\n         }\n         // Relay inventory, but don't relay old inventory during initial block download.\n-        m_connman.ForEachNode([nNewHeight, &vHashes](CNode* pnode) {\n-            LOCK(pnode->cs_inventory);\n-            if (nNewHeight > (pnode->nStartingHeight != -1 ? pnode->nStartingHeight - 2000 : 0)) {\n+        ForEachPeer([nNewHeight, &vHashes](const PeerRef& peer) {\n+            LOCK(peer->m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496653399",
      "id" : 496653399,
      "in_reply_to_id" : 496090875,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MzM5OQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1387,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 498384642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496653399",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the very thorough review, @jonatack. I've addressed all of your comments.",
      "created_at" : "2020-09-29T11:54:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-700652906",
      "id" : 700652906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMDY1MjkwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-29T11:54:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/700652906",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r498128377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498128377"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0a9839058c\r\n```bash\r\nnet_processing.cpp: In function âbool GetNodeStateStats(NodeId, CNodeStateStats&)â:\r\nnet_processing.cpp:982:11: error: âstruct CNodeStateStatsâ has no member named âm_starting_heightâ; did you mean ânStartingHeightâ?\r\n  982 |     stats.m_starting_height = peer->m_starting_height;\r\n      |           ^~~~~~~~~~~~~~~~~\r\n      |           nStartingHeight\r\n```",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-10-01T10:03:17Z",
      "diff_hunk" : "@@ -971,6 +1011,7 @@ bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n     PeerRef peer = GetPeerRef(nodeid);\n     if (peer == nullptr) return false;\n     stats.m_misbehavior_score = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n+    stats.m_starting_height = peer->m_starting_height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r498128377",
      "id" : 498128377,
      "line" : 878,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEyODM3Nw==",
      "original_commit_id" : "1a9e1911673e2e643e9ad9b6ff412ce34e7af72f",
      "original_line" : 878,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 500193857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498128377",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r498154958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498154958"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-10-01T10:53:12Z",
      "diff_hunk" : "@@ -971,6 +1011,7 @@ bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n     PeerRef peer = GetPeerRef(nodeid);\n     if (peer == nullptr) return false;\n     stats.m_misbehavior_score = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n+    stats.m_starting_height = peer->m_starting_height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r498154958",
      "id" : 498154958,
      "in_reply_to_id" : 498128377,
      "line" : 878,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE1NDk1OA==",
      "original_commit_id" : "1a9e1911673e2e643e9ad9b6ff412ce34e7af72f",
      "original_line" : 878,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 500228247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498154958",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @jonatack . I fixed the bad rebase.",
      "created_at" : "2020-10-01T10:53:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-702054221",
      "id" : 702054221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMjA1NDIyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-01T10:53:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/702054221",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "commits f9136f4bf, 7199d81968, 8ff3e9319c11 and 40ea4a42d9\r\n```diff\r\nnet_processing.cpp: In function âbool GetNodeStateStats(NodeId, CNodeStateStats&)â:\r\nnet_processing.cpp:982/1000/1009: error: âstruct CNodeStateStatsâ has no member named ânStartingHeightâ; did you mean âm_starting_heightâ?\r\n  982 |     stats.nStartingHeight = peer->nStartingHeight;\r\n      |           ^~~~~~~~~~~~~~~\r\n      |           m_starting_height\r\n```\r\n(we'll get there!)",
      "created_at" : "2020-10-01T13:32:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-702137666",
      "id" : 702137666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMjEzNzY2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-01T13:32:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/702137666",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Oops. Sorry Jon. Should be good now.",
      "created_at" : "2020-10-01T18:01:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-702303723",
      "id" : 702303723,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMjMwMzcyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-01T18:01:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/702303723",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-19T02:49:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-711480527",
      "id" : 711480527,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTQ4MDUyNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-19T02:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711480527",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-10-19T08:16:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-711816616",
      "id" : 711816616,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTgxNjYxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-19T08:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711816616",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-11-19T11:10:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-730300986",
      "id" : 730300986,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMDMwMDk4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-19T11:10:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/730300986",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-09T15:25:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-741842942",
      "id" : 741842942,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTg0Mjk0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-09T15:25:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741842942",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is a slightly difficult rebase since the commits need to be structured a little differently to all build. Will work on it tomorrow.",
      "created_at" : "2020-12-09T18:42:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-741971580",
      "id" : 741971580,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MTk3MTU4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-09T18:42:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/741971580",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm going to mark this as WIP for now. It'll be a lot easier to rebase after #20624 is merged.\r\n\r\nIf you want to help with #19398, please review #20624 first!",
      "created_at" : "2020-12-11T10:54:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-743125310",
      "id" : 743125310,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MzEyNTMxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-11T10:54:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/743125310",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased. This is now ready for review.",
      "created_at" : "2020-12-14T12:09:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-744398168",
      "id" : 744398168,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NDM5ODE2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-14T12:09:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/744398168",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nRunning script for: fe391ca326f73337275d726f7de9db384ac35466\r\n\r\nsed -i 's/vBlockHashesToAnnounce/m_blocks_for_headers_relay/g' src/net_processing.cpp\r\n\r\nsed -i 's/vInventoryBlockToSend/m_blocks_for_inv_relay/g' src/net_processing.cpp\r\n\r\ndiff --git a/src/net_processing.h b/src/net_processing.h\r\n\r\nindex 1ad40982b..4998a1e04 100644\r\n\r\n--- a/src/net_processing.h\r\n\r\n+++ b/src/net_processing.h\r\n\r\n@@ -66,9 +66,9 @@ struct Peer {\r\n\r\n     /** List of block ids we still have announce.\r\n\r\n      * There is no final sorting before sending, as they are always sent\r\n\r\n      * immediately and in the order requested. */\r\n\r\n-    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\r\n\r\n+    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\r\n\r\n     /** List of headers to relay */\r\n\r\n-    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\r\n\r\n+    std::vector<uint256> vBlockHashesToAnnounce GUARDED_BY(m_block_inv_mutex);\r\n\r\n \r\n\r\n     /** This peer's reported block height when we connected */\r\n\r\n     std::atomic<int> m_starting_height{-1};\r\n\r\nFailed",
      "created_at" : "2020-12-14T12:42:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-744413465",
      "id" : 744413465,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NDQxMzQ2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-14T12:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/744413465",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @MarcoFalke. Should be fixed now.",
      "created_at" : "2020-12-14T12:44:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-744414753",
      "id" : 744414753,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NDQxNDc1Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-14T12:44:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/744414753",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r543272216"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/543272216"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1 : `ForEachNode` performs an additional check `NodeFullyConnected` (`pnode->fSuccessfullyConnected && !pnode->fDisconnect;`).\r\n\r\nNot sure if that matters much here. Could we prematurely send headers before `VERACK`?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-15T11:41:32Z",
      "diff_hunk" : "@@ -1315,13 +1315,17 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n         }\n     }\n \n-    // Relay to all peers\n-    m_connman.ForEachNode([&vHashes](CNode* pnode) {\n-        LOCK(pnode->cs_inventory);\n-        for (const uint256& hash : reverse_iterate(vHashes)) {\n-            pnode->vBlockHashesToAnnounce.push_back(hash);\n+    {\n+        LOCK(m_peer_mutex);\n+        for (auto& it : m_peer_map) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r543272216",
      "id" : 543272216,
      "line" : 1320,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI3MjIxNg==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 1320,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 31,
      "pull_request_review_id" : 552365804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/543272216",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r543710801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/543710801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is an excellent observation. Block hashes could be pushed into `m_blocks_for_headers_relay` before the version/verack handshake is complete. However, we'll never send any blocks inventory before we're fully connected due to the guard clause at the top of SendMessages():\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c434e2cca9181ce184efef946ab2ce62f2cd2ee7/src/net_processing.cpp#L4077-L4078\r\n\r\nI think this behaviour is ok. The version-verack handshake usually lasts no more than a second or two, and at the worst case times out after a minute, so we're never going to push many block hashes onto this vector.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-15T21:48:58Z",
      "diff_hunk" : "@@ -1315,13 +1315,17 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n         }\n     }\n \n-    // Relay to all peers\n-    m_connman.ForEachNode([&vHashes](CNode* pnode) {\n-        LOCK(pnode->cs_inventory);\n-        for (const uint256& hash : reverse_iterate(vHashes)) {\n-            pnode->vBlockHashesToAnnounce.push_back(hash);\n+    {\n+        LOCK(m_peer_mutex);\n+        for (auto& it : m_peer_map) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r543710801",
      "id" : 543710801,
      "in_reply_to_id" : 543272216,
      "line" : 1320,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxMDgwMQ==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 1320,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 31,
      "pull_request_review_id" : 552937445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/543710801",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@hebasto @ariard @jonatack - this is now rebased with all comments addressed. Do you have time to rereview?",
      "created_at" : "2020-12-18T19:15:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748272056",
      "id" : 748272056,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODI3MjA1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-18T19:15:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748272056",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546087558"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546087558"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4ac61d85f1624b1cd7af4a85c8bca0bd430801f0\r\nPosition of `\"startingheight\"` in `RPCHelpMan` should be changed accordingly.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-18T20:58:34Z",
      "diff_hunk" : "@@ -224,14 +224,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.nStartingHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546087558",
      "id" : 546087558,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA4NzU1OA==",
      "original_commit_id" : "4ac61d85f1624b1cd7af4a85c8bca0bd430801f0",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 555809738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546087558",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546095735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546095735"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1\r\n\r\nI understand that comment text has been preserved, but maybe\r\n```suggestion\r\n    /** List of block ids we still have to announce.\r\n```\r\n?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-18T21:19:18Z",
      "diff_hunk" : "@@ -61,6 +61,15 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546095735",
      "id" : 546095735,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA5NTczNQ==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 66,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555809738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546095735",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK b5b27ea052905ff7f26a962baa961fcc762c5ee0\r\n\r\nIs m_hash_continue protected by any locks? A \"this is only accessed by the singular net_processing thread\" rationale would be sufficient, but if there happens to be a lock that's held in all access locations, perhaps it's easy to add?",
      "created_at" : "2020-12-18T21:31:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748329137",
      "id" : 748329137,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODMyOTEzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-18T21:31:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748329137",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546116786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546116786"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is the first place where we are acquiring a lock while already holding `m_peer_mutex`.  Any thoughts on what is the best way to document this design, so that future code writers know that acquiring `m_peer_mutex` while holding a peer's `m_block_inv_mutex` is not allowed?\r\n\r\nOr, would it be better to first copy all the Peer objects to a temporary place, release the `m_peer_mutex` lock, and then grab the per-peer `m_block_inv_mutex` locks to avoid holding both at the same time?  (I don't know or have an opinion; just trying to figure out the locking design here.)",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-18T22:16:36Z",
      "diff_hunk" : "@@ -1315,13 +1315,17 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n         }\n     }\n \n-    // Relay to all peers\n-    m_connman.ForEachNode([&vHashes](CNode* pnode) {\n-        LOCK(pnode->cs_inventory);\n-        for (const uint256& hash : reverse_iterate(vHashes)) {\n-            pnode->vBlockHashesToAnnounce.push_back(hash);\n+    {\n+        LOCK(m_peer_mutex);\n+        for (auto& it : m_peer_map) {\n+            Peer& peer = *it.second;\n+            LOCK(peer.m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546116786",
      "id" : 546116786,
      "line" : 1322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExNjc4Ng==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 1322,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 480949559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546116786",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546118439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546118439"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We send an INV message, not a BLOCK message.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-18T22:21:49Z",
      "diff_hunk" : "@@ -72,6 +72,11 @@ struct Peer {\n \n     /** This peer's reported block height when we connected */\n     std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in an INV message. When the peer requests this\n+     * block, we send a BLOCK message to trigger the peer to request the next",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546118439",
      "id" : 546118439,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExODQzOQ==",
      "original_commit_id" : "b5b27ea052905ff7f26a962baa961fcc762c5ee0",
      "original_line" : 76,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 480949559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546118439",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546147190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546147190"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would a comment next to `m_peer_mutex` suffice here? This design (take `m_peer_mutex` first, then lock the mutexes protecting the individual data members) is analogous to `ForEachNode()` was doing here before (take `cs_vNodes` first, then lock the mutexes protecting the individual data members in the lambda - here `cs_inventory`).",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-18T23:38:51Z",
      "diff_hunk" : "@@ -1315,13 +1315,17 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n         }\n     }\n \n-    // Relay to all peers\n-    m_connman.ForEachNode([&vHashes](CNode* pnode) {\n-        LOCK(pnode->cs_inventory);\n-        for (const uint256& hash : reverse_iterate(vHashes)) {\n-            pnode->vBlockHashesToAnnounce.push_back(hash);\n+    {\n+        LOCK(m_peer_mutex);\n+        for (auto& it : m_peer_map) {\n+            Peer& peer = *it.second;\n+            LOCK(peer.m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546147190",
      "id" : 546147190,
      "in_reply_to_id" : 546116786,
      "line" : 1322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0NzE5MA==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 1322,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 555879922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546147190",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546147750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546147750"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, will fix.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-18T23:41:35Z",
      "diff_hunk" : "@@ -72,6 +72,11 @@ struct Peer {\n \n     /** This peer's reported block height when we connected */\n     std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in an INV message. When the peer requests this\n+     * block, we send a BLOCK message to trigger the peer to request the next",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546147750",
      "id" : 546147750,
      "in_reply_to_id" : 546118439,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0Nzc1MA==",
      "original_commit_id" : "b5b27ea052905ff7f26a962baa961fcc762c5ee0",
      "original_line" : 76,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555880570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546147750",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546147783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546147783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree. Will fix.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-18T23:41:44Z",
      "diff_hunk" : "@@ -61,6 +61,15 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546147783",
      "id" : 546147783,
      "in_reply_to_id" : 546095735,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0Nzc4Mw==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 66,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555880607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546147783",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546147815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546147815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Will fix.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-18T23:41:53Z",
      "diff_hunk" : "@@ -224,14 +224,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.nStartingHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546147815",
      "id" : 546147815,
      "in_reply_to_id" : 546087558,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0NzgxNQ==",
      "original_commit_id" : "4ac61d85f1624b1cd7af4a85c8bca0bd430801f0",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 555880664,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546147815",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Is m_hash_continue protected by any locks? A \"this is only accessed by the singular net_processing thread\" rationale would be sufficient, but if there happens to be a lock that's held in all access locations, perhaps it's easy to add?\r\n\r\n@sipa could we just make it a std::atomic? It doesn't need to be synchronized with any other data, so as long as we're guaranteeing that reads/writes are atomic, I think that's enough?",
      "created_at" : "2020-12-18T23:42:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748374852",
      "id" : 748374852,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODM3NDg1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-18T23:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748374852",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This has three code review ACKs, with just three minor comments outstanding. I think we can merge now and I can fix those outstanding comments in the next PR in the #19398 sequence. Also happy to fix them here if that's what others prefer.",
      "created_at" : "2020-12-18T23:43:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748375235",
      "id" : 748375235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODM3NTIzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-18T23:43:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748375235",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've addressed @sdaftuar, @hebasto and @sipa suggestions in the first three commits of #20721.",
      "created_at" : "2020-12-19T11:25:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748460913",
      "id" : 748460913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODQ2MDkxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-19T11:25:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748460913",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546232897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546232897"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4ac61d85f1624b1cd7af4a85c8bca0bd430801f0:\r\n\r\nCan you explain why a nullptr-Assert is not needed here?\r\nAlso, why isn't the peer passed in from outside, where it already exists?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T12:27:53Z",
      "diff_hunk" : "@@ -1843,7 +1844,8 @@ void PeerManager::ProcessHeadersMessage(CNode& pfrom, const std::vector<CBlockHe\n             // Headers message had its maximum size; the peer may have more headers.\n             // TODO: optimize: if pindexLast is an ancestor of ::ChainActive().Tip or pindexBestHeader, continue\n             // from there instead.\n-            LogPrint(BCLog::NET, \"more getheaders (%d) to end to peer=%d (startheight:%d)\\n\", pindexLast->nHeight, pfrom.GetId(), pfrom.nStartingHeight);\n+            PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546232897",
      "id" : 546232897,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIzMjg5Nw==",
      "original_commit_id" : "4ac61d85f1624b1cd7af4a85c8bca0bd430801f0",
      "original_line" : 1866,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555938493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546232897",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546234157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546234157"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1\r\n\r\nAny reason to not have a `ForEachPeer` member function?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T12:41:31Z",
      "diff_hunk" : "@@ -1315,13 +1315,17 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n         }\n     }\n \n-    // Relay to all peers\n-    m_connman.ForEachNode([&vHashes](CNode* pnode) {\n-        LOCK(pnode->cs_inventory);\n-        for (const uint256& hash : reverse_iterate(vHashes)) {\n-            pnode->vBlockHashesToAnnounce.push_back(hash);\n+    {\n+        LOCK(m_peer_mutex);\n+        for (auto& it : m_peer_map) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546234157",
      "id" : 546234157,
      "line" : 1320,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIzNDE1Nw==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 1320,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 31,
      "pull_request_review_id" : 555938493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546234157",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546235312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546235312"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1\r\n\r\nThe list is unfiltered, as was mentioned in the previous comment. Any reason to remove that?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T12:54:18Z",
      "diff_hunk" : "@@ -61,6 +61,15 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546235312",
      "id" : 546235312,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIzNTMxMg==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 70,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555938493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546235312",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546235973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546235973"
         }
      },
      "author_association" : "MEMBER",
      "body" : "22c2b3eff601cbc1aed2e466502bdc5549e11ae2\r\n\r\nI don't think this name is correct. Headers relay isn't implied. It might very well fall back to inv relay. Most importantly when the peer asked us to. Though, there are other reasons, too.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T13:00:47Z",
      "diff_hunk" : "@@ -66,9 +66,9 @@ struct Peer {\n     /** List of block ids we still have announce.\n      * There is no final sorting before sending, as they are always sent\n      * immediately and in the order requested. */\n-    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n     /** List of headers to relay */\n-    std::vector<uint256> vBlockHashesToAnnounce GUARDED_BY(m_block_inv_mutex);\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546235973",
      "id" : 546235973,
      "line" : 75,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIzNTk3Mw==",
      "original_commit_id" : "22c2b3eff601cbc1aed2e466502bdc5549e11ae2",
      "original_line" : 75,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 30,
      "pull_request_review_id" : 555938493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546235973",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546237229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546237229"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b5b27ea052905ff7f26a962baa961fcc762c5ee0\r\n\r\nI don't think this is true either. `m_hash_continue` is a purely internal helper, never sent over the wire directly.  Instead, the tip hash is sent to trigger the peer to ask further.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T13:14:56Z",
      "diff_hunk" : "@@ -72,6 +72,11 @@ struct Peer {\n \n     /** This peer's reported block height when we connected */\n     std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in an INV message. When the peer requests this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546237229",
      "id" : 546237229,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIzNzIyOQ==",
      "original_commit_id" : "b5b27ea052905ff7f26a962baa961fcc762c5ee0",
      "original_line" : 75,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555938493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546237229",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @MarcoFalke . There are enough review comments here that it makes sense to address them in this PR instead of a follow-up. It also looks to me like this isn't entirely a clean merge, so I'm going to rebase on master.",
      "created_at" : "2020-12-19T14:32:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748482302",
      "id" : 748482302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODQ4MjMwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-19T14:32:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748482302",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246602"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added comments to the first commit. Let me know if you think more is required.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T14:52:05Z",
      "diff_hunk" : "@@ -1315,13 +1315,17 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n         }\n     }\n \n-    // Relay to all peers\n-    m_connman.ForEachNode([&vHashes](CNode* pnode) {\n-        LOCK(pnode->cs_inventory);\n-        for (const uint256& hash : reverse_iterate(vHashes)) {\n-            pnode->vBlockHashesToAnnounce.push_back(hash);\n+    {\n+        LOCK(m_peer_mutex);\n+        for (auto& it : m_peer_map) {\n+            Peer& peer = *it.second;\n+            LOCK(peer.m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246602",
      "id" : 546246602,
      "in_reply_to_id" : 546116786,
      "line" : 1322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0NjYwMg==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 1322,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 555946452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246602",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246608"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T14:52:11Z",
      "diff_hunk" : "@@ -72,6 +72,11 @@ struct Peer {\n \n     /** This peer's reported block height when we connected */\n     std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in an INV message. When the peer requests this\n+     * block, we send a BLOCK message to trigger the peer to request the next",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246608",
      "id" : 546246608,
      "in_reply_to_id" : 546118439,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0NjYwOA==",
      "original_commit_id" : "b5b27ea052905ff7f26a962baa961fcc762c5ee0",
      "original_line" : 76,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555946460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246608",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246613"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T14:52:18Z",
      "diff_hunk" : "@@ -61,6 +61,15 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246613",
      "id" : 546246613,
      "in_reply_to_id" : 546095735,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0NjYxMw==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 66,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555946464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246613",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246624"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246624"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T14:52:25Z",
      "diff_hunk" : "@@ -224,14 +224,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.nStartingHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246624",
      "id" : 546246624,
      "in_reply_to_id" : 546087558,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0NjYyNA==",
      "original_commit_id" : "4ac61d85f1624b1cd7af4a85c8bca0bd430801f0",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 555946473,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246624",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246883"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure if it is done in the latest push (58f4c8567ba77fbdbd65a12c74628505aacd0d3c).",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T14:55:05Z",
      "diff_hunk" : "@@ -224,14 +224,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.nStartingHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546246883",
      "id" : 546246883,
      "in_reply_to_id" : 546087558,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0Njg4Mw==",
      "original_commit_id" : "4ac61d85f1624b1cd7af4a85c8bca0bd430801f0",
      "original_line" : 234,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 555946615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546246883",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546247528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546247528"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, passing in from outside is a much better idea. I've done that now.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T15:00:57Z",
      "diff_hunk" : "@@ -1843,7 +1844,8 @@ void PeerManager::ProcessHeadersMessage(CNode& pfrom, const std::vector<CBlockHe\n             // Headers message had its maximum size; the peer may have more headers.\n             // TODO: optimize: if pindexLast is an ancestor of ::ChainActive().Tip or pindexBestHeader, continue\n             // from there instead.\n-            LogPrint(BCLog::NET, \"more getheaders (%d) to end to peer=%d (startheight:%d)\\n\", pindexLast->nHeight, pfrom.GetId(), pfrom.nStartingHeight);\n+            PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546247528",
      "id" : 546247528,
      "in_reply_to_id" : 546232897,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0NzUyOA==",
      "original_commit_id" : "4ac61d85f1624b1cd7af4a85c8bca0bd430801f0",
      "original_line" : 1866,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555947033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546247528",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546247965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546247965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I originally had one but removed it because it didn't seem worth it. We can revisit that decision later if it seems useful.\r\n\r\nForEachNode was useful because it allowed passing a lambda into CConnman which would be executed while the cs_vNodes lock was held. Here, the m_peer_mutex is in PeerMan, so it can be held directly.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T15:05:24Z",
      "diff_hunk" : "@@ -1315,13 +1315,17 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n         }\n     }\n \n-    // Relay to all peers\n-    m_connman.ForEachNode([&vHashes](CNode* pnode) {\n-        LOCK(pnode->cs_inventory);\n-        for (const uint256& hash : reverse_iterate(vHashes)) {\n-            pnode->vBlockHashesToAnnounce.push_back(hash);\n+    {\n+        LOCK(m_peer_mutex);\n+        for (auto& it : m_peer_map) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546247965",
      "id" : 546247965,
      "in_reply_to_id" : 546234157,
      "line" : 1320,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0Nzk2NQ==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 1320,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 31,
      "pull_request_review_id" : 555947299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546247965",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546247973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546247973"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, I've added the word unfiltered back.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T15:05:37Z",
      "diff_hunk" : "@@ -61,6 +61,15 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546247973",
      "id" : 546247973,
      "in_reply_to_id" : 546235312,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0Nzk3Mw==",
      "original_commit_id" : "a50dee50fd2aee93b41bfb3b04b24939d0c2f6c1",
      "original_line" : 70,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555947311,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546247973",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546248923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546248923"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We hope to announce these blocks via headers. If we can't, we'll move the hashes onto the `m_blocks_for_inv_relay` and then announce via inv.\r\n\r\nI've updated the comment. Let me know if you think it's clear enough now.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T15:14:34Z",
      "diff_hunk" : "@@ -66,9 +66,9 @@ struct Peer {\n     /** List of block ids we still have announce.\n      * There is no final sorting before sending, as they are always sent\n      * immediately and in the order requested. */\n-    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n     /** List of headers to relay */\n-    std::vector<uint256> vBlockHashesToAnnounce GUARDED_BY(m_block_inv_mutex);\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546248923",
      "id" : 546248923,
      "in_reply_to_id" : 546235973,
      "line" : 75,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0ODkyMw==",
      "original_commit_id" : "22c2b3eff601cbc1aed2e466502bdc5549e11ae2",
      "original_line" : 75,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 30,
      "pull_request_review_id" : 555947892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546248923",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546248967"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546248967"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've updated the comment to be \"The final block hash that we sent in an `inv` message to this peer.\" Let me know if you have suggestions for better wording.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T15:15:10Z",
      "diff_hunk" : "@@ -72,6 +72,11 @@ struct Peer {\n \n     /** This peer's reported block height when we connected */\n     std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in an INV message. When the peer requests this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546248967",
      "id" : 546248967,
      "in_reply_to_id" : 546237229,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI0ODk2Nw==",
      "original_commit_id" : "b5b27ea052905ff7f26a962baa961fcc762c5ee0",
      "original_line" : 75,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555947933,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546248967",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed all comments.\r\n\r\n> Is m_hash_continue protected by any locks? A \"this is only accessed by the singular net_processing thread\" rationale would be sufficient, but if there happens to be a lock that's held in all access locations, perhaps it's easy to add?\r\n\r\n@sipa I've added a commit to guard m_hash_continue with m_block_inv_mutex.",
      "created_at" : "2020-12-19T15:16:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748487089",
      "id" : 748487089,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODQ4NzA4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-19T15:16:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748487089",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546251702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546251702"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2f023a8 nit, the diff would be clearer without the line break changes, and I also find the code less readable here than on one line",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T15:42:09Z",
      "diff_hunk" : "@@ -1764,7 +1775,9 @@ void PeerManager::SendBlockTransactions(CNode& pfrom, const CBlock& block, const\n     m_connman.PushMessage(&pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCKTXN, resp));\n }\n \n-void PeerManager::ProcessHeadersMessage(CNode& pfrom, const std::vector<CBlockHeader>& headers, bool via_compact_block)\n+void PeerManager::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n+                                        const std::vector<CBlockHeader>& headers,\n+                                        bool via_compact_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546251702",
      "id" : 546251702,
      "line" : 1781,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI1MTcwMg==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 1781,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 97,
      "pull_request_review_id" : 555949691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546251702",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546251731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546251731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2f023a8 nit, as above, easier diff to review and more readable without the added line break",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T15:42:49Z",
      "diff_hunk" : "@@ -1854,7 +1867,8 @@ void PeerManager::ProcessHeadersMessage(CNode& pfrom, const std::vector<CBlockHe\n             // Headers message had its maximum size; the peer may have more headers.\n             // TODO: optimize: if pindexLast is an ancestor of ::ChainActive().Tip or pindexBestHeader, continue\n             // from there instead.\n-            LogPrint(BCLog::NET, \"more getheaders (%d) to end to peer=%d (startheight:%d)\\n\", pindexLast->nHeight, pfrom.GetId(), pfrom.nStartingHeight);\n+            LogPrint(BCLog::NET, \"more getheaders (%d) to end to peer=%d (startheight:%d)\\n\",\n+                                 pindexLast->nHeight, pfrom.GetId(), peer.m_starting_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546251731",
      "id" : 546251731,
      "line" : 1872,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI1MTczMQ==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 1872,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 107,
      "pull_request_review_id" : 555949691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546251731",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546252186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546252186"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2f023a8 nit, as above, easier diff to review and more readable here without the line break changes",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T15:46:37Z",
      "diff_hunk" : "@@ -180,7 +202,9 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n \n     void ProcessOrphanTx(std::set<uint256>& orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(cs_main, g_cs_orphans);\n     /** Process a single headers message from a peer. */\n-    void ProcessHeadersMessage(CNode& pfrom, const std::vector<CBlockHeader>& headers, bool via_compact_block);\n+    void ProcessHeadersMessage(CNode& pfrom, const Peer& peer,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546252186",
      "id" : 546252186,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI1MjE4Ng==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 205,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 48,
      "pull_request_review_id" : 555949691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546252186",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546266076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546266076"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 2f023a8c0e445985a20, `startingheight` should remain before `synced_headers` and `synced_blocks` (here and in the help) for consistency with the GUI peers info (or maybe less preferably, the GUI should be updated to follow this change)",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T18:05:53Z",
      "diff_hunk" : "@@ -224,14 +224,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.m_starting_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546266076",
      "id" : 546266076,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI2NjA3Ng==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 234,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 555949691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546266076",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546267230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546267230"
         }
      },
      "author_association" : "MEMBER",
      "body" : "25ccfd3b while renaming `hashContinue`, I wonder if it can be better named (but don't have one to propose)",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-19T18:17:18Z",
      "diff_hunk" : "@@ -60,6 +63,25 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of blocks that we'll anounce via an `inv` message.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** Unfiltered list of blocks that we'd like to announce via a `headers`\n+     * message. If we can't announce via a `headers` message, we'll fall back to\n+     * announcing via `inv`. */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+    /** The final block hash that we sent in an `inv` message to this peer.\n+     * When the peer requests this block, we send an `inv` message to trigger\n+     * the peer to request the next sequence of block hashes.\n+     * Most peers use headers-first syncing, which doesn't use this mechanism */\n+    uint256 m_hash_continue GUARDED_BY(m_block_inv_mutex) {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546267230",
      "id" : 546267230,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI2NzIzMA==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 80,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555949691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546267230",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-12-19T19:48:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748517082",
      "id" : 748517082,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODUxNzA4Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-19T19:48:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748517082",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546338754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546338754"
         }
      },
      "author_association" : "MEMBER",
      "body" : "717a374e74b64b7b90bc1b2995e8900212bd0bfe\r\n\r\nnit to avoid the inversion and give a rationale:\r\n\r\n\"m_peer_mutex should be locked before locking a mutex inside this struct to avoid lock order violations\"\r\n\r\nThis will also weaken the requirement, because for some mutexes it could make sense to not require m_peer_mutex beforehand. ",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T08:06:25Z",
      "diff_hunk" : "@@ -46,6 +46,8 @@ struct CNodeStateStats {\n  * Memory is owned by shared pointers and this object is destructed when\n  * the refcount drops to zero.\n  *\n+ * Mutexes inside this struct must not be held when locking m_peer_mutex.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546338754",
      "id" : 546338754,
      "line" : 50,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMzODc1NA==",
      "original_commit_id" : "717a374e74b64b7b90bc1b2995e8900212bd0bfe",
      "original_line" : 49,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 12,
      "pull_request_review_id" : 555994173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546338754",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546338825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546338825"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T08:06:52Z",
      "diff_hunk" : "@@ -210,7 +212,8 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n       * on extra block-relay-only peers. */\n     bool m_initial_sync_finished{false};\n \n-    /** Protects m_peer_map */\n+    /** Protects m_peer_map. This mutex must not be locked while holding a lock\n+     *  on any of the mutexes inside a Peer object. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546338825",
      "id" : 546338825,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMzODgyNQ==",
      "original_commit_id" : "717a374e74b64b7b90bc1b2995e8900212bd0bfe",
      "original_line" : 216,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 60,
      "pull_request_review_id" : 555994173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546338825",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546342334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546342334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What syntax is this? I don't think we use `LOCK(); { ... }` anywhere in the codebase",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T08:20:49Z",
      "diff_hunk" : "@@ -1615,15 +1615,17 @@ void static ProcessGetBlockData(CNode& pfrom, Peer& peer, const CChainParams& ch\n             }\n         }\n \n-        // Trigger the peer node to send a getblocks request for the next batch of inventory\n-        if (inv.hash == peer.m_hash_continue) {\n-            // Send immediately. This must send even if redundant,\n-            // and we want it right after the last block so they don't\n-            // wait for other stuff first.\n-            std::vector<CInv> vInv;\n-            vInv.push_back(CInv(MSG_BLOCK, ::ChainActive().Tip()->GetBlockHash()));\n-            connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::INV, vInv));\n-            peer.m_hash_continue.SetNull();\n+        LOCK(peer.m_block_inv_mutex); {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546342334",
      "id" : 546342334,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM0MjMzNA==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 1618,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555994173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546342334",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546342415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546342415"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, doesn't this lock violate the documentation you added in the first commit?",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T08:21:34Z",
      "diff_hunk" : "@@ -1615,15 +1615,17 @@ void static ProcessGetBlockData(CNode& pfrom, Peer& peer, const CChainParams& ch\n             }\n         }\n \n-        // Trigger the peer node to send a getblocks request for the next batch of inventory\n-        if (inv.hash == peer.m_hash_continue) {\n-            // Send immediately. This must send even if redundant,\n-            // and we want it right after the last block so they don't\n-            // wait for other stuff first.\n-            std::vector<CInv> vInv;\n-            vInv.push_back(CInv(MSG_BLOCK, ::ChainActive().Tip()->GetBlockHash()));\n-            connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::INV, vInv));\n-            peer.m_hash_continue.SetNull();\n+        LOCK(peer.m_block_inv_mutex); {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546342415",
      "id" : 546342415,
      "in_reply_to_id" : 546342334,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM0MjQxNQ==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 1618,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555994173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546342415",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546342532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546342532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. Looks good now.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T08:22:53Z",
      "diff_hunk" : "@@ -72,6 +72,11 @@ struct Peer {\n \n     /** This peer's reported block height when we connected */\n     std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in an INV message. When the peer requests this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546342532",
      "id" : 546342532,
      "in_reply_to_id" : 546237229,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM0MjUzMg==",
      "original_commit_id" : "b5b27ea052905ff7f26a962baa961fcc762c5ee0",
      "original_line" : 75,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555996244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546342532",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546342556"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546342556"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\n\r\nThanks. Looks good now.\r\n",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T08:23:06Z",
      "diff_hunk" : "@@ -66,9 +66,9 @@ struct Peer {\n     /** List of block ids we still have announce.\n      * There is no final sorting before sending, as they are always sent\n      * immediately and in the order requested. */\n-    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n     /** List of headers to relay */\n-    std::vector<uint256> vBlockHashesToAnnounce GUARDED_BY(m_block_inv_mutex);\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546342556",
      "id" : 546342556,
      "in_reply_to_id" : 546235973,
      "line" : 75,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM0MjU1Ng==",
      "original_commit_id" : "22c2b3eff601cbc1aed2e466502bdc5549e11ae2",
      "original_line" : 75,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 30,
      "pull_request_review_id" : 555996261,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546342556",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546352430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546352430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That isn't precise enough. It's fine to lock m_peer_mutex, take a shared_ptr to one of the Peer objects, release m_peer_mutex and later lock one of the inner mutexes. The only rule is that we don't want to lock m_peer_mutex while already holding a lock on one of the inner mutexes.\r\n\r\nThis is the same as cs_vNodes and the inner mutexes in CNode.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T09:53:19Z",
      "diff_hunk" : "@@ -46,6 +46,8 @@ struct CNodeStateStats {\n  * Memory is owned by shared pointers and this object is destructed when\n  * the refcount drops to zero.\n  *\n+ * Mutexes inside this struct must not be held when locking m_peer_mutex.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546352430",
      "id" : 546352430,
      "in_reply_to_id" : 546338754,
      "line" : 50,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1MjQzMA==",
      "original_commit_id" : "717a374e74b64b7b90bc1b2995e8900212bd0bfe",
      "original_line" : 49,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 12,
      "pull_request_review_id" : 556002144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546352430",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546352494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546352494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "as above",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T09:53:44Z",
      "diff_hunk" : "@@ -210,7 +212,8 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n       * on extra block-relay-only peers. */\n     bool m_initial_sync_finished{false};\n \n-    /** Protects m_peer_map */\n+    /** Protects m_peer_map. This mutex must not be locked while holding a lock\n+     *  on any of the mutexes inside a Peer object. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546352494",
      "id" : 546352494,
      "in_reply_to_id" : 546338825,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1MjQ5NA==",
      "original_commit_id" : "717a374e74b64b7b90bc1b2995e8900212bd0bfe",
      "original_line" : 216,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 60,
      "pull_request_review_id" : 556002188,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546352494",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is my brain not working properly. I've fixed the syntax.\r\n\r\nThis doesn't violate the documentation. That says that it's not permitted to lock m_peer_map while holding a lock on an inner mutex. This is locking an inner mutex.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T09:58:24Z",
      "diff_hunk" : "@@ -1615,15 +1615,17 @@ void static ProcessGetBlockData(CNode& pfrom, Peer& peer, const CChainParams& ch\n             }\n         }\n \n-        // Trigger the peer node to send a getblocks request for the next batch of inventory\n-        if (inv.hash == peer.m_hash_continue) {\n-            // Send immediately. This must send even if redundant,\n-            // and we want it right after the last block so they don't\n-            // wait for other stuff first.\n-            std::vector<CInv> vInv;\n-            vInv.push_back(CInv(MSG_BLOCK, ::ChainActive().Tip()->GetBlockHash()));\n-            connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::INV, vInv));\n-            peer.m_hash_continue.SetNull();\n+        LOCK(peer.m_block_inv_mutex); {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353092",
      "id" : 546353092,
      "in_reply_to_id" : 546342334,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1MzA5Mg==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 1618,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 556002530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353092",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353260"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is permitted by our clang formatter. I find it easier to read lines that are less than 100 columns, so I think this is a matter of taste.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T09:59:52Z",
      "diff_hunk" : "@@ -1764,7 +1775,9 @@ void PeerManager::SendBlockTransactions(CNode& pfrom, const CBlock& block, const\n     m_connman.PushMessage(&pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCKTXN, resp));\n }\n \n-void PeerManager::ProcessHeadersMessage(CNode& pfrom, const std::vector<CBlockHeader>& headers, bool via_compact_block)\n+void PeerManager::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n+                                        const std::vector<CBlockHeader>& headers,\n+                                        bool via_compact_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353260",
      "id" : 546353260,
      "in_reply_to_id" : 546251702,
      "line" : 1781,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1MzI2MA==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 1781,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 97,
      "pull_request_review_id" : 556002647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353260",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353297"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Again, this is personal taste, so I'm going to resolve this.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T10:00:17Z",
      "diff_hunk" : "@@ -1854,7 +1867,8 @@ void PeerManager::ProcessHeadersMessage(CNode& pfrom, const std::vector<CBlockHe\n             // Headers message had its maximum size; the peer may have more headers.\n             // TODO: optimize: if pindexLast is an ancestor of ::ChainActive().Tip or pindexBestHeader, continue\n             // from there instead.\n-            LogPrint(BCLog::NET, \"more getheaders (%d) to end to peer=%d (startheight:%d)\\n\", pindexLast->nHeight, pfrom.GetId(), pfrom.nStartingHeight);\n+            LogPrint(BCLog::NET, \"more getheaders (%d) to end to peer=%d (startheight:%d)\\n\",\n+                                 pindexLast->nHeight, pfrom.GetId(), peer.m_starting_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353297",
      "id" : 546353297,
      "in_reply_to_id" : 546251731,
      "line" : 1872,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1MzI5Nw==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 1872,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 107,
      "pull_request_review_id" : 556002678,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353297",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353320"
         }
      },
      "author_association" : "MEMBER",
      "body" : "as above",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T10:00:27Z",
      "diff_hunk" : "@@ -180,7 +202,9 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n \n     void ProcessOrphanTx(std::set<uint256>& orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(cs_main, g_cs_orphans);\n     /** Process a single headers message from a peer. */\n-    void ProcessHeadersMessage(CNode& pfrom, const std::vector<CBlockHeader>& headers, bool via_compact_block);\n+    void ProcessHeadersMessage(CNode& pfrom, const Peer& peer,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353320",
      "id" : 546353320,
      "in_reply_to_id" : 546252186,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1MzMyMA==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 205,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 48,
      "pull_request_review_id" : 556002693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353320",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353473"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T10:01:54Z",
      "diff_hunk" : "@@ -224,14 +224,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.m_starting_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353473",
      "id" : 546353473,
      "in_reply_to_id" : 546266076,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1MzQ3Mw==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 234,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 556002806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353473",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353844"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Changed to `m_continuation_block`",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T10:05:24Z",
      "diff_hunk" : "@@ -60,6 +63,25 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of blocks that we'll anounce via an `inv` message.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** Unfiltered list of blocks that we'd like to announce via a `headers`\n+     * message. If we can't announce via a `headers` message, we'll fall back to\n+     * announcing via `inv`. */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+    /** The final block hash that we sent in an `inv` message to this peer.\n+     * When the peer requests this block, we send an `inv` message to trigger\n+     * the peer to request the next sequence of block hashes.\n+     * Most peers use headers-first syncing, which doesn't use this mechanism */\n+    uint256 m_hash_continue GUARDED_BY(m_block_inv_mutex) {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546353844",
      "id" : 546353844,
      "in_reply_to_id" : 546267230,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1Mzg0NA==",
      "original_commit_id" : "9aad3e4f3347990641da23c0d9a3f05e1669cabf",
      "original_line" : 80,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 556003057,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546353844",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the latest reviews @jonatack and @MarcoFalke. I've addressed/responded to all of your comments.\r\n\r\nI'd like to stabilize this PR now unless any functional issues are found. We have ACKs on the code change at various times from @MarcoFalke, @jonatack, @hebasto, @sipa and @Sjors. If there are any further style suggestions, I can address them in the next PR in this series.",
      "created_at" : "2020-12-20T10:11:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748587747",
      "id" : 748587747,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODU4Nzc0Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-20T10:11:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748587747",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546367599"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546367599"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah right. I didn't parse this correctly. Thanks for the explanation.",
      "commit_id" : "3002b4af2b4fde63026f8f7c575452a5c989c662",
      "created_at" : "2020-12-20T12:05:36Z",
      "diff_hunk" : "@@ -46,6 +46,8 @@ struct CNodeStateStats {\n  * Memory is owned by shared pointers and this object is destructed when\n  * the refcount drops to zero.\n  *\n+ * Mutexes inside this struct must not be held when locking m_peer_mutex.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r546367599",
      "id" : 546367599,
      "in_reply_to_id" : 546338754,
      "line" : 50,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2NzU5OQ==",
      "original_commit_id" : "717a374e74b64b7b90bc1b2995e8900212bd0bfe",
      "original_line" : 49,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 12,
      "pull_request_review_id" : 556011499,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T12:05:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546367599",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 3002b4af2b4fde63026f8f7c575452a5c989c662 per `git diff 9aad3e4 3002b4a`",
      "created_at" : "2020-12-20T12:30:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-748601703",
      "id" : 748601703,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODYwMTcwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-20T12:30:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748601703",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
